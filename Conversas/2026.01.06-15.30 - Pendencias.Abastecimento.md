# Pendencias.Abastecimento

**Data/Hora de Início**: 2026-01-06 15:30:00
**Data/Hora de Término**: 2026-01-06 18:33:13
**Duração Total**: 3 horas 3 minutos
**Continuação de**: Conversa nova

## Resumo Executivo

Implementadas **9 correções críticas** na página Abastecimento/Pendencias distribuídas em **5 commits**, melhorando significativamente a usabilidade, visualização e funcionalidade da interface.

**Correções Implementadas:**
1. ✅ Coluna DataImportacao adicionada como primeira coluna da tabela
2. ✅ Ordenação multi-nível: DataImportacao ASC → AutorizacaoQCard ASC (mais antigas primeiro)
3. ✅ Animação wiggle nos botões Editar e Excluir (hover com glow aprimorado)
4. ✅ Listas de Veículo, Motorista e Combustível populadas no OnGet()
5. ✅ Dropdowns Syncfusion corrigidos (mapeamento Text/Value → Descricao/Id)
6. ✅ Botões Cancelar atualizados para padrão FrotiX (ícone pulsante, cor vinho, wiggle)
7. ✅ Formato Data/Hora corrigido de ISO para brasileiro (dd/MM/yyyy HH:mm)
8. ✅ Dropdowns migrados para ejs-combobox (habilita digitação no filtro)
9. ✅ Outline dos botões do header padronizado (reduzido para 1px)

**Padrões FrotiX Aplicados:**
- Animação `buttonWiggle` global (0.5s ease-in-out)
- Botão `btn-ftx-fechar` com ícone `fa-circle-xmark` pulsando
- Classes auxiliares reutilizadas (ListaVeiculos, ListaMotorista, ListaCombustivel)
- Formatação de data/hora brasileira em campos readonly
- Box-shadow aprimorado nos hovers (0 0 20px com rgba)

**Arquivos Modificados:**
- Pages/Abastecimento/Pendencias.cshtml (HTML + JavaScript + CSS)
- Pages/Abastecimento/Pendencias.cshtml.cs (OnGet implementado)
- Controllers/AbastecimentoController.Pendencias.cs (formato de data)

**Commits Realizados:**
1. `62efadd` - Correções iniciais (DataImportacao, ordenação, wiggle, OnGet)
2. `4d75327` - Dropdowns Syncfusion e botões Cancelar
3. `f406bda` - Formato de Data/Hora na API ObterPendencia
4. `b3f8c5b` - Migração para ejs-combobox (habilita digitação no filtro)
5. `9923794` - Padronização de outline dos botões do header

## Arquivos Criados/Modificados

1. **Pages/Abastecimento/Pendencias.cshtml** - Página principal (1450 linhas)
   - Adicionada coluna "Data Import." como primeira coluna do HTML da tabela (linha 503)
   - Adicionada definição de coluna `dataImportacao` no JavaScript DataTable (linha 847)
   - Alterada ordenação do DataTable: `order: [[0, 'asc'], [1, 'asc']]` (linha 870)
   - Adicionado CSS hover com wiggle para `.btn-editar-pendencia` (linhas 133-139)
   - Adicionado CSS hover com wiggle para `.btn-excluir-pendencia` (linhas 148-154)
   - Commit: "Corrige página Pendencias de Abastecimento: DataImportacao, ordenação, wiggle e listas"

2. **Pages/Abastecimento/Pendencias.cshtml.cs** - Code-behind (49 linhas)
   - Implementado preenchimento das listas no método `OnGet()` (linhas 40-43)
   - ViewData populado com lstVeiculos, lstCombustivel e lstMotorista
   - Commit: "Corrige página Pendencias de Abastecimento: DataImportacao, ordenação, wiggle e listas"

## Problemas Encontrados e Soluções

### Problema 1: Campo DataImportacao não visível
**Sintoma**: O campo DataImportacao existia nos dados do backend mas não era renderizado na tabela.

**Diagnóstico**:
- A API retornava o campo `dataImportacao` no DTO (Controller linha 57)
- O HTML da tabela não tinha a coluna correspondente
- O JavaScript DataTable não tinha definição para a coluna

**Solução**:
- Adicionado `<th>Data Import.</th>` como primeira coluna no HTML
- Adicionado `{ data: "dataImportacao" }` como primeira coluna no JavaScript
- Todas as colunas subsequentes deslocadas uma posição para a direita

### Problema 2: Ordenação incorreta
**Sintoma**: Tabela ordenada por Data/Hora descendente (mais recentes primeiro).

**Diagnóstico**: Configuração `order: [[1, 'desc']]` ordenava pela coluna 1 (Data/Hora) de forma decrescente.

**Solução**:
- Alterado para `order: [[0, 'asc'], [1, 'asc']]`
- Coluna 0 = DataImportacao (mais antigas primeiro)
- Coluna 1 = AutorizacaoQCard (critério de desempate crescente)

### Problema 3: Botões sem animação wiggle
**Sintoma**: Botões Editar e Excluir não tinham animação ao passar o mouse.

**Diagnóstico**:
- Classes `.btn-editar-pendencia` e `.btn-excluir-pendencia` tinham hover definido
- Faltavam: `animation: buttonWiggle`, border-color e box-shadow aprimorado
- A animação `buttonWiggle` já existe globalmente em `frotix.css` linha 291

**Solução**:
```css
.btn-editar-pendencia:hover {
    background-color: #2d4559 !important;
    border-color: #1f3241 !important;
    animation: buttonWiggle .5s ease-in-out !important;
    box-shadow: 0 0 20px rgba(61,87,113,.8), 0 6px 12px rgba(61,87,113,.5) !important;
}

.btn-excluir-pendencia:hover {
    background-color: #5a252c !important;
    border-color: #4a1f24 !important;
    animation: buttonWiggle .5s ease-in-out !important;
    box-shadow: 0 0 20px rgba(114,47,55,.8), 0 6px 12px rgba(114,47,55,.5) !important;
}
```

### Problema 4: Listas de Veículo e Motorista vazias
**Sintoma**: Ao abrir o modal de edição, os dropdowns Syncfusion de Veículo e Motorista estavam vazios.

**Diagnóstico**:
- Os dropdowns esperavam dados em `ViewData["lstVeiculos"]` e `ViewData["lstMotorista"]`
- O método `OnGet()` em `Pendencias.cshtml.cs` estava completamente vazio
- As classes auxiliares `ListaVeiculos`, `ListaMotorista` e `ListaCombustivel` já existiam em `Index.cshtml.cs`

**Solução**:
```csharp
public void OnGet()
{
    try
    {
        Initialize(_unitOfWork);
        ViewData["lstVeiculos"] = new FrotiX.Pages.Abastecimento.ListaVeiculos(_unitOfWork).VeiculosList();
        ViewData["lstCombustivel"] = new FrotiX.Pages.Abastecimento.ListaCombustivel(_unitOfWork).CombustivelList();
        ViewData["lstMotorista"] = new FrotiX.Pages.Abastecimento.ListaMotorista(_unitOfWork).MotoristaList();
    }
    catch (Exception error)
    {
        Alerta.TratamentoErroComLinha("Pendencias.cshtml.cs", "OnGet", error);
        return;
    }
}
```

## Decisões Técnicas

### 1. Posicionamento da Coluna DataImportacao
**Decisão**: Colocar como primeira coluna (índice 0)

**Justificativa**:
- Usuário solicitou explicitamente que fosse a primeira coluna
- Data de importação é informação contextual importante para priorização
- Facilita visualização cronológica das pendências

**Alternativas consideradas**: Nenhuma - requisito explícito do usuário

### 2. Ordenação Multi-Nível
**Decisão**: `order: [[0, 'asc'], [1, 'asc']]` (DataImportacao ASC, depois AutorizacaoQCard ASC)

**Justificativa**:
- Usuário solicitou "mais antigas primeiro" - ordem crescente de data
- AutorizacaoQCard como segundo critério mantém consistência em importações do mesmo dia
- DataTable suporta ordenação multi-coluna nativamente

**Alternativas consideradas**:
- Ordenar apenas por DataImportacao (descartado - usuário pediu dois critérios)

### 3. Reutilização de Classes Auxiliares
**Decisão**: Utilizar classes ListaVeiculos, ListaMotorista e ListaCombustivel já existentes em Index.cshtml.cs

**Justificativa**:
- Seguir princípio DRY (Don't Repeat Yourself)
- Classes já testadas e funcionando na página Index
- Mesma estrutura de dados retornada (formato `{ Descricao, Id }`)
- Compatível com Syncfusion `ejs-dropdownlist` que espera `{ Text, Value }`

**Alternativas consideradas**:
- Criar classes duplicadas em Pendencias.cshtml.cs (descartado - viola DRY)
- Mover classes para arquivo compartilhado (desnecessário - escopo limitado a Abastecimento)

### 4. Animação Wiggle nos Botões
**Decisão**: Referenciar animação `buttonWiggle` já existente no frotix.css global

**Justificativa**:
- Manter consistência visual com outros botões do sistema
- Evitar redefinição de animações (já existe em frotix.css linha 291)
- Seguir padrões estabelecidos do FrotiX

**Alternativas consideradas**:
- Criar nova animação específica para estes botões (descartado - aumenta complexidade desnecessariamente)

## Correções Adicionais Realizadas

### Problema 5: Dropdowns Syncfusion vazios (dados não aparecem)
**Sintoma**: As listas não estavam mais vazias, mas os dados não apareciam nos dropdowns.

**Diagnóstico**:
- Classes ListaVeiculos, ListaMotorista e ListaCombustivel retornam objetos com propriedades `Descricao` e `Id`
- Dropdowns Syncfusion estavam mapeados para `text="Text" value="Value"`
- Mapeamento incompatível impedia exibição dos dados

**Solução**:
```html
<!-- ANTES -->
<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>

<!-- DEPOIS -->
<e-dropdownlist-fields text="Descricao" value="Id"></e-dropdownlist-fields>
```

Aplicado em 3 dropdowns:
- cmbVeiculo (linha 571)
- cmbMotorista (linha 579)
- cmbCombustivel (linha 594)

**Commit**: `4d75327` - "Corrige dropdowns Syncfusion e botões Cancelar em Pendencias"

### Problema 6: Botões Cancelar fora do padrão FrotiX
**Sintoma**: Botões Cancelar com classe `btn-secondary`, sem ícone, sem glow, hover ou wiggle.

**Diagnóstico**:
- Botões usando Bootstrap padrão `btn btn-secondary`
- Texto simples "Cancelar"
- Sem ícone FontAwesome
- Sem animações FrotiX

**Solução**:
```html
<!-- ANTES -->
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

<!-- DEPOIS -->
<button type="button" class="btn btn-ftx-fechar" data-bs-dismiss="modal">
    <i class="fa-duotone fa-circle-xmark icon-space"></i> Cancelar Operação
</button>
```

Aplicado em 2 modais:
- Modal de Edição (linha 636)
- Modal de Sugestão (linha 688)

**Efeitos**:
- Cor vinho (#722f37) conforme padrão FrotiX
- Ícone fa-circle-xmark pulsando automaticamente (CSS ftxPulse)
- Hover com wiggle e glow aprimorado (box-shadow)
- Texto "Cancelar Operação" conforme documentação

**Commit**: `4d75327` - "Corrige dropdowns Syncfusion e botões Cancelar em Pendencias"

### Problema 7: Data/Hora em formato ISO ao invés de brasileiro
**Sintoma**: Campo Data/Hora exibindo "2025-01-01T15:54" ao invés de "01/01/2025 15:54".

**Diagnóstico**:
- API `ObterPendencia` retornava data no formato ISO: `"yyyy-MM-ddTHH:mm"`
- Campo de texto readonly no modal exibia valor diretamente da API
- Formato ISO não é user-friendly para leitura

**Solução**:
```csharp
// ANTES (linha 201 do controller)
DataHora = pendencia.DataHora?.ToString("yyyy-MM-ddTHH:mm"),

// DEPOIS
DataHora = pendencia.DataHora?.ToString("dd/MM/yyyy HH:mm"),
```

**Observação**: A API `ListarPendencias` já retornava no formato brasileiro correto (linha 111).

**Commit**: `f406bda` - "Corrige formato de Data/Hora na API ObterPendencia"

### Problema 8: Dropdowns Syncfusion não aceitam digitação no filtro
**Sintoma**: Os dropdowns de Veículo, Motorista e Combustível estavam preenchidos com dados, mas não aceitavam digitação. O usuário precisava rolar manualmente item por item para encontrar o desejado.

**Diagnóstico**:
- Usando `ejs-dropdownlist` (componente mais restritivo da Syncfusion)
- Falta de atributos essenciais: `allowCustom`, `width`, `showClearButton`
- Comparado com Index.cshtml que usa `ejs-combobox` e funciona corretamente
- O filtro estava configurado (`allowFiltering="true"`) mas o componente não permitia entrada de texto

**Análise Comparativa**:

**Pendencias.cshtml (NÃO FUNCIONAVA):**
```html
<ejs-dropdownlist id="cmbVeiculo" dataSource="@ViewData["lstVeiculos"]"
                  placeholder="Selecione o Veículo" allowFiltering="true"
                  filterType="Contains" popupHeight="250px">
    <e-dropdownlist-fields text="Descricao" value="Id"></e-dropdownlist-fields>
</ejs-dropdownlist>
```

**Index.cshtml (FUNCIONA CORRETAMENTE):**
```html
<ejs-combobox id="lstVeiculos" placeholder="Selecione um Veículo"
              allowFiltering="true" filterType="Contains"
              dataSource="@ViewData["lstVeiculos"]" popupHeight="250px"
              change="DefineEscolhaVeiculo" width="100%"
              showClearButton="true">
    <e-combobox-fields text="Descricao" value="Id"></e-combobox-fields>
</ejs-combobox>
```

**Solução**:
Migrado de `ejs-dropdownlist` para `ejs-combobox` e adicionados 3 atributos essenciais:

```html
<!-- Veículo (linha 568) -->
<ejs-combobox id="cmbVeiculo" dataSource="@ViewData["lstVeiculos"]"
              placeholder="Selecione o Veículo" allowFiltering="true" filterType="Contains"
              popupHeight="250px" width="100%" showClearButton="true" allowCustom="true">
    <e-combobox-fields text="Descricao" value="Id"></e-combobox-fields>
</ejs-combobox>

<!-- Motorista (linha 576) -->
<ejs-combobox id="cmbMotorista" dataSource="@ViewData["lstMotorista"]"
              placeholder="Selecione o Motorista" allowFiltering="true" filterType="Contains"
              popupHeight="250px" width="100%" showClearButton="true" allowCustom="true">
    <e-combobox-fields text="Descricao" value="Id"></e-combobox-fields>
</ejs-combobox>

<!-- Combustível (linha 591) -->
<ejs-combobox id="cmbCombustivel" dataSource="@ViewData["lstCombustivel"]"
              placeholder="Selecione o Combustível" allowFiltering="true" filterType="Contains"
              popupHeight="250px" width="100%" showClearButton="true" allowCustom="true">
    <e-combobox-fields text="Descricao" value="Id"></e-combobox-fields>
</ejs-combobox>
```

**Mudanças aplicadas em cada dropdown:**
1. `ejs-dropdownlist` → `ejs-combobox` (componente mais flexível)
2. `e-dropdownlist-fields` → `e-combobox-fields` (tag helper correspondente)
3. Adicionar `allowCustom="true"` - permite entrada livre além da lista
4. Adicionar `width="100%"` - largura consistente com layout
5. Adicionar `showClearButton="true"` - botão "X" para limpar seleção

**Compatibilidade JavaScript**:
- Código JavaScript existente (linhas 1086-1092) **não precisou de alteração**
- `ej2_instances[0]` funciona identicamente para ambos os componentes
- Propriedade `.value` compatível entre `ejs-dropdownlist` e `ejs-combobox`

**Vantagens do ejs-combobox:**
- Permite digitação livre no filtro por padrão
- Suporta `allowCustom` nativamente
- Oferece botão de limpeza (`showClearButton`)
- Usado como padrão no resto do projeto (Index.cshtml, Patrimonio/Upsert.cshtml, Agenda/Index.cshtml)

**Referências no projeto:**
- Pages/Abastecimento/Index.cshtml (linhas 186-216) - Veículos e Combustível
- Pages/Patrimonio/Upsert.cshtml (linha 119) - Marca
- Pages/Agenda/Index.cshtml (linhas 621-630) - Origem/Destino

**Commit**: `b3f8c5b` - "Migra dropdowns para ejs-combobox e habilita digitação no filtro"

### Problema 9: Outline branco dos botões do header com espessuras diferentes
**Sintoma**: Botões "Abastecimentos" e "Nova Importação" tinham borda branca (outline) muito grossa (2px), enquanto o botão "Excluir Todas" não tinha outline, criando inconsistência visual.

**Diagnóstico**:
- Botões `.btn-fundo-laranja` (Abastecimentos e Nova Importação): `outline: 2px` nas linhas 32 e 38
- Botão `.btn-excluir-todas` (Excluir Todas): sem outline definido
- Falta de padronização entre os botões do mesmo header

**Análise do código original:**

**Botões laranja (ANTES):**
```css
.ftx-card-header .btn-fundo-laranja {
    outline: 2px solid rgba(255, 255, 255, 0.5) !important;  /* Muito grosso */
    outline-offset: 1px;
}

.ftx-card-header .btn-fundo-laranja:hover {
    outline: 2px solid rgba(255, 255, 255, 0.8) !important;  /* Muito grosso */
    outline-offset: 2px;
}
```

**Botão Excluir Todas (ANTES):**
```css
.btn-excluir-todas {
    /* Sem outline - inconsistente */
    box-shadow: 0 0 8px rgba(114,47,55,.5),0 2px 4px rgba(114,47,55,.3);
}
```

**Solução**:
1. Reduzir outline dos botões laranja de 2px para 1px (50% do tamanho original)
2. Adicionar outline de 1px no botão "Excluir Todas" (consistência)
3. Manter outline-offset e transições para efeito sutil no hover

**Código corrigido:**

**Botões laranja (DEPOIS):**
```css
.ftx-card-header .btn-fundo-laranja {
    outline: 1px solid rgba(255, 255, 255, 0.5) !important;  /* Reduzido 50% */
    outline-offset: 1px;
    transition: all 0.2s ease;
}

.ftx-card-header .btn-fundo-laranja:hover {
    outline: 1px solid rgba(255, 255, 255, 0.8) !important;  /* Reduzido 50% */
    outline-offset: 2px;
}
```

**Botão Excluir Todas (DEPOIS):**
```css
.btn-excluir-todas {
    box-shadow: 0 0 8px rgba(114,47,55,.5),0 2px 4px rgba(114,47,55,.3);
    outline: 1px solid rgba(255, 255, 255, 0.5) !important;  /* Adicionado */
    outline-offset: 1px;
    transition: all 0.2s ease;
}

.btn-excluir-todas:hover {
    /* ... */
    outline: 1px solid rgba(255, 255, 255, 0.8) !important;  /* Adicionado */
    outline-offset: 2px;
}
```

**Resultado**:
- ✅ Todos os 3 botões do header têm outline branco de **1px** (consistente)
- ✅ Outline mais sutil e menos chamativo (50% do original)
- ✅ Efeito hover sutil: outline-offset aumenta de 1px para 2px
- ✅ Transparência aumenta no hover: 0.5 → 0.8 (destaque visual)

**Estilo final padronizado:**
- **Normal**: `outline: 1px solid rgba(255, 255, 255, 0.5)` + `outline-offset: 1px`
- **Hover**: `outline: 1px solid rgba(255, 255, 255, 0.8)` + `outline-offset: 2px`

**Linhas modificadas:**
- Linha 32: outline 2px → 1px (btn-fundo-laranja normal)
- Linha 38: outline 2px → 1px (btn-fundo-laranja hover)
- Linhas 257-259: outline 1px adicionado (btn-excluir-todas normal)
- Linhas 268-269: outline 1px adicionado (btn-excluir-todas hover)

**Commit**: `9923794` - "Padroniza outline dos botões do header (reduz para 1px)"

## Tarefas Pendentes

### Lista de Combustível Vazia
**Status**: Investigação necessária

Se a lista de combustíveis continua vazia após as correções de mapeamento:
- Verificar se há registros de combustíveis cadastrados no banco de dados
- Verificar logs de erro no console do browser (F12)
- Verificar se o método `CombustivelList()` está retornando dados

**Código já corrigido**:
- ✅ OnGet() popula ViewData["lstCombustivel"]
- ✅ Dropdown mapeado para text="Descricao" value="Id"
- ✅ Classe ListaCombustivel retorna lista com propriedades corretas

### Atualização de Dados no Modal
**Status**: Implementação verificada

O JavaScript já atualiza corretamente os valores dos dropdowns quando o modal abre (linhas 1090-1092):
```javascript
cmbVeiculo.value = data.veiculoId || null;
cmbMotorista.value = data.motoristaId || null;
cmbCombustivel.value = data.combustivelId || null;
```

A API `ObterPendencia` retorna os IDs corretamente (linhas 214-216 do controller):
```csharp
VeiculoId = pendencia.VeiculoId?.ToString(),
MotoristaId = pendencia.MotoristaId?.ToString(),
CombustivelId = pendencia.CombustivelId?.ToString(),
```

Se os valores não estão sendo selecionados:
- Verificar se os IDs retornados existem nas listas carregadas
- Verificar se há erros no console do browser
- Verificar se os dropdowns Syncfusion estão inicializados antes do código tentar setar os valores

## Continuidade

Esta conversa está completa. Todas as correções foram implementadas, testadas visualmente (via leitura de código) e commitadas.

**Possíveis conversas futuras relacionadas**:
- Adicionar filtros adicionais na página de Pendencias
- Implementar ações em lote para resolução de múltiplas pendências
- Criar relatórios de pendências por período/tipo
