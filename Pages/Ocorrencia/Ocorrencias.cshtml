@page
@model FrotiX.Pages.Ocorrencia.OcorrenciasModel

@using FrotiX.Repository.IRepository
@using Syncfusion.EJ2

@inject IUnitOfWork _unitOfWork

@{
    ViewData["Title"] = "Ocorrências";
    ViewData["PageName"] = "ocorrencia_ocorrencias";
    ViewData["Heading"] = "<i class='fa-duotone fa-car-crash'></i> Vistoria: <span class='fw-300'>Ocorrências</span>";
    ViewData["Category1"] = "Vistoria";
    ViewData["PageIcon"] = "fa-duotone fa-car-crash";

    var lstMotoristas = new ListaMotoristaOcorrencias(_unitOfWork).MotoristaList();
    var lstVeiculos = new ListaVeiculosOcorrencias(_unitOfWork).VeiculosList();
    var lstStatus = new ListaStatusOcorrencias(_unitOfWork).StatusList();
}

@section HeadBlock {
	<style>
/* ======== OUTLINE BRANCO NO BOTÃO DO HEADER (Padrão FrotiX) ======== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

	</style>
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />
    <style>
        /* ===== Fonte Outfit ===== */
        @@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap');

        /* ===== Variáveis FrotiX ===== */
        :root {
            --fx-primary: #2c3e50;
            --fx-primary-hover: #1a252f;
            --fx-success: #27ae60;
            --fx-success-hover: #219a52;
            --fx-danger: #c0392b;
            --fx-danger-hover: #a93226;
            --fx-warning: #f39c12;
            --fx-warning-hover: #d68910;
            --fx-info: #3498db;
            --fx-muted: #6c757d;

            --edit-blue: #3D5771;
            --edit-blue-hover: #2d4559;
            --edit-blue-shadow: rgba(61,87,113,.5);
            --finish-orange: #A0522D;
            --finish-orange-hover: #8B4513;
            --finish-orange-shadow: rgba(160,82,45,.5);
        }

        /* ===== Override Header (fonte Outfit 900 + cores) ===== */
        .ftx-card-header .ftx-card-title {
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            color: #fff !important;
        }

        .ftx-card-header .ftx-card-title i {
            color: #fff !important;
            --fa-primary-color: #fff !important;
            --fa-secondary-color: rgba(255,255,255,0.7) !important;
        }

        /* Botão laranja usa padrão global do frotix.css */

        /* ===== Card de Filtros ===== */
        .filtros-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filtros-card .filtro-titulo {
            font-weight: 600;
            color: var(--fx-primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }

        .filtros-card label {
            font-weight: 500;
            color: #495057;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        /* ===== Card de Período ===== */
        .periodo-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }

        .periodo-card .periodo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .periodo-card .periodo-title {
            font-weight: 600;
            color: var(--fx-primary);
            font-size: 0.9rem;
        }

        .periodo-card .periodo-hint {
            font-size: 0.75rem;
            color: var(--fx-muted);
        }

        /* ===== Botão Filtrar ===== */
        .btn-filtrar,
        button.btn-filtrar {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%) !important;
            border: none !important;
            color: #fff !important;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(139, 69, 19, 0.3);
        }

        .btn-filtrar:hover,
        button.btn-filtrar:hover {
            background: linear-gradient(135deg, #6B3410 0%, #8B4513 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.4);
            color: #fff !important;
        }

        .btn-filtrar i,
        button.btn-filtrar i {
            margin-right: 0.5rem;
            color: #fff !important;
        }

        /* ===== Tabela ===== */
        .tabela-ocorrencias {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
        }

        #tblOcorrencia {
            width: 100% !important;
        }

        #tblOcorrencia thead th {
            background: #f8f9fa;
            color: var(--fx-primary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
            padding: 0.75rem;
        }

        #tblOcorrencia tbody td {
            vertical-align: middle;
            padding: 0.6rem;
            font-size: 0.9rem;
        }

        /* ===== Badges de Status FrotiX (sem degradê) ===== */
        .ftx-badge-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 90px;
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            color: #fff !important;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .ftx-badge-status i {
            font-size: 0.7rem;
        }

        .ftx-badge-aberta {
            background-color: #4A5D23;
        }

        .ftx-badge-baixada {
            background-color: #718096;
        }

        .ftx-badge-pendente {
            background-color: #ED8936;
        }

        .ftx-badge-manutencao {
            background-color: #4299E1;
        }

        /* ===== Botões de Ação - Usa CSS Global do frotix.css ===== */

        /* ===== Modal ===== */
        .modal-header-ocorrencia {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fff;
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .modal-header-ocorrencia .modal-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header-ocorrencia .btn-close {
            filter: brightness(0) invert(1);
        }

        /* ===== Botões do Modal de Edição ===== */
        .btn.btn-salvar,
        button.btn-salvar {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%) !important;
            border: none !important;
            color: #fff !important;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn.btn-salvar:hover,
        button.btn-salvar:hover {
            background: linear-gradient(135deg, #1f6fa5 0%, #2980b9 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(41, 128, 185, 0.4);
            color: #fff !important;
        }

        .btn.btn-salvar i,
        button.btn-salvar i {
            color: #fff !important;
        }

        .btn.btn-fechar,
        button.btn-fechar {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%) !important;
            border: none !important;
            color: #fff !important;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn.btn-fechar:hover,
        button.btn-fechar:hover {
            background: linear-gradient(135deg, #a93226 0%, #c0392b 100%) !important;
            color: #fff !important;
        }

        .btn.btn-fechar i,
        button.btn-fechar i {
            color: #fff !important;
        }

        /* ===== Modal Baixa Rápida ===== */
        .btn.btn-cancelar-outline,
        button.btn-cancelar-outline {
            background: #fff !important;
            border: 2px solid #6c757d !important;
            color: #495057 !important;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn.btn-cancelar-outline:hover,
        button.btn-cancelar-outline:hover {
            background: #6c757d !important;
            color: #fff !important;
            border-color: #6c757d !important;
        }

        .btn.btn-cancelar-outline i,
        button.btn-cancelar-outline i {
            color: inherit !important;
        }

        .btn.btn-baixa-modal,
        button.btn-baixa-modal {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%) !important;
            border: none !important;
            color: #fff !important;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn.btn-baixa-modal:hover,
        button.btn-baixa-modal:hover {
            background: linear-gradient(135deg, #1e8449 0%, #27ae60 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
            color: #fff !important;
        }

        .btn.btn-baixa-modal i,
        button.btn-baixa-modal i {
            color: #fff !important;
        }

        /* ===== Imagem Ocorrência ===== */
        .img-ocorrencia-container {
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .img-ocorrencia-preview {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .img-ocorrencia-placeholder {
            padding: 2rem;
            text-align: center;
            color: var(--fx-muted);
        }

        .img-ocorrencia-placeholder i {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .img-ocorrencia-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-img-action {
            padding: 0.4rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-img-action.btn-alterar {
            background: var(--fx-info);
            color: #fff;
        }

        .btn-img-action.btn-alterar:hover {
            background: #2980b9;
        }

        .btn-img-action.btn-excluir {
            background: var(--fx-danger);
            color: #fff;
        }

        .btn-img-action.btn-excluir:hover {
            background: var(--fx-danger-hover);
        }

        /* ===== Ícones dos Badges de Status - 20% maior ===== */
        .ftx-badge-status.ftx-badge-aberta i,
        .ftx-badge-status.ftx-badge-baixada i,
        .ftx-badge-status.ftx-badge-pendente i,
        .ftx-badge-status.ftx-badge-manutencao i {
            font-size: 1.2em;
        }

        /* ===== Responsivo ===== */
        @@media (max-width: 768px) {
            .filtros-card {
                padding: 1rem;
            }
        }
    </style>
}

<div class="row">
    <div class="col-12">
        <!-- Header Padrão FrotiX -->
        <div class="panel ftx-card-styled mb-3">
            <div class="ftx-card-header">
                <h2 class="ftx-card-title">
                    <i class="fa-duotone fa-car-crash"></i>
                    Gestão de Ocorrências de Viagem
                </h2>
                <div class="ftx-card-actions">
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filtros-card">
            <div class="filtro-titulo">
                <i class="fa-duotone fa-filter me-2"></i>Filtros de Pesquisa
            </div>

            <div class="row g-3">
                <!-- Data Única -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Data Específica</label>
                    <input id="txtData" class="form-control form-control-sm" type="date" />
                </div>

                <!-- Período -->
                <div class="col-12 col-md-5">
                    <div class="periodo-card">
                        <div class="periodo-header">
                            <span class="periodo-title">
                                <i class="fa-duotone fa-calendar-range me-1"></i>Filtrar por Período
                            </span>
                            <span class="periodo-hint">(sobrepõe "Data Específica")</span>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small">Data Inicial</label>
                                <input id="txtDataInicial" class="form-control form-control-sm" type="date" />
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Data Final</label>
                                <input id="txtDataFinal" class="form-control form-control-sm" type="date" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Espaço -->
                <div class="col-12 col-md-4"></div>

                <!-- Veículo -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Veículo</label>
                    <ejs-combobox id="lstVeiculos"
                                  placeholder="Selecione um Veículo..."
                                  allowFiltering="true" filterType="Contains"
                                  dataSource="@lstVeiculos"
                                  popupHeight="250px" width="100%" showClearButton="true">
                        <e-combobox-fields text="Descricao" value="Id"></e-combobox-fields>
                    </ejs-combobox>
                </div>

                <!-- Motorista -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Motorista</label>
                    <ejs-combobox id="lstMotorista"
                                  placeholder="Selecione um Motorista..."
                                  allowFiltering="true" filterType="Contains"
                                  dataSource="@lstMotoristas"
                                  popupHeight="250px" width="100%" showClearButton="true">
                        <e-combobox-fields text="Descricao" value="Id"></e-combobox-fields>
                    </ejs-combobox>
                </div>

                <!-- Status -->
                <div class="col-12 col-md-3">
                    <label class="form-label">Status</label>
                    <ejs-combobox id="lstStatus"
                                  placeholder="Status da Ocorrência..."
                                  allowFiltering="true" filterType="Contains"
                                  dataSource="@lstStatus"
                                  popupHeight="250px" width="100%" showClearButton="true">
                        <e-combobox-fields text="Status" value="StatusId"></e-combobox-fields>
                    </ejs-combobox>
                </div>

                <!-- Botão Filtrar -->
                <div class="col-12 col-md-3 d-flex align-items-end">
                    <button id="btnFiltrarOcorrencias" class="btn btn-filtrar w-100" type="button"
                        style="color:#fff !important;">
                        <i class="fa-duotone fa-magnifying-glass" style="color:#fff;"></i>
                        Filtrar Ocorrências
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="tabela-ocorrencias">
            <table id="tblOcorrencia" class="table table-hover" width="100%">
                <thead>
                    <tr>
                        <th>Ficha</th>
                        <th>Data</th>
                        <th>Motorista</th>
                        <th>Veículo</th>
                        <th>Resumo</th>
                        <th>Solução</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Ações</th>
                        <th>Descrição</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="modalOcorrencia" tabindex="-1" aria-labelledby="modalOcorrenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header modal-header-ocorrencia">
                <h5 class="modal-title" id="modalOcorrenciaLabel">
                    <i class="fa-duotone fa-car-crash"></i>
                    <span>Editar Ocorrência</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="frmOcorrencia">
                    <input type="hidden" id="txtId" />
                    <input type="hidden" id="txtImagemOcorrenciaAtual" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Resumo da Ocorrência</label>
                        <input id="txtResumo" class="form-control" placeholder="Breve descrição do problema..." />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Descrição Detalhada</label>
                        <ejs-richtexteditor id="rteOcorrencias" locale="pt-BR" height="200px">
                            <e-richtexteditor-insertimagesettings saveUrl="api/OcorrenciaViagem/UploadImagem" path="./uploads/ocorrencias/"></e-richtexteditor-insertimagesettings>
                        </ejs-richtexteditor>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Solução / Observações</label>
                        <ejs-richtexteditor id="rteSolucao" locale="pt-BR" height="200px">
                            <e-richtexteditor-insertimagesettings saveUrl="api/OcorrenciaViagem/UploadImagem" path="./uploads/ocorrencias/"></e-richtexteditor-insertimagesettings>
                        </ejs-richtexteditor>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Imagem / Vídeo da Ocorrência</label>
                        <div id="divImagemOcorrencia"></div>
                        <input type="file" id="inputImagemOcorrencia" accept="image/*,video/mp4,video/webm" style="display:none;" />
                    </div>

                    <input type="hidden" id="chkStatusOcorrencia" />
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button id="btnBaixarOcorrenciaModal" type="button"
                        style="background:linear-gradient(135deg,#27ae60,#2ecc71); border:none; color:#fff; padding:0.5rem 1.25rem; border-radius:6px; font-weight:600;">
                        <i class="fa-duotone fa-flag-checkered me-1" style="color:#fff;"></i>
                        Dar Baixa
                    </button>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnEditarOcorrencia" type="button"
                        style="background:linear-gradient(135deg,#2980b9,#3498db); border:none; color:#fff; padding:0.5rem 1.25rem; border-radius:6px; font-weight:600;">
                        <i class="fa-duotone fa-floppy-disk me-1" style="color:#fff;"></i>
                        Salvar Alterações
                    </button>
                    <button id="btnFechar" type="button" data-bs-dismiss="modal"
                        style="background:linear-gradient(135deg,#6c757d,#5a6268); border:none; color:#fff; padding:0.5rem 1.25rem; border-radius:6px; font-weight:600;">
                        <i class="fa-duotone fa-xmark me-1" style="color:#fff;"></i>
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Visualização de Imagem/Vídeo -->
<div class="modal fade" id="modalVisualizarImagem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header modal-header-ocorrencia">
                <h5 class="modal-title">
                    <i class="fa-duotone fa-image me-2"></i>Imagem da Ocorrência
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center p-3">
                <div id="divImagemVisualizacao"></div>
            </div>
            <div class="modal-footer">
                <button type="button" data-bs-dismiss="modal"
                    style="background:linear-gradient(135deg,#6c757d,#5a6268); border:none; color:#fff; padding:0.5rem 1.25rem; border-radius:6px; font-weight:600;">
                    <i class="fa-duotone fa-xmark me-1" style="color:#fff;"></i>Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Baixa Rápida -->
<div class="modal fade" id="modalBaixaRapida" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: #fff;">
                <h5 class="modal-title">
                    <i class="fa-duotone fa-flag-checkered me-2"></i>Dar Baixa na Ocorrência
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar" style="filter: brightness(0) invert(1);"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtBaixaRapidaId" />

                <div class="alert alert-warning mb-3">
                    <i class="fa-duotone fa-exclamation-triangle me-2"></i>
                    <strong>Solução não preenchida!</strong><br>
                    Descreva como o problema foi resolvido antes de dar baixa.
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Solução da Ocorrência</label>
                    <textarea id="txtBaixaRapidaSolucao" class="form-control" rows="4"
                        placeholder="Descreva como o problema foi resolvido..."></textarea>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" data-bs-dismiss="modal"
                    style="background:#6c757d; border:none; color:#fff; padding:0.5rem 1.25rem; border-radius:6px; font-weight:600;">
                    <i class="fa-duotone fa-xmark me-1" style="color:#fff;"></i>Cancelar
                </button>
                <button type="button" id="btnConfirmarBaixaRapida"
                    style="background:linear-gradient(135deg,#27ae60,#2ecc71); border:none; color:#fff; padding:0.5rem 1.25rem; border-radius:6px; font-weight:600;">
                    <i class="fa-duotone fa-flag-checkered me-1" style="color:#fff;"></i>Confirmar Baixa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- OVERLAY DE LOADING - PADRÃO FROTIX -->
<div id="loadingOverlayOcorrencias" class="ftx-spin-overlay" style="z-index: 999999; cursor: wait; display: none;">
    <div class="ftx-spin-box" style="text-align: center; min-width: 300px;">
        <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="ftx-loading-logo" style="display: block;" />
        <div class="ftx-loading-bar"></div>
        <div class="ftx-loading-text">Carregando Ocorrências...</div>
        <div class="ftx-loading-subtext">Aguarde, por favor</div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/cadastros/ocorrencias.js" asp-append-version="true"></script>
}
