@*
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                          ‚ïë
‚ïë  üìö DOCUMENTA√á√ÉO DISPON√çVEL                                              ‚ïë
‚ïë                                                                          ‚ïë
‚ïë  Este arquivo est√° completamente documentado em:                         ‚ïë
‚ïë  üìÑ Documentacao/Pages/Agenda - Index.md                                 ‚ïë
‚ïë                                                                          ‚ïë
‚ïë  A documenta√ß√£o inclui:                                                   ‚ïë
‚ïë  ‚Ä¢ Vis√£o geral completa da funcionalidade                                ‚ïë
‚ïë  ‚Ä¢ Explica√ß√£o detalhada de cada componente JavaScript                    ‚ïë
‚ïë  ‚Ä¢ Documenta√ß√£o completa de todos os endpoints API                       ‚ïë
‚ïë  ‚Ä¢ Sistema de recorr√™ncia explicado em detalhes                          ‚ïë
‚ïë  ‚Ä¢ Valida√ß√µes frontend e backend documentadas                            ‚ïë
‚ïë  ‚Ä¢ Interconex√µes entre todos os arquivos                                 ‚ïë
‚ïë  ‚Ä¢ Exemplos pr√°ticos de uso                                              ‚ïë
‚ïë  ‚Ä¢ Troubleshooting completo com solu√ß√µes                                 ‚ïë
‚ïë                                                                          ‚ïë
‚ïë  √öltima atualiza√ß√£o: 08/01/2026                                          ‚ïë
‚ïë                                                                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
*@

@page

@using FrotiX.Repository.IRepository
@using Syncfusion.EJ2
@using Stimulsoft.Report.Mvc;
@using Syncfusion.EJ2.DropDowns
@using Syncfusion.EJ2.Navigations
@using Syncfusion.EJ2.Base
@using Syncfusion.EJ2.Popups
@using Kendo.Mvc.UI
@using FrotiX.Helpers;

@model FrotiX.Models.Agenda

@inject IUnitOfWork _unitOfWork

@* ============================================
   FUN√á√ïES DO SERVIDOR (FORA DE BLOCOS @{})
   ============================================ *@
@functions {
    public void OnGet()
    {
    FrotiX.Pages.Agenda.IndexModel.Initialize(_unitOfWork);
    ViewData["dataCombustivel"] = new ListaNivelCombustivel(_unitOfWork).NivelCombustivelList();
    ViewData["dataMotorista"] = new ListaMotorista(_unitOfWork).MotoristaList();
    ViewData["dataVeiculo"] = new ListaVeiculos(_unitOfWork).VeiculosList();
    ViewData["dataSetor"] = new ListaSetores(_unitOfWork).SetoresList();
    ViewData["dataRequisitante"] = new ListaRequisitante(_unitOfWork).RequisitantesList();
    ViewData["dataFinalidade"] = new ListaFinalidade(_unitOfWork).FinalidadesList();
    ViewData["dataEvento"] = new ListaEvento(_unitOfWork).EventosList();
    ViewData["dataSetorEvento"] = new ListaSetoresEvento(_unitOfWork).SetoresEventoList();
    ViewData["dataPeriodo"] = new ListaPeriodos().PeriodosList();
    ViewData["dataRecorrente"] = new ListaRecorrente().RecorrenteList();

    var listaOrigem = _unitOfWork.Viagem.GetAllReduced(selector: v => v.Origem)
        .Where(o => o != null)
        .Distinct()
        .OrderBy(o => o)
        .ToList();
    ViewData["ListaOrigem"] = listaOrigem;

    var listaDestino = _unitOfWork.Viagem.GetAllReduced(selector: v => v.Destino)
        .Where(d => d != null)
        .Distinct()
        .OrderBy(d => d)
        .ToList();
    ViewData["ListaDestino"] = listaDestino;
    }
}

@* ============================================
   CONFIGURA√á√ïES DE MODAL E BOT√ïES
   ============================================ *@
@{
var Modalanimation = new Syncfusion.EJ2.Popups.DialogAnimationSettings { Effect = Syncfusion.EJ2.Popups.DialogEffect.None };
var Okbutton = new
{
    content = "Inserir Requisitante" ,
    isPrimary = true
};
var Closebutton = new
{
    content = "Fechar" ,
    isPrimary = false
};
}

@* ============================================
   CONFIGURA√á√ïES DA P√É¬ÅGINA
   ============================================ *@
@{
ViewData["Title"] = "Agenda";
ViewData["PageName"] = "agenda_index";
ViewData["Heading"] = "<i class='fa-duotone fa-calendar-alt'></i> Agenda: <span class='fw-300'>Agenda de Viagens</span>";
ViewData["Category1"] = "Agenda";
ViewData["PageIcon"] = "fa-duotone fa-calendar-alt";
}

@* ============================================
   SECTION HEAD BLOCK - CSS E SCRIPTS DO HEAD
   ============================================ *@
@section HeadBlock {

<!-- FONTE OUTFIT PARA T√çTULOS DOS MODAIS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">

<link rel="stylesheet" href="~/css/modal-viagens-consolidado.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/modal-viagens-headers.css" asp-append-version="true" />

<!-- FullCalendar 6.1.15 -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
@Html.Raw("<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js'></script>")

<link rel="stylesheet" type="text/css" href="~/css/spinkit.css">

<!-- Kendo UI (padronizado 2024.3.806) -->
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.2.1/default/default-main.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.3.806/js/jszip.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.3.806/js/kendo.all.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.3.806/js/kendo.aspnetmvc.min.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
<script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
</script>

<script>

            /**
     * Inicializa os templates do ComboBox de Motorista
     * Configura itemTemplate e valueTemplate com fotos
     */
    function onLstMotoristaCreated() {
        try {
            const combo = document.getElementById('lstMotorista');
            if (!combo || !combo.ej2_instances || !combo.ej2_instances[0]) {
                console.warn('lstMotorista n√£o encontrado ou n√£o inicializado');
                return;
            }

            const motoristaCombo = combo.ej2_instances[0];

            // Template para itens da lista (dropdown)
            motoristaCombo.itemTemplate = function (data) {
                if (!data) return '';

                let imgSrc = '/images/barbudo.jpg'; // Imagem padr√≠o

                // Verifica se tem foto em base64
                if (data.Foto && data.Foto.startsWith('data:image')) {
                    imgSrc = data.Foto;
                }

                return `
                    <div class="d-flex align-items-center">
                        <img src="${imgSrc}"
                             alt="Foto ${data.Nome || 'Motorista'}"
                             style="height:40px; width:40px; border-radius:50%; margin-right:10px; object-fit: cover;"
                             onerror="this.src='/images/barbudo.jpg';" />
                        <span>${data.Nome || ''}</span>
                    </div>`;
            };

            // Template para valor selecionado (input)
            motoristaCombo.valueTemplate = function (data) {
                if (!data) return '';

                let imgSrc = '/images/barbudo.jpg'; // Imagem padr√≠o

                // Verifica se tem foto em base64
                if (data.Foto && data.Foto.startsWith('data:image')) {
                    imgSrc = data.Foto;
                }

                return `
                    <div class="d-flex align-items-center">
                        <img src="${imgSrc}"
                             alt="Foto ${data.Nome || 'Motorista'}"
                             style="height:30px; width:30px; border-radius:50%; margin-right:10px; object-fit: cover;"
                             onerror="this.src='/images/barbudo.jpg';" />
                        <span>${data.Nome || ''}</span>
                    </div>`;
            };

            console.log('Templates de foto do motorista configurados com sucesso');
        } catch (error) {
            console.error('Erro ao configurar templates do motorista:', error);
            // Se houver sistema de alertas
            if (typeof Alerta !== 'undefined' && Alerta.TratamentoErroComLinha) {
                Alerta.TratamentoErroComLinha("motorista-templates.js", "onLstMotoristaCreated", error);
            }
        }
    }

    /**
     * Handler de mudan√ßa do ComboBox de Motorista
     * Atualiza foto quando motorista √© selecionado
     */
    function onLstMotoristaChange(args) {
        try {
            const motoristaId = args?.itemData?.MotoristaId;

            if (!motoristaId) {
                console.log('Nenhum motorista selecionado');
                return;
            }

            console.log('Motorista selecionado:', motoristaId);

            // Se houver um elemento de foto para atualizar
            const fotoElement = document.getElementById("fotoMotorista");
            if (fotoElement && args.itemData.Foto) {
                fotoElement.src = args.itemData.Foto;
                fotoElement.style.display = 'block';
            }

            // Opcional: buscar mais detalhes do motorista via API
            // fetch(`/api/Viagem/FotoMotorista?id=${motoristaId}`)
            //     .then(resp => resp.json())
            //     .then(data => {
            //         if (data.fotoBase64 && fotoElement) {
            //             fotoElement.src = data.fotoBase64;
            //             fotoElement.style.display = 'block';
            //         }
            //     })
            //     .catch(error => console.error('Erro ao buscar foto:', error));

        } catch (error) {
            console.error('Erro ao processar mudan√ßa de motorista:', error);
            if (typeof Alerta !== 'undefined' && Alerta.TratamentoErroComLinha) {
                Alerta.TratamentoErroComLinha("motorista-templates.js", "onLstMotoristaChange", error);
            }
        }
    }

</script>

<style>
    /* Usamos o header padr√£o FrotiX (ftx-card-header + titulo-paginas) definido em frotix.css */

    /* ======== Legenda de Cores da Agenda ======== */
    .legenda-cores {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.75rem; /* Reduzido 50% (era 1.5rem) */
        padding: 0.25rem 0.5rem; /* Reduzido 50% (era 0.5rem 1rem) */
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        flex-wrap: wrap;
    }

    .legenda-item {
        display: flex;
        align-items: center;
        gap: 0.2rem; /* Reduzido 50% (era 0.4rem) */
    }

    .legenda-bola {
        width: 16px; /* Ajustado para 16px */
        height: 16px; /* Ajustado para 16px */
        border-radius: 50%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); /* Reduzida a sombra */
    }

    .legenda-texto {
        font-size: 0.8rem; /* Ajustado para 0.8rem */
        color: #495057;
        font-weight: 500;
    }

    /* ======== Syncfusion ComboBox personalizado (motorista) ======== */
    .lstMotorista_popup .e-dropdownbase .e-list-item {
        min-height: 60px;
        display: flex;
        align-items: center;
        padding-left: 10px;
        transition: background-color 0.3s;
    }

        .lstMotorista_popup .e-dropdownbase .e-list-item img {
            height: 45px;
            width: 45px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }

        .lstMotorista_popup .e-dropdownbase .e-list-item:hover {
            background-color: #f0f8ff;
        }

    #lstMotorista_popup .e-dropdownbase .e-list-item:hover img {
        transform: scale(1.2);
    }

    .lstMotorista .e-input-group .e-input,
    .lstMotorista .e-control-wrapper .e-input {
        display: flex;
        align-items: center;
    }

        .lstMotorista .e-input-group .e-input img,
        .lstMotorista .e-control-wrapper .e-input img {
            height: 30px;
            width: 30px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 8px;
        }

    /* ======== Placeholder (mobile) para Ficha de Vistoria ======== */
    .placeholder-mobile::placeholder {
        color: #555555;
        font-style: italic;
        font-weight: 400;
    }

    /* Webkit browsers (Chrome, Safari, Edge) */
    .placeholder-mobile::-webkit-input-placeholder {
        color: #555555;
        font-style: italic;
        font-weight: 400;
    }

    /* Firefox */
    .placeholder-mobile::-moz-placeholder {
        color: #555555;
        font-style: italic;
        font-weight: 400;
        opacity: 1;
    }

    /* IE 10+ */
    .placeholder-mobile:-ms-input-placeholder {
        color: #555555;
        font-style: italic;
        font-weight: 400;
    }

    /* ======== Dist√¢ncia > 100km - Vermelho Negrito ======== */
    .distancia-alerta {
        color: #dc3545 !important;
        font-weight: 700 !important;
    }

    /* ======== Tooltips do Calend√°rio ======== */
    /* Agora usa a classe global .tooltip-ftx-azul definida em frotix.css */

</style>

}
@* ============================================
   FIM DA SECTION HeadBlock
   ============================================ *@

@* ============================================
   CONTE√öDO DA P√Å¬ÅGINA (HTML DO BODY)
   ============================================ *@

@* Modal de Espera - Vis√≠vel desde o in√≠cio *@
<div id="agenda-loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; display: flex; align-items: center; justify-content: center;">
    <div style="background: rgba(30,30,30,0.95); padding: 30px; border-radius: 8px; text-align: center; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" style="width: 80px; height: 80px; margin: 0 auto 20px; display: block; animation: pulse 1.5s ease-in-out infinite;" />
        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 15px;">
            <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #C67750, #ff9966); animation: loading-bar 1.5s ease-in-out infinite;"></div>
        </div>
        <div style="color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 5px;">Carregando Agenda...</div>
        <div style="color: rgba(255,255,255,0.7); font-size: 14px;">Aguarde, por favor</div>
    </div>
</div>

<style>
    @@keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(0.95); }
    }
    @@keyframes loading-bar {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
</style>

<div class="row" align="center">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <!-- ===== HEADER FROTIX ===== -->
            <div class="ftx-card-header">
                <h2 class="titulo-paginas">
                    <i class="fa-duotone fa-calendar-lines-pen"></i>
                    Agenda de Viagens
                </h2>
            </div>

            <div class="panel-container show">
                <div class="panel-content ">

                    <!-- Legenda de Cores -->
                    <div class="legenda-cores">
                        <div class="legenda-item">
                            <span class="legenda-bola" style="background-color: #D55102;"></span>
                            <span class="legenda-texto">Agendamento</span>
                        </div>
                        <div class="legenda-item">
                            <span class="legenda-bola" style="background-color: #4C2B08;"></span>
                            <span class="legenda-texto">Evento</span>
                        </div>
                        <div class="legenda-item">
                            <span class="legenda-bola" style="background-color: #3d5c3d;"></span>
                            <span class="legenda-texto">Aberta</span>
                        </div>
                        <div class="legenda-item">
                            <span class="legenda-bola" style="background-color: #154c62;"></span>
                            <span class="legenda-texto">Realizada</span>
                        </div>
                        <div class="legenda-item">
                            <span class="legenda-bola" style="background-color: #722F37;"></span>
                            <span class="legenda-texto">Cancelada</span>
                        </div>
                    </div>

                    <div id="loading " class="example">
                    </div>
                    <div class="box-body">
                        <br />
                        <div id='agenda'></div>
                        <br /><br />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* ============================================
   MODAL AGENDAMENTO/VIAGENS - REFATORADO
   ============================================ *@

<div class="modal fade" id="modalViagens" role="dialog" data-bs-focus="false">
    <div class="modal-dialog custom-modal-lg">
        <div class="modal-content">
            <div id="Titulo" class="modal-header modal-header-dinheiro">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="close btn-close-modal" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fa-duotone fa-xmark"></i>
                </button>
            </div>
            <div id="divModal" class="modal-body">
                <!-- Hidden Inputs - MANTIDOS TODOS OS ORIGINAIS -->
                <input id="txtReport" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtViagemId" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtRecorrenciaViagemId" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtStatusAgendamento" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtUsuarioIdCriacao" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtDataCriacao" class="form-control form-control-xs" hidden="hidden" />

                <div id="dialogRecorrencia"></div>

                <!-- ============================================
                     SE√á√ÉO 1: INFORMA√á√ïES B√É¬ÅSICAS
                     Campos de data, hora e dura√ß√£o da viagem
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-info-circle"></i> Informa√ß√µes B√°sicas
                    </div>
                    <div class="section-card-body">
                        <div class="row align-baseline">

                            <!-- ===================================
                                 FICHA DE VISTORIA
                                 Campo vis√≠¬≠vel apenas em modo viagem
                                 =================================== -->
                            <div id="divNoFichaVistoria" class="col-12 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        N¬∫ Ficha Vistoria
                                        <i class="fa-duotone fa-clipboard-list field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtNoFichaVistoria" class="form-control form-control-xs" />
                                </div>
                            </div>

                            <!-- ===================================
                                 DATA INICIAL
                                 Data de in√≠¬≠cio da viagem/agendamento
                                 Obrigat√≥rio
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Data Inicial
                                        <i class="fa-duotone fa-calendar-day field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <ejs-datepicker id="txtDataInicial"
                                                    format="dd/MM/yyyy"
                                                    placeholder="Selecione a data"
                                                    locale="pt-BR">
                                    </ejs-datepicker>
                                </div>
                            </div>

                            <!-- ===================================
                                 HORA IN√ç¬çCIO
                                 Hor√°rio de in√≠¬≠cio da viagem
                                 Obrigat√≥rio
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Hora In√≠¬≠cio
                                        <i class="fa-duotone fa-clock field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtHoraInicial" class="form-control form-control-xs" type="time" />
                                </div>
                            </div>

                            <!-- ===================================
                                 DATA FINAL
                                 Data de t√©rmino da viagem
                                 Vis√≠¬≠vel apenas em modo viagem
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div id="divDataFinal" class="form-group">
                                    <label class="label font-weight-bold">
                                        Data Final
                                        <i class="fa-duotone fa-calendar-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <ejs-datepicker id="txtDataFinal"
                                                    format="dd/MM/yyyy"
                                                    placeholder="Selecione a data"
                                                    locale="pt-BR">
                                    </ejs-datepicker>
                                </div>
                            </div>

                            <!-- ===================================
                                 HORA FIM
                                 Hor√°rio de t√©rmino da viagem
                                 Vis√≠vel apenas em modo viagem
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div id="divHoraFinal" class="form-group">
                                    <label class="label font-weight-bold">
                                        Hora Fim
                                        <i class="fa-duotone fa-stopwatch field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtHoraFinal" class="form-control form-control-xs" type="time" />
                                </div>
                            </div>

                            <!-- ===================================
                                 DURA√á√ÉO
                                 Calculado automaticamente (somente leitura)
                                 Diferen√ßa entre data/hora inicial e final
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div id="divDuracao" class="form-group">
                                    <label class="label font-weight-bold">
                                        Dura√ß√£o (hs)
                                        <i class="fa-duotone fa-hourglass-half field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <ejs-numerictextbox id="txtDuracao"
                                                        Enabled="false"
                                                        format="n0"
                                                        Readonly="true"
                                                        showSpinButton="false"
                                                        data-ejtip="Se a <strong>Dura√ß√£o</strong> estiver alta, revise o hor√°rio e datas">
                                    </ejs-numerictextbox>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 2: ROTEIRO
                     Finalidade, origem e destino da viagem
                     ============================================ -->
                <div class="section-card" id="divFinalidadeOrigemDestino">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-route"></i> Roteiro
                    </div>
                    <div class="section-card-body">
                        <div class="row align-baseline">

                            <!-- ===================================
                                 FINALIDADE
                                 Motivo/objetivo da viagem
                                 Campo obrigat√≥rio
                                 Tipo: DropDownTree hier√°rquico
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstFinalidade" class="label mr-2 mb-0">Finalidade</label>
                                            <i class="fa-duotone fa-rectangle-history-circle-user field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <div class="dropdown-wrapper">
                                            <ejs-dropdowntree id="lstFinalidade"
                                                              placeholder="Selecione uma Finalidade..."
                                                              showCheckBox="false"
                                                              allowMultiSelection="false"
                                                              allowFiltering="true"
                                                              filterType="Contains"
                                                              filterBarPlaceholder="Procurar..."
                                                              popupHeight="200px"
                                                              sortOrder="Ascending"
                                                              showClearButton="true">
                                                <e-dropdowntree-fields dataSource="@ViewData["dataFinalidade"]"
                                                                       value="FinalidadeId"
                                                                       text="Descricao">
                                                </e-dropdowntree-fields>
                                            </ejs-dropdowntree>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 ORIGEM
                                 Local de partida da viagem
                                 Campo obrigat√≥rio
                                 Tipo: ComboBox com valores customiz√°veis
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="cmbOrigem" class="label mr-2 mb-0">Origem</label>
                                            <i class="fa-duotone fa-map-location field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>
                                        <!-- allowCustom="true" permite digita√ß√£o livre -->
                                        <ejs-combobox id="cmbOrigem"
                                                      dataSource="@ViewData["ListaOrigem"]"
                                                      placeholder="Selecione ou digite a origem"
                                                      allowFiltering="true"
                                                      filterType="Contains"
                                                      allowCustom="true"
                                                      popupHeight="220px"
                                                      data-ejtip="Origem n√£o est√° na lista? Consulte direito antes de cadastrar!">
                                        </ejs-combobox>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 DESTINO
                                 Local de chegada da viagem
                                 Campo obrigat√≥rio
                                 Tipo: ComboBox com valores customiz√°veis
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="cmbDestino" class="label mr-2 mb-0">Destino</label>
                                            <i class="fa-duotone fa-map-location-dot field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>
                                        <!-- allowCustom="true" permite digita√ß√£o livre -->
                                        <ejs-combobox id="cmbDestino"
                                                      dataSource="@ViewData["ListaDestino"]"
                                                      placeholder="Selecione ou digite o destino"
                                                      allowFiltering="true"
                                                      filterType="Contains"
                                                      allowCustom="true"
                                                      popupHeight="220px"
                                                      data-ejtip="Destino n√£o est√° na lista? Consulte direito antes de cadastrar!">
                                        </ejs-combobox>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 3: EVENTO - SELE√á√ÉO
                     Aparece quando Finalidade = "Evento"
                     Permite selecionar evento existente
                     ============================================ -->
                <div id="sectionEvento" class="section-card" style="display: none;">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-tent-circus"></i> Evento
                    </div>
                    <div class="section-card-body">
                        <div class="row">

                            <!-- ===================================
                                 LISTA DE EVENTOS
                                 ComboBox com eventos cadastrados
                                 =================================== -->
                            <div class="col-md-8 mb-3">
                                <label for="lstEventos" class="label font-weight-bold">
                                    Nome do Evento
                                    <i class="fa-duotone fa-tent-circus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-combobox id="lstEventos"
                                              placeholder="Selecione um evento..."
                                              allowFiltering="true"
                                              filterType="Contains"
                                              dataSource="@ViewData["dataEvento"]"
                                              popupHeight="200px"
                                              showClearButton="true"
                                              data-ejtip="Selecione um evento existente ou cadastre um novo">
                                    <e-combobox-fields text="Evento" value="EventoId"></e-combobox-fields>
                                </ejs-combobox>
                            </div>

                            <!-- ===================================
                                 BOt√£o NOVO EVENTO
                                 Abre formul√°rio de cadastro (se√ß√£o 3.1)
                                 =================================== -->
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <!-- Bot√£o vis√≠vel (dispara o btnEvento oculto) -->
                                <button id="btnInsereNovoEvento"
                                        type="button"
                                        onclick="document.getElementById('btnEvento').click();"
                                        class="btn btn-azul"
                                        style="width: 100%; height: 38px;">
                                    <i class="fa-duotone fa-calendar-check"></i>
                                    Novo Evento
                                </button>

                                <!-- Bot√£o oculto (usado pelo JavaScript) -->
                                <button type="button" id="btnEvento" style="display: none;">Evento</button>
                            </div>

                        </div>

                        <!-- ===================================
                             LINHA 2: CAMPOS DO EVENTO SELECIONADO
                             Aparecem quando um evento √© selecionado
                             Todos os campos desabilitados
                             =================================== -->
                        <div id="divDadosEventoSelecionado" class="row" style="display: none;">

                            <!-- Data In√≠cio -->
                            <div class="col-md-4 mb-3">
                                <label for="txtDataInicioEvento" class="label font-weight-bold">
                                    Data In√≠cio
                                    <i class="fa-duotone fa-calendar-day field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-datepicker id="txtDataInicioEvento"
                                                format="dd/MM/yyyy"
                                                placeholder="Data In√≠cio"
                                                locale="pt-BR"
                                                enabled="false">
                                </ejs-datepicker>
                            </div>

                            <!-- Data Fim -->
                            <div class="col-md-4 mb-3">
                                <label for="txtDataFimEvento" class="label font-weight-bold">
                                    Data Fim
                                    <i class="fa-duotone fa-calendar-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-datepicker id="txtDataFimEvento"
                                                format="dd/MM/yyyy"
                                                placeholder="Data Fim"
                                                locale="pt-BR"
                                                enabled="false">
                                </ejs-datepicker>
                            </div>

                            <!-- Quantidade de Participantes -->
                            <div class="col-md-4 mb-3">
                                <label for="txtQtdParticipantesEvento" class="label font-weight-bold">
                                    Qtd Participantes
                                    <i class="fa-duotone fa-users field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-numerictextbox id="txtQtdParticipantesEvento"
                                                    format="N0"
                                                    min="0"
                                                    placeholder="Quantidade"
                                                    enabled="false">
                                </ejs-numerictextbox>
                            </div>

                        </div>

                        <!-- =================================================================== -->
                        <!-- SE√á√ÉO 3.1: ACCORDION PARA CADASTRO DE NOVO EVENTO -->
                        <!-- Hidden por padr√£o, exibido quando btnEvento (btnInsereNovoEvento) √© clicado -->
                        <!-- =================================================================== -->
                        <div id="sectionCadastroEvento" class="mt-3" style="display: none;">
                            <div class="accordion" id="accordionEvento">
                                <div class="accordion-item">
                                    <div class="section-card-header">
                                        <i class="fa-duotone fa-users"></i> Cadastrar Novo Evento
                                    </div>
                                    <div id="collapseEvento"
                                         class="accordion-collapse collapse show"
                                         aria-labelledby="headingEvento">
                                        <div class="accordion-body">
                                            <!-- Nome do Evento -->
                                            <div class="mb-3">
                                                <label for="txtNomeEvento" class="form-label fw-bold">
                                                    Nome do Evento
                                                    <span class="text-danger">*</span>
                                                </label>
                                                <input type="text"
                                                       class="form-control"
                                                       id="txtNomeEvento"
                                                       placeholder="Digite o nome do evento">
                                            </div>

                                            <!-- Descri√ß√£o do Evento -->
                                            <div class="mb-3">
                                                <label for="txtDescricaoEvento" class="form-label fw-bold">
                                                    Descri√ß√£o do Evento
                                                </label>
                                                <textarea class="form-control"
                                                          id="txtDescricaoEvento"
                                                          rows="3"
                                                          placeholder="Descreva o evento"></textarea>
                                            </div>

                                            <!-- Data Inicial e Final -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="txtDataInicialEvento" class="form-label fw-bold">
                                                        Data In√≠cio
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <ejs-datepicker id="txtDataInicialEvento"
                                                                    placeholder="Selecione a data"
                                                                    format="dd/MM/yyyy"
                                                                    locale="pt-BR"
                                                                    strictMode="true"
                                                                    allowEdit="false">
                                                    </ejs-datepicker>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="txtDataFinalEvento" class="form-label fw-bold">
                                                        Data Fim
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <ejs-datepicker id="txtDataFinalEvento"
                                                                    placeholder="Selecione a data"
                                                                    format="dd/MM/yyyy"
                                                                    locale="pt-BR"
                                                                    strictMode="true"
                                                                    allowEdit="false">
                                                    </ejs-datepicker>
                                                </div>
                                            </div>

                                            <!-- Quantidade de Participantes -->
                                            <div class="mb-3">
                                                <label for="txtQtdParticipantesEventoCadastro" class="form-label fw-bold">
                                                    Quantidade de Participantes
                                                </label>
                                                <ejs-numerictextbox id="txtQtdParticipantesEventoCadastro"
                                                                    placeholder="N√∫mero de participantes"
                                                                    format="n0"
                                                                    min="0"
                                                                    step="1">
                                                </ejs-numerictextbox>
                                            </div>

                                            <!-- Requisitante do Evento -->
                                            <div class="mb-3">
                                                <label for="lstRequisitanteEvento" class="form-label fw-bold">
                                                    Requisitante
                                                </label>
                                                <ejs-dropdowntree id="lstRequisitanteEvento"
                                                                  placeholder="Selecione o requisitante..."
                                                                  showCheckBox="false"
                                                                  allowMultiSelection="false"
                                                                  allowFiltering="true"
                                                                  filterType="Contains"
                                                                  filterBarPlaceholder="Procurar..."
                                                                          popupHeight="200px">
                                                    <e-dropdowntree-fields dataSource="@ViewData["dataRequisitante"]"
                                                                           value="RequisitanteId"
                                                                           text="Requisitante"
                                                                           parentValue="RequisitantePaiId">
                                                    </e-dropdowntree-fields>
                                                </ejs-dropdowntree>
                                            </div>

                                            <!-- Setor do Requisitante -->
                                            <div class="mb-3">
                                                <label for="lstSetorRequisitanteEvento" class="form-label fw-bold">
                                                    Setor
                                                </label>
                                                <ejs-dropdowntree id="lstSetorRequisitanteEvento"
                                                                  placeholder="Selecione o setor..."
                                                                  showCheckBox="false"
                                                                  allowMultiSelection="false"
                                                                  allowFiltering="true"
                                                                  filterType="Contains"
                                                                  filterBarPlaceholder="Procurar..."
                                                                          popupHeight="200px">
                                                    <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                           value="SetorSolicitanteId"
                                                                           text="Nome"
                                                                           parentValue="SetorPaiId"
                                                                                   hasChildren="HasChild">
                                                    </e-dropdowntree-fields>
                                                </ejs-dropdowntree>
                                            </div>

                                            <!-- Bot√µes de A√ß√£o -->
                                            <div class="d-flex justify-content-end gap-2 mt-4">
                                                <button type="button"
                                                        id="btnCancelarEvento"
                                                        class="btn btn-secondary">
                                                    <i class="fa-duotone fa-times me-1"></i>
                                                    Cancelar
                                                </button>
                                                <button type="button"
                                                        id="btnInserirEvento"
                                                        class="btn btn-verde">
                                                    <i class="fa-duotone fa-save me-1 icon-pulse"></i>
                                                    Salvar Evento
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 4: INFORMA√á√ïES DO TRANSPORTE
                     Motorista, ve√≠¬≠culo, quilometragem e combust√≠¬≠vel
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-car"></i> Informa√ß√µes do Transporte
                    </div>
                    <div class="section-card-body">

                        <!-- ===================================
                             LINHA 1: Motorista, Ve√≠¬≠culo e Quilometragem
                             =================================== -->
                        <div class="row align-baseline">

                            <!-- ===================================
                                 MOTORISTA
                                 Campo obrigat√≥rio
                                 Lista apenas motoristas ativos
                                 =================================== -->
                            <div class="col-4 col-md-4">
                                <div class="d-flex flex-column ml-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <label id="lblMotorista" for="lstMotorista" class="label font-weight-bold mr-2" style="margin: 0;">Motorista</label>
                                        <i id="icoMotorista" class="fa-duotone fa-person-biking field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </div>
                                    <ejs-combobox id="lstMotorista"
                                                  placeholder="Selecione um Motorista"
                                                  allowFiltering="true"
                                                  filterType="Contains"
                                                  popupHeight="200px"
                                                  width="100%"
                                                  showClearButton="true"
                                                  dataSource="@ViewData["dataMotorista"]"
                                                  data-ejtip="Motorista n√£o aparece? Talvez esteja inativo">
                                        <e-combobox-fields text="Nome" value="MotoristaId" imageUrl="FotoBase64"></e-combobox-fields>
                                    </ejs-combobox>
                                </div>
                            </div>

                            <!-- ===================================
                                 Ve√≠¬çCULO
                                 Campo obrigat√≥rio
                                 Lista apenas ve√≠¬≠culos ativos
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="d-flex flex-column ml-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <label for="lstVeiculo" class="label mr-2 mb-0">Ve√≠¬≠culo</label>
                                        <i class="fa-duotone fa-truck-bolt field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </div>
                                    <ejs-combobox id="lstVeiculo"
                                                  placeholder="Selecione um Ve√≠¬≠culo"
                                                  allowFiltering="true"
                                                  filterType="Contains"
                                                  dataSource="@ViewData["dataVeiculo"]"
                                                  popupHeight="200px"
                                                  width="100%"
                                                  showClearButton="true"
                                                  data-ejtip="Ve√≠¬≠culo n√£o aparece? Talvez esteja inativo">
                                        <e-combobox-fields text="Descricao" value="VeiculoId"></e-combobox-fields>
                                    </ejs-combobox>
                                </div>
                            </div>

                            <!-- ===================================
                                 BLOCO DE QUILOMETRAGEM
                                 4 campos relacionados ao hod√¥metro
                                 Vis√≠veis apenas em modo viagem
                                 =================================== -->
                            <div class="col-5 col-md-5 d-flex align-items-start">
                                <!-- KM Atual (somente leitura - mostra √∫ltimo KM registrado) -->
                                <div class="form-group mr-2" id="divKmAtual">
                                    <label class="label">
                                        Km Atual
                                        <i class="fa-duotone fa-gauge field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input readonly id="txtKmAtual" class="form-control form-control-xs" />
                                </div>

                                <!-- KM Inicial (preenchido ao iniciar viagem) -->
                                <div class="form-group mr-2" id="divKmInicial">
                                    <label class="label">
                                        Km Inicial
                                        <i class="fa-duotone fa-gauge-max field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtKmInicial" class="form-control form-control-xs" />
                                </div>

                                <!-- KM Final (preenchido ao finalizar viagem) -->
                                <div class="form-group mr-2" id="divKmFinal">
                                    <label class="label">
                                        Km Final
                                        <i class="fa-duotone fa-gauge-min field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtKmFinal" class="form-control form-control-xs" />
                                </div>

                                <!-- Dist√¢ncia (calculado: KM Final - KM Inicial) -->
                                <div class="form-group mr-2" id="divQuilometragem">
                                    <label class="label">
                                        Dist√¢ncia
                                        <i class="fa-duotone fa-road field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtQuilometragem"
                                           class="form-control form-control-xs"
                                           readonly
                                           data-ejtip="Quilometragem alta? Confirme os valores antes de salvar" />
                                </div>
                            </div>

                        </div>

                        <!-- ===================================
                             LINHA 2: n√≠veis de Combust√≠¬≠vel
                             Vis√≠veis apenas em modo viagem
                             =================================== -->
                        <div class="row align-baseline mt-3">

                            <!-- Combust√≠¬≠vel Inicial -->
                            <div class="col-6 col-md-3">
                                <div class="form-group" id="divCombustivelInicial">
                                    <label class="label">
                                        Combust√≠¬≠vel Inicial
                                        <i class="fa-duotone fa-gauge-circle-plus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <!-- DropDownTree com imagens dos n√≠veis -->
                                    <ejs-dropdowntree id="ddtCombustivelInicial" popupHeight="200px" showClearButton="true">
                                        <e-dropdowntree-fields dataSource="@ViewData["dataCombustivel"]"
                                                               value="Nivel"
                                                               text="Descricao"
                                                               imageURL="Imagem">
                                        </e-dropdowntree-fields>
                                    </ejs-dropdowntree>
                                </div>
                            </div>

                            <!-- Combust√≠¬≠vel Final -->
                            <div class="col-6 col-md-3">
                                <div class="form-group" id="divCombustivelFinal">
                                    <label class="label">
                                        Combust√≠¬≠vel Final
                                        <i class="fa-duotone fa-gauge-circle-minus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <!-- DropDownTree com imagens dos n√≠veis -->
                                    <ejs-dropdowntree id="ddtCombustivelFinal" popupHeight="200px" showClearButton="true">
                                        <e-dropdowntree-fields dataSource="@ViewData["dataCombustivel"]"
                                                               value="Nivel"
                                                               text="Descricao"
                                                               imageURL="Imagem">
                                        </e-dropdowntree-fields>
                                    </ejs-dropdowntree>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 5: REQUISITANTE E SETOR
                     Dados do solicitante da viagem
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-users"></i> Requisitante e Setor
                    </div>
                    <div class="section-card-body">
                        <!-- g-3: espa√ßamento horizontal/vertical; align-items-end: alinha pela base -->
                        <div class="row g-3 align-items-end">

                            <!-- ===================================
                                 BLOCO 1: REQUISITANTE (col-md-5)
                                 ComboBox + Bot√£o "Novo Requisitante"
                                 =================================== -->
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <div class="d-flex flex-column">
                                        <!-- Label com √≠cone -->
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstRequisitante" class="label font-weight-bold mr-2" style="margin: 0;">
                                                Requisitante
                                            </label>
                                            <i class="fa-duotone fa-person-simple field-icon"
                                               style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <!-- ComboBox + Bot√£o na mesma linha -->
                                        <div class="d-flex flex-row align-items-center" style="gap: 6px;">
                                            <!-- Lista de Requisitantes -->
                                            <ejs-combobox id="lstRequisitante"
                                                          placeholder="Selecione um Requisitante..."
                                                          allowFiltering="true"
                                                          filterType="Contains"
                                                          dataSource="@ViewData["dataRequisitante"]"
                                                          popupHeight="200px"
                                                          showClearButton="true"
                                                          cssClass="flex-grow-1"
                                                          data-ejtip="Se o <strong>Requisitante</strong> n√£o estiver presente na Lista, verifique primeiro se ele n√£o est√° <strong>Inativo</strong> antes de cadastrar um novo">
                                                <e-combobox-fields text="Requisitante" value="RequisitanteId"></e-combobox-fields>
                                            </ejs-combobox>

                                            <!-- Bot√£o Novo Requisitante -->
                                            <a class="btn btn-nfs" id="btnRequisitante" style="height: 38px; display: flex; align-items: center;">
                                                <i class="fa-duotone fa-user-plus"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 BLOCO 2: RAMAL (col-md-2)
                                 N√∫mero de telefone/ramal do requisitante
                                 =================================== -->
                            <div class="col-md-2">
                                <div class="form-group mb-0">
                                    <div class="d-flex flex-column">
                                        <!-- Label com √≠cone -->
                                        <div class="d-flex align-items-center mb-1">
                                            <label class="label font-weight-bold mr-2" style="margin: 0;">
                                                Ramal
                                            </label>
                                            <i class="fa-duotone fa-phone-office field-icon"
                                               style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <!-- Input Ramal -->
                                        <input type="text" id="txtRamalRequisitanteSF" class="form-control" placeholder="Ex: 1234" />
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 BLOCO 3: SETOR (col-md-5)
                                 DropDownTree hier√°rquico de setores
                                 =================================== -->
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <div class="d-flex flex-column">
                                        <!-- Label com √≠cone -->
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstSetorRequisitanteAgendamento" class="label font-weight-bold mr-2" style="margin: 0;">
                                                Setor do Requisitante
                                            </label>
                                            <i class="fa-duotone fa-building-user field-icon"
                                               style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <!-- DropDownTree com estrutura hier√°rquica -->
                                        <ejs-dropdowntree id="lstSetorRequisitanteAgendamento"
                                                          allowFiltering="true"
                                                          placeholder="Selecione um setor..."
                                                          sortOrder="Ascending"
                                                          showCheckBox="false"
                                                          filterType="Contains"
                                                          filterBarPlaceholder="Procurar setor..."
                                                          popupHeight="200px">
                                            <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                   value="SetorSolicitanteId"
                                                                   parentValue="SetorPaiId"
                                                                   hasChildren="HasChild"
                                                                   text="Nome">
                                            </e-dropdowntree-fields>
                                        </ejs-dropdowntree>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================================================
                                 CARD PARA CADASTRO DE NOVO REQUISITANTE
                                 Fica em uma nova linha (col-12) para n√£o quebrar os 3 blocos acima
                                 =================================================================== -->
                            <div class="col-12">
                                <div id="sectionCadastroRequisitante" class="mt-3" style="display: none;">
                                    <div class="accordion" id="accordionRequisitante">
                                        <div class="accordion-item">
                                            <div class="section-card-header">
                                                <i class="fa-duotone fa-users"></i> Cadastrar Novo Requisitante
                                            </div>
                                            <div id="collapseRequisitante"
                                                 class="accordion-collapse collapse show"
                                                 aria-labelledby="headingRequisitante">
                                                <div class="accordion-body">
                                                    <!-- Ponto / Nome -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-3">
                                                            <label for="txtPonto" class="form-label fw-bold">Ponto</label>
                                                            <input type="text" class="form-control" id="txtPonto" placeholder="Digite o ponto">
                                                        </div>
                                                        <div class="col-md-9">
                                                            <label for="txtNome" class="form-label fw-bold">
                                                                Nome do Requisitante <span class="text-danger">*</span>
                                                            </label>
                                                            <input type="text" class="form-control" id="txtNome" placeholder="Digite o nome do requisitante">
                                                        </div>
                                                    </div>

                                                    <!-- Ramal / Email -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-4">
                                                            <label for="txtRamal" class="form-label fw-bold">Ramal</label>
                                                            <input type="text" class="form-control" id="txtRamal" placeholder="Digite o ramal">
                                                        </div>
                                                        <div class="col-md-8">
                                                            <label for="txtEmail" class="form-label fw-bold">Email</label>
                                                            <input type="email" class="form-control" id="txtEmail" placeholder="Digite o email">
                                                        </div>
                                                    </div>

                                                    <!-- Setor -->
                                                    <div class="mb-3">
                                                        <label for="ddtSetorRequisitante" class="form-label fw-bold">Setor do Requisitante</label>
                                                        <ejs-dropdowntree id="ddtSetorRequisitante"
                                                                          allowFiltering="true"
                                                                          placeholder="Selecione o setor..."
                                                                          sortOrder="Ascending"
                                                                          showCheckBox="false"
                                                                          filterType="Contains"
                                                                          filterBarPlaceholder="Procurar..."
                                                                          popupHeight="200px">
                                                            <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                                   value="SetorSolicitanteId"
                                                                                   parentValue="SetorPaiId"
                                                                                   hasChildren="HasChild"
                                                                                   text="Nome">
                                                            </e-dropdowntree-fields>
                                                        </ejs-dropdowntree>
                                                    </div>

                                                    <!-- Bot√µes -->
                                                    <div class="d-flex justify-content-end gap-2 mt-4">
                                                        <button type="button" id="btnFecharAccordionRequisitante" class="btn btn-vinho">
                                                            <span class="btn-inner">
                                                                <i class="fa-duotone fa-circle-xmark icon-spin"></i>
                                                                <span>Cancelar</span>
                                                            </span>
                                                        </button>
                                                        <button type="button" id="btnInserirRequisitante" class="btn btn-azul">
                                                            <span class="btn-inner">
                                                                <i class="fa-duotone fa-down-to-bracket"></i>
                                                                <span>Salvar Requisitante</span>
                                                            </span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- /.accordion -->
                                </div><!-- /#sectionCadastroRequisitante -->
                            </div><!-- /.col-12 -->

                        </div><!-- /.row -->
                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 6: CONFIGURA√á√ïES DE RECORR√äNCIA
                     Define se a viagem se repete e com qual frequ√™ncia
                     ============================================ -->
                <div class="section-card" id="cardRecorrencia">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-repeat"></i> Configura√ß√µes de Recorr√™ncia
                    </div>
                    <div class="section-card-body">
                        <div class="select-container" id="divRecorrencia">

                            <!-- ===================================
                                 LINHA 1: Recorrente? e Per√≠¬≠odo
                                 =================================== -->
                            <div class="row">

                                <!-- lstRecorrente - Col 2 (CORRIGIDO: era col-md-9) -->
                                <div class="col-md-2">
                                    <div class="form-group mb-3">
                                        <label for="lstRecorrente" class="label font-weight-bold">
                                            Recorrente?
                                            <i class="fa-duotone fa-arrows-spin field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-dropdownlist id="lstRecorrente"
                                                          popupHeight="200px"
                                                          cssClass="e-outline text-center"
                                                          floatLabelType="Never">
                                            <e-dropdownlist-fields text="Descricao" value="RecorrenteId"></e-dropdownlist-fields>
                                        </ejs-dropdownlist>
                                    </div>
                                </div>

                                <!-- lstPeriodos - Col 2 (CORRIGIDO: era col-md-3) -->
                                <div class="col-md-2" id="divPeriodo" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="lstPeriodos" class="label font-weight-bold">
                                            Per√≠¬≠odo
                                            <i class="fa-duotone fa-calendar-circle-exclamation field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <input id="lstPeriodos"
                                               type="text"
                                               class="e-control e-dropdownlist"
                                               style="width: 100%; height: 38px;" />
                                    </div>
                                </div>

                            </div>

                            <!-- LINHA 2: Campos espec√≠¬≠ficos por per√≠¬≠odo -->
                            <div class="row">

                                <!-- lstDias - Col 6 (CORRIGIDO: era col-md-4) -->
                                <div class="col-md-6" id="divDias" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="lstDias" class="label font-weight-bold">
                                            Dias da Semana
                                            <i class="fa-duotone fa-calendar-week field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-multiselect id="lstDias"
                                                         placeholder="Selecione os dias..."
                                                         mode="CheckBox"
                                                         showSelectAll="true"
                                                         selectAllText="Selecionar todos"
                                                         unSelectAllText="Desmarcar todos"
                                                         popupHeight="250px">
                                            <e-multiselect-fields value="Value" text="Text"></e-multiselect-fields>
                                        </ejs-multiselect>
                                    </div>
                                </div>

                                <!-- lstDiasMes - Col 3 (MANTIDO) -->
                                <div class="col-md-3" id="divDiaMes" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="lstDiasMes" class="label font-weight-bold">
                                            Dia do M√™s
                                            <i class="fa-duotone fa-calendar-clock field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-dropdownlist id="lstDiasMes"
                                                          placeholder="Selecione o dia..."
                                                          popupHeight="250px"
                                                          cssClass="e-outline">
                                            <e-dropdownlist-fields value="Value" text="Text"></e-dropdownlist-fields>
                                        </ejs-dropdownlist>
                                    </div>
                                </div>

                                <!-- txtFinalRecorrencia - Col 3 (CORRIGIDO: era col-md-5) -->
                                <div class="col-md-3" id="divFinalRecorrencia" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="txtFinalRecorrencia" class="label font-weight-bold">
                                            Data Final Recorr√™ncia
                                            <i class="fa-duotone fa-calendar-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-datepicker id="txtFinalRecorrencia"
                                                        format="dd/MM/yyyy"
                                                        placeholder="Selecione a data final"
                                                        locale="pt-BR"
                                                        cssClass="e-outline">
                                        </ejs-datepicker>
                                    </div>
                                </div>

                            </div>

                            <!-- ===================================
                                 LINHA 3: CALEND√Å¬ÅRIO (Recorr√™ncia Variada)
                                 Permite selecionar datas espec√≠¬≠ficas manualmente
                                 =================================== -->
                            <div class="row" id="calendarContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="form-group mb-3">
                                        <label class="label font-weight-bold" id="lblSelecioneAsDatas">
                                            Selecione as Datas
                                            <i class="fa-duotone fa-calendar-days field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <!-- Componente Calendar ser√° inicializado via JavaScript -->
                                        <div id="calDatasSelecionadas"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- ============================================
                                 CONTAINER LISTBOX - DATAS VARIADAS
                                 Exibe datas selecionadas em recorr√™ncia variada
                                 ============================================ -->
                            <div class="row" id="listboxDatasVariadasContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="form-group mb-3 position-relative">
                                        <!-- Badge contador (similar ao calend√°rio) -->
                                        <span id="badgeContadorDatasVariadas" class="badge">0</span>

                                        <label class="label font-weight-bold">
                                            Datas Selecionadas para este Agendamento
                                            <i class="fa-duotone fa-list-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>

                                        <!-- ListBox Syncfusion ser√° inicializado aqui via JavaScript -->
                                        <select id="lstDatasVariadas" class="form-control"></select>

                                        <small class="form-text text-muted mt-2">
                                            <i class="fa-duotone fa-info-circle"></i>
                                            Lista de todas as datas vinculadas a este agendamento recorrente.
                                            <span style="color: #dc3545; font-weight: bold;">A data atual √© destacada em vermelho.</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 7: DESCRI√á√ÉO DA VIAGEM
                     Editor de texto rico para detalhes da viagem
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-file-alt"></i> Descri√ß√£o da Viagem
                    </div>
                    <div class="section-card-body">
                        <div class="row">
                            <div class="col-md-12 col-xl-10 control-section">
                                <div class="control-wrapper">
                                    <div>
                                        <div class="d-flex flex-column ml-2">
                                            <div class="d-flex align-items-center mb-1">
                                                <label for="rteDescricao" class="label mr-2 mb-0">Descri√ß√£o da Viagem (passageiros / carga)</label>
                                                <i class="fa-duotone fa-typewriter field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                            </div>
                                            <!-- Kendo Editor - Substitui Syncfusion RTE -->
                                            <!-- Upload de imagens configurado em kendo-editor-helper.js -->
                                            <textarea id="rteDescricao" name="Descricao" style="height:250px; width:100%;"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SE√á√ÉO 8: RELAt√ìRIO DA FICHA DE VISTORIA
                     Exibe PDF da ficha de viagem usando Telerik
                     Vis√≠vel apenas quando viagem possui ID
                     ============================================ -->
                <div class="section-card" id="cardRelatorio" style="display: none;">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-file-pdf" style="color: #e74c3c;"></i> Ficha da Viagem
                    </div>
                    <div class="section-card-body p-0">
                        <!-- Hidden input para armazenar ID da viagem -->
                        <input type="hidden" id="txtViagemIdRelatorio" />

                        <!-- Container do Telerik Report Viewer -->
                        <div id="ReportContainerAgenda" style="min-height: 850px; background-color: #f8f9fa;">
                            <div id="reportViewerAgenda" style="width:100%; height: 800px; min-height: 800px;">
                                <!-- Spinner de carregamento -->
                                <div class="text-center p-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Carregando relat√≥rio...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Labels - Gerenciadas por JavaScript -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div id="lblUsuarioAgendamento" style="display: none;"></div>
                        <div id="lblUsuarioCriacao" style="display: none;"></div>
                        <div id="lblUsuarioFinalizacao" style="display: none;"></div>
                        <div id="lblUsuarioCancelamento" style="display: none;"></div>
                    </div>
                </div>

                <!-- Modal Footer - MANTIDO ORIGINAL -->
                <div class="modal-footer" id="divBotoes">
                    <button id="btnViagem" type="button" class="btn btn-sm btn-fundo-laranja">
                        <i class="fa-duotone fa-shuffle" aria-hidden="true"></i>&nbsp;Transforma em Viagem
                    </button>
                    <button id="btnConfirma" type="button" class="btn btn-sm btn-azul">
                        <i class="fa fa-save" aria-hidden="true"></i>Confirmar
                    </button>
                    <button id="btnApaga" type="button" class="btn btn-sm btn-vinho">
                        <i class="fa-duotone fa-trash-can-undo" aria-hidden="true"></i>Apagar
                    </button>
                    <button id="btnCancela" type="button" class="btn btn-sm fundo-vermelho">
                        <i class="fa fa-ban" aria-hidden="true"></i>Cancelar
                    </button>
                    <button id="btnFecha" type="button" class="btn btn-sm fundo-ebony" data-bs-dismiss="modal">
                        <i class="fa fa-times" aria-hidden="true"></i>Fechar
                    </button>

                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock
{
@* ============================================
       DADOS DO SERVIDOR (C# √¢‚Ä†‚Äô JavaScript)
       ============================================ *@
<script>
    window.dataFinalidade = @Html.Raw(Json.Serialize(ViewData["dataFinalidade"]));
    window.dataPeriodo = @Html.Raw(Json.Serialize(ViewData["dataPeriodo"]));
    window.dataPeriodos = @Html.Raw(Json.Serialize(ViewData["dataPeriodos"]));
</script>

@* ============================================
       DEPEND√öNCIAS EXTERNAS
       ============================================ *@
<link href="https://cdn.kendostatic.com/2022.1.412/styles/kendo.default-main.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.kendostatic.com/2022.1.412/js/jszip.min.js"></script>
<script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.all.min.js"></script>
<script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.aspnetmvc.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
<script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
</script>
<script src="/api/reports/resources/js/telerikReportViewer"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.js" integrity="sha512-zAadCzZHXo/f5A/3uhF50bZXahdYNqisNgKKniyoJJVpp27b2bR82N4hPLGj3/qBEh3tGZ9SYGmSA1jpdtNF5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="~/lib/fullcalendar/locales-all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
<script src="/api/reports/resources/js/telerikReportViewer-18.1.24.514.min.js"></script>

@* ============================================
       CORE - Camada Base
       ============================================ *@
<script src="~/js/agendamento/core/ajax-helper.js" asp-append-version="true"></script>
<script src="~/js/agendamento/core/state.js" asp-append-version="true"></script>
<script src="~/js/agendamento/core/api-client.js" asp-append-version="true"></script>

@* ============================================
       UTILS - Utilit√°rios
       ============================================ *@
<script src="~/js/agendamento/utils/date.utils.js" asp-append-version="true"></script>
<script src="~/js/agendamento/utils/syncfusion.utils.js" asp-append-version="true"></script>
<script src="~/js/agendamento/utils/kendo-editor-helper.js" asp-append-version="true"></script>
<script src="~/js/agendamento/utils/formatters.js" asp-append-version="true"></script>

@* ============================================
       SERVICES - Servi√ßos de API
       ============================================ *@
<script src="~/js/agendamento/services/agendamento.service.js" asp-append-version="true"></script>
<script src="~/js/agendamento/services/viagem.service.js" asp-append-version="true"></script>
<script src="~/js/agendamento/services/requisitante.service.js" asp-append-version="true"></script>
<script src="~/js/agendamento/services/evento.service.js" asp-append-version="true"></script>

@* ============================================
       COMPONENTS - Componentes da UI
       ============================================ *@
<script src="~/js/agendamento/components/validacao.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/modal-viagem-novo.js?v=@DateTime.Now.Ticks"></script>
<script src="~/js/agendamento/components/recorrencia.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/modal-config.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/exibe-viagem.js?v=@DateTime.Now.Ticks"></script>
<script src="~/js/agendamento/components/event-handlers.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/dialogs.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/controls-init.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/recorrencia-init.js" asp-append-version="true"></script>
@* <script src="~/js/agendamento/components/sweetalert_interop.patch.js" asp-append-version="true"></script> *@
<script src="~/js/agendamento/components/reportviewer-close-guard.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/relatorio.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/evento.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/recorrencia-logic.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/calendario.js?v=@DateTime.Now.Ticks"></script>

@* ============================================
       VALIDA√á√ÉO IA - Validador Evolutivo de Finaliza√ß√£o
       ============================================ *@
<script src="~/js/validacao/ValidadorFinalizacaoIA.js" asp-append-version="true"></script>

@* ============================================
       MAIN - Inicializa√ß√£o (SEMPRE POR √öLTIMO)
       ============================================ *@
<script src="~/js/agendamento/main.js" asp-append-version="true"></script>

}
