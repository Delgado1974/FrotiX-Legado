@page

@using FrotiX.Repository.IRepository
@using Syncfusion.EJ2
@using Stimulsoft.Report.Mvc;
@using Syncfusion.EJ2.DropDowns
@using Syncfusion.EJ2.Navigations
@using Syncfusion.EJ2.Base
@using Syncfusion.EJ2.Popups
@using Kendo.Mvc.UI
@using FrotiX.Helpers;

@model FrotiX.Models.Agenda

@inject IUnitOfWork _unitOfWork

@* ============================================
   FUNÇÕES DO SERVIDOR (FORA DE BLOCOS @{})
   ============================================ *@
@functions {
    public void OnGet()
    {
    FrotiX.Pages.Agenda.IndexModel.Initialize(_unitOfWork);
    ViewData["dataCombustivel"] = new ListaNivelCombustivel(_unitOfWork).NivelCombustivelList();
    ViewData["dataMotorista"] = new ListaMotorista(_unitOfWork).MotoristaList();
    ViewData["dataVeiculo"] = new ListaVeiculos(_unitOfWork).VeiculosList();
    ViewData["dataSetor"] = new ListaSetores(_unitOfWork).SetoresList();
    ViewData["dataRequisitante"] = new ListaRequisitante(_unitOfWork).RequisitantesList();
    ViewData["dataFinalidade"] = new ListaFinalidade(_unitOfWork).FinalidadesList();
    ViewData["dataEvento"] = new ListaEvento(_unitOfWork).EventosList();
    ViewData["dataSetorEvento"] = new ListaSetoresEvento(_unitOfWork).SetoresEventoList();
    ViewData["dataPeriodo"] = new ListaPeriodos().PeriodosList();
    ViewData["dataRecorrente"] = new ListaRecorrente().RecorrenteList();

    var listaOrigem = _unitOfWork.Viagem.GetAllReduced(selector: v => v.Origem)
        .Where(o => o != null)
        .Distinct()
        .OrderBy(o => o)
        .ToList();
    ViewData["ListaOrigem"] = listaOrigem;

    var listaDestino = _unitOfWork.Viagem.GetAllReduced(selector: v => v.Destino)
        .Where(d => d != null)
        .Distinct()
        .OrderBy(d => d)
        .ToList();
    ViewData["ListaDestino"] = listaDestino;
    }
}

@* ============================================
   CONFIGURAÇÕES DE MODAL E BOTÕES
   ============================================ *@
@{
var Modalanimation = new Syncfusion.EJ2.Popups.DialogAnimationSettings { Effect = Syncfusion.EJ2.Popups.DialogEffect.None };
var Okbutton = new
{
    content = "Inserir Requisitante" ,
    isPrimary = true
};
var Closebutton = new
{
    content = "Fechar" ,
    isPrimary = false
};
}

@* ============================================
   CONFIGURAÇÕES DA PÃGINA
   ============================================ *@
@{
ViewData["Title"] = "Agenda";
ViewData["PageName"] = "agenda_index";
ViewData["Heading"] = "<i class='fad fa-calendar-alt'></i> Agenda: <span class='fw-300'>Agenda de Viagens</span>";
ViewData["Category1"] = "Agenda";
ViewData["PageIcon"] = "fad fa-calendar-alt";
}

@* ============================================
   SECTION HEAD BLOCK - CSS E SCRIPTS DO HEAD
   ============================================ *@
@section HeadBlock {

<link rel="stylesheet" href="~/css/modal-viagens-consolidado.css" asp-append-version="true" />

<!-- FullCalendar 6.1.15 -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
@Html.Raw("<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js'></script>")

<link rel="stylesheet" type="text/css" href="~/css/spinkit.css">

<!-- Kendo UI (padronizado 2024.3.806) -->
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.2.1/default/default-main.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.3.806/js/jszip.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.3.806/js/kendo.all.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2024.3.806/js/kendo.aspnetmvc.min.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
<script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
</script>

<script>

            /**
     * Inicializa os templates do ComboBox de Motorista
     * Configura itemTemplate e valueTemplate com fotos
     */
    function onLstMotoristaCreated() {
        try {
            const combo = document.getElementById('lstMotorista');
            if (!combo || !combo.ej2_instances || !combo.ej2_instances[0]) {
                console.warn('lstMotorista não encontrado ou não inicializado');
                return;
            }

            const motoristaCombo = combo.ej2_instances[0];

            // Template para itens da lista (dropdown)
            motoristaCombo.itemTemplate = function (data) {
                if (!data) return '';

                let imgSrc = '/images/barbudo.jpg'; // Imagem padrío

                // Verifica se tem foto em base64
                if (data.Foto && data.Foto.startsWith('data:image')) {
                    imgSrc = data.Foto;
                }

                return `
                    <div class="d-flex align-items-center">
                        <img src="${imgSrc}"
                             alt="Foto ${data.Nome || 'Motorista'}"
                             style="height:40px; width:40px; border-radius:50%; margin-right:10px; object-fit: cover;"
                             onerror="this.src='/images/barbudo.jpg';" />
                        <span>${data.Nome || ''}</span>
                    </div>`;
            };

            // Template para valor selecionado (input)
            motoristaCombo.valueTemplate = function (data) {
                if (!data) return '';

                let imgSrc = '/images/barbudo.jpg'; // Imagem padrío

                // Verifica se tem foto em base64
                if (data.Foto && data.Foto.startsWith('data:image')) {
                    imgSrc = data.Foto;
                }

                return `
                    <div class="d-flex align-items-center">
                        <img src="${imgSrc}"
                             alt="Foto ${data.Nome || 'Motorista'}"
                             style="height:30px; width:30px; border-radius:50%; margin-right:10px; object-fit: cover;"
                             onerror="this.src='/images/barbudo.jpg';" />
                        <span>${data.Nome || ''}</span>
                    </div>`;
            };

            console.log('Templates de foto do motorista configurados com sucesso');
        } catch (error) {
            console.error('Erro ao configurar templates do motorista:', error);
            // Se houver sistema de alertas
            if (typeof Alerta !== 'undefined' && Alerta.TratamentoErroComLinha) {
                Alerta.TratamentoErroComLinha("motorista-templates.js", "onLstMotoristaCreated", error);
            }
        }
    }

    /**
     * Handler de mudança do ComboBox de Motorista
     * Atualiza foto quando motorista é selecionado
     */
    function onLstMotoristaChange(args) {
        try {
            const motoristaId = args?.itemData?.MotoristaId;

            if (!motoristaId) {
                console.log('Nenhum motorista selecionado');
                return;
            }

            console.log('Motorista selecionado:', motoristaId);

            // Se houver um elemento de foto para atualizar
            const fotoElement = document.getElementById("fotoMotorista");
            if (fotoElement && args.itemData.Foto) {
                fotoElement.src = args.itemData.Foto;
                fotoElement.style.display = 'block';
            }

            // Opcional: buscar mais detalhes do motorista via API
            // fetch(`/api/Viagem/FotoMotorista?id=${motoristaId}`)
            //     .then(resp => resp.json())
            //     .then(data => {
            //         if (data.fotoBase64 && fotoElement) {
            //             fotoElement.src = data.fotoBase64;
            //             fotoElement.style.display = 'block';
            //         }
            //     })
            //     .catch(error => console.error('Erro ao buscar foto:', error));

        } catch (error) {
            console.error('Erro ao processar mudança de motorista:', error);
            if (typeof Alerta !== 'undefined' && Alerta.TratamentoErroComLinha) {
                Alerta.TratamentoErroComLinha("motorista-templates.js", "onLstMotoristaChange", error);
            }
        }
    }

</script>

<style>

    /* ======== Syncfusion ComboBox personalizado (motorista) ======== */
    .lstMotorista_popup .e-dropdownbase .e-list-item {
        min-height: 60px;
        display: flex;
        align-items: center;
        padding-left: 10px;
        transition: background-color 0.3s;
    }

        .lstMotorista_popup .e-dropdownbase .e-list-item img {
            height: 45px;
            width: 45px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }

        .lstMotorista_popup .e-dropdownbase .e-list-item:hover {
            background-color: #f0f8ff;
        }

    #lstMotorista_popup .e-dropdownbase .e-list-item:hover img {
        transform: scale(1.2);
    }

    .lstMotorista .e-input-group .e-input,
    .lstMotorista .e-control-wrapper .e-input {
        display: flex;
        align-items: center;
    }

        .lstMotorista .e-input-group .e-input img,
        .lstMotorista .e-control-wrapper .e-input img {
            height: 30px;
            width: 30px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 8px;
        }

</style>

}
@* ============================================
   FIM DA SECTION HeadBlock
   ============================================ *@

@* ============================================
   CONTEÚDO DA PÁGINA (HTML DO BODY)
   ============================================ *@

<div class="row" align="center">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">
                <div class="panel-content ">
                    <div id="loading " class="example">
                    </div>
                    <div class="box-body">
                        <br /><br />
                        <div id='agenda'></div>
                        <br /><br />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* ============================================
   MODAL AGENDAMENTO/VIAGENS - REFATORADO
   ============================================ *@

<div class="modal fade" id="modalViagens" role="dialog" data-bs-focus="false">
    <div class="modal-dialog custom-modal-lg">
        <div class="modal-content">
            <div id="Titulo" class="modal-header modal-header-dinheiro">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="divModal" class="modal-body">
                <!-- Hidden Inputs - MANTIDOS TODOS OS ORIGINAIS -->
                <input id="txtReport" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtViagemId" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtRecorrenciaViagemId" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtStatusAgendamento" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtUsuarioIdCriacao" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtDataCriacao" class="form-control form-control-xs" hidden="hidden" />

                <div id="dialogRecorrencia"></div>

                <!-- ============================================
                     SEÇÃO 1: INFORMAÇÕES BÃSICAS
                     Campos de data, hora e duração da viagem
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-info-circle"></i> Informações Básicas
                    </div>
                    <div class="section-card-body">
                        <div class="row align-baseline">

                            <!-- ===================================
                                 FICHA DE VISTORIA
                                 Campo visí­vel apenas em modo viagem
                                 =================================== -->
                            <div id="divNoFichaVistoria" class="col-12 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Nº Ficha Vistoria
                                        <i class="fa-duotone fa-solid fa-clipboard-list field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtNoFichaVistoria" class="form-control form-control-xs" />
                                </div>
                            </div>

                            <!-- ===================================
                                 DATA INICIAL
                                 Data de iní­cio da viagem/agendamento
                                 Obrigatório
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Data Inicial
                                        <i class="fa-duotone fa-solid fa-calendar-day field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <ejs-datepicker id="txtDataInicial"
                                                    format="dd/MM/yyyy"
                                                    placeholder="Selecione a data"
                                                    locale="pt-BR">
                                    </ejs-datepicker>
                                </div>
                            </div>

                            <!-- ===================================
                                 HORA INÍCIO
                                 Horário de iní­cio da viagem
                                 Obrigatório
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Hora Iní­cio
                                        <i class="fa-duotone fa-solid fa-clock field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtHoraInicial" class="form-control form-control-xs" type="time" />
                                </div>
                            </div>

                            <!-- ===================================
                                 DATA FINAL
                                 Data de término da viagem
                                 Visí­vel apenas em modo viagem
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div id="divDataFinal" class="form-group">
                                    <label class="label font-weight-bold">
                                        Data Final
                                        <i class="fa-duotone fa-solid fa-calendar-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <ejs-datepicker id="txtDataFinal"
                                                    format="dd/MM/yyyy"
                                                    placeholder="Selecione a data"
                                                    locale="pt-BR">
                                    </ejs-datepicker>
                                </div>
                            </div>

                            <!-- ===================================
                                 HORA FIM
                                 Horário de término da viagem
                                 Visível apenas em modo viagem
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div id="divHoraFinal" class="form-group">
                                    <label class="label font-weight-bold">
                                        Hora Fim
                                        <i class="fa-duotone fa-solid fa-stopwatch field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtHoraFinal" class="form-control form-control-xs" type="time" />
                                </div>
                            </div>

                            <!-- ===================================
                                 DURAÇÃO
                                 Calculado automaticamente (somente leitura)
                                 Diferença entre data/hora inicial e final
                                 =================================== -->
                            <div class="col-6 col-md-2">
                                <div id="divDuracao" class="form-group">
                                    <label class="label font-weight-bold">
                                        Duração (hs)
                                        <i class="fa-duotone fa-solid fa-hourglass-half field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <ejs-numerictextbox id="txtDuracao"
                                                        Enabled="false"
                                                        format="n0"
                                                        Readonly="true"
                                                        showSpinButton="false"
                                                        data-ejtip="Se a <strong>Duração</strong> estiver alta, revise o horário e datas">
                                    </ejs-numerictextbox>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 2: ROTEIRO
                     Finalidade, origem e destino da viagem
                     ============================================ -->
                <div class="section-card" id="divFinalidadeOrigemDestino">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-route"></i> Roteiro
                    </div>
                    <div class="section-card-body">
                        <div class="row align-baseline">

                            <!-- ===================================
                                 FINALIDADE
                                 Motivo/objetivo da viagem
                                 Campo obrigatório
                                 Tipo: DropDownTree hierárquico
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstFinalidade" class="label mr-2 mb-0">Finalidade</label>
                                            <i class="fa-duotone fa-solid fa-rectangle-history-circle-user field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <div class="dropdown-wrapper">
                                            <ejs-dropdowntree id="lstFinalidade"
                                                              placeholder="Selecione uma Finalidade..."
                                                              showCheckBox="false"
                                                              allowMultiSelection="false"
                                                              allowFiltering="true"
                                                              filterType="Contains"
                                                              filterBarPlaceholder="Procurar..."
                                                              popupHeight="200px"
                                                              sortOrder="Ascending"
                                                              showClearButton="true">
                                                <e-dropdowntree-fields dataSource="@ViewData["dataFinalidade"]"
                                                                       value="FinalidadeId"
                                                                       text="Descricao">
                                                </e-dropdowntree-fields>
                                            </ejs-dropdowntree>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 ORIGEM
                                 Local de partida da viagem
                                 Campo obrigatório
                                 Tipo: ComboBox com valores customizáveis
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="cmbOrigem" class="label mr-2 mb-0">Origem</label>
                                            <i class="fa-duotone fa-solid fa-map-location field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>
                                        <!-- allowCustom="true" permite digitação livre -->
                                        <ejs-combobox id="cmbOrigem"
                                                      dataSource="@ViewData["ListaOrigem"]"
                                                      placeholder="Selecione ou digite a origem"
                                                      allowFiltering="true"
                                                      filterType="Contains"
                                                      allowCustom="true"
                                                      popupHeight="220px"
                                                      data-ejtip="Origem não está na lista? Consulte direito antes de cadastrar!">
                                        </ejs-combobox>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 DESTINO
                                 Local de chegada da viagem
                                 Campo obrigatório
                                 Tipo: ComboBox com valores customizáveis
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="cmbDestino" class="label mr-2 mb-0">Destino</label>
                                            <i class="fa-duotone fa-solid fa-map-location-dot field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>
                                        <!-- allowCustom="true" permite digitação livre -->
                                        <ejs-combobox id="cmbDestino"
                                                      dataSource="@ViewData["ListaDestino"]"
                                                      placeholder="Selecione ou digite o destino"
                                                      allowFiltering="true"
                                                      filterType="Contains"
                                                      allowCustom="true"
                                                      popupHeight="220px"
                                                      data-ejtip="Destino não está na lista? Consulte direito antes de cadastrar!">
                                        </ejs-combobox>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 3: EVENTO - SELEÇÃO
                     Aparece quando Finalidade = "Evento"
                     Permite selecionar evento existente
                     ============================================ -->
                <div id="sectionEvento" class="section-card" style="display: none;">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-tent-circus"></i> Evento
                    </div>
                    <div class="section-card-body">
                        <div class="row">

                            <!-- ===================================
                                 LISTA DE EVENTOS
                                 ComboBox com eventos cadastrados
                                 =================================== -->
                            <div class="col-md-8 mb-3">
                                <label for="lstEventos" class="label font-weight-bold">
                                    Nome do Evento
                                    <i class="fa-duotone fa-solid fa-tent-circus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-combobox id="lstEventos"
                                              placeholder="Selecione um evento..."
                                              allowFiltering="true"
                                              filterType="Contains"
                                              dataSource="@ViewData["dataEvento"]"
                                              popupHeight="200px"
                                              showClearButton="true"
                                              data-ejtip="Selecione um evento existente ou cadastre um novo">
                                    <e-combobox-fields text="Evento" value="EventoId"></e-combobox-fields>
                                </ejs-combobox>
                            </div>

                            <!-- ===================================
                                 BOtão NOVO EVENTO
                                 Abre formulário de cadastro (seção 3.1)
                                 =================================== -->
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <!-- Botão visível (dispara o btnEvento oculto) -->
                                <button id="btnInsereNovoEvento"
                                        type="button"
                                        onclick="document.getElementById('btnEvento').click();"
                                        class="btn btn-azul"
                                        style="width: 100%; height: 38px;">
                                    <i class="fa-duotone fa-solid fa-calendar-check"></i>
                                    Novo Evento
                                </button>

                                <!-- Botão oculto (usado pelo JavaScript) -->
                                <button type="button" id="btnEvento" style="display: none;">Evento</button>
                            </div>

                        </div>

                        <!-- ===================================
                             LINHA 2: CAMPOS DO EVENTO SELECIONADO
                             Aparecem quando um evento é selecionado
                             Todos os campos desabilitados
                             =================================== -->
                        <div id="divDadosEventoSelecionado" class="row" style="display: none;">

                            <!-- Data Início -->
                            <div class="col-md-4 mb-3">
                                <label for="txtDataInicioEvento" class="label font-weight-bold">
                                    Data Início
                                    <i class="fa-duotone fa-solid fa-calendar-day field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-datepicker id="txtDataInicioEvento"
                                                format="dd/MM/yyyy"
                                                placeholder="Data Início"
                                                locale="pt-BR"
                                                enabled="false">
                                </ejs-datepicker>
                            </div>

                            <!-- Data Fim -->
                            <div class="col-md-4 mb-3">
                                <label for="txtDataFimEvento" class="label font-weight-bold">
                                    Data Fim
                                    <i class="fa-duotone fa-solid fa-calendar-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-datepicker id="txtDataFimEvento"
                                                format="dd/MM/yyyy"
                                                placeholder="Data Fim"
                                                locale="pt-BR"
                                                enabled="false">
                                </ejs-datepicker>
                            </div>

                            <!-- Quantidade de Participantes -->
                            <div class="col-md-4 mb-3">
                                <label for="txtQtdParticipantesEvento" class="label font-weight-bold">
                                    Qtd Participantes
                                    <i class="fa-duotone fa-solid fa-users field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-numerictextbox id="txtQtdParticipantesEvento"
                                                    format="N0"
                                                    min="0"
                                                    placeholder="Quantidade"
                                                    enabled="false">
                                </ejs-numerictextbox>
                            </div>

                        </div>

                        <!-- =================================================================== -->
                        <!-- SEÇÃO 3.1: ACCORDION PARA CADASTRO DE NOVO EVENTO -->
                        <!-- Hidden por padrão, exibido quando btnEvento (btnInsereNovoEvento) é clicado -->
                        <!-- =================================================================== -->
                        <div id="sectionCadastroEvento" class="mt-3" style="display: none;">
                            <div class="accordion" id="accordionEvento">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingEvento">
                                        <button class="accordion-button" 
                                                type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#collapseEvento" 
                                                aria-expanded="true" 
                                                aria-controls="collapseEvento">
                                            <i class="fa-solid fa-file-lines me-2"></i>
                                            Cadastrar Novo Evento
                                        </button>
                                    </h2>
                                    <div id="collapseEvento" 
                                         class="accordion-collapse collapse show" 
                                         aria-labelledby="headingEvento">
                                        <div class="accordion-body">
                                            <!-- Nome do Evento -->
                                            <div class="mb-3">
                                                <label for="txtNomeEvento" class="form-label fw-bold">
                                                    Nome do Evento
                                                    <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="txtNomeEvento" 
                                                       placeholder="Digite o nome do evento">
                                            </div>

                                            <!-- Descrição do Evento -->
                                            <div class="mb-3">
                                                <label for="txtDescricaoEvento" class="form-label fw-bold">
                                                    Descrição do Evento
                                                </label>
                                                <textarea class="form-control" 
                                                          id="txtDescricaoEvento" 
                                                          rows="3" 
                                                          placeholder="Descreva o evento"></textarea>
                                            </div>

                                            <!-- Data Inicial e Final -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="txtDataInicialEvento" class="form-label fw-bold">
                                                        Data Início
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <ejs-datepicker id="txtDataInicialEvento" 
                                                                    placeholder="Selecione a data"
                                                                    format="dd/MM/yyyy">
                                                    </ejs-datepicker>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="txtDataFinalEvento" class="form-label fw-bold">
                                                        Data Fim
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <ejs-datepicker id="txtDataFinalEvento" 
                                                                    placeholder="Selecione a data"
                                                                    format="dd/MM/yyyy">
                                                    </ejs-datepicker>
                                                </div>
                                            </div>

                                            <!-- Quantidade de Participantes -->
                                            <div class="mb-3">
                                                <label for="txtQtdParticipantesEventoCadastro" class="form-label fw-bold">
                                                    Quantidade de Participantes
                                                </label>
                                                <ejs-numerictextbox id="txtQtdParticipantesEventoCadastro" 
                                                                    placeholder="Número de participantes"
                                                                    format="n0"
                                                                    min="0"
                                                                    step="1">
                                                </ejs-numerictextbox>
                                            </div>

                                            <!-- Requisitante do Evento -->
                                            <div class="mb-3">
                                                <label for="lstRequisitanteEvento" class="form-label fw-bold">
                                                    Requisitante
                                                </label>
                                                <ejs-dropdowntree id="lstRequisitanteEvento"
                                                                  placeholder="Selecione o requisitante..."
                                                                  showCheckBox="false"
                                                                  allowMultiSelection="false"
                                                                  allowFiltering="true"
                                                                  filterType="Contains"
                                                                  popupHeight="200px">
                                                    <e-dropdowntree-fields dataSource="@ViewData["dataRequisitante"]"
                                                                           value="RequisitanteId"
                                                                           text="Nome"
                                                                           parentValue="RequisitantePaiId">
                                                    </e-dropdowntree-fields>
                                                </ejs-dropdowntree>
                                            </div>

                                            <!-- Setor do Requisitante -->
                                            <div class="mb-3">
                                                <label for="lstSetorRequisitanteEvento" class="form-label fw-bold">
                                                    Setor
                                                </label>
                                                <ejs-dropdowntree id="lstSetorRequisitanteEvento"
                                                                  placeholder="Selecione o setor..."
                                                                  showCheckBox="false"
                                                                  allowMultiSelection="false"
                                                                  allowFiltering="true"
                                                                  filterType="Contains"
                                                                  popupHeight="200px">
                                                    <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                           value="SetorId"
                                                                           text="Setor"
                                                                           parentValue="SetorPaiId">
                                                    </e-dropdowntree-fields>
                                                </ejs-dropdowntree>
                                            </div>

                                            <!-- Botões de Ação -->
                                            <div class="d-flex justify-content-end gap-2 mt-4">
                                                <button type="button" 
                                                        id="btnCancelarEvento" 
                                                        class="btn btn-secondary">
                                                    <i class="fa-solid fa-times me-1"></i>
                                                    Cancelar
                                                </button>
                                                <button type="button" 
                                                        id="btnInserirEvento" 
                                                        class="btn btn-verde">
                                                    <i class="fa-solid fa-save me-1"></i>
                                                    Salvar Evento
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 4: INFORMAÇÕES DO TRANSPORTE
                     Motorista, veí­culo, quilometragem e combustí­vel
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-car"></i> Informações do Transporte
                    </div>
                    <div class="section-card-body">

                        <!-- ===================================
                             LINHA 1: Motorista, Veí­culo e Quilometragem
                             =================================== -->
                        <div class="row align-baseline">

                            <!-- ===================================
                                 MOTORISTA
                                 Campo obrigatório
                                 Lista apenas motoristas ativos
                                 =================================== -->
                            <div class="col-4 col-md-4">
                                <div class="d-flex flex-column ml-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <label id="lblMotorista" for="lstMotorista" class="label font-weight-bold mr-2" style="margin: 0;">Motorista</label>
                                        <i id="icoMotorista" class="fa-duotone fa-solid fa-person-biking field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </div>
                                    <ejs-combobox id="lstMotorista"
                                                  placeholder="Selecione um Motorista"
                                                  allowFiltering="true"
                                                  filterType="Contains"
                                                  popupHeight="200px"
                                                  width="100%"
                                                  showClearButton="true"
                                                  dataSource="@ViewData["dataMotorista"]"
                                                  data-ejtip="Motorista não aparece? Talvez esteja inativo">
                                        <e-combobox-fields text="Nome" value="MotoristaId" imageUrl="FotoBase64"></e-combobox-fields>
                                    </ejs-combobox>
                                </div>
                            </div>

                            <!-- ===================================
                                 VeíCULO
                                 Campo obrigatório
                                 Lista apenas veí­culos ativos
                                 =================================== -->
                            <div class="col-4 col-md-3">
                                <div class="d-flex flex-column ml-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <label for="lstVeiculo" class="label mr-2 mb-0">Veí­culo</label>
                                        <i class="fa-duotone fa-solid fa-truck-bolt field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </div>
                                    <ejs-combobox id="lstVeiculo"
                                                  placeholder="Selecione um Veí­culo"
                                                  allowFiltering="true"
                                                  filterType="Contains"
                                                  dataSource="@ViewData["dataVeiculo"]"
                                                  popupHeight="200px"
                                                  width="100%"
                                                  showClearButton="true"
                                                  data-ejtip="Veí­culo não aparece? Talvez esteja inativo">
                                        <e-combobox-fields text="Descricao" value="VeiculoId"></e-combobox-fields>
                                    </ejs-combobox>
                                </div>
                            </div>

                            <!-- ===================================
                                 BLOCO DE QUILOMETRAGEM
                                 4 campos relacionados ao hodômetro
                                 Visíveis apenas em modo viagem
                                 =================================== -->
                            <div class="col-5 col-md-5 d-flex align-items-start">
                                <!-- KM Atual (somente leitura - mostra último KM registrado) -->
                                <div class="form-group mr-2" id="divKmAtual">
                                    <label class="label">
                                        Km Atual
                                        <i class="fa-duotone fa-solid fa-gauge field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input readonly id="txtKmAtual" class="form-control form-control-xs" />
                                </div>

                                <!-- KM Inicial (preenchido ao iniciar viagem) -->
                                <div class="form-group mr-2" id="divKmInicial">
                                    <label class="label">
                                        Km Inicial
                                        <i class="fa-duotone fa-solid fa-gauge-max field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtKmInicial" class="form-control form-control-xs" />
                                </div>

                                <!-- KM Final (preenchido ao finalizar viagem) -->
                                <div class="form-group mr-2" id="divKmFinal">
                                    <label class="label">
                                        Km Final
                                        <i class="fa-duotone fa-solid fa-gauge-min field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtKmFinal" class="form-control form-control-xs" />
                                </div>

                                <!-- Distância (calculado: KM Final - KM Inicial) -->
                                <div class="form-group mr-2" id="divQuilometragem">
                                    <label class="label">
                                        Distância
                                        <i class="fa-duotone fa-solid fa-road field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <input id="txtQuilometragem"
                                           class="form-control form-control-xs"
                                           data-ejtip="Quilometragem alta? Confirme os valores antes de salvar" />
                                </div>
                            </div>

                        </div>

                        <!-- ===================================
                             LINHA 2: níveis de Combustí­vel
                             Visíveis apenas em modo viagem
                             =================================== -->
                        <div class="row align-baseline mt-3">

                            <!-- Combustí­vel Inicial -->
                            <div class="col-6 col-md-3">
                                <div class="form-group" id="divCombustivelInicial">
                                    <label class="label">
                                        Combustí­vel Inicial
                                        <i class="fa-duotone fa-solid fa-gauge-circle-plus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <!-- DropDownTree com imagens dos níveis -->
                                    <ejs-dropdowntree id="ddtCombustivelInicial" popupHeight="200px" showClearButton="true">
                                        <e-dropdowntree-fields dataSource="@ViewData["dataCombustivel"]"
                                                               value="Nivel"
                                                               text="Descricao"
                                                               imageURL="Imagem">
                                        </e-dropdowntree-fields>
                                    </ejs-dropdowntree>
                                </div>
                            </div>

                            <!-- Combustí­vel Final -->
                            <div class="col-6 col-md-3">
                                <div class="form-group" id="divCombustivelFinal">
                                    <label class="label">
                                        Combustí­vel Final
                                        <i class="fa-duotone fa-solid fa-gauge-circle-minus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </label>
                                    <!-- DropDownTree com imagens dos níveis -->
                                    <ejs-dropdowntree id="ddtCombustivelFinal" popupHeight="200px" showClearButton="true">
                                        <e-dropdowntree-fields dataSource="@ViewData["dataCombustivel"]"
                                                               value="Nivel"
                                                               text="Descricao"
                                                               imageURL="Imagem">
                                        </e-dropdowntree-fields>
                                    </ejs-dropdowntree>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 5: REQUISITANTE E SETOR
                     Dados do solicitante da viagem
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-users"></i> Requisitante e Setor
                    </div>
                    <div class="section-card-body">
                        <!-- align-items-end: alinha todos os campos pela base -->
                        <div class="row align-items-end">

                            <!-- ===================================
                                 BLOCO 1: REQUISITANTE (col-md-5)
                                 ComboBox + Botão "Novo Requisitante"
                                 =================================== -->
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <div class="d-flex flex-column">
                                        <!-- Label com ícone -->
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstRequisitante" class="label font-weight-bold mr-2" style="margin: 0;">
                                                Requisitante
                                            </label>
                                            <i class="fa-duotone fa-solid fa-person-simple field-icon"
                                               style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <!-- ComboBox + Botão na mesma linha -->
                                        <div class="d-flex flex-row align-items-center" style="gap: 6px;">
                                            <!-- Lista de Requisitantes -->
                                            <ejs-combobox id="lstRequisitante"
                                                          placeholder="Selecione um Requisitante..."
                                                          allowFiltering="true"
                                                          filterType="Contains"
                                                          dataSource="@ViewData["dataRequisitante"]"
                                                          popupHeight="200px"
                                                          showClearButton="true"
                                                          cssClass="flex-grow-1"
                                                          data-ejtip="Se o <strong>Requisitante</strong> não estiver presente na Lista, verifique primeiro se ele não está <strong>Inativo</strong> antes de cadastrar um novo">
                                                <e-combobox-fields text="Requisitante" value="RequisitanteId"></e-combobox-fields>
                                            </ejs-combobox>

                                            <!-- Botão Novo Requisitante -->
                                            <a class="btn btn-nfs" id="btnRequisitante" style="height: 38px; display: flex; align-items: center;">
                                                <i class="fal fa-user-plus"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- =================================================================== -->
                                <!-- SEÇÃO: CARD PARA CADASTRO DE NOVO REQUISITANTE -->
                                <!-- Hidden por padrão, exibido quando btnRequisitante é clicado -->
                                <!-- Estrutura idêntica ao sectionCadastroEvento -->
                                <!-- =================================================================== -->
                                <div id="sectionCadastroRequisitante" class="mt-3" style="display: none;">
                                    <div class="accordion" id="accordionRequisitante">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="headingRequisitante">
                                                <button class="accordion-button" 
                                                        type="button" 
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#collapseRequisitante" 
                                                        aria-expanded="true" 
                                                        aria-controls="collapseRequisitante">
                                                    <i class="fa-solid fa-user-plus me-2"></i>
                                                    Cadastrar Novo Requisitante
                                                </button>
                                            </h2>
                                            <div id="collapseRequisitante" 
                                                 class="accordion-collapse collapse show" 
                                                 aria-labelledby="headingRequisitante">
                                                <div class="accordion-body">
                                                    <!-- Ponto -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-3">
                                                            <label for="txtPonto" class="form-label fw-bold">
                                                                Ponto
                                                            </label>
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   id="txtPonto" 
                                                                   placeholder="Digite o ponto">
                                                        </div>
                                                        <div class="col-md-9">
                                                            <label for="txtNome" class="form-label fw-bold">
                                                                Nome do Requisitante
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   id="txtNome" 
                                                                   placeholder="Digite o nome do requisitante">
                                                        </div>
                                                    </div>

                                                    <!-- Ramal e Email -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-4">
                                                            <label for="txtRamal" class="form-label fw-bold">
                                                                Ramal
                                                            </label>
                                                            <input type="text" 
                                                                   class="form-control" 
                                                                   id="txtRamal" 
                                                                   placeholder="Digite o ramal">
                                                        </div>
                                                        <div class="col-md-8">
                                                            <label for="txtEmail" class="form-label fw-bold">
                                                                Email
                                                            </label>
                                                            <input type="email" 
                                                                   class="form-control" 
                                                                   id="txtEmail" 
                                                                   placeholder="Digite o email">
                                                        </div>
                                                    </div>

                                                    <!-- Setor do Requisitante -->
                                                    <div class="mb-3">
                                                        <label for="ddtSetorRequisitante" class="form-label fw-bold">
                                                            Setor do Requisitante
                                                        </label>
                                                        <ejs-dropdowntree id="ddtSetorRequisitante"
                                                                          placeholder="Selecione o setor..."
                                                                          showCheckBox="false"
                                                                          allowMultiSelection="false"
                                                                          allowFiltering="true"
                                                                          filterType="Contains"
                                                                          popupHeight="200px">
                                                            <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                                   value="SetorSolicitanteId"
                                                                                   text="Nome"
                                                                                   parentValue="SetorPaiId">
                                                            </e-dropdowntree-fields>
                                                        </ejs-dropdowntree>
                                                    </div>

                                                    <!-- Botões de Ação -->
                                                    <div class="d-flex justify-content-end gap-2 mt-4">
                                                        <button type="button" 
                                                                id="btnFecharAccordionRequisitante" 
                                                                class="btn btn-secondary">
                                                            <i class="fa-solid fa-times me-1"></i>
                                                            Cancelar
                                                        </button>
                                                        <button type="button" 
                                                                id="btnInserirRequisitante" 
                                                                class="btn btn-verde">
                                                            <i class="fa-solid fa-save me-1"></i>
                                                            Salvar Requisitante
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 BLOCO 2: RAMAL (col-md-2)
                                 Número de telefone/ramal do requisitante
                                 =================================== -->
                            <div class="col-md-2">
                                <div class="form-group mb-0">
                                    <div class="d-flex flex-column">
                                        <!-- Label com ícone -->
                                        <div class="d-flex align-items-center mb-1">
                                            <label class="label font-weight-bold mr-2" style="margin: 0;">
                                                Ramal
                                            </label>
                                            <i class="fa-duotone fa-solid fa-phone-office field-icon"
                                               style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <!-- Input Ramal (altura fixa 38px para alinhar) -->
                                        <input type="text" id="txtRamalRequisitanteSF" />
                                    </div>
                                </div>
                            </div>

                            <!-- ===================================
                                 BLOCO 3: SETOR (col-md-5)
                                 DropDownTree hierárquico de setores
                                 =================================== -->
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <div class="d-flex flex-column">
                                        <!-- Label com ícone -->
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstSetorRequisitanteAgendamento" class="label font-weight-bold mr-2" style="margin: 0;">
                                                Setor do Requisitante
                                            </label>
                                            <i class="fa-duotone fa-solid fa-building-user field-icon"
                                               style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <!-- DropDownTree com estrutura hierárquica -->
                                        <ejs-dropdowntree id="lstSetorRequisitanteAgendamento"
                                                          allowFiltering="true"
                                                          placeholder="Selecione um setor..."
                                                          sortOrder="Ascending"
                                                          showCheckBox="false"
                                                          filterType="Contains"
                                                          filterBarPlaceholder="Procurar setor..."
                                                          popupHeight="200px">
                                            <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                   value="SetorSolicitanteId"
                                                                   parentValue="SetorPaiId"
                                                                   hasChildren="HasChild"
                                                                   text="Nome">
                                            </e-dropdowntree-fields>
                                        </ejs-dropdowntree>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- Fim da row align-items-end -->
                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 6: CONFIGURAÇÕES DE RECORRÊNCIA
                     Define se a viagem se repete e com qual frequência
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-repeat"></i> Configurações de Recorrência
                    </div>
                    <div class="section-card-body">
                        <div class="select-container" id="divRecorrencia">

                            <!-- ===================================
                                 LINHA 1: Recorrente? e Perí­odo
                                 =================================== -->
                            <div class="row">

                                <!-- lstRecorrente - Col 2 (CORRIGIDO: era col-md-9) -->
                                <div class="col-md-2">
                                    <div class="form-group mb-3">
                                        <label for="lstRecorrente" class="label font-weight-bold">
                                            Recorrente?
                                            <i class="fa-duotone fa-solid fa-arrows-spin field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-dropdownlist id="lstRecorrente"
                                                          dataSource="@ViewData["dataRecorrente"]"
                                                          popupHeight="200px"
                                                          cssClass="e-outline text-center"
                                                          floatLabelType="Never">
                                            <e-dropdownlist-fields text="Descricao" value="RecorrenteId"></e-dropdownlist-fields>
                                        </ejs-dropdownlist>
                                    </div>
                                </div>

                                <!-- lstPeriodos - Col 2 (CORRIGIDO: era col-md-3) -->
                                <div class="col-md-2" id="divPeriodo" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="lstPeriodos" class="label font-weight-bold">
                                            Perí­odo
                                            <i class="fa-duotone fa-solid fa-calendar-circle-exclamation field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <input id="lstPeriodos"
                                               type="text"
                                               class="e-control e-dropdownlist"
                                               style="width: 100%; height: 38px;" />
                                    </div>
                                </div>

                            </div>

                            <!-- LINHA 2: Campos especí­ficos por perí­odo -->
                            <div class="row">

                                <!-- lstDias - Col 6 (CORRIGIDO: era col-md-4) -->
                                <div class="col-md-6" id="divDias" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="lstDias" class="label font-weight-bold">
                                            Dias da Semana
                                            <i class="fa-duotone fa-solid fa-calendar-week field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-multiselect id="lstDias"
                                                         placeholder="Selecione os dias..."
                                                         mode="CheckBox"
                                                         showSelectAll="true"
                                                         selectAllText="Selecionar todos"
                                                         unSelectAllText="Desmarcar todos"
                                                         popupHeight="250px">
                                            <e-multiselect-fields value="Value" text="Text"></e-multiselect-fields>
                                        </ejs-multiselect>
                                    </div>
                                </div>

                                <!-- lstDiasMes - Col 3 (MANTIDO) -->
                                <div class="col-md-3" id="divDiaMes" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="lstDiasMes" class="label font-weight-bold">
                                            Dia do Mês
                                            <i class="fa-duotone fa-solid fa-calendar-clock field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-dropdownlist id="lstDiasMes"
                                                          placeholder="Selecione o dia..."
                                                          popupHeight="250px"
                                                          cssClass="e-outline">
                                            <e-dropdownlist-fields value="Value" text="Text"></e-dropdownlist-fields>
                                        </ejs-dropdownlist>
                                    </div>
                                </div>

                                <!-- txtFinalRecorrencia - Col 3 (CORRIGIDO: era col-md-5) -->
                                <div class="col-md-3" id="divFinalRecorrencia" style="display: none;">
                                    <div class="form-group mb-3">
                                        <label for="txtFinalRecorrencia" class="label font-weight-bold">
                                            Data Final Recorrência
                                            <i class="fa-duotone fa-solid fa-calendar-check field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <ejs-datepicker id="txtFinalRecorrencia"
                                                        format="dd/MM/yyyy"
                                                        placeholder="Selecione a data final"
                                                        locale="pt-BR"
                                                        cssClass="e-outline">
                                        </ejs-datepicker>
                                    </div>
                                </div>

                            </div>

                            <!-- ===================================
                                 LINHA 3: CALENDÁRIO (Recorrência Variada)
                                 Permite selecionar datas especí­ficas manualmente
                                 =================================== -->
                            <div class="row" id="calendarContainer" style="display: none;">
                                <div class="col-12">
                                    <div class="form-group mb-3">
                                        <label class="label font-weight-bold">
                                            Selecione as Datas
                                            <i class="fa-duotone fa-solid fa-calendar-days field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </label>
                                        <!-- Componente Calendar será inicializado via JavaScript -->
                                        <div id="calDatasSelecionadas"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 7: DESCRIÇÃO DA VIAGEM
                     Editor de texto rico para detalhes da viagem
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-file-alt"></i> Descrição da Viagem
                    </div>
                    <div class="section-card-body">
                        <div class="row">
                            <div class="col-md-12 col-xl-10 control-section">
                                <div class="control-wrapper">
                                    <div>
                                        <div class="d-flex flex-column ml-2">
                                            <div class="d-flex align-items-center mb-1">
                                                <label for="rteDescricao" class="label mr-2 mb-0">Descrição da Viagem (passageiros / carga)</label>
                                                <i class="fa-duotone fa-solid fa-typewriter field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                            </div>
                                            <!-- RichTextEditor com suporte a imagens -->
                                            <!-- saveUrl: Endpoint para upload de imagens -->
                                            <!-- path: Diretório de armazenamento -->
                                            <ejs-richtexteditor id="rteDescricao" locale="pt-BR" height="250px">
                                                <e-richtexteditor-insertimagesettings saveUrl="api/Viagem/SaveImage" path="./DadosEditaveis/ImagensViagens/"></e-richtexteditor-insertimagesettings>
                                            </ejs-richtexteditor>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                     SEÇÃO 8: RELAtÓRIO DA FICHA DE VISTORIA
                     Exibe PDF da ficha de viagem usando Telerik
                     Visível apenas quando viagem possui ID
                     ============================================ -->
                <div class="section-card" id="cardRelatorio" style="display: none;">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-file-pdf" style="color: #e74c3c;"></i> Ficha da Viagem
                    </div>
                    <div class="section-card-body p-0">
                        <!-- Hidden input para armazenar ID da viagem -->
                        <input type="hidden" id="txtViagemIdRelatorio" />

                        <!-- Container do Telerik Report Viewer -->
                        <div id="ReportContainerAgenda" style="min-height: 850px; background-color: #f8f9fa;">
                            <div id="reportViewerAgenda" style="width:100%; height: 800px; min-height: 800px;">
                                <!-- Spinner de carregamento -->
                                <div class="text-center p-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Carregando relatório...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Labels - Gerenciadas por JavaScript -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div id="lblUsuarioAgendamento" style="display: none;"></div>
                        <div id="lblUsuarioCriacao" style="display: none;"></div>
                        <div id="lblUsuarioFinalizacao" style="display: none;"></div>
                        <div id="lblUsuarioCancelamento" style="display: none;"></div>
                    </div>
                </div>

                <!-- Modal Footer - MANTIDO ORIGINAL -->
                <div class="modal-footer" id="divBotoes">
                    <button id="btnViagem" type="button" class="btn btn-sm btn-fundo-laranja">
                        <i class="fa-regular fa-shuffle" aria-hidden="true"></i>&nbsp;Transforma em Viagem
                    </button>
                    <button id="btnConfirma" type="button" class="btn btn-sm btn-azul">
                        <i class="fa fa-save" aria-hidden="true"></i>Confirmar
                    </button>
                    <button id="btnApaga" type="button" class="btn btn-sm btn-vinho">
                        <i class="fa-light fa-trash-can-undo" aria-hidden="true"></i>Apagar
                    </button>
                    <button id="btnCancela" type="button" class="btn btn-sm fundo-vermelho">
                        <i class="fa fa-ban" aria-hidden="true"></i>Cancelar
                    </button>
                    <button id="btnFecha" type="button" class="btn btn-sm fundo-ebony" data-bs-dismiss="modal">
                        <i class="fa fa-times" aria-hidden="true"></i>Fechar
                    </button>

                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock
{
@* ============================================
       DADOS DO SERVIDOR (C# â†’ JavaScript)
       ============================================ *@
<script>
    window.dataFinalidade = @Html.Raw(Json.Serialize(ViewData["dataFinalidade"]));
    window.dataPeriodo = @Html.Raw(Json.Serialize(ViewData["dataPeriodo"]));
    window.dataPeriodos = @Html.Raw(Json.Serialize(ViewData["dataPeriodos"]));
</script>

@* ============================================
       DEPENDÚNCIAS EXTERNAS
       ============================================ *@
<link href="https://cdn.kendostatic.com/2022.1.412/styles/kendo.default-main.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.kendostatic.com/2022.1.412/js/jszip.min.js"></script>
<script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.all.min.js"></script>
<script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.aspnetmvc.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
<script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
</script>
<script src="/api/reports/resources/js/telerikReportViewer"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.js" integrity="sha512-zAadCzZHXo/f5A/3uhF50bZXahdYNqisNgKKniyoJJVpp27b2bR82N4hPLGj3/qBEh3tGZ9SYGmSA1jpdtNF5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="~/lib/fullcalendar/locales-all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
<script src="/api/reports/resources/js/telerikReportViewer-18.1.24.514.min.js"></script>

@* ============================================
       CORE - Camada Base
       ============================================ *@
<script src="~/js/agendamento/core/ajax-helper.js" asp-append-version="true"></script>
<script src="~/js/agendamento/core/state.js" asp-append-version="true"></script>
<script src="~/js/agendamento/core/api-client.js" asp-append-version="true"></script>

@* ============================================
       UTILS - Utilitários
       ============================================ *@
<script src="~/js/agendamento/utils/date.utils.js" asp-append-version="true"></script>
<script src="~/js/agendamento/utils/syncfusion.utils.js" asp-append-version="true"></script>
<script src="~/js/agendamento/utils/formatters.js" asp-append-version="true"></script>

@* ============================================
       SERVICES - Serviços de API
       ============================================ *@
<script src="~/js/agendamento/services/agendamento.service.js" asp-append-version="true"></script>
<script src="~/js/agendamento/services/viagem.service.js" asp-append-version="true"></script>
<script src="~/js/agendamento/services/requisitante.service.js" asp-append-version="true"></script>
<script src="~/js/agendamento/services/evento.service.js" asp-append-version="true"></script>

@* ============================================
       COMPONENTS - Componentes da UI
       ============================================ *@
<script src="~/js/agendamento/components/validacao.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/modal-viagem.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/recorrencia.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/modal-config.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/exibe-viagem.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/event-handlers.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/dialogs.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/controls-init.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/recorrencia-init.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/relatorio.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/evento.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/recorrencia-logic.js" asp-append-version="true"></script>
<script src="~/js/agendamento/components/calendario.js" asp-append-version="true"></script>

@* ============================================
       MAIN - Inicialização (SEMPRE POR ÚLTIMO)
       ============================================ *@
<script src="~/js/agendamento/main.js" asp-append-version="true"></script>

}
