@page

@using FrotiX.Repository.IRepository
@using Syncfusion.EJ2
@using Stimulsoft.Report.Mvc;
@using Syncfusion.EJ2.DropDowns
@using Syncfusion.EJ2.Navigations
@using Syncfusion.EJ2.Base
@using Syncfusion.EJ2.Popups
@using Kendo.Mvc.UI
@using FrotiX.Helpers;

@model FrotiX.Models.Agenda

@inject IUnitOfWork _unitOfWork

@* ============================================
   FUNÇÕES DO SERVIDOR (FORA DE BLOCOS @{})
   ============================================ *@
@functions {
    public void OnGet()
    {
        FrotiX.Pages.Agenda.IndexModel.Initialize(_unitOfWork);
        ViewData["dataCombustivel"] = new ListaNivelCombustivel(_unitOfWork).NivelCombustivelList();
        ViewData["dataMotorista"] = new ListaMotorista(_unitOfWork).MotoristaList();
        ViewData["dataVeiculo"] = new ListaVeiculos(_unitOfWork).VeiculosList();
        ViewData["dataSetor"] = new ListaSetores(_unitOfWork).SetoresList();
        ViewData["dataRequisitante"] = new ListaRequisitante(_unitOfWork).RequisitantesList();
        ViewData["dataFinalidade"] = new ListaFinalidade(_unitOfWork).FinalidadesList();
        ViewData["dataEvento"] = new ListaEvento(_unitOfWork).EventosList();
        ViewData["dataSetorEvento"] = new ListaSetoresEvento(_unitOfWork).SetoresEventoList();
        ViewData["dataPeriodo"] = new ListaPeriodos().PeriodosList();
        ViewData["dataRecorrente"] = new ListaRecorrente().RecorrenteList();

        var listaOrigem = _unitOfWork.Viagem.GetAllReduced(selector: v => v.Origem)
            .Where(o => o != null)
            .Distinct()
            .OrderBy(o => o)
            .ToList();
        ViewData["ListaOrigem"] = listaOrigem;

        var listaDestino = _unitOfWork.Viagem.GetAllReduced(selector: v => v.Destino)
            .Where(d => d != null)
            .Distinct()
            .OrderBy(d => d)
            .ToList();
        ViewData["ListaDestino"] = listaDestino;
    }
}

@* ============================================
   CONFIGURAÇÕES DE MODAL E BOTÕES
   ============================================ *@
@{
    var Modalanimation = new Syncfusion.EJ2.Popups.DialogAnimationSettings { Effect = Syncfusion.EJ2.Popups.DialogEffect.None };
    var Okbutton = new { content = "Inserir Requisitante", isPrimary = true };
    var Closebutton = new { content = "Fechar", isPrimary = false };
}

@* ============================================
   CONFIGURAÇÕES DA PÁGINA
   ============================================ *@
@{
    ViewData["Title"] = "Agenda";
    ViewData["PageName"] = "agenda_index";
    ViewData["Heading"] = "<i class='fad fa-calendar-alt'></i> Agenda: <span class='fw-300'>Agenda de Viagens</span>";
    ViewData["Category1"] = "Agenda";
    ViewData["PageIcon"] = "fad fa-calendar-alt";
}

@* ============================================
   SECTION HEAD BLOCK - CSS E SCRIPTS DO HEAD
   ============================================ *@
@section HeadBlock {

	<link rel="stylesheet" href="~/css/modal-viagens-clean.css" asp-append-version="true" />
<link rel="stylesheet" href="~/css/modal-viagens-syncfusion.css" asp-append-version="true" />

    <!-- FullCalendar 6.1.15 -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    @Html.Raw("<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js'></script>")

    <link rel="stylesheet" type="text/css" href="~/css/spinkit.css">

    <!-- Kendo UI (padronizado 2024.3.806) -->
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.2.1/default/default-main.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2024.3.806/js/jszip.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2024.3.806/js/kendo.all.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2024.3.806/js/kendo.aspnetmvc.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
    </script>

}
@* ============================================
   FIM DA SECTION HeadBlock
   ============================================ *@

@* ============================================
   CONTEÚDO DA PÁGINA (HTML DO BODY)
   ============================================ *@

<div class="row" align="center">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">
                <div class="panel-content ">
                    <div id="loading " class="example">
                    </div>
                    <div class="box-body">
                        <br /><br />
                        <div id='agenda'></div>
                        <br /><br />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* ============================================
   MODAL AGENDAMENTO/VIAGENS - REFATORADO
   ============================================ *@

<div class="modal fade" id="modalViagens" role="dialog" data-bs-focus="false">
    <div class="modal-dialog custom-modal-lg">
        <div class="modal-content">
            <div id="Titulo" class="modal-header modal-header-dinheiro">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="divModal" class="modal-body">
                <!-- Hidden Inputs - MANTIDOS TODOS OS ORIGINAIS -->
                <input id="txtReport" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtViagemId" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtRecorrenciaViagemId" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtStatusAgendamento" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtUsuarioIdCriacao" class="form-control form-control-xs" hidden="hidden" />
                <input id="txtDataCriacao" class="form-control form-control-xs" hidden="hidden" />

                <div id="dialogRecorrencia"></div>

                <!-- SEÇÃO 1: Informações Básicas -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-solid fa-info-circle"></i> Informações Básicas
                    </div>
                    <div class="section-card-body">
                        <div class="row align-baseline">
                            <!-- Ficha de Vistoria -->
                            <div id="divNoFichaVistoria" class="col-12 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Nº Ficha Vistoria <i class="fa-solid fa-clipboard-list field-icon"></i>
                                    </label>
                                    <input id="txtNoFichaVistoria" class="form-control form-control-xs" />
                                </div>
                            </div>

							<!-- Data Inicial -->
							<div class="col-6 col-md-2">
								<div class="form-group">
									<label class="label font-weight-bold">
										Data Inicial <i class="fa-solid fa-calendar-day field-icon"></i>
									</label>
									<ejs-datepicker id="txtDataInicial" 
													format="dd/MM/yyyy"
													placeholder="Selecione a data"
													locale="pt-BR">
									</ejs-datepicker>
								</div>
							</div>

                            <!-- Hora Início -->
                            <div class="col-6 col-md-2">
                                <div class="form-group">
                                    <label class="label font-weight-bold">
                                        Hora Início <i class="fa-solid fa-clock field-icon"></i>
                                    </label>
                                    <input id="txtHoraInicial" class="form-control form-control-xs" type="time" />
                                </div>
                            </div>

							<!-- Data Final -->
							<div class="col-6 col-md-2">
								<div id="divDataFinal" class="form-group">
									<label class="label font-weight-bold">
										Data Final <i class="fa-duotone fa-calendar-check field-icon"></i>
									</label>
									<ejs-datepicker id="txtDataFinal" 
													format="dd/MM/yyyy"
													placeholder="Selecione a data"
													locale="pt-BR">
									</ejs-datepicker>
								</div>
							</div>

                            <!-- Hora Fim -->
                            <div class="col-6 col-md-2">
                                <div id="divHoraFinal" class="form-group">
                                    <label class="label font-weight-bold">
                                        Hora Fim <i class="fa-duotone fa-stopwatch field-icon"></i>
                                    </label>
                                    <input id="txtHoraFinal" class="form-control form-control-xs" type="time" />
                                </div>
                            </div>

                            <!-- Duração -->
                            <div class="col-6 col-md-2">
                                <div id="divDuracao" class="form-group">
                                    <label class="label font-weight-bold">
                                        Duração (hs) <i class="fa-duotone fa-hourglass-half field-icon"></i>
                                    </label>
                                    <ejs-numerictextbox id="txtDuracao"
                                                        Enabled="false"
                                                        format="n0"
                                                        Readonly="true"
                                                        showSpinButton="false"
                                                        data-ejtip="Se a <strong>Duração</strong> estiver alta, revise o horário e datas">
                                    </ejs-numerictextbox>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEÇÃO 2: Finalidade, Origem e Destino -->
                <div class="section-card" id="divFinalidadeOrigemDestino">
                    <div class="section-card-header">
                        <i class="fa-solid fa-route"></i> Roteiro
                    </div>
                    <div class="section-card-body">
                        <div class="row align-baseline">
                            <!-- Finalidade -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="lstFinalidade" class="label mr-2 mb-0">Finalidade</label>
                                            <i class="fa-duotone fa-solid fa-rectangle-history-circle-user field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <div class="dropdown-wrapper">
                                                <ejs-dropdowntree id="lstFinalidade"
                                                                  placeholder="Selecione uma Finalidade..."
                                                                  showCheckBox="false"
                                                                  allowMultiSelection="false"
                                                                  allowFiltering="true"
                                                                  filterType="Contains"
                                                                  filterBarPlaceholder="Procurar..."
                                                                  popupHeight="200px"
                                                                  sortOrder="Ascending">
                                                    <e-dropdowntree-fields dataSource="@ViewData["dataFinalidade"]"
                                                                           value="FinalidadeId"
                                                                           text="Descricao">
                                                    </e-dropdowntree-fields>
                                                </ejs-dropdowntree>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Origem -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="cmbOrigem" class="label mr-2 mb-0">Origem</label>
                                            <i class="fa-duotone fa-solid fa-map-location field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>
                                        <ejs-combobox id="cmbOrigem"
                                                      dataSource="@ViewData["ListaOrigem"]"
                                                      placeholder="Selecione ou digite a origem"
                                                      allowFiltering="true"
                                                      filterType="Contains"
                                                      allowCustom="true"
                                                      popupHeight="220px"
                                                      data-ejtip="Origem não está na lista? Consulte direito antes de cadastrar!">
                                        </ejs-combobox>
                                    </div>
                                </div>
                            </div>

                            <!-- Destino -->
                            <div class="col-4 col-md-3">
                                <div class="form-group">
                                    <div class="d-flex flex-column ml-2">
                                        <div class="d-flex align-items-center mb-1">
                                            <label for="cmbDestino" class="label mr-2 mb-0">Destino</label>
                                            <i class="fa-duotone fa-solid fa-map-location-dot field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>
                                        <ejs-combobox id="cmbDestino"
                                                      dataSource="@ViewData["ListaDestino"]"
                                                      placeholder="Selecione ou digite o destino"
                                                      allowFiltering="true"
                                                      filterType="Contains"
                                                      allowCustom="true"
                                                      popupHeight="220px"
                                                      data-ejtip="Destino não está na lista? Consulte direito antes de cadastrar!">
                                        </ejs-combobox>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                        SEÇÃO 3: EVENTO - SELEÇÃO
                        Aparece quando Finalidade = "Evento"
                        Substitua a SEÇÃO 3 antiga completa por este código
                        ============================================ -->
                <div id="sectionEvento" class="section-card" style="display: none;">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-calendar-star"></i> Evento
                    </div>
                    <div class="section-card-body">
                        <div class="row">
                            <!-- Nome do Evento -->
                            <div class="col-md-8 mb-3">
                                <label for="lstEventos" class="label font-weight-bold">
                                    Nome do Evento
                                    <i class="fa-duotone fa-solid fa-calendar-star field-icon"
                                        style="font-size: 1.25em; cursor: pointer;"></i>
                                </label>
                                <ejs-combobox id="lstEventos"
                                                placeholder="Selecione um evento..."
                                                allowFiltering="true"
                                                filterType="Contains"
                                                dataSource="@ViewData["dataEvento"]"
                                                popupHeight="200px"
                                                showClearButton="true"
                                                data-ejtip="Selecione um evento existente ou cadastre um novo">
                                    <e-combobox-fields text="Evento" value="EventoId"></e-combobox-fields>
                                </ejs-combobox>
                            </div>

                            <!-- Botão Novo Evento -->
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <!-- Botão Teste (visível) -->
                                <button id="btnInsereNovoEvento"
                                        type="button"
                                        onclick="document.getElementById('btnEvento').click();"
                                        class="btn btn-azul"
                                        color: white;
                                        border: none;
                                        padding: 10px 20px;
                                        font-size: 14px;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        width: 100%;
                                        height: 38px;
                                        display: block;">
                                    <i class="fa-utility fa-semibold fa-calendar-check"></i>
                                    Novo Evento
                                </button>

                                <!-- Botão Real (oculto mas mantido para JavaScript) -->
                                <button type="button"
                                        id="btnEvento"
                                        style="display: none;">
                                    Evento
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                        SEÇÃO 3.1: CADASTRO DE NOVO EVENTO
                        Aparece quando clica no botão "Novo Evento"
                        ============================================ -->
<div id="sectionCadastroEvento" class="section-card" style="display: none;">
    <div class="section-card-header">
        <i class="fa-solid fa-file-lines"></i> Cadastrar Novo Evento
    </div>
    <div class="section-card-body">
        <!-- LINHA 1: Nome do Evento e Quantidade de Pessoas -->
        <div class="row mb-3">
            <div class="col-md-8">
                <label for="txtNomeEvento" class="label font-weight-bold">
                    <i class="fa-solid fa-file-signature mr-1"></i>
                    Nome do Evento <span class="text-danger">*</span>
                </label>
                <input type="text"
                        class="form-control form-control-xs"
                        id="txtNomeEvento"
                        placeholder="Digite o nome do evento">
            </div>

            <div class="col-md-4">
                <label for="txtQuantidadePessoasEvento" class="label font-weight-bold">
                    <i class="fa-solid fa-users mr-1"></i>
                    Quantidade de Pessoas
                </label>
                <ejs-numerictextbox id="txtQuantidadePessoasEvento"
                                    format="n0"
                                    min="1"
                                    placeholder="Nº de pessoas"
                                    showSpinButton="true">
                </ejs-numerictextbox>
            </div>
        </div>

        <!-- LINHA 2: Descrição do Evento -->
        <div class="row mb-3">
            <div class="col-12">
                <label for="txtDescricaoEvento" class="label font-weight-bold">
                    <i class="fa-solid fa-align-left mr-1"></i>
                    Descrição do Evento
                </label>
                <textarea class="form-control form-control-xs"
                            id="txtDescricaoEvento"
                            rows="3"
                            placeholder="Descreva o evento"></textarea>
            </div>
        </div>

        <!-- LINHA 3: Data Inicial e Data Final -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="txtDataInicialEvento" class="label font-weight-bold">
                    <i class="fa-solid fa-calendar-day mr-1"></i>
                    Data Inicial <span class="text-danger">*</span>
                </label>
                <ejs-datepicker id="txtDataInicialEvento"
                                format="dd/MM/yyyy"
                                placeholder="Selecione a data inicial"
                                locale="pt-BR">
                </ejs-datepicker>
            </div>

            <div class="col-md-6">
                <label for="txtDataFinalEvento" class="label font-weight-bold">
                    <i class="fa-duotone fa-calendar-check mr-1"></i>
                    Data Final <span class="text-danger">*</span>
                </label>
                <ejs-datepicker id="txtDataFinalEvento"
                                format="dd/MM/yyyy"
                                placeholder="Selecione a data final"
                                locale="pt-BR">
                </ejs-datepicker>
            </div>
        </div>

        <!-- LINHA 4: Requisitante e Ramal -->
        <div class="row mb-3">
            <div class="col-md-8">
                <label for="lstRequisitanteEvento" class="label font-weight-bold">
                    <i class="fa-solid fa-user mr-1"></i>
                    Requisitante <span class="text-danger">*</span>
                </label>
                <ejs-combobox id="lstRequisitanteEvento"
                                placeholder="Selecione um requisitante..."
                                allowFiltering="true"
                                filterType="Contains"
                                dataSource="@ViewData["dataRequisitante"]"
                                popupHeight="200px"
                                showClearButton="true">
                    <e-combobox-fields text="Requisitante" value="RequisitanteId"></e-combobox-fields>
                </ejs-combobox>
            </div>

            <div class="col-md-4">
                <label for="txtRamalRequisitante" class="label font-weight-bold">
                    <i class="fa-solid fa-phone mr-1"></i>
                    Ramal
                </label>
                <input type="text"
                        class="form-control form-control-xs"
                        id="txtRamalRequisitante"
                        placeholder="Ex: 1234"
                        maxlength="10">
            </div>
        </div>

        <!-- LINHA 5: Setor do Requisitante -->
        <div class="row mb-3">
            <div class="col-12">
                <label for="ddtSetorEvento" class="label font-weight-bold">
                    <i class="fa-solid fa-building mr-1"></i>
                    Setor do Requisitante <span class="text-danger">*</span>
                </label>
                <ejs-dropdowntree id="ddtSetorEvento"
                                    allowFiltering="true"
                                    placeholder="Selecione um setor..."
                                    sortOrder="Ascending"
                                    showCheckBox="false"
                                    filterType="Contains"
                                    filterBarPlaceholder="Procurar setor..."
                                    popupHeight="200px">
                    <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                            value="SetorSolicitanteId"
                                            parentValue="SetorPaiId"
                                            hasChildren="HasChild"
                                            text="Nome">
                    </e-dropdowntree-fields>
                </ejs-dropdowntree>
            </div>
        </div>

        <!-- LINHA 6: Botões de Ação -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end mt-3" style="gap: 10px;">
                    <button type="button"
                            class="btn btn-azul"
                            id="btnInserirEvento">
                        <i class="fa-solid fa-check mr-1"></i>
                        Inserir Evento
                    </button>
                    <button type="button"
                            class="btn btn-vinho"
                            id="btnCancelarEvento">
                        <i class="fa-solid fa-times mr-1"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- SEÇÃO 4: Transporte -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-solid fa-car"></i> Informações do Transporte
                    </div>
                    <div class="section-card-body">
                        <!-- Motorista, Veículo, KM -->
                        <div class="row align-baseline">
                            <!-- Motorista -->
                            <div class="col-4 col-md-4">
                                <div class="d-flex flex-column ml-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <label id="lblMotorista" for="lstMotorista" class="label font-weight-bold mr-2" style="margin: 0;">Motorista</label>
                                        <i id="icoMotorista" class="fa-duotone fa-solid fa-person-biking field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </div>
                                    <ejs-combobox id="lstMotorista"
                                                  placeholder="Selecione um Motorista"
                                                  allowFiltering="true"
                                                  filterType="Contains"
                                                  popupHeight="200px"
                                                  width="100%"
                                                  showClearButton="true"
                                                  dataSource="@ViewData["dataMotorista"]"
                                                  data-ejtip="Motorista não aparece? Talvez esteja inativo">
                                        <e-combobox-fields text="Nome" value="MotoristaId"></e-combobox-fields>
                                    </ejs-combobox>
                                </div>
                            </div>

                            <!-- Veículo -->
                            <div class="col-4 col-md-3">
                                <div class="d-flex flex-column ml-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <label for="lstVeiculo" class="label mr-2 mb-0">Veículo</label>
                                        <i class="fa-duotone fa-solid fa-truck-bolt field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    </div>
                                    <ejs-combobox id="lstVeiculo"
                                                  placeholder="Selecione um Veículo"
                                                  allowFiltering="true"
                                                  filterType="Contains"
                                                  dataSource="@ViewData["dataVeiculo"]"
                                                  popupHeight="200px"
                                                  width="100%"
                                                  showClearButton="true"
                                                  data-ejtip="Veículo não aparece? Talvez esteja inativo">
                                        <e-combobox-fields text="Descricao" value="VeiculoId"></e-combobox-fields>
                                    </ejs-combobox>
                                </div>
                            </div>

                            <!-- Quilometragem -->
                            <div class="col-5 col-md-5 d-flex align-items-start">
                                <div class="form-group mr-2" id="divKmAtual">
                                    <label class="label">Km Atual</label>
                                    <i class="fa-duotone fa-solid fa-gauge field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    <input readonly id="txtKmAtual" class="form-control form-control-xs" />
                                </div>
                                <div class="form-group mr-2" id="divKmInicial">
                                    <label class="label">Km Inicial</label>
                                    <i class="fa-duotone fa-solid fa-gauge-max field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    <input id="txtKmInicial" class="form-control form-control-xs" />
                                </div>
                                <div class="form-group mr-2" id="divKmFinal">
                                    <label class="label">Km Final</label>
                                    <i class="fa-duotone fa-solid fa-gauge-min field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    <input id="txtKmFinal" class="form-control form-control-xs" />
                                </div>
                                <div class="form-group mr-2" id="divQuilometragem">
                                    <label class="label">Distância</label>
                                    <i class="fa-duotone fa-solid fa-road field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    <input id="txtQuilometragem"
                                           class="form-control form-control-xs"
                                           data-ejtip="Quilometragem alta? Confirme os valores antes de salvar" />
                                </div>
                            </div>
                        </div>

                        <!-- Combustível -->
                        <div class="row align-baseline mt-3">
                            <div class="col-6 col-md-3">
                                <div class="form-group" id="divCombustivelInicial">
                                    <label class="label">Combustível Inicial</label>
                                    <i class="fa-duotone fa-solid fa-gauge-circle-plus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    <ejs-dropdowntree id="ddtCombustivelInicial" popupHeight="200px" showClearButton="true">
                                        <e-dropdowntree-fields dataSource="@ViewData["dataCombustivel"]"
                                                               value="Nivel"
                                                               text="Descricao"
                                                               imageURL="Imagem">
                                        </e-dropdowntree-fields>
                                    </ejs-dropdowntree>
                                </div>
                            </div>

                            <div class="col-6 col-md-3">
                                <div class="form-group" id="divCombustivelFinal">
                                    <label class="label">Combustível Final</label>
                                    <i class="fa-duotone fa-solid fa-gauge-circle-minus field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
                                    <ejs-dropdowntree id="ddtCombustivelFinal" popupHeight="200px" showClearButton="true">
                                        <e-dropdowntree-fields dataSource="@ViewData["dataCombustivel"]"
                                                               value="Nivel"
                                                               text="Descricao"
                                                               imageURL="Imagem">
                                        </e-dropdowntree-fields>
                                    </ejs-dropdowntree>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

				<!-- ============================================
					 SEÇÃO 5: Requisitante e Setor - CORRIGIDO
					 ============================================ -->
				<div class="section-card">
					<div class="section-card-header">
						<i class="fa-solid fa-users"></i> Requisitante e Setor
					</div>
					<div class="section-card-body">
						<!-- ✅ CORREÇÃO PRINCIPAL: Adicionado align-items-end -->
						<div class="row align-items-end">
			
							<!-- ===== BLOCO 1: REQUISITANTE (col-md-5) ===== -->
							<div class="col-md-5">
								<div class="form-group mb-0">
									<div class="d-flex flex-column">
										<!-- Label com ícone -->
										<div class="d-flex align-items-center mb-1">
											<label for="lstRequisitante" class="label font-weight-bold mr-2" style="margin: 0;">
												Requisitante
											</label>
											<i class="fa-duotone fa-solid fa-person-simple field-icon" 
											   style="font-size: 1.25em; cursor: pointer;"></i>
										</div>
						
										<!-- ComboBox + Botão -->
										<div class="d-flex flex-row align-items-center" style="gap: 6px;">
											<ejs-combobox id="lstRequisitante"
														  placeholder="Selecione um Requisitante..."
														  allowFiltering="true"
														  filterType="Contains"
														  dataSource="@ViewData["dataRequisitante"]"
														  popupHeight="200px"
														  showClearButton="true"
														  cssClass="flex-grow-1"
														  data-ejtip="Se o <strong>Requisitante</strong> não estiver presente na Lista, verifique primeiro se ele não está <strong>Inativo</strong> antes de cadastrar um novo">
												<e-combobox-fields text="Requisitante" value="RequisitanteId"></e-combobox-fields>
											</ejs-combobox>
							
											<a class="btn btn-nfs" id="btnRequisitante" style="height: 38px; display: flex; align-items: center;">
												<i class="fal fa-user-plus"></i>
											</a>
										</div>
									</div>
								</div>

								<!-- Accordion Requisitante (mantido como está) -->
								<div id="accordionRequisitante" class="accordion-container-requisitante mt-2">
									<e-accordion>
										<e-accordion-items>
											<e-accordion-item expanded="false" header="Inserir um novo Requisitante">
												<ng-template #content>
													<form id="frmRequisitante">
														<div class="row g-3 mb-3">
															<div class="col-3">
																<div class="form-group">
																	<label for="txtPonto">Ponto</label>
																	<input type="text" id="txtPonto" class="form-control" />
																</div>
															</div>
															<div class="col-9">
																<div class="form-group">
																	<label for="txtNome">Nome do Requisitante</label>
																	<input type="text" id="txtNome" class="form-control" />
																</div>
															</div>
														</div>

														<div class="row g-3 mb-3">
															<div class="col-md-4">
																<div class="form-group">
																	<label for="txtRamal">Ramal</label>
																	<input type="text" id="txtRamal" class="form-control" />
																</div>
															</div>
															<div class="col-md-8">
																<div class="form-group">
																	<label for="txtEmail">Email</label>
																	<input type="email" id="txtEmail" class="form-control" />
																</div>
															</div>
														</div>

														<div class="form-group">
                                                            <label for="lstSetorRequisitanteAgendamento">Setor do Requisitante</label>



														</div>

														<div class="d-flex justify-content-end">
															<button id="btnInserirRequisitante" class="btn fundo-azul mr-2" type="submit">
																Inserir Requisitante
															</button>
															<button type="button" class="btn btn-danger" id="btnFecharAccordionRequisitante">
																Fechar
															</button>
														</div>
													</form>
												</ng-template>
											</e-accordion-item>
										</e-accordion-items>
									</e-accordion>
								</div>
							</div>

							<!-- ===== BLOCO 2: RAMAL (col-md-2) ===== -->
							<div class="col-md-2">
								<div class="form-group mb-0">
									<div class="d-flex flex-column">
										<!-- Label com ícone -->
										<div class="d-flex align-items-center mb-1">
											<label class="label font-weight-bold mr-2" style="margin: 0;">
												Ramal
											</label>
											<i class="fa-duotone fa-phone-office field-icon" 
											   style="font-size: 1.25em; cursor: pointer;"></i>
										</div>
						
										<!-- Input Ramal -->
										<input id="txtRamalRequisitante" 
											   class="form-control form-control-xs" 
											   style="height: 38px;" />
									</div>
								</div>
							</div>

							<!-- ===== BLOCO 3: SETOR (col-md-5) ===== -->
							<div class="col-md-5">
								<div class="form-group mb-0">
									<div class="d-flex flex-column">
										<!-- Label com ícone -->
										<div class="d-flex align-items-center mb-1">
											<label for="ddtSetor" class="label font-weight-bold mr-2" style="margin: 0;">
												Setor do Requisitante
											</label>
											<i class="fa-duotone fa-solid fa-building-user field-icon" 
											   style="font-size: 1.25em; cursor: pointer;"></i>
                                        </div>

                                        <ejs-dropdowntree id="lstSetorRequisitanteAgendamento"
                                                          allowFiltering="true"
                                                          placeholder="Selecione um setor..."
                                                          sortOrder="Ascending"
                                                          showCheckBox="false"
                                                          filterType="Contains"
                                                          filterBarPlaceholder="Procurar setor..."
                                                          popupHeight="200px">
                                            <e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
                                                                   value="SetorSolicitanteId"
                                                                   parentValue="SetorPaiId"
                                                                   hasChildren="HasChild"
                                                                   text="Nome">
                                            </e-dropdowntree-fields>
                                        </ejs-dropdowntree>

@* 										<!-- DropDownTree Setor -->
										<ejs-dropdowntree id="ddtSetor"
														  allowFiltering="true"
														  placeholder="Selecione um Setor..."
														  sortOrder="Ascending"
														  showCheckBox="false"
														  filterType="Contains"
														  filterBarPlaceholder="Procurar setor..."
														  width="100%">
											<e-dropdowntree-fields dataSource="@ViewData["dataSetor"]"
																   value="SetorSolicitanteId"
																   parentValue="SetorPaiId"
																   hasChildren="HasChild"
																   text="Nome"
																   expanded="expanded">
											</e-dropdowntree-fields>
										</ejs-dropdowntree> *@
									</div>
								</div>
							</div>

						</div>
						<!-- Fim da row align-items-end -->
					</div>
				</div>

                <!-- ============================================
                     SEÇÃO 6: Configurações de Recorrência - ESTRUTURA CORRIGIDA
                     ============================================ -->
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fa-solid fa-repeat"></i> Configurações de Recorrência
                    </div>
                    <div class="section-card-body">
                        <div class="select-container" id="divRecorrencia">
                            <div class="row">

                                <!-- ====================================
                                     CAMPO 1: Recorrente? (Sim/Não)
                                     ==================================== -->
                                <div class="select-wrapper col-md-9">
                                    <label for="lstRecorrente" class="label font-weight-bold mb-1">
                                        <i class="fa-solid fa-arrows-spin mr-1"></i>
                                        Recorrente?
                                    </label>
                                    <ejs-dropdownlist id="lstRecorrente"
                                                      dataSource="@ViewData["dataRecorrente"]"
                                                      placeholder="Selecione..."
                                                      popupHeight="200px"
                                                      change="RecorrenteValueChange">
                                        <e-dropdownlist-fields text="Descricao" value="RecorrenteId"></e-dropdownlist-fields>
                                    </ejs-dropdownlist>
                                </div>

                                <!-- ====================================
                                     CAMPO 2: Período (aparece quando seleciona SIM)
                                     ==================================== -->
                                <div class="select-wrapper col-md-3" id="divPeriodo" style="display: none;">
                                    <label for="lstPeriodos" class="label font-weight-bold mb-1">
                                        <i class="fa-solid fa-calendar-circle-exclamation mr-1"></i>
                                        Período
                                    </label>
                                    <input id="lstPeriodos" type="text" />
                                </div>

                                <!-- ====================================
                                     CAMPO 3: Dias da Semana (Semanal/Quinzenal)
                                     ==================================== -->
                                <div class="select-wrapper col-md-3" id="divDias" style="display: none;">
                                    <label for="lstDias" class="label font-weight-bold mb-1">
                                        <i class="fa-solid fa-calendar-week mr-1"></i>
                                        Dias da Semana
                                    </label>
                                    <ejs-multiselect id="lstDias"
                                                     placeholder="Selecione os dias..."
                                                     mode="CheckBox"
                                                     showSelectAll="true"
                                                     selectAllText="Selecionar todos"
                                                     unSelectAllText="Desmarcar todos"
                                                     popupHeight="250px">
                                        <e-multiselect-fields value="Value" text="Text"></e-multiselect-fields>
                                    </ejs-multiselect>
                                </div>

                                <!-- ====================================
                                     CAMPO 4: Dia do Mês (Mensal)
                                     ==================================== -->
                                <div class="select-wrapper col-md-2" id="divDiaMes" style="display: none;">
                                    <label for="lstDiasMes" class="label font-weight-bold mb-1">
                                        <i class="fa-solid fa-calendar-clock mr-1"></i>
                                        Dia do Mês
                                    </label>
                                    <ejs-dropdownlist id="lstDiasMes"
                                                      placeholder="Selecione o dia..."
                                                      popupHeight="250px">
                                        <e-dropdownlist-fields value="Value" text="Text"></e-dropdownlist-fields>
                                    </ejs-dropdownlist>
                                </div>

                                <!-- ====================================
                                     CAMPO 5: Data Final Recorrência (aparece DEPOIS de selecionar período)
                                     ==================================== -->
                                <div class="select-wrapper col-md-3" id="divFinalRecorrencia" style="display: none;">
                                    <label for="txtFinalRecorrencia" class="label font-weight-bold mb-1">
                                        <i class="fa-solid fa-calendar-check mr-1"></i>
                                        Data Final Recorrência
                                    </label>
                                    <ejs-datepicker id="txtFinalRecorrencia"
                                                    format="dd/MM/yyyy"
                                                    placeholder="Selecione a data"
                                                    locale="pt-BR">
                                    </ejs-datepicker>
                                </div>

                            </div>

                            <!-- ====================================
                                 CALENDÁRIO (para recorrência variada)
                                 ==================================== -->
                            <div class="calendar-container" id="calendarContainer" style="display: none;">
                                <div id="calDatasSelecionadas"></div>
                            </div>
                        </div>
                    </div>
                </div>

				<!-- SEÇÃO 7: Descrição da Viagem -->
				<div class="section-card">
					<div class="section-card-header">
						<i class="fa-solid fa-file-alt"></i> Descrição da Viagem
					</div>
					<div class="section-card-body">
						<div class="row">
							<div class="col-md-12 col-xl-10 control-section">
								<div class="control-wrapper">
									<div>
										<div class="d-flex flex-column ml-2">
											<div class="d-flex align-items-center mb-1">
												<label for="rteDescricao" class="label mr-2 mb-0">Descrição da Viagem (passageiros / carga)</label>
												<i class="fa-duotone fa-solid fa-typewriter field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
											</div>
											<ejs-richtexteditor id="rteDescricao" locale="pt-BR" height="250px">
												<e-richtexteditor-insertimagesettings saveUrl="api/Viagem/SaveImage" path="./DadosEditaveis/ImagensViagens/"></e-richtexteditor-insertimagesettings>
											</ejs-richtexteditor>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

                <!-- ====================================================================
                     SEÇÃO 8: Relatório da Ficha de Vistoria (PADRONIZADO)
                     ==================================================================== -->
                <div class="section-card" id="cardRelatorio" style="display: none;">
                    <div class="section-card-header">
                        <i class="fa-duotone fa-solid fa-file-pdf" style="color: #e74c3c;"></i> Ficha da Viagem
                    </div>
                    <div class="section-card-body p-0">
                        <input type="hidden" id="txtViagemIdRelatorio" />

                        <div id="ReportContainerAgenda" style="min-height: 850px; background-color: #f8f9fa;">
                            <div id="reportViewerAgenda" style="width:100%; height: 800px; min-height: 800px;">
                                <div class="text-center p-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Carregando relatório...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- User Labels -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="form-group">
                            <label id="lblUsuarioAgendamento" class="font-weight-light d-block text-muted">
                                <i class="fa-duotone fa-solid fa-user-clock"></i> <span>Agendado por:</span>
                            </label>
                            <label id="lblUsuarioCriacao" class="font-weight-light d-block text-muted">
                                <i class="fa-sharp-duotone fa-solid fa-user-plus"></i> <span>Criado por:</span>
                            </label>
                            <label id="lblUsuarioFinalizacao" class="font-weight-light d-block text-muted">
                                <i class="fa-duotone fa-solid fa-user-check"></i> <span>Finalizado por:</span>
                            </label>
                            <label id="lblUsuarioCancelamento" class="font-weight-light d-block text-muted">
                                <i class="fa-duotone fa-regular fa-trash-can-xmark"></i> <span>Cancelado por:</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer - MANTIDO ORIGINAL -->
                <div class="modal-footer" id="divBotoes">
                    <button id="btnViagem" type="button" class="btn btn-sm fundo-laranja">
                        <i class="fa-regular fa-shuffle" aria-hidden="true"></i>&nbsp;Transforma em Viagem
                    </button>
                    <button id="btnConfirma" type="button" class="btn btn-sm btn-azul">
                        <i class="fa fa-save" aria-hidden="true"></i>Confirmar
                    </button>
                    <button id="btnApaga" type="button" class="btn btn-sm btn-vinho-fechar">
                        <i class="fa-light fa-trash-can-undo" aria-hidden="true"></i>Apagar
                    </button>
                    <button id="btnCancela" type="button" class="btn btn-sm fundo-vermelho">
                        <i class="fa fa-ban" aria-hidden="true"></i>Cancelar
                    </button>
                    <button id="btnFecha" type="button" class="btn btn-sm fundo-ebony" data-bs-dismiss="modal">
                        <i class="fa fa-times" aria-hidden="true"></i>Fechar
                    </button>
                    
                </div>
            </div>
        </div>
    </div>
</div>

@* ============================================
   MODAL DA FICHA DA VIAGEM
   ============================================ *@
@* <form method="post" asp-action="Index" enctype="multipart/form-data">
    <div class="modal fade" id="modalPrint">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-azul">
                    <h4 class="modal-title" id="DynamicModalLabel">Ficha do Agendamento</h4>
                    <button id="btnFecharFicha" type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
                </div>
                <div class="modal-body table-bordered container-fluid">
                    <div class="row">
                        <div class="col-xl-12">
                            <div id="panel-1" class="panel">
                                <div class="panel-container show">
                                    <div id="divPainel" class="panel-content">
                                        <div class="d-flex" style="height:700px" id="ReportContainer">
                                            <div id="reportViewer1" style="width:100%" class="pb-3">
                                                Carregando...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </div>
</form> *@

@section ScriptsBlock
{
    @* ============================================
       DADOS DO SERVIDOR (C# → JavaScript)
       ============================================ *@
    <script>
        window.dataFinalidade = @Html.Raw(Json.Serialize(ViewData["dataFinalidade"]));
        window.dataPeriodo = @Html.Raw(Json.Serialize(ViewData["dataPeriodo"]));
        window.dataPeriodos = @Html.Raw(Json.Serialize(ViewData["dataPeriodos"]));
    </script>
    
    @* ============================================
       DEPENDÊNCIAS EXTERNAS
       ============================================ *@
    <link href="https://cdn.kendostatic.com/2022.1.412/styles/kendo.default-main.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.kendostatic.com/2022.1.412/js/jszip.min.js"></script>
    <script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.all.min.js"></script>
    <script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.aspnetmvc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
    </script>
    <script src="/api/reports/resources/js/telerikReportViewer"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.js" integrity="sha512-zAadCzZHXo/f5A/3uhF50bZXahdYNqisNgKKniyoJJVpp27b2bR82N4hPLGj3/qBEh3tGZ9SYGmSA1jpdtNF5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="~/lib/fullcalendar/locales-all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
    <script src="/api/reports/resources/js/telerikReportViewer-18.1.24.514.min.js"></script>

    @* ============================================
       CORE - Camada Base
       ============================================ *@
    <script src="~/js/agendamento/core/ajax-helper.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/core/state.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/core/api-client.js" asp-append-version="true"></script>

    @* ============================================
       UTILS - Utilitários
       ============================================ *@
    <script src="~/js/agendamento/utils/date.utils.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/utils/syncfusion.utils.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/utils/formatters.js" asp-append-version="true"></script>

    @* ============================================
       SERVICES - Serviços de API
       ============================================ *@
    <script src="~/js/agendamento/services/agendamento.service.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/services/viagem.service.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/services/requisitante.service.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/services/evento.service.js" asp-append-version="true"></script>

    @* ============================================
       COMPONENTS - Componentes da UI
       ============================================ *@
    <script src="~/js/agendamento/components/validacao.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/recorrencia.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/modal-config.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/modal-viagem.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/exibe-viagem.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/event-handlers.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/dialogs.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/controls-init.js" asp-append-version="true"></script>
	<script src="~/js/agendamento/components/recorrencia-init.js" asp-append-version="true"></script> <!-- ✅ NOVO -->
	<script src="~/js/agendamento/components/relatorio.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/evento.js" asp-append-version="true"></script>
    <script src="~/js/agendamento/components/calendario.js" asp-append-version="true"></script>

    @* ============================================
       MAIN - Inicialização (SEMPRE POR ÚLTIMO)
       ============================================ *@
    <script src="~/js/agendamento/main.js" asp-append-version="true"></script>
}

@* ---

## **📊 ORDEM HIERÁRQUICA DE DEPENDÊNCIAS**
```
NÍVEL 1 - CORE (Base)
├── ajax-helper.js
├── state.js
└── api-client.js

NÍVEL 2 - UTILS (Utilitários)
├── date.utils.js
├── syncfusion.utils.js
└── formatters.js

NÍVEL 3 - SERVICES (Serviços)
├── agendamento.service.js
├── viagem.service.js
├── requisitante.service.js
└── evento.service.js

NÍVEL 4 - COMPONENTS (Componentes)
├── validacao.js
├── recorrencia.js
├── recorrencia-init.js
├── relatorio.js
├── modal-config.js
├── modal-viagem.js
├── exibe-viagem.js
├── event-handlers.js
├── dialogs.js
├── controls-init.js
└── calendario.js

NÍVEL 5 - MAIN (Inicialização)
└── main.js
```

---

## **🎯 RECOMENDAÇÃO**

Use a **OPÇÃO 1** (com partial) porque:

✅ Mantém o Index.cshtml limpo  
✅ Facilita manutenção  
✅ Pode reutilizar em outras páginas  
✅ Separa responsabilidades  
✅ Evita duplicação  

---

## **✅ CHECKLIST DE VERIFICAÇÃO**
```
[ ] Partial _ScriptsAgendamento.cshtml existe em Views/Shared/
[ ] Partial tem todos os 18 arquivos JS na ordem correta
[ ] Index.cshtml tem @await Html.PartialAsync("_ScriptsAgendamento")
[ ] Todos os arquivos JS existem no caminho correto
[ ] Limpar cache do navegador (Ctrl+F5)
[ ] Verificar no DevTools > Network se todos carregaram
[ ] Verificar console se há erros de "not defined" *@
