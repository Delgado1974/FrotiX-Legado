@page

@{
	ViewData["Title"] = "Importar Planilha TaxiLeg";
	ViewData["PageName"] = "taxileg_importacao";
	ViewData["Heading"] = "<i class='fa-duotone fa-taxi'></i> Importação: <span class='fw-300'>Planilha TaxiLeg</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-taxi";
}

@section HeadBlock {
	<link rel="stylesheet" href="~/css/ImportaTaxiLeg.css" />
}

<div class="row h-100">
	<!-- altura total da janela -->
	<div class="col-xl-12 d-flex flex-column h-100">
		<div id="panel-1" class="panel flex-grow-1 d-flex flex-column">
			<div class="panel-container show flex-grow-1 d-flex flex-column">
				<div class="panel-content d-flex flex-column flex-grow-1">

					<!-- Token anti-forgery para AJAX -->
					@Html.AntiForgeryToken()

					<!-- Bloco de controles (altura fixa) -->
					<div id="controles" class="container mt-4">
						<h2 class="text-primary mb-4">Importar Planilha TaxiLeg</h2>
						<div class="row mb-3">
							<div class="col-12 col-md-6">
								<input type="file" id="fileupload" class="form-control" accept=".xls,.xlsx" />
							</div>
							<div class="col-12 col-md-6">
								<button id="btnupload" class="btn btn-azul text-white" aria-label="Fazer upload da planilha do TaxiLeg">
									<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> &nbsp; Upload
								</button>
							</div>
						</div>
					</div>

					<!-- Grid: cresce para preencher o restante -->
					<div id="divTaxiLeg" class="flex-grow-1 px-0 w-100"></div>

				</div>
			</div>
		</div>
	</div>
</div>

@section ScriptsBlock {
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<!-- Syncfusion JS -->
	<script src="https://cdn.syncfusion.com/ej2/dist/ej2.min.js"></script>
	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- Script de loading (opcional) -->
	<script src="js/loading_script.js"></script>

	<script type="text/javascript">
		$(function () {
			try {
				$('#btnupload').on('click', function (e) {
					try {
						e.preventDefault();

						const allowedExt = ['xls', 'xlsx'];
						const $input = $('#fileupload');
						const filename = $input.val();

						if (!filename || filename.length === 0) {
							AppToast.show("Amarelo", "Por favor, selecione um arquivo.", 2000);
							return false;
						}

						const extension = filename.split('.').pop().toLowerCase();
						if ($.inArray(extension, allowedExt) === -1) {
							AppToast.show("Vermelho", "Por favor, selecione apenas arquivos do Excel (.xls, .xlsx).", 2000);
							return false;
						}

						const fileUpload = $input.get(0);
						if (!fileUpload || !fileUpload.files || fileUpload.files.length === 0) {
							AppToast.show("Vermelho", "Nenhum arquivo selecionado.", 2000);
							return false;
						}

						const fdata = new FormData();
						fdata.append('file', fileUpload.files[0]);

						// Ativa o loading (opcional)
						if ($('#divTaxiLeg').LoadingScript) {
							$('#divTaxiLeg').LoadingScript('method_12', {
								'background_image': 'img/loading7.png',
								'main_width': 60,
								'animation_speed': 10,
								'additional_style': '',
								'after_element': false
							});
						}

						// Desabilita o botão durante o upload
						$('#btnupload').prop('disabled', true).addClass('disabled');

						$.ajax({
							type: "POST",
							url: "/api/TaxiLeg/Import",
							data: fdata,
							contentType: false,
							processData: false,
							beforeSend: function (xhr) {
								try {
									// Envia o token anti-CSRF (se exigido pela API)
									const token = $('input[name="__RequestVerificationToken"]').val();
									if (token) {
										xhr.setRequestHeader("XSRF-TOKEN", token);
									}
								} catch (error) {
									Alerta.TratamentoErroComLinha("Importacao.cshtml", "btnupload.ajax.beforeSend", error);
								}
							},
							success: function (data) {
								try {
									// Sucesso quando a API retorna a coleção de dados
									if (data && Array.isArray(data.data) && data.data.length > 0) {
										AppToast.show('Verde', 'Planilha importada com sucesso!', 2000);
										renderSyncfusionGrid(data.data);
									} else if (data && data.success === true && Array.isArray(data.response?.data) && data.response.data.length > 0) {
										// Fallback para outra estrutura de retorno
										AppToast.show('Verde', data.message || 'Planilha importada com sucesso!', 2000);
										renderSyncfusionGrid(data.response.data);
									} else {
										const msg = (data && data.message) ? data.message : 'Nenhum dado para exibir.';
										AppToast.show('Amarela', msg, 2000);
										$('#divTaxiLeg').html(`
											<div class="taxi-leg-container">
												<h4>${msg}</h4>
											</div>
										`);
									}
								} catch (error) {
									Alerta.TratamentoErroComLinha("Importacao.cshtml", "btnupload.ajax.success", error);
								} finally {
									if ($('#divTaxiLeg').LoadingScript) {
										$('#divTaxiLeg').LoadingScript('destroy');
									}
									$('#btnupload').prop('disabled', false).removeClass('disabled');
								}
							},
							error: function (err) {
								try {
									console.log(err);
									AppToast.show('Vermelho', 'Erro na importação! Tente novamente.', 2000);
									if ($('#divTaxiLeg').LoadingScript) {
										$('#divTaxiLeg').LoadingScript('destroy');
									}
									$('#btnupload').prop('disabled', false).removeClass('disabled');
								} catch (error) {
									Alerta.TratamentoErroComLinha("Importacao.cshtml", "btnupload.ajax.error", error);
								}
							}
						});
					} catch (error) {
						Alerta.TratamentoErroComLinha("Importacao.cshtml", "btnupload.click", error);
					}
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("Importacao.cshtml", "document.ready", error);
			}
		});

		function resetScroll(g) {
			try {
				// conteúdo
				const content = g.getContent().querySelector('.e-content');
				if (content) content.scrollLeft = 0;

				// cabeçalho (mantém sincronizado)
				const header = g.getHeaderContent().querySelector('.e-headercontent');
				if (header) header.scrollLeft = 0;
			} catch (error) {
				Alerta.TratamentoErroComLinha("Importacao.cshtml", "resetScroll", error);
			}
		}

		function renderSyncfusionGrid(dados) {
			try {
				// Limpa antes de renderizar
				$('#divTaxiLeg').html('');

				var grid = new ej.grids.Grid({
					dataSource: dados,
					allowPaging: true,
					allowSorting: true,
					allowScrolling: true,
					height: '700px',            // altura fixa para caber no layout
					width: '100%',
					toolbar: ['Print'],
					printMode: 'AllPages',
					pageSettings: { pageSize: 19 },
					columns: [
						{ field: 'qru', headerText: 'QRU', width: 90, textAlign: 'Center' },
						{ field: 'setor', headerText: 'Setor', width: 90, textAlign: 'Center' },
						{ field: 'descSetor', headerText: 'Descrição Setor', width: 150 },
						{ field: 'unidade', headerText: 'Unidade', width: 110, textAlign: 'Center' },
						{ field: 'descUnidade', headerText: 'Descrição Unidade', width: 200 },
						{ field: 'qtdPassageiros', headerText: 'Passageiros', width: 110, textAlign: 'Center' },
						{ field: 'motivoUso', headerText: 'Motivo Uso', width: 200 },
						{ field: 'dataAgenda', headerText: 'Data Inicial', width: 110, textAlign: 'Center', format: 'dd/MM/yyyy', type: 'date' },
						{ field: 'horaAgenda', headerText: 'Hora', width: 100 },
						{ field: 'horaAceite', headerText: 'Aceite', width: 100 },
						{ field: 'horaLocal', headerText: 'Local', width: 100 },
						{ field: 'horaInicio', headerText: 'Início', width: 100 },
						{ field: 'horaFinal', headerText: 'Final', width: 100 },
						{ field: 'dataFinal', headerText: 'Data Final', width: 110, textAlign: 'Center', format: 'dd/MM/yyyy', type: 'date' },
						{ field: 'origemCorrida', headerText: 'Origem', width: 200 },
						{ field: 'destinoCorrida', headerText: 'Destino', width: 200 },
						{ field: 'kmReal', headerText: 'Km', width: 90, textAlign: 'Right', format: 'N2' },
						{ field: 'qtdEstrelas', headerText: 'Estrelas', width: 100, textAlign: 'Center' },
						{ field: 'avaliacao', headerText: 'Avaliação', width: 120, textAlign: 'Center' },
						{ field: 'duracao', headerText: 'Duração', width: 100, textAlign: 'Right' },
						{ field: 'espera', headerText: 'Espera', width: 100, textAlign: 'Right' },
						{
							field: 'glosa',
							headerText: 'Glosa',
							width: 100,
							textAlign: 'Center',
							template: function (args) {
								try {
									return args.glosa === true
										? `<span class="botao-sim-fake">
											   <i class="fa-duotone fa-skull-crossbones"></i>
											   Sim
										   </span>`
										: '';
								} catch (error) {
									Alerta.TratamentoErroComLinha("Importacao.cshtml", "grid.glosa.template", error);
									return '';
								}
							}
						},
						{
							field: 'valorGlosa',
							headerText: 'Valor da Glosa',
							width: 140,
							textAlign: 'Right',
							template: function (e) {
								try {
									return (e && typeof e.valorGlosa === 'number')
										? e.valorGlosa.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
										: (e && e.valorGlosa ? Number(e.valorGlosa).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '');
								} catch (error) {
									Alerta.TratamentoErroComLinha("Importacao.cshtml", "grid.valorGlosa.template", error);
									return '';
								}
							}
						}
					],
					aggregates: [{
						columns: [{
							field: 'valorGlosa',
							type: 'Sum',
							footerTemplate: function (args) {
								try {
									const total = Number(args.Sum) || 0;
									return `<span style="font-weight:bold;white-space:nowrap">
												Total: ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
											</span>`;
								} catch (error) {
									Alerta.TratamentoErroComLinha("Importacao.cshtml", "grid.aggregates.footerTemplate", error);
									return '';
								}
							}
						}]
					}],
					created: function () {
						try {
							resetScroll(this);
						} catch (error) {
							Alerta.TratamentoErroComLinha("Importacao.cshtml", "grid.created", error);
						}
					},
					dataBound: function () {
						try {
							// garante que sempre parte do 0
							const content = this.getContent();
							if (content && content.firstChild) {
								content.firstChild.scrollLeft = 0;
							}
						} catch (error) {
							Alerta.TratamentoErroComLinha("Importacao.cshtml", "grid.dataBound", error);
						}
					}
				});

				grid.appendTo('#divTaxiLeg');
			} catch (error) {
				Alerta.TratamentoErroComLinha("Importacao.cshtml", "renderSyncfusionGrid", error);
			}
		}
	</script>
}
