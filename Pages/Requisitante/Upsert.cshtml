@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Requisitante.UpsertModel

@{
	ViewData["Title"] = "Requisitantes";
	ViewData["PageName"] = "requisitante_upsert";
	ViewData["Heading"] = "<i class='fad fa-user-tie'></i> Cadastros: <span class='fw-300'>Requisitantes</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fad fa-user-tie";
}

@section HeadBlock {
}

<style>
	/* ===== LABELS DO FORMULÁRIO - PADRÃO FROTIX ===== */
	.ftx-label {
		font-weight: 600;
		color: #495057;
		margin-bottom: 0.5rem;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.ftx-label i {
		color: #325d88;
		font-size: 0.9rem;
		--fa-primary-color: #325d88;
		--fa-secondary-color: #6c9fd4;
	}

	.ftx-label .text-danger {
		margin-left: 2px;
	}

	/* ===== CHECKBOX DE STATUS - PADRÃO FROTIX ===== */
	.ftx-checkbox {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		cursor: pointer;
	}

	.ftx-checkbox input[type="checkbox"] {
		width: 1.25rem;
		height: 1.25rem;
		cursor: pointer;
		accent-color: #198754;
	}

	.ftx-checkbox label {
		font-weight: 600;
		cursor: pointer;
		margin: 0;
		user-select: none;
	}

	/* ===== BOTÕES DE AÇÃO - PADRÃO FROTIX ===== */
	.btn-ftx-salvar {
		background-color: #325d88 !important;
		border-color: #325d88 !important;
		color: #fff !important;
		padding: 0.5rem 1.5rem;
		font-weight: 600;
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		transition: all 0.3s ease;
		box-shadow: 0 0 8px rgba(50, 93, 136, 0.4);
	}

	.btn-ftx-salvar:hover {
		background-color: #2a4d73 !important;
		border-color: #2a4d73 !important;
		box-shadow: 0 0 15px rgba(50, 93, 136, 0.6);
		transform: translateY(-2px);
	}

	/* Botão com loading spinner */
	.btn-loading {
		position: relative;
		pointer-events: none;
		opacity: 0.8;
	}

	.btn-loading .btn-text {
		visibility: hidden;
	}

	.btn-loading .btn-spinner {
		position: absolute;
		left: 50%;
		top: 50%;
		transform: translate(-50%, -50%);
	}

	/* ===== AJUSTES PARA DROPDOWNTREE ===== */
	#ddtree {
		width: 100% !important;
	}

	.e-ddt.e-control-wrapper .e-ddt-wrap {
		border-bottom: 1px solid #ced4da !important;
	}

	.e-ddt.e-control-wrapper.e-input-focus .e-ddt-wrap {
		border-bottom: 2px solid #325d88 !important;
	}

	/* ===== VALIDAÇÃO ===== */
	.form-group .text-danger {
		display: block;
		margin-top: 0.25rem;
		font-size: 0.875rem;
	}

	/* ===== FORM CONTROL ===== */
	.form-control:focus {
		border-color: #325d88;
		box-shadow: 0 0 0 0.2rem rgba(50, 93, 136, 0.25);
	}
</style>

<form method="post" id="formRequisitante">
	@Html.AntiForgeryToken()
	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<div class="panel-container show">

					<!-- HEADER DO CARD - PADRÃO FROTIX -->
					<div class="ftx-card-header">
						<h2 class="titulo-paginas">
							<i class="fa-duotone fa-user-tie"></i>
							@(Model.RequisitanteObj.Requisitante.RequisitanteId != Guid.Empty ? "Editar" : "Novo") Requisitante
						</h2>
						<div class="ftx-card-actions">
							<a href="javascript:void(0)" class="btn btn-header-orange" id="btnVoltarLista">
								<i class="fa-duotone fa-arrow-left" style="--fa-primary-color:#fff; --fa-secondary-color:#ffeeba;"></i>
								Voltar à Lista
							</a>
						</div>
					</div>

					<div class="panel-content">
						<div asp-validation-summary="ModelOnly" class="text-danger"></div>

						@if (Model.RequisitanteObj.Requisitante.RequisitanteId != Guid.Empty)
						{
							<input type="hidden" asp-for="RequisitanteObj.Requisitante.RequisitanteId" />
						}

						<!-- Formulário -->
						<div class="col-12 px-3 pt-3">

							<!-- Linha 1: Ponto, Nome e Ramal -->
							<div class="row mb-3">
								<div class="col-md-2">
									<div class="form-group">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Ponto">
											<i class="fa-duotone fa-hashtag"></i>
											Ponto <span class="text-danger">*</span>
										</label>
										<input class="form-control form-control-sm"
											   asp-for="RequisitanteObj.Requisitante.Ponto"
											   placeholder="Ex: 12345" />
										<span class="text-danger small"
											  asp-validation-for="RequisitanteObj.Requisitante.Ponto"></span>
									</div>
								</div>
								<div class="col-md-8">
									<div class="form-group">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Nome">
											<i class="fa-duotone fa-user"></i>
											Nome Completo <span class="text-danger">*</span>
										</label>
										<input class="form-control form-control-sm"
											   asp-for="RequisitanteObj.Requisitante.Nome"
											   placeholder="Digite o nome completo" />
										<span class="text-danger small"
											  asp-validation-for="RequisitanteObj.Requisitante.Nome"></span>
									</div>
								</div>
								<div class="col-md-2">
									<div class="form-group">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Ramal">
											<i class="fa-duotone fa-phone"></i>
											Ramal
										</label>
										<input class="form-control form-control-sm"
											   asp-for="RequisitanteObj.Requisitante.Ramal"
											   placeholder="Ex: 1234" />
										<span class="text-danger small"
											  asp-validation-for="RequisitanteObj.Requisitante.Ramal"></span>
									</div>
								</div>
							</div>

							<!-- Linha 2: Email e Setor -->
							<div class="row mb-3">
								<div class="col-md-6">
									<div class="form-group">
										<label class="ftx-label" asp-for="RequisitanteObj.Requisitante.Email">
											<i class="fa-duotone fa-envelope"></i>
											E-mail
										</label>
										<input class="form-control form-control-sm"
											   asp-for="RequisitanteObj.Requisitante.Email"
											   type="email"
											   placeholder="exemplo@dominio.com" />
										<span class="text-danger small"
											  asp-validation-for="RequisitanteObj.Requisitante.Email"></span>
									</div>
								</div>
								<div class="col-md-6">
									<div class="form-group">
										<label class="ftx-label">
											<i class="fa-duotone fa-building"></i>
											Setor do Requisitante
										</label>

										<!-- Campo hidden conectado ao modelo -->
										<input type="hidden"
											   asp-for="RequisitanteObj.Requisitante.SetorSolicitanteId"
											   id="hiddenSetorId" />

										<ejs-dropdowntree id="ddtree"
														  placeholder="Selecione um Setor"
														  sortOrder="Ascending"
														  showCheckBox="false"
														  allowMultiSelection="false"
														  allowFiltering="true"
														  filterType="Contains"
														  value="@Model.RequisitanteObj.Requisitante.SetorSolicitanteId"
														  filterBarPlaceholder="Procurar..."
														  change="onSetorChange">
											<e-dropdowntree-fields dataSource="@ViewData["dataSource"]"
																   value="SetorSolicitanteId"
																   text="Nome"
																   parentValue="SetorPaiId"
																   hasChildren="HasChild">
											</e-dropdowntree-fields>
										</ejs-dropdowntree>
									</div>
								</div>
							</div>

							<!-- Linha 3: Status -->
							<div class="row mb-4">
								<div class="col-12">
									<div class="form-group mb-0">
										<div class="ftx-checkbox">
											<input type="checkbox"
												   asp-for="RequisitanteObj.Requisitante.Status"
												   id="statusCheck" />
											<label for="statusCheck">
												<i class="fa-duotone fa-circle-check me-1" style="--fa-primary-color:#198754; --fa-secondary-color:#c8e6c9;"></i>
												Ativo
											</label>
										</div>
									</div>
								</div>
							</div>

							<!-- Linha 4: Botões de Ação -->
							<div class="row mt-4 mb-3">
								<div class="col-12">
									<div class="d-flex justify-content-start gap-2">
										@if (Model.RequisitanteObj.Requisitante.RequisitanteId != Guid.Empty)
										{
											<button type="submit"
													asp-page-handler="Edit"
													asp-route-id="@Model.RequisitanteObj.Requisitante.RequisitanteId"
													class="btn btn-ftx-salvar"
													id="btnSalvar">
												<i class="fa-duotone fa-pen-to-square btn-icon" style="--fa-primary-color:#fff; --fa-secondary-color:#90caf9;"></i>
												<span class="btn-text">Atualizar</span>
												<i class="fa-duotone fa-spinner-third fa-spin btn-spinner" style="display:none; --fa-primary-color:#fff; --fa-secondary-color:#90caf9;"></i>
											</button>
										}
										else
										{
											<button type="submit"
													asp-page-handler="Submit"
													class="btn btn-ftx-salvar"
													id="btnSalvar">
												<i class="fa-duotone fa-file-plus btn-icon" style="--fa-primary-color:#fff; --fa-secondary-color:#c8e6c9;"></i>
												<span class="btn-text">Criar</span>
												<i class="fa-duotone fa-spinner-third fa-spin btn-spinner" style="display:none; --fa-primary-color:#fff; --fa-secondary-color:#90caf9;"></i>
											</button>
										}
									</div>
								</div>
							</div>

						</div> <!-- /.col-12 px-3 -->
					</div> <!-- /.panel-content -->
				</div> <!-- /.panel-container -->
			</div> <!-- /#panel-1 -->
		</div>
	</div>
</form>

@section ScriptsBlock {
	<script type="text/javascript">
		// Função para atualizar o campo hidden quando o setor é selecionado
		function onSetorChange(args) {
			try {
				var setorId = args.value;
				var hiddenField = document.getElementById('hiddenSetorId');
				if (hiddenField) {
					hiddenField.value = setorId;
					// Dispara evento change para detectar alteração no formulário
					$(hiddenField).trigger('change');
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "onSetorChange", error);
			}
		}

		$(document).ready(function () {
			try {
				// Salva o estado inicial do formulário para detectar mudanças
				var estadoInicial = $('#formRequisitante').serialize();
				var formularioAlterado = false;

				// Detecta mudanças no formulário
				$('#formRequisitante').on('change input', 'input, select, textarea', function () {
					try {
						formularioAlterado = ($('#formRequisitante').serialize() !== estadoInicial);
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "form.change", error);
					}
				});

				// Intercepta clique no botão Voltar à Lista
				$('#btnVoltarLista').on('click', function (e) {
					try {
						e.preventDefault();
						
						if (formularioAlterado) {
							Alerta.Confirmar(
								"Descartar Alterações?",
								"Você fez alterações no formulário que ainda não foram salvas. Deseja realmente descartar essas mudanças?",
								"Sim, descartar",
								"Cancelar"
							).then(function (confirmado) {
								try {
									if (confirmado) {
										window.location.href = '/Requisitante';
									}
								} catch (error) {
									Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnVoltarLista.confirmar.then", error);
								}
							});
						} else {
							window.location.href = '/Requisitante';
						}
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnVoltarLista.click", error);
					}
				});

				// Define o setor selecionado ao abrir a página (edição)
				var ddtree = document.getElementById("ddtree");
				if (ddtree && ddtree.ej2_instances && ddtree.ej2_instances[0]) {
					ddtree.ej2_instances[0].value = ["@Model.RequisitanteObj.Requisitante.SetorSolicitanteId"];
				}

				// Loading no botão ao submeter o formulário
				$('#formRequisitante').on('submit', function () {
					try {
						var btnSalvar = $('#btnSalvar');
						btnSalvar.prop('disabled', true);
						btnSalvar.find('.btn-icon').hide();
						btnSalvar.find('.btn-text').css('visibility', 'hidden');
						btnSalvar.find('.btn-spinner').show();
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "form.submit", error);
					}
				});

			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "document.ready", error);
			}
		});
	</script>
}
