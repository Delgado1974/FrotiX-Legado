@page
@model FrotiX.Pages.Empenho.IndexModel

@{
    ViewData["Title"] = "Empenhos";
    ViewData["PageName"] = "empenho_index";
    ViewData["Heading"] = "<i class='fa-duotone fa-money-check-alt'></i> Cadastros: <span class='fw-300'>Empenhos</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-money-check-alt";
}

@section HeadBlock {
    <style>
/* ======== OUTLINE BRANCO NO BOTÃO DO HEADER (Padrão FrotiX) ======== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

        /* Container de Filtros */
        .ftx-filtros-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border: 1px solid rgba(50, 93, 136, 0.12);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .ftx-filtros-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #325d88;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ftx-filtros-title i {
            font-size: 1.2rem;
            --fa-primary-color: #325d88;
            --fa-secondary-color: #7a9cc6;
        }

        .ftx-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #2d4559;
            margin-bottom: 0.35rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .ftx-label i {
            font-size: 0.9rem;
            --fa-primary-color: #3D5771;
            --fa-secondary-color: #7a9cc6;
        }

        /* DataTable Estilizado */
        .ftx-datatable-wrapper {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .ftx-datatable-wrapper table.dataTable thead {
            background: linear-gradient(135deg, #325d88 0%, #2a4d73 100%);
        }

        .ftx-datatable-wrapper table.dataTable thead th {
            color: #fff !important;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border: none !important;
            padding: 0.875rem 0.75rem;
        }

        .ftx-datatable-wrapper table.dataTable tbody tr {
            transition: background-color 0.15s ease;
        }

        .ftx-datatable-wrapper table.dataTable tbody tr:hover {
            background-color: rgba(50, 93, 136, 0.06) !important;
        }

        .ftx-datatable-wrapper table.dataTable tbody td {
            vertical-align: middle;
            padding: 0.75rem;
            border-color: rgba(0, 0, 0, 0.05);
        }

        /* Paginação Estilizada */
        .ftx-datatable-wrapper .dataTables_paginate .paginate_button {
            border-radius: 6px !important;
            margin: 0 2px;
            border: none !important;
            padding: 6px 12px !important;
            min-width: 36px !important;
            text-align: center !important;
        }

        .ftx-datatable-wrapper .dataTables_paginate .paginate_button.current,
        .ftx-datatable-wrapper .dataTables_paginate .paginate_button.current:hover {
            background: linear-gradient(135deg, #325d88 0%, #2a4d73 100%) !important;
            color: #ffffff !important;
            border: none !important;
            font-weight: 700 !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
        }

        .ftx-datatable-wrapper .dataTables_paginate .paginate_button:hover:not(.current):not(.disabled) {
            background: rgba(50, 93, 136, 0.1) !important;
            color: #325d88 !important;
            border: none !important;
        }

        .ftx-datatable-wrapper .dataTables_paginate .paginate_button.disabled {
            color: #adb5bd !important;
            cursor: not-allowed !important;
        }

        /* Botões de Ação FrotiX */
        .ftx-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .btn-icon-28 {
            width: var(--ftx-icon-btn);
            height: var(--ftx-icon-btn);
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border: none;
        }

        .btn-icon-28:hover {
            transform: translateY(-2px);
        }

        .btn-icon-28 i {
            font-size: var(--ftx-action-icon);
        }

        .btn-icon-28.btn-azul {
            box-shadow: 0 2px 6px rgba(61, 87, 113, 0.4);
        }

        .btn-icon-28.btn-azul:hover {
            box-shadow: 0 4px 12px rgba(61, 87, 113, 0.6);
        }

        .btn-icon-28.btn-vinho {
            box-shadow: 0 2px 6px rgba(114, 47, 55, 0.4);
        }

        .btn-icon-28.btn-vinho:hover {
            box-shadow: 0 4px 12px rgba(114, 47, 55, 0.6);
        }

        .btn-icon-28.btn-dark {
            background: linear-gradient(135deg, #343a40 0%, #23272b 100%);
            box-shadow: 0 2px 6px rgba(52, 58, 64, 0.4);
        }

        .btn-icon-28.btn-dark:hover {
            box-shadow: 0 4px 12px rgba(52, 58, 64, 0.6);
        }

        .btn-icon-28.fundo-cinza {
            box-shadow: 0 2px 6px rgba(47, 79, 79, 0.4);
        }

        .btn-icon-28.fundo-cinza:hover {
            box-shadow: 0 4px 12px rgba(47, 79, 79, 0.6);
        }

        /* Modal Header Dinheiro (Verde/Ouro) */
        .modal-header-dinheiro {
            background: linear-gradient(135deg, #1e5631 0%, #2d7a4a 50%, #1e5631 100%);
            background-size: 200% 200%;
            animation: ftxHeaderGradientShift 6s ease infinite;
            color: #fff;
            border-bottom: none;
            padding: 1rem 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .modal-header-dinheiro::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.08), transparent);
            animation: ftxHeaderShine 5s ease-in-out infinite;
            pointer-events: none;
        }

        .modal-header-dinheiro .modal-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header-dinheiro .modal-title i {
            font-size: 1.3rem;
            --fa-primary-color: #ffd700;
            --fa-secondary-color: #fff;
            animation: ftxHeaderIconPulse 2s ease-in-out infinite;
        }

        .modal-header-dinheiro .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.85;
        }

        .modal-header-dinheiro .btn-close:hover {
            opacity: 1;
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel ftx-card-styled">
            <div class="panel-container show">
                <!-- ===== HEADER PADRÃO FROTIX ===== -->
                <div class="ftx-card-header">
                    <h2 class="titulo-paginas">
                        <i class="fa-duotone fa-file-invoice-dollar"></i>
                        Gestão de Empenhos
                    </h2>
                    <div class="ftx-card-actions">
                        <a href="/Empenho/Upsert" class="btn btn-fundo-laranja" data-ftx-loading>
                            <i class="fa-duotone fa-clone-plus icon-pulse me-1"></i> Adicionar Empenho
                        </a>
                    </div>
                </div>

                <div class="panel-content">
                    <div class="box-body">
                        <!-- ===== CONTAINER DE FILTROS ===== -->
                        <div class="ftx-filtros-container">
                            <div class="ftx-filtros-title">
                                <i class="fa-duotone fa-filter-list"></i>
                                Escolha um Instrumento para visualizar seus Empenhos
                            </div>

                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="ftx-label">
                                        <i class="fa-duotone fa-file-contract"></i> Instrumento
                                    </label>
                                    <select id="lstInstrumento" class="form-select form-select-sm">
                                        <option value="">-- Selecione --</option>
                                        <option value="0">Contrato</option>
                                        <option value="1">Ata de Registro de Preços</option>
                                    </select>
                                </div>

                                <!-- Filtros de Contrato -->
                                <div id="divContrato" class="col-md-9" style="display:none">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-toggle-on"></i> Status
                                            </label>
                                            <select id="lstStatusContrato" class="form-select form-select-sm">
                                                <option value="1">Ativo</option>
                                                <option value="0">Inativo</option>
                                            </select>
                                        </div>
                                        <div class="col-md-9">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-file-signature"></i> Contratos
                                            </label>
                                            <select id="ListaContratos" name="ListaContratos" class="form-select form-select-sm">
                                                <option value="">-- Selecione um Contrato --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Filtros de Ata -->
                                <div id="divAta" class="col-md-9" style="display:none">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-toggle-on"></i> Status
                                            </label>
                                            <select id="lstStatusAta" class="form-select form-select-sm">
                                                <option value="1">Ativa</option>
                                                <option value="0">Inativa</option>
                                            </select>
                                        </div>
                                        <div class="col-md-9">
                                            <label class="ftx-label">
                                                <i class="fa-duotone fa-clipboard-list-check"></i> Atas de Registro de Preço
                                            </label>
                                            <select id="ListaAtas" name="ListaAtas" class="form-select form-select-sm">
                                                <option value="">-- Selecione uma Ata --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ===== DATATABLE ===== -->
                        <div id="divEmpenho" class="ftx-datatable-wrapper" style="display:none">
                            <table id="tblEmpenho" class="table table-bordered table-striped w-100">
                                <thead>
                                    <tr>
                                        <th>Nota de Empenho</th>
                                        <th>Vigência Inicial</th>
                                        <th>Vigência Final</th>
                                        <th>Saldo Inicial</th>
                                        <th>Total Movimentações</th>
                                        <th>Total Notas Fiscais</th>
                                        <th>Saldo Atual</th>
                                        <th>Ações</th>
                                        <th>Aporte/Anulação</th>
                                        <th>EmpenhoId</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL APORTE ===== -->
<div class="modal fade" id="modalAporte" data-bs-backdrop="static" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg" role="dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-dinheiro">
                <h5 class="modal-title">
                    <i class="fa-duotone fa-hand-holding-dollar"></i>
                    <span id="lblTituloAporte">Aportar Valores ao Empenho</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form id="frmAporte">
                    <input type="hidden" id="txtIdAporte" />
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-calendar-day"></i> Data do Aporte
                            </label>
                            <input id="txtData" class="form-control form-control-sm" type="date" />
                        </div>
                        <div class="col-md-7">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-text"></i> Descrição
                            </label>
                            <input id="txtDescricao" class="form-control form-control-sm" placeholder="Descrição do aporte..." />
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-coins"></i> Valor do Aporte
                            </label>
                            <input id="txtValor" 
                                   class="form-control form-control-sm"
                                   style="text-align: right;"
                                   onkeypress="return moeda(this,'.',',',event)"
                                   placeholder="0,00" />
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button id="btnAportar" class="btn btn-verde" type="button">
                    <i class="fa-duotone fa-check-circle icon-space"></i> Confirmar Aporte
                </button>
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL ANULAÇÃO ===== -->
<div class="modal fade" id="modalAnulacao" data-bs-backdrop="static" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg" role="dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-vinho">
                <h5 class="modal-title">
                    <i class="fa-duotone fa-ban"></i>
                    <span id="lblTituloAnulacao">Anular Valores do Empenho</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <form id="frmAnulacao">
                    <input type="hidden" id="txtIdAnulacao" />
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-calendar-day"></i> Data da Anulação
                            </label>
                            <input id="txtDataanulacao" class="form-control form-control-sm" type="date" />
                        </div>
                        <div class="col-md-7">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-text"></i> Descrição
                            </label>
                            <input id="txtDescricaoanulacao" class="form-control form-control-sm" placeholder="Motivo da anulação..." />
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-coins"></i> Valor da Anulação
                            </label>
                            <input id="txtValoranulacao" 
                                   class="form-control form-control-sm"
                                   style="text-align: right;"
                                   onkeypress="return moeda(this,'.',',',event)"
                                   placeholder="0,00" />
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button id="btnAnular" class="btn btn-vinho" type="button">
                    <i class="fa-duotone fa-ban icon-space"></i> Confirmar Anulação
                </button>
                <button type="button" class="btn btn-azul" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL NOTAS FISCAIS ===== -->
<div class="modal fade" id="modalNF" data-bs-backdrop="static" data-bs-keyboard="true">
    <div class="modal-dialog modal-xl" role="dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h5 class="modal-title">
                    <i class="fa-duotone fa-file-invoice"></i>
                    Notas Fiscais do Empenho
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <div class="ftx-datatable-wrapper">
                    <table id="tblNotaFiscal" class="table table-bordered table-striped w-100">
                        <thead>
                            <tr>
                                <th>Número da Nota</th>
                                <th>Data de Emissão</th>
                                <th>Valor</th>
                                <th>Valor de Glosa</th>
                                <th>Motivo da Glosa</th>
                                <th>Ações</th>
                                <th>ContratoId</th>
                                <th>EmpenhoId</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="~/js/cadastros/empenho.js" asp-append-version="true"></script>

    <script>
        // ===== UTILITÁRIOS =====
        // Converte valor BR para número (ex: "10.000,50" -> 10000.50)
        function parseCurrencyBR(str) {
            try {
                if (!str) return 0;
                let limpo = String(str)
                    .replace(/\s/g, '')
                    .replace('R$', '')
                    .replace(/\./g, '')
                    .replace(',', '.');
                return parseFloat(limpo) || 0;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Index.cshtml", "parseCurrencyBR", error);
                return 0;
            }
        }

        // Função de formatação de moeda (últimos 2 dígitos = centavos)
        // Para R$ 1.000,00 digite 100000
        function moeda(input, sep, dec, event) {
            try {
                let digitado = "",
                    i = j = 0,
                    tamanho = tamanho2 = 0,
                    limpo = ajustado = "",
                    tecla = window.Event ? event.which : event.keyCode;

                if (tecla === 13 || tecla === 8) return true;

                digitado = String.fromCharCode(tecla);

                if ("0123456789".indexOf(digitado) === -1) return false;

                for (tamanho = input.value.length, i = 0;
                     i < tamanho && (input.value.charAt(i) === "0" || input.value.charAt(i) === dec);
                     i++);

                for (limpo = ""; i < tamanho; i++) {
                    if ("0123456789".indexOf(input.value.charAt(i)) !== -1) {
                        limpo += input.value.charAt(i);
                    }
                }

                limpo += digitado;
                tamanho = limpo.length;

                if (tamanho === 0) {
                    input.value = "";
                } else if (tamanho === 1) {
                    input.value = "0" + dec + "0" + limpo;
                } else if (tamanho === 2) {
                    input.value = "0" + dec + limpo;
                } else {
                    for (ajustado = "", j = 0, i = tamanho - 3; i >= 0; i--) {
                        if (j === 3) {
                            ajustado += sep;
                            j = 0;
                        }
                        ajustado += limpo.charAt(i);
                        j++;
                    }

                    input.value = "";
                    tamanho2 = ajustado.length;

                    for (i = tamanho2 - 1; i >= 0; i--) {
                        input.value += ajustado.charAt(i);
                    }

                    input.value += dec + limpo.substr(tamanho - 2, tamanho);
                }

                return false;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Index.cshtml", "moeda", error);
                return false;
            }
        }

        // ===== INSTÂNCIAS DOS MODAIS (Bootstrap 5) =====
        let modalAporteInstance = null;
        let modalAnulacaoInstance = null;
        let modalNFInstance = null;

        // ===== DOCUMENT READY =====
        $(document).ready(function () {
            try {
                // Inicializar instâncias dos modais
                const modalAporteEl = document.getElementById('modalAporte');
                const modalAnulacaoEl = document.getElementById('modalAnulacao');
                const modalNFEl = document.getElementById('modalNF');

                if (modalAporteEl) {
                    modalAporteInstance = new bootstrap.Modal(modalAporteEl);
                }

                if (modalAnulacaoEl) {
                    modalAnulacaoInstance = new bootstrap.Modal(modalAnulacaoEl);
                }

                // Evento delegado para botão de Aporte (criado dinamicamente pelo DataTable)
                $(document).on('click', '.btn-aporte', function (e) {
                    try {
                        e.preventDefault();
                        const empenhoId = $(this).data('id');
                        const row = $(this).closest('tr');
                        const notaEmpenho = row.find('td:first').text();

                        $('#lblTituloAporte').html(`<b>Aportar Valor ao Empenho: ${notaEmpenho}</b>`);
                        $('#txtIdAporte').val(empenhoId);
                        $('#frmAporte')[0].reset();

                        if (modalAporteInstance) {
                            modalAporteInstance.show();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "btn-aporte.click", error);
                    }
                });

                // Evento delegado para botão de Anulação (criado dinamicamente pelo DataTable)
                $(document).on('click', '.btn-anulacao', function (e) {
                    try {
                        e.preventDefault();
                        const empenhoId = $(this).data('id');
                        const row = $(this).closest('tr');
                        const notaEmpenho = row.find('td:first').text();

                        $('#lblTituloAnulacao').html(`<b>Anular Valor do Empenho: ${notaEmpenho}</b>`);
                        $('#txtIdAnulacao').val(empenhoId);
                        $('#frmAnulacao')[0].reset();

                        if (modalAnulacaoInstance) {
                            modalAnulacaoInstance.show();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "btn-anulacao.click", error);
                    }
                });

                if (modalNFEl) {
                    modalNFInstance = new bootstrap.Modal(modalNFEl);
                }

                // Evento delegado para botão de Notas Fiscais (criado dinamicamente pelo DataTable)
                $(document).on('click', '.btn-nf-modal', function (e) {
                    try {
                        e.preventDefault();
                        const empenhoId = $(this).data('id');

                        if ($.fn.DataTable.isDataTable('#tblNotaFiscal')) {
                            $('#tblNotaFiscal').DataTable().destroy();
                        }

                        $('#tblNotaFiscal').DataTable({
                            columnDefs: [
                                { targets: 0, className: "text-center", width: "10%" },
                                { targets: 1, className: "text-center", width: "10%" },
                                { targets: 2, className: "text-end", width: "12%" },
                                { targets: 3, className: "text-end", width: "10%" },
                                { targets: 4, className: "text-start", width: "20%" },
                                { targets: 5, className: "text-center", width: "10%" },
                                { targets: 6, visible: false },
                                { targets: 7, visible: false }
                            ],
                            responsive: true,
                            ajax: {
                                url: "/api/notafiscal/nfempenhos",
                                data: { id: empenhoId },
                                type: "GET",
                                datatype: "json"
                            },
                            columns: [
                                { data: "numeroNF" },
                                { data: "dataFormatada" },
                                { data: "valorNFFormatado" },
                                { data: "valorGlosaFormatado" },
                                { data: "motivoGlosa" },
                                {
                                    data: "notaFiscalId",
                                    render: function (data) {
                                        return `
                                            <div class="ftx-actions">
                                                <a href="/NotaFiscal/Upsert?id=${data}" class="btn btn-icon-28 btn-azul text-white">
                                                    <i class="fa-duotone fa-pen-to-square"></i>
                                                </a>
                                                <a class="btn btn-icon-28 btn-vinho btn-delete-nf text-white" data-id="${data}">
                                                    <i class="fa-duotone fa-trash-can"></i>
                                                </a>
                                            </div>`;
                                    }
                                },
                                { data: "contratoId" },
                                { data: "empenhoId" }
                            ],
                            language: {
                                url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                                emptyTable: "Nenhuma nota fiscal encontrada para este empenho"
                            }
                        });

                        // Abre o modal manualmente
                        if (modalNFInstance) {
                            modalNFInstance.show();
                        }

                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "btn-nf-modal.click", error);
                    }
                });

                // ===== EVENTOS DE FILTRO =====
                $("#lstInstrumento").on('change', function () {
                    try {
                        const val = $(this).val();
                        if (val === '0') {
                            $("#divContrato").show();
                            $("#divAta").hide();
                            $('#ListaContratos').empty().append('<option value="">-- Selecione um Contrato --</option>');
                            loadListaContratos(1);
                        } else if (val === '1') {
                            $("#divAta").show();
                            $("#divContrato").hide();
                            $('#ListaAtas').empty().append('<option value="">-- Selecione uma Ata --</option>');
                            loadListaAtas(1);
                        } else {
                            $("#divAta, #divContrato, #divEmpenho").hide();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "lstInstrumento.change", error);
                    }
                });

                $("#lstStatusContrato").on('change', function () {
                    try {
                        $('#ListaContratos').empty().append('<option value="">-- Selecione um Contrato --</option>');
                        loadListaContratos($(this).val());
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "lstStatusContrato.change", error);
                    }
                });

                $("#lstStatusAta").on('change', function () {
                    try {
                        $('#ListaAtas').empty().append('<option value="">-- Selecione uma Ata --</option>');
                        loadListaAtas($(this).val());
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "lstStatusAta.change", error);
                    }
                });

                $("#ListaContratos").on('change', function () {
                    try {
                        const id = $(this).val();
                        if (!id) {
                            $('#divEmpenho').hide();
                            return;
                        }
                        if ($.fn.DataTable.isDataTable('#tblEmpenho')) {
                            $('#tblEmpenho').DataTable().destroy();
                        }
                        PreencheTabelaEmpenho(id, "contrato");
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "ListaContratos.change", error);
                    }
                });

                $("#ListaAtas").on('change', function () {
                    try {
                        const id = $(this).val();
                        if (!id) {
                            $('#divEmpenho').hide();
                            return;
                        }
                        if ($.fn.DataTable.isDataTable('#tblEmpenho')) {
                            $('#tblEmpenho').DataTable().destroy();
                        }
                        PreencheTabelaEmpenho(id, "ata");
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "ListaAtas.change", error);
                    }
                });

                // ===== FUNÇÕES DE CARGA =====
                function loadListaContratos(status) {
                    try {
                        $.ajax({
                            url: "/api/Contrato/ListaContratos",
                            data: { id: status },
                            type: "GET",
                            dataType: "json",
                            success: function (res) {
                                try {
                                    let option = '<option value="">-- Selecione um Contrato --</option>';
                                    if (res && res.data && res.data.length) {
                                        res.data.forEach(function (obj) {
                                            option += `<option value="${obj.value}">${obj.text}</option>`;
                                        });
                                    }
                                    $('#ListaContratos').empty().append(option);
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("Index.cshtml", "loadListaContratos.success", error);
                                }
                            },
                            error: function (err) {
                                Alerta.TratamentoErroComLinha("Index.cshtml", "loadListaContratos.error", err);
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "loadListaContratos", error);
                    }
                }

                function loadListaAtas(status) {
                    try {
                        $.ajax({
                            url: "/api/AtaRegistroPrecos/ListaAtas",
                            data: { id: status },
                            type: "GET",
                            dataType: "json",
                            success: function (res) {
                                try {
                                    let option = '<option value="">-- Selecione uma Ata --</option>';
                                    if (res && res.data && res.data.length) {
                                        res.data.forEach(function (obj) {
                                            option += `<option value="${obj.value}">${obj.text}</option>`;
                                        });
                                    }
                                    $('#ListaAtas').empty().append(option);
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("Index.cshtml", "loadListaAtas.success", error);
                                }
                            },
                            error: function (err) {
                                Alerta.TratamentoErroComLinha("Index.cshtml", "loadListaAtas.error", err);
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "loadListaAtas", error);
                    }
                }

                function PreencheTabelaEmpenho(id, instrumento) {
                    try {
                        $('#divEmpenho').show();

                        $('#tblEmpenho').DataTable({
                            columnDefs: [
                                { targets: 0, className: "text-center", width: "8%" },
                                { targets: 1, className: "text-center", width: "8%" },
                                { targets: 2, className: "text-center", width: "8%" },
                                { targets: 3, className: "text-end", width: "10%" },
                                { targets: 4, className: "text-end", width: "10%" },
                                { targets: 5, className: "text-end", width: "10%" },
                                { targets: 6, className: "text-end", width: "10%" },
                                { targets: 7, className: "text-center", width: "12%" },
                                { targets: 8, className: "text-center", width: "10%" },
                                { targets: 9, visible: false }
                            ],
                            responsive: true,
                            ajax: {
                                url: "/api/empenho",
                                type: "GET",
                                datatype: "json",
                                data: { id: id, instrumento: instrumento }
                            },
                            columns: [
                                { data: "notaEmpenho" },
                                { data: "vigenciaInicialFormatada" },
                                { data: "vigenciaFinalFormatada" },
                                { data: "saldoInicialFormatado" },
                                { data: "saldoMovimentacaoFormatado" },
                                { data: "saldoNFFormatado" },
                                { data: "saldoFinalFormatado" },
                                {
                                    data: "empenhoId",
                                    render: function (data) {
                                        return `
                                            <div class="ftx-actions">
                                                <a href="/Empenho/Upsert?id=${data}" class="btn btn-icon-28 btn-azul text-white">
                                                    <i class="fa-duotone fa-pen-to-square"></i>
                                                </a>
                                                <a class="btn btn-icon-28 btn-vinho btn-delete text-white" data-id="${data}">
                                                    <i class="fa-duotone fa-trash-can"></i>
                                                </a>
                                                <a class="btn btn-icon-28 fundo-cinza btn-nf-modal text-white" data-ejtip="Notas Fiscais do Empenho" data-id="${data}">
                                                    <i class="fa-duotone fa-file-invoice"></i>
                                                </a>
                                            </div>`;
                                    }
                                },
                                {
                                    data: "empenhoId",
                                    render: function (data) {
                                        return `
                                            <div class="ftx-actions">
                                                <a class="btn btn-icon-28 btn-verde btn-aporte text-white" data-ejtip="Aportar Valor" data-id="${data}">
                                                    <i class="fa-duotone fa-circle-plus"></i>
                                                </a>
                                                <a class="btn btn-icon-28 btn-vinho btn-anulacao text-white" data-id="${data}">
                                                    <i class="fa-duotone fa-circle-minus"></i>
                                                </a>
                                            </div>`;
                                    }
                                },
                                { data: "empenhoId" }
                            ],
                            language: {
                                url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                                emptyTable: "Nenhum empenho encontrado para este instrumento"
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "PreencheTabelaEmpenho", error);
                    }
                }

            } catch (error) {
                Alerta.TratamentoErroComLinha("Index.cshtml", "document.ready", error);
            }
        });

        // ===== EVENTOS DE BOTÕES =====
        $("#btnAportar").on("click", function (e) {
            try {
                e.preventDefault();

                if (!$("#txtData").val()) {
                    Alerta.Erro("Atenção", "A data do Aporte é obrigatória!");
                    return;
                }
                if (!$("#txtDescricao").val()) {
                    Alerta.Erro("Atenção", "A descrição do Aporte é obrigatória!");
                    return;
                }
                
                if (!$("#txtValor").val()) {
                    Alerta.Erro("Atenção", "O valor do Aporte é obrigatório!");
                    return;
                }
                
                const valorAporte = parseCurrencyBR($("#txtValor").val());

                const objEmpenho = JSON.stringify({
                    EmpenhoId: $('#txtIdAporte').val(),
                    Descricao: $('#txtDescricao').val(),
                    Valor: valorAporte,
                    DataMovimentacao: $('#txtData').val(),
                    TipoMovimentacao: "A"
                });

                // Spinning: desabilita botão e troca ícone
                const $btn = $(this);
                const textoOriginal = $btn.html();
                $btn.prop('disabled', true).html('<i class="fa-duotone fa-spinner-third fa-spin icon-space"></i> Processando...');

                $.ajax({
                    type: "post",
                    url: "/api/Empenho/Aporte",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: objEmpenho,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message);
                            $('#tblEmpenho').DataTable().ajax.reload(null, false);
                            modalAporteInstance.hide();
                            $('#frmAporte')[0].reset();
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Index.cshtml", "btnAportar.success", error);
                        }
                    },
                    error: function (data) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "btnAportar.error", data);
                    },
                    complete: function () {
                        // Restaura botão
                        $btn.prop('disabled', false).html(textoOriginal);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Index.cshtml", "btnAportar.click", error);
            }
        });

        $("#btnAnular").on("click", function (e) {
            try {
                e.preventDefault();

                if (!$("#txtDataanulacao").val()) {
                    Alerta.Erro("Atenção", "A data da anulação é obrigatória!");
                    return;
                }
                if (!$("#txtDescricaoanulacao").val()) {
                    Alerta.Erro("Atenção", "A descrição da anulação é obrigatória!");
                    return;
                }
                
                if (!$("#txtValoranulacao").val()) {
                    Alerta.Erro("Atenção", "O valor da anulação é obrigatório!");
                    return;
                }
                
                const valorAnulacao = parseCurrencyBR($("#txtValoranulacao").val());

                const objEmpenho = JSON.stringify({
                    EmpenhoId: $('#txtIdAnulacao').val(),
                    Descricao: $('#txtDescricaoanulacao').val(),
                    Valor: valorAnulacao,
                    DataMovimentacao: $('#txtDataanulacao').val(),
                    TipoMovimentacao: "G"
                });

                // Spinning: desabilita botão e troca ícone
                const $btn = $(this);
                const textoOriginal = $btn.html();
                $btn.prop('disabled', true).html('<i class="fa-duotone fa-spinner-third fa-spin icon-space"></i> Processando...');

                $.ajax({
                    type: "post",
                    url: "/api/Empenho/anulacao",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: objEmpenho,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message);
                            $('#tblEmpenho').DataTable().ajax.reload(null, false);
                            modalAnulacaoInstance.hide();
                            $('#frmAnulacao')[0].reset();
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Index.cshtml", "btnAnular.success", error);
                        }
                    },
                    error: function (data) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "btnAnular.error", data);
                    },
                    complete: function () {
                        // Restaura botão
                        $btn.prop('disabled', false).html(textoOriginal);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Index.cshtml", "btnAnular.click", error);
            }
        });

        // ===== DELETE EMPENHO (delegado) =====
        $(document).on("click", ".btn-delete", function () {
            try {
                var id = $(this).data("id");

                Alerta.Confirmar(
                    "Você tem certeza que deseja apagar este empenho?",
                    "Não será possível recuperar os dados eliminados!",
                    "Excluir",
                    "Cancelar"
                ).then((willDelete) => {
                    try {
                        if (willDelete) {
                            $.ajax({
                                url: "/api/Empenho/Delete",
                                type: "POST",
                                data: JSON.stringify({ EmpenhoId: id }),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    try {
                                        if (data.success) {
                                            AppToast.show('Verde', data.message);
                                            $("#tblEmpenho").DataTable().ajax.reload(null, false);
                                        } else {
                                            AppToast.show('Vermelho', data.message);
                                        }
                                    } catch (error) {
                                        Alerta.TratamentoErroComLinha("Index.cshtml", "btn-delete.success", error);
                                    }
                                },
                                error: function (err) {
                                    Alerta.TratamentoErroComLinha("Index.cshtml", "btn-delete.error", err);
                                }
                            });
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Index.cshtml", "btn-delete.swal.then", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Index.cshtml", "btn-delete.click", error);
            }
        });
    </script>
}
