@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Empenho.UpsertModel

@{
    ViewData["Title"] = "Empenhos";
    ViewData["PageName"] = "empenho_index";
    ViewData["Heading"] = "<i class='fa-duotone fa-money-check-alt'></i> Cadastros: <span class='fw-300'>Empenhos</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-money-check-alt";
}

<style>
    /* ===== CAMPOS MODERNIZADOS (+10% altura) ===== */
    .ftx-form-control {
        height: calc(1.3em + 0.95rem + 2px) !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
        line-height: 1.5;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        transition: all 0.2s ease;
        background-color: #fff;
    }

    .ftx-form-control:focus {
        border-color: #2d5a87;
        box-shadow: 0 0 0 3px rgba(45, 90, 135, 0.15);
        outline: none;
    }

    .ftx-form-control:disabled {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    /* Labels modernizados */
    .ftx-label {
        margin-bottom: 0.35rem;
        margin-top: 0.75rem;
        font-weight: 600;
        font-size: 0.8rem;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .ftx-label i {
        color: #6b7280;
        font-size: 0.85rem;
    }

    /* ===== BOTÕES MODERNIZADOS ===== */
    .ftx-btn {
        height: calc(1.3em + 0.95rem + 2px);
        padding: 0.5rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .ftx-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .ftx-btn-azul {
        background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%);
        color: #fff !important;
    }

    .ftx-btn-vinho {
        background: linear-gradient(135deg, #722f37 0%, #5a252c 100%);
        color: #fff !important;
    }

    .ftx-btn-verde {
        background: linear-gradient(135deg, #2d4a2d 0%, #1e351e 100%);
        color: #fff !important;
    }

    .ftx-btn i {
        font-size: 0.9rem;
    }

    /* Botão Ver Notas */
    .ftx-btn-notas {
        height: calc(1.3em + 0.95rem + 2px);
        padding: 0.5rem 1rem;
    }

    input[type=checkbox] {
        vertical-align: middle;
        position: relative;
        bottom: 1px;
    }
</style>

@section HeadBlock {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css" />

    <style>
        /* ===== ESPAÇAMENTO ENTRE BOTÕES E DATATABLES ===== */
        .ftx-listas-container {
            margin-top: 35px !important;
            padding-top: 0;
        }

        /* ===== CONTAINER APORTES (Verde Militar) ===== */
        .ftx-aporte-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1rem;
        }

        .ftx-aporte-header {
            background: linear-gradient(135deg, #2d4a2d 0%, #3d5c3d 100%);
            color: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ftx-aporte-header h3 {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* TEXTO AMARELO NO HEADER DE APORTES */
        .ftx-aporte-header h3 span {
            color: #ffd700 !important;
        }

        .ftx-aporte-header .ftx-valor-total {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        /* Header do DataTable de Aportes - Verde Claro */
        .ftx-aporte-container table thead,
        .ftx-aporte-container table.dataTable thead,
        .ftx-aporte-container .dataTable thead,
        #tblAporte thead {
            background: linear-gradient(135deg, #4a7c4a 0%, #5d8f5d 100%) !important;
        }

        .ftx-aporte-container table thead th,
        .ftx-aporte-container table.dataTable thead th,
        #tblAporte thead th {
            color: #fff !important;
            font-weight: 600 !important;
            font-size: 0.8rem !important;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none !important;
            padding: 0.75rem !important;
            background: transparent !important;
        }

        .ftx-aporte-container table.dataTable tbody tr:hover {
            background-color: rgba(74, 124, 74, 0.08) !important;
        }

        /* ===== CONTAINER ANULAÇÕES (Vinho) ===== */
        .ftx-anulacao-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1rem;
        }

        .ftx-anulacao-header {
            background: linear-gradient(135deg, #722f37 0%, #8b3a44 100%);
            color: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ftx-anulacao-header h3 {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ftx-anulacao-header h3 span {
            color: #ffd700 !important;
        }

        .ftx-anulacao-header .ftx-valor-total {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        /* Header do DataTable de Anulações - Vinho Claro */
        .ftx-anulacao-container table thead,
        .ftx-anulacao-container table.dataTable thead,
        .ftx-anulacao-container .dataTable thead,
        #tblanulacao thead {
            background: linear-gradient(135deg, #a04a55 0%, #b35a66 100%) !important;
        }

        .ftx-anulacao-container table thead th,
        .ftx-anulacao-container table.dataTable thead th,
        #tblanulacao thead th {
            color: #fff !important;
            font-weight: 600 !important;
            font-size: 0.8rem !important;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none !important;
            padding: 0.75rem !important;
            background: transparent !important;
        }

        .ftx-anulacao-container table.dataTable tbody tr:hover {
            background-color: rgba(114, 47, 55, 0.08) !important;
        }

        /* ===== REMOVER BARRA DE ROLAGEM HORIZONTAL ===== */
        .ftx-aporte-container .dataTables_wrapper,
        .ftx-anulacao-container .dataTables_wrapper {
            overflow-x: hidden !important;
        }

        .ftx-aporte-container table.dataTable,
        .ftx-anulacao-container table.dataTable {
            width: 100% !important;
            table-layout: fixed;
        }

        /* ===== BOTÕES DE AÇÃO NAS TABELAS ===== */
        .ftx-aporte-container .btn-icon-sm,
        .ftx-anulacao-container .btn-icon-sm {
            width: 28px;
            height: 28px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin: 0 2px;
        }

        /* ===== ESCONDER PAGINAÇÃO E INFO SE POUCOS REGISTROS ===== */
        .ftx-aporte-container .dataTables_info,
        .ftx-anulacao-container .dataTables_info,
        .ftx-aporte-container .dataTables_paginate,
        .ftx-anulacao-container .dataTables_paginate {
            display: none;
        }

        /* ===== MODAL NOTAS FISCAIS ===== */
        .ftx-modal-nf .modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: #fff;
            border-radius: 0;
        }

        .ftx-modal-nf .modal-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
        }

        .ftx-modal-nf .btn-close {
            filter: brightness(0) invert(1);
        }

        .ftx-modal-nf table thead {
            background: linear-gradient(135deg, #4a6fa5 0%, #5d82b8 100%) !important;
        }

        .ftx-modal-nf table thead th {
            color: #fff !important;
            font-weight: 600 !important;
            font-size: 0.8rem !important;
            text-transform: uppercase;
            border: none !important;
        }

        /* ===== MODAL HEADER DINHEIRO (Verde/Ouro) ===== */
        .modal-header-dinheiro {
            background: linear-gradient(135deg, #1e5631 0%, #2d7a4a 50%, #1e5631 100%);
            background-size: 200% 200%;
            animation: ftxHeaderGradientShift 6s ease infinite;
            color: #fff;
            border-bottom: none;
            padding: 1rem 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .modal-header-dinheiro::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.08), transparent);
            animation: ftxHeaderShine 5s ease-in-out infinite;
            pointer-events: none;
        }

        @@keyframes ftxHeaderGradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @@keyframes ftxHeaderShine {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .modal-header-dinheiro .modal-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header-dinheiro .modal-title i {
            font-size: 1.3rem;
            --fa-primary-color: #ffd700;
            --fa-secondary-color: #fff;
        }

        .modal-header-dinheiro .btn-close-white {
            filter: brightness(0) invert(1);
            opacity: 0.85;
        }

        .modal-header-dinheiro .btn-close-white:hover {
            opacity: 1;
        }

        /* ===== MODAL HEADER VINHO ===== */
        .modal-header-vinho {
            background: linear-gradient(135deg, #722f37 0%, #8b3a44 50%, #722f37 100%);
            background-size: 200% 200%;
            animation: ftxHeaderGradientShift 6s ease infinite;
            color: #fff;
            border-bottom: none;
            padding: 1rem 1.25rem;
            position: relative;
            overflow: hidden;
        }

        .modal-header-vinho::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.06), transparent);
            animation: ftxHeaderShine 5s ease-in-out infinite;
            pointer-events: none;
        }

        .modal-header-vinho .modal-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header-vinho .modal-title i {
            font-size: 1.3rem;
            --fa-primary-color: #ffd700;
            --fa-secondary-color: #fff;
        }

        .modal-header-vinho .btn-close-white {
            filter: brightness(0) invert(1);
            opacity: 0.85;
        }

        .modal-header-vinho .btn-close-white:hover {
            opacity: 1;
        }
    </style>
}

<form method="post" asp-action="Upsert">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel">
                <div class="panel-container show">
                    <div class="panel-content">

                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        @if (Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty)
                        {
                            <input id="hdnEmpenhoId" type="hidden" asp-for="EmpenhoObj.Empenho.EmpenhoId" />
                        }

                        <!-- HEADER PADRÃO FROTIX -->
                        <div class="ftx-card-header">
                            <h2 class="titulo-paginas">
                                <i class="fa-duotone fa-money-check-dollar-pen"></i>
                                @(Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty ? "Atualizar Empenho" : "Criar Novo Empenho")
                            </h2>
                            @if (Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty && !string.IsNullOrEmpty(Model.EmpenhoObj.Empenho.NotaEmpenho))
                            {
                                <div class="ftx-card-actions">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.95rem; color: #ffd700;">
                                        <i class="fa-duotone fa-hashtag me-1 icon-pulse me-1"></i>@Model.EmpenhoObj.Empenho.NotaEmpenho
                                    </span>
                                </div>
                            }
                        </div>

                        <div class="col-12 pt-2">
                            <div class="row">
                                <div class="col-md-4 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.NotaEmpenho">
                                            <i class="fa-duotone fa-file-invoice"></i> Nota de Empenho
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.NotaEmpenho"></span>
                                        <input id="txtNotaEmpenho"
                                               class="form-control ftx-form-control"
                                               asp-for="EmpenhoObj.Empenho.NotaEmpenho"
                                               placeholder="Ex: 2024NE00123" />
                                    </div>
                                </div>
                                <div class="col-md-2 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.DataEmissao">
                                            <i class="fa-duotone fa-calendar-day"></i> Data de Emissão
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.DataEmissao"></span>
                                        <input id="txtDataEmissao"
                                               class="form-control ftx-form-control"
                                               asp-for="EmpenhoObj.Empenho.DataEmissao"
                                               type="date" />
                                    </div>
                                </div>
                                <div class="col-md-2 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.VigenciaInicial">
                                            <i class="fa-duotone fa-calendar-arrow-down"></i> Vigência Inicial
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.VigenciaInicial"></span>
                                        <input id="txtVigenciaInicial"
                                               class="form-control ftx-form-control"
                                               asp-for="EmpenhoObj.Empenho.VigenciaInicial"
                                               type="date" />
                                    </div>
                                </div>
                                <div class="col-md-2 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.VigenciaFinal">
                                            <i class="fa-duotone fa-calendar-arrow-up"></i> Vigência Final
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.VigenciaFinal"></span>
                                        <input id="txtVigenciaFinal"
                                               class="form-control ftx-form-control"
                                               asp-for="EmpenhoObj.Empenho.VigenciaFinal"
                                               type="date" />
                                    </div>
                                </div>
                                <div class="col-md-2 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.AnoVigencia">
                                            <i class="fa-duotone fa-calendar-check"></i> Ano de Vigência
                                        </label>
                                        <span class="text-danger font-weight-light" asp-validation-for="EmpenhoObj.Empenho.AnoVigencia"></span>
                                        <select id="lstVigencia"
                                                class="form-control ftx-form-control"
                                                asp-for="EmpenhoObj.Empenho.AnoVigencia">
                                            <option value="">-- Ano --</option>
                                            <option value="2026">2026</option>
                                            <option value="2025">2025</option>
                                            <option value="2024">2024</option>
                                            <option value="2023">2023</option>
                                            <option value="2022">2022</option>
                                            <option value="2021">2021</option>
                                            <option value="2020">2020</option>
                                            <option value="2019">2019</option>
                                            <option value="2018">2018</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-2 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label">
                                            <i class="fa-duotone fa-file-contract"></i> Contrato/Ata
                                        </label>
                                        <select id="lstInstrumento" class="form-control ftx-form-control">
                                            <option value="">-- Selecione --</option>
                                            <option value="0">Contrato</option>
                                            <option value="1">Ata de Registro de Preços</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="divContrato" class="col-md-6 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.ContratoId">
                                            <i class="fa-duotone fa-file-signature"></i> Contrato
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.ContratoId"></span>
                                        @Html.DropDownListFor(m => m.EmpenhoObj.Empenho.ContratoId,
                                            Model.EmpenhoObj.ContratoList,
                                            "- Selecione um Contrato -",
                                            new { @class = "form-control ftx-form-control" })
                                    </div>
                                </div>

                                <div id="divAta" class="col-md-6 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.AtaId">
                                            <i class="fa-duotone fa-clipboard-list"></i> Ata de Registro de Preços
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.AtaId"></span>
                                        @Html.DropDownListFor(m => m.EmpenhoObj.Empenho.AtaId,
                                            Model.EmpenhoObj.AtaList,
                                            "- Selecione uma Ata -",
                                            new { @class = "form-control ftx-form-control" })
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.SaldoInicial">
                                            <i class="fa-duotone fa-coins"></i> Saldo Inicial (R$)
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.SaldoInicial"></span>
                                        <input id="SaldoInicial"
                                               class="form-control ftx-form-control"
                                               data-inputmask="'alias': 'currency'"
                                               style="text-align: right;"
                                               asp-for="EmpenhoObj.Empenho.SaldoInicial"
                                               onKeyPress="return(moeda(this,'.',',',event))"
                                               placeholder="0,00" />
                                    </div>
                                </div>
                                <div class="col-md-3 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label" asp-for="EmpenhoObj.Empenho.SaldoFinal">
                                            <i class="fa-duotone fa-sack-dollar"></i> Saldo Final (R$)
                                        </label>
                                        <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.SaldoFinal"></span>
                                        <input id="SaldoFinal"
                                               class="form-control ftx-form-control"
                                               disabled
                                               data-inputmask="'alias': 'currency'"
                                               style="text-align: right; background-color: #e8f5e9;"
                                               asp-for="EmpenhoObj.Empenho.SaldoFinal"
                                               onKeyPress="return(moeda(this,'.',',',event))"
                                               placeholder="0,00" />
                                    </div>
                                </div>
                                <div class="col-md-3 col-12">
                                    <div class="form-group">
                                        <label class="ftx-label">
                                            <i class="fa-duotone fa-file-invoice-dollar"></i> Total Notas Fiscais
                                        </label>
                                        <input id="SaldoNotas"
                                               class="form-control ftx-form-control"
                                               data-inputmask="'alias': 'currency'"
                                               style="text-align: right; background-color: #fff3e0;"
                                               disabled
                                               placeholder="0,00" />
                                    </div>
                                </div>
                                <div class="col-md-3 col-12 d-flex align-items-end">
                                    @if (Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty)
                                    {
                                        <button type="button"
                                                id="btnVerNotas"
                                                class="ftx-btn ftx-btn-azul ftx-btn-notas w-100">
                                            <i class="fa-duotone fa-file-invoice-dollar"></i> Ver Notas Fiscais
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button"
                                                id="btnVerNotas"
                                                class="ftx-btn ftx-btn-notas w-100"
                                                style="background: #9ca3af; cursor: not-allowed;"
                                                disabled>
                                            <i class="fa-duotone fa-file-invoice-dollar"></i> Ver Notas Fiscais
                                        </button>
                                    }
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="row">
                                        <div id="divSubmit" class="col-12 col-md-4 pb-2">
                                            @if (Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty)
                                            {
                                                <button id="btnSubmit"
                                                        method="post"
                                                        asp-page-handler="Edit"
                                                        asp-route-id=@Model.EmpenhoObj.Empenho.EmpenhoId
                                                        class="btn btn-azul btn-submit-spin w-100">
                                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Atualizar Empenho
                                                </button>
                                            }
                                            else
                                            {
                                                <button id="btnSubmit"
                                                        type="submit"
                                                        value="Submit"
                                                        asp-page-handler="Submit"
                                                        class="btn btn-azul btn-submit-spin w-100">
                                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Criar Empenho
                                                </button>
                                            }
                                        </div>

                                        <div class="col-12" hidden>
                                            @if (Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty)
                                            {
                                                <button id="btnEscondido"
                                                        method="post"
                                                        asp-page-handler="Edit"
                                                        asp-route-id=@Model.EmpenhoObj.Empenho.EmpenhoId
                                                        class="btn btn-azul form-control">
                                                    Atualizar
                                                </button>
                                            }
                                            else
                                            {
                                                <button id="btnEscondido"
                                                        type="submit"
                                                        value="Submit"
                                                        asp-page-handler="Submit"
                                                        class="btn btn-azul form-control">
                                                    Criar
                                                </button>
                                            }
                                        </div>

                                        <div class="col-12 col-md-4">
                                            <a asp-page="./Index" class="btn btn-ftx-fechar w-100" data-ftx-loading>
                                                <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Operação
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty)
                        {
                            <div class="row ftx-listas-container" style="margin-top: 35px;">
                                <div class="col-md-6 col-12">
                                    <div class="ftx-aporte-container">
                                        <div class="ftx-aporte-header">
                                            <h3>
                                                <i class="fa-duotone fa-circle-plus"></i>
                                                <span id="lblTituloAportes">Aportes / Reforços</span>
                                            </h3>
                                            <span id="lblTotalAportes" class="ftx-valor-total">R$ 0,00</span>
                                        </div>
                                        <div class="p-0">
                                            <table id="tblAporte" class="table table-bordered table-striped w-100 mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Descrição</th>
                                                        <th>Valor</th>
                                                        <th>Ações</th>
                                                        <th>Id</th>
                                                        <th>ValorOrig</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <!-- Botão Adicionar Aporte -->
                                        <div class="p-3 text-center" style="background: rgba(45, 74, 45, 0.05); border-top: 1px solid rgba(45, 74, 45, 0.1);">
                                            <button type="button" id="btnAdicionarAporte" class="btn btn-verde">
                                                <i class="fa-duotone fa-circle-plus icon-space icon-pulse"></i> Adicionar Aporte
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-12">
                                    <div class="ftx-anulacao-container">
                                        <div class="ftx-anulacao-header">
                                            <h3>
                                                <i class="fa-duotone fa-circle-minus"></i>
                                                <span id="lblTituloAnulacoes">Anulações</span>
                                            </h3>
                                            <span id="lblTotalAnulacoes" class="ftx-valor-total">R$ 0,00</span>
                                        </div>
                                        <div class="p-0">
                                            <table id="tblanulacao" class="table table-bordered table-striped w-100 mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Descrição</th>
                                                        <th>Valor</th>
                                                        <th>Ações</th>
                                                        <th>Id</th>
                                                        <th>ValorOrig</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <!-- Botão Adicionar Anulação -->
                                        <div class="p-3 text-center" style="background: rgba(114, 47, 55, 0.05); border-top: 1px solid rgba(114, 47, 55, 0.1);">
                                            <button type="button" id="btnAdicionarAnulacao" class="btn btn-vinho">
                                                <i class="fa-duotone fa-circle-minus icon-space icon-pulse"></i> Adicionar Anulação
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal Aporte (Bootstrap 5) -->
<div class="modal fade" id="modalAporte" tabindex="-1" aria-labelledby="ModalLabelAporte" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #2d4a2d 0%, #3d5c3d 100%); color: #fff;">
                <h5 class="modal-title" id="ModalLabelAporte">
                    <i class="fa-duotone fa-circle-plus me-2"></i>Editar Aporte do Empenho
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="frmAporte">
                    <input type="hidden" id="hdnEmpenhoIdAporte" />
                    <input type="hidden" id="hdnMovimentacaoIdAporte" />
                    <div class="row">
                        <div class="col-md-5 col-12">
                            <div class="form-group">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-calendar-day"></i> Data do Aporte
                                </label>
                                <input id="txtDataAporte" class="form-control ftx-form-control" type="date" />
                            </div>
                        </div>
                        <div class="col-md-7 col-12">
                            <div class="form-group">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-text"></i> Descrição
                                </label>
                                <input id="txtDescricaoAporte" class="form-control ftx-form-control" placeholder="Descrição do aporte" />
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4 col-12">
                            <div class="form-group">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-coins"></i> Valor do Aporte
                                </label>
                                <input id="txtValorAporte"
                                       class="form-control ftx-form-control"
                                       data-inputmask="'alias': 'currency'"
                                       style="text-align: right;"
                                       onKeyPress="return(moeda(this,'.',',',event))"
                                       placeholder="0,00" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnAportar" class="ftx-btn ftx-btn-verde" type="button">
                    <i class="fa-duotone fa-check icon-pulse"></i> Salvar Aporte
                </button>
                <button type="button" class="ftx-btn ftx-btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Anulação (Bootstrap 5) -->
<div class="modal fade" id="modalanulacao" tabindex="-1" aria-labelledby="ModalLabelAnulacao" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #722f37 0%, #8b3a44 100%); color: #fff;">
                <h5 class="modal-title" id="ModalLabelAnulacao">
                    <i class="fa-duotone fa-circle-minus me-2"></i>Editar Anulação do Empenho
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="frmanulacao">
                    <input type="hidden" id="hdnEmpenhoIdAnulacao" />
                    <input type="hidden" id="hdnMovimentacaoIdAnulacao" />
                    <div class="row">
                        <div class="col-md-5 col-12">
                            <div class="form-group">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-calendar-day"></i> Data da Anulação
                                </label>
                                <input id="txtDataanulacao" class="form-control ftx-form-control" type="date" />
                            </div>
                        </div>
                        <div class="col-md-7 col-12">
                            <div class="form-group">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-text"></i> Descrição
                                </label>
                                <input id="txtDescricaoanulacao" class="form-control ftx-form-control" placeholder="Descrição da anulação" />
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4 col-12">
                            <div class="form-group">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-coins"></i> Valor da Anulação
                                </label>
                                <input id="txtValoranulacao"
                                       class="form-control ftx-form-control"
                                       data-inputmask="'alias': 'currency'"
                                       style="text-align: right;"
                                       onKeyPress="return(moeda(this,'.',',',event))"
                                       placeholder="0,00" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnAnular" class="ftx-btn ftx-btn-verde" type="button">
                    <i class="fa-duotone fa-check icon-pulse"></i> Salvar Anulação
                </button>
                <button type="button" class="ftx-btn ftx-btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Notas Fiscais (Bootstrap 5 - CORRIGIDO) -->
<div class="modal fade ftx-modal-nf" id="modalNF" tabindex="-1" aria-labelledby="ModalLabelNF" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabelNF">
                    <i class="fa-duotone fa-file-invoice-dollar me-2"></i>Notas Fiscais do Empenho
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <table id="tblNotaFiscal" class="table table-bordered table-striped" width="100%">
                    <thead>
                        <tr>
                            <th>Número da Nota</th>
                            <th>Data de Emissão</th>
                            <th>Valor</th>
                            <th>Valor de Glosa</th>
                            <th>Motivo da Glosa</th>
                            <th>Ação</th>
                            <th>ContratoId</th>
                            <th>EmpenhoId</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="ftx-btn ftx-btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-pulse"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Aporte (Bootstrap 5) -->
<div class="modal fade" id="modalAdicionarAporte" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria-labelledby="ModalLabelAdicionarAporte" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-dinheiro">
                <h5 class="modal-title" id="ModalLabelAdicionarAporte">
                    <i class="fa-duotone fa-hand-holding-dollar me-2"></i>
                    <span>Aportar Valores ao Empenho</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="frmAdicionarAporte">
                    <input type="hidden" id="hdnEmpenhoIdAdicionarAporte" />
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-calendar-day"></i> Data do Aporte
                            </label>
                            <input id="txtDataAdicionarAporte" class="form-control ftx-form-control" type="date" />
                        </div>
                        <div class="col-md-7">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-text"></i> Descrição
                            </label>
                            <input id="txtDescricaoAdicionarAporte" class="form-control ftx-form-control" placeholder="Descrição do aporte..." />
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-coins"></i> Valor do Aporte
                            </label>
                            <input id="txtValorAdicionarAporte"
                                   class="form-control ftx-form-control"
                                   style="text-align: right;"
                                   onkeypress="return moeda(this,'.',',',event)"
                                   placeholder="0,00" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnConfirmarAporte" class="btn btn-verde" type="button">
                    <i class="fa-duotone fa-check-circle icon-space"></i> Confirmar Aporte
                </button>
                <button type="button" class="btn btn-vinho" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Anulação (Bootstrap 5) -->
<div class="modal fade" id="modalAdicionarAnulacao" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria-labelledby="ModalLabelAdicionarAnulacao" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-vinho">
                <h5 class="modal-title" id="ModalLabelAdicionarAnulacao">
                    <i class="fa-duotone fa-ban me-2"></i>
                    <span>Anular Valores do Empenho</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="frmAdicionarAnulacao">
                    <input type="hidden" id="hdnEmpenhoIdAdicionarAnulacao" />
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-calendar-day"></i> Data da Anulação
                            </label>
                            <input id="txtDataAdicionarAnulacao" class="form-control ftx-form-control" type="date" />
                        </div>
                        <div class="col-md-7">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-text"></i> Descrição
                            </label>
                            <input id="txtDescricaoAdicionarAnulacao" class="form-control ftx-form-control" placeholder="Motivo da anulação..." />
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-coins"></i> Valor da Anulação
                            </label>
                            <input id="txtValorAdicionarAnulacao"
                                   class="form-control ftx-form-control"
                                   style="text-align: right;"
                                   onkeypress="return moeda(this,'.',',',event)"
                                   placeholder="0,00" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnConfirmarAnulacao" class="btn btn-vinho" type="button">
                    <i class="fa-duotone fa-ban icon-space"></i> Confirmar Anulação
                </button>
                <button type="button" class="btn btn-azul" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {

    <script src="~/js/cadastros/aporte_001.js" asp-append-version="true"></script>
    <script src="~/js/cadastros/anulacao_001.js" asp-append-version="true"></script>

    <script>
        function parseCurrencyBR(str) {
            try {
                if (!str) return 0;
                return parseFloat(
                    String(str)
                        .replace(/\s/g, '')
                        .replace('R$', '')
                        .replace(/\./g, '')
                        .replace(',', '.')
                ) || 0;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "parseCurrencyBR", error);
                return 0;
            }
        }

        function formatNumberBR(value) {
            try {
                const num = typeof value === 'number' ? value : parseFloat(value);
                if (isNaN(num)) return '0,00';

                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "formatNumberBR", error);
                return '0,00';
            }
        }

        function moeda(input, sep, dec, event) {
            try {
                let digitado = "",
                    i = j = 0,
                    tamanho = tamanho2 = 0,
                    limpo = ajustado = "",
                    tecla = window.Event ? event.which : event.keyCode;

                if (tecla === 13 || tecla === 8) return true;

                digitado = String.fromCharCode(tecla);

                if ("0123456789".indexOf(digitado) === -1) return false;

                for (tamanho = input.value.length, i = 0;
                     i < tamanho && (input.value.charAt(i) === "0" || input.value.charAt(i) === dec);
                     i++);

                for (limpo = ""; i < tamanho; i++) {
                    if ("0123456789".indexOf(input.value.charAt(i)) !== -1) {
                        limpo += input.value.charAt(i);
                    }
                }

                limpo += digitado;
                tamanho = limpo.length;

                if (tamanho === 0) {
                    input.value = "";
                } else if (tamanho === 1) {
                    input.value = "0" + dec + "0" + limpo;
                } else if (tamanho === 2) {
                    input.value = "0" + dec + limpo;
                } else {
                    for (ajustado = "", j = 0, i = tamanho - 3; i >= 0; i--) {
                        if (j === 3) {
                            ajustado += sep;
                            j = 0;
                        }
                        ajustado += limpo.charAt(i);
                        j++;
                    }

                    input.value = "";
                    tamanho2 = ajustado.length;

                    for (i = tamanho2 - 1; i >= 0; i--) {
                        input.value += ajustado.charAt(i);
                    }

                    input.value += dec + limpo.substr(tamanho - 2, tamanho);
                }

                return false;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "moeda", error);
                return false;
            }
        }

        function convertDateToISO(dateStr) {
            try {
                if (!dateStr) return '';

                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                return dateStr;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "convertDateToISO", error);
                return '';
            }
        }

        $(document).ready(function () {
            try {
                $("#divContrato, #divAta").hide();

                const empenhoId = '@Model.EmpenhoObj.Empenho.EmpenhoId';
                const isEditing = empenhoId && empenhoId !== '00000000-0000-0000-0000-000000000000';

                if (isEditing) {
                    $("#SaldoInicial").prop("disabled", true);

                    const contratoId = '@Model.EmpenhoObj.Empenho.ContratoId';
                    const ataId = '@Model.EmpenhoObj.Empenho.AtaId';

                    if (contratoId) {
                        $("#divContrato").show();
                        $("#lstInstrumento").val('0');
                    }

                    if (ataId) {
                        $("#divAta").show();
                        $("#lstInstrumento").val('1');
                    }
                }

                $.ajax({
                    type: "GET",
                    url: "/api/Empenho/SaldoNotas",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: { Id: empenhoId },
                    success: function (data) {
                        try {
                            if (data && typeof data.saldonotas !== 'undefined') {
                                $('#SaldoNotas').val(formatNumberBR(parseCurrencyBR(data.saldonotas)));
                            }

                            const saldoInicial = parseCurrencyBR($('#SaldoInicial').val());
                            $('#SaldoInicial').val(formatNumberBR(saldoInicial));

                            const saldoFinal = parseCurrencyBR($('#SaldoFinal').val());
                            $('#SaldoFinal').val(formatNumberBR(saldoFinal));
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "loadSaldos.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "loadSaldos.error", error);
                    }
                });

                $("#SaldoInicial").on("focusout", function () {
                    try {
                        if (!isEditing) {
                            $("#SaldoFinal").val(this.value);
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "SaldoInicial.focusout", error);
                    }
                });

                $("#lstInstrumento").on('change', function () {
                    try {
                        $('#EmpenhoObj_Empenho_AtaId').val('');
                        $('#EmpenhoObj_Empenho_ContratoId').val('');

                        const valor = $(this).val();

                        if (valor === '0') {
                            $("#divContrato").show();
                            $("#divAta").hide();
                        } else if (valor === '1') {
                            $("#divAta").show();
                            $("#divContrato").hide();
                        } else {
                            $("#divContrato, #divAta").hide();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "lstInstrumento.change", error);
                    }
                });

                // ===== MODAL APORTE (Bootstrap 5) =====
                const modalAporteEl = document.getElementById('modalAporte');
                const modalAporte = new bootstrap.Modal(modalAporteEl);

                $(document).on('click', '.btn-edit-aporte', function (e) {
                    try {
                        e.preventDefault();
                        const $btn = $(this);
                        const $row = $btn.closest("tr");
                        const movimentacaoId = $btn.data("id");

                        const dataAporte = $row.find("td:eq(0)").text();
                        const descricao = $row.find("td:eq(1)").text();
                        const valor = $row.find("td:eq(2)").text();

                        $("#txtDataAporte").val(convertDateToISO(dataAporte));
                        $("#txtDescricaoAporte").val(descricao);
                        $("#txtValorAporte").val(valor);

                        const notaEmpenho = $("#txtNotaEmpenho").val() || '';
                        $("#ModalLabelAporte").html(`<i class="fa-duotone fa-circle-plus me-2"></i>Editar Aporte: <b>${notaEmpenho}</b>`);

                        $('#hdnMovimentacaoIdAporte').val(movimentacaoId);
                        $('#hdnEmpenhoIdAporte').val(empenhoId);
                        $('#btnAportar').attr('data-id', movimentacaoId);

                        modalAporte.show();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btn-edit-aporte.click", error);
                    }
                });

                modalAporteEl.addEventListener('hidden.bs.modal', function () {
                    try {
                        $("#frmAporte")[0].reset();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAporte.hidden", error);
                    }
                });

                // ===== MODAL ANULAÇÃO (Bootstrap 5) =====
                const modalAnulacaoEl = document.getElementById('modalanulacao');
                const modalAnulacao = new bootstrap.Modal(modalAnulacaoEl);

                $(document).on('click', '.btn-edit-anulacao', function (e) {
                    try {
                        e.preventDefault();
                        const $btn = $(this);
                        const $row = $btn.closest("tr");
                        const movimentacaoId = $btn.data("id");

                        const dataAnulacao = $row.find("td:eq(0)").text();
                        const descricao = $row.find("td:eq(1)").text();
                        const valor = $row.find("td:eq(2)").text();

                        $("#txtDataanulacao").val(convertDateToISO(dataAnulacao));
                        $("#txtDescricaoanulacao").val(descricao);
                        $("#txtValoranulacao").val(valor);

                        const notaEmpenho = $("#txtNotaEmpenho").val() || '';
                        $("#ModalLabelAnulacao").html(`<i class="fa-duotone fa-circle-minus me-2"></i>Editar Anulação: <b>${notaEmpenho}</b>`);

                        $('#hdnMovimentacaoIdAnulacao').val(movimentacaoId);
                        $('#hdnEmpenhoIdAnulacao').val(empenhoId);
                        $('#btnAnular').attr('data-id', movimentacaoId);

                        modalAnulacao.show();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btn-edit-anulacao.click", error);
                    }
                });

                modalAnulacaoEl.addEventListener('hidden.bs.modal', function () {
                    try {
                        $("#frmanulacao")[0].reset();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAnulacao.hidden", error);
                    }
                });

                // ===== MODAL NOTAS FISCAIS (Bootstrap 5 - CORRIGIDO) =====
                const modalNFEl = document.getElementById('modalNF');
                let dataTableNF = null;

                $("#btnVerNotas").on('click', function () {
                    try {
                        const modalNF = new bootstrap.Modal(modalNFEl);
                        modalNF.show();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnVerNotas.click", error);
                    }
                });

                modalNFEl.addEventListener('show.bs.modal', function () {
                    try {
                        if (!$('#tblNotaFiscal').length) return;

                        if (dataTableNF) {
                            dataTableNF.destroy();
                        }

                        dataTableNF = $('#tblNotaFiscal').DataTable({
                            columnDefs: [
                                { targets: 0, className: "text-center", width: "12%" },
                                { targets: 1, className: "text-center", width: "12%" },
                                { targets: 2, className: "text-end",    width: "12%" },
                                { targets: 3, className: "text-end",    width: "10%" },
                                { targets: 4, className: "text-start",  width: "20%" },
                                { targets: 5, className: "text-center", width: "10%" },
                                { targets: 6, className: "text-center", visible: false },
                                { targets: 7, className: "text-center", visible: false }
                            ],
                            responsive: true,
                            ajax: {
                                url: "/api/notafiscal/nfempenhos",
                                data: { id: empenhoId },
                                type: "GET",
                                datatype: "json"
                            },
                            columns: [
                                { data: "numeroNF" },
                                { data: "dataFormatada" },
                                { data: "valorNFFormatado" },
                                { data: "valorGlosaFormatado" },
                                { data: "motivoGlosa" },
                                {
                                    data: "notaFiscalId",
                                    render: function (data) {
                                        return `
                                            <div class="text-center">
                                                <a href="/NotaFiscal/Upsert?id=${data}"
                                                   class="btn btn-sm btn-azul text-white">
                                                    <i class="fa-duotone fa-pen-to-square"></i>
                                                </a>
                                                <a class="btn btn-sm btn-delete btn-vinho text-white"
                                                   data-id='${data}'>
                                                    <i class="fa-duotone fa-trash-can"></i>
                                                </a>
                                            </div>
                                        `;
                                    }
                                },
                                { data: "contratoId" },
                                { data: "empenhoId" }
                            ],
                            language: {
                                url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                                emptyTable: "Nenhuma Nota Fiscal encontrada"
                            },
                            width: "100%"
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalNF.show", error);
                    }
                });

                // ===== MODAL ADICIONAR APORTE (Bootstrap 5) =====
                const modalAdicionarAporteEl = document.getElementById('modalAdicionarAporte');
                let modalAdicionarAporteInstance = null;
                
                if (modalAdicionarAporteEl) {
                    modalAdicionarAporteInstance = new bootstrap.Modal(modalAdicionarAporteEl);
                }

                $("#btnAdicionarAporte").on('click', function () {
                    try {
                        const notaEmpenho = $("#txtNotaEmpenho").val() || '';
                        $("#ModalLabelAdicionarAporte span").html(`Aportar Valor ao Empenho: <b>${notaEmpenho}</b>`);
                        $('#hdnEmpenhoIdAdicionarAporte').val(empenhoId);
                        $('#frmAdicionarAporte')[0].reset();
                        
                        if (modalAdicionarAporteInstance) {
                            modalAdicionarAporteInstance.show();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAdicionarAporte.click", error);
                    }
                });

                modalAdicionarAporteEl.addEventListener('hidden.bs.modal', function () {
                    try {
                        $("#frmAdicionarAporte")[0].reset();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAdicionarAporte.hidden", error);
                    }
                });

                // ===== MODAL ADICIONAR ANULAÇÃO (Bootstrap 5) =====
                const modalAdicionarAnulacaoEl = document.getElementById('modalAdicionarAnulacao');
                let modalAdicionarAnulacaoInstance = null;
                
                if (modalAdicionarAnulacaoEl) {
                    modalAdicionarAnulacaoInstance = new bootstrap.Modal(modalAdicionarAnulacaoEl);
                }

                $("#btnAdicionarAnulacao").on('click', function () {
                    try {
                        const notaEmpenho = $("#txtNotaEmpenho").val() || '';
                        $("#ModalLabelAdicionarAnulacao span").html(`Anular Valor do Empenho: <b>${notaEmpenho}</b>`);
                        $('#hdnEmpenhoIdAdicionarAnulacao').val(empenhoId);
                        $('#frmAdicionarAnulacao')[0].reset();
                        
                        if (modalAdicionarAnulacaoInstance) {
                            modalAdicionarAnulacaoInstance.show();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAdicionarAnulacao.click", error);
                    }
                });

                modalAdicionarAnulacaoEl.addEventListener('hidden.bs.modal', function () {
                    try {
                        $("#frmAdicionarAnulacao")[0].reset();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAdicionarAnulacao.hidden", error);
                    }
                });

                // ===== DATATABLE APORTES =====
                if ($('#tblAporte').length) {
                    try {
                        window.AporteTable = $('#tblAporte').DataTable({
                            paging: false,
                            lengthChange: false,
                            searching: false,
                            bSort: false,
                            info: false,
                            columnDefs: [
                                { targets: 0, className: "text-center", width: "15%" },
                                { targets: 1, className: "text-start",  width: "35%" },
                                { targets: 2, className: "text-end",    width: "20%" },
                                { targets: 3, className: "text-center", width: "15%" },
                                { targets: 4, className: "text-center", visible: false },
                                { targets: 5, className: "text-center", visible: false }
                            ],
                            responsive: true,
                            ajax: {
                                url: "/api/empenho/listaaporte",
                                type: "GET",
                                datatype: "json",
                                data: { Id: empenhoId }
                            },
                            columns: [
                                { data: "dataFormatada" },
                                { data: "descricao" },
                                { data: "valorFormatado" },
                                {
                                    data: "movimentacaoId",
                                    render: function (data) {
                                        return `
                                            <div class="text-center ftx-actions">
                                                <a class="btn btn-icon-sm btn-azul btn-edit-aporte text-white"
                                                   data-id='${data}'>
                                                    <i class="fa-duotone fa-pen-to-square"></i>
                                                </a>
                                                <a class="btn btn-icon-sm btn-vinho btn-deleteaporte text-white"
                                                   data-context="empenho"
                                                   data-id='${data}'>
                                                    <i class="fa-duotone fa-trash-can"></i>
                                                </a>
                                            </div>
                                        `;
                                    }
                                },
                                { data: "movimentacaoId" },
                                { data: "valorOriginal" }
                            ],
                            language: {
                                url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                                emptyTable: "Nenhum aporte registrado"
                            },
                            width: "100%",
                            footerCallback: function () {
                                try {
                                    const total = this.api().column(5).data().reduce(function (a, b) {
                                        return (parseFloat(a) || 0) + (parseFloat(b) || 0);
                                    }, 0);

                                    const soma = total.toLocaleString('pt-BR', {
                                        style: "currency",
                                        currency: "BRL"
                                    });

                                    $("#lblTotalAportes").text(soma);
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("Upsert.cshtml", "AporteTable.footerCallback", error);
                                }
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "AporteTable.init", error);
                    }
                }

                // ===== DATATABLE ANULAÇÕES =====
                if ($('#tblanulacao').length) {
                    try {
                        window.anulacaoTable = $('#tblanulacao').DataTable({
                            paging: false,
                            lengthChange: false,
                            searching: false,
                            bSort: false,
                            info: false,
                            columnDefs: [
                                { targets: 0, className: "text-center", width: "15%" },
                                { targets: 1, className: "text-start",  width: "35%" },
                                { targets: 2, className: "text-end",    width: "20%" },
                                { targets: 3, className: "text-center", width: "15%" },
                                { targets: 4, className: "text-center", visible: false },
                                { targets: 5, className: "text-center", visible: false }
                            ],
                            responsive: true,
                            ajax: {
                                url: "/api/empenho/listaanulacao",
                                type: "GET",
                                datatype: "json",
                                data: { Id: empenhoId }
                            },
                            columns: [
                                { data: "dataFormatada" },
                                { data: "descricao" },
                                {
                                    data: "valorFormatado",
                                    render: function (data) {
                                        return `<span style="color: #dc3545; font-weight: 600;">${data}</span>`;
                                    }
                                },
                                {
                                    data: "movimentacaoId",
                                    render: function (data) {
                                        return `
                                            <div class="text-center ftx-actions">
                                                <a class="btn btn-icon-sm btn-azul btn-edit-anulacao text-white"
                                                   data-id='${data}'>
                                                    <i class="fa-duotone fa-pen-to-square"></i>
                                                </a>
                                                <a class="btn btn-icon-sm btn-vinho btn-deleteanulacao text-white"
                                                   data-context="empenho"
                                                   data-id='${data}'>
                                                    <i class="fa-duotone fa-trash-can"></i>
                                                </a>
                                            </div>
                                        `;
                                    }
                                },
                                { data: "movimentacaoId" },
                                { data: "valorOriginal" }
                            ],
                            language: {
                                url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
                                emptyTable: "Nenhuma anulação registrada"
                            },
                            width: "100%",
                            footerCallback: function () {
                                try {
                                    const total = this.api().column(5).data().reduce(function (a, b) {
                                        return (parseFloat(a) || 0) + (parseFloat(b) || 0);
                                    }, 0);

                                    const soma = total.toLocaleString('pt-BR', {
                                        style: "currency",
                                        currency: "BRL"
                                    });

                                    $("#lblTotalAnulacoes").text(soma);
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("Upsert.cshtml", "anulacaoTable.footerCallback", error);
                                }
                            }
                        });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "anulacaoTable.init", error);
                    }
                }

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "document.ready", error);
            }
        });

        // ===== BOTÃO APORTAR =====
        $("#btnAportar").click(function (e) {
            try {
                e.preventDefault();

                if (!$("#txtDataAporte").val()) {
                    Alerta.Erro("Atenção", "A data do Aporte é obrigatória!");
                    return;
                }
                if (!$("#txtDescricaoAporte").val()) {
                    Alerta.Erro("Atenção", "A descrição do Aporte é obrigatória!");
                    return;
                }
                if (!$("#txtValorAporte").val()) {
                    Alerta.Erro("Atenção", "O valor do Aporte é obrigatório!");
                    return;
                }

                const valorAporte = parseCurrencyBR($("#txtValorAporte").val());
                const empenhoId = '@Model.EmpenhoObj.Empenho.EmpenhoId';

                const objAporte = JSON.stringify({
                    EmpenhoId: empenhoId,
                    MovimentacaoId: $('#hdnMovimentacaoIdAporte').val(),
                    Descricao: $('#txtDescricaoAporte').val(),
                    Valor: valorAporte,
                    DataMovimentacao: $('#txtDataAporte').val(),
                    TipoMovimentacao: "A"
                });

                $.ajax({
                    type: "POST",
                    url: "/api/Empenho/EditarAporte",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: objAporte,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message || 'Aporte editado com sucesso!');

                            if (window.AporteTable) {
                                window.AporteTable.ajax.reload(null, false);
                            }

                            const modalAporteInstance = bootstrap.Modal.getInstance(document.getElementById('modalAporte'));
                            if (modalAporteInstance) modalAporteInstance.hide();

                            setTimeout(() => location.reload(), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAportar.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAportar.error", error);
                        const message = xhr.responseJSON?.message || 'Erro ao editar aporte';
                        AppToast.show('Vermelho', message);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAportar.click", error);
            }
        });

        // ===== BOTÃO ANULAR =====
        $("#btnAnular").click(function (e) {
            try {
                e.preventDefault();

                if (!$("#txtDataanulacao").val()) {
                    Alerta.Erro("Atenção", "A data da Anulação é obrigatória!");
                    return;
                }
                if (!$("#txtDescricaoanulacao").val()) {
                    Alerta.Erro("Atenção", "A descrição da Anulação é obrigatória!");
                    return;
                }
                if (!$("#txtValoranulacao").val()) {
                    Alerta.Erro("Atenção", "O valor da Anulação é obrigatório!");
                    return;
                }

                const valorAnulacao = parseCurrencyBR($("#txtValoranulacao").val());
                const empenhoId = '@Model.EmpenhoObj.Empenho.EmpenhoId';

                const objAnulacao = JSON.stringify({
                    EmpenhoId: empenhoId,
                    MovimentacaoId: $('#hdnMovimentacaoIdAnulacao').val(),
                    Descricao: $('#txtDescricaoanulacao').val(),
                    Valor: valorAnulacao,
                    DataMovimentacao: $('#txtDataanulacao').val(),
                    TipoMovimentacao: "G"
                });

                $.ajax({
                    type: "POST",
                    url: "/api/Empenho/EditarAnulacao",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: objAnulacao,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message || 'Anulação editada com sucesso!');

                            if (window.anulacaoTable) {
                                window.anulacaoTable.ajax.reload(null, false);
                            }

                            const modalAnulacaoInstance = bootstrap.Modal.getInstance(document.getElementById('modalanulacao'));
                            if (modalAnulacaoInstance) modalAnulacaoInstance.hide();

                            setTimeout(() => location.reload(), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAnular.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAnular.error", error);
                        const message = xhr.responseJSON?.message || 'Erro ao editar anulação';
                        AppToast.show('Vermelho', message);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnAnular.click", error);
            }
        });

        // ===== BOTÃO CONFIRMAR APORTE (ADICIONAR NOVO) =====
        $("#btnConfirmarAporte").on("click", function (e) {
            try {
                e.preventDefault();

                if (!$("#txtDataAdicionarAporte").val()) {
                    Alerta.Erro("Atenção", "A data do Aporte é obrigatória!");
                    return;
                }
                if (!$("#txtDescricaoAdicionarAporte").val()) {
                    Alerta.Erro("Atenção", "A descrição do Aporte é obrigatória!");
                    return;
                }
                if (!$("#txtValorAdicionarAporte").val()) {
                    Alerta.Erro("Atenção", "O valor do Aporte é obrigatório!");
                    return;
                }

                const valorAporte = parseCurrencyBR($("#txtValorAdicionarAporte").val());
                const empenhoId = '@Model.EmpenhoObj.Empenho.EmpenhoId';

                const objAporte = JSON.stringify({
                    EmpenhoId: empenhoId,
                    Descricao: $('#txtDescricaoAdicionarAporte').val(),
                    Valor: valorAporte,
                    DataMovimentacao: $('#txtDataAdicionarAporte').val(),
                    TipoMovimentacao: "A"
                });

                // Spinning: desabilita botão e troca ícone
                const $btn = $(this);
                const textoOriginal = $btn.html();
                $btn.prop('disabled', true).html('<i class="fa-duotone fa-spinner-third fa-spin icon-space"></i> Processando...');

                $.ajax({
                    type: "POST",
                    url: "/api/Empenho/Aporte",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: objAporte,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message || 'Aporte adicionado com sucesso!');

                            if (window.AporteTable) {
                                window.AporteTable.ajax.reload(null, false);
                            }

                            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalAdicionarAporte'));
                            if (modalInstance) modalInstance.hide();

                            setTimeout(() => location.reload(), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnConfirmarAporte.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnConfirmarAporte.error", error);
                        const message = xhr.responseJSON?.message || 'Erro ao adicionar aporte';
                        AppToast.show('Vermelho', message);
                    },
                    complete: function () {
                        $btn.prop('disabled', false).html(textoOriginal);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnConfirmarAporte.click", error);
            }
        });

        // ===== BOTÃO CONFIRMAR ANULAÇÃO (ADICIONAR NOVA) =====
        $("#btnConfirmarAnulacao").on("click", function (e) {
            try {
                e.preventDefault();

                if (!$("#txtDataAdicionarAnulacao").val()) {
                    Alerta.Erro("Atenção", "A data da Anulação é obrigatória!");
                    return;
                }
                if (!$("#txtDescricaoAdicionarAnulacao").val()) {
                    Alerta.Erro("Atenção", "A descrição da Anulação é obrigatória!");
                    return;
                }
                if (!$("#txtValorAdicionarAnulacao").val()) {
                    Alerta.Erro("Atenção", "O valor da Anulação é obrigatório!");
                    return;
                }

                const valorAnulacao = parseCurrencyBR($("#txtValorAdicionarAnulacao").val());
                const empenhoId = '@Model.EmpenhoObj.Empenho.EmpenhoId';

                const objAnulacao = JSON.stringify({
                    EmpenhoId: empenhoId,
                    Descricao: $('#txtDescricaoAdicionarAnulacao').val(),
                    Valor: valorAnulacao,
                    DataMovimentacao: $('#txtDataAdicionarAnulacao').val(),
                    TipoMovimentacao: "G"
                });

                // Spinning: desabilita botão e troca ícone
                const $btn = $(this);
                const textoOriginal = $btn.html();
                $btn.prop('disabled', true).html('<i class="fa-duotone fa-spinner-third fa-spin icon-space"></i> Processando...');

                $.ajax({
                    type: "POST",
                    url: "/api/Empenho/anulacao",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: objAnulacao,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message || 'Anulação adicionada com sucesso!');

                            if (window.anulacaoTable) {
                                window.anulacaoTable.ajax.reload(null, false);
                            }

                            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalAdicionarAnulacao'));
                            if (modalInstance) modalInstance.hide();

                            setTimeout(() => location.reload(), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnConfirmarAnulacao.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnConfirmarAnulacao.error", error);
                        const message = xhr.responseJSON?.message || 'Erro ao adicionar anulação';
                        AppToast.show('Vermelho', message);
                    },
                    complete: function () {
                        $btn.prop('disabled', false).html(textoOriginal);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnConfirmarAnulacao.click", error);
            }
        });

        // ===== BOTÃO SUBMIT =====
        $("#btnSubmit").click(function (event) {
            try {
                event.preventDefault();

                if (!$("#txtNotaEmpenho").val()) {
                    Alerta.Erro("Informação Ausente", "A Nota de Empenho é obrigatória");
                    return;
                }
                if (!$("#txtDataEmissao").val()) {
                    Alerta.Erro("Informação Ausente", "A data de emissão é obrigatória");
                    return;
                }
                if (!$("#txtVigenciaInicial").val()) {
                    Alerta.Erro("Informação Ausente", "A Vigência Inicial do Empenho é obrigatória");
                    return;
                }
                if (!$("#lstVigencia").val()) {
                    Alerta.Erro("Informação Ausente", "O ano da Vigência do Empenho é obrigatório");
                    return;
                }
                if (!$("#txtVigenciaFinal").val()) {
                    Alerta.Erro("Informação Ausente", "A Vigência Final do Empenho é obrigatória");
                    return;
                }

                if (!$("#lstInstrumento").val()) {
                    Alerta.Erro("Informação Ausente", "Você deve escolher o Instrumento do Empenho (Contrato/Ata)");
                    return;
                }

                if ($("#lstInstrumento").val() === "0" && !$("#EmpenhoObj_Empenho_ContratoId").val()) {
                    Alerta.Erro("Informação Ausente", "O Contrato do Empenho é obrigatório");
                    return;
                }

                if ($("#lstInstrumento").val() === "1" && !$("#EmpenhoObj_Empenho_AtaId").val()) {
                    Alerta.Erro("Informação Ausente", "A Ata de Registro de Preços do Empenho é obrigatória");
                    return;
                }

                const saldoInicial = parseCurrencyBR($("#SaldoInicial").val());
                if (!saldoInicial || saldoInicial === 0) {
                    Alerta.Erro("Informação Ausente", "O Saldo Inicial do Empenho é obrigatório");
                    return;
                }

                $("#btnSubmit").prop("disabled", true);
                $("#btnEscondido").click();

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnSubmit.click", error);
                $("#btnSubmit").prop("disabled", false);
            }
        });

        $("#btnEscondido").click(function (event) {
            try {
                event.preventDefault();
                InsereRegistro();
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnEscondido.click", error);
            }
        });

        function InsereRegistro() {
            try {
                const empenhoId = '@Model.EmpenhoObj.Empenho.EmpenhoId';
                const criando = !empenhoId || empenhoId === '00000000-0000-0000-0000-000000000000';

                const valorSaldoInicial = parseCurrencyBR($('#SaldoInicial').val());
                const valorSaldoFinal = criando
                    ? valorSaldoInicial
                    : parseCurrencyBR($('#SaldoFinal').val());

                let payload = {
                    NotaEmpenho: $('#txtNotaEmpenho').val(),
                    DataEmissao: $('#txtDataEmissao').val(),
                    AnoVigencia: $('#lstVigencia').val(),
                    VigenciaInicial: $('#txtVigenciaInicial').val(),
                    VigenciaFinal: $('#txtVigenciaFinal').val(),
                    SaldoInicial: valorSaldoInicial,
                    SaldoFinal: valorSaldoFinal
                };

                if ($("#lstInstrumento").val() === "0") {
                    payload.ContratoId = $('#EmpenhoObj_Empenho_ContratoId').val();
                } else {
                    payload.AtaId = $('#EmpenhoObj_Empenho_AtaId').val();
                }

                if (!criando) {
                    payload.EmpenhoId = empenhoId;
                }

                const json = JSON.stringify(payload);
                const url = criando
                    ? "/api/Empenho/InsereEmpenho"
                    : "/api/Empenho/EditaEmpenho";

                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: json,
                    success: function (data) {
                        try {
                            const mensagem = criando
                                ? "Empenho Adicionado com Sucesso!"
                                : "Empenho Alterado com Sucesso!";

                            AppToast.show('Verde', mensagem);

                            setTimeout(() => location.replace("/empenho"), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "InsereRegistro.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "InsereRegistro.error", error);

                        const message = xhr.responseJSON?.message || "Ocorreu um erro ao salvar o empenho.";
                        AppToast.show('Vermelho', message);

                        $("#btnSubmit").prop("disabled", false);
                    }
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "InsereRegistro", error);
                $("#btnSubmit").prop("disabled", false);
            }
        }
    </script>
}
