@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Empenho.UpsertModel

@{
    ViewData["Title"] = "Empenhos";
    ViewData["PageName"] = "empenho_upsert";
    ViewData["Heading"] = "<i class='fa-duotone fa-money-check-dollar-pen'></i> Cadastros: <span class='fw-300'>Empenhos</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-money-check-dollar-pen";

    var isEditing = Model.EmpenhoObj.Empenho.EmpenhoId != Guid.Empty;
    var pageTitle = isEditing ? "Editar Empenho" : "Novo Empenho";
    var pageIcon = isEditing ? "fa-pen-to-square" : "fa-file-circle-plus";
}

@section HeadBlock {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />

    <style>
        /* ===== HEADER PADRÃO FrotiX ===== */
        .ftx-card-header {
            background: linear-gradient(135deg, #325d88 0%, #2a4d73 50%, #1e3a5f 100%);
            background-size: 200% 200%;
            animation: ftxHeaderGradientShift 8s ease infinite;
            padding: 1.25rem 1.75rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(50, 93, 136, 0.3);
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: ftxHeaderShine 4s ease-in-out infinite;
        }

        @@keyframes ftxHeaderGradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @@keyframes ftxHeaderShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .titulo-paginas {
            font-family: 'Outfit', sans-serif;
            font-weight: 900;
            font-size: 1.925rem;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .titulo-paginas i {
            font-size: 2.2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: ftxHeaderIconPulse 2.5s ease-in-out infinite;
        }

        @@keyframes ftxHeaderIconPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.08); opacity: 0.9; }
        }

        .btn-header-voltar {
            background: linear-gradient(135deg, #722F37 0%, #5a252c 100%);
            border: 2px solid rgba(255,255,255,0.3);
            color: #fff;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(114, 47, 55, 0.3);
            position: relative;
            z-index: 1;
            text-decoration: none;
        }

        .btn-header-voltar:hover {
            background: linear-gradient(135deg, #5a252c 0%, #461d23 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(114, 47, 55, 0.4);
            color: #fff;
        }

        /* ===== CARD PRINCIPAL ===== */
        .ftx-form-card {
            background: #fff;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .ftx-form-body {
            padding: 2rem;
        }

        /* ===== SEÇÕES DO FORMULÁRIO ===== */
        .ftx-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .ftx-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .ftx-section-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #325d88;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ftx-section-title i {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        /* ===== LABELS E INPUTS ===== */
        .ftx-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.4rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .ftx-label i {
            color: #325d88;
            font-size: 0.9rem;
        }

        .ftx-input {
            border: 1.5px solid #dee2e6;
            border-radius: 8px;
            padding: 0.6rem 0.9rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: #fff;
        }

        .ftx-input:focus {
            border-color: #325d88;
            box-shadow: 0 0 0 3px rgba(50, 93, 136, 0.15);
            outline: none;
        }

        .ftx-input:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .ftx-select {
            border: 1.5px solid #dee2e6;
            border-radius: 8px;
            padding: 0.6rem 0.9rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: #fff;
            cursor: pointer;
        }

        .ftx-select:focus {
            border-color: #325d88;
            box-shadow: 0 0 0 3px rgba(50, 93, 136, 0.15);
            outline: none;
        }

        /* ===== CARDS DE SALDO ===== */
        .ftx-saldo-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }

        .ftx-saldo-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ftx-saldo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 12px 12px 0 0;
        }

        .ftx-saldo-card.saldo-inicial::before {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .ftx-saldo-card.saldo-final::before {
            background: linear-gradient(90deg, #325d88, #4a7eb8);
        }

        .ftx-saldo-card.saldo-notas::before {
            background: linear-gradient(90deg, #E67E22, #f39c12);
        }

        .ftx-saldo-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .ftx-saldo-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .ftx-saldo-label i {
            font-size: 1rem;
        }

        .ftx-saldo-valor {
            font-family: 'Outfit', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: #212529;
        }

        .ftx-saldo-card.saldo-inicial .ftx-saldo-valor { color: #28a745; }
        .ftx-saldo-card.saldo-final .ftx-saldo-valor { color: #325d88; }
        .ftx-saldo-card.saldo-notas .ftx-saldo-valor { color: #E67E22; }

        /* ===== BOTÕES DE AÇÃO ===== */
        .ftx-actions-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e9ecef;
        }

        .btn-ftx-primary {
            background: linear-gradient(135deg, #325d88 0%, #2a4d73 100%);
            border: none;
            color: #fff;
            font-weight: 600;
            font-size: 1.05rem;
            padding: 0.85rem 2.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(50, 93, 136, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
        }

        .btn-ftx-primary i {
            font-size: 1.2rem;
        }

        .btn-ftx-primary:hover {
            background: linear-gradient(135deg, #2a4d73 0%, #1e3a5f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 93, 136, 0.4);
            color: #fff;
        }

        .btn-ftx-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-ftx-secondary {
            background: linear-gradient(135deg, #722F37 0%, #5a252c 100%);
            border: none;
            color: #fff;
            font-weight: 600;
            font-size: 1.05rem;
            padding: 0.85rem 2.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(114, 47, 55, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            text-decoration: none;
        }

        .btn-ftx-secondary i {
            font-size: 1.2rem;
        }

        .btn-ftx-secondary:hover {
            background: linear-gradient(135deg, #5a252c 0%, #461d23 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(114, 47, 55, 0.4);
            color: #fff;
        }

        .btn-ftx-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            color: #fff;
            font-weight: 600;
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-ftx-info:hover {
            background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
            color: #fff;
        }

        /* ===== SEÇÃO DE MOVIMENTAÇÕES ===== */
        .ftx-movimentacoes-section {
            margin-top: 2rem;
        }

        .ftx-movimentacoes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @@media (max-width: 991px) {
            .ftx-movimentacoes-grid {
                grid-template-columns: 1fr;
            }
        }

        .ftx-mov-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .ftx-mov-header {
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .ftx-mov-header.aportes {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .ftx-mov-header.anulacoes {
            background: linear-gradient(135deg, #722F37 0%, #9b3a44 100%);
        }

        .ftx-mov-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .ftx-mov-total {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: #fff;
            background: rgba(255,255,255,0.2);
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
        }

        .ftx-mov-body {
            padding: 1rem;
        }

        /* ===== DATATABLES ESTILIZADAS ===== */
        .ftx-table-wrapper {
            overflow-x: auto;
        }

        .ftx-table-wrapper table.dataTable thead th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 0.75rem 0.5rem;
            border-bottom: 2px solid #dee2e6;
        }

        .ftx-table-wrapper table.dataTable tbody td {
            padding: 0.6rem 0.5rem;
            vertical-align: middle;
            font-size: 0.85rem;
        }

        .ftx-table-wrapper table.dataTable tbody tr:hover {
            background: rgba(50, 93, 136, 0.05);
        }

        /* ===== BOTÕES DE AÇÃO NA TABELA ===== */
        .ftx-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-icon-28 {
            width: 28px;
            height: 28px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-icon-28:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-icon-28.btn-azul {
            background: linear-gradient(135deg, #325d88 0%, #2a4d73 100%);
            color: #fff;
        }

        .btn-icon-28.btn-vinho {
            background: linear-gradient(135deg, #722F37 0%, #5a252c 100%);
            color: #fff;
        }

        .btn-icon-28.btn-dark {
            background: linear-gradient(135deg, #343a40 0%, #23272b 100%);
            color: #fff;
        }

        /* ===== MODAIS ===== */
        .modal-header-aporte {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: #fff;
            border: none;
            padding: 1rem 1.5rem;
        }

        .modal-header-anulacao {
            background: linear-gradient(135deg, #722F37 0%, #9b3a44 100%);
            color: #fff;
            border: none;
            padding: 1rem 1.5rem;
        }

        .modal-header-nf {
            background: linear-gradient(135deg, #E67E22 0%, #f39c12 100%);
            color: #fff;
            border: none;
            padding: 1rem 1.5rem;
        }

        .modal-title-ftx {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-title-ftx i {
            font-size: 1.3rem;
            animation: ftxHeaderIconPulse 2.5s ease-in-out infinite;
        }

        .modal-body-ftx {
            padding: 1.5rem;
        }

        .modal-footer-ftx {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* ===== VALIDATION ===== */
        .text-danger {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* ===== ANIMAÇÃO DE LOADING ===== */
        .btn-ftx-primary.btn-loading,
        .btn-ftx-secondary.btn-loading {
            position: relative;
            pointer-events: none;
            color: transparent !important;
        }

        .btn-ftx-primary.btn-loading i,
        .btn-ftx-primary.btn-loading span,
        .btn-ftx-secondary.btn-loading i,
        .btn-ftx-secondary.btn-loading span {
            visibility: hidden;
        }

        .btn-ftx-primary.btn-loading::after,
        .btn-ftx-secondary.btn-loading::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            top: 50%;
            left: 50%;
            margin: -11px 0 0 -11px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: btnSpin 0.8s linear infinite;
        }

        @@keyframes btnSpin {
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVO ===== */
        @@media (max-width: 768px) {
            .titulo-paginas {
                font-size: 1.4rem;
            }
            .titulo-paginas i {
                font-size: 1.6rem;
            }
            .ftx-form-body {
                padding: 1.25rem;
            }
            .ftx-saldo-container {
                grid-template-columns: 1fr;
            }
            .ftx-actions-container {
                flex-direction: column;
            }
            .ftx-actions-container .btn-ftx-primary,
            .ftx-actions-container .btn-ftx-secondary {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
}

<div class="row">
    <div class="col-12">
        <!-- ===== HEADER ===== -->
        <div class="ftx-card-header">
            <h1 class="titulo-paginas">
                <i class="fa-duotone @pageIcon"></i>
                @pageTitle
            </h1>
            <a asp-page="./Index" class="btn-header-voltar">
                <i class="fa-duotone fa-arrow-left"></i> Voltar à Lista
            </a>
        </div>

        <!-- ===== FORMULÁRIO PRINCIPAL ===== -->
        <div class="ftx-form-card">
            <div class="ftx-form-body">
                <form id="frmEmpenho" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    @if (isEditing)
                    {
                        <input id="hdnEmpenhoId" type="hidden" asp-for="EmpenhoObj.Empenho.EmpenhoId" />
                    }

                    <!-- ===== SEÇÃO: IDENTIFICAÇÃO ===== -->
                    <div class="ftx-section">
                        <h3 class="ftx-section-title">
                            <i class="fa-duotone fa-file-certificate"></i>
                            Identificação do Empenho
                        </h3>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-hashtag"></i>
                                    Nota de Empenho
                                </label>
                                <div class="position-relative">
                                    <input id="txtNotaEmpenho"
                                           class="form-control ftx-input"
                                           asp-for="EmpenhoObj.Empenho.NotaEmpenho"
                                           placeholder="Ex: 2025NE00001"
                                           maxlength="12"
                                           minlength="12"
                                           style="padding-right: 60px; text-transform: uppercase;"
                                           data-ejtip="Informe o número da Nota de Empenho (exatamente 12 caracteres)" />
                                    <span id="contadorNota" class="position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: #6c757d;">0/12</span>
                                </div>
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.NotaEmpenho"></span>
                            </div>

                            <div class="col-md-2">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-calendar-day"></i>
                                    Data Emissão
                                </label>
                                <input id="txtDataEmissao"
                                       class="form-control ftx-input"
                                       asp-for="EmpenhoObj.Empenho.DataEmissao"
                                       type="date"
                                       data-ejtip="Data de emissão do empenho" />
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.DataEmissao"></span>
                            </div>

                            <div class="col-md-2">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-calendar-arrow-down"></i>
                                    Vigência Inicial
                                </label>
                                <input id="txtVigenciaInicial"
                                       class="form-control ftx-input"
                                       asp-for="EmpenhoObj.Empenho.VigenciaInicial"
                                       type="date"
                                       data-ejtip="Data inicial de vigência" />
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.VigenciaInicial"></span>
                            </div>

                            <div class="col-md-2">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-calendar-arrow-up"></i>
                                    Vigência Final
                                </label>
                                <input id="txtVigenciaFinal"
                                       class="form-control ftx-input"
                                       asp-for="EmpenhoObj.Empenho.VigenciaFinal"
                                       type="date"
                                       data-ejtip="Data final de vigência" />
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.VigenciaFinal"></span>
                            </div>

                            <div class="col-md-2">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-calendar-range"></i>
                                    Ano Vigência
                                </label>
                                <select id="lstVigencia"
                                        class="form-select ftx-select"
                                        asp-for="EmpenhoObj.Empenho.AnoVigencia"
                                        data-ejtip="Ano de vigência do empenho">
                                    <option value="">-- Ano --</option>
                                    <option value="2027">2027</option>
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="2019">2019</option>
                                    <option value="2018">2018</option>
                                </select>
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.AnoVigencia"></span>
                            </div>
                        </div>
                    </div>

                    <!-- ===== SEÇÃO: INSTRUMENTO ===== -->
                    <div class="ftx-section">
                        <h3 class="ftx-section-title">
                            <i class="fa-duotone fa-file-contract"></i>
                            Instrumento Vinculado
                        </h3>

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-layer-group"></i>
                                    Tipo de Instrumento
                                </label>
                                <select id="lstInstrumento"
                                        class="form-select ftx-select"
                                        data-ejtip="Selecione o tipo de instrumento">
                                    <option value="">-- Selecione --</option>
                                    <option value="0">Contrato</option>
                                    <option value="1">Ata de Registro de Preços</option>
                                </select>
                            </div>

                            <div id="divContrato" class="col-md-9" style="display: none;">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-file-signature"></i>
                                    Contrato
                                </label>
                                @Html.DropDownListFor(m => m.EmpenhoObj.Empenho.ContratoId,
                                    Model.EmpenhoObj.ContratoList,
                                    "- Selecione um Contrato -",
                                    new { @class = "form-select ftx-select" })
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.ContratoId"></span>
                            </div>

                            <div id="divAta" class="col-md-9" style="display: none;">
                                <label class="ftx-label">
                                    <i class="fa-duotone fa-clipboard-list"></i>
                                    Ata de Registro de Preços
                                </label>
                                @Html.DropDownListFor(m => m.EmpenhoObj.Empenho.AtaId,
                                    Model.EmpenhoObj.AtaList,
                                    "- Selecione uma Ata -",
                                    new { @class = "form-select ftx-select" })
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.AtaId"></span>
                            </div>
                        </div>
                    </div>

                    <!-- ===== SEÇÃO: VALORES ===== -->
                    <div class="ftx-section">
                        <h3 class="ftx-section-title">
                            <i class="fa-duotone fa-sack-dollar"></i>
                            Valores do Empenho
                        </h3>

                        <div class="ftx-saldo-container">
                            <div class="ftx-saldo-card saldo-inicial">
                                <div class="ftx-saldo-label">
                                    <i class="fa-duotone fa-arrow-right-to-bracket"></i>
                                    Saldo Inicial
                                </div>
                                <input id="SaldoInicial"
                                       class="form-control ftx-input ftx-saldo-valor text-center"
                                       asp-for="EmpenhoObj.Empenho.SaldoInicial"
                                       style="border: none; background: transparent; font-size: 1.4rem;"
                                       onKeyPress="return(moeda(this,'.',',',event))"
                                       placeholder="0,00"
                                       data-ejtip="Valor inicial do empenho" />
                                <span class="text-danger" asp-validation-for="EmpenhoObj.Empenho.SaldoInicial"></span>
                            </div>

                            <div class="ftx-saldo-card saldo-final">
                                <div class="ftx-saldo-label">
                                    <i class="fa-duotone fa-scale-balanced"></i>
                                    Saldo Atual
                                </div>
                                <input id="SaldoFinal"
                                       class="form-control ftx-input ftx-saldo-valor text-center"
                                       asp-for="EmpenhoObj.Empenho.SaldoFinal"
                                       style="border: none; background: transparent; font-size: 1.4rem;"
                                       disabled
                                       data-ejtip="Saldo atual calculado automaticamente" />
                            </div>

                            <div class="ftx-saldo-card saldo-notas">
                                <div class="ftx-saldo-label">
                                    <i class="fa-duotone fa-file-invoice-dollar"></i>
                                    Total Notas Fiscais
                                </div>
                                <input id="SaldoNotas"
                                       class="form-control ftx-saldo-valor text-center"
                                       style="border: none; background: transparent; font-size: 1.4rem;"
                                       disabled
                                       placeholder="0,00"
                                       data-ejtip="Total das notas fiscais lançadas" />
                                <button type="button" class="btn btn-ftx-info mt-2" data-bs-toggle="modal" data-bs-target="#modalNF">
                                    <i class="fa-duotone fa-eye"></i> Ver Notas
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ===== BOTÕES DE AÇÃO ===== -->
                    <div class="ftx-actions-container">
                        @if (isEditing)
                        {
                            <button id="btnSubmit" type="button" class="btn-ftx-primary">
                                <i class="fa-duotone fa-floppy-disk"></i> <span>Salvar Alterações</span>
                            </button>
                        }
                        else
                        {
                            <button id="btnSubmit" type="button" class="btn-ftx-primary">
                                <i class="fa-duotone fa-file-circle-plus"></i> <span>Criar Empenho</span>
                            </button>
                        }
                        <a asp-page="./Index" class="btn-ftx-secondary">
                            <i class="fa-duotone fa-xmark"></i> <span>Cancelar</span>
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- ===== SEÇÃO: MOVIMENTAÇÕES (apenas na edição) ===== -->
        @if (isEditing)
        {
            <div class="ftx-movimentacoes-section">
                <div class="ftx-movimentacoes-grid">
                    <!-- Card Aportes -->
                    <div class="ftx-mov-card">
                        <div class="ftx-mov-header aportes">
                            <h4 class="ftx-mov-title">
                                <i class="fa-duotone fa-circle-plus"></i>
                                Aportes / Reforços
                            </h4>
                            <span id="totalAportes" class="ftx-mov-total">R$ 0,00</span>
                        </div>
                        <div class="ftx-mov-body">
                            <div class="ftx-table-wrapper">
                                <table id="tblAporte" class="table table-sm" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descrição</th>
                                            <th>Valor</th>
                                            <th>Ações</th>
                                            <th>Id</th>
                                            <th>ValorNum</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Card Anulações -->
                    <div class="ftx-mov-card">
                        <div class="ftx-mov-header anulacoes">
                            <h4 class="ftx-mov-title">
                                <i class="fa-duotone fa-circle-minus"></i>
                                Anulações
                            </h4>
                            <span id="totalAnulacoes" class="ftx-mov-total">R$ 0,00</span>
                        </div>
                        <div class="ftx-mov-body">
                            <div class="ftx-table-wrapper">
                                <table id="tblAnulacao" class="table table-sm" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descrição</th>
                                            <th>Valor</th>
                                            <th>Ações</th>
                                            <th>Id</th>
                                            <th>ValorNum</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- ===== MODAL APORTE ===== -->
<div class="modal fade" id="modalAporte" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-aporte">
                <h5 class="modal-title modal-title-ftx" id="modalAporteLabel">
                    <i class="fa-duotone fa-circle-plus"></i>
                    Editar Aporte
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body modal-body-ftx">
                <form id="frmAporte">
                    <input type="hidden" id="hdnEmpenhoIdAporte" />
                    <input type="hidden" id="hdnMovimentacaoIdAporte" />

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-calendar"></i>
                                Data do Aporte
                            </label>
                            <input id="txtDataAporte" type="date" class="form-control ftx-input" />
                        </div>
                        <div class="col-md-8">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-align-left"></i>
                                Descrição
                            </label>
                            <input id="txtDescricaoAporte" class="form-control ftx-input" placeholder="Descrição do aporte" />
                        </div>
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-dollar-sign"></i>
                                Valor do Aporte
                            </label>
                            <input id="txtValorAporte"
                                   class="form-control ftx-input text-end"
                                   onKeyPress="return(moeda(this,'.',',',event))"
                                   placeholder="0,00" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-ftx">
                <button type="button" id="btnSalvarAporte" class="btn-ftx-primary">
                    <i class="fa-duotone fa-floppy-disk"></i> Salvar Aporte
                </button>
                <button type="button" class="btn-ftx-secondary" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL ANULAÇÃO ===== -->
<div class="modal fade" id="modalAnulacao" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-anulacao">
                <h5 class="modal-title modal-title-ftx" id="modalAnulacaoLabel">
                    <i class="fa-duotone fa-circle-minus"></i>
                    Editar Anulação
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body modal-body-ftx">
                <form id="frmAnulacao">
                    <input type="hidden" id="hdnEmpenhoIdAnulacao" />
                    <input type="hidden" id="hdnMovimentacaoIdAnulacao" />

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-calendar"></i>
                                Data da Anulação
                            </label>
                            <input id="txtDataAnulacao" type="date" class="form-control ftx-input" />
                        </div>
                        <div class="col-md-8">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-align-left"></i>
                                Descrição
                            </label>
                            <input id="txtDescricaoAnulacao" class="form-control ftx-input" placeholder="Descrição da anulação" />
                        </div>
                        <div class="col-md-4">
                            <label class="ftx-label">
                                <i class="fa-duotone fa-dollar-sign"></i>
                                Valor da Anulação
                            </label>
                            <input id="txtValorAnulacao"
                                   class="form-control ftx-input text-end"
                                   onKeyPress="return(moeda(this,'.',',',event))"
                                   placeholder="0,00" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-ftx">
                <button type="button" id="btnSalvarAnulacao" class="btn-ftx-primary">
                    <i class="fa-duotone fa-floppy-disk"></i> Salvar Anulação
                </button>
                <button type="button" class="btn-ftx-secondary" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== MODAL NOTAS FISCAIS ===== -->
<div class="modal fade" id="modalNF" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header modal-header-nf">
                <h5 class="modal-title modal-title-ftx" id="modalNFLabel">
                    <i class="fa-duotone fa-file-invoice-dollar"></i>
                    Notas Fiscais do Empenho
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body modal-body-ftx">
                <div class="ftx-table-wrapper">
                    <table id="tblNotaFiscal" class="table table-sm table-striped" width="100%">
                        <thead>
                            <tr>
                                <th>Nº Nota</th>
                                <th>Data Emissão</th>
                                <th>Valor NF</th>
                                <th>Valor Glosa</th>
                                <th>Motivo Glosa</th>
                                <th>Ações</th>
                                <th>ContratoId</th>
                                <th>EmpenhoId</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer modal-footer-ftx">
                <button type="button" class="btn-ftx-secondary" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="~/js/cadastros/empenho.js" asp-append-version="true"></script>

    <script>
        // ===== CONSTANTES =====
        const EMPENHO_ID = '@Model.EmpenhoObj.Empenho.EmpenhoId';
        const IS_EDITING = EMPENHO_ID && EMPENHO_ID !== '00000000-0000-0000-0000-000000000000';

        // ===== FUNÇÕES UTILITÁRIAS =====
        function parseCurrencyBR(str) {
            try {
                if (!str) return 0;
                return parseFloat(
                    String(str)
                        .replace(/\s/g, '')
                        .replace('R$', '')
                        .replace(/\./g, '')
                        .replace(',', '.')
                ) || 0;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "parseCurrencyBR", error);
                return 0;
            }
        }

        function formatNumberBR(value) {
            try {
                const num = typeof value === 'number' ? value : parseFloat(value);
                if (isNaN(num)) return '0,00';
                return num.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "formatNumberBR", error);
                return '0,00';
            }
        }

        function formatCurrencyBR(value) {
            try {
                const num = typeof value === 'number' ? value : parseFloat(value);
                if (isNaN(num)) return 'R$ 0,00';
                return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "formatCurrencyBR", error);
                return 'R$ 0,00';
            }
        }

        function moeda(input, sep, dec, event) {
            try {
                let digitado = "", i = j = 0, tamanho = tamanho2 = 0, limpo = ajustado = "";
                let tecla = window.Event ? event.which : event.keyCode;

                if (tecla === 13 || tecla === 8) return true;
                digitado = String.fromCharCode(tecla);
                if ("0123456789".indexOf(digitado) === -1) return false;

                for (tamanho = input.value.length, i = 0;
                     i < tamanho && (input.value.charAt(i) === "0" || input.value.charAt(i) === dec);
                     i++);

                for (limpo = ""; i < tamanho; i++) {
                    if ("0123456789".indexOf(input.value.charAt(i)) !== -1) {
                        limpo += input.value.charAt(i);
                    }
                }

                limpo += digitado;
                tamanho = limpo.length;

                if (tamanho === 0) {
                    input.value = "";
                } else if (tamanho === 1) {
                    input.value = "0" + dec + "0" + limpo;
                } else if (tamanho === 2) {
                    input.value = "0" + dec + limpo;
                } else {
                    for (ajustado = "", j = 0, i = tamanho - 3; i >= 0; i--) {
                        if (j === 3) {
                            ajustado += sep;
                            j = 0;
                        }
                        ajustado += limpo.charAt(i);
                        j++;
                    }

                    input.value = "";
                    tamanho2 = ajustado.length;

                    for (i = tamanho2 - 1; i >= 0; i--) {
                        input.value += ajustado.charAt(i);
                    }

                    input.value += dec + limpo.substr(tamanho - 2, tamanho);
                }

                return false;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "moeda", error);
                return false;
            }
        }

        function convertDateToISO(dateStr) {
            try {
                if (!dateStr) return '';
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`;
                }
                return dateStr;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "convertDateToISO", error);
                return '';
            }
        }

        // ===== DOCUMENT READY =====
        $(document).ready(function () {
            try {
                // ===== INICIALIZAÇÃO =====
                initInstrumentoVisibility();
                loadSaldos();

                if (IS_EDITING) {
                    $('#SaldoInicial').prop('disabled', true);
                    initAporteTable();
                    initAnulacaoTable();
                }

                // ===== EVENTOS =====

                // Contador de caracteres da Nota de Empenho + conversão para maiúsculas
                $('#txtNotaEmpenho').on('input', function () {
                    try {
                        // Converte para maiúsculas
                        const valor = $(this).val().toUpperCase();
                        $(this).val(valor);
                        
                        const tamanho = valor.length;
                        const $contador = $('#contadorNota');
                        $contador.text(tamanho + '/12');
                        
                        if (tamanho === 12) {
                            $contador.css('color', '#28a745'); // verde
                            $(this).css('border-color', '#28a745');
                        } else if (tamanho > 0) {
                            $contador.css('color', '#dc3545'); // vermelho
                            $(this).css('border-color', '#dc3545');
                        } else {
                            $contador.css('color', '#6c757d'); // cinza
                            $(this).css('border-color', '#dee2e6');
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtNotaEmpenho.input", error);
                    }
                });

                // Dispara o evento para atualizar contador no carregamento
                $('#txtNotaEmpenho').trigger('input');

                // Validação das datas no blur (lost focus)
                $('#txtVigenciaInicial').on('blur', function () {
                    try {
                        validarVigenciaInicial();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtVigenciaInicial.blur", error);
                    }
                });

                $('#txtVigenciaFinal').on('blur', function () {
                    try {
                        validarVigenciaFinal();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtVigenciaFinal.blur", error);
                    }
                });

                // Saldo Inicial -> Saldo Final (apenas na criação)
                $('#SaldoInicial').on('focusout', function () {
                    try {
                        if (!IS_EDITING) {
                            $('#SaldoFinal').val(this.value);
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "SaldoInicial.focusout", error);
                    }
                });

                // Troca de instrumento
                $('#lstInstrumento').on('change', function () {
                    try {
                        $('#EmpenhoObj_Empenho_AtaId').val('');
                        $('#EmpenhoObj_Empenho_ContratoId').val('');

                        const valor = $(this).val();

                        if (valor === '0') {
                            $('#divContrato').show();
                            $('#divAta').hide();
                        } else if (valor === '1') {
                            $('#divAta').show();
                            $('#divContrato').hide();
                        } else {
                            $('#divContrato, #divAta').hide();
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "lstInstrumento.change", error);
                    }
                });

                // Submit do formulário
                $('#btnSubmit').on('click', function () {
                    try {
                        if (!validarFormulario()) return;

                        const $btn = $(this);
                        $btn.prop('disabled', true).addClass('btn-loading');

                        salvarEmpenho()
                            .then(() => {
                                $btn.prop('disabled', false).removeClass('btn-loading');
                            })
                            .catch(() => {
                                $btn.prop('disabled', false).removeClass('btn-loading');
                            });
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnSubmit.click", error);
                        $(this).prop('disabled', false).removeClass('btn-loading');
                    }
                });

                // Salvar Aporte
                $('#btnSalvarAporte').on('click', function () {
                    try {
                        salvarAporte();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnSalvarAporte.click", error);
                    }
                });

                // Salvar Anulação
                $('#btnSalvarAnulacao').on('click', function () {
                    try {
                        salvarAnulacao();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnSalvarAnulacao.click", error);
                    }
                });

                // Modal Aporte - show
                const modalAporte = document.getElementById('modalAporte');
                if (modalAporte) {
                    modalAporte.addEventListener('show.bs.modal', function (event) {
                        try {
                            const $btn = $(event.relatedTarget);
                            const $row = $btn.closest('tr');
                            const movimentacaoId = $btn.data('id');

                            const dataAporte = $row.find('td:eq(0)').text();
                            const descricao = $row.find('td:eq(1)').text();
                            const valor = $row.find('td:eq(2)').text();

                            $('#txtDataAporte').val(convertDateToISO(dataAporte));
                            $('#txtDescricaoAporte').val(descricao);
                            $('#txtValorAporte').val(valor);

                            const notaEmpenho = $('#txtNotaEmpenho').val() || '';
                            $('#modalAporteLabel').html(`<i class="fa-duotone fa-circle-plus"></i> Editar Aporte - ${notaEmpenho}`);

                            $('#hdnMovimentacaoIdAporte').val(movimentacaoId);
                            $('#hdnEmpenhoIdAporte').val(EMPENHO_ID);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAporte.show", error);
                        }
                    });

                    modalAporte.addEventListener('hidden.bs.modal', function () {
                        try {
                            $('#frmAporte')[0].reset();
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAporte.hidden", error);
                        }
                    });
                }

                // Modal Anulação - show
                const modalAnulacao = document.getElementById('modalAnulacao');
                if (modalAnulacao) {
                    modalAnulacao.addEventListener('show.bs.modal', function (event) {
                        try {
                            const $btn = $(event.relatedTarget);
                            const $row = $btn.closest('tr');
                            const movimentacaoId = $btn.data('id');

                            const dataAnulacao = $row.find('td:eq(0)').text();
                            const descricao = $row.find('td:eq(1)').text();
                            const valor = $row.find('td:eq(2)').text();

                            $('#txtDataAnulacao').val(convertDateToISO(dataAnulacao));
                            $('#txtDescricaoAnulacao').val(descricao);
                            $('#txtValorAnulacao').val(valor);

                            const notaEmpenho = $('#txtNotaEmpenho').val() || '';
                            $('#modalAnulacaoLabel').html(`<i class="fa-duotone fa-circle-minus"></i> Editar Anulação - ${notaEmpenho}`);

                            $('#hdnMovimentacaoIdAnulacao').val(movimentacaoId);
                            $('#hdnEmpenhoIdAnulacao').val(EMPENHO_ID);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAnulacao.show", error);
                        }
                    });

                    modalAnulacao.addEventListener('hidden.bs.modal', function () {
                        try {
                            $('#frmAnulacao')[0].reset();
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalAnulacao.hidden", error);
                        }
                    });
                }

                // Modal Notas Fiscais - show
                const modalNF = document.getElementById('modalNF');
                if (modalNF) {
                    let dataTableNF = null;

                    modalNF.addEventListener('show.bs.modal', function () {
                        try {
                            if (!$('#tblNotaFiscal').length) return;

                            if (dataTableNF) {
                                dataTableNF.destroy();
                            }

                            dataTableNF = $('#tblNotaFiscal').DataTable({
                                columnDefs: [
                                    { targets: 0, className: "text-center", width: "8%" },
                                    { targets: 1, className: "text-center", width: "10%" },
                                    { targets: 2, className: "text-end", width: "12%" },
                                    { targets: 3, className: "text-end", width: "10%" },
                                    { targets: 4, className: "text-start", width: "20%" },
                                    { targets: 5, className: "text-center", width: "10%" },
                                    { targets: 6, visible: false },
                                    { targets: 7, visible: false }
                                ],
                                responsive: true,
                                ajax: {
                                    url: "/api/notafiscal/nfempenhos",
                                    data: { id: EMPENHO_ID },
                                    type: "GET",
                                    dataType: "json"
                                },
                                columns: [
                                    { data: "numeroNF" },
                                    { data: "dataFormatada" },
                                    { data: "valorNFFormatado" },
                                    { data: "valorGlosaFormatado" },
                                    { data: "motivoGlosa" },
                                    {
                                        data: "notaFiscalId",
                                        render: function (data) {
                                            return `
                                                <div class="ftx-actions">
                                                    <a href="/NotaFiscal/Upsert?id=${data}" class="btn btn-icon-28 btn-azul" data-ejtip="Editar NF">
                                                        <i class="fa-duotone fa-pen-to-square"></i>
                                                    </a>
                                                    <a class="btn btn-icon-28 btn-vinho btn-delete-nf" data-ejtip="Excluir NF" data-id="${data}">
                                                        <i class="fa-duotone fa-trash-can"></i>
                                                    </a>
                                                </div>`;
                                        }
                                    },
                                    { data: "contratoId" },
                                    { data: "empenhoId" }
                                ],
                                language: {
                                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json",
                                    emptyTable: "Nenhuma nota fiscal encontrada"
                                }
                            });
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "modalNF.show", error);
                        }
                    });
                }

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "document.ready", error);
            }
        });

        // ===== FUNÇÕES DE INICIALIZAÇÃO =====
        function initInstrumentoVisibility() {
            try {
                if (IS_EDITING) {
                    const contratoId = '@Model.EmpenhoObj.Empenho.ContratoId';
                    const ataId = '@Model.EmpenhoObj.Empenho.AtaId';

                    if (contratoId && contratoId !== '00000000-0000-0000-0000-000000000000' && contratoId !== '') {
                        $('#divContrato').show();
                        $('#lstInstrumento').val('0');
                    } else if (ataId && ataId !== '00000000-0000-0000-0000-000000000000' && ataId !== '') {
                        $('#divAta').show();
                        $('#lstInstrumento').val('1');
                    }
                }
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "initInstrumentoVisibility", error);
            }
        }

        function loadSaldos() {
            try {
                $.ajax({
                    type: "GET",
                    url: "/api/Empenho/SaldoNotas",
                    data: { Id: EMPENHO_ID },
                    dataType: "json",
                    success: function (data) {
                        try {
                            if (data && typeof data.saldonotas !== 'undefined') {
                                $('#SaldoNotas').val(formatNumberBR(parseCurrencyBR(data.saldonotas)));
                            }

                            const saldoInicial = parseCurrencyBR($('#SaldoInicial').val());
                            $('#SaldoInicial').val(formatNumberBR(saldoInicial));

                            const saldoFinal = parseCurrencyBR($('#SaldoFinal').val());
                            $('#SaldoFinal').val(formatNumberBR(saldoFinal));
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "loadSaldos.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "loadSaldos.error", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "loadSaldos", error);
            }
        }

        function initAporteTable() {
            try {
                if (!$('#tblAporte').length) return;

                window.AporteTable = $('#tblAporte').DataTable({
                    lengthChange: false,
                    searching: false,
                    ordering: false,
                    paging: false,
                    info: false,
                    columnDefs: [
                        { targets: 0, className: "text-center", width: "15%" },
                        { targets: 1, className: "text-start", width: "35%" },
                        { targets: 2, className: "text-end", width: "20%" },
                        { targets: 3, className: "text-center", width: "15%" },
                        { targets: 4, visible: false },
                        { targets: 5, visible: false }
                    ],
                    responsive: true,
                    ajax: {
                        url: "/api/empenho/listaaporte",
                        type: "GET",
                        data: { Id: EMPENHO_ID },
                        dataType: "json"
                    },
                    columns: [
                        { data: "dataFormatada" },
                        { data: "descricao" },
                        { data: "valorFormatado" },
                        {
                            data: "movimentacaoId",
                            render: function (data) {
                                return `
                                    <div class="ftx-actions">
                                        <a class="btn btn-icon-28 btn-azul btn-aporte" data-bs-toggle="modal" data-bs-target="#modalAporte" data-id="${data}" data-ejtip="Editar">
                                            <i class="fa-duotone fa-pen-to-square"></i>
                                        </a>
                                        <a class="btn btn-icon-28 btn-vinho btn-deleteaporte" data-id="${data}" data-context="empenho" data-ejtip="Excluir">
                                            <i class="fa-duotone fa-trash-can"></i>
                                        </a>
                                    </div>`;
                            }
                        },
                        { data: "movimentacaoId" },
                        { data: "valorOriginal" }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json",
                        emptyTable: "Nenhum aporte registrado"
                    },
                    drawCallback: function () {
                        try {
                            const total = this.api().column(5).data().reduce(function (a, b) {
                                return (parseFloat(a) || 0) + (parseFloat(b) || 0);
                            }, 0);
                            $('#totalAportes').text(formatCurrencyBR(total));
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "AporteTable.drawCallback", error);
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "initAporteTable", error);
            }
        }

        function initAnulacaoTable() {
            try {
                if (!$('#tblAnulacao').length) return;

                window.AnulacaoTable = $('#tblAnulacao').DataTable({
                    lengthChange: false,
                    searching: false,
                    ordering: false,
                    paging: false,
                    info: false,
                    columnDefs: [
                        { targets: 0, className: "text-center", width: "15%" },
                        { targets: 1, className: "text-start", width: "35%" },
                        {
                            targets: 2,
                            className: "text-end",
                            width: "20%",
                            createdCell: function (td) {
                                $(td).css('color', '#dc3545');
                            }
                        },
                        { targets: 3, className: "text-center", width: "15%" },
                        { targets: 4, visible: false },
                        { targets: 5, visible: false }
                    ],
                    responsive: true,
                    ajax: {
                        url: "/api/empenho/listaanulacao",
                        type: "GET",
                        data: { Id: EMPENHO_ID },
                        dataType: "json"
                    },
                    columns: [
                        { data: "dataFormatada" },
                        { data: "descricao" },
                        { data: "valorFormatado" },
                        {
                            data: "movimentacaoId",
                            render: function (data) {
                                return `
                                    <div class="ftx-actions">
                                        <a class="btn btn-icon-28 btn-azul btn-anulacao" data-bs-toggle="modal" data-bs-target="#modalAnulacao" data-id="${data}" data-ejtip="Editar">
                                            <i class="fa-duotone fa-pen-to-square"></i>
                                        </a>
                                        <a class="btn btn-icon-28 btn-vinho btn-deleteanulacao" data-id="${data}" data-context="empenho" data-ejtip="Excluir">
                                            <i class="fa-duotone fa-trash-can"></i>
                                        </a>
                                    </div>`;
                            }
                        },
                        { data: "movimentacaoId" },
                        { data: "valorOriginal" }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json",
                        emptyTable: "Nenhuma anulação registrada"
                    },
                    drawCallback: function () {
                        try {
                            const total = this.api().column(5).data().reduce(function (a, b) {
                                return (parseFloat(a) || 0) + (parseFloat(b) || 0);
                            }, 0);
                            $('#totalAnulacoes').text(formatCurrencyBR(total));
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "AnulacaoTable.drawCallback", error);
                        }
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "initAnulacaoTable", error);
            }
        }

        // ===== VALIDAÇÃO DE DATAS NO BLUR =====
        function validarVigenciaInicial() {
            try {
                const dataEmissao = $('#txtDataEmissao').val();
                const vigenciaInicial = $('#txtVigenciaInicial').val();

                // Reset do estilo
                $('#txtVigenciaInicial').css('border-color', '#dee2e6');

                if (!dataEmissao || !vigenciaInicial) return;

                // Valida Vigência Inicial >= Data Emissão
                if (new Date(vigenciaInicial) < new Date(dataEmissao)) {
                    $('#txtVigenciaInicial').css('border-color', '#dc3545');
                    AppToast.show('Amarelo', 'Vigência Inicial não pode ser anterior à Data de Emissão');
                    $('#txtVigenciaInicial').val('');
                    return;
                }

                $('#txtVigenciaInicial').css('border-color', '#28a745');
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "validarVigenciaInicial", error);
            }
        }

        function validarVigenciaFinal() {
            try {
                const dataEmissao = $('#txtDataEmissao').val();
                const vigenciaInicial = $('#txtVigenciaInicial').val();
                const vigenciaFinal = $('#txtVigenciaFinal').val();

                // Reset do estilo
                $('#txtVigenciaFinal').css('border-color', '#dee2e6');

                if (!vigenciaFinal) return;

                // Valida Vigência Final >= Data Emissão
                if (dataEmissao && new Date(vigenciaFinal) < new Date(dataEmissao)) {
                    $('#txtVigenciaFinal').css('border-color', '#dc3545');
                    AppToast.show('Amarelo', 'Vigência Final não pode ser anterior à Data de Emissão');
                    $('#txtVigenciaFinal').val('');
                    return;
                }

                // Valida Vigência Final >= Vigência Inicial
                if (vigenciaInicial && new Date(vigenciaFinal) < new Date(vigenciaInicial)) {
                    $('#txtVigenciaFinal').css('border-color', '#dc3545');
                    AppToast.show('Amarelo', 'Vigência Final não pode ser anterior à Vigência Inicial');
                    $('#txtVigenciaFinal').val('');
                    return;
                }

                $('#txtVigenciaFinal').css('border-color', '#28a745');
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "validarVigenciaFinal", error);
            }
        }

        // ===== VALIDAÇÃO =====
        function validarFormulario() {
            try {
                // ===== NOTA DE EMPENHO =====
                const notaEmpenho = $('#txtNotaEmpenho').val()?.trim();
                if (!notaEmpenho) {
                    Alerta.Erro("Campo Obrigatório", "A Nota de Empenho é obrigatória");
                    $('#txtNotaEmpenho').focus();
                    return false;
                }
                if (notaEmpenho.length !== 12) {
                    Alerta.Erro("Formato Inválido", "A Nota de Empenho deve ter exatamente 12 caracteres");
                    $('#txtNotaEmpenho').focus();
                    return false;
                }

                // ===== DATA DE EMISSÃO =====
                const dataEmissao = $('#txtDataEmissao').val();
                if (!dataEmissao) {
                    Alerta.Erro("Campo Obrigatório", "A data de emissão é obrigatória");
                    $('#txtDataEmissao').focus();
                    return false;
                }

                // ===== VIGÊNCIA INICIAL =====
                const vigenciaInicial = $('#txtVigenciaInicial').val();
                if (!vigenciaInicial) {
                    Alerta.Erro("Campo Obrigatório", "A vigência inicial é obrigatória");
                    $('#txtVigenciaInicial').focus();
                    return false;
                }

                // Vigência Inicial não pode ser menor que Data Emissão
                if (new Date(vigenciaInicial) < new Date(dataEmissao)) {
                    Alerta.Erro("Data Inválida", "A Vigência Inicial não pode ser anterior à Data de Emissão");
                    $('#txtVigenciaInicial').focus();
                    return false;
                }

                // ===== VIGÊNCIA FINAL =====
                const vigenciaFinal = $('#txtVigenciaFinal').val();
                if (!vigenciaFinal) {
                    Alerta.Erro("Campo Obrigatório", "A vigência final é obrigatória");
                    $('#txtVigenciaFinal').focus();
                    return false;
                }

                // Vigência Final não pode ser menor que Data Emissão
                if (new Date(vigenciaFinal) < new Date(dataEmissao)) {
                    Alerta.Erro("Data Inválida", "A Vigência Final não pode ser anterior à Data de Emissão");
                    $('#txtVigenciaFinal').focus();
                    return false;
                }

                // Vigência Final não pode ser menor que Vigência Inicial
                if (new Date(vigenciaFinal) < new Date(vigenciaInicial)) {
                    Alerta.Erro("Data Inválida", "A Vigência Final não pode ser anterior à Vigência Inicial");
                    $('#txtVigenciaFinal').focus();
                    return false;
                }

                // ===== ANO DE VIGÊNCIA =====
                if (!$('#lstVigencia').val()) {
                    Alerta.Erro("Campo Obrigatório", "O ano de vigência é obrigatório");
                    $('#lstVigencia').focus();
                    return false;
                }

                // ===== INSTRUMENTO =====
                if (!$('#lstInstrumento').val()) {
                    Alerta.Erro("Campo Obrigatório", "Selecione o tipo de instrumento (Contrato ou Ata)");
                    $('#lstInstrumento').focus();
                    return false;
                }

                // ===== CONTRATO OU ATA =====
                if ($('#lstInstrumento').val() === '0' && !$('#EmpenhoObj_Empenho_ContratoId').val()) {
                    Alerta.Erro("Campo Obrigatório", "Selecione o Contrato");
                    $('#EmpenhoObj_Empenho_ContratoId').focus();
                    return false;
                }
                if ($('#lstInstrumento').val() === '1' && !$('#EmpenhoObj_Empenho_AtaId').val()) {
                    Alerta.Erro("Campo Obrigatório", "Selecione a Ata de Registro de Preços");
                    $('#EmpenhoObj_Empenho_AtaId').focus();
                    return false;
                }

                // ===== SALDO INICIAL =====
                const saldoInicial = parseCurrencyBR($('#SaldoInicial').val());
                if (!saldoInicial || saldoInicial === 0) {
                    Alerta.Erro("Campo Obrigatório", "O saldo inicial é obrigatório e deve ser maior que zero");
                    $('#SaldoInicial').focus();
                    return false;
                }

                return true;
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "validarFormulario", error);
                return false;
            }
        }

        // ===== SALVAR EMPENHO =====
        function salvarEmpenho() {
            try {
                return new Promise((resolve, reject) => {
                    const valorSaldoInicial = parseCurrencyBR($('#SaldoInicial').val());
                    const valorSaldoFinal = IS_EDITING
                        ? parseCurrencyBR($('#SaldoFinal').val())
                        : valorSaldoInicial;

                    let payload = {
                        NotaEmpenho: $('#txtNotaEmpenho').val(),
                        DataEmissao: $('#txtDataEmissao').val(),
                        AnoVigencia: parseInt($('#lstVigencia').val()),
                        VigenciaInicial: $('#txtVigenciaInicial').val(),
                        VigenciaFinal: $('#txtVigenciaFinal').val(),
                        SaldoInicial: valorSaldoInicial,
                        SaldoFinal: valorSaldoFinal
                    };

                    if ($('#lstInstrumento').val() === '0') {
                        payload.ContratoId = $('#EmpenhoObj_Empenho_ContratoId').val();
                    } else {
                        payload.AtaId = $('#EmpenhoObj_Empenho_AtaId').val();
                    }

                    if (IS_EDITING) {
                        payload.EmpenhoId = EMPENHO_ID;
                    }

                    const url = IS_EDITING ? "/api/Empenho/EditaEmpenho" : "/api/Empenho/InsereEmpenho";

                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(payload),
                        success: function (data) {
                            try {
                                if (data.success) {
                                    const mensagem = IS_EDITING
                                        ? "Empenho atualizado com sucesso!"
                                        : "Empenho criado com sucesso!";

                                    AppToast.show('Verde', mensagem);
                                    setTimeout(() => location.replace("/empenho"), 1000);
                                } else {
                                    AppToast.show('Vermelho', data.message || "Erro ao salvar o empenho");
                                }
                                resolve();
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarEmpenho.success", error);
                                reject(error);
                            }
                        },
                        error: function (xhr, status, error) {
                            try {
                                const message = xhr.responseJSON?.message || "Erro ao salvar o empenho. Verifique os dados e tente novamente.";
                                AppToast.show('Vermelho', message);
                                console.error("Erro ao salvar empenho:", { xhr, status, error });
                            } catch (e) {
                                Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarEmpenho.error", e);
                            }
                            reject(error);
                        }
                    });
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarEmpenho", error);
                return Promise.reject(error);
            }
        }

        // ===== SALVAR APORTE =====
        function salvarAporte() {
            try {
                const movimentacaoId = $('#hdnMovimentacaoIdAporte').val();
                const valorAporte = parseCurrencyBR($('#txtValorAporte').val());

                if (!$('#txtDataAporte').val()) {
                    Alerta.Erro("Campo Obrigatório", "Informe a data do aporte");
                    return;
                }
                if (!valorAporte || valorAporte === 0) {
                    Alerta.Erro("Campo Obrigatório", "Informe o valor do aporte");
                    return;
                }

                const payload = JSON.stringify({
                    MovimentacaoId: movimentacaoId,
                    EmpenhoId: EMPENHO_ID,
                    Descricao: $('#txtDescricaoAporte').val(),
                    Valor: valorAporte,
                    DataMovimentacao: $('#txtDataAporte').val(),
                    TipoMovimentacao: "F"
                });

                $.ajax({
                    type: "POST",
                    url: "/api/Empenho/EditarAporte",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: payload,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message || 'Aporte editado com sucesso!');

                            if (window.AporteTable) {
                                window.AporteTable.ajax.reload(null, false);
                            }

                            bootstrap.Modal.getInstance(document.getElementById('modalAporte')).hide();

                            setTimeout(() => location.reload(), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarAporte.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarAporte.error", error);
                        const message = xhr.responseJSON?.message || 'Erro ao editar aporte';
                        AppToast.show('Vermelho', message);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarAporte", error);
            }
        }

        // ===== SALVAR ANULAÇÃO =====
        function salvarAnulacao() {
            try {
                const movimentacaoId = $('#hdnMovimentacaoIdAnulacao').val();
                const valorAnulacao = parseCurrencyBR($('#txtValorAnulacao').val());

                if (!$('#txtDataAnulacao').val()) {
                    Alerta.Erro("Campo Obrigatório", "Informe a data da anulação");
                    return;
                }
                if (!valorAnulacao || valorAnulacao === 0) {
                    Alerta.Erro("Campo Obrigatório", "Informe o valor da anulação");
                    return;
                }

                const payload = JSON.stringify({
                    MovimentacaoId: movimentacaoId,
                    EmpenhoId: EMPENHO_ID,
                    Descricao: $('#txtDescricaoAnulacao').val(),
                    Valor: valorAnulacao,
                    DataMovimentacao: $('#txtDataAnulacao').val(),
                    TipoMovimentacao: "G"
                });

                $.ajax({
                    type: "POST",
                    url: "/api/Empenho/EditarAnulacao",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: payload,
                    success: function (data) {
                        try {
                            AppToast.show('Verde', data.message || 'Anulação editada com sucesso!');

                            if (window.AnulacaoTable) {
                                window.AnulacaoTable.ajax.reload(null, false);
                            }

                            bootstrap.Modal.getInstance(document.getElementById('modalAnulacao')).hide();

                            setTimeout(() => location.reload(), 1000);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarAnulacao.success", error);
                        }
                    },
                    error: function (xhr, status, error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarAnulacao.error", error);
                        const message = xhr.responseJSON?.message || 'Erro ao editar anulação';
                        AppToast.show('Vermelho', message);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "salvarAnulacao", error);
            }
        }

        // ===== HANDLERS DELEGADOS PARA EXCLUSÃO =====
        $(document).on('click', '.btn-deleteaporte', function () {
            try {
                const id = $(this).data('id');

                Alerta.Confirmar(
                    "Confirmar Exclusão",
                    "Deseja realmente excluir este aporte?",
                    "Excluir",
                    "Cancelar"
                ).then((willDelete) => {
                    try {
                        if (willDelete) {
                            $.ajax({
                                url: "/api/Empenho/DeletaAporte",
                                type: "POST",
                                data: JSON.stringify({ MovimentacaoId: id }),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    try {
                                        if (data.success) {
                                            AppToast.show('Verde', data.message);
                                            if (window.AporteTable) {
                                                window.AporteTable.ajax.reload(null, false);
                                            }
                                            setTimeout(() => location.reload(), 1000);
                                        } else {
                                            AppToast.show('Vermelho', data.message);
                                        }
                                    } catch (error) {
                                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteAporte.success", error);
                                    }
                                },
                                error: function (err) {
                                    Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteAporte.error", err);
                                    AppToast.show('Vermelho', 'Erro ao excluir o aporte');
                                }
                            });
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteAporte.then", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btn-deleteaporte.click", error);
            }
        });

        $(document).on('click', '.btn-deleteanulacao', function () {
            try {
                const id = $(this).data('id');

                Alerta.Confirmar(
                    "Confirmar Exclusão",
                    "Deseja realmente excluir esta anulação?",
                    "Excluir",
                    "Cancelar"
                ).then((willDelete) => {
                    try {
                        if (willDelete) {
                            $.ajax({
                                url: "/api/Empenho/DeletaAnulacao",
                                type: "POST",
                                data: JSON.stringify({ MovimentacaoId: id }),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    try {
                                        if (data.success) {
                                            AppToast.show('Verde', data.message);
                                            if (window.AnulacaoTable) {
                                                window.AnulacaoTable.ajax.reload(null, false);
                                            }
                                            setTimeout(() => location.reload(), 1000);
                                        } else {
                                            AppToast.show('Vermelho', data.message);
                                        }
                                    } catch (error) {
                                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteAnulacao.success", error);
                                    }
                                },
                                error: function (err) {
                                    Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteAnulacao.error", err);
                                    AppToast.show('Vermelho', 'Erro ao excluir a anulação');
                                }
                            });
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteAnulacao.then", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btn-deleteanulacao.click", error);
            }
        });

        $(document).on('click', '.btn-delete-nf', function () {
            try {
                const id = $(this).data('id');

                Alerta.Confirmar(
                    "Confirmar Exclusão",
                    "Deseja realmente excluir esta nota fiscal?",
                    "Excluir",
                    "Cancelar"
                ).then((willDelete) => {
                    try {
                        if (willDelete) {
                            $.ajax({
                                url: "/api/NotaFiscal/Delete",
                                type: "POST",
                                data: JSON.stringify({ NotaFiscalId: id }),
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    try {
                                        if (data.success) {
                                            AppToast.show('Verde', data.message);
                                            $('#tblNotaFiscal').DataTable().ajax.reload(null, false);
                                            loadSaldos();
                                        } else {
                                            AppToast.show('Vermelho', data.message);
                                        }
                                    } catch (error) {
                                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteNF.success", error);
                                    }
                                },
                                error: function (err) {
                                    Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteNF.error", err);
                                    AppToast.show('Vermelho', 'Erro ao excluir a nota fiscal');
                                }
                            });
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("Upsert.cshtml", "deleteNF.then", error);
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "btn-delete-nf.click", error);
            }
        });
    </script>
}
