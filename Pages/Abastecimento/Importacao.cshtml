@page
@model FrotiX.Pages.Abastecimentos.ImportarModel

@{
    ViewData["Title"] = "Importar Abastecimentos";
    ViewData["PageName"] = "abastecimentos_importacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-gas-pump'></i> Abastecimentos: <span class='fw-300'>Importação</span>";
    ViewData["Category1"] = "Abastecimentos";
    ViewData["PageIcon"] = "fa-duotone fa-gas-pump";
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        /* ===== DROP ZONE ===== */
        .ftx-dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            background: linear-gradient(180deg, #f8fafc, #fff);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .ftx-dropzone:hover {
            border-color: #3D5771;
            background: linear-gradient(180deg, #f1f5f9, #fff);
        }

        .ftx-dropzone.dragover {
            border-color: #3D5771;
            background: rgba(61, 87, 113, 0.05);
            box-shadow: 0 0 20px rgba(61, 87, 113, 0.15);
        }

        .ftx-dropzone.arquivo-ok {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .ftx-dropzone-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .ftx-dropzone-icon {
            font-size: 3rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .ftx-dropzone.arquivo-ok .ftx-dropzone-icon {
            color: #22c55e;
        }

        /* ===== STAT CARDS ===== */
        .stat-card-ftx {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.2s ease;
        }

        .stat-card-ftx:hover {
            transform: translateY(-2px);
        }

        .stat-card-ftx .stat-icon {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .stat-card-ftx .stat-valor {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-card-ftx .stat-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-card-ftx.stat-total .stat-icon { color: #3D5771; }
        .stat-card-ftx.stat-total .stat-valor { color: #3D5771; }

        .stat-card-ftx.stat-sucesso .stat-icon { color: #22c55e; }
        .stat-card-ftx.stat-sucesso .stat-valor { color: #22c55e; }

        .stat-card-ftx.stat-erro .stat-icon { color: #ef4444; }
        .stat-card-ftx.stat-erro .stat-valor { color: #ef4444; }

        .stat-card-ftx.stat-ignorado .stat-icon { color: #6c757d; }
        .stat-card-ftx.stat-ignorado .stat-valor { color: #6c757d; }

        /* ===== ESTADOS ===== */
        .estado-aguardando {
            padding: 3rem;
            text-align: center;
        }

        .estado-aguardando i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        /* ===== ALERT RESULTADO ===== */
        .alert-resultado {
            border: none;
            border-radius: 12px;
            padding: 1.25rem;
        }

        .alert-resultado .alert-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }

        .alert-resultado.alert-success .alert-icon {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .alert-resultado.alert-warning .alert-icon {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .alert-resultado.alert-danger .alert-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* ===== INFO BOX ===== */
        .info-box-ftx {
            background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 1rem;
        }

        .info-box-ftx h6 {
            color: #0369a1;
            font-weight: 700;
        }

        .info-box-ftx ul {
            margin-bottom: 0;
            padding-left: 1.25rem;
        }

        .info-box-ftx li {
            color: #475569;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* ===== LISTA DE ERROS ===== */
        .lista-erros-ftx {
            max-height: 400px;
            overflow-y: auto;
        }

        .lista-erros-ftx .list-group-item {
            border: none;
            border-bottom: 1px solid #f1f5f9;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .lista-erros-ftx .list-group-item:last-child {
            border-bottom: none;
        }

        .lista-erros-ftx .list-group-item.corrigido {
            animation: fadeOutSlide 0.4s ease forwards;
        }

        @@keyframes fadeOutSlide {
            to {
                opacity: 0;
                max-height: 0;
                padding: 0;
                margin: 0;
                overflow: hidden;
            }
        }

        .erro-icon-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            flex-shrink: 0;
        }

        /* Badge de tipo de erro */
        .badge-tipo-erro {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-tipo-erro.badge-erro {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .badge-tipo-erro.badge-corrigivel {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        /* Card de sugestão de correção */
        .sugestao-correcao {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .sugestao-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .sugestao-header i {
            color: #059669;
            font-size: 1rem;
        }

        .sugestao-header span {
            font-weight: 600;
            color: #065f46;
            font-size: 0.85rem;
        }

        .sugestao-valores {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .sugestao-valor {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            min-width: 80px;
        }

        .sugestao-valor.valor-errado {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #fecaca;
        }

        .sugestao-valor.valor-errado .valor-numero {
            color: #dc2626;
            text-decoration: line-through;
        }

        .sugestao-valor.valor-correto {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid #86efac;
        }

        .sugestao-valor.valor-correto .valor-numero {
            color: #16a34a;
            font-weight: 700;
        }

        .sugestao-valor .valor-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.3px;
        }

        .sugestao-valor .valor-numero {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sugestao-seta {
            color: #22c55e;
            font-size: 1.25rem;
        }

        .sugestao-justificativa {
            font-size: 0.75rem;
            color: #475569;
            font-style: italic;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #a7f3d0;
        }

        .btn-aplicar-correcao {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border: none;
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-aplicar-correcao:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-aplicar-correcao:active {
            transform: translateY(0);
        }

        .btn-aplicar-correcao i {
            font-size: 0.9rem;
        }

        .btn-aplicar-correcao.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Stat card para linhas corrigíveis */
        .stat-card-ftx.stat-corrigivel .stat-icon { color: #059669; }
        .stat-card-ftx.stat-corrigivel .stat-valor { color: #059669; }

        /* ===== TABELA IMPORTADOS ===== */
        .tabela-importados-container {
            max-height: 350px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .tabela-importados-container thead {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 1;
        }

        /* ===== BARRA DE PROGRESSO ===== */
        .ftx-progress-container {
            width: 100%;
            max-width: 400px;
            margin: 1.5rem auto;
        }

        .ftx-progress-bar {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .ftx-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3D5771, #5a7a9a, #3D5771);
            background-size: 200% 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
            animation: progressShine 1.5s ease-in-out infinite;
        }

        @@keyframes progressShine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .ftx-progress-text {
            text-align: center;
            margin-top: 0.75rem;
            font-weight: 600;
            color: #3D5771;
        }

        .ftx-progress-detail {
            text-align: center;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        /* ===== CARD RESUMO PLANILHA ===== */
        .resumo-planilha-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            max-width: 500px;
            margin: 0 auto;
            animation: fadeInUp 0.4s ease-out;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .resumo-header {
            background: linear-gradient(135deg, #3D5771 0%, #5a7a9a 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .resumo-header i {
            font-size: 1.1rem;
        }

        .resumo-body {
            padding: 1rem;
        }

        .resumo-periodo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #cbd5e1;
        }

        .resumo-periodo-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .resumo-periodo-item i {
            font-size: 1.5rem;
        }

        .resumo-periodo-item small {
            display: block;
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .resumo-periodo-item strong {
            display: block;
            font-size: 1rem;
            color: #1e293b;
        }

        .resumo-periodo-seta {
            color: #94a3b8;
            font-size: 1rem;
        }

        .resumo-stats {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
        }

        .resumo-stat {
            text-align: center;
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 70px;
        }

        .resumo-stat-valor {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .resumo-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
        }

        .resumo-stat-total {
            background: rgba(59, 130, 246, 0.1);
        }
        .resumo-stat-total .resumo-stat-valor {
            color: #3b82f6;
        }

        .resumo-stat-gasolina {
            background: rgba(34, 197, 94, 0.1);
        }
        .resumo-stat-gasolina .resumo-stat-valor {
            color: #22c55e;
        }

        .resumo-stat-diesel {
            background: rgba(245, 158, 11, 0.1);
        }
        .resumo-stat-diesel .resumo-stat-valor {
            color: #f59e0b;
        }

        .resumo-stat-outros {
            background: rgba(107, 114, 128, 0.1);
        }
        .resumo-stat-outros .resumo-stat-valor {
            color: #6b7280;
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel ftx-card-styled">
            <div class="panel-container show">

                <!-- Header Padrão FrotiX -->
                <div class="ftx-card-header">
                    <h2 class="titulo-paginas mb-0">
                        <i class="fa-duotone fa-gas-pump"></i>
                        Importar Abastecimentos
                    </h2>
                </div>

                <div class="panel-content">
                    <div class="row">
                        <!-- Painel de Upload -->
                        <div class="col-lg-5 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom py-3">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fa-duotone fa-cloud-arrow-up text-primary me-2"></i>
                                        Upload de Planilha
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Área de Drop -->
                                    <div class="mb-4">
                                        <label class="form-label fw-semibold">
                                            <i class="fa-duotone fa-file-excel text-success me-2"></i>
                                            Arquivo Excel
                                        </label>
                                        <div id="dropZone" class="ftx-dropzone">
                                            <input type="file" id="arquivoExcel" accept=".xlsx,.xls" class="ftx-dropzone-input" />
                                            <div id="dropZoneContent">
                                                <i class="fa-duotone fa-cloud-arrow-up ftx-dropzone-icon"></i>
                                                <p class="mb-1 fw-semibold">Arraste o arquivo aqui</p>
                                                <p class="text-muted small mb-2">ou clique para selecionar</p>
                                                <span class="badge bg-light text-dark border">.xlsx ou .xls</span>
                                            </div>
                                            <div id="arquivoSelecionado" class="d-none">
                                                <i class="fa-duotone fa-file-excel ftx-dropzone-icon"></i>
                                                <p class="mb-1 fw-semibold text-success" id="nomeArquivo"></p>
                                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="btnRemoverArquivo">
                                                    <i class="fa-duotone fa-xmark me-1"></i>Remover
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botão Importar -->
                                    <button type="button" id="btnImportar" class="btn btn-fundo-laranja btn-lg w-100" disabled>
                                        <i class="fa-duotone fa-upload me-2"></i>
                                        Importar Abastecimentos
                                    </button>

                                    <!-- Info Box -->
                                    <div class="info-box-ftx mt-4">
                                        <h6>
                                            <i class="fa-duotone fa-lightbulb me-2"></i>Informações
                                        </h6>
                                        <hr class="my-2">
                                        <ul>
                                            <li>Colunas obrigatórias: Autorização, <strong>Data</strong>, <strong>Hora</strong>, Placa, KM, Produto, Qtde, Valor Unitário, Rodado, CodMotorista, KMAnterior</li>
                                            <li>Produtos aceitos: <strong>Gasolina Comum</strong> e <strong>Diesel S-10</strong></li>
                                            <li>Outros produtos (ARLA, etc) serão ignorados</li>
                                            <li>Limite máximo: 500 litros por abastecimento</li>
                                            <li>Limite máximo: 1.000 km rodados</li>
                                            <li><strong class="text-success">A data/hora é lida diretamente da planilha</strong></li>
                                            <li>Linhas válidas são importadas, erros geram arquivo para correção</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Painel de Resultado -->
                        <div class="col-lg-7 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom py-3">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fa-duotone fa-clipboard-list text-primary me-2"></i>
                                        Resultado da Importação
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Estado Inicial -->
                                    <div id="estadoInicial" class="estado-aguardando">
                                        <i class="fa-duotone fa-inbox"></i>
                                        <h5 class="text-muted">Aguardando importação</h5>
                                        <p class="text-muted mb-0">Selecione o arquivo para começar</p>
                                    </div>

                                    <!-- Loading com Barra de Progresso -->
                                    <div id="estadoLoading" class="estado-aguardando d-none">
                                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                                            <span class="visually-hidden">Processando...</span>
                                        </div>
                                        <h5 class="text-primary mb-1" id="progressEtapa">Iniciando importação...</h5>
                                        <p class="text-muted mb-3" id="progressDetail">Preparando...</p>
                                        
                                        <div class="ftx-progress-container">
                                            <div class="ftx-progress-bar">
                                                <div class="ftx-progress-fill" id="progressFill" style="width: 0%"></div>
                                            </div>
                                            <div class="ftx-progress-text" id="progressText">0%</div>
                                        </div>

                                        <!-- Card de Resumo da Planilha (aparece após análise) -->
                                        <div id="resumoPlanilha" class="d-none mt-4">
                                            <div class="resumo-planilha-card">
                                                <div class="resumo-header">
                                                    <i class="fa-duotone fa-file-spreadsheet"></i>
                                                    <span>Resumo da Planilha</span>
                                                </div>
                                                <div class="resumo-body">
                                                    <div class="resumo-periodo">
                                                        <div class="resumo-periodo-item">
                                                            <i class="fa-duotone fa-calendar-arrow-down text-success"></i>
                                                            <div>
                                                                <small>Data Inicial</small>
                                                                <strong id="resumoDataInicial">--/--/----</strong>
                                                            </div>
                                                        </div>
                                                        <div class="resumo-periodo-seta">
                                                            <i class="fa-duotone fa-arrow-right"></i>
                                                        </div>
                                                        <div class="resumo-periodo-item">
                                                            <i class="fa-duotone fa-calendar-arrow-up text-danger"></i>
                                                            <div>
                                                                <small>Data Final</small>
                                                                <strong id="resumoDataFinal">--/--/----</strong>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="resumo-stats">
                                                        <div class="resumo-stat resumo-stat-total">
                                                            <div class="resumo-stat-valor" id="resumoTotal">0</div>
                                                            <div class="resumo-stat-label">Total</div>
                                                        </div>
                                                        <div class="resumo-stat resumo-stat-gasolina">
                                                            <div class="resumo-stat-valor" id="resumoGasolina">0</div>
                                                            <div class="resumo-stat-label">Gasolina</div>
                                                        </div>
                                                        <div class="resumo-stat resumo-stat-diesel">
                                                            <div class="resumo-stat-valor" id="resumoDiesel">0</div>
                                                            <div class="resumo-stat-label">Diesel</div>
                                                        </div>
                                                        <div class="resumo-stat resumo-stat-outros">
                                                            <div class="resumo-stat-valor" id="resumoOutros">0</div>
                                                            <div class="resumo-stat-label">Outros</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resultado Sucesso Total -->
                                    <div id="estadoSucesso" class="d-none">
                                        <div class="alert alert-resultado alert-success d-flex align-items-center gap-3 mb-4">
                                            <div class="alert-icon">
                                                <i class="fa-duotone fa-circle-check"></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading mb-1">Importação Concluída!</h5>
                                                <p class="mb-0" id="msgSucesso"></p>
                                            </div>
                                        </div>

                                        <!-- Estatísticas -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-total">
                                                    <i class="fa-duotone fa-file-lines stat-icon"></i>
                                                    <div class="stat-valor" id="statTotal">0</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-sucesso">
                                                    <i class="fa-duotone fa-check stat-icon"></i>
                                                    <div class="stat-valor" id="statImportados">0</div>
                                                    <div class="stat-label">Importados</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-ignorado">
                                                    <i class="fa-duotone fa-filter stat-icon"></i>
                                                    <div class="stat-valor" id="statIgnorados">0</div>
                                                    <div class="stat-label">Ignorados</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tabela de Importados -->
                                        <div class="tabela-importados-container">
                                            <table class="table table-sm table-hover mb-0" id="tblImportados">
                                                <thead>
                                                    <tr>
                                                        <th>Data/Hora</th>
                                                        <th>Placa</th>
                                                        <th>Motorista</th>
                                                        <th>Produto</th>
                                                        <th class="text-end">Qtde</th>
                                                        <th class="text-end">Km</th>
                                                        <th class="text-end">Consumo</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyImportados"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Resultado Parcial -->
                                    <div id="estadoParcial" class="d-none">
                                        <div class="alert alert-resultado alert-warning d-flex align-items-center gap-3 mb-4">
                                            <div class="alert-icon">
                                                <i class="fa-duotone fa-triangle-exclamation"></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading mb-1">Importação Parcial</h5>
                                                <p class="mb-0" id="msgParcial"></p>
                                            </div>
                                        </div>

                                        <!-- Estatísticas Parcial -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-total">
                                                    <i class="fa-duotone fa-file-lines stat-icon"></i>
                                                    <div class="stat-valor" id="statTotalParcial">0</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-sucesso">
                                                    <i class="fa-duotone fa-check stat-icon"></i>
                                                    <div class="stat-valor" id="statImportadosParcial">0</div>
                                                    <div class="stat-label">Importados</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-erro">
                                                    <i class="fa-duotone fa-xmark stat-icon"></i>
                                                    <div class="stat-valor" id="statErrosParcial">0</div>
                                                    <div class="stat-label">Com Erro</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-ignorado">
                                                    <i class="fa-duotone fa-filter stat-icon"></i>
                                                    <div class="stat-valor" id="statIgnoradosParcial">0</div>
                                                    <div class="stat-label">Ignorados</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Botão Acessar Pendências -->
                                        <div class="d-grid gap-2 mb-4">
                                            <a href="/Abastecimento/Pendencias" class="btn btn-terracota btn-lg">
                                                <i class="fa-duotone fa-clipboard-list-check me-2"></i>
                                                Acessar Pendências para Correção
                                            </a>
                                        </div>

                                        <!-- Lista de Erros -->
                                        <h6 class="mb-3 fw-bold">
                                            <i class="fa-duotone fa-bug text-danger me-2"></i>
                                            Resumo dos Erros
                                        </h6>
                                        <div class="list-group lista-erros-ftx" id="listaErrosParcial"></div>
                                    </div>

                                    <!-- Resultado Erro Total -->
                                    <div id="estadoErro" class="d-none">
                                        <div class="alert alert-resultado alert-danger d-flex align-items-center gap-3 mb-4">
                                            <div class="alert-icon">
                                                <i class="fa-duotone fa-circle-xmark"></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading mb-1">Nenhum Registro Importado</h5>
                                                <p class="mb-0" id="msgErro"></p>
                                            </div>
                                        </div>

                                        <!-- Estatísticas de Erro -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-total">
                                                    <i class="fa-duotone fa-file-lines stat-icon"></i>
                                                    <div class="stat-valor" id="statTotalErro">0</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-erro">
                                                    <i class="fa-duotone fa-triangle-exclamation stat-icon"></i>
                                                    <div class="stat-valor" id="statErros">0</div>
                                                    <div class="stat-label">Com Erro</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-ignorado">
                                                    <i class="fa-duotone fa-filter stat-icon"></i>
                                                    <div class="stat-valor" id="statIgnoradosErro">0</div>
                                                    <div class="stat-label">Ignorados</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Botão Acessar Pendências -->
                                        <div class="d-grid gap-2 mb-4">
                                            <a href="/Abastecimento/Pendencias" class="btn btn-terracota btn-lg">
                                                <i class="fa-duotone fa-clipboard-list-check me-2"></i>
                                                Acessar Pendências para Correção
                                            </a>
                                        </div>

                                        <!-- Lista de Erros -->
                                        <h6 class="mb-3 fw-bold">
                                            <i class="fa-duotone fa-bug text-danger me-2"></i>
                                            Detalhes dos Erros
                                        </h6>
                                        <div class="list-group lista-erros-ftx" id="listaErros"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <!-- SignalR -->
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js" asp-append-version="true"></script>

    <script asp-append-version="true">
        (function () {
            'use strict';

            // ===== ELEMENTOS DO DOM =====
            const arquivoExcel = document.getElementById('arquivoExcel');
            const dropZone = document.getElementById('dropZone');
            const dropZoneContent = document.getElementById('dropZoneContent');
            const arquivoSelecionado = document.getElementById('arquivoSelecionado');
            const nomeArquivo = document.getElementById('nomeArquivo');
            const btnRemoverArquivo = document.getElementById('btnRemoverArquivo');
            const btnImportar = document.getElementById('btnImportar');

            const estadoInicial = document.getElementById('estadoInicial');
            const estadoLoading = document.getElementById('estadoLoading');
            const estadoSucesso = document.getElementById('estadoSucesso');
            const estadoParcial = document.getElementById('estadoParcial');
            const estadoErro = document.getElementById('estadoErro');

            // Elementos da barra de progresso
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressEtapa = document.getElementById('progressEtapa');
            const progressDetail = document.getElementById('progressDetail');

            // Elementos do resumo da planilha
            const resumoPlanilha = document.getElementById('resumoPlanilha');
            const resumoDataInicial = document.getElementById('resumoDataInicial');
            const resumoDataFinal = document.getElementById('resumoDataFinal');
            const resumoTotal = document.getElementById('resumoTotal');
            const resumoGasolina = document.getElementById('resumoGasolina');
            const resumoDiesel = document.getElementById('resumoDiesel');
            const resumoOutros = document.getElementById('resumoOutros');

            let arquivoAtual = null;

            // ===== SIGNALR =====
            let hubConnection = null;
            let connectionId = null;

            async function inicializarSignalR() {
                try {
                    hubConnection = new signalR.HubConnectionBuilder()
                        .withUrl("/hubs/importacao")
                        .withAutomaticReconnect()
                        .build();

                    // Evento: Conexão estabelecida
                    hubConnection.on("Conectado", (connId) => {
                        connectionId = connId;
                        console.log("SignalR conectado:", connectionId);
                    });

                    // Evento: Receber progresso
                    hubConnection.on("ProgressoImportacao", (progresso) => {
                        try {
                            // Atualizar etapa (título) e progresso
                            atualizarProgresso(progresso.porcentagem, progresso.etapa, progresso.detalhe);

                            // Se tem info de linhas, mostrar detalhes com contagem
                            if (progresso.totalLinhas > 0 && !progresso.resumoDisponivel) {
                                progressDetail.textContent = `${progresso.detalhe} (${progresso.linhaAtual}/${progresso.totalLinhas})`;
                            }

                            // Se recebeu resumo da planilha, exibir card
                            if (progresso.resumoDisponivel) {
                                mostrarResumoPlanilha(progresso);
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha('Importacao.cshtml', 'ProgressoImportacao', error);
                        }
                    });

                    // Iniciar conexão
                    await hubConnection.start();
                    console.log("SignalR iniciado");

                } catch (error) {
                    console.error("Erro ao conectar SignalR:", error);
                    // Continua funcionando sem SignalR (fallback para progresso simulado)
                }
            }

            function mostrarResumoPlanilha(progresso) {
                try {
                    resumoDataInicial.textContent = progresso.dataInicial || '--/--/----';
                    resumoDataFinal.textContent = progresso.dataFinal || '--/--/----';
                    resumoTotal.textContent = progresso.totalRegistros || 0;
                    resumoGasolina.textContent = progresso.registrosGasolina || 0;
                    resumoDiesel.textContent = progresso.registrosDiesel || 0;
                    resumoOutros.textContent = progresso.registrosOutros || 0;
                    resumoPlanilha.classList.remove('d-none');
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarResumoPlanilha', error);
                }
            }

            function ocultarResumoPlanilha() {
                try {
                    resumoPlanilha.classList.add('d-none');
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'ocultarResumoPlanilha', error);
                }
            }

            function init() {
                try {
                    inicializarSignalR();
                    configurarEventos();
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'init', error);
                }
            }

            function configurarEventos() {
                try {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('dragover');
                    });

                    dropZone.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');
                    });

                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');

                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            selecionarArquivo(files[0]);
                        }
                    });

                    arquivoExcel.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            selecionarArquivo(e.target.files[0]);
                        }
                    });

                    btnRemoverArquivo.addEventListener('click', removerArquivo);
                    btnImportar.addEventListener('click', importar);

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'configurarEventos', error);
                }
            }

            // Cria HTML para um item de erro (com ou sem sugestão de correção)
            function criarItemErro(erro, index) {
                try {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.id = `erro-item-${index}`;

                    // Badge: vermelho para erro, verde para corrigível
                    const badgeClass = erro.corrigivel ? 'badge-corrigivel' : 'badge-erro';
                    const badgeText = erro.corrigivel ? 'sugestão' : erro.tipo;

                    let html = `
                        <div class="d-flex align-items-start gap-3">
                            <div class="erro-icon-circle">
                                <i class="fa-solid ${erro.icone}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong class="text-danger">Linha ${erro.linhaArquivoErros} (original: ${erro.linhaOriginal})</strong>
                                    <div class="d-flex gap-2">
                                        <span class="badge-tipo-erro badge-erro">${erro.tipo}</span>
                                        ${erro.corrigivel ? '<span class="badge-tipo-erro badge-corrigivel"><i class="fa-duotone fa-wand-magic-sparkles me-1"></i>sugestão</span>' : ''}
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small">${erro.descricao}</p>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <strong>Placa:</strong> ${erro.placa || '-'} | 
                                        <strong>Aut:</strong> ${erro.autorizacao || '-'} |
                                        <strong>KM Ant:</strong> ${erro.kmAnterior?.toLocaleString('pt-BR') || '-'} |
                                        <strong>KM:</strong> ${erro.km?.toLocaleString('pt-BR') || '-'}
                                    </small>
                                </div>
                    `;

                    // Se tem sugestão de correção
                    if (erro.corrigivel) {
                        const campoLabel = erro.campoCorrecao === 'KmAnterior' ? 'KM Anterior' : 'KM Atual';
                        
                        html += `
                                <div class="sugestao-correcao">
                                    <div class="sugestao-header">
                                        <i class="fa-duotone fa-lightbulb-on"></i>
                                        <span>Sugestão de Correção: ${campoLabel}</span>
                                    </div>
                                    <div class="sugestao-valores">
                                        <div class="sugestao-valor valor-errado">
                                            <span class="valor-label">Atual (errado)</span>
                                            <span class="valor-numero">${erro.valorAtual?.toLocaleString('pt-BR')}</span>
                                        </div>
                                        <i class="fa-duotone fa-arrow-right sugestao-seta"></i>
                                        <div class="sugestao-valor valor-correto">
                                            <span class="valor-label">Sugerido</span>
                                            <span class="valor-numero">${erro.valorSugerido?.toLocaleString('pt-BR')}</span>
                                        </div>
                                    </div>
                                    <div class="sugestao-justificativa">
                                        ${erro.justificativaSugestao}
                                    </div>
                                    <button type="button" class="btn-aplicar-correcao" onclick="aplicarCorrecao(${index}, this)">
                                        <i class="fa-duotone fa-check"></i>
                                        Aplicar e Importar
                                    </button>
                                </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;

                    item.innerHTML = html;
                    return item;

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'criarItemErro', error);
                    return null;
                }
            }

            // Armazena os erros para referência na correção
            let errosAtuais = [];

            // Aplica correção sugerida via API
            async function aplicarCorrecao(index, btnElement) {
                try {
                    const erro = errosAtuais[index];
                    if (!erro || !erro.corrigivel) {
                        AppToast.show('Vermelho', 'Erro não disponível para correção', 4000);
                        return;
                    }

                    // Desabilitar botão
                    btnElement.classList.add('loading');
                    btnElement.innerHTML = '<i class="fa-duotone fa-spinner fa-spin"></i> Aplicando...';

                    const response = await fetch('/api/Abastecimento/AplicarCorrecao', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            autorizacao: erro.autorizacao,
                            placa: erro.placa,
                            kmAnterior: erro.kmAnterior,
                            km: erro.km,
                            litros: erro.litros,
                            veiculoId: erro.veiculoId,
                            motoristaId: erro.motoristaId,
                            combustivelId: erro.combustivelId,
                            dataHora: erro.dataHora,
                            valorUnitario: erro.valorUnitario,
                            campoCorrecao: erro.campoCorrecao,
                            valorCorrigido: erro.valorSugerido
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        AppToast.show('Verde', result.message, 5000);
                        
                        // Animar e remover item da lista
                        const item = document.getElementById(`erro-item-${index}`);
                        if (item) {
                            item.classList.add('corrigido');
                            setTimeout(() => item.remove(), 400);
                        }

                        // Atualizar contadores
                        atualizarContadoresAposCorrecao();

                    } else {
                        AppToast.show('Vermelho', result.message || 'Erro ao aplicar correção', 5000);
                        btnElement.classList.remove('loading');
                        btnElement.innerHTML = '<i class="fa-duotone fa-check"></i> Aplicar e Importar';
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'aplicarCorrecao', error);
                    AppToast.show('Vermelho', 'Erro ao aplicar correção', 4000);
                    btnElement.classList.remove('loading');
                    btnElement.innerHTML = '<i class="fa-duotone fa-check"></i> Aplicar e Importar';
                }
            }

            // Atualiza contadores após correção bem-sucedida
            function atualizarContadoresAposCorrecao() {
                try {
                    // Parcial
                    const statImportadosParcial = document.getElementById('statImportadosParcial');
                    const statErrosParcial = document.getElementById('statErrosParcial');
                    if (statImportadosParcial && !statImportadosParcial.closest('.d-none')) {
                        statImportadosParcial.textContent = parseInt(statImportadosParcial.textContent || 0) + 1;
                        statErrosParcial.textContent = Math.max(0, parseInt(statErrosParcial.textContent || 0) - 1);
                    }

                    // Erro total
                    const statErros = document.getElementById('statErros');
                    const statImportadosErro = document.getElementById('statImportadosErro');
                    if (statErros && !statErros.closest('.d-none')) {
                        statErros.textContent = Math.max(0, parseInt(statErros.textContent || 0) - 1);
                        if (statImportadosErro) {
                            statImportadosErro.textContent = parseInt(statImportadosErro.textContent || 0) + 1;
                        }
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'atualizarContadoresAposCorrecao', error);
                }
            }

            // Faz aplicarCorrecao disponível globalmente
            window.aplicarCorrecao = aplicarCorrecao;

            function atualizarProgresso(pct, etapa, detalhe) {
                try {
                    const porcentagem = Math.min(Math.round(pct), 100);
                    progressFill.style.width = porcentagem + '%';
                    progressText.textContent = porcentagem + '%';
                    
                    // Atualizar título da etapa
                    if (etapa) {
                        progressEtapa.textContent = etapa;
                    }
                    
                    // Atualizar detalhe
                    if (detalhe) {
                        progressDetail.textContent = detalhe;
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'atualizarProgresso', error);
                }
            }

            function selecionarArquivo(file) {
                try {
                    const extensao = file.name.split('.').pop().toLowerCase();
                    if (extensao !== 'xlsx' && extensao !== 'xls') {
                        AppToast.show('Amarelo', 'Selecione um arquivo Excel (.xlsx ou .xls)', 4000);
                        return;
                    }

                    arquivoAtual = file;
                    nomeArquivo.textContent = file.name;
                    dropZoneContent.classList.add('d-none');
                    arquivoSelecionado.classList.remove('d-none');
                    dropZone.classList.add('arquivo-ok');

                    atualizarBotaoImportar();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'selecionarArquivo', error);
                }
            }

            function removerArquivo() {
                try {
                    arquivoAtual = null;
                    arquivoExcel.value = '';
                    dropZoneContent.classList.remove('d-none');
                    arquivoSelecionado.classList.add('d-none');
                    dropZone.classList.remove('arquivo-ok');

                    atualizarBotaoImportar();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'removerArquivo', error);
                }
            }

            function atualizarBotaoImportar() {
                try {
                    btnImportar.disabled = arquivoAtual === null;
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'atualizarBotaoImportar', error);
                }
            }

            async function importar() {
                try {
                    mostrarEstado('loading');
                    ocultarResumoPlanilha(); // Resetar resumo para nova importação
                    atualizarProgresso(0, 'Iniciando importação...', 'Preparando envio do arquivo...');

                    const formData = new FormData();
                    formData.append('arquivo', arquivoAtual);

                    // Enviar connectionId do SignalR para o servidor
                    if (connectionId) {
                        formData.append('connectionId', connectionId);
                    }

                    const response = await fetch('/api/Abastecimento/ImportarNovo', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    // Pequeno delay para garantir que a barra chegou em 100%
                    await new Promise(resolve => setTimeout(resolve, 300));

                    if (result.sucesso && result.linhasComErro === 0) {
                        mostrarSucesso(result);
                    } else if (result.sucesso && result.linhasComErro > 0) {
                        mostrarParcial(result);
                    } else {
                        mostrarErro(result);
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'importar', error);
                    mostrarEstado('inicial');
                    AppToast.show('Vermelho', 'Erro ao processar importação', 5000);
                }
            }

            function mostrarEstado(estado) {
                try {
                    estadoInicial.classList.add('d-none');
                    estadoLoading.classList.add('d-none');
                    estadoSucesso.classList.add('d-none');
                    estadoParcial.classList.add('d-none');
                    estadoErro.classList.add('d-none');

                    switch (estado) {
                        case 'inicial':
                            estadoInicial.classList.remove('d-none');
                            break;
                        case 'loading':
                            estadoLoading.classList.remove('d-none');
                            break;
                        case 'sucesso':
                            estadoSucesso.classList.remove('d-none');
                            break;
                        case 'parcial':
                            estadoParcial.classList.remove('d-none');
                            break;
                        case 'erro':
                            estadoErro.classList.remove('d-none');
                            break;
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarEstado', error);
                }
            }

            function mostrarSucesso(result) {
                try {
                    mostrarEstado('sucesso');

                    document.getElementById('msgSucesso').textContent = result.mensagem;
                    document.getElementById('statTotal').textContent = result.totalLinhas;
                    document.getElementById('statImportados').textContent = result.linhasImportadas;
                    document.getElementById('statIgnorados').textContent = result.linhasIgnoradas;

                    const tbody = document.getElementById('tbodyImportados');
                    tbody.innerHTML = '';

                    if (result.linhasImportadasLista && result.linhasImportadasLista.length > 0) {
                        result.linhasImportadasLista.forEach(linha => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><small class="text-muted">${linha.dataHora}</small></td>
                                <td><span class="badge bg-secondary">${linha.placa}</span></td>
                                <td>${linha.motorista || '-'}</td>
                                <td>
                                    <span class="badge ${linha.produto === 'Gasolina Comum' ? 'bg-warning text-dark' : 'bg-dark'}">
                                        ${linha.produto}
                                    </span>
                                </td>
                                <td class="text-end">${linha.quantidade}</td>
                                <td class="text-end">${linha.kmRodado}</td>
                                <td class="text-end"><strong>${linha.consumo}</strong></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }

                    AppToast.show('Verde', 'Importação concluída com sucesso!', 5000);
                    removerArquivo();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarSucesso', error);
                }
            }

            function mostrarParcial(result) {
                try {
                    mostrarEstado('parcial');

                    document.getElementById('msgParcial').textContent = result.mensagem;
                    document.getElementById('statTotalParcial').textContent = result.totalLinhas;
                    document.getElementById('statImportadosParcial').textContent = result.linhasImportadas;
                    document.getElementById('statErrosParcial').textContent = result.linhasComErro;
                    document.getElementById('statIgnoradosParcial').textContent = result.linhasIgnoradas;

                    const listaErros = document.getElementById('listaErrosParcial');
                    listaErros.innerHTML = '';

                    // Armazenar erros para referência na correção
                    errosAtuais = result.erros || [];

                    if (errosAtuais.length > 0) {
                        errosAtuais.forEach((erro, index) => {
                            const item = criarItemErro(erro, index);
                            if (item) listaErros.appendChild(item);
                        });
                    }

                    // Mostrar quantidade corrigível se houver
                    const corrigiveis = errosAtuais.filter(e => e.corrigivel).length;
                    if (corrigiveis > 0) {
                        AppToast.show('Amarelo', `${result.linhasImportadas} importados, ${result.linhasComErro} pendência(s) gerada(s). Acesse a tela de Pendências.`, 6000);
                    } else {
                        AppToast.show('Amarelo', `${result.linhasImportadas} importados, ${result.linhasComErro} pendência(s) gerada(s)`, 5000);
                    }
                    removerArquivo();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarParcial', error);
                }
            }

            function mostrarErro(result) {
                try {
                    mostrarEstado('erro');

                    document.getElementById('msgErro').textContent = result.mensagem;
                    document.getElementById('statTotalErro').textContent = result.totalLinhas;
                    document.getElementById('statErros').textContent = result.linhasComErro;
                    document.getElementById('statIgnoradosErro').textContent = result.linhasIgnoradas || 0;

                    const listaErros = document.getElementById('listaErros');
                    listaErros.innerHTML = '';

                    // Armazenar erros para referência na correção
                    errosAtuais = result.erros || [];

                    if (errosAtuais.length > 0) {
                        errosAtuais.forEach((erro, index) => {
                            const item = criarItemErro(erro, index);
                            if (item) listaErros.appendChild(item);
                        });
                    }

                    // Mostrar quantidade corrigível se houver
                    const corrigiveis = errosAtuais.filter(e => e.corrigivel).length;
                    if (corrigiveis > 0) {
                        AppToast.show('Vermelho', `Nenhum registro importado. ${result.linhasComErro} pendência(s) gerada(s). Acesse a tela de Pendências.`, 6000);
                    } else {
                        AppToast.show('Vermelho', `Nenhum registro importado. ${result.linhasComErro} pendência(s) gerada(s).`, 5000);
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarErro', error);
                }
            }

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
}
