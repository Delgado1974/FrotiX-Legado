@page
@model FrotiX.Pages.Abastecimentos.ImportarModel

@{
    ViewData["Title"] = "Importar Abastecimentos";
    ViewData["PageName"] = "abastecimentos_importacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-gas-pump'></i> Abastecimentos: <span class='fw-300'>Importa√ß√£o</span>";
    ViewData["Category1"] = "Abastecimentos";
    ViewData["PageIcon"] = "fa-duotone fa-gas-pump";
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        /* ===== DROP ZONE ===== */
        .ftx-dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            background: linear-gradient(180deg, #f8fafc, #fff);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .ftx-dropzone:hover {
            border-color: #3D5771;
            background: linear-gradient(180deg, #f1f5f9, #fff);
        }

        .ftx-dropzone.dragover {
            border-color: #3D5771;
            background: rgba(61, 87, 113, 0.05);
            box-shadow: 0 0 20px rgba(61, 87, 113, 0.15);
        }

        .ftx-dropzone.arquivo-ok {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
        }

        .ftx-dropzone-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .ftx-dropzone-icon {
            font-size: 3rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .ftx-dropzone.arquivo-ok .ftx-dropzone-icon {
            color: #22c55e;
        }

        /* ===== DROP ZONE SMALL (para dual upload) ===== */
        .ftx-dropzone-small {
            padding: 1.25rem;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ftx-dropzone-icon-small {
            font-size: 2rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .ftx-dropzone-small.arquivo-ok .ftx-dropzone-icon-small {
            color: #22c55e;
        }

        /* ===== STAT CARDS ===== */
        .stat-card-ftx {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.2s ease;
        }

        .stat-card-ftx:hover {
            transform: translateY(-2px);
        }

        .stat-card-ftx .stat-icon {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .stat-card-ftx .stat-valor {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-card-ftx .stat-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-card-ftx.stat-total .stat-icon { color: #3D5771; }
        .stat-card-ftx.stat-total .stat-valor { color: #3D5771; }

        .stat-card-ftx.stat-sucesso .stat-icon { color: #22c55e; }
        .stat-card-ftx.stat-sucesso .stat-valor { color: #22c55e; }

        .stat-card-ftx.stat-erro .stat-icon { color: #ef4444; }
        .stat-card-ftx.stat-erro .stat-valor { color: #ef4444; }

        .stat-card-ftx.stat-ignorado .stat-icon { color: #6c757d; }
        .stat-card-ftx.stat-ignorado .stat-valor { color: #6c757d; }

        /* ===== ESTADOS ===== */
        .estado-aguardando {
            padding: 3rem;
            text-align: center;
        }

        .estado-aguardando i {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        /* ===== ALERT RESULTADO ===== */
        .alert-resultado {
            border: none;
            border-radius: 12px;
            padding: 1.25rem;
        }

        .alert-resultado .alert-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }

        .alert-resultado.alert-success .alert-icon {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .alert-resultado.alert-warning .alert-icon {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .alert-resultado.alert-danger .alert-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* ===== INFO BOX ===== */
        .info-box-ftx {
            background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 1rem;
        }

        .info-box-ftx h6 {
            color: #0369a1;
            font-weight: 700;
        }

        .info-box-ftx ul {
            margin-bottom: 0;
            padding-left: 1.25rem;
        }

        .info-box-ftx li {
            color: #475569;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* ===== LISTA DE ERROS ===== */
        .lista-erros-ftx {
            max-height: 400px;
            overflow-y: auto;
        }

        .lista-erros-ftx .list-group-item {
            border: none;
            border-bottom: 1px solid #f1f5f9;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .lista-erros-ftx .list-group-item:last-child {
            border-bottom: none;
        }

        .lista-erros-ftx .list-group-item.corrigido {
            animation: fadeOutSlide 0.4s ease forwards;
        }

        @@keyframes fadeOutSlide {
            to {
                opacity: 0;
                max-height: 0;
                padding: 0;
                margin: 0;
                overflow: hidden;
            }
        }

        .erro-icon-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
            flex-shrink: 0;
        }

        /* Badge de tipo de erro */
        .badge-tipo-erro {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-tipo-erro.badge-erro {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .badge-tipo-erro.badge-corrigivel {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        /* Card de sugest√£o de corre√ß√£o */
        .sugestao-correcao {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .sugestao-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .sugestao-header i {
            color: #059669;
            font-size: 1rem;
        }

        .sugestao-header span {
            font-weight: 600;
            color: #065f46;
            font-size: 0.85rem;
        }

        .sugestao-valores {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .sugestao-valor {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            min-width: 80px;
        }

        .sugestao-valor.valor-errado {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #fecaca;
        }

        .sugestao-valor.valor-errado .valor-numero {
            color: #dc2626;
            text-decoration: line-through;
        }

        .sugestao-valor.valor-correto {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid #86efac;
        }

        .sugestao-valor.valor-correto .valor-numero {
            color: #16a34a;
            font-weight: 700;
        }

        .sugestao-valor .valor-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.3px;
        }

        .sugestao-valor .valor-numero {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sugestao-seta {
            color: #22c55e;
            font-size: 1.25rem;
        }

        .sugestao-justificativa {
            font-size: 0.75rem;
            color: #475569;
            font-style: italic;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #a7f3d0;
        }

        .btn-aplicar-correcao {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border: none;
            color: white;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-aplicar-correcao:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-aplicar-correcao:active {
            transform: translateY(0);
        }

        .btn-aplicar-correcao i {
            font-size: 0.9rem;
        }

        .btn-aplicar-correcao.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Stat card para linhas corrig√≠veis */
        .stat-card-ftx.stat-corrigivel .stat-icon { color: #059669; }
        .stat-card-ftx.stat-corrigivel .stat-valor { color: #059669; }

        /* ===== TABELA IMPORTADOS ===== */
        .tabela-importados-container {
            max-height: 350px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .tabela-importados-container thead {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 1;
        }

        /* ===== BARRA DE PROGRESSO ===== */
        .ftx-progress-container {
            width: 100%;
            max-width: 400px;
            margin: 1.5rem auto;
        }

        .ftx-progress-bar {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .ftx-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3D5771, #5a7a9a, #3D5771);
            background-size: 200% 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
            animation: progressShine 1.5s ease-in-out infinite;
        }

        @@keyframes progressShine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .ftx-progress-text {
            text-align: center;
            margin-top: 0.75rem;
            font-weight: 600;
            color: #3D5771;
        }

        .ftx-progress-detail {
            text-align: center;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        /* ===== CARD RESUMO PLANILHA ===== */
        .resumo-planilha-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            max-width: 500px;
            margin: 0 auto;
            animation: fadeInUp 0.4s ease-out;
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .resumo-header {
            background: linear-gradient(135deg, #3D5771 0%, #5a7a9a 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .resumo-header i {
            font-size: 1.1rem;
        }

        .resumo-body {
            padding: 1rem;
        }

        .resumo-periodo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #cbd5e1;
        }

        .resumo-periodo-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .resumo-periodo-item i {
            font-size: 1.5rem;
        }

        .resumo-periodo-item small {
            display: block;
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .resumo-periodo-item strong {
            display: block;
            font-size: 1rem;
            color: #1e293b;
        }

        .resumo-periodo-seta {
            color: #94a3b8;
            font-size: 1rem;
        }

        .resumo-stats {
            display: flex;
            justify-content: space-around;
            gap: 0.5rem;
        }

        .resumo-stat {
            text-align: center;
            padding: 0.5rem;
            border-radius: 8px;
            min-width: 70px;
        }

        .resumo-stat-valor {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .resumo-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
        }

        .resumo-stat-total {
            background: rgba(59, 130, 246, 0.1);
        }
        .resumo-stat-total .resumo-stat-valor {
            color: #3b82f6;
        }

        .resumo-stat-gasolina {
            background: rgba(34, 197, 94, 0.1);
        }
        .resumo-stat-gasolina .resumo-stat-valor {
            color: #22c55e;
        }

        .resumo-stat-diesel {
            background: rgba(245, 158, 11, 0.1);
        }
        .resumo-stat-diesel .resumo-stat-valor {
            color: #f59e0b;
        }

        .resumo-stat-outros {
            background: rgba(107, 114, 128, 0.1);
        }
        .resumo-stat-outros .resumo-stat-valor {
            color: #6b7280;
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel ftx-card-styled">
            <div class="panel-container show">

                <!-- Header Padr√£o FrotiX -->
                <div class="ftx-card-header">
                    <h2 class="titulo-paginas mb-0">
                        <i class="fa-duotone fa-gas-pump"></i>
                        Importar Abastecimentos
                    </h2>
                </div>

                <div class="panel-content">
                    <div class="row">
                        <!-- Painel de Upload -->
                        <div class="col-lg-5 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom py-3">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fa-duotone fa-cloud-arrow-up text-primary me-2"></i>
                                        Upload de Planilha
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- √Årea de Drop: 2 Arquivos -->
                                    <div class="row g-3 mb-4">
                                        <!-- Dropzone 1: XLSX (Data/Hora) -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">
                                                <i class="fa-duotone fa-file-excel text-success me-2"></i>
                                                Arquivo Excel
                                            </label>
                                            <div id="dropZoneXlsx" class="ftx-dropzone ftx-dropzone-small"
                                                 data-bs-toggle="tooltip"
                                                 data-bs-custom-class="tooltip-ftx-azul"
                                                 data-bs-placement="top"
                                                 title="Nenhum arquivo escolhido">
                                                <input type="file" id="arquivoXlsx" accept=".xlsx,.xls" class="ftx-dropzone-input" />
                                                <div id="dropZoneXlsxContent">
                                                    <i class="fa-duotone fa-cloud-arrow-up ftx-dropzone-icon-small"></i>
                                                    <p class="mb-1 fw-semibold small">Arraste aqui</p>
                                                    <p class="text-muted small mb-2" style="font-size: 0.7rem;">ou clique</p>
                                                    <span class="badge bg-light text-dark border" style="font-size: 0.65rem;">.xlsx ou .xls</span>
                                                    <p class="text-muted mt-2 mb-0" style="font-size: 0.65rem;"><strong>Cont√©m:</strong> Data/Hora</p>
                                                </div>
                                                <div id="arquivoXlsxSelecionado" class="d-none">
                                                    <i class="fa-duotone fa-file-excel ftx-dropzone-icon-small text-success"></i>
                                                    <p class="mb-1 fw-semibold text-success small" id="nomeArquivoXlsx"></p>
                                                    <button type="button" class="btn btn-sm btn-vinho mt-2" id="btnRemoverXlsx">
                                                        <i class="fa-duotone fa-trash-can me-1"></i>Remover
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Dropzone 2: CSV (Dados) -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">
                                                <i class="fa-duotone fa-file-csv text-warning me-2"></i>
                                                Arquivo CSV
                                            </label>
                                            <div id="dropZoneCsv" class="ftx-dropzone ftx-dropzone-small"
                                                 data-bs-toggle="tooltip"
                                                 data-bs-custom-class="tooltip-ftx-azul"
                                                 data-bs-placement="top"
                                                 title="Nenhum arquivo escolhido">
                                                <input type="file" id="arquivoCsv" accept=".csv" class="ftx-dropzone-input" />
                                                <div id="dropZoneCsvContent">
                                                    <i class="fa-duotone fa-cloud-arrow-up ftx-dropzone-icon-small"></i>
                                                    <p class="mb-1 fw-semibold small">Arraste aqui</p>
                                                    <p class="text-muted small mb-2" style="font-size: 0.7rem;">ou clique</p>
                                                    <span class="badge bg-light text-dark border" style="font-size: 0.65rem;">.csv</span>
                                                    <p class="text-muted mt-2 mb-0" style="font-size: 0.65rem;"><strong>Cont√©m:</strong> Placa, KM, Litros...</p>
                                                </div>
                                                <div id="arquivoCsvSelecionado" class="d-none">
                                                    <i class="fa-duotone fa-file-csv ftx-dropzone-icon-small text-warning"></i>
                                                    <p class="mb-1 fw-semibold text-warning small" id="nomeArquivoCsv"></p>
                                                    <button type="button" class="btn btn-sm btn-vinho mt-2" id="btnRemoverCsv">
                                                        <i class="fa-duotone fa-trash-can me-1"></i>Remover
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Bot√£o Importar -->
                                    <button type="button" id="btnImportar" class="btn btn-fundo-laranja btn-lg w-100" disabled>
                                        <i class="fa-duotone fa-upload me-2"></i>
                                        Importar Abastecimentos
                                    </button>

                                    <!-- Info Box -->
                                    <div class="info-box-ftx mt-4">
                                        <h6>
                                            <i class="fa-duotone fa-lightbulb me-2"></i>Informa√ß√µes
                                        </h6>
                                        <hr class="my-2">
                                        <p class="small mb-2"><strong>üìÑ Arquivo XLSX (Excel):</strong></p>
                                        <ul class="small mb-3">
                                            <li>Colunas: <strong>Data</strong> (com hora), <strong>Autorizacao</strong></li>
                                            <li>A data/hora deve estar no formato correto do Excel</li>
                                        </ul>
                                        <p class="small mb-2"><strong>üìÑ Arquivo CSV:</strong></p>
                                        <ul class="small mb-3">
                                            <li>Colunas: Autorizacao, Placa, KM, Produto, Qtde, VrUnitario, Rodado, CodMotorista, KMAnterior</li>
                                            <li>Produtos aceitos: <strong>Gasolina Comum</strong> e <strong>Diesel S-10</strong></li>
                                        </ul>
                                        <p class="small mb-2"><strong>‚úÖ Regras:</strong></p>
                                        <ul class="small">
                                            <li>Os arquivos s√£o combinados pelo n√∫mero de <strong>Autoriza√ß√£o</strong></li>
                                            <li>Outros produtos (ARLA, etc) ser√£o ignorados</li>
                                            <li>Limite: 500 litros por abastecimento</li>
                                            <li>Limite: 1.000 km rodados</li>
                                            <li>Erros geram pend√™ncias para corre√ß√£o</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Painel de Resultado -->
                        <div class="col-lg-7 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom py-3">
                                    <h5 class="mb-0 fw-bold">
                                        <i class="fa-duotone fa-clipboard-list text-primary me-2"></i>
                                        Resultado da Importa√ß√£o
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Estado Inicial -->
                                    <div id="estadoInicial" class="estado-aguardando">
                                        <i class="fa-duotone fa-inbox"></i>
                                        <h5 class="text-muted">Aguardando importa√ß√£o</h5>
                                        <p class="text-muted mb-0">Selecione o arquivo para come√ßar</p>
                                    </div>

                                    <!-- Loading com Barra de Progresso -->
                                    <div id="estadoLoading" class="estado-aguardando d-none">
                                        <div class="mb-3">
                                            <i class="fa-duotone fa-cogs text-primary fa-3x fa-spin-pulse"></i>
                                        </div>
                                        <h5 class="text-primary mb-1" id="progressEtapa">Iniciando importa√ß√£o...</h5>
                                        <p class="text-muted mb-3" id="progressDetail">Preparando...</p>

                                        <!-- Barra de Progresso -->
                                        <div class="ftx-progress-container">
                                            <div class="ftx-progress-bar">
                                                <div class="ftx-progress-fill" id="progressFill" style="width: 0%"></div>
                                            </div>
                                            <div class="ftx-progress-text" id="progressText">0%</div>
                                        </div>

                                        <!-- Card de Resumo da Planilha (aparece ap√≥s an√°lise) -->
                                        <div id="resumoPlanilha" class="d-none mt-4">
                                            <div class="resumo-planilha-card">
                                                <div class="resumo-header">
                                                    <i class="fa-duotone fa-file-spreadsheet"></i>
                                                    <span>Resumo da Planilha</span>
                                                </div>
                                                <div class="resumo-body">
                                                    <div class="resumo-periodo">
                                                        <div class="resumo-periodo-item">
                                                            <i class="fa-duotone fa-calendar-arrow-down text-success"></i>
                                                            <div>
                                                                <small>Data Inicial</small>
                                                                <strong id="resumoDataInicial">--/--/----</strong>
                                                            </div>
                                                        </div>
                                                        <div class="resumo-periodo-seta">
                                                            <i class="fa-duotone fa-arrow-right"></i>
                                                        </div>
                                                        <div class="resumo-periodo-item">
                                                            <i class="fa-duotone fa-calendar-arrow-up text-danger"></i>
                                                            <div>
                                                                <small>Data Final</small>
                                                                <strong id="resumoDataFinal">--/--/----</strong>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="resumo-stats">
                                                        <div class="resumo-stat resumo-stat-total">
                                                            <div class="resumo-stat-valor" id="resumoTotal">0</div>
                                                            <div class="resumo-stat-label">Total</div>
                                                        </div>
                                                        <div class="resumo-stat resumo-stat-gasolina">
                                                            <div class="resumo-stat-valor" id="resumoGasolina">0</div>
                                                            <div class="resumo-stat-label">Gasolina</div>
                                                        </div>
                                                        <div class="resumo-stat resumo-stat-diesel">
                                                            <div class="resumo-stat-valor" id="resumoDiesel">0</div>
                                                            <div class="resumo-stat-label">Diesel</div>
                                                        </div>
                                                        <div class="resumo-stat resumo-stat-outros">
                                                            <div class="resumo-stat-valor" id="resumoOutros">0</div>
                                                            <div class="resumo-stat-label">Outros</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resultado Sucesso Total -->
                                    <div id="estadoSucesso" class="d-none">
                                        <div class="alert alert-resultado alert-success d-flex align-items-center gap-3 mb-4">
                                            <div class="alert-icon">
                                                <i class="fa-duotone fa-circle-check"></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading mb-1">Importa√ß√£o Conclu√≠da!</h5>
                                                <p class="mb-0" id="msgSucesso"></p>
                                            </div>
                                        </div>

                                        <!-- Estat√≠sticas -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-total">
                                                    <i class="fa-duotone fa-file-lines stat-icon"></i>
                                                    <div class="stat-valor" id="statTotal">0</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-sucesso">
                                                    <i class="fa-duotone fa-check stat-icon"></i>
                                                    <div class="stat-valor" id="statImportados">0</div>
                                                    <div class="stat-label">Importados</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-ignorado">
                                                    <i class="fa-duotone fa-filter stat-icon"></i>
                                                    <div class="stat-valor" id="statIgnorados">0</div>
                                                    <div class="stat-label">Ignorados</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tabela de Importados -->
                                        <div class="tabela-importados-container">
                                            <table class="table table-sm table-hover mb-0" id="tblImportados">
                                                <thead>
                                                    <tr>
                                                        <th>Data/Hora</th>
                                                        <th>Placa</th>
                                                        <th>Motorista</th>
                                                        <th>Produto</th>
                                                        <th class="text-end">Qtde</th>
                                                        <th class="text-end">Km</th>
                                                        <th class="text-end">Consumo</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbodyImportados"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Resultado Parcial -->
                                    <div id="estadoParcial" class="d-none">
                                        <div class="alert alert-resultado alert-warning d-flex align-items-center gap-3 mb-4">
                                            <div class="alert-icon">
                                                <i class="fa-duotone fa-triangle-exclamation"></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading mb-1">Importa√ß√£o Parcial</h5>
                                                <p class="mb-0" id="msgParcial"></p>
                                            </div>
                                        </div>

                                        <!-- Estat√≠sticas Parcial -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-total">
                                                    <i class="fa-duotone fa-file-lines stat-icon"></i>
                                                    <div class="stat-valor" id="statTotalParcial">0</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-sucesso">
                                                    <i class="fa-duotone fa-check stat-icon"></i>
                                                    <div class="stat-valor" id="statImportadosParcial">0</div>
                                                    <div class="stat-label">Importados</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-erro">
                                                    <i class="fa-duotone fa-xmark stat-icon"></i>
                                                    <div class="stat-valor" id="statErrosParcial">0</div>
                                                    <div class="stat-label">Com Erro</div>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="stat-card-ftx stat-ignorado">
                                                    <i class="fa-duotone fa-filter stat-icon"></i>
                                                    <div class="stat-valor" id="statIgnoradosParcial">0</div>
                                                    <div class="stat-label">Ignorados</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Bot√µes Acessar Pend√™ncias e Exportar -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-md-7">
                                                <button onclick="window.location.href='/Abastecimento/Pendencias'" class="btn btn-azul btn-lg w-100">
                                                    <i class="fa-duotone fa-clipboard-list-check me-2"></i>
                                                    Acessar Pend√™ncias para Corre√ß√£o
                                                </button>
                                            </div>
                                            <div class="col-md-5">
                                                <button onclick="exportarPendencias()" class="btn btn-verde-dinheiro btn-lg w-100">
                                                    <i class="fa-duotone fa-file-excel me-2"></i>
                                                    Exportar Excel
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Lista de Erros -->
                                        <h6 class="mb-3 fw-bold">
                                            <i class="fa-duotone fa-bug text-danger me-2"></i>
                                            Resumo dos Erros
                                        </h6>
                                        <div class="list-group lista-erros-ftx" id="listaErrosParcial"></div>
                                    </div>

                                    <!-- Resultado Erro Total -->
                                    <div id="estadoErro" class="d-none">
                                        <div class="alert alert-resultado alert-danger d-flex align-items-center gap-3 mb-4">
                                            <div class="alert-icon">
                                                <i class="fa-duotone fa-circle-xmark"></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading mb-1">Nenhum Registro Importado</h5>
                                                <p class="mb-0" id="msgErro"></p>
                                            </div>
                                        </div>

                                        <!-- Estat√≠sticas de Erro -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-total">
                                                    <i class="fa-duotone fa-file-lines stat-icon"></i>
                                                    <div class="stat-valor" id="statTotalErro">0</div>
                                                    <div class="stat-label">Total</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-erro">
                                                    <i class="fa-duotone fa-triangle-exclamation stat-icon"></i>
                                                    <div class="stat-valor" id="statErros">0</div>
                                                    <div class="stat-label">Com Erro</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="stat-card-ftx stat-ignorado">
                                                    <i class="fa-duotone fa-filter stat-icon"></i>
                                                    <div class="stat-valor" id="statIgnoradosErro">0</div>
                                                    <div class="stat-label">Ignorados</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Bot√µes Acessar Pend√™ncias e Exportar -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-md-7">
                                                <button onclick="window.location.href='/Abastecimento/Pendencias'" class="btn btn-azul btn-lg w-100">
                                                    <i class="fa-duotone fa-clipboard-list-check me-2"></i>
                                                    Acessar Pend√™ncias para Corre√ß√£o
                                                </button>
                                            </div>
                                            <div class="col-md-5">
                                                <button onclick="exportarPendencias()" class="btn btn-verde-dinheiro btn-lg w-100">
                                                    <i class="fa-duotone fa-file-excel me-2"></i>
                                                    Exportar Excel
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Lista de Erros -->
                                        <h6 class="mb-3 fw-bold">
                                            <i class="fa-duotone fa-bug text-danger me-2"></i>
                                            Detalhes dos Erros
                                        </h6>
                                        <div class="list-group lista-erros-ftx" id="listaErros"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <!-- SignalR -->
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js" asp-append-version="true"></script>

    <script asp-append-version="true">
        (function () {
            'use strict';

            // ===== ELEMENTOS DO DOM =====
            // Dropzone XLSX
            const arquivoXlsx = document.getElementById('arquivoXlsx');
            const dropZoneXlsx = document.getElementById('dropZoneXlsx');
            const dropZoneXlsxContent = document.getElementById('dropZoneXlsxContent');
            const arquivoXlsxSelecionado = document.getElementById('arquivoXlsxSelecionado');
            const nomeArquivoXlsx = document.getElementById('nomeArquivoXlsx');
            const btnRemoverXlsx = document.getElementById('btnRemoverXlsx');

            // Dropzone CSV
            const arquivoCsv = document.getElementById('arquivoCsv');
            const dropZoneCsv = document.getElementById('dropZoneCsv');
            const dropZoneCsvContent = document.getElementById('dropZoneCsvContent');
            const arquivoCsvSelecionado = document.getElementById('arquivoCsvSelecionado');
            const nomeArquivoCsv = document.getElementById('nomeArquivoCsv');
            const btnRemoverCsv = document.getElementById('btnRemoverCsv');

            const btnImportar = document.getElementById('btnImportar');

            const estadoInicial = document.getElementById('estadoInicial');
            const estadoLoading = document.getElementById('estadoLoading');
            const estadoSucesso = document.getElementById('estadoSucesso');
            const estadoParcial = document.getElementById('estadoParcial');
            const estadoErro = document.getElementById('estadoErro');

            // Elementos da barra de progresso
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressEtapa = document.getElementById('progressEtapa');
            const progressDetail = document.getElementById('progressDetail');

            // Elementos do resumo da planilha
            const resumoPlanilha = document.getElementById('resumoPlanilha');
            const resumoDataInicial = document.getElementById('resumoDataInicial');
            const resumoDataFinal = document.getElementById('resumoDataFinal');
            const resumoTotal = document.getElementById('resumoTotal');
            const resumoGasolina = document.getElementById('resumoGasolina');
            const resumoDiesel = document.getElementById('resumoDiesel');
            const resumoOutros = document.getElementById('resumoOutros');

            let arquivoXlsxAtual = null;
            let arquivoCsvAtual = null;

            // ===== SIGNALR =====
            let hubConnection = null;
            let connectionId = null;

            async function inicializarSignalR() {
                try {
                    console.log("üîß Inicializando SignalR...");

                    hubConnection = new signalR.HubConnectionBuilder()
                        .withUrl("/hubs/importacao", {
                            transport: signalR.HttpTransportType.LongPolling  // For√ßar LongPolling como outros hubs
                        })
                        .withAutomaticReconnect()
                        .build();

                    // Vari√°vel para resolver Promise externamente
                    let resolverConexao = null;

                    // Criar Promise que resolve quando receber connectionId
                    const conexaoPromise = new Promise((resolve) => {
                        resolverConexao = resolve;
                    });

                    // IMPORTANTE: Registrar handlers ANTES de chamar .start()
                    // Evento: Conex√£o estabelecida
                    hubConnection.on("Conectado", (connId) => {
                        connectionId = connId;
                        console.log("‚úÖ SignalR conectado com sucesso! ConnectionID:", connectionId);
                        atualizarBotaoImportar(); // Atualizar bot√£o imediatamente
                        if (resolverConexao) {
                            resolverConexao(); // Resolver a Promise quando connectionId chegar
                        }
                    });

                    // Evento: Receber progresso
                    hubConnection.on("ProgressoImportacao", (progresso) => {
                        try {
                            // Atualizar barra de progresso e etapa
                            atualizarProgresso(progresso.porcentagem, progresso.etapa, progresso.detalhe);

                            // Se tem info de linhas, mostrar detalhes com contagem
                            if (progresso.totalLinhas > 0 && !progresso.resumoDisponivel) {
                                progressDetail.textContent = `${progresso.detalhe} (${progresso.linhaAtual}/${progresso.totalLinhas})`;
                            }

                            // Se recebeu resumo da planilha, exibir card
                            if (progresso.resumoDisponivel) {
                                mostrarResumoPlanilha(progresso);
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha('Importacao.cshtml', 'ProgressoImportacao', error);
                        }
                    });

                    // Iniciar conex√£o
                    console.log("üîÑ Iniciando conex√£o SignalR...");
                    await hubConnection.start();
                    console.log("üîÑ Conex√£o SignalR estabelecida, aguardando evento Conectado...");

                    // Aguardar at√© receber o connectionId (com timeout de 5 segundos)
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error("Timeout aguardando ConnectionID")), 5000);
                    });

                    await Promise.race([conexaoPromise, timeoutPromise]);
                    console.log("üéØ SignalR completamente pronto para uso! ConnectionID:", connectionId);

                    // Atualizar bot√£o agora que SignalR est√° pronto
                    atualizarBotaoImportar();

                } catch (error) {
                    console.error("‚ùå Erro ao conectar SignalR:", error);
                    console.warn("‚ö†Ô∏è P√°gina funcionar√° sem progresso em tempo real");

                    // Mesmo com erro, atualizar o bot√£o (permitir√° importar sem progresso)
                    atualizarBotaoImportar();
                }
            }

            function mostrarResumoPlanilha(progresso) {
                try {
                    resumoDataInicial.textContent = progresso.dataInicial || '--/--/----';
                    resumoDataFinal.textContent = progresso.dataFinal || '--/--/----';
                    resumoTotal.textContent = progresso.totalRegistros || 0;
                    resumoGasolina.textContent = progresso.registrosGasolina || 0;
                    resumoDiesel.textContent = progresso.registrosDiesel || 0;
                    resumoOutros.textContent = progresso.registrosOutros || 0;
                    resumoPlanilha.classList.remove('d-none');
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarResumoPlanilha', error);
                }
            }

            function ocultarResumoPlanilha() {
                try {
                    resumoPlanilha.classList.add('d-none');
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'ocultarResumoPlanilha', error);
                }
            }

            async function init() {
                try {
                    // Aguardar SignalR conectar ANTES de permitir uso da p√°gina
                    await inicializarSignalR();
                    configurarEventos();
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'init', error);
                }
            }

            function configurarEventos() {
                try {
                    // ===== DROPZONE XLSX =====
                    dropZoneXlsx.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZoneXlsx.classList.add('dragover');
                    });

                    dropZoneXlsx.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        dropZoneXlsx.classList.remove('dragover');
                    });

                    dropZoneXlsx.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZoneXlsx.classList.remove('dragover');

                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            selecionarArquivoXlsx(files[0]);
                        }
                    });

                    arquivoXlsx.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            selecionarArquivoXlsx(e.target.files[0]);
                        }
                    });

                    btnRemoverXlsx.addEventListener('click', removerArquivoXlsx);

                    // ===== DROPZONE CSV =====
                    dropZoneCsv.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZoneCsv.classList.add('dragover');
                    });

                    dropZoneCsv.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        dropZoneCsv.classList.remove('dragover');
                    });

                    dropZoneCsv.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZoneCsv.classList.remove('dragover');

                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            selecionarArquivoCsv(files[0]);
                        }
                    });

                    arquivoCsv.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            selecionarArquivoCsv(e.target.files[0]);
                        }
                    });

                    btnRemoverCsv.addEventListener('click', removerArquivoCsv);

                    // ===== BOT√ÉO IMPORTAR =====
                    btnImportar.addEventListener('click', importar);

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'configurarEventos', error);
                }
            }

            // Cria HTML para um item de erro (com ou sem sugest√£o de corre√ß√£o)
            function criarItemErro(erro, index) {
                try {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.id = `erro-item-${index}`;

                    // Badge: vermelho para erro, verde para corrig√≠vel
                    const badgeClass = erro.corrigivel ? 'badge-corrigivel' : 'badge-erro';
                    const badgeText = erro.corrigivel ? 'sugest√£o' : erro.tipo;

                    let html = `
                        <div class="d-flex align-items-start gap-3">
                            <div class="erro-icon-circle">
                                <i class="fa-solid ${erro.icone}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong class="text-danger">Linha ${erro.linhaArquivoErros} (original: ${erro.linhaOriginal})</strong>
                                    <div class="d-flex gap-2">
                                        <span class="badge-tipo-erro badge-erro">${erro.tipo}</span>
                                        ${erro.corrigivel ? '<span class="badge-tipo-erro badge-corrigivel"><i class="fa-duotone fa-wand-magic-sparkles me-1"></i>sugest√£o</span>' : ''}
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small">${erro.descricao}</p>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <strong>Placa:</strong> ${erro.placa || '-'} | 
                                        <strong>Aut:</strong> ${erro.autorizacao || '-'} |
                                        <strong>KM Ant:</strong> ${erro.kmAnterior?.toLocaleString('pt-BR') || '-'} |
                                        <strong>KM:</strong> ${erro.km?.toLocaleString('pt-BR') || '-'}
                                    </small>
                                </div>
                    `;

                    // Se tem sugest√£o de corre√ß√£o
                    if (erro.corrigivel) {
                        const campoLabel = erro.campoCorrecao === 'KmAnterior' ? 'KM Anterior' : 'KM Atual';
                        
                        html += `
                                <div class="sugestao-correcao">
                                    <div class="sugestao-header">
                                        <i class="fa-duotone fa-lightbulb-on"></i>
                                        <span>Sugest√£o de Corre√ß√£o: ${campoLabel}</span>
                                    </div>
                                    <div class="sugestao-valores">
                                        <div class="sugestao-valor valor-errado">
                                            <span class="valor-label">Atual (errado)</span>
                                            <span class="valor-numero">${erro.valorAtual?.toLocaleString('pt-BR')}</span>
                                        </div>
                                        <i class="fa-duotone fa-arrow-right sugestao-seta"></i>
                                        <div class="sugestao-valor valor-correto">
                                            <span class="valor-label">Sugerido</span>
                                            <span class="valor-numero">${erro.valorSugerido?.toLocaleString('pt-BR')}</span>
                                        </div>
                                    </div>
                                    <div class="sugestao-justificativa">
                                        ${erro.justificativaSugestao}
                                    </div>
                                    <button type="button" class="btn-aplicar-correcao" onclick="aplicarCorrecao(${index}, this)">
                                        <i class="fa-duotone fa-check"></i>
                                        Aplicar e Importar
                                    </button>
                                </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;

                    item.innerHTML = html;
                    return item;

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'criarItemErro', error);
                    return null;
                }
            }

            // Armazena os erros para refer√™ncia na corre√ß√£o
            let errosAtuais = [];

            // Aplica corre√ß√£o sugerida via API
            async function aplicarCorrecao(index, btnElement) {
                try {
                    const erro = errosAtuais[index];
                    if (!erro || !erro.corrigivel) {
                        AppToast.show('Vermelho', 'Erro n√£o dispon√≠vel para corre√ß√£o', 4000);
                        return;
                    }

                    // Desabilitar bot√£o
                    btnElement.classList.add('loading');
                    btnElement.innerHTML = '<i class="fa-duotone fa-spinner fa-spin"></i> Aplicando...';

                    const response = await fetch('/api/Abastecimento/AplicarCorrecao', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            autorizacao: erro.autorizacao,
                            placa: erro.placa,
                            kmAnterior: erro.kmAnterior,
                            km: erro.km,
                            litros: erro.litros,
                            veiculoId: erro.veiculoId,
                            motoristaId: erro.motoristaId,
                            combustivelId: erro.combustivelId,
                            dataHora: erro.dataHora,
                            valorUnitario: erro.valorUnitario,
                            campoCorrecao: erro.campoCorrecao,
                            valorCorrigido: erro.valorSugerido
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        AppToast.show('Verde', result.message, 5000);
                        
                        // Animar e remover item da lista
                        const item = document.getElementById(`erro-item-${index}`);
                        if (item) {
                            item.classList.add('corrigido');
                            setTimeout(() => item.remove(), 400);
                        }

                        // Atualizar contadores
                        atualizarContadoresAposCorrecao();

                    } else {
                        AppToast.show('Vermelho', result.message || 'Erro ao aplicar corre√ß√£o', 5000);
                        btnElement.classList.remove('loading');
                        btnElement.innerHTML = '<i class="fa-duotone fa-check"></i> Aplicar e Importar';
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'aplicarCorrecao', error);
                    AppToast.show('Vermelho', 'Erro ao aplicar corre√ß√£o', 4000);
                    btnElement.classList.remove('loading');
                    btnElement.innerHTML = '<i class="fa-duotone fa-check"></i> Aplicar e Importar';
                }
            }

            // Atualiza contadores ap√≥s corre√ß√£o bem-sucedida
            function atualizarContadoresAposCorrecao() {
                try {
                    // Parcial
                    const statImportadosParcial = document.getElementById('statImportadosParcial');
                    const statErrosParcial = document.getElementById('statErrosParcial');
                    if (statImportadosParcial && !statImportadosParcial.closest('.d-none')) {
                        statImportadosParcial.textContent = parseInt(statImportadosParcial.textContent || 0) + 1;
                        statErrosParcial.textContent = Math.max(0, parseInt(statErrosParcial.textContent || 0) - 1);
                    }

                    // Erro total
                    const statErros = document.getElementById('statErros');
                    const statImportadosErro = document.getElementById('statImportadosErro');
                    if (statErros && !statErros.closest('.d-none')) {
                        statErros.textContent = Math.max(0, parseInt(statErros.textContent || 0) - 1);
                        if (statImportadosErro) {
                            statImportadosErro.textContent = parseInt(statImportadosErro.textContent || 0) + 1;
                        }
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'atualizarContadoresAposCorrecao', error);
                }
            }

            // Faz aplicarCorrecao dispon√≠vel globalmente
            window.aplicarCorrecao = aplicarCorrecao;

            function atualizarProgresso(pct, etapa, detalhe) {
                try {
                    const porcentagem = Math.min(Math.round(pct), 100);
                    progressFill.style.width = porcentagem + '%';
                    progressText.textContent = porcentagem + '%';

                    // Atualizar t√≠tulo da etapa
                    if (etapa) {
                        progressEtapa.textContent = etapa;
                    }

                    // Atualizar detalhe
                    if (detalhe) {
                        progressDetail.textContent = detalhe;
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'atualizarProgresso', error);
                }
            }

            // ===== SELE√á√ÉO E REMO√á√ÉO DE ARQUIVOS =====
            function selecionarArquivoXlsx(file) {
                try {
                    const extensao = file.name.split('.').pop().toLowerCase();
                    if (extensao !== 'xlsx' && extensao !== 'xls') {
                        AppToast.show('Amarelo', 'Selecione um arquivo Excel (.xlsx ou .xls)', 4000);
                        return;
                    }

                    arquivoXlsxAtual = file;
                    nomeArquivoXlsx.textContent = file.name;
                    dropZoneXlsxContent.classList.add('d-none');
                    arquivoXlsxSelecionado.classList.remove('d-none');
                    dropZoneXlsx.classList.add('arquivo-ok');

                    // Atualizar tooltip com nome do arquivo
                    const tooltipInstance = bootstrap.Tooltip.getInstance(dropZoneXlsx);
                    if (tooltipInstance) {
                        tooltipInstance.setContent({ '.tooltip-inner': file.name });
                    }

                    atualizarBotaoImportar();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'selecionarArquivoXlsx', error);
                }
            }

            function removerArquivoXlsx() {
                try {
                    arquivoXlsxAtual = null;
                    arquivoXlsx.value = '';
                    dropZoneXlsxContent.classList.remove('d-none');
                    arquivoXlsxSelecionado.classList.add('d-none');
                    dropZoneXlsx.classList.remove('arquivo-ok');

                    // Restaurar tooltip original
                    const tooltipInstance = bootstrap.Tooltip.getInstance(dropZoneXlsx);
                    if (tooltipInstance) {
                        tooltipInstance.setContent({ '.tooltip-inner': 'Nenhum arquivo escolhido' });
                    }

                    atualizarBotaoImportar();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'removerArquivoXlsx', error);
                }
            }

            function selecionarArquivoCsv(file) {
                try {
                    const extensao = file.name.split('.').pop().toLowerCase();
                    if (extensao !== 'csv') {
                        AppToast.show('Amarelo', 'Selecione um arquivo CSV (.csv)', 4000);
                        return;
                    }

                    arquivoCsvAtual = file;
                    nomeArquivoCsv.textContent = file.name;
                    dropZoneCsvContent.classList.add('d-none');
                    arquivoCsvSelecionado.classList.remove('d-none');
                    dropZoneCsv.classList.add('arquivo-ok');

                    // Atualizar tooltip com nome do arquivo
                    const tooltipInstance = bootstrap.Tooltip.getInstance(dropZoneCsv);
                    if (tooltipInstance) {
                        tooltipInstance.setContent({ '.tooltip-inner': file.name });
                    }

                    atualizarBotaoImportar();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'selecionarArquivoCsv', error);
                }
            }

            function removerArquivoCsv() {
                try {
                    arquivoCsvAtual = null;
                    arquivoCsv.value = '';
                    dropZoneCsvContent.classList.remove('d-none');
                    arquivoCsvSelecionado.classList.add('d-none');
                    dropZoneCsv.classList.remove('arquivo-ok');

                    // Restaurar tooltip original
                    const tooltipInstance = bootstrap.Tooltip.getInstance(dropZoneCsv);
                    if (tooltipInstance) {
                        tooltipInstance.setContent({ '.tooltip-inner': 'Nenhum arquivo escolhido' });
                    }

                    atualizarBotaoImportar();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'removerArquivoCsv', error);
                }
            }

            function removerArquivo() {
                try {
                    removerArquivoXlsx();
                    removerArquivoCsv();
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'removerArquivo', error);
                }
            }

            function atualizarBotaoImportar() {
                try {
                    // Bot√£o s√≥ fica habilitado quando:
                    // 1. AMBOS os arquivos est√£o selecionados
                    // 2. SignalR est√° conectado (connectionId dispon√≠vel)
                    const arquivosOk = arquivoXlsxAtual !== null && arquivoCsvAtual !== null;
                    const signalROk = connectionId !== null;

                    btnImportar.disabled = !(arquivosOk && signalROk);

                    // Atualizar texto do bot√£o baseado no status
                    if (!signalROk) {
                        btnImportar.innerHTML = '<i class="fa-duotone fa-spinner-third fa-spin me-2"></i>Conectando...';
                    } else if (!arquivosOk) {
                        btnImportar.innerHTML = '<i class="fa-duotone fa-file-import me-2"></i>Selecione os arquivos';
                    } else {
                        btnImportar.innerHTML = '<i class="fa-duotone fa-file-import me-2"></i>Importar Abastecimentos';
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'atualizarBotaoImportar', error);
                }
            }

            async function importar() {
                try {
                    console.log('[IMPORTAR] Iniciando importa√ß√£o...');
                    console.log('[IMPORTAR] ConnectionID:', connectionId);

                    // Validar que ambos os arquivos est√£o selecionados
                    if (!arquivoXlsxAtual || !arquivoCsvAtual) {
                        AppToast.show('Amarelo', 'Selecione ambos os arquivos (XLSX e CSV)', 4000);
                        return;
                    }

                    console.log('[IMPORTAR] Arquivos selecionados:', {
                        xlsx: arquivoXlsxAtual.name,
                        csv: arquivoCsvAtual.name
                    });

                    mostrarEstado('loading');
                    ocultarResumoPlanilha(); // Resetar resumo para nova importa√ß√£o
                    atualizarProgresso(0, 'Iniciando importa√ß√£o...', 'Preparando envio dos arquivos...');

                    const formData = new FormData();
                    formData.append('arquivoXlsx', arquivoXlsxAtual);
                    formData.append('arquivoCsv', arquivoCsvAtual);

                    // Enviar connectionId do SignalR para o servidor
                    if (connectionId) {
                        formData.append('connectionId', connectionId);
                        console.log('[IMPORTAR] ConnectionID enviado ao servidor');
                    } else {
                        console.warn('[IMPORTAR] ATEN√á√ÉO: ConnectionID n√£o dispon√≠vel!');
                    }

                    console.log('[IMPORTAR] Enviando requisi√ß√£o para /api/Abastecimento/ImportarDual...');

                    const response = await fetch('/api/Abastecimento/ImportarDual', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('[IMPORTAR] Resposta recebida. Status:', response.status);

                    const result = await response.json();

                    // Pequeno delay para garantir que a barra chegou em 100%
                    await new Promise(resolve => setTimeout(resolve, 300));

                    if (result.sucesso && result.linhasComErro === 0) {
                        mostrarSucesso(result);
                    } else if (result.sucesso && result.linhasComErro > 0) {
                        mostrarParcial(result);
                    } else {
                        mostrarErro(result);
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'importar', error);
                    mostrarEstado('inicial');
                    AppToast.show('Vermelho', 'Erro ao processar importa√ß√£o', 5000);
                }
            }

            function mostrarEstado(estado) {
                try {
                    estadoInicial.classList.add('d-none');
                    estadoLoading.classList.add('d-none');
                    estadoSucesso.classList.add('d-none');
                    estadoParcial.classList.add('d-none');
                    estadoErro.classList.add('d-none');

                    switch (estado) {
                        case 'inicial':
                            estadoInicial.classList.remove('d-none');
                            break;
                        case 'loading':
                            estadoLoading.classList.remove('d-none');
                            // Desabilitar bot√µes durante importa√ß√£o
                            btnRemoverXlsx.disabled = true;
                            btnRemoverCsv.disabled = true;
                            btnImportar.disabled = true;
                            break;
                        case 'sucesso':
                            estadoSucesso.classList.remove('d-none');
                            break;
                        case 'parcial':
                            estadoParcial.classList.remove('d-none');
                            break;
                        case 'erro':
                            estadoErro.classList.remove('d-none');
                            break;
                    }

                    // Reabilitar bot√µes quando sair do estado loading
                    if (estado !== 'loading') {
                        btnRemoverXlsx.disabled = false;
                        btnRemoverCsv.disabled = false;
                        // Atualizar estado do bot√£o importar baseado nas condi√ß√µes
                        atualizarBotaoImportar();
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarEstado', error);
                }
            }

            function mostrarSucesso(result) {
                try {
                    mostrarEstado('sucesso');

                    document.getElementById('msgSucesso').textContent = result.mensagem;
                    document.getElementById('statTotal').textContent = result.totalLinhas;
                    document.getElementById('statImportados').textContent = result.linhasImportadas;
                    document.getElementById('statIgnorados').textContent = result.linhasIgnoradas;

                    const tbody = document.getElementById('tbodyImportados');
                    tbody.innerHTML = '';

                    if (result.linhasImportadasLista && result.linhasImportadasLista.length > 0) {
                        result.linhasImportadasLista.forEach(linha => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><small class="text-muted">${linha.dataHora}</small></td>
                                <td><span class="badge bg-secondary">${linha.placa}</span></td>
                                <td>${linha.motorista || '-'}</td>
                                <td>
                                    <span class="badge ${linha.produto === 'Gasolina Comum' ? 'bg-warning text-dark' : 'bg-dark'}">
                                        ${linha.produto}
                                    </span>
                                </td>
                                <td class="text-end">${linha.quantidade}</td>
                                <td class="text-end">${linha.kmRodado}</td>
                                <td class="text-end"><strong>${linha.consumo}</strong></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }

                    AppToast.show('Verde', 'Importa√ß√£o conclu√≠da com sucesso!', 5000);
                    removerArquivo();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarSucesso', error);
                }
            }

            function mostrarParcial(result) {
                try {
                    mostrarEstado('parcial');

                    document.getElementById('msgParcial').textContent = result.mensagem;
                    document.getElementById('statTotalParcial').textContent = result.totalLinhas;
                    document.getElementById('statImportadosParcial').textContent = result.linhasImportadas;
                    document.getElementById('statErrosParcial').textContent = result.linhasComErro;
                    document.getElementById('statIgnoradosParcial').textContent = result.linhasIgnoradas;

                    const listaErros = document.getElementById('listaErrosParcial');
                    listaErros.innerHTML = '';

                    // Armazenar erros para refer√™ncia na corre√ß√£o
                    errosAtuais = result.erros || [];

                    if (errosAtuais.length > 0) {
                        errosAtuais.forEach((erro, index) => {
                            const item = criarItemErro(erro, index);
                            if (item) listaErros.appendChild(item);
                        });
                    }

                    // Mostrar quantidade corrig√≠vel se houver
                    const corrigiveis = errosAtuais.filter(e => e.corrigivel).length;
                    if (corrigiveis > 0) {
                        AppToast.show('Amarelo', `${result.linhasImportadas} importados, ${result.linhasComErro} pend√™ncia(s) gerada(s). Acesse a tela de Pend√™ncias.`, 6000);
                    } else {
                        AppToast.show('Amarelo', `${result.linhasImportadas} importados, ${result.linhasComErro} pend√™ncia(s) gerada(s)`, 5000);
                    }
                    removerArquivo();

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarParcial', error);
                }
            }

            function mostrarErro(result) {
                try {
                    mostrarEstado('erro');

                    document.getElementById('msgErro').textContent = result.mensagem;
                    document.getElementById('statTotalErro').textContent = result.totalLinhas;
                    document.getElementById('statErros').textContent = result.linhasComErro;
                    document.getElementById('statIgnoradosErro').textContent = result.linhasIgnoradas || 0;

                    const listaErros = document.getElementById('listaErros');
                    listaErros.innerHTML = '';

                    // Armazenar erros para refer√™ncia na corre√ß√£o
                    errosAtuais = result.erros || [];

                    if (errosAtuais.length > 0) {
                        errosAtuais.forEach((erro, index) => {
                            const item = criarItemErro(erro, index);
                            if (item) listaErros.appendChild(item);
                        });
                    }

                    // Mostrar quantidade corrig√≠vel se houver
                    const corrigiveis = errosAtuais.filter(e => e.corrigivel).length;
                    if (corrigiveis > 0) {
                        AppToast.show('Vermelho', `Nenhum registro importado. ${result.linhasComErro} pend√™ncia(s) gerada(s). Acesse a tela de Pend√™ncias.`, 6000);
                    } else {
                        AppToast.show('Vermelho', `Nenhum registro importado. ${result.linhasComErro} pend√™ncia(s) gerada(s).`, 5000);
                    }

                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'mostrarErro', error);
                }
            }

            function exportarPendencias() {
                try {
                    AppToast.show('Azul', 'Gerando arquivo Excel...', 3000);
                    window.location.href = '/api/Abastecimento/ExportarPendencias';
                } catch (error) {
                    Alerta.TratamentoErroComLinha('Importacao.cshtml', 'exportarPendencias', error);
                    AppToast.show('Vermelho', 'Erro ao exportar pend√™ncias', 4000);
                }
            }

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
}
