@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using Syncfusion.EJ2
@model FrotiX.Pages.Abastecimento.UpsertCuponsModel

@{
	ViewData["Title"] = "Registro de Cupons";
	ViewData["PageName"] = "abastecimento_registracupons";
	ViewData["Heading"] = "<i class='fa-duotone fa-scroll'></i> Cadastros: <span class='fw-300'>Registra Cupons de Abastecimento</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-scroll";
}

<style>
	.form-control-xs {
		height: calc(1em + .775rem + 10px) !important;
		padding: .125rem .25rem !important;
		font-size: .75rem !important;
		line-height: 1.5;
		border-radius: .2rem;
	}

	.label {
		margin-bottom: -5px;
		margin-top: 10px;
	}

	input[type=checkbox] {
		vertical-align: middle;
		position: relative;
		bottom: 1px;
	}

	.btn-largura {
		width: 100px;
		height: 100px;
	}

	.fundo-chocolate {
		background-color: #7B3F00;
		color: white;
	}
</style>

@section HeadBlock {
	<link href="https://cdn.kendostatic.com/2022.1.412/styles/kendo.default-main.min.css" rel="stylesheet" type="text/css" />
}

<form method="post" onkeypress="stopEnterSubmitting(event)" enctype="multipart/form-data">
	@Html.AntiForgeryToken()

	<div class="row">
		<div class="col-xl-12">
			<div id="panel-1" class="panel">
				<!-- ===== HEADER FROTIX ===== -->
				<div class="ftx-card-header">
					<h2 class="titulo-paginas">
						<i class="fa-duotone fa-scroll"></i>
						@(Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId != Guid.Empty ? "Atualizar " : "Registrar ")
						Cupons de Abastecimento
					</h2>
				</div>

				<div class="panel-container show">
					<div id="divPainel" class="panel-content">
						<div asp-validation-summary="ModelOnly" class="text-danger">
							@if (Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId != Guid.Empty)
							{
								<input type="hidden" asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId" />
							}
						</div>

						<div class="p-3">
							<div class="row">
								<div class="col-6 col-md-2 col-xl-2">
									<div class="form-group">
										<label class="label font-weight-bold" asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.DataRegistro"></label>
										<span class="text-danger font-weight-light" asp-validation-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.DataRegistro"></span>
										<input id="txtDataRegistro" class="form-control form-control-xs" asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.DataRegistro" type="date" />
									</div>
								</div>
							</div>

							<br />

							<div class="row">
								<div class="col-md-12 col-xl-10 control-section">
									<div class="control-wrapper">
										<div>
											<input type="file" name="files" id="pdf" />
											<input id="txtRegistroPDF" class="form-control form-control-xs" asp-for="RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF" hidden="hidden" />
											<div id="PDFContainer">
												<div id="pdfViewer"></div>
											</div>
										</div>
										<br />
									</div>
								</div>
							</div>

							<br />

							<div class="row">
								<div class="col-md-12 col-xl-10 control-section">
									<div class="control-wrapper">
										<div>
											<label class="label font-weight-bold">Observações a respeito do Registro</label>
											<ejs-richtexteditor ejs-for="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.Observacoes"
																id="rte"
																toolbarClick="toolbarClick"
																locale="pt-BR"
																height="150px">
												<e-richtexteditor-insertimagesettings saveUrl="api/Viagem/SaveImage"
																					  path="./DadosEditaveis/ImagensViagens/">
												</e-richtexteditor-insertimagesettings>
											</ejs-richtexteditor>
											<div id="errorMessage">
												<span asp-validation-for="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.Observacoes"></span>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div class="row pb-5"></div>
							<div class="row"></div>
							<div class="row pb-5"></div>

							<div class="form-group row">
								<div class="col-12">
									<div class="row">
										<div id="divSubmit" class="col-12 col-md-4 pb-2">
											@if (Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId != Guid.Empty)
											{
												<button id="btnSubmit"
														type="submit"
														asp-page-handler="Edit"
														asp-route-id="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId"
														class="btn fundo-azul form-control">
													Atualizar
												</button>
											}
											else
											{
												<button id="btnSubmit"
														type="submit"
														value="Submit"
														asp-page-handler="Submit"
														class="btn fundo-azul form-control">
													Criar
												</button>
											}
										</div>

										<div class="col-12" hidden>
											@if (Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId != Guid.Empty)
											{
												<button id="btnEscondido"
														type="submit"
														asp-page-handler="Edit"
														asp-route-id="@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId"
														class="btn fundo-azul form-control">
													Atualizar
												</button>
											}
											else
											{
												<button id="btnEscondido"
														type="submit"
														value="Submit"
														asp-page-handler="Submit"
														class="btn fundo-azul form-control">
													Criar
												</button>
											}
										</div>

										<div class="col-12 col-md-4">
											<a asp-page="./RegistraCupons" class="btn btn-voltar form-control" data-ftx-loading><i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar à Lista</a>
										</div>

										<br />
									</div>
								</div>
							</div>
						</div> <!-- .p-3 -->
					</div> <!-- #divPainel -->
				</div> <!-- .panel-container -->
			</div> <!-- #panel-1 -->
		</div> <!-- .col-xl-12 -->
	</div> <!-- .row -->
</form>

@section ScriptsBlock {
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

	<!-- Dependências Kendo -->
	<!-- Caso seu layout já inclua jQuery, mantenha o include abaixo comentado -->
	@* <script src="https://cdn.kendostatic.com/2022.1.412/js/jquery.min.js"></script> *@
	<script src="https://cdn.kendostatic.com/2022.1.412/js/jszip.min.js"></script>
	<script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.all.min.js"></script>
	<script src="https://cdn.kendostatic.com/2022.1.412/js/kendo.aspnetmvc.min.js"></script>

	<!-- PDF.js -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.js"></script>
	<script>
		window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.2/pdf.worker.js';
	</script>

	<script src="~/js/cadastros/tiraacento_001.js"></script>

	<script>
		function stopEnterSubmitting(e) {
			try {
				try {
					if (e.keyCode === 13) {
						var src = e.srcElement || e.target;

						console.log(src && src.tagName ? src.tagName.toLowerCase() : 'unknown');

						if (src && src.tagName && src.tagName.toLowerCase() !== "div") {
							if (e.preventDefault) {
								e.preventDefault();
							} else {
								e.returnValue = false;
							}
						}
					}
				} catch (error) {
					Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "stopEnterSubmitting", error);
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "stopEnterSubmitting", error);
			}
		}
	</script>

	<script>
		// Controla o Submit do formulário através de botões escondidos (permite a validação via javascript)
		// ================================================================================================
		$("#btnSubmit").on("click", function (event) {
			try {
				event.preventDefault();

				if (document.getElementById("txtDataRegistro").value === "") {
					// Requer SweetAlert no layout; caso não tenha, caia no alert nativo
					if (typeof swal === "function") {
						swal({
							title: "Informação Ausente",
							text: "A Data do Registro é obrigatória",
							icon: "error",
							buttons: {
								ok: "Ok"
							}
						});
					} else {
						alert("A Data do Registro é obrigatória.");
					}
					return;
				}

				$("#btnEscondido").trigger("click");
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "#btnSubmit.click", error);
			}
		});
	</script>

	<script>
		function toolbarClick(e) {
			try {
				if (e.item.id === "rte_toolbar_Image") {
					var element = document.getElementById('rte_upload');
					if (element && element.ej2_instances && element.ej2_instances[0]) {
						element.ej2_instances[0].uploading = function upload(args) {
							var tokenField = document.getElementsByName('__RequestVerificationToken')[0];
							if (tokenField) {
								args.currentRequest.setRequestHeader('XSRF-TOKEN', tokenField.value);
							}
						};
					}
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "toolbarClick", error);
			}
		}

		$(document).ready(function () {
			try {
				if ('@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroCupomId' !== '00000000-0000-0000-0000-000000000000') {
					// Visualiza o PDF, se houver
					if ('@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF' != null &&
						'@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF' !== '') {
						$("#pdfViewer").kendoPDFViewer({
							pdfjsProcessing: {
								file: "/DadosEditaveis/Cupons/" + '@Model.RegistroCupomAbastecimentoObj.RegistroCupomAbastecimento.RegistroPDF'
							},
							width: "100%",
							height: 400
						}).data("kendoPDFViewer");
					}
				} else {
					document.getElementById("txtDataRegistro").setAttribute('value', '');
				}
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "document.ready", error);
			}
		});
	</script>

	<script>
		// Desabilita o Drop Zone
		kendo.ui.Upload.fn._supportsDrop = function () {
			try {
				return false;
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "_supportsDrop", error);
			}
		};

		// Upload do PDF
		// ==============
		$("#pdf").kendoUpload({
			async: {
				saveUrl: "/Abastecimento/UpsertCupons?handler=SavePDF",
				removeUrl: "/Abastecimento/UpsertCupons?handler=RemovePDF"
			},
			localization: {
				select: "Selecione o Registro de Cupons de Abastecimento...",
				headerStatusUploaded: "Arquivo Carregado",
				uploadSuccess: "Arquivo Carregado com Sucesso"
			},
			validation: {
				allowedExtensions: [".pdf"]
			},
			success: onSuccess
		});

		function onSuccess(e) {
			try {
				// Remove a DIV para excluir o PDF escolhido anteriormente
				$("#pdfViewer").remove();

				// Cria DIV do PDF
				$("#PDFContainer").append("<div id='pdfViewer'></div>");

				// Informações sobre os arquivos enviados
				var files = e.files;

				$.each(files, function () {
					console.log(this.name);

					// document.getElementById("txtRegistroPDF").setAttribute('value', this.name.replaceAll(" ", "_"));
					document.getElementById("txtRegistroPDF").setAttribute('value', TiraAcento(this.name));

					console.log(document.getElementById("txtRegistroPDF").value);

					$("#pdfViewer").kendoPDFViewer({
						pdfjsProcessing: {
							file: "/DadosEditaveis/Cupons/" + document.getElementById("txtRegistroPDF").value
						},
						width: "100%",
						height: 400
					}).data("kendoPDFViewer");
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("UpsertCupons.cshtml", "onSuccess", error);
			}
		}
	</script>
}
