@page
@model FrotiX.Pages.Administracao.GestaoRecursosNavegacaoModel

@{
    ViewData["Title"] = "Gestão de Recursos e Navegação";
    ViewData["PageName"] = "administracao_gestaorecursosnavegacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-sitemap'></i> Administração: <span class='fw-300'>Gestão de Recursos e Navegação</span>";
    ViewData["Category1"] = "Administração";
    ViewData["PageIcon"] = "fa-duotone fa-sitemap";
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADRAO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .ftx-card-header .header-actions {
            display: flex;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* ====== LAYOUT PRINCIPAL ====== */
        .gestao-container {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            min-height: calc(100vh - 200px);
        }

        /* ====== COLUNA ESQUERDA - TREEVIEW ====== */
        .tree-panel {
            flex: 0 0 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .tree-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 350px);
        }

        .tree-actions {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.5rem;
        }

        /* ====== COLUNA DIREITA - PROPRIEDADES ====== */
        .props-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Card de propriedades */
        .props-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .props-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .props-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .props-body {
            padding: 1.5rem;
        }

        /* ====== FORMULARIO DE PROPRIEDADES ====== */
        .form-group {
            margin-bottom: 2rem;  /* Espaçamento vertical aumentado significativamente */
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.375rem;  /* Mantém label próxima ao controle */
            font-size: 0.875rem;
        }

        .form-group .form-control {
            border-radius: 6px;
            border: 1px solid #ced4da;
            padding: 0.5rem 0.75rem;
        }

        .form-group .form-control:focus {
            border-color: #3D5771;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15);
        }

        /* ====== CARD DE CONTROLE DE ACESSO ====== */
        .acesso-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .acesso-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .acesso-item:last-child {
            border-bottom: none;
        }

        .acesso-item label {
            flex: 1;
            margin: 0;
            cursor: pointer;
        }

        /* ====== TREEVIEW CUSTOMIZADO ====== */
        #gestaoTreeView .e-treeview {
            background: transparent;
        }

        /* REMOVE o ícone padrão do Syncfusion (evita duplicação) */
        #gestaoTreeView .e-treeview .e-list-icon {
            display: none !important;
        }

        /* REMOVE o fundo azul de seleção padrão do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-item.e-active,
        #gestaoTreeView .e-treeview .e-list-item.e-node-focus,
        #gestaoTreeView .e-treeview .e-list-item:focus,
        #gestaoTreeView .e-treeview .e-fullrow.e-active,
        #gestaoTreeView .e-treeview .e-text-content.e-active {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Remove fullrow highlight */
        #gestaoTreeView .e-treeview .e-fullrow {
            display: none !important;
        }

        #gestaoTreeView .e-list-item {
            padding: 2px 0;
            background: transparent !important;
        }

        #gestaoTreeView .e-text-content {
            background: transparent !important;
            border: none !important;
        }

        #gestaoTreeView .tree-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #gestaoTreeView .tree-node:hover {
            background: #f1f3f5;
        }

        #gestaoTreeView .tree-node.selected {
            background: rgba(61, 87, 113, 0.15) !important;
            border-left: 3px solid #3D5771;
        }

        /* Garante que o texto NÃO desaparece ao selecionar */
        #gestaoTreeView .tree-node .node-text,
        #gestaoTreeView .tree-node.selected .node-text,
        #gestaoTreeView .e-list-item .tree-node .node-text,
        #gestaoTreeView .e-list-item.e-active .tree-node .node-text,
        #gestaoTreeView .e-list-item.e-node-focus .tree-node .node-text {
            color: #333 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Texto em NEGRITO quando item está selecionado */
        #gestaoTreeView .tree-node.selected .node-text {
            font-weight: 700 !important;
        }

        /* FORÇA texto visível em TODOS os estados do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-text,
        #gestaoTreeView .e-treeview .e-text-content,
        #gestaoTreeView .e-treeview .e-list-item span,
        #gestaoTreeView .e-treeview .e-active .e-list-text,
        #gestaoTreeView .e-treeview .e-node-focus .e-list-text {
            color: #333 !important;
        }

        /* Ícones duotone com cores FrotiX */
        #gestaoTreeView .tree-node i,
        #gestaoTreeView .tree-node i.fa-duotone {
            --fa-primary-color: #a0aec0;
            --fa-secondary-color: #c67750;
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 1;
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* Ícone do item selecionado destaca com cor primária laranja */
        #gestaoTreeView .tree-node.selected i,
        #gestaoTreeView .tree-node.selected i.fa-duotone {
            --fa-primary-color: #c67750;
            --fa-secondary-color: #3D5771;
        }

        #gestaoTreeView .tree-node .node-text {
            flex: 1;
            font-size: 0.9rem;
            color: #333;
        }

        #gestaoTreeView .tree-node .node-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #e9ecef;
            color: #6c757d;
        }

        /* Drag and drop */
        #gestaoTreeView .e-drag-item {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
        }

        /* ====== BOTOES ====== */
        /* Os botões usam classes globais do FrotiX: btn-azul, btn-ftx-fechar, btn-voltar */

        /* Estado vazio */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* ====== MENSAGENS ====== */
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @@keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ====== DROPDOWNTREE DE ÍCONES - BORDAS SEMPRE VISÍVEIS ====== */
        .ddl-icone-border .e-ddt-wrapper,
        .ddl-icone-border .e-input-group,
        .ddl-icone-border.e-dropdowntree .e-input-group,
        .ddl-icone-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-icone-border .e-input-group.e-input-focus,
        .ddl-icone-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* Força bordas mesmo quando vazio */
        #ddlIcone.e-dropdowntree,
        #ddlIcone .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }

        /* ====== DROPDOWNTREE DE PÁGINAS - BORDAS SEMPRE VISÍVEIS ====== */
        .ddl-pagina-border .e-ddt-wrapper,
        .ddl-pagina-border .e-input-group,
        .ddl-pagina-border.e-dropdowntree .e-input-group,
        .ddl-pagina-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-pagina-border .e-input-group.e-input-focus,
        .ddl-pagina-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* Força bordas mesmo quando vazio */
        #ddlPagina.e-dropdowntree,
        #ddlPagina .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }
    </style>
}

<div class="ftx-card-header">
    <h2 class="titulo-paginas mb-0">
        <i class="fa-duotone fa-sitemap"></i>
        Gestão de Recursos e Navegação
    </h2>
    <div class="header-actions">
        <button type="button" class="btn btn-header-orange" onclick="migrarDadosJson()">
            <i class="fa-duotone fa-database icon-space"></i> Migrar do JSON
        </button>
        <a asp-page="/Index" class="btn btn-header-orange">
            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar
        </a>
    </div>
</div>

<div class="gestao-container">
    <!-- Coluna Esquerda: TreeView -->
    <div class="tree-panel">
        <div class="tree-header">
            <h5><i class="fa-duotone fa-folder-tree"></i> Estrutura do Menu</h5>
            <span id="itemCount" class="badge bg-secondary">0 itens</span>
        </div>
        <div class="tree-content" id="gestaoTreeView">
            <div class="empty-state" id="emptyTreeState">
                <i class="fa-duotone fa-folder-open"></i>
                <p>Nenhum recurso encontrado.<br>Clique em "Migrar do JSON" para importar ou adicione novos itens.</p>
            </div>
        </div>
        <div class="tree-actions">
            <button type="button" class="btn btn-header-orange btn-submit-spin" onclick="adicionarNovoItem()">
                <i class="fa-duotone fa-plus icon-space icon-pulse"></i> Novo Item
            </button>
            <button type="button" class="btn btn-azul btn-submit-spin" onclick="salvarOrdenacao()">
                <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Salvar Ordenação
            </button>
        </div>
    </div>

    <!-- Coluna Direita: Propriedades -->
    <div class="props-panel">
        <!-- Card: Propriedades do Item -->
        <div class="props-card" id="propsCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-sliders"></i> Propriedades do Item <span id="modoEdicao" class="badge bg-secondary ms-2">Selecione</span></h5>
                <span id="selectedItemName" class="text-muted">Nenhum item selecionado</span>
            </div>
            <div class="props-body">
                <form id="formPropriedades">
                    <input type="hidden" id="recursoId" />
                    <input type="hidden" id="parentId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNome">Nome (exibido no menu)</label>
                                <input type="text" class="form-control" id="txtNome" placeholder="Ex: Veiculos" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNomeMenu">NomeMenu (identificador único)</label>
                                <input type="text" class="form-control" id="txtNomeMenu" placeholder="Ex: veiculo" />
                            </div>
                        </div>
                    </div>

                    <!-- DropDownTree de Páginas - DEVE FICAR ANTES DO CAMPO URL -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlPagina">Selecione a Página do Sistema</label>

                                <ejs-dropdowntree id="ddlPagina"
                                                 placeholder="Busque ou selecione uma página..."
                                                 popupHeight="400px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline ddl-pagina-border"
                                                 created="onPaginaDropdownCreated">
                                </ejs-dropdowntree>

                                <small class="form-text text-muted mt-1">
                                    Ao selecionar uma página, a URL será preenchida automaticamente abaixo
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- DropDown de Seleção do Item Pai (Grupo) -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlItemPai">Item Pai (Grupo)</label>
                                <ejs-dropdownlist id="ddlItemPai"
                                                 placeholder="Selecione o grupo pai deste item..."
                                                 popupHeight="300px"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline"
                                                 change="onItemPaiChange">
                                </ejs-dropdownlist>
                                <small class="form-text text-muted mt-1">
                                    Ao mudar o Item Pai, a Ordem será recalculada automaticamente
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="txtHref">URL da Página (gerada automaticamente)</label>
                                <input type="text" class="form-control" id="txtHref" readonly
                                       placeholder="Selecione uma página acima para gerar a URL..."
                                       style="background-color: #f8f9fa; cursor: not-allowed;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="txtOrdem">Ordem (calculada automaticamente)</label>
                                <input type="number" class="form-control" id="txtOrdem" value="0" readonly
                                       style="background-color: #f8f9fa;" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="ddlIcone">Selecione o Ícone (FontAwesome 7 Pro)</label>

                                <!-- DropDownTree para seleção hierárquica -->
                                <ejs-dropdowntree id="ddlIcone"
                                                 placeholder="Busque ou selecione um ícone..."
                                                 popupHeight="400px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline ddl-icone-border"
                                                 created="onIconeDropdownCreated"
                                                 change="onIconeChange">
                                </ejs-dropdowntree>

                                <!-- Campo bloqueado exibindo a classe CSS completa do ícone selecionado -->
                                <small class="form-text text-muted mt-1">Classe CSS:</small>
                                <input type="text" class="form-control form-control-sm mt-1" id="txtIconClass" readonly
                                       placeholder="A classe do ícone aparecerá aqui..."
                                       style="background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="chkAtivo">Status</label>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" id="chkAtivo" checked />
                                    <label class="form-check-label" for="chkAtivo">Ativo no menu</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="txtDescricao">Descrição</label>
                        <textarea class="form-control" id="txtDescricao" rows="2" placeholder="Descrição do recurso..."></textarea>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-azul btn-submit-spin" onclick="salvarPropriedades()">
                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Salvar Propriedades
                        </button>
                        <button type="button" class="btn btn-ftx-fechar" onclick="excluirItem()">
                            <i class="fa-duotone fa-trash icon-space icon-pulse"></i> Excluir
                        </button>
                        <button type="button" class="btn btn-voltar" onclick="limparFormulario()">
                            <i class="fa-duotone fa-eraser icon-space icon-pulse"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card: Controle de Acesso -->
        <div class="props-card" id="acessoCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-users"></i> Controle de Acesso</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosAcessos()">
                    Marcar Todos
                </button>
            </div>
            <div class="props-body">
                <div class="acesso-list" id="listaAcessos">
                    <div class="empty-state">
                        <p class="text-muted mb-0">Selecione um item para gerenciar acessos</p>
                    </div>
                </div>
            </div>
            <div class="props-footer" style="padding: 15px; border-top: 1px solid #dee2e6; text-align: center;">
                <button type="button" class="btn btn-ftx-fechar" onclick="fecharCards()">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar Item
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
<script>
    var treeData = [];
    var treeObj = null;
    var selectedItem = null;

    // ✅ Variáveis para rastrear última seleção nos DropDownTrees
    var ultimoIconeSelecionado = null;
    var ultimaPaginaSelecionada = null;

    // Callback executado quando o DropDownTree é criado
    function onIconeDropdownCreated() {
        try {
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj) {
                // Configura template customizado para exibir ícone + label no dropdown
                ddlIconeObj.itemTemplate = function(data) {
                    // Se for uma categoria, não exibe ícone
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0;">' + data.text + '</div>';
                    }
                    // Se for um ícone, exibe o ícone FontAwesome + label
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + data.id + '" style="font-size: 18px; width: 24px; text-align: center;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                // Configura template para o valor selecionado (exibido no campo)
                ddlIconeObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + data.id + '" style="font-size: 16px; width: 20px; text-align: center;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                // ✅ Evento SELECTING: dispara ANTES de confirmar seleção (mais confiável)
                ddlIconeObj.selecting = function(args) {
                    console.log('=== SELECTING ícone (ANTES) ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a seleção na variável global IMEDIATAMENTE
                        ultimoIconeSelecionado = args.nodeData.id;

                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = args.nodeData.id;
                            console.log('✅ Classe atualizada via SELECTING:', args.nodeData.id);
                        }
                    }
                };

                // ✅ Evento SELECT: dispara ao selecionar item
                ddlIconeObj.select = function(args) {
                    console.log('=== SELECT ícone ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a seleção na variável global
                        ultimoIconeSelecionado = args.nodeData.id;

                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = args.nodeData.id;
                            console.log('✅ Classe atualizada via SELECT:', args.nodeData.id);
                        }
                    }
                };

                // ✅ Evento CHANGE: backup
                ddlIconeObj.change = function(args) {
                    onIconeChange(args);
                };

                // ✅ Evento CLOSE do popup: garante atualização ao fechar
                ddlIconeObj.close = function(args) {
                    console.log('=== CLOSE ícone ===');

                    var iconId = null;

                    // Tenta pegar o valor atual do componente
                    var valor = ddlIconeObj.value;
                    if (valor && valor.length > 0) {
                        iconId = valor[0];
                        console.log('Valor do componente:', iconId);
                    }

                    // Se não encontrou, usa a última seleção armazenada
                    if (!iconId && ultimoIconeSelecionado) {
                        iconId = ultimoIconeSelecionado;
                        console.log('Usando último ícone selecionado:', iconId);
                    }

                    // Atualiza o campo se tiver um ID válido
                    if (iconId && !iconId.includes('cat_')) {
                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = iconId;
                            console.log('✅ Classe atualizada via CLOSE:', iconId);
                        }
                    }
                };

                console.log('Templates de ícones configurados');
            }
        } catch (error) {
            console.error('Erro ao configurar template do DropDownTree:', error);
        }
    }

    // Callback APÓS o DropDownTree de ícones ser criado
    function onIconeDropdownCreated() {
        try {
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj) {
                ddlIconeObj.itemTemplate = function(data) {
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + data.id + '" style="font-size: 16px; width: 20px;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                ddlIconeObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + data.id + '" style="font-size: 14px; width: 18px;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                // Registra eventos novamente para garantir
                ddlIconeObj.select = function(args) {
                    onIconeSelect(args);
                };

                ddlIconeObj.change = function(args) {
                    onIconeChange(args);
                };

                console.log('Templates e eventos reconfigurados no created');
            }
        } catch (error) {
            console.error('Erro ao configurar template do DropDownTree:', error);
        }
    }

    // ========== FUNÇÕES DE CODIFICAÇÃO/DECODIFICAÇÃO HTML ==========

    // Decodifica entidades HTML para caracteres normais (para exibição)
    function decodeHtml(html) {
        if (!html) return html;
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    }

    // Codifica TODOS caracteres especiais e acentuados para entidades HTML (para gravação)
    function encodeHtml(text) {
        if (!text) return text;

        var result = '';
        for (var i = 0; i < text.length; i++) {
            var char = text[i];
            var code = char.charCodeAt(0);

            // Se for caractere ASCII básico (32-126) exceto < > & " '
            if (code >= 32 && code <= 126 && char !== '<' && char !== '>' && char !== '&' && char !== '"' && char !== "'") {
                result += char;
            } else {
                // Converte para entidade HTML numérica
                result += '&#' + code + ';';
            }
        }
        return result;
    }

    // Carrega dados ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
        carregarArvore();
        carregarIconesFontAwesome();
        carregarPaginasSistema();
    });

    // Popula dropdown de Item Pai com todos os grupos (não-página)
    function popularDropdownItemPai() {
        var grupos = [];

        // Função recursiva para extrair todos os grupos da árvore
        function extrairGrupos(items) {
            if (!items) return;

            items.forEach(function(item) {
                // Grupo = href vazio ou 'javascript:void(0);'
                var isGrupo = !item.href || item.href === 'javascript:void(0);';

                if (isGrupo) {
                    grupos.push({
                        id: item.id,
                        text: item.text,
                        nivel: calcularNivel(item.id)
                    });
                }

                // Recursão nos filhos
                if (item.items && item.items.length > 0) {
                    extrairGrupos(item.items);
                }
            });
        }

        // Calcula nível do item na hierarquia (quantos pais tem)
        function calcularNivel(itemId) {
            var nivel = 0;
            var item = buscarItemPorId(treeData, itemId);

            while (item && item.parentId) {
                nivel++;
                item = buscarItemPorId(treeData, item.parentId);
            }

            return nivel;
        }

        // Extrai todos os grupos da árvore
        extrairGrupos(treeData);

        // Formata texto com indentação baseada no nível E decodifica HTML
        grupos.forEach(function(grupo) {
            var indentacao = '  '.repeat(grupo.nivel);
            grupo.textFormatado = indentacao + decodeHtml(grupo.text);  // ✅ DECODIFICA
        });

        console.log('Grupos encontrados:', grupos.length);

        // Popula o DropDownList
        var ddlItemPai = document.getElementById('ddlItemPai');
        if (ddlItemPai && ddlItemPai.ej2_instances && ddlItemPai.ej2_instances[0]) {
            var ddl = ddlItemPai.ej2_instances[0];
            ddl.dataSource = grupos;
            ddl.fields = { text: 'textFormatado', value: 'id' };
            ddl.dataBind();
            console.log('✅ DropDownList de Item Pai populado');
        }
    }

    // Evento change do dropdown de Item Pai
    function onItemPaiChange(args) {
        console.log('=== Item Pai alterado ===');
        console.log('Novo Pai ID:', args.value);

        if (!args.value) {
            console.log('Pai removido - mantém ordem atual');
            return;
        }

        // Calcula nova ordem baseada nos filhos do novo pai
        calcularOrdemAutomatica(args.value);

        // Atualiza campo parentId oculto
        document.getElementById('parentId').value = args.value;
    }

    // Calcula ordem automaticamente baseada nos filhos do pai
    function calcularOrdemAutomatica(paiId) {
        console.log('Calculando ordem para pai:', paiId);

        // Busca o item pai no treeData
        var pai = buscarItemPorId(treeData, paiId);

        if (!pai) {
            console.warn('Pai não encontrado no treeData');
            document.getElementById('txtOrdem').value = 0;
            return;
        }

        // Busca todos os filhos do pai
        var filhos = pai.items || [];
        console.log('Filhos encontrados:', filhos.length);

        if (filhos.length === 0) {
            // Primeiro filho
            document.getElementById('txtOrdem').value = 0;
            console.log('✅ Ordem definida: 0 (primeiro filho)');
            return;
        }

        // Encontra a maior ordem entre os filhos
        var maiorOrdem = -1;
        filhos.forEach(function(filho) {
            var ordem = parseFloat(filho.ordem) || 0;
            if (ordem > maiorOrdem) {
                maiorOrdem = ordem;
            }
        });

        // Nova ordem = maior + 1
        var novaOrdem = maiorOrdem + 1;
        document.getElementById('txtOrdem').value = novaOrdem;
        console.log('✅ Ordem calculada:', novaOrdem, '(maior atual:', maiorOrdem, ')');
    }

    // Carrega arvore do banco de dados
    function carregarArvore() {
        fetch('/api/Navigation/GetTreeAdmin')
            .then(r => r.json())
            .then(result => {
                console.log('Dados recebidos da API:', result);
                if (result.success && result.data && result.data.length > 0) {
                    treeData = result.data;
                    document.getElementById('emptyTreeState').style.display = 'none';
                    renderizarTreeView();
                    atualizarContagem();
                    // ✅ Popula dropdown de Item Pai após carregar árvore
                    popularDropdownItemPai();
                } else {
                    document.getElementById('emptyTreeState').style.display = 'block';
                    document.getElementById('itemCount').textContent = '0 itens';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar arvore:', error);
                mostrarAlerta('Erro ao carregar dados', 'danger');
            });
    }

    // Renderiza TreeView com Syncfusion
    function renderizarTreeView() {
        // ✅ Destrói instância anterior do TreeView se existir
        if (treeObj) {
            console.log('Destruindo instância anterior do TreeView...');
            try {
                treeObj.destroy();
                treeObj = null;
            } catch (error) {
                console.warn('Erro ao destruir TreeView anterior:', error);
            }
        }

        var container = document.getElementById('gestaoTreeView');
        container.innerHTML = '<div id="treeViewControl"></div>';

        console.log('Criando nova instância do TreeView com', treeData.length, 'itens');

        treeObj = new ej.navigations.TreeView({
            fields: {
                dataSource: treeData,
                id: 'id',
                text: 'text',
                child: 'items',
                parentID: 'parentId'
            },
            nodeTemplate: function(data) {
                var badge = data.href && data.href !== 'javascript:void(0);' ? 'Página' : 'Grupo';
                var badgeClass = badge === 'Página' ? 'bg-info' : 'bg-warning text-dark';
                var displayText = decodeHtml(data.text);  // ✅ DECODIFICA para exibição
                return '<div class="tree-node" data-id="' + data.id + '">' +
                       '<i class="' + (data.icon || 'fa-duotone fa-folder') + '"></i>' +
                       '<span class="node-text">' + displayText + '</span>' +
                       '<span class="node-badge ' + badgeClass + '">' + badge + '</span>' +
                       '</div>';
            },
            allowDragAndDrop: true,
            allowMultiSelection: false,
            nodeClicked: function(args) {
                try {
                    console.log('=== nodeClicked event ===', args);

                    // Verifica se há elemento node
                    if (!args || !args.node) {
                        console.warn('Node clicado sem elemento válido:', args);
                        return;
                    }

                    // Obtém o ID do data-id do elemento DOM
                    var nodeElement = args.node;
                    var treeNodeDiv = nodeElement.querySelector('.tree-node');

                    if (!treeNodeDiv) {
                        console.error('Elemento .tree-node não encontrado dentro do node');
                        return;
                    }

                    var nodeId = treeNodeDiv.getAttribute('data-id');
                    console.log('Node clicado - ID extraído do DOM:', nodeId);

                    if (!nodeId) {
                        console.error('data-id não encontrado no elemento');
                        return;
                    }

                    // Busca dados completos no treeData
                    var itemCompleto = buscarItemPorId(treeData, nodeId);
                    console.log('Item encontrado no treeData:', itemCompleto);

                    if (itemCompleto) {
                        selecionarItem(itemCompleto);
                    } else {
                        console.error('Item não encontrado no treeData para ID:', nodeId);
                    }
                } catch (error) {
                    console.error('ERRO em nodeClicked:', error);
                    console.error('Stack:', error.stack);
                }
            },
            nodeDragStart: function(args) {
                console.log('Drag iniciado:', args.draggedNodeData);
            },
            nodeDragging: function(args) {
                // Permite arrastar para qualquer lugar
            },
            nodeDragStop: function(args) {
                console.log('Drag finalizado:', args);
                // Atualiza hierarquia apos drag-drop
                setTimeout(function() {
                    // Recarrega dados atualizados do TreeView
                    treeData = treeObj.fields.dataSource;
                    atualizarContagem();
                    mostrarAlerta('Arraste concluído. Clique em "Salvar Ordenação" para persistir.', 'info');
                }, 200);
            },
            nodeDropped: function(args) {
                console.log('Node solto:', args);
                console.log('Destino:', args.droppedNode);
                console.log('Posição:', args.dropLevel, args.dropIndex);
            },
            expandOn: 'Click'
        });

        treeObj.appendTo('#treeViewControl');
        console.log('✅ TreeView renderizado com sucesso! Total de itens:', treeData.length);
    }

    // Seleciona item e carrega propriedades
    function selecionarItem(itemData) {
        try {
            console.log('=== INICIO selecionarItem ===');
            console.log('itemData recebido:', itemData);

            if (!itemData) {
                console.error('itemData é null ou undefined');
                return;
            }

            selectedItem = itemData;

            // Mostra card de propriedades
            var propsCard = document.getElementById('propsCard');
            if (!propsCard) {
                console.error('Elemento propsCard não encontrado!');
                return;
            }
            propsCard.style.display = 'block';
            console.log('Card de propriedades mostrado');

            // Marca visualmente
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
            var node = document.querySelector('.tree-node[data-id="' + selectedItem.id + '"]');
            if (node) {
                node.classList.add('selected');
                console.log('Node marcado visualmente');
            }

            // Preenche formulario - usa os nomes corretos das propriedades (camelCase do JSON)
            var recursoId = document.getElementById('recursoId');
            var parentId = document.getElementById('parentId');
            var txtNome = document.getElementById('txtNome');
            var txtNomeMenu = document.getElementById('txtNomeMenu');
            var txtHref = document.getElementById('txtHref');
            var txtIconClass = document.getElementById('txtIconClass');
            var txtOrdem = document.getElementById('txtOrdem');
            var txtDescricao = document.getElementById('txtDescricao');
            var chkAtivo = document.getElementById('chkAtivo');
            var selectedItemName = document.getElementById('selectedItemName');
            var modoEdicao = document.getElementById('modoEdicao');

            // ✅ Preenche campos com valores DECODIFICADOS
            if (recursoId) recursoId.value = selectedItem.id || '';
            if (parentId) parentId.value = selectedItem.parentId || '';
            if (txtNome) txtNome.value = decodeHtml(selectedItem.text) || '';
            if (txtNomeMenu) txtNomeMenu.value = decodeHtml(selectedItem.nomeMenu) || '';
            if (txtHref) txtHref.value = selectedItem.href || '';
            if (txtOrdem) txtOrdem.value = selectedItem.ordem || 0;
            if (txtDescricao) txtDescricao.value = decodeHtml(selectedItem.descricao) || '';
            if (chkAtivo) chkAtivo.checked = selectedItem.ativo !== false;
            if (selectedItemName) selectedItemName.textContent = decodeHtml(selectedItem.text);

            console.log('Campos básicos preenchidos (decodificados)');

            // ========== ATUALIZA DROPDOWNTREE DE ÍCONE ==========
            var iconClass = selectedItem.icon || 'fa-regular fa-file';
            if (txtIconClass) txtIconClass.value = iconClass;

            var ddlIconeObj = document.getElementById('ddlIcone');
            if (ddlIconeObj && ddlIconeObj.ej2_instances && ddlIconeObj.ej2_instances[0]) {
                var ddlIcone = ddlIconeObj.ej2_instances[0];
                // Limpa seleção anterior
                ddlIcone.value = null;
                // Define novo valor
                setTimeout(function() {
                    ddlIcone.value = [iconClass];
                    console.log('DropDownTree de ícone atualizado para:', iconClass);
                }, 100);
            }

            // ========== ATUALIZA DROPDOWNTREE DE PÁGINA ==========
            // Busca pela paginaRef (URL) ao invés de tentar reconstruir o ID
            var href = selectedItem.href || '';
            console.log('URL do item (href):', href);

            if (href && href.endsWith('.html')) {
                var ddlPaginaObj = document.getElementById('ddlPagina');
                if (ddlPaginaObj && ddlPaginaObj.ej2_instances && ddlPaginaObj.ej2_instances[0]) {
                    var ddlPagina = ddlPaginaObj.ej2_instances[0];

                    // Busca o item pela paginaRef no dataSource
                    var pageId = null;
                    if (ddlPagina.fields && ddlPagina.fields.dataSource) {
                        var dataSource = ddlPagina.fields.dataSource;
                        console.log('Buscando página com paginaRef:', href);

                        // Itera todas as categorias (módulos)
                        for (var i = 0; i < dataSource.length; i++) {
                            var category = dataSource[i];
                            if (category.child && category.child.length > 0) {
                                // Busca nos filhos (páginas)
                                for (var j = 0; j < category.child.length; j++) {
                                    var page = category.child[j];
                                    if (page.paginaRef === href) {
                                        pageId = page.id;
                                        console.log('✅ Página encontrada! ID:', pageId, '| Módulo:', category.text, '| Página:', page.text);
                                        break;
                                    }
                                }
                            }
                            if (pageId) break;
                        }
                    }

                    if (pageId) {
                        // Limpa seleção anterior
                        ddlPagina.value = null;
                        // Define novo valor
                        setTimeout(function() {
                            ddlPagina.value = [pageId];
                            console.log('✅ DropDownTree de página atualizado para:', pageId);
                        }, 100);
                    } else {
                        console.warn('⚠️ Página não encontrada no DropDownTree para href:', href);
                    }
                }
            } else {
                console.log('URL não está no formato esperado ou está vazia');
            }

            // ========== ATUALIZA DROPDOWN DE ITEM PAI ==========
            var parentId = selectedItem.parentId;
            console.log('Parent ID do item:', parentId);

            var ddlItemPaiObj = document.getElementById('ddlItemPai');
            if (ddlItemPaiObj && ddlItemPaiObj.ej2_instances && ddlItemPaiObj.ej2_instances[0]) {
                var ddlItemPai = ddlItemPaiObj.ej2_instances[0];
                if (parentId) {
                    ddlItemPai.value = parentId;
                    console.log('✅ DropDownList de Item Pai atualizado para:', parentId);
                } else {
                    ddlItemPai.value = null;
                    console.log('Item não tem pai (é raiz)');
                }
            }

            // Atualiza indicador de modo
            if (modoEdicao) {
                modoEdicao.textContent = 'Editar';
                modoEdicao.className = 'badge bg-warning text-dark ms-2';
            }

            // ✅ Habilita Card de Propriedades (caso esteja desabilitado)
            habilitarCardPropriedades(true);

            // ✅ Carrega e mostra controle de acesso
            carregarControleAcesso(selectedItem.id);
            document.getElementById('acessoCard').style.display = 'block';

            console.log('=== FIM selecionarItem (sucesso) ===');
        } catch (error) {
            console.error('ERRO em selecionarItem:', error);
            console.error('Stack:', error.stack);
            mostrarAlerta('Erro ao selecionar item: ' + error.message, 'danger');
        }
    }

    // Busca item por ID recursivamente no treeData
    function buscarItemPorId(items, id) {
        if (!items || !id) return null;

        for (var i = 0; i < items.length; i++) {
            // Compara como string para garantir
            if (String(items[i].id) === String(id)) {
                return items[i];
            }
            if (items[i].items && items[i].items.length > 0) {
                var found = buscarItemPorId(items[i].items, id);
                if (found) return found;
            }
        }
        return null;
    }

    // Carrega ícones FontAwesome do endpoint
    function carregarIconesFontAwesome() {
        fetch('/api/Navigation/GetIconesFontAwesomeHierarquico')
            .then(r => r.json())
            .then(result => {
                console.log('Ícones FontAwesome carregados:', result);
                if (result.success && result.data) {
                    var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                    if (ddlIconeObj) {
                        // Configura os fields do DropDownTree
                        ddlIconeObj.fields = {
                            dataSource: result.data,
                            value: 'id',
                            text: 'text',
                            parentValue: 'parentId',
                            hasChildren: 'hasChild',
                            child: 'child'
                        };
                        ddlIconeObj.dataBind();
                        console.log('DropDownTree de ícones populado com', result.data.length, 'categorias');
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar ícones FontAwesome:', error);
                mostrarAlerta('Erro ao carregar ícones. Verifique o console.', 'warning');
            });
    }

    // ✅ EVENTO SELECT: Dispara AO CLICAR no ícone (não precisa clicar fora)
    function onIconeSelect(args) {
        console.log('=== onIconeSelect disparado (AO CLICAR) ===');
        console.log('args.nodeData:', args.nodeData);

        if (!args.nodeData || args.nodeData.isCategory) {
            console.log('Categoria clicada - não atualiza campo');
            return;
        }

        // No evento SELECT, os dados vêm em args.nodeData
        var iconClass = args.nodeData.id;      // "fa-duotone fa-bat"
        var iconLabel = args.nodeData.text;    // "Bastão"

        var txtIconClass = document.getElementById('txtIconClass');
        if (txtIconClass) {
            txtIconClass.value = iconClass;
            console.log('✅ Classe CSS atualizada IMEDIATAMENTE:', iconClass, '| Label:', iconLabel);
        } else {
            console.error('❌ Elemento txtIconClass não encontrado!');
        }
    }

    // ✅ EVENTO CHANGE: Backup para quando setado programaticamente
    function onIconeChange(args) {
        console.log('=== onIconeChange disparado ===');
        console.log('args completo:', args);
        console.log('args.itemData:', args.itemData);
        console.log('args.value:', args.value);

        // Quando setado programaticamente, itemData vem undefined
        // Preciso buscar o item no dataSource
        var itemData = args.itemData;

        if (!itemData && args.value && args.value.length > 0) {
            console.log('itemData undefined - buscando no dataSource...');
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj && ddlIconeObj.fields && ddlIconeObj.fields.dataSource) {
                var iconId = args.value[0];
                console.log('Buscando iconId:', iconId);

                // Busca em todas as categorias
                var dataSource = ddlIconeObj.fields.dataSource;
                for (var i = 0; i < dataSource.length; i++) {
                    var category = dataSource[i];
                    if (category.child && category.child.length > 0) {
                        for (var j = 0; j < category.child.length; j++) {
                            if (category.child[j].id === iconId) {
                                itemData = category.child[j];
                                console.log('✅ Ícone encontrado no dataSource:', itemData);
                                break;
                            }
                        }
                    }
                    if (itemData) break;
                }

                // Se não encontrou, pode ser que seja a própria classe
                if (!itemData) {
                    console.log('❌ Ícone não encontrado no dataSource - usando iconId diretamente');
                    itemData = { id: iconId, text: iconId, isCategory: false };
                }
            }
        }

        // Se não há dados ou é uma categoria, limpa o campo
        if (!itemData || itemData.isCategory) {
            document.getElementById('txtIconClass').value = '';
            console.log('Categoria selecionada ou campo limpo');
            return;
        }

        // Apenas ícones válidos (não categorias)
        var iconClass = itemData.id;      // "fa-duotone fa-bat"
        var iconLabel = itemData.text;    // "Bastão"

        // Atualiza campo de texto bloqueado com a classe CSS
        var txtIconClass = document.getElementById('txtIconClass');
        if (txtIconClass) {
            txtIconClass.value = iconClass;
            console.log('✅ Classe CSS atualizada:', iconClass, '| Label:', iconLabel);
        } else {
            console.error('❌ Elemento txtIconClass não encontrado!');
        }
    }

    // Carrega páginas do sistema
    function carregarPaginasSistema() {
        fetch('/api/Navigation/GetPaginasHierarquico')
            .then(r => r.json())
            .then(result => {
                console.log('Páginas carregadas:', result);
                if (result.success && result.data) {
                    var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                    if (ddlPaginaObj) {
                        ddlPaginaObj.fields = {
                            dataSource: result.data,
                            value: 'id',
                            text: 'text',
                            parentValue: 'parentId',
                            hasChildren: 'hasChild',
                            child: 'child'
                        };
                        ddlPaginaObj.dataBind();
                        console.log('DropDownTree de páginas populado com', result.data.length, 'módulos');
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao carregar páginas:', error);
                mostrarAlerta('Erro ao carregar páginas. Verifique o console.', 'warning');
            });
    }

    function onPaginaDropdownCreated() {
        try {
            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
            if (ddlPaginaObj) {
                ddlPaginaObj.itemTemplate = function(data) {
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="fa-regular fa-file-lines" style="font-size: 16px; width: 20px; color: #6c757d;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                ddlPaginaObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    var displayText = data.displayText || data.text;
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="fa-regular fa-file-lines" style="font-size: 14px; width: 18px; color: #6c757d;"></i>' +
                           '<span>' + displayText + '</span>' +
                           '</div>';
                };

                // ✅ Evento SELECTING: dispara ANTES de confirmar seleção (mais confiável)
                ddlPaginaObj.selecting = function(args) {
                    console.log('=== SELECTING página (ANTES) ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a seleção na variável global IMEDIATAMENTE
                        ultimaPaginaSelecionada = {
                            id: args.nodeData.id,
                            paginaRef: args.nodeData.paginaRef
                        };

                        var txtHref = document.getElementById('txtHref');
                        if (txtHref && args.nodeData.paginaRef) {
                            txtHref.value = args.nodeData.paginaRef;
                            console.log('✅ URL atualizada via SELECTING:', args.nodeData.paginaRef);
                        }
                    }
                };

                // ✅ Evento SELECT: dispara ao selecionar item
                ddlPaginaObj.select = function(args) {
                    console.log('=== SELECT página ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a seleção na variável global
                        ultimaPaginaSelecionada = {
                            id: args.nodeData.id,
                            paginaRef: args.nodeData.paginaRef
                        };

                        var txtHref = document.getElementById('txtHref');
                        if (txtHref && args.nodeData.paginaRef) {
                            txtHref.value = args.nodeData.paginaRef;
                            console.log('✅ URL atualizada via SELECT:', args.nodeData.paginaRef);
                        }
                    }
                };

                // ✅ Evento CHANGE: backup
                ddlPaginaObj.change = function(args) {
                    onPaginaChange(args);
                };

                // ✅ Evento CLOSE do popup: garante atualização ao fechar
                ddlPaginaObj.close = function(args) {
                    console.log('=== CLOSE página ===');

                    var paginaRef = null;
                    var pageId = null;

                    // Tenta pegar o valor atual do componente
                    var valor = ddlPaginaObj.value;
                    if (valor && valor.length > 0) {
                        pageId = valor[0];
                        console.log('Valor do componente:', pageId);

                        // Busca a paginaRef no dataSource
                        if (ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                            var dataSource = ddlPaginaObj.fields.dataSource;
                            for (var i = 0; i < dataSource.length; i++) {
                                var modulo = dataSource[i];
                                if (modulo.child && modulo.child.length > 0) {
                                    for (var j = 0; j < modulo.child.length; j++) {
                                        var page = modulo.child[j];
                                        if (page.id === pageId && page.paginaRef) {
                                            paginaRef = page.paginaRef;
                                            break;
                                        }
                                    }
                                }
                                if (paginaRef) break;
                            }
                        }
                    }

                    // Se não encontrou, usa a última seleção armazenada
                    if (!paginaRef && ultimaPaginaSelecionada) {
                        paginaRef = ultimaPaginaSelecionada.paginaRef;
                        console.log('Usando última página selecionada:', paginaRef);
                    }

                    // Atualiza o campo se tiver uma URL válida
                    if (paginaRef) {
                        var txtHref = document.getElementById('txtHref');
                        if (txtHref) {
                            txtHref.value = paginaRef;
                            console.log('✅ URL atualizada via CLOSE:', paginaRef);
                        }
                    }
                };

                console.log('DropDownTree de páginas configurado');
            }
        } catch (error) {
            console.error('Erro ao configurar DropDownTree de páginas:', error);
        }
    }

    // ✅ EVENTO SELECT: Dispara AO CLICAR no item (não precisa clicar fora)
    function onPaginaSelect(args) {
        console.log('=== onPaginaSelect disparado (AO CLICAR) ===');
        console.log('args.nodeData:', args.nodeData);

        if (!args.nodeData || args.nodeData.isCategory) {
            console.log('Categoria clicada - não gera URL');
            return;
        }

        // No evento SELECT, os dados vêm em args.nodeData
        var paginaRef = args.nodeData.paginaRef;
        console.log('paginaRef extraída:', paginaRef);

        var txtHref = document.getElementById('txtHref');
        if (txtHref) {
            txtHref.value = paginaRef;
            console.log('✅ URL atualizada IMEDIATAMENTE:', paginaRef);
        } else {
            console.error('❌ Elemento txtHref não encontrado!');
        }
    }

    // ✅ EVENTO CHANGE: Backup para quando setado programaticamente
    function onPaginaChange(args) {
        console.log('=== onPaginaChange disparado ===');
        console.log('args completo:', args);
        console.log('args.itemData:', args.itemData);
        console.log('args.value:', args.value);

        // Quando setado programaticamente, itemData vem undefined
        // Preciso buscar o item no dataSource
        var itemData = args.itemData;

        if (!itemData && args.value && args.value.length > 0) {
            console.log('itemData undefined - buscando no dataSource...');
            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
            if (ddlPaginaObj && ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                var pageId = args.value[0];
                console.log('Buscando pageId:', pageId);

                // Busca em todas as categorias
                var dataSource = ddlPaginaObj.fields.dataSource;
                for (var i = 0; i < dataSource.length; i++) {
                    var category = dataSource[i];
                    if (category.child && category.child.length > 0) {
                        for (var j = 0; j < category.child.length; j++) {
                            if (category.child[j].id === pageId) {
                                itemData = category.child[j];
                                console.log('✅ Item encontrado no dataSource:', itemData);
                                break;
                            }
                        }
                    }
                    if (itemData) break;
                }
            }
        }

        // Se não há dados ou é uma categoria, não faz nada
        if (!itemData || itemData.isCategory) {
            console.log('Categoria selecionada ou campo limpo - não gera URL');
            return;
        }

        // Obtém a URL gerada (formato: modulo_pagina.html)
        var paginaRef = itemData.paginaRef;
        console.log('paginaRef extraída:', paginaRef);

        var txtHref = document.getElementById('txtHref');
        if (txtHref) {
            txtHref.value = paginaRef;
            console.log('✅ URL atualizada no campo txtHref:', paginaRef);
        } else {
            console.error('❌ Elemento txtHref não encontrado!');
        }
    }

    // Carrega lista de usuarios com acesso
    function carregarControleAcesso(recursoId) {
        if (!recursoId) {
            document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
            return;
        }

        fetch('/api/Navigation/GetUsuariosAcesso?recursoId=' + recursoId)
            .then(r => r.json())
            .then(result => {
                console.log('Acessos carregados:', result);
                var container = document.getElementById('listaAcessos');
                if (result.success && result.data && result.data.length > 0) {
                    container.innerHTML = result.data.map(u =>
                        '<div class="acesso-item">' +
                        '<input type="checkbox" class="form-check-input me-2" ' +
                        'id="acesso_' + u.usuarioId + '" ' +
                        (u.acesso ? 'checked' : '') +
                        ' onchange="atualizarAcesso(\'' + u.usuarioId + '\', this.checked)" />' +
                        '<label for="acesso_' + u.usuarioId + '">' + u.nome + '</label>' +
                        '</div>'
                    ).join('');
                } else {
                    container.innerHTML = '<p class="text-muted text-center">Nenhum usuário encontrado</p>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar acessos:', error);
            });
    }

    // Atualiza acesso de usuario
    function atualizarAcesso(usuarioId, acesso) {
        if (!selectedItem) return;

        fetch('/api/Navigation/UpdateAcesso', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuarioId: usuarioId,
                recursoId: selectedItem.id,
                acesso: acesso
            })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                mostrarAlerta('Acesso atualizado!', 'success');
            } else {
                mostrarAlerta('Erro ao atualizar acesso: ' + result.message, 'danger');
            }
        });
    }

    // Salva propriedades do item
    function salvarPropriedades() {
        // ✅ CODIFICA valores antes de enviar ao backend
        var dto = {
            id: document.getElementById('recursoId').value,
            text: encodeHtml(document.getElementById('txtNome').value),
            nomeMenu: encodeHtml(document.getElementById('txtNomeMenu').value),
            href: document.getElementById('txtHref').value,
            icon: document.getElementById('txtIconClass').value,
            ordem: parseFloat(document.getElementById('txtOrdem').value) || 0,
            descricao: encodeHtml(document.getElementById('txtDescricao').value),
            ativo: document.getElementById('chkAtivo').checked,
            parentId: document.getElementById('parentId').value
        };

        console.log('DTO codificado para envio:', dto);

        if (!dto.text || !dto.nomeMenu) {
            mostrarAlerta('Preencha Nome e NomeMenu!', 'warning');
            return;
        }

        var ehNovoItem = !dto.id;  // Se não tem ID, é novo item

        fetch('/api/Navigation/SaveRecurso', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dto)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                mostrarAlerta(result.message, 'success');

                // ✅ Atualiza árvore após pequeno delay para garantir que backend processou
                setTimeout(function() {
                    carregarArvore();
                }, 300);

                var recursoId = result.id || dto.id;

                // Se foi criado novo item, habilita acesso para todos usuários
                if (ehNovoItem && recursoId) {
                    habilitarAcessoTodosUsuarios(recursoId);
                }

                // Pergunta se deseja fazer controle de acesso
                if (confirm('Deseja gerenciar o controle de acesso deste item agora?')) {
                    // Atualiza selectedItem com o ID retornado
                    if (ehNovoItem) {
                        selectedItem = {
                            id: recursoId,
                            text: dto.text,
                            nomeMenu: dto.nomeMenu,
                            href: dto.href,
                            icon: dto.icon,
                            ordem: dto.ordem,
                            descricao: dto.descricao,
                            ativo: dto.ativo,
                            parentId: dto.parentId
                        };
                        document.getElementById('recursoId').value = recursoId;
                    }

                    // Desabilita Card de Propriedades
                    habilitarCardPropriedades(false);

                    // Carrega controle de acesso
                    carregarControleAcesso(recursoId);

                    // Mostra Card de Controle de Acesso
                    document.getElementById('acessoCard').style.display = 'block';
                } else {
                    // Não quer gerenciar acesso, fecha os cards
                    document.getElementById('propsCard').style.display = 'none';
                    document.getElementById('acessoCard').style.display = 'none';
                    habilitarCardPropriedades(true);
                }
            } else {
                mostrarAlerta('Erro: ' + result.message, 'danger');
            }
        });
    }

    // Adiciona novo item
    function adicionarNovoItem() {
        // Limpa formulario mas mantém card visível
        limparFormulario(false);  // false = NÃO esconde o card

        // ✅ Habilita Card de Propriedades
        habilitarCardPropriedades(true);

        // Mostra card de propriedades
        document.getElementById('propsCard').style.display = 'block';

        // ✅ Garante que Card de Controle de Acesso está escondido ao criar novo item
        document.getElementById('acessoCard').style.display = 'none';

        document.getElementById('txtNome').focus();
        document.getElementById('selectedItemName').textContent = 'Novo Item';

        // Atualiza indicador de modo para "Criar"
        document.getElementById('modoEdicao').textContent = 'Criar';
        document.getElementById('modoEdicao').className = 'badge bg-success ms-2';
    }

    // Exclui item selecionado
    function excluirItem() {
        if (!selectedItem || !selectedItem.id) {
            mostrarAlerta('Selecione um item para excluir!', 'warning');
            return;
        }

        if (!confirm('Tem certeza que deseja excluir "' + selectedItem.text + '"?')) {
            return;
        }

        fetch('/api/Navigation/DeleteRecurso', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recursoId: selectedItem.id })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                mostrarAlerta(result.message, 'success');
                limparFormulario();
                carregarArvore();
            } else {
                mostrarAlerta('Erro: ' + result.message, 'danger');
            }
        });
    }

    // Limpa formulario
    function limparFormulario(esconderCard = true) {
        selectedItem = null;

        // ✅ Reseta variáveis de rastreamento
        ultimoIconeSelecionado = null;
        ultimaPaginaSelecionada = null;

        document.getElementById('formPropriedades').reset();
        document.getElementById('recursoId').value = '';
        document.getElementById('parentId').value = '';
        document.getElementById('txtIconClass').value = '';
        document.getElementById('selectedItemName').textContent = 'Nenhum item selecionado';

        // Limpa DropDownTree de ícones
        var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
        if (ddlIconeObj) {
            ddlIconeObj.value = null;
        }

        // Limpa DropDownTree de páginas
        var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
        if (ddlPaginaObj) {
            ddlPaginaObj.value = null;
        }

        // Limpa DropDownList de Item Pai
        var ddlItemPaiObj = document.getElementById('ddlItemPai').ej2_instances[0];
        if (ddlItemPaiObj) {
            ddlItemPaiObj.value = null;
        }

        document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
        document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));

        // Reseta indicador de modo
        document.getElementById('modoEdicao').textContent = 'Selecione';
        document.getElementById('modoEdicao').className = 'badge bg-secondary ms-2';

        // Esconde card apenas se solicitado
        if (esconderCard) {
            document.getElementById('propsCard').style.display = 'none';
        }
    }

    // Salva ordenacao apos drag-drop
    function salvarOrdenacao() {
        if (!treeObj) return;

        // Pega o dataSource atualizado do TreeView
        var dataSource = treeObj.getTreeData();
        console.log('Dados para salvar:', dataSource);

        var items = extrairItensDoTreeView(dataSource, null, 0);
        console.log('Itens extraídos:', items);

        fetch('/api/Navigation/SaveTreeToDb', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(items)
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                mostrarAlerta('Ordenação salva com sucesso!', 'success');
                carregarArvore(); // Recarrega para refletir as mudanças
            } else {
                mostrarAlerta('Erro: ' + result.message, 'danger');
            }
        });
    }

    // Extrai itens do TreeView para salvar
    function extrairItensDoTreeView(items, parentId, nivel) {
        if (!items) return [];

        var result = [];

        items.forEach(function(item, index) {
            result.push({
                id: item.id,
                text: item.text,
                nomeMenu: item.nomeMenu,
                icon: item.icon,
                href: item.href,
                parentId: parentId,
                ordem: (nivel * 100) + index + 1,
                nivel: nivel,
                ativo: item.ativo !== false,
                descricao: item.descricao,
                items: []
            });

            if (item.items && item.items.length > 0) {
                result = result.concat(extrairItensDoTreeView(item.items, item.id, nivel + 1));
            }
        });

        return result;
    }

    // Atualiza contagem de itens
    function atualizarContagem() {
        var total = contarItens(treeData);
        document.getElementById('itemCount').textContent = total + ' itens';
    }

    function contarItens(items) {
        if (!items) return 0;
        var count = items.length;
        items.forEach(function(item) {
            if (item.items && item.items.length > 0) {
                count += contarItens(item.items);
            }
        });
        return count;
    }

    // Migra dados do JSON
    function migrarDadosJson() {
        if (!confirm('Isso irá migrar os dados do nav.json para o banco de dados. Continuar?')) {
            return;
        }

        mostrarAlerta('Migrando dados...', 'info');

        fetch('/api/Navigation/MigrateFromJson', {
            method: 'POST'
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                mostrarAlerta(result.message, 'success');
                carregarArvore();
            } else {
                mostrarAlerta('Erro: ' + result.message, 'danger');
            }
        });
    }

    // Seleciona todos os acessos
    function selecionarTodosAcessos() {
        document.querySelectorAll('#listaAcessos input[type="checkbox"]').forEach(function(cb) {
            if (!cb.checked) {
                cb.checked = true;
                cb.dispatchEvent(new Event('change'));
            }
        });
    }

    // Fecha ambos os cards (Propriedades e Controle de Acesso)
    function fecharCards() {
        document.getElementById('propsCard').style.display = 'none';
        document.getElementById('acessoCard').style.display = 'none';
        habilitarCardPropriedades(true);
        limparFormulario(true);
    }

    // Habilita ou desabilita todos os campos do Card de Propriedades
    function habilitarCardPropriedades(habilitar) {
        var campos = document.querySelectorAll('#formPropriedades input, #formPropriedades textarea, #formPropriedades select, #formPropriedades button');
        campos.forEach(function(campo) {
            if (habilitar) {
                campo.removeAttribute('disabled');
                campo.style.opacity = '1';
                campo.style.cursor = 'auto';
            } else {
                campo.setAttribute('disabled', 'disabled');
                campo.style.opacity = '0.6';
                campo.style.cursor = 'not-allowed';
            }
        });

        // Mantém o botão Salvar Propriedades desabilitado quando está no modo de controle de acesso
        var btnSalvar = document.querySelector('#formPropriedades button[onclick*="salvarPropriedades"]');
        if (btnSalvar && !habilitar) {
            btnSalvar.setAttribute('disabled', 'disabled');
        }
    }

    // Habilita acesso para todos os usuários (chamado ao criar novo item)
    function habilitarAcessoTodosUsuarios(recursoId) {
        fetch('/api/Navigation/HabilitarAcessoTodosUsuarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recursoId: recursoId })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                console.log('Acessos habilitados para todos os usuários');
                carregarControleAcesso(recursoId);
            } else {
                console.error('Erro ao habilitar acessos:', result.message);
            }
        })
        .catch(error => {
            console.error('Erro ao habilitar acessos:', error);
        });
    }

    // Mostra alerta toast
    function mostrarAlerta(mensagem, tipo) {
        var existente = document.querySelector('.alert-toast');
        if (existente) existente.remove();

        var alert = document.createElement('div');
        alert.className = 'alert alert-' + tipo + ' alert-toast alert-dismissible fade show';
        alert.innerHTML = mensagem + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.body.appendChild(alert);

        setTimeout(function() {
            alert.remove();
        }, 5000);
    }
</script>
}
