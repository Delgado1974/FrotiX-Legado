@page
@model FrotiX.Pages.Administracao.GestaoRecursosNavegacaoModel

@{
    ViewData["Title"] = "Gest√£o de Recursos e Navega√ß√£o";
    ViewData["PageName"] = "administracao_gestaorecursosnavegacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-sitemap'></i> Administra√ß√£o: <span class='fw-300'>Gest√£o de Recursos e Navega√ß√£o</span>";
    ViewData["Category1"] = "Administra√ß√£o";
    ViewData["PageIcon"] = "fa-duotone fa-sitemap";
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADRAO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .ftx-card-header .header-actions {
            display: flex;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* ====== LAYOUT PRINCIPAL ====== */
        .gestao-container {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            min-height: calc(100vh - 200px);
        }

        /* ====== COLUNA ESQUERDA - TREEVIEW ====== */
        .tree-panel {
            flex: 0 0 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .tree-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 350px);
        }

        .tree-actions {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.5rem;
        }

        /* ====== COLUNA DIREITA - PROPRIEDADES ====== */
        .props-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Card de propriedades */
        .props-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .props-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .props-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .props-body {
            padding: 1.5rem;
        }

        /* ====== FORMULARIO DE PROPRIEDADES ====== */
        .form-group {
            margin-bottom: 2rem;  /* Espa√ßamento vertical aumentado significativamente */
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.375rem;  /* Mant√©m label pr√≥xima ao controle */
            font-size: 0.875rem;
        }

        /* Asteriscos obrigat√≥rios nas labels */
        .form-group label .required-asterisk {
            font-size: calc(0.875rem - 2px);
            color: #dc3545;
            font-style: italic;
            margin-left: 0.25rem;
        }

        /* Bot√µes de ordena√ß√£o */
        .order-controls {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .btn-order {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            background: #fff;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 24px;
        }

        .btn-order:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #3D5771;
            color: #3D5771;
        }

        .btn-order:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-order i {
            font-size: 0.875rem;
        }

        .order-input-group {
            display: flex;
            align-items: center;
        }

        .form-group .form-control {
            border-radius: 6px;
            border: 1px solid #ced4da;
            padding: 0.5rem 0.75rem;
        }

        .form-group .form-control:focus {
            border-color: #3D5771;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15);
        }

        /* ====== CARD DE CONTROLE DE ACESSO ====== */
        .acesso-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .acesso-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .acesso-item:last-child {
            border-bottom: none;
        }

        .acesso-item label {
            flex: 1;
            margin: 0;
            cursor: pointer;
        }

        /* ====== TREEVIEW CUSTOMIZADO ====== */
        #gestaoTreeView .e-treeview {
            background: transparent;
        }

        /* ‚úÖ LINHAS VISUAIS CONECTANDO N√ìS (Grupos e P√°ginas) */
        #gestaoTreeView .e-treeview .e-list-item {
            position: relative;
        }

        /* Container de filhos - adiciona padding para espa√ßo das linhas */
        #gestaoTreeView .e-treeview .e-list-children {
            position: relative;
            margin-left: 1.25rem;
            padding-left: 0.5rem;
            border-left: 1px solid #d0d0d0;
            opacity: 0.6;
        }

        /* Linha horizontal conectando ao n√≥ pai */
        #gestaoTreeView .e-treeview .e-list-item:not(:first-child)::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 50%;
            width: 1.25rem;
            height: 1px;
            background-color: #d0d0d0;
            opacity: 0.6;
        }

        /* REMOVE o √≠cone padr√£o do Syncfusion (evita duplica√ß√£o) */
        #gestaoTreeView .e-treeview .e-list-icon {
            display: none !important;
        }

        /* REMOVE o fundo azul de sele√ß√£o padr√£o do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-item.e-active,
        #gestaoTreeView .e-treeview .e-list-item.e-node-focus,
        #gestaoTreeView .e-treeview .e-list-item:focus,
        #gestaoTreeView .e-treeview .e-fullrow.e-active,
        #gestaoTreeView .e-treeview .e-text-content.e-active {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Remove fullrow highlight */
        #gestaoTreeView .e-treeview .e-fullrow {
            display: none !important;
        }

        #gestaoTreeView .e-list-item {
            padding: 2px 0;
            background: transparent !important;
        }

        #gestaoTreeView .e-text-content {
            background: transparent !important;
            border: none !important;
        }

        #gestaoTreeView .tree-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #gestaoTreeView .tree-node:hover {
            background: #f1f3f5;
        }

        #gestaoTreeView .tree-node.selected {
            background: rgba(61, 87, 113, 0.15) !important;
            border-left: 3px solid #3D5771;
        }

        /* Garante que o texto N√ÉO desaparece ao selecionar */
        #gestaoTreeView .tree-node .node-text,
        #gestaoTreeView .e-list-item .tree-node .node-text,
        /* Texto padr√£o quando item N√ÉO est√° selecionado */
        #gestaoTreeView .e-list-item .tree-node:not(.selected) .node-text {
            color: #333 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Texto em NEGRITO LARANJA ESCURO quando item est√° selecionado */
        #gestaoTreeView .tree-node.selected .node-text,
        #gestaoTreeView .e-list-item.e-active .tree-node.selected .node-text,
        #gestaoTreeView .e-list-item.e-node-focus .tree-node.selected .node-text {
            color: #cc5500 !important;  /* Laranja bem escuro */
            font-weight: 700 !important;  /* Negrito */
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Texto em NEGRITO para grupos (n√≥s com filhos ou href vazio) */
        #gestaoTreeView .tree-node .node-text.node-group {
            font-weight: 700;
        }

        /* FOR√áA texto vis√≠vel em TODOS os estados do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-text,
        #gestaoTreeView .e-treeview .e-text-content,
        #gestaoTreeView .e-treeview .e-list-item span,
        #gestaoTreeView .e-treeview .e-active .e-list-text,
        #gestaoTreeView .e-treeview .e-node-focus .e-list-text {
            color: #333 !important;
        }

        /* Classe para √≠cones duotone padr√£o FrotiX (reutiliz√°vel) */
        .icon-duotone-ftx {
            --fa-primary-color: #ff6b35;      /* Laranja forte */
            --fa-secondary-color: #6c757d;    /* Cinza m√©dio */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 1;
            margin-right: 0.5rem;  /* Espa√ßamento de 2 caracteres */
        }

        /* √çcones duotone com cores FrotiX padr√£o */
        #gestaoTreeView .tree-node i,
        #gestaoTreeView .tree-node i.fa-duotone {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* √çcone do item selecionado mant√©m cores padr√£o */
        #gestaoTreeView .tree-node.selected i,
        #gestaoTreeView .tree-node.selected i.fa-duotone {
            --fa-primary-color: #ff6b35;
            --fa-secondary-color: #6c757d;
        }

        /* Drop como filho - destaca item inteiro */
        #gestaoTreeView .e-drop-target-child {
            background-color: rgba(0, 123, 255, 0.2) !important;
            border: 2px dashed #007bff !important;
            border-radius: 6px;
        }

        /* Drop como irm√£o - linha indicadora */
        #gestaoTreeView .e-drop-target-sibling {
            position: relative;
        }

        #gestaoTreeView .e-drop-target-sibling::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: -2px;
            height: 3px;
            background-color: #007bff;
            border-radius: 2px;
            z-index: 10;
        }

        #gestaoTreeView .tree-node .node-text {
            flex: 1;
            font-size: 0.9rem;
            color: #333;
        }

        /* SweetAlert mais largo para dropdown de p√°ginas */
        .swal-wide {
            width: 550px !important;
            max-width: 90vw !important;
        }
        
        .swal-wide .swal2-html-container {
            text-align: center;
            padding: 1rem 1.5rem !important;
        }
        
        .swal-wide select {
            margin-top: 8px;
            border: 2px solid #3D5771;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .swal-wide select:focus {
            border-color: #ff6b35;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        /* Badge clic√°vel (transforma Grupo ‚Üî P√°gina) */
        #gestaoTreeView .tree-node .node-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #gestaoTreeView .tree-node .node-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        /* Badge P√°gina - Azul */
        #gestaoTreeView .tree-node .node-badge.badge-pagina {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: #fff;
        }
        
        #gestaoTreeView .tree-node .node-badge.badge-pagina:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        }
        
        /* Badge Grupo - Laranja */
        #gestaoTreeView .tree-node .node-badge.badge-grupo {
            background: linear-gradient(135deg, #fd7e14 0%, #e96b02 100%);
            color: #fff;
        }
        
        #gestaoTreeView .tree-node .node-badge.badge-grupo:hover {
            background: linear-gradient(135deg, #e96b02 0%, #d35400 100%);
        }

        /* Drag and drop */
        #gestaoTreeView .e-drag-item {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
        }

        /* ‚úÖ Destaca item quando pode soltar sobre ele (como filho) */
        #gestaoTreeView .e-treeview .e-list-item.e-drop-target {
            background-color: rgba(198, 119, 80, 0.1) !important;
            border: 2px dashed #c67750 !important;
            border-radius: 6px;
        }

        /* ‚úÖ Remove a seta azul padr√£o (drop indicator) entre itens quando queremos drop sobre item */
        #gestaoTreeView .e-treeview .e-drop-indicator {
            display: none !important;
        }

        /* ‚úÖ Mostra indicador visual quando pode soltar sobre item */
        #gestaoTreeView .e-treeview .e-list-item.e-drop-target::before {
            content: "üìÅ Soltar aqui para criar grupo";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: #c67750;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
            pointer-events: none;
        }

        /* ====== BOT√ïES DE NAVEGA√á√ÉO DA √ÅRVORE ====== */
        
        /* Container dos bot√µes de cada item */
        .tree-nav-buttons {
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        /* Mostra bot√µes ao passar mouse no item */
        #gestaoTreeView .tree-node:hover .tree-nav-buttons {
            opacity: 1;
        }
        
        /* Mostra bot√µes quando item est√° selecionado */
        #gestaoTreeView .tree-node.selected .tree-nav-buttons {
            opacity: 1;
        }
        
        /* Bot√£o base de navega√ß√£o */
        .tree-nav-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
            padding: 0;
        }
        
        .tree-nav-btn:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        
        .tree-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .tree-nav-btn:disabled:hover {
            background: transparent;
        }
        
        /* √çcones das setas */
        .tree-nav-btn i {
            font-size: 0.85rem;
        }
        
        /* Setas de Ordena√ß√£o (Esquerda) - Vinho/Vermelho claro */
        .tree-nav-btn.btn-order i {
            --fa-primary-color: #722F37;      /* Vinho */
            --fa-secondary-color: #FFCCCB;    /* Vermelho claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.7;
        }
        
        .tree-nav-btn.btn-order:hover i {
            --fa-primary-color: #5a252c;      /* Vinho mais escuro */
            --fa-secondary-color: #ff9999;    /* Vermelho mais vis√≠vel */
        }
        
        /* Setas de Hierarquia (Direita) - Roxo/Azul claro */
        .tree-nav-btn.btn-level i {
            --fa-primary-color: #6B3FA0;      /* Roxo */
            --fa-secondary-color: #ADD8E6;    /* Azul claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.7;
        }
        
        .tree-nav-btn.btn-level:hover i {
            --fa-primary-color: #522f7a;      /* Roxo mais escuro */
            --fa-secondary-color: #87CEEB;    /* Azul mais vis√≠vel */
        }
        
        /* Separador entre bot√µes esquerda/direita e o conte√∫do */
        .tree-nav-separator {
            width: 1px;
            height: 20px;
            background: #dee2e6;
            margin: 0 4px;
        }
        
        /* ====== CARD DE CONFIRMA√á√ÉO DE ALTERA√á√ïES ====== */
        .tree-changes-card {
            display: none !important;  /* Oculto por padr√£o */
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            margin: 0 1.5rem 1rem 1.5rem;  /* Margem para alinhar com o container */
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        .tree-changes-card.show {
            display: flex !important;
            animation: slideIn 0.3s ease;
        }
        
        @@keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tree-changes-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .tree-changes-info i {
            color: #ffc107;
        }
        
        .tree-changes-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Bot√£o Confirmar (Check-mark) - Azul Petr√≥leo padr√£o FrotiX */
        .btn-confirmar-alteracoes {
            width: 28px;
            height: 28px;
            border: none;
            background: #3D5771;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .btn-confirmar-alteracoes:hover {
            background: #2d4154;
            transform: scale(1.08);
        }
        
        .btn-confirmar-alteracoes i {
            font-size: 0.95rem;
            --fa-primary-color: #fff;         /* Branco */
            --fa-secondary-color: #a0c4e8;    /* Azul claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.8;
        }
        
        /* Bot√£o Cancelar (X no c√≠rculo) - Vinho padr√£o FrotiX */
        .btn-cancelar-alteracoes {
            width: 28px;
            height: 28px;
            border: none;
            background: #722F37;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .btn-cancelar-alteracoes:hover {
            background: #5a252b;
            transform: scale(1.08);
        }
        
        .btn-cancelar-alteracoes i {
            font-size: 0.95rem;
            --fa-primary-color: #fff;         /* Branco */
            --fa-secondary-color: #FFCCCB;    /* Vermelho claro */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.8;
        }
        
        /* ====== TOGGLE TIPO DE ITEM (P√ÅGINA/GRUPO) ====== */
        .tipo-item-toggle {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #3D5771;
        }
        
        .tipo-item-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
        }
        
        .tipo-item-btn:first-child {
            border-right: 1px solid #dee2e6;
        }
        
        .tipo-item-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tipo-item-btn.active {
            background: #3D5771;
            color: #fff;
        }
        
        .tipo-item-btn i {
            font-size: 1.1rem;
        }
        
        .tipo-item-btn.active i {
            --fa-primary-color: #fff;
            --fa-secondary-color: #a0c4e8;
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 0.8;
        }
        
        .tipo-item-btn:not(.active) i {
            --fa-primary-color: #6c757d;
            --fa-secondary-color: #adb5bd;
        }

        /* ====== BOTOES ====== */
        /* Os bot√µes usam classes globais do FrotiX: btn-azul, btn-ftx-fechar, btn-voltar */

        /* Estado vazio */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* ====== MENSAGENS ====== */
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @@keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ====== DROPDOWNTREE DE √çCONES - BORDAS SEMPRE VIS√çVEIS ====== */
        .ddl-icone-border .e-ddt-wrapper,
        .ddl-icone-border .e-input-group,
        .ddl-icone-border.e-dropdowntree .e-input-group,
        .ddl-icone-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-icone-border .e-input-group.e-input-focus,
        .ddl-icone-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* For√ßa bordas mesmo quando vazio */
        #ddlIcone.e-dropdowntree,
        #ddlIcone .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }

        /* ====== DROPDOWNTREE DE P√ÅGINAS - BORDAS SEMPRE VIS√çVEIS ====== */
        .ddl-pagina-border .e-ddt-wrapper,
        .ddl-pagina-border .e-input-group,
        .ddl-pagina-border.e-dropdowntree .e-input-group,
        .ddl-pagina-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-pagina-border .e-input-group.e-input-focus,
        .ddl-pagina-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* For√ßa bordas mesmo quando vazio */
        #ddlPagina.e-dropdowntree,
        #ddlPagina .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }
    </style>
}

<div class="ftx-card-header">
    <h2 class="titulo-paginas mb-0">
        <i class="fa-duotone fa-sitemap"></i>
        Gest√£o de Recursos e Navega√ß√£o
    </h2>
    <div class="header-actions">
        <button type="button" class="btn btn-header-orange" onclick="migrarDadosJson()">
            <i class="fa-duotone fa-database icon-space"></i> Migrar do JSON
        </button>
        <a asp-page="/Index" class="btn btn-header-orange">
            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar
        </a>
    </div>
</div>

<div class="gestao-container">
    <!-- Coluna Esquerda: TreeView -->
    <div class="tree-panel">
        <div class="tree-header">
            <h5><i class="fa-duotone fa-folder-tree"></i> Estrutura do Menu</h5>
            <span id="itemCount" class="badge bg-secondary">0 itens</span>
        </div>
        
        <!-- ‚úÖ Card de Confirma√ß√£o de Altera√ß√µes (dentro do tree-panel) -->
        <div class="tree-changes-card" id="treeChangesCard">
            <div class="tree-changes-info">
                <i class="fa-duotone fa-triangle-exclamation"></i>
                <span id="changesMessage">Altera√ß√µes pendentes</span>
            </div>
            <div class="tree-changes-actions">
                <button type="button" class="btn-confirmar-alteracoes" id="btnConfirmarAlteracoes" title="Confirmar e salvar">
                    <i class="fa-duotone fa-circle-check"></i>
                </button>
                <button type="button" class="btn-cancelar-alteracoes" id="btnCancelarAlteracoes" title="Cancelar altera√ß√µes">
                    <i class="fa-duotone fa-circle-xmark"></i>
                </button>
            </div>
        </div>
        <div class="tree-content" id="gestaoTreeView">
            <div class="empty-state" id="emptyTreeState">
                <i class="fa-duotone fa-folder-open"></i>
                <p>Nenhum recurso encontrado.<br>Clique em "Migrar do JSON" para importar ou adicione novos itens.</p>
            </div>
        </div>
        
        <div class="tree-actions">
            <button type="button" class="btn btn-header-orange btn-submit-spin" onclick="adicionarNovoItem()">
                <i class="fa-duotone fa-plus icon-space icon-pulse"></i> Novo Item
            </button>
            <!-- ‚úÖ REMOVIDO: Salvamento agora √© autom√°tico ap√≥s drag-drop -->
        </div>
    </div>

    <!-- Coluna Direita: Propriedades -->
    <div class="props-panel">
        <!-- Card: Propriedades do Item -->
        <div class="props-card" id="propsCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-sliders"></i> Propriedades do Item <span id="modoEdicao" class="badge bg-secondary ms-2">Selecione</span></h5>
                <span id="selectedItemName" class="text-muted">Nenhum item selecionado</span>
            </div>
            <div class="props-body">
                <form id="formPropriedades">
                    <input type="hidden" id="recursoId" />
                    <input type="hidden" id="parentId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNome">Nome (exibido no menu)<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="txtNome" placeholder="Ex: Veiculos" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNomeMenu">NomeMenu (identificador √∫nico)<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="txtNomeMenu" placeholder="Ex: veiculo" />
                            </div>
                        </div>
                    </div>

                    <!-- DropDownTree de P√°ginas - DEVE FICAR ANTES DO CAMPO URL -->
                    <!-- ‚úÖ POSICIONAR ABAIXO DE... -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlPosicao">Posicionar abaixo de...</label>
                                <ejs-dropdowntree id="ddlPosicao"
                                                 placeholder="Selecione a posi√ß√£o na estrutura..."
                                                 popupHeight="350px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline"
                                                 change="onPosicaoChange">
                                </ejs-dropdowntree>
                                <small class="form-text text-muted mt-1">
                                    O item ser√° posicionado logo ap√≥s o item selecionado
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‚úÖ TIPO DE ITEM: P√ÅGINA OU GRUPO -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label>Tipo de Item</label>
                                <div class="tipo-item-toggle" id="tipoItemToggle">
                                    <button type="button" class="tipo-item-btn active" id="btnTipoPagina" onclick="selecionarTipoItem('pagina')">
                                        <i class="fa-duotone fa-file-lines"></i>
                                        <span>P√°gina</span>
                                    </button>
                                    <button type="button" class="tipo-item-btn" id="btnTipoGrupo" onclick="selecionarTipoItem('grupo')">
                                        <i class="fa-duotone fa-folder-tree"></i>
                                        <span>Grupo</span>
                                    </button>
                                </div>
                                <input type="hidden" id="tipoItem" value="pagina" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‚úÖ SELECIONE A P√ÅGINA (s√≥ aparece se for P√°gina) -->
                    <div class="row" id="rowPaginaSistema">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlPagina">Selecione a P√°gina do Sistema<span class="required-asterisk">*</span></label>

                                <ejs-dropdowntree id="ddlPagina"
                                                 placeholder="Busque ou selecione uma p√°gina..."
                                                 popupHeight="400px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline ddl-pagina-border"
                                                 created="onPaginaDropdownCreated">
                                </ejs-dropdowntree>

                                <small class="form-text text-muted mt-1">
                                    Ao selecionar uma p√°gina, a URL ser√° preenchida automaticamente
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Campos ocultos para compatibilidade -->
                    <input type="hidden" id="ddlItemPai" />
                    <input type="hidden" id="txtOrdem" value="0" />
                    <input type="hidden" id="txtHref" />

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="ddlIcone">Selecione o √çcone (FontAwesome 7 Pro)<span class="required-asterisk">*</span></label>

                                <!-- DropDownTree para sele√ß√£o hier√°rquica -->
                                <ejs-dropdowntree id="ddlIcone"
                                                 placeholder="Busque ou selecione um √≠cone..."
                                                 popupHeight="400px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline ddl-icone-border"
                                                 created="onIconeDropdownCreated"
                                                 change="onIconeChange">
                                </ejs-dropdowntree>

                                <!-- Campo bloqueado exibindo a classe CSS completa do √≠cone selecionado -->
                                <small class="form-text text-muted mt-1">Classe CSS:</small>
                                <input type="text" class="form-control form-control-sm mt-1" id="txtIconClass" readonly
                                       placeholder="A classe do √≠cone aparecer√° aqui..."
                                       style="background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="chkAtivo">Status</label>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" id="chkAtivo" checked />
                                    <label class="form-check-label" for="chkAtivo">Ativo no menu</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="txtDescricao">Descri√ß√£o</label>
                        <textarea class="form-control" id="txtDescricao" rows="2" placeholder="Descri√ß√£o do recurso..."></textarea>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-azul btn-submit-spin" onclick="salvarPropriedades()">
                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Salvar Propriedades
                        </button>
                        <button type="button" class="btn btn-ftx-fechar" onclick="excluirItem()">
                            <i class="fa-duotone fa-trash icon-space icon-pulse"></i> Excluir
                        </button>
                        <button type="button" class="btn btn-voltar" onclick="limparFormulario()">
                            <i class="fa-duotone fa-eraser icon-space icon-pulse"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card: Controle de Acesso -->
        <div class="props-card" id="acessoCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-users"></i> Controle de Acesso</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosAcessos()">
                    Marcar Todos
                </button>
            </div>
            <div class="props-body">
                <div class="acesso-list" id="listaAcessos">
                    <div class="empty-state">
                        <p class="text-muted mb-0">Selecione um item para gerenciar acessos</p>
                    </div>
                </div>
            </div>
            <div class="props-footer" style="padding: 15px; border-top: 1px solid #dee2e6; text-align: center;">
                <button type="button" class="btn btn-ftx-fechar" onclick="fecharCards()">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar Item
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
<script>
    var treeData = [];
    var treeObj = null;
    var selectedItem = null;
    var lastDragInfo = null; // guarda informa√ß√£o do movimento para o toast
    
    // ‚úÖ Controle de altera√ß√µes pendentes na estrutura
    var treeDataOriginal = null;  // Estado original antes das altera√ß√µes
    var alteracoesPendentes = false;  // Flag para indicar se h√° altera√ß√µes n√£o salvas

    // Helper para achar √≠cone no dataSource do DropDownTree
    function findIconById(iconId) {
        try {
            var ddlIconeObj = document.getElementById('ddlIcone')?.ej2_instances?.[0];
            if (!ddlIconeObj || !ddlIconeObj.fields || !ddlIconeObj.fields.dataSource) return null;
            var ds = ddlIconeObj.fields.dataSource;
            for (var i = 0; i < ds.length; i++) {
                var cat = ds[i];
                if (cat.child && cat.child.length > 0) {
                    for (var j = 0; j < cat.child.length; j++) {
                        if (cat.child[j].id === iconId) return cat.child[j];
                    }
                }
            }
            return null;
        } catch (e) {
            console.warn('[findIconById] Erro:', e);
            return null;
        }
    }

    // ‚úÖ Vari√°veis para rastrear √∫ltima sele√ß√£o nos DropDownTrees
    var ultimoIconeSelecionado = null;
    var ultimaPaginaSelecionada = null;

    // Callback AP√ìS o DropDownTree de √≠cones ser criado
    function onIconeDropdownCreated() {
        try {
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj) {
                ddlIconeObj.itemTemplate = function(data) {
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                    }
                    // ‚úÖ Garante que seja duotone e aplica cores padr√£o FrotiX
                    var iconClass = data.id || '';
                    if (iconClass && !iconClass.includes('fa-duotone')) {
                        iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + iconClass + '" style="font-size: 16px; width: 20px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span style="color: #5f6b7a;">' + data.text + '</span>' +
                           '</div>';
                };

                ddlIconeObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    // ‚úÖ Garante que seja duotone e aplica cores padr√£o FrotiX
                    var iconClass = data.id || '';
                    if (iconClass && !iconClass.includes('fa-duotone')) {
                        iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + iconClass + '" style="font-size: 14px; width: 18px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span style="color: #5f6b7a;">' + data.text + '</span>' +
                           '</div>';
                };

                // Eventos alinhados ao comportamento de p√°ginas (aplica no primeiro clique)
                ddlIconeObj.selecting = function(args) {
                    if (args.nodeData && !args.nodeData.isCategory) {
                        ultimoIconeSelecionado = args.nodeData.id;
                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = args.nodeData.id;
                        }
                    }
                };

                ddlIconeObj.select = function(args) {
                    console.log('=== SELECT √≠cone ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        ultimoIconeSelecionado = args.nodeData.id;
                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = args.nodeData.id;
                        }
                        // ‚úÖ Define o valor e fecha o popup IMEDIATAMENTE
                        ddlIconeObj.value = [args.nodeData.id];
                        ddlIconeObj.dataBind();
                        setTimeout(function() {
                            ddlIconeObj.hidePopup();
                            // ‚úÖ Dispara change manualmente ap√≥s fechar
                            onIconeChange({ itemData: args.nodeData, value: [args.nodeData.id] });
                            // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
                            atualizarEstadoBotoesOrdenacao();
                        }, 50);
                    }
                };

                ddlIconeObj.change = function(args) {
                    onIconeChange(args);
                };

                ddlIconeObj.changeOnBlur = false;

                console.log('Templates e eventos de √≠cone configurados');
            }
        } catch (error) {
            console.error('Erro ao configurar template do DropDownTree:', error);
        }
    }

    // ========== FUN√á√ïES DE CODIFICA√á√ÉO/DECODIFICA√á√ÉO HTML ==========

    // Decodifica entidades HTML para caracteres normais (para exibi√ß√£o)
    function decodeHtml(html) {
        try {
            if (!html) return html;
            var txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        } catch (erro) {
            console.error('[decodeHtml] Erro:', erro);
            return html; // Retorna valor original em caso de erro
        }
    }

    // Codifica TODOS caracteres especiais e acentuados para entidades HTML (para grava√ß√£o)
    function encodeHtml(text) {
        try {
            if (!text) return text;

            var result = '';
            for (var i = 0; i < text.length; i++) {
                var char = text[i];
                var code = char.charCodeAt(0);

                // Se for caractere ASCII b√°sico (32-126) exceto < > & " '
                if (code >= 32 && code <= 126 && char !== '<' && char !== '>' && char !== '&' && char !== '"' && char !== "'") {
                    result += char;
                } else {
                    // Converte para entidade HTML num√©rica
                    result += '&#' + code + ';';
                }
            }
            return result;
        } catch (erro) {
            console.error('[encodeHtml] Erro:', erro);
            return text; // Retorna valor original em caso de erro
        }
    }

    // Carrega dados ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
        carregarArvore();
        carregarIconesFontAwesome();
        carregarPaginasSistema();
        
        // ‚úÖ Configura bot√µes de confirma√ß√£o/cancelamento de altera√ß√µes
        configurarBotoesAlteracoes();
    });

    // Popula dropdown de Item Pai com todos os grupos (n√£o-p√°gina)
    function popularDropdownItemPai() {
        try {
            var grupos = [];

            // ‚úÖ Adiciona op√ß√£o "<sem grupo>" no in√≠cio
            // Usa valor especial '_SEM_GRUPO_' ao inv√©s de null para dropdown conseguir selecionar visualmente
            grupos.push({
                id: '_SEM_GRUPO_',
                text: '<sem grupo>',
                textFormatado: '<sem grupo>',
                textoSemIndentacao: '<sem grupo>',
                nivel: -1
            });

            // Fun√ß√£o recursiva para extrair todos os grupos da √°rvore
            function extrairGrupos(items) {
                if (!items) return;

                items.forEach(function(item) {
                    // Grupo = href vazio ou 'javascript:void(0);'
                    var isGrupo = !item.href || item.href === 'javascript:void(0);';

                    if (isGrupo) {
                        grupos.push({
                            id: item.id,
                            text: item.text,
                            nivel: calcularNivel(item.id)
                        });
                    }

                    // Recurs√£o nos filhos
                    if (item.items && item.items.length > 0) {
                        extrairGrupos(item.items);
                    }
                });
            }

            // Calcula n√≠vel do item na hierarquia (quantos pais tem)
            function calcularNivel(itemId) {
                var nivel = 0;
                var item = buscarItemPorId(treeData, itemId);

                while (item && item.parentId) {
                    nivel++;
                    item = buscarItemPorId(treeData, item.parentId);
                }

                return nivel;
            }

            // Extrai todos os grupos da √°rvore
            extrairGrupos(treeData);

            // Formata texto com indenta√ß√£o baseada no n√≠vel E decodifica HTML
            grupos.forEach(function(grupo) {
                if (grupo.id === '_SEM_GRUPO_') {
                    // "<sem grupo>" n√£o precisa indenta√ß√£o (j√° definido acima)
                    return;
                } else {
                    var textoDecodificado = decodeHtml(grupo.text);  // ‚úÖ DECODIFICA
                    var indentacao = '  '.repeat(grupo.nivel);
                    grupo.textFormatado = indentacao + textoDecodificado;  // Com indenta√ß√£o para exibi√ß√£o
                    grupo.textoSemIndentacao = textoDecodificado;  // Sem indenta√ß√£o para ordena√ß√£o
                }
            });

            // ‚úÖ Ordena alfabeticamente pelo texto SEM indenta√ß√£o (exceto "<sem grupo>" que fica primeiro)
            grupos.sort(function(a, b) {
                if (a.id === '_SEM_GRUPO_') return -1; // "<sem grupo>" sempre primeiro
                if (b.id === '_SEM_GRUPO_') return 1;
                // Ordena pelo texto sem indenta√ß√£o para ordena√ß√£o correta
                return a.textoSemIndentacao.localeCompare(b.textoSemIndentacao, 'pt-BR', { sensitivity: 'base' });
            });

            console.log('Grupos encontrados:', grupos.length - 1, '+ <sem grupo>');
            // ‚úÖ Dropdown removido - hierarquia agora √© gerenciada pelos bot√µes de seta
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "popularDropdownItemPai", erro);
        }
    }
    
    // =====================================================
    // ‚úÖ CONTROLES DE POSI√á√ÉO E TIPO DE ITEM
    // =====================================================
    
    // Popula o dropdown "Posicionar abaixo de..."
    function popularDropdownPosicao() {
        try {
            var itens = [];
            
            // Adiciona op√ß√£o "No in√≠cio (raiz)"
            itens.push({
                id: '_INICIO_',
                text: 'üìç No in√≠cio (primeiro item)',
                hasChildren: false
            });
            
            // Fun√ß√£o recursiva para extrair todos os itens com hierarquia
            function extrairItensHierarquicos(lista, nivel) {
                lista.forEach(function(item) {
                    var indentacao = '  '.repeat(nivel);
                    var icone = (item.items && item.items.length > 0) ? 'üìÅ' : 'üìÑ';
                    
                    itens.push({
                        id: item.id,
                        text: indentacao + icone + ' ' + decodeHtml(item.text),
                        hasChildren: false
                    });
                    
                    if (item.items && item.items.length > 0) {
                        extrairItensHierarquicos(item.items, nivel + 1);
                    }
                });
            }
            
            extrairItensHierarquicos(treeData, 0);
            
            // Popula o DropDownTree
            var ddlPosicao = document.getElementById('ddlPosicao');
            if (ddlPosicao && ddlPosicao.ej2_instances && ddlPosicao.ej2_instances[0]) {
                var ddl = ddlPosicao.ej2_instances[0];
                ddl.fields = {
                    dataSource: itens,
                    value: 'id',
                    text: 'text',
                    hasChildren: 'hasChildren'
                };
                ddl.dataBind();
                console.log('‚úÖ Dropdown de posi√ß√£o populado com', itens.length, 'itens');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "popularDropdownPosicao", erro);
        }
    }
    
    // Alterna entre P√°gina e Grupo
    function selecionarTipoItem(tipo) {
        try {
            var btnPagina = document.getElementById('btnTipoPagina');
            var btnGrupo = document.getElementById('btnTipoGrupo');
            var tipoItemInput = document.getElementById('tipoItem');
            var rowPagina = document.getElementById('rowPaginaSistema');
            
            if (tipo === 'pagina') {
                btnPagina.classList.add('active');
                btnGrupo.classList.remove('active');
                tipoItemInput.value = 'pagina';
                
                // Mostra sele√ß√£o de p√°gina
                if (rowPagina) rowPagina.style.display = 'block';
                
            } else {
                btnPagina.classList.remove('active');
                btnGrupo.classList.add('active');
                tipoItemInput.value = 'grupo';
                
                // Esconde sele√ß√£o de p√°gina
                if (rowPagina) rowPagina.style.display = 'none';
                
                // Limpa URL quando vira grupo
                document.getElementById('txtHref').value = '';
            }
            
            console.log('[TIPO] Tipo de item alterado para:', tipo);
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "selecionarTipoItem", erro);
        }
    }
    
    // Evento de mudan√ßa de posi√ß√£o
    function onPosicaoChange(args) {
        try {
            console.log('[POSI√á√ÉO] Nova posi√ß√£o selecionada:', args.value);
            // A posi√ß√£o ser√° aplicada ao salvar
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPosicaoChange", erro);
        }
    }
    
    // Atualiza o toggle de tipo baseado no item selecionado
    function atualizarToggleTipo(item) {
        if (!item) return;
        
        var ehGrupo = !item.href || item.href === 'javascript:void(0);' || (item.items && item.items.length > 0);
        
        if (ehGrupo) {
            selecionarTipoItem('grupo');
        } else {
            selecionarTipoItem('pagina');
        }
    }
    
    // ‚úÖ Alterna tipo do item (clique no badge)
    function alternarTipoItem(itemId, event) {
        try {
            console.log('[TOGGLE-TIPO] Alternando tipo do item:', itemId);
            
            var item = buscarItemPorId(treeData, itemId);
            if (!item) {
                console.error('[TOGGLE-TIPO] Item n√£o encontrado:', itemId);
                return;
            }
            
            var nomeItem = decodeHtml(item.text);
            var ehGrupoAtual = !item.href || item.href === 'javascript:void(0);';
            
            if (ehGrupoAtual) {
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // GRUPO ‚Üí P√ÅGINA
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                // Monta HTML com dropdown de p√°ginas dentro do SweetAlert
                var htmlPaginas = montarSelectPaginasParaSwal(itemId);
                
                var mensagemBase = 'O Grupo <strong>"' + nomeItem + '"</strong> ser√° transformado em uma <strong>P√°gina</strong>.<br><br>';
                
                if (item.items && item.items.length > 0) {
                    mensagemBase += '<div class="alert alert-warning" style="text-align:left; font-size:0.9rem; margin-bottom:15px;">' +
                        '<i class="fa-duotone fa-triangle-exclamation"></i> ' +
                        'Este grupo possui <strong>' + item.items.length + '</strong> filho(s).<br>' +
                        'Eles ser√£o movidos para o n√≠vel acima.' +
                        '</div>';
                }
                
                // N√£o inclui o select na mensagemBase - ser√° inserido pela fun√ß√£o do modal
                
                mostrarModalTransformacaoGrupoEmPagina('Transformar Grupo em P√°gina', mensagemBase, htmlPaginas)
                    .then(function(result) {
                        if (result.confirmado && result.paginaUrl) {
                            executarTransformacaoGrupoEmPagina(item, result.paginaUrl);
                        }
                    });
                
            } else {
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // P√ÅGINA ‚Üí GRUPO
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                // Encontra itens irm√£os ABAIXO deste item
                var irmaosAbaixo = encontrarIrmaosAbaixo(item);
                
                var mensagem = 'A P√°gina <strong>"' + nomeItem + '"</strong> ser√° transformada em <strong>Grupo</strong>.<br><br>' +
                    '<div class="alert alert-info" style="text-align:left; font-size:0.9rem;">' +
                    '<i class="fa-duotone fa-info-circle"></i> A URL da p√°gina ser√° removida.' +
                    '</div>';
                
                if (irmaosAbaixo.length > 0) {
                    // ‚úÖ Tem itens abaixo - mostra modal customizado com 4 op√ß√µes
                    mostrarModalTransformacaoPaginaEmGrupo(item, nomeItem, irmaosAbaixo);

                } else {
                    // N√£o tem itens abaixo - confirma√ß√£o simples
                    Alerta.Confirmar(
                        'Transformar P√°gina em Grupo',
                        mensagem,
                        'Sim, Transformar',
                        'Cancelar'
                    ).then(function(confirmado) {
                        if (confirmado) {
                            executarTransformacaoPaginaEmGrupo(item, false, [], null);
                        }
                    });
                }
            }
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "alternarTipoItem", erro);
        }
    }
    
    // Busca √≠cone personalizado na treeData por URL/href
    function buscarIconePorUrl(items, url) {
        try {
            if (!items || !url) return null;
            
            // Normaliza URL para compara√ß√£o (m√∫ltiplos formatos)
            var normalizarUrl = function(u) {
                if (!u) return '';
                u = u.toLowerCase().trim();
                u = u.replace(/^\//, ''); // Remove barra inicial
                u = u.replace(/\.html$/, ''); // Remove .html se existir
                u = u.replace(/\.cshtml$/, ''); // Remove .cshtml se existir
                u = u.replace(/_/g, ''); // Remove underscores para compara√ß√£o flex√≠vel
                u = u.replace(/\//g, ''); // Remove barras
                return u;
            };
            
            // Extrai partes da URL (m√≥dulo e p√°gina) para correspond√™ncia mais precisa
            var extrairPartesUrl = function(u) {
                if (!u) return { modulo: '', pagina: '', completa: '' };
                u = u.toLowerCase().trim();
                var partes = u.replace(/\.(html|cshtml)$/, '').split(/[\/_]/);
                return {
                    modulo: partes[0] || '',
                    pagina: partes[1] || partes[0] || '',
                    completa: u.replace(/\.(html|cshtml)$/, '').replace(/[\/_]/g, '')
                };
            };
            
            var urlNormalizada = normalizarUrl(url);
            var partesUrl = extrairPartesUrl(url);
            
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                
                // Compara href do item com a URL normalizada (m√∫ltiplas estrat√©gias)
                if (item.href) {
                    var hrefNormalizado = normalizarUrl(item.href);
                    var partesHref = extrairPartesUrl(item.href);
                    
                    // Estrat√©gia 1: Compara√ß√£o exata normalizada
                    var matchExato = hrefNormalizado === urlNormalizada;
                    
                    // Estrat√©gia 2: Compara√ß√£o por partes (m√≥dulo + p√°gina)
                    var matchPartes = partesHref.completa === partesUrl.completa || 
                                     (partesHref.modulo === partesUrl.modulo && partesHref.pagina === partesUrl.pagina);
                    
                    // Estrat√©gia 3: Compara√ß√£o flex√≠vel (cont√©m)
                    var matchFlexivel = hrefNormalizado.includes(urlNormalizada) || urlNormalizada.includes(hrefNormalizado);
                    
                    if ((matchExato || matchPartes || matchFlexivel) && item.icon) {
                        // Normaliza √≠cone para duotone se necess√°rio
                        var iconClass = item.icon || '';
                        if (iconClass && !iconClass.includes('fa-duotone')) {
                            iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                        }
                        return iconClass || null;
                    }
                }
                
                // Busca recursivamente nos filhos
                if (item.items && item.items.length > 0) {
                    var found = buscarIconePorUrl(item.items, url);
                    if (found) return found;
                }
            }
            
            return null;
        } catch (erro) {
            console.error('[buscarIconePorUrl]', erro);
            return null;
        }
    }
    
    // Busca item na treeData por texto/nome (para grupos/categorias)
    function buscarItemPorTexto(items, texto) {
        try {
            if (!items || !texto) return null;
            
            var textoBusca = (texto || '').toLowerCase().trim();
            
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var textoItem = (item.text || '').toLowerCase().trim();
                
                // Compara texto normalizado
                if (textoItem === textoBusca) {
                    return item;
                }
                
                // Busca recursivamente nos filhos
                if (item.items && item.items.length > 0) {
                    var found = buscarItemPorTexto(item.items, texto);
                    if (found) return found;
                }
            }
            
            return null;
        } catch (erro) {
            console.error('[buscarItemPorTexto]', erro);
            return null;
        }
    }
    
    // Monta HTML do <select> de p√°ginas com √≠cones personalizados da treeData
    function montarSelectPaginasParaSwal(itemIdExcluir) {
        try {
            var ddlPaginaObj = document.getElementById('ddlPagina');
            if (!ddlPaginaObj || !ddlPaginaObj.ej2_instances || !ddlPaginaObj.ej2_instances[0]) {
                return '<p style="color:#ff6b35;">Erro ao carregar p√°ginas</p>';
            }
            
            var ddl = ddlPaginaObj.ej2_instances[0];
            var dataSource = ddl.fields && ddl.fields.dataSource ? ddl.fields.dataSource : [];
            
            if (!dataSource || dataSource.length === 0) {
                return '<p style="color:#ff6b35; padding:20px; text-align:center;">‚ö†Ô∏è Nenhuma p√°gina dispon√≠vel. Aguarde o carregamento das p√°ginas do sistema.</p>';
            }
            
            // Lista customizada com divs clic√°veis (permite HTML e √≠cones FontAwesome)
            var html = '<div id="swalListaPaginas" style="max-height:300px; overflow-y:auto; border:2px solid #3D5771; border-radius:6px; background:#1e1e2f;">';
            
            var totalOpcoes = 0;
            
            // Fun√ß√£o recursiva para montar lista hier√°rquica com √≠cones FontAwesome oficiais
            function adicionarOpcoes(items, nivel) {
                items.forEach(function(item) {
                    var indentPx = nivel * 20;
                    var temFilhos = item.child && item.child.length > 0;
                    // Categoria √© identificada por: isCategory=true OU (tem filhos E n√£o tem paginaRef)
                    var isCategory = item.isCategory || (temFilhos && !item.paginaRef);
                    
                    // URL vem do campo paginaRef (igual ao DropDownTree)
                    var paginaUrl = item.paginaRef || item.url || '';
                    
                    // ‚úÖ Busca √≠cone personalizado na treeData (igual √† Estrutura do Menu)
                    var iconClass = '';
                    if (isCategory) {
                        // Para categorias/grupos, busca na treeData por texto/nome
                        var grupoEncontrado = buscarItemPorTexto(treeData || [], item.text);
                        if (grupoEncontrado && grupoEncontrado.icon) {
                            iconClass = grupoEncontrado.icon;
                            // Normaliza √≠cone para duotone se necess√°rio
                            if (!iconClass.includes('fa-duotone')) {
                                iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                            }
                        } else {
                            // Fallback: usa folder-tree se n√£o encontrar √≠cone personalizado
                            iconClass = 'fa-duotone fa-folder-tree';
                        }
                    } else {
                        // Para p√°ginas, busca √≠cone personalizado pela URL
                        var iconPersonalizado = buscarIconePorUrl(treeData || [], paginaUrl);
                        if (iconPersonalizado) {
                            iconClass = iconPersonalizado;
                        } else {
                            // Fallback: usa file-lines se n√£o encontrar √≠cone personalizado
                            iconClass = 'fa-duotone fa-file-lines';
                        }
                    }
                    
                    // S√≥ permite selecionar p√°ginas (n√£o categorias)
                    var podeSelecionar = !isCategory && paginaUrl;
                    
                    html += '<div class="swal-item-pagina' + (isCategory ? ' swal-item-categoria' : ' swal-item-pagina-sel') + '" ' +
                            'data-itemid="' + item.id + '" ' +
                            'data-url="' + paginaUrl + '" ' +
                            'data-iscategory="' + (isCategory ? 'true' : 'false') + '" ' +
                            'data-podeselecionar="' + (podeSelecionar ? 'true' : 'false') + '" ' +
                            'style="padding:10px 15px; padding-left:' + (15 + indentPx) + 'px; border-bottom:1px solid #2d2d4d; ' +
                            'display:flex; align-items:center; gap:8px; transition:all 0.2s; ' +
                            (isCategory ? 'font-weight:700; color:#6c757d; cursor:not-allowed; opacity:0.7;' : 'font-weight:400; color:#e0e0e0; cursor:pointer;') + '">' +
                            '<i class="' + iconClass + '" style="font-size:16px; width:20px; flex-shrink:0; --fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d;"></i>' +
                            '<span style="flex:1;">' + decodeHtml(item.text) + '</span>' +
                            (podeSelecionar ? '' : '<i class="fa-duotone fa-ban" style="font-size:14px; flex-shrink:0; --fa-primary-color:#ff4444; --fa-secondary-color:#ff8888;"></i>') +
                            '</div>';
                    totalOpcoes++;
                    
                    if (temFilhos) {
                        adicionarOpcoes(item.child, nivel + 1);
                    }
                });
            }
            
            adicionarOpcoes(dataSource, 0);
            html += '</div>';
            // Campos hidden para armazenar sele√ß√£o
            html += '<input type="hidden" id="swalPaginaSelecionada" value="" />';
            html += '<input type="hidden" id="swalUrlSelecionada" value="" />';
            
            return html;
            
        } catch (erro) {
            console.error('[SWAL-SELECT]', erro);
            return '<p style="color:#ff6b35;">Erro ao carregar p√°ginas</p>';
        }
    }
    
    // Modal customizado padr√£o FrotiX para transforma√ß√£o Grupo‚ÜíP√°gina
    function mostrarModalTransformacaoGrupoEmPagina(titulo, mensagem, htmlSelect) {
        return new Promise(function(resolve) {
            var iconHtml = '<img src="/images/confirmar_transparente.png" style="max-width: 150px; width: 100%; height: auto; margin-bottom: 10px;">';
            
            var msg = `
            <div style="background:#1e1e2f; border-radius: 8px; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #e0e0e0;">
              <div style="background:#2d2d4d; padding: 20px; text-align: center;">
                <div style="margin-bottom: 10px;">
                  <div style="display: inline-block; max-width: 200px; width: 100%;">
                    ${iconHtml}
                  </div>
                </div>
                <div style="font-size: 20px; color: #c9a8ff; font-weight: bold;">${titulo}</div>
              </div>

              <div style="padding: 20px; font-size: 15px; line-height: 1.6; text-align: center; background:#1e1e2f">
                <div style="margin-bottom: 20px;">${mensagem}</div>
                <div style="margin-top: 15px; text-align: left;">
                  <label style="font-weight:600; margin-bottom:8px; display:block; color:#e0e0e0;">Selecione a P√°gina do Sistema:</label>
                  ${htmlSelect}
                </div>
                <div id="swalMensagemErro" style="display:none; margin-top:15px; background:linear-gradient(135deg, #ff6b35, #e55a2b); color:white; padding:10px 15px; border-radius:8px; border:2px solid rgba(255,255,255,0.5); text-align:center;">
                  <i class="fa-duotone fa-triangle-exclamation" style="--fa-primary-color:#ffffff; --fa-secondary-color:#ffcc00; margin-right:8px;"></i>
                  <strong>Selecione uma p√°gina</strong> clicando em um item da lista acima!
                </div>
              </div>

              <div style="background:#3b3b5c; padding: 15px; text-align: center;">
                <button id="btnCancelTransform" style="
                  background: #722F37;
                  border: none;
                  color: #fff;
                  padding: 10px 20px;
                  margin-right: 10px;
                  font-size: 14px;
                  border-radius: 5px;
                  cursor: pointer;
                  transition: background 0.3s;
                " onmouseover="this.style.background='#5a252b'" onmouseout="this.style.background='#722F37'">
                  <i class="fa-duotone fa-circle-xmark" style="--fa-primary-color:#fff; --fa-secondary-color:#FFCCCB; margin-right: 5px;"></i>Cancelar
                </button>

                <button id="btnConfirmTransform" style="
                  background: #3D5771;
                  border: none;
                  color: #fff;
                  padding: 10px 20px;
                  font-size: 14px;
                  border-radius: 5px;
                  cursor: pointer;
                  transition: background 0.3s;
                " onmouseover="this.style.background='#2d4154'" onmouseout="this.style.background='#3D5771'">
                  <i class="fa-duotone fa-arrow-right-arrow-left" style="--fa-primary-color:#fff; --fa-secondary-color:#a0c4e8; margin-right: 5px;"></i>Transformar
                </button>
              </div>
            </div>`;

            Swal.fire({
                showConfirmButton: false,
                html: msg,
                backdrop: true,
                heightAuto: false,
                allowOutsideClick: false,
                allowEscapeKey: true,
                focusConfirm: false,
                customClass: {
                    popup: 'swal2-popup swal2-no-border swal2-no-shadow'
                },
                didOpen: function() {
                    var popup = document.querySelector('.swal2-popup');
                    if (popup) {
                        popup.style.border = 'none';
                        popup.style.boxShadow = 'none';
                        popup.style.background = 'transparent';
                    }
                    
                    // ‚úÖ Event delegation para cliques nos itens da lista
                    // Usa setTimeout para garantir que o DOM foi completamente renderizado
                    setTimeout(function() {
                        var listaPaginas = document.getElementById('swalListaPaginas');
                        if (listaPaginas) {
                            listaPaginas.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // Busca o item pai mais pr√≥ximo que tenha a classe swal-item-pagina
                                var target = e.target;
                                var item = null;
                                
                                // Tenta encontrar o item pai
                                while (target && target !== listaPaginas) {
                                    if (target.classList && target.classList.contains('swal-item-pagina')) {
                                        item = target;
                                        break;
                                    }
                                    target = target.parentElement;
                                }
                                
                                if (!item) {
                                    return;
                                }
                                
                                var podeSelecionar = item.dataset.podeselecionar === 'true';
                                var isCategory = item.dataset.iscategory === 'true';
                                
                                if (!podeSelecionar || isCategory || !item.dataset.itemid) {
                                    return; // N√£o permite selecionar categorias ou placeholder
                                }
                                
                                // Remove sele√ß√£o anterior
                                document.querySelectorAll('.swal-item-pagina').forEach(function(el) {
                                    el.style.background = 'transparent';
                                    el.style.borderLeft = 'none';
                                    el.classList.remove('swal-item-selected');
                                    delete el.dataset.selected;
                                });
                                
                                // Seleciona item atual
                                item.style.background = '#3D5771';
                                item.style.borderLeft = '3px solid #ff6b35';
                                item.classList.add('swal-item-selected');
                                item.dataset.selected = 'true';

                                // Esconde mensagem de erro quando usu√°rio seleciona uma p√°gina
                                var mensagemErro = document.getElementById('swalMensagemErro');
                                if (mensagemErro) {
                                    mensagemErro.style.display = 'none';
                                }

                                // Atualiza campos hidden
                                var paginaIdInput = document.getElementById('swalPaginaSelecionada');
                                var urlInput = document.getElementById('swalUrlSelecionada');

                                if (!paginaIdInput || !urlInput) {
                                    return;
                                }

                                paginaIdInput.value = item.dataset.itemid;
                                urlInput.value = item.dataset.url || '';
                            }, true); // useCapture = true para garantir captura
                            
                            // Hover effect para p√°ginas selecion√°veis
                            listaPaginas.addEventListener('mouseover', function(e) {
                                var target = e.target;
                                var item = null;
                                while (target && target !== listaPaginas) {
                                    if (target.classList && target.classList.contains('swal-item-pagina')) {
                                        item = target;
                                        break;
                                    }
                                    target = target.parentElement;
                                }
                                if (item && item.dataset.podeselecionar === 'true' && item.dataset.selected !== 'true') {
                                    item.style.background = '#2d2d4d';
                                }
                            }, true);
                            
                            listaPaginas.addEventListener('mouseout', function(e) {
                                var target = e.target;
                                var item = null;
                                while (target && target !== listaPaginas) {
                                    if (target.classList && target.classList.contains('swal-item-pagina')) {
                                        item = target;
                                        break;
                                    }
                                    target = target.parentElement;
                                }
                                if (item && item.dataset.selected !== 'true') {
                                    item.style.background = 'transparent';
                                }
                            }, true);
                        }
                    }, 100);
                    
                    var confirmBtn = document.getElementById('btnConfirmTransform');
                    if (confirmBtn) {
                        confirmBtn.onclick = function() {
                            var paginaIdInput = document.getElementById('swalPaginaSelecionada');
                            var urlInput = document.getElementById('swalUrlSelecionada');
                            var mensagemErro = document.getElementById('swalMensagemErro');

                            if (!paginaIdInput || !paginaIdInput.value || !urlInput || !urlInput.value) {
                                // Mostra mensagem de erro inline no modal (n√£o abre outro SweetAlert)
                                if (mensagemErro) {
                                    mensagemErro.style.display = 'block';
                                    // Scroll para a mensagem de erro
                                    mensagemErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                                return;
                            }

                            var paginaId = paginaIdInput.value;
                            var paginaUrl = urlInput.value;

                            Swal.close();
                            resolve({ confirmado: true, paginaId: paginaId, paginaUrl: paginaUrl });
                        };
                    }
                    
                    var cancelBtn = document.getElementById('btnCancelTransform');
                    if (cancelBtn) {
                        cancelBtn.onclick = function() {
                            Swal.close();
                            resolve({ confirmado: false });
                        };
                    }
                }
            });
        });
    }
    
    // Encontra itens irm√£os que est√£o ABAIXO do item atual
    function encontrarIrmaosAbaixo(item) {
        try {
            var lista = item.parentId ? null : treeData;
            
            if (item.parentId) {
                var pai = buscarItemPorId(treeData, item.parentId);
                lista = pai ? pai.items : null;
            }
            
            if (!lista) return [];
            
            var indexAtual = lista.findIndex(function(i) { return i.id === item.id; });
            if (indexAtual === -1 || indexAtual >= lista.length - 1) return [];
            
            // Retorna todos os itens ap√≥s o atual
            return lista.slice(indexAtual + 1);
            
        } catch (erro) {
            console.error('[IRMAOS-ABAIXO]', erro);
            return [];
        }
    }
    
    // Executa transforma√ß√£o GRUPO ‚Üí P√ÅGINA (salva imediatamente)
    function executarTransformacaoGrupoEmPagina(item, novaUrl) {
        try {
            // Guarda o ID do item
            var itemId = item.id;
            
            // Se tem filhos, move para o n√≠vel do pai
            if (item.items && item.items.length > 0) {
                var paiId = item.parentId;
                var listaDestino = paiId ? null : treeData;
                
                if (paiId) {
                    var pai = buscarItemPorId(treeData, paiId);
                    listaDestino = pai ? pai.items : null;
                }
                
                if (listaDestino) {
                    var indexItem = listaDestino.findIndex(function(i) { return i.id === item.id; });
                    
                    // Insere filhos ap√≥s o item
                    item.items.forEach(function(filho, idx) {
                        filho.parentId = paiId || null;
                        listaDestino.splice(indexItem + 1 + idx, 0, filho);
                    });
                }
                
                item.items = [];
            }
            
            // Define a nova URL
            item.href = novaUrl;
            
            // For√ßa reconstru√ß√£o da √°rvore
            treeData = JSON.parse(JSON.stringify(treeData));

            // ‚úÖ Atualiza TreeView SEM marcar altera√ß√µes pendentes (salva direto no banco)
            // Passa null para limpar sele√ß√£o, false para n√£o marcar pendentes
            atualizarTreeViewAposMovimento(null, false);

            // ‚úÖ Salva a estrutura completa diretamente (j√° salva href/icon)
            // N√£o usa salvarPropriedades() pois ela faz reload da p√°gina antes de terminar
            salvarOrdenacaoAutomaticaSemReload().then(function() {
                // ‚úÖ Limpa sele√ß√£o ap√≥s salvar com sucesso
                selectedItem = null;
                if (treeObj) {
                    treeObj.selectedNodes = [];
                }
                limparFormulario();

                Alerta.Sucesso('Transforma√ß√£o Realizada', 'O grupo foi transformado em p√°gina e salvo com sucesso!');

                // ‚úÖ Agora sim, recarrega a p√°gina para atualizar menu lateral
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            }).catch(function(erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoGrupoEmPagina", erro);
            });
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoGrupoEmPagina", erro);
        }
    }
    
    // ‚úÖ Modal customizado FrotiX para transforma√ß√£o P√°gina‚ÜíGrupo com 4 op√ß√µes
    function mostrarModalTransformacaoPaginaEmGrupo(item, nomeItem, irmaosAbaixo) {
        try {
            // Monta lista de itens (m√°ximo 5 + contador)
            var listaItensHtml = irmaosAbaixo.slice(0, 5).map(function(irmao) {
                return '<div style="padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.1);">‚Ä¢ ' + decodeHtml(irmao.text) + '</div>';
            }).join('');

            if (irmaosAbaixo.length > 5) {
                listaItensHtml += '<div style="padding:4px 0; font-style:italic; color:#aaa;">... e mais ' + (irmaosAbaixo.length - 5) + ' item(ns)</div>';
            }

            var htmlModal = `
            <div id="modalTransformPaginaGrupo" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
            ">
                <div style="
                    background: linear-gradient(135deg, #1e1e2f 0%, #2d2d4d 100%);
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    overflow: hidden;
                    font-family: 'Segoe UI', sans-serif;
                ">
                    <!-- Header com emoji -->
                    <div style="background:#2d2d4d; padding:25px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:50px; margin-bottom:10px;">ü§î</div>
                        <div style="font-size:22px; color:#c9a8ff; font-weight:bold;">Transformar P√°gina em Grupo</div>
                    </div>

                    <!-- Conte√∫do -->
                    <div style="padding:20px; color:#e0e0e0;">
                        <p style="text-align:center; margin-bottom:15px;">
                            A P√°gina <strong style="color:#ff6b35;">"${decodeHtml(nomeItem)}"</strong> ser√° transformada em <strong>Grupo</strong>.
                        </p>

                        <!-- Card de aviso laranja -->
                        <div style="
                            background: rgba(255,107,53,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            border-radius: 8px;
                            padding: 12px 15px;
                            margin-bottom: 20px;
                            color: #fff;
                            font-size: 0.9rem;
                        ">
                            <i class="fa-duotone fa-info-circle" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#fff; margin-right:8px;"></i>
                            A URL da p√°gina ser√° removida.
                        </div>

                        <!-- Lista de itens abaixo -->
                        <div style="text-align:left;">
                            <strong style="color:#c9a8ff;">Existem ${irmaosAbaixo.length} item(ns) abaixo desta p√°gina:</strong>
                            <div style="
                                margin-top:10px;
                                max-height:150px;
                                overflow-y:auto;
                                background:rgba(0,0,0,0.2);
                                border-radius:6px;
                                padding:10px;
                            ">
                                ${listaItensHtml}
                            </div>
                        </div>

                        <p style="text-align:center; margin-top:20px; font-weight:600; color:#c9a8ff;">
                            O que deseja fazer com estes itens?
                        </p>
                    </div>

                    <!-- Bot√µes - 4 op√ß√µes -->
                    <div style="background:#3b3b5c; padding:20px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
                        <!-- Subordinar ao Novo Grupo (Verde Militar FrotiX) -->
                        <button id="btnSubordinarNovoGrupo" style="
                            background: #4a5d23;
                            border: none;
                            color: #fff;
                            padding: 12px 16px;
                            font-size: 13px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                            flex: 1 1 45%;
                            min-width: 180px;
                        " onmouseover="this.style.background='#3d4d1c'" onmouseout="this.style.background='#4a5d23'">
                            <i class="fa-duotone fa-folder-tree" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                            Subordinar ao Novo Grupo
                        </button>

                        <!-- Subordinar a Outro Grupo (Marrom FrotiX) -->
                        <button id="btnSubordinarOutroGrupo" style="
                            background: #68432C;
                            border: none;
                            color: #fff;
                            padding: 12px 16px;
                            font-size: 13px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                            flex: 1 1 45%;
                            min-width: 180px;
                        " onmouseover="this.style.background='#523522'" onmouseout="this.style.background='#68432C'">
                            <i class="fa-duotone fa-folder-open" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                            Subordinar a Outro Grupo
                        </button>

                        <!-- Manter Onde Est√£o (Azul Petr√≥leo FrotiX) -->
                        <button id="btnManterOndeEstao" style="
                            background: #154c62;
                            border: none;
                            color: #fff;
                            padding: 12px 16px;
                            font-size: 13px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                            flex: 1 1 45%;
                            min-width: 180px;
                        " onmouseover="this.style.background='#0f3a4a'" onmouseout="this.style.background='#154c62'">
                            <i class="fa-duotone fa-location-dot" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                            Manter Onde Est√£o
                        </button>

                        <!-- Cancelar Opera√ß√£o (Vinho FrotiX) -->
                        <button id="btnCancelarTransformacao" style="
                            background: #722F37;
                            border: none;
                            color: #fff;
                            padding: 12px 16px;
                            font-size: 13px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                            flex: 1 1 45%;
                            min-width: 180px;
                        " onmouseover="this.style.background='#5a252b'" onmouseout="this.style.background='#722F37'">
                            <i class="fa-duotone fa-circle-xmark" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                            Cancelar Opera√ß√£o
                        </button>
                    </div>
                </div>
            </div>`;

            // Adiciona ao DOM
            document.body.insertAdjacentHTML('beforeend', htmlModal);

            var modal = document.getElementById('modalTransformPaginaGrupo');

            // Event listeners para os bot√µes
            document.getElementById('btnSubordinarNovoGrupo').onclick = function() {
                modal.remove();
                executarTransformacaoPaginaEmGrupo(item, true, irmaosAbaixo, null);
            };

            document.getElementById('btnSubordinarOutroGrupo').onclick = function() {
                // Abre modal de sele√ß√£o de grupo (por cima deste)
                mostrarModalSelecionarGrupoDestino(item, irmaosAbaixo, modal);
            };

            document.getElementById('btnManterOndeEstao').onclick = function() {
                modal.remove();
                // Transforma em grupo mas N√ÉO move os itens (ficam onde est√£o)
                executarTransformacaoPaginaEmGrupo(item, false, [], null);
            };

            document.getElementById('btnCancelarTransformacao').onclick = function() {
                modal.remove();
            };

            // Fecha com ESC
            var escHandler = function(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "mostrarModalTransformacaoPaginaEmGrupo", erro);
        }
    }

    // ‚úÖ Modal secund√°rio para selecionar grupo destino (aparece por cima do modal principal)
    function mostrarModalSelecionarGrupoDestino(itemOrigem, itensParaMover, modalPrincipal) {
        try {
            var htmlGrupos = montarSelectGruposParaSwal(itemOrigem.id);

            var htmlModal = `
            <div id="modalSelecionarGrupo" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100000;
            ">
                <div style="
                    background: linear-gradient(135deg, #1e1e2f 0%, #2d2d4d 100%);
                    border-radius: 12px;
                    max-width: 450px;
                    width: 90%;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    overflow: hidden;
                    font-family: 'Segoe UI', sans-serif;
                ">
                    <!-- Header -->
                    <div style="background:#2d2d4d; padding:20px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1);">
                        <div style="font-size:40px; margin-bottom:8px;">üìÅ</div>
                        <div style="font-size:18px; color:#c9a8ff; font-weight:bold;">Selecionar Grupo Destino</div>
                    </div>

                    <!-- Conte√∫do -->
                    <div style="padding:20px; color:#e0e0e0;">
                        <p style="margin-bottom:15px;">
                            Os <strong style="color:#ff6b35;">${itensParaMover.length}</strong> item(ns) ser√£o movidos para o grupo selecionado:
                        </p>

                        <div style="text-align:left;">
                            <label style="font-weight:600; margin-bottom:8px; display:block; color:#c9a8ff;">
                                Selecione o Grupo:
                            </label>
                            ${htmlGrupos}
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div style="background:#3b3b5c; padding:15px; display:flex; gap:10px; justify-content:center;">
                        <!-- Confirmar (Verde Militar) -->
                        <button id="btnConfirmarGrupo" style="
                            background: #4a5d23;
                            border: none;
                            color: #fff;
                            padding: 12px 25px;
                            font-size: 14px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='#3d4d1c'" onmouseout="this.style.background='#4a5d23'">
                            <i class="fa-duotone fa-check" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                            Confirmar
                        </button>

                        <!-- Voltar (Azul Petr√≥leo) -->
                        <button id="btnVoltarSelecao" style="
                            background: #154c62;
                            border: none;
                            color: #fff;
                            padding: 12px 25px;
                            font-size: 14px;
                            border-radius: 6px;
                            cursor: pointer;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='#0f3a4a'" onmouseout="this.style.background='#154c62'">
                            <i class="fa-duotone fa-arrow-left" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right:6px;"></i>
                            Voltar
                        </button>
                    </div>
                </div>
            </div>`;

            // Adiciona ao DOM
            document.body.insertAdjacentHTML('beforeend', htmlModal);

            var modalSelecao = document.getElementById('modalSelecionarGrupo');

            // Event listeners
            document.getElementById('btnConfirmarGrupo').onclick = function() {
                var selectGrupo = document.getElementById('swalSelectGrupo');
                if (!selectGrupo || !selectGrupo.value) {
                    Alerta.Warning('Aten√ß√£o', 'Selecione um grupo destino!');
                    return;
                }

                var grupoDestinoId = selectGrupo.value;

                // Fecha ambos os modais
                modalSelecao.remove();
                modalPrincipal.remove();

                // Executa a transforma√ß√£o
                executarTransformacaoPaginaEmGrupo(itemOrigem, false, itensParaMover, grupoDestinoId);
            };

            document.getElementById('btnVoltarSelecao').onclick = function() {
                // Apenas fecha este modal, volta pro anterior
                modalSelecao.remove();
            };

            // Fecha com ESC (volta pro modal anterior)
            var escHandler = function(e) {
                if (e.key === 'Escape') {
                    modalSelecao.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "mostrarModalSelecionarGrupoDestino", erro);
        }
    }
    
    // Monta HTML do <select> de grupos para usar no SweetAlert
    function montarSelectGruposParaSwal(itemIdExcluir) {
        try {
            var grupos = [];
            
            // Adiciona op√ß√£o "Raiz (sem grupo pai)"
            grupos.push({
                id: '_RAIZ_',
                text: 'üìç Raiz (n√≠vel principal)',
                nivel: 0
            });
            
            // Fun√ß√£o recursiva para encontrar grupos
            function coletarGrupos(items, nivel) {
                items.forEach(function(item) {
                    // √â grupo se n√£o tem href ou tem filhos
                    var ehGrupo = !item.href || item.href === 'javascript:void(0);' || (item.items && item.items.length > 0);
                    
                    // N√£o inclui o item que est√° sendo transformado
                    if (ehGrupo && item.id !== itemIdExcluir) {
                        grupos.push({
                            id: item.id,
                            text: decodeHtml(item.text),
                            nivel: nivel
                        });
                    }
                    
                    if (item.items && item.items.length > 0) {
                        coletarGrupos(item.items, nivel + 1);
                    }
                });
            }
            
            coletarGrupos(treeData, 1);
            
            var html = '<select id="swalSelectGrupo" class="form-control" style="width:100%; padding:10px; font-size:1rem; margin-top:8px;">';
            html += '<option value="">-- Selecione um grupo --</option>';
            
            grupos.forEach(function(grupo) {
                var indent = '&nbsp;&nbsp;'.repeat(grupo.nivel * 2);
                var icone = grupo.id === '_RAIZ_' ? 'üìç' : 'üìÅ';
                html += '<option value="' + grupo.id + '">' + indent + icone + ' ' + grupo.text + '</option>';
            });
            
            html += '</select>';
            
            return html;
            
        } catch (erro) {
            console.error('[SWAL-SELECT-GRUPOS]', erro);
            return '<p class="text-danger">Erro ao carregar grupos</p>';
        }
    }
    
    // Executa transforma√ß√£o P√ÅGINA ‚Üí GRUPO
    function executarTransformacaoPaginaEmGrupo(item, subordinarAoNovoGrupo, itensParaMover, grupoDestinoId) {
        try {
            // Transforma em grupo
            item.href = 'javascript:void(0);';
            item.items = item.items || [];
            
            // Obt√©m lista onde o item est√° atualmente
            var listaOrigem = item.parentId ? null : treeData;
            if (item.parentId) {
                var paiOrigem = buscarItemPorId(treeData, item.parentId);
                listaOrigem = paiOrigem ? paiOrigem.items : null;
            }
            
            if (itensParaMover && itensParaMover.length > 0 && listaOrigem) {
                if (subordinarAoNovoGrupo) {
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // OP√á√ÉO 1: Subordinar ao novo grupo (viram filhos)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    itensParaMover.forEach(function(irmao) {
                        var idx = listaOrigem.findIndex(function(i) { return i.id === irmao.id; });
                        if (idx !== -1) {
                            listaOrigem.splice(idx, 1);
                            irmao.parentId = item.id;
                            item.items.push(irmao);
                        }
                    });
                } else if (grupoDestinoId) {
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // OP√á√ÉO 2: Mover para outro grupo
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    var listaDestino;
                    var novoParentId;
                    
                    if (grupoDestinoId === '_RAIZ_') {
                        listaDestino = treeData;
                        novoParentId = null;
                    } else {
                        var grupoDestino = buscarItemPorId(treeData, grupoDestinoId);
                        if (grupoDestino) {
                            grupoDestino.items = grupoDestino.items || [];
                            listaDestino = grupoDestino.items;
                            novoParentId = grupoDestinoId;
                        }
                    }
                    
                    if (listaDestino) {
                        itensParaMover.forEach(function(irmao) {
                            var idx = listaOrigem.findIndex(function(i) { return i.id === irmao.id; });
                            if (idx !== -1) {
                                listaOrigem.splice(idx, 1);
                                irmao.parentId = novoParentId;
                                listaDestino.push(irmao);
                            }
                        });
                    }
                }
            }
            
            // For√ßa reconstru√ß√£o da √°rvore
            treeData = JSON.parse(JSON.stringify(treeData));

            // ‚úÖ Atualiza TreeView SEM marcar altera√ß√µes pendentes (salva direto no banco)
            // Passa null para limpar sele√ß√£o, false para n√£o marcar pendentes
            atualizarTreeViewAposMovimento(null, false);

            // ‚úÖ Salva a estrutura completa diretamente (j√° salva href/icon)
            // N√£o usa salvarPropriedades() pois ela faz reload da p√°gina antes de terminar
            salvarOrdenacaoAutomaticaSemReload().then(function() {
                // ‚úÖ Limpa sele√ß√£o ap√≥s salvar com sucesso
                selectedItem = null;
                if (treeObj) {
                    treeObj.selectedNodes = [];
                }
                limparFormulario();

                // Mensagem de sucesso
                var msg = 'P√°gina transformada em Grupo e salva com sucesso!';
                if (itensParaMover && itensParaMover.length > 0) {
                    if (subordinarAoNovoGrupo) {
                        msg = 'Grupo criado com ' + itensParaMover.length + ' filho(s) e salvo com sucesso!';
                    } else if (grupoDestinoId) {
                        msg = 'Grupo criado! ' + itensParaMover.length + ' item(ns) movido(s) para outro grupo. Altera√ß√µes salvas.';
                    }
                }

                Alerta.Sucesso('Transforma√ß√£o Realizada', msg);

                // ‚úÖ Agora sim, recarrega a p√°gina para atualizar menu lateral
                setTimeout(function() {
                    window.location.reload();
                }, 1500);
            }).catch(function(erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoPaginaEmGrupo", erro);
            });
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarTransformacaoPaginaEmGrupo", erro);
        }
    }
    
    // ‚úÖ REMOVIDO: Fun√ß√£o transformarGrupoEmPaginaComFilhos substitu√≠da por executarTransformacaoGrupoEmPagina
    // ‚úÖ REMOVIDO: Evento onItemPaiChange - hierarquia agora √© gerenciada pelos bot√µes de seta na TreeView

    // =====================================================
    // ‚úÖ CONTROLE DE ALTERA√á√ïES PENDENTES
    // =====================================================
    
    // Guarda o estado original do treeData (para poder cancelar altera√ß√µes)
    function guardarEstadoOriginal() {
        treeDataOriginal = JSON.parse(JSON.stringify(treeData));
        alteracoesPendentes = false;
        esconderCardAlteracoes();
        console.log('[ALTERA√á√ïES] Estado original guardado');
    }
    
    // Marca que h√° altera√ß√µes pendentes e mostra o card
    function marcarAlteracoesPendentes() {
        alteracoesPendentes = true;
        mostrarCardAlteracoes();
        console.log('[ALTERA√á√ïES] ‚ö†Ô∏è Altera√ß√µes pendentes marcadas');
    }
    
    // Mostra o card de confirma√ß√£o de altera√ß√µes
    function mostrarCardAlteracoes() {
        var card = document.getElementById('treeChangesCard');
        console.log('[ALTERA√á√ïES] Tentando mostrar card:', card);
        if (card) {
            card.classList.add('show');
            console.log('[ALTERA√á√ïES] Card show adicionado. Classes:', card.className);
        } else {
            console.error('[ALTERA√á√ïES] Card treeChangesCard n√£o encontrado!');
        }
    }
    
    // Esconde o card de confirma√ß√£o de altera√ß√µes
    function esconderCardAlteracoes() {
        var card = document.getElementById('treeChangesCard');
        if (card) {
            card.classList.remove('show');
        }
    }
    
    // Confirma as altera√ß√µes e salva no banco
    function confirmarAlteracoes() {
        try {
            console.log('[ALTERA√á√ïES] ‚úÖ Confirmando altera√ß√µes...');
            
            // Se h√° item selecionado com altera√ß√µes (ex: transforma√ß√£o de tipo), salva primeiro
            if (selectedItem && selectedItem._transformado) {
                console.log('[ALTERA√á√ïES] Item foi transformado, salvando primeiro...');
                
                // Garante que os campos do formul√°rio est√£o corretos
                var tipoItem = document.getElementById('tipoItem');
                var txtHref = document.getElementById('txtHref');
                
                if (tipoItem) tipoItem.value = 'pagina';
                if (txtHref && selectedItem._novaUrl) txtHref.value = selectedItem._novaUrl;
                
                // Salva o item transformado primeiro
                salvarPropriedades().then(function() {
                    // Remove a flag de transforma√ß√£o
                    delete selectedItem._transformado;
                    delete selectedItem._novaUrl;
                    
                    // Depois salva a √°rvore
                    salvarArvoreCompleta();
                }).catch(function(erro) {
                    console.error('[ALTERA√á√ïES] Erro ao salvar item transformado:', erro);
                    Alerta.Erro('Erro ao Salvar', 'N√£o foi poss√≠vel salvar a transforma√ß√£o do item.');
                });
                return;
            }
            
            // Salva apenas a √°rvore (reordena√ß√£o)
            salvarArvoreCompleta();
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "confirmarAlteracoes", erro);
        }
    }
    
    // Salva a √°rvore completa ap√≥s confirma√ß√£o
    function salvarArvoreCompleta() {
        try {
            // Salva no banco
            salvarOrdenacaoAutomatica();
            
            // Atualiza TreeView
            treeObj.fields.dataSource = treeData;
            treeObj.dataBind();
            treeObj.refresh();
            treeObj.expandAll();
            configurarBotoesNavegacao();
            
            // Atualiza o estado original para o novo estado
            guardarEstadoOriginal();
            
            // Esconde o card de altera√ß√µes
            alteracoesPendentes = false;
            esconderCardAlteracoes();
            
            // Mostra mensagem de sucesso
            Alerta.Sucesso('Altera√ß√µes Salvas', 'As altera√ß√µes na estrutura do menu foram salvas com sucesso!');
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarArvoreCompleta", erro);
        }
    }
    
    // Cancela as altera√ß√µes e restaura o estado original
    function cancelarAlteracoes() {
        try {
            console.log('[ALTERA√á√ïES] ‚ùå Cancelando altera√ß√µes...');
            
            if (!treeDataOriginal) {
                console.warn('[ALTERA√á√ïES] N√£o h√° estado original para restaurar');
                return;
            }
            
            // Restaura o estado original
            treeData = JSON.parse(JSON.stringify(treeDataOriginal));
            
            // Atualiza TreeView
            treeObj.fields.dataSource = treeData;
            treeObj.dataBind();
            treeObj.refresh();
            treeObj.expandAll();
            
            // Reconfigura event listeners
            configurarBotoesNavegacao();
            
            // Limpa sele√ß√£o
            selectedItem = null;
            limparFormulario(false);
            
            // Marca como sem altera√ß√µes pendentes
            alteracoesPendentes = false;
            esconderCardAlteracoes();
            
            // Mostra mensagem
            mostrarAlerta('Altera√ß√µes canceladas. Estrutura restaurada.', 'info');
            
            console.log('[ALTERA√á√ïES] ‚úÖ Estado original restaurado');
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "cancelarAlteracoes", erro);
        }
    }
    
    // Configura os event listeners dos bot√µes de confirma√ß√£o/cancelamento
    function configurarBotoesAlteracoes() {
        var btnConfirmar = document.getElementById('btnConfirmarAlteracoes');
        var btnCancelar = document.getElementById('btnCancelarAlteracoes');
        
        if (btnConfirmar) {
            btnConfirmar.onclick = confirmarAlteracoes;
        }
        if (btnCancelar) {
            btnCancelar.onclick = cancelarAlteracoes;
        }
        
        console.log('‚úÖ Bot√µes de confirma√ß√£o/cancelamento configurados');
    }

    // Calcula ordem automaticamente baseada nos filhos do pai
    function calcularOrdemAutomatica(paiId) {
        try {
            console.log('Calculando ordem para pai:', paiId);

            // Busca o item pai no treeData
            var pai = buscarItemPorId(treeData, paiId);

            if (!pai) {
                console.warn('Pai n√£o encontrado no treeData');
                document.getElementById('txtOrdem').value = 0;
                return;
            }

            // Busca todos os filhos do pai
            var filhos = pai.items || [];
            console.log('Filhos encontrados:', filhos.length);

            if (filhos.length === 0) {
                // Primeiro filho
                document.getElementById('txtOrdem').value = 0;
                console.log('‚úÖ Ordem definida: 0 (primeiro filho)');
                return;
            }

            // Encontra a maior ordem entre os filhos
            var maiorOrdem = -1;
            filhos.forEach(function(filho) {
                var ordem = parseFloat(filho.ordem) || 0;
                if (ordem > maiorOrdem) {
                    maiorOrdem = ordem;
                }
            });

            // Nova ordem = maior + 1
            var novaOrdem = maiorOrdem + 1;
            document.getElementById('txtOrdem').value = novaOrdem;
            console.log('‚úÖ Ordem calculada:', novaOrdem, '(maior atual:', maiorOrdem, ')');
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "calcularOrdemAutomatica", erro);
        }
    }

    // Carrega arvore do banco de dados
    function carregarArvore() {
        try {
            console.log('[DEBUG] Iniciando carregamento da √°rvore...');
            fetch('/api/Navigation/GetTreeAdmin')
                .then(r => {
                    console.log('[DEBUG] Response recebido:', r.status, r.statusText);
                    return r.json();
                })
                .then(result => {
                    console.log('[DEBUG] Dados recebidos da API:', result);
                    console.log('[DEBUG] result.success:', result.success);
                    console.log('[DEBUG] result.data:', result.data);
                    console.log('[DEBUG] result.data.length:', result.data ? result.data.length : 'undefined');

                    if (result.success && result.data && result.data.length > 0) {
                        console.log('[DEBUG] ‚úÖ Condi√ß√£o OK - Renderizando √°rvore com', result.data.length, 'itens');
                        treeData = result.data;

                        // Esconde estado vazio (com verifica√ß√£o de exist√™ncia)
                        var emptyState = document.getElementById('emptyTreeState');
                        if (emptyState) {
                            emptyState.style.display = 'none';
                        }

                        console.log('[DEBUG] Chamando renderizarTreeView()...');
                        renderizarTreeView();
                        console.log('[DEBUG] Chamando atualizarContagem()...');
                        atualizarContagem();
                        console.log('[DEBUG] Chamando popularDropdownItemPai()...');
                        // ‚úÖ Popula dropdown de Item Pai ap√≥s carregar √°rvore
                        popularDropdownItemPai();
                        
                        // ‚úÖ Popula dropdown de posi√ß√£o
                        popularDropdownPosicao();
                        
                        // ‚úÖ Guarda o estado original para poder cancelar altera√ß√µes
                        guardarEstadoOriginal();
                        
                        console.log('[DEBUG] ‚úÖ √Årvore carregada com sucesso!');
                    } else {
                        console.log('[DEBUG] ‚ùå Condi√ß√£o falhou - Mostrando estado vazio');
                        console.log('[DEBUG] Motivo: success=' + result.success + ', data=' + (result.data ? 'existe' : 'null/undefined') + ', length=' + (result.data ? result.data.length : 'N/A'));

                        // Mostra estado vazio (com verifica√ß√£o de exist√™ncia)
                        var emptyState = document.getElementById('emptyTreeState');
                        if (emptyState) {
                            emptyState.style.display = 'block';
                        }

                        var itemCount = document.getElementById('itemCount');
                        if (itemCount) {
                            itemCount.textContent = '0 itens';
                        }
                    }
                })
                .catch(erro => {
                    console.error('[DEBUG] ‚ùå ERRO no fetch:', erro);
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarArvore", erro);
                });
        } catch (erro) {
            console.error('[DEBUG] ‚ùå ERRO no try-catch:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarArvore", erro);
        }
    }

    // Renderiza TreeView com Syncfusion
    function renderizarTreeView() {
        try {
            console.log('[DEBUG renderizarTreeView] Iniciando renderiza√ß√£o...');
            console.log('[DEBUG renderizarTreeView] treeData:', treeData);
            console.log('[DEBUG renderizarTreeView] treeData.length:', treeData ? treeData.length : 'undefined');

            // ‚úÖ Destr√≥i inst√¢ncia anterior do TreeView se existir
            if (treeObj) {
                console.log('[DEBUG renderizarTreeView] Destruindo inst√¢ncia anterior do TreeView...');
                try {
                    treeObj.destroy();
                    treeObj = null;
                } catch (error) {
                    console.warn('[DEBUG renderizarTreeView] Erro ao destruir TreeView anterior:', error);
                }
            }

            var container = document.getElementById('gestaoTreeView');
            console.log('[DEBUG renderizarTreeView] Container encontrado:', container);
            container.innerHTML = '<div id="treeViewControl"></div>';

            console.log('[DEBUG renderizarTreeView] Criando nova inst√¢ncia do TreeView com', treeData.length, 'itens');

            treeObj = new ej.navigations.TreeView({
                fields: {
                    dataSource: treeData,
                    id: 'id',
                    text: 'text',
                    child: 'items'
                },
                nodeTemplate: function(data) {
                    // ‚úÖ REGRA: Grupo nunca tem href, apenas P√°ginas t√™m href
                    // Grupo = tem filhos OU href vazio/null/javascript:void(0)
                    var isGroup = (data.items && data.items.length > 0) || !data.href || data.href === 'javascript:void(0);' || data.href === '';
                    // Se tem href v√°lido (n√£o vazio, n√£o void), √© P√°gina
                    if (data.href && data.href !== 'javascript:void(0);' && data.href !== '') {
                        isGroup = false;
                    }
                    
                    var badge = isGroup ? 'Grupo' : 'P√°gina';
                    var badgeClass = isGroup ? 'badge-grupo' : 'badge-pagina';
                    var badgeTitle = isGroup ? 'Clique para transformar em P√°gina' : 'Clique para transformar em Grupo';
                    var displayText = decodeHtml(data.text);  // ‚úÖ DECODIFICA para exibi√ß√£o
                    
                    // ‚úÖ Normaliza √≠cone para DUOTONE
                    var iconClass = data.icon || 'fa-duotone fa-folder';
                    if (iconClass && !iconClass.includes('fa-duotone')) {
                        iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                    }
                    
                    // ‚úÖ Bot√µes de navega√ß√£o da √°rvore
                    // Usa data-itemid para evitar problemas com escape de aspas em GUIDs
                    var btnsEsquerda = 
                        '<div class="tree-nav-buttons tree-nav-left">' +
                            '<button type="button" class="tree-nav-btn btn-order btn-mover-cima" data-itemid="' + data.id + '" title="Mover para cima">' +
                                '<i class="fa-duotone fa-arrow-up-from-bracket"></i>' +
                            '</button>' +
                            '<button type="button" class="tree-nav-btn btn-order btn-mover-baixo" data-itemid="' + data.id + '" title="Mover para baixo">' +
                                '<i class="fa-duotone fa-arrow-down-from-bracket"></i>' +
                            '</button>' +
                        '</div>';
                    
                    var btnsDireita = 
                        '<div class="tree-nav-buttons tree-nav-right">' +
                            '<button type="button" class="tree-nav-btn btn-level btn-mover-esq" data-itemid="' + data.id + '" title="Subir n√≠vel (vira irm√£o do pai)">' +
                                '<i class="fa-duotone fa-arrow-left-from-bracket"></i>' +
                            '</button>' +
                            '<button type="button" class="tree-nav-btn btn-level btn-mover-dir" data-itemid="' + data.id + '" title="Descer n√≠vel (vira filho do item acima)">' +
                                '<i class="fa-duotone fa-arrow-right-from-bracket"></i>' +
                            '</button>' +
                        '</div>';
                    
                    // ‚úÖ Badge clic√°vel para alternar tipo
                    var badgeBtn = '<button type="button" class="node-badge ' + badgeClass + ' btn-toggle-tipo" ' +
                                   'data-itemid="' + data.id + '" title="' + badgeTitle + '">' + badge + '</button>';
                    
                    return '<div class="tree-node" data-id="' + data.id + '">' +
                           btnsEsquerda +
                           '<div class="tree-nav-separator"></div>' +
                           '<i class="' + iconClass + ' icon-duotone-ftx"></i>' +
                           '<span class="node-text ' + (isGroup ? 'node-group' : '') + '">' + displayText + '</span>' +
                           badgeBtn +
                           '<div class="tree-nav-separator"></div>' +
                           btnsDireita +
                           '</div>';
                },
                allowDragAndDrop: false,  // ‚úÖ DESABILITADO - usar apenas Propriedades
                allowDropSibling: false,
                allowDropChild: false,
                allowMultiSelection: false,
                nodeClicked: function(args) {
                    try {
                        console.log('=== nodeClicked event ===', args);

                        // Verifica se h√° elemento node
                        if (!args || !args.node) {
                            console.warn('Node clicado sem elemento v√°lido:', args);
                            return;
                        }

                        // Obt√©m o ID do data-id do elemento DOM
                        var nodeElement = args.node;
                        var treeNodeDiv = nodeElement.querySelector('.tree-node');

                        if (!treeNodeDiv) {
                            console.error('Elemento .tree-node n√£o encontrado dentro do node');
                            return;
                        }

                        var nodeId = treeNodeDiv.getAttribute('data-id');
                        console.log('Node clicado - ID extra√≠do do DOM:', nodeId);

                        if (!nodeId) {
                            console.error('data-id n√£o encontrado no elemento');
                            return;
                        }

                        // Busca dados completos no treeData
                        var itemCompleto = buscarItemPorId(treeData, nodeId);
                        console.log('Item encontrado no treeData:', itemCompleto);

                        if (itemCompleto) {
                            selecionarItem(itemCompleto);
                        } else {
                            console.error('Item n√£o encontrado no treeData para ID:', nodeId);
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "renderizarTreeView.nodeClicked", error);
                    }
                },
                expandOn: 'Click'
            });

            treeObj.appendTo('#treeViewControl');
            console.log('‚úÖ TreeView renderizado com sucesso! Total de itens:', treeData.length);
            
            // ‚úÖ Adiciona event listeners com delega√ß√£o para os bot√µes de navega√ß√£o
            configurarBotoesNavegacao();
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "renderizarTreeView", erro);
        }
    }
    
    // ‚úÖ Configura event listeners para bot√µes de navega√ß√£o (com delega√ß√£o)
    function configurarBotoesNavegacao() {
        var treeContainer = document.getElementById('gestaoTreeView');
        if (!treeContainer) {
            console.error('[NAV-BTNS] Container da √°rvore n√£o encontrado');
            return;
        }
        
        // Remove listeners anteriores (se houver)
        treeContainer.removeEventListener('click', handleNavButtonClick);
        
        // Adiciona listener com delega√ß√£o
        treeContainer.addEventListener('click', handleNavButtonClick, true); // useCapture = true
        
        console.log('‚úÖ Event listeners de navega√ß√£o configurados');
    }
    
    // ‚úÖ Handler para cliques nos bot√µes de navega√ß√£o
    function handleNavButtonClick(event) {
        var target = event.target;
        
        // Se clicou no √≠cone, pega o bot√£o pai
        if (target.tagName === 'I') {
            target = target.parentElement;
        }
        
        // Verifica se √© um bot√£o de navega√ß√£o OU badge de tipo
        var isNavBtn = target.classList.contains('tree-nav-btn');
        var isToggleTipo = target.classList.contains('btn-toggle-tipo');
        
        if (!isNavBtn && !isToggleTipo) {
            return; // N√£o √© um bot√£o, deixa propagar
        }
        
        // Para a propaga√ß√£o para evitar que o nodeClicked seja chamado
        event.stopPropagation();
        event.preventDefault();
        
        var itemId = target.getAttribute('data-itemid');
        console.log('[NAV-BTN] Bot√£o clicado, itemId:', itemId);
        
        if (!itemId) {
            console.error('[NAV-BTN] data-itemid n√£o encontrado no bot√£o');
            return;
        }
        
        // ‚úÖ Clique no badge de tipo (Grupo ‚Üî P√°gina)
        if (isToggleTipo) {
            alternarTipoItem(itemId, event);
            return;
        }
        
        // Identifica qual bot√£o foi clicado
        if (target.classList.contains('btn-mover-cima')) {
            moverItemCima(itemId, event);
        } else if (target.classList.contains('btn-mover-baixo')) {
            moverItemBaixo(itemId, event);
        } else if (target.classList.contains('btn-mover-esq')) {
            moverItemEsquerda(itemId, event);
        } else if (target.classList.contains('btn-mover-dir')) {
            moverItemDireita(itemId, event);
        }
    }

    // Seleciona item e carrega propriedades
    function selecionarItem(itemData) {
        try {
            console.log('=== INICIO selecionarItem ===');
            console.log('itemData recebido:', itemData);

            if (!itemData) {
                console.error('itemData √© null ou undefined');
                return;
            }

            selectedItem = itemData;

            // Mostra card de propriedades
            var propsCard = document.getElementById('propsCard');
            if (!propsCard) {
                console.error('Elemento propsCard n√£o encontrado!');
                return;
            }
            propsCard.style.display = 'block';
            console.log('Card de propriedades mostrado');

            // Marca visualmente
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
            var node = document.querySelector('.tree-node[data-id="' + selectedItem.id + '"]');
            if (node) {
                node.classList.add('selected');
                console.log('Node marcado visualmente');
            }

            // Preenche formulario - usa os nomes corretos das propriedades (camelCase do JSON)
            var recursoId = document.getElementById('recursoId');
            var parentId = document.getElementById('parentId');
            var txtNome = document.getElementById('txtNome');
            var txtNomeMenu = document.getElementById('txtNomeMenu');
            var txtHref = document.getElementById('txtHref');
            var txtIconClass = document.getElementById('txtIconClass');
            var txtOrdem = document.getElementById('txtOrdem');
            var txtDescricao = document.getElementById('txtDescricao');
            var chkAtivo = document.getElementById('chkAtivo');
            var selectedItemName = document.getElementById('selectedItemName');
            var modoEdicao = document.getElementById('modoEdicao');

            // ‚úÖ Preenche campos com valores DECODIFICADOS
            if (recursoId) recursoId.value = selectedItem.id || '';
            if (parentId) parentId.value = selectedItem.parentId || '';
            if (txtNome) txtNome.value = decodeHtml(selectedItem.text) || '';
            if (txtNomeMenu) txtNomeMenu.value = decodeHtml(selectedItem.nomeMenu) || '';
            if (txtHref) txtHref.value = selectedItem.href || '';
            if (txtOrdem) txtOrdem.value = selectedItem.ordem || 0;
            if (txtDescricao) txtDescricao.value = decodeHtml(selectedItem.descricao) || '';
            if (chkAtivo) chkAtivo.checked = selectedItem.ativo !== false;
            if (selectedItemName) selectedItemName.textContent = decodeHtml(selectedItem.text);

            console.log('Campos b√°sicos preenchidos (decodificados)');
            
            // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
            atualizarEstadoBotoesOrdenacao();

            // ========== ATUALIZA DROPDOWNTREE DE √çCONE ==========
            var iconClass = selectedItem.icon || 'fa-duotone fa-file';
            if (txtIconClass) txtIconClass.value = iconClass;

            var ddlIconeObj = document.getElementById('ddlIcone');
            if (ddlIconeObj && ddlIconeObj.ej2_instances && ddlIconeObj.ej2_instances[0]) {
                var ddlIcone = ddlIconeObj.ej2_instances[0];
                
                // ‚úÖ Converte fa-regular/fa-solid/fa-light para fa-duotone se necess√°rio
                var iconClassNormalizado = iconClass;
                if (iconClass) {
                    // Remove qualquer prefixo e adiciona fa-duotone
                    iconClassNormalizado = iconClass.replace(/^fa-(regular|solid|light|duotone)\s+/, 'fa-duotone ');
                    // Se n√£o tinha prefixo, adiciona fa-duotone
                    if (!iconClassNormalizado.startsWith('fa-')) {
                        iconClassNormalizado = 'fa-duotone ' + iconClassNormalizado;
                    }
                }
                
                // Limpa sele√ß√£o anterior
                ddlIcone.value = null;
                ddlIcone.dataBind();
                
                // Define novo valor ap√≥s um pequeno delay para garantir que o componente est√° pronto
                setTimeout(function() {
                    if (ddlIcone.fields && ddlIcone.fields.dataSource) {
                        var dataSource = ddlIcone.fields.dataSource;
                        var iconEncontrado = null;
                        
                        // Busca em todas as categorias
                        for (var i = 0; i < dataSource.length; i++) {
                            var cat = dataSource[i];
                            if (cat.child && cat.child.length > 0) {
                                for (var j = 0; j < cat.child.length; j++) {
                                    var icon = cat.child[j];
                                    // Compara com ID normalizado, original, ou apenas o nome do √≠cone
                                    var iconIdStr = String(icon.id || '');
                                    var iconClassStr = String(iconClassNormalizado || '');
                                    var iconClassOriginalStr = String(iconClass || '');
                                    
                                    // Extrai apenas o nome do √≠cone (ex: "fa-file" de "fa-duotone fa-file")
                                    var iconNameNormalizado = iconClassNormalizado.replace(/^fa-duotone\s+/, '');
                                    var iconNameOriginal = iconClassOriginalStr.replace(/^fa-(regular|solid|light|duotone)\s+/, '');
                                    
                                    if (iconIdStr === iconClassNormalizado || 
                                        iconIdStr === iconClassOriginalStr ||
                                        iconIdStr.endsWith(' ' + iconNameNormalizado) ||
                                        iconIdStr.endsWith(' ' + iconNameOriginal)) {
                                        iconEncontrado = icon;
                                        break;
                                    }
                                }
                            }
                            if (iconEncontrado) break;
                        }
                        
                        if (iconEncontrado) {
                            ddlIcone.value = [iconEncontrado.id];
                            ddlIcone.dataBind();
                            console.log('‚úÖ DropDownTree de √≠cone atualizado para:', iconEncontrado.id);
                        } else {
                            console.warn('√çcone n√£o encontrado no dataSource. Tentando:', iconClassNormalizado, 'ou', iconClass);
                        }
                    }
                }, 500);
            }

            // ========== ATUALIZA DROPDOWNTREE DE P√ÅGINA ==========
            // Busca pela paginaRef (URL) ao inv√©s de tentar reconstruir o ID
            var href = selectedItem.href || '';
            console.log('URL do item (href):', href);

            if (href && href.endsWith('.html')) {
                var ddlPaginaObj = document.getElementById('ddlPagina');
                if (ddlPaginaObj && ddlPaginaObj.ej2_instances && ddlPaginaObj.ej2_instances[0]) {
                    var ddlPagina = ddlPaginaObj.ej2_instances[0];

                    // Busca o item pela paginaRef no dataSource
                    var pageId = null;
                    if (ddlPagina.fields && ddlPagina.fields.dataSource) {
                        var dataSource = ddlPagina.fields.dataSource;
                        console.log('Buscando p√°gina com paginaRef:', href);

                        // Itera todas as categorias (m√≥dulos)
                        for (var i = 0; i < dataSource.length; i++) {
                            var category = dataSource[i];
                            if (category.child && category.child.length > 0) {
                                // Busca nos filhos (p√°ginas)
                                for (var j = 0; j < category.child.length; j++) {
                                    var page = category.child[j];
                                    if (page.paginaRef === href) {
                                        pageId = page.id;
                                        console.log('‚úÖ P√°gina encontrada! ID:', pageId, '| M√≥dulo:', category.text, '| P√°gina:', page.text);
                                        break;
                                    }
                                }
                            }
                            if (pageId) break;
                        }
                    }

                    if (pageId) {
                        // Limpa sele√ß√£o anterior
                        ddlPagina.value = null;
                        // Define novo valor
                        setTimeout(function() {
                            ddlPagina.value = [pageId];
                            console.log('‚úÖ DropDownTree de p√°gina atualizado para:', pageId);
                        }, 100);
                    } else {
                        console.warn('‚ö†Ô∏è P√°gina n√£o encontrada no DropDownTree para href:', href);
                    }
                }
            } else {
                console.log('URL n√£o est√° no formato esperado ou est√° vazia');
            }

            // ========== ATUALIZA PARENT ID (campo oculto) ==========
            var parentId = selectedItem.parentId;
            console.log('Parent ID do item:', parentId);
            document.getElementById('parentId').value = parentId || '';

            // Atualiza indicador de modo
            if (modoEdicao) {
                modoEdicao.textContent = 'Editar';
                modoEdicao.className = 'badge bg-warning text-dark ms-2';
            }

            // ‚úÖ Habilita Card de Propriedades (caso esteja desabilitado)
            habilitarCardPropriedades(true);

            // ‚úÖ Carrega e mostra controle de acesso
            carregarControleAcesso(selectedItem.id);
            document.getElementById('acessoCard').style.display = 'block';
            
            // ‚úÖ Atualiza toggle de tipo (P√°gina/Grupo)
            atualizarToggleTipo(selectedItem);

            console.log('=== FIM selecionarItem (sucesso) ===');
        } catch (error) {
            console.error('ERRO em selecionarItem:', error);
            console.error('Stack:', error.stack);
            mostrarAlerta('Erro ao selecionar item: ' + error.message, 'danger');
        }
    }

    // Busca item por ID recursivamente no treeData
    function buscarItemPorId(items, id) {
        try {
            if (!items || !id) return null;

            for (var i = 0; i < items.length; i++) {
                // Compara como string para garantir
                if (String(items[i].id) === String(id)) {
                    return items[i];
                }
                if (items[i].items && items[i].items.length > 0) {
                    var found = buscarItemPorId(items[i].items, id);
                    if (found) return found;
                }
            }
            return null;
        } catch (erro) {
            console.error('[buscarItemPorId] Erro:', erro);
            return null;
        }
    }

    // ‚úÖ Remove um item da √°rvore recursivamente
    function removerItemDaArvore(items, id) {
        try {
            if (!items || !id) return false;

            for (var i = 0; i < items.length; i++) {
                if (String(items[i].id) === String(id)) {
                    // Remove o item encontrado
                    items.splice(i, 1);
                    return true;
                }
                // Busca recursivamente nos filhos
                if (items[i].items && items[i].items.length > 0) {
                    if (removerItemDaArvore(items[i].items, id)) {
                        return true;
                    }
                }
            }
            return false;
        } catch (erro) {
            console.error('[removerItemDaArvore] Erro:', erro);
            return false;
        }
    }

    // ‚úÖ Busca item por texto (usado quando n√£o temos ID direto do DOM)
    function buscarItemPorTexto(items, texto) {
        try {
            if (!items || !texto) return null;

            for (var i = 0; i < items.length; i++) {
                var itemText = items[i].text || items[i].nomeMenu || '';
                if (itemText.trim() === texto.trim()) {
                    return items[i];
                }
                if (items[i].items && items[i].items.length > 0) {
                    var found = buscarItemPorTexto(items[i].items, texto);
                    if (found) return found;
                }
            }
            return null;
        } catch (erro) {
            console.error('[buscarItemPorTexto] Erro:', erro);
            return null;
        }
    }

    // Carrega √≠cones FontAwesome do endpoint
    function carregarIconesFontAwesome() {
        try {
            fetch('/api/Navigation/GetIconesFontAwesomeHierarquico')
                .then(r => r.json())
                .then(result => {
                    console.log('√çcones FontAwesome carregados:', result);
                    if (result.success && result.data) {
                        var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                        if (ddlIconeObj) {
                            // Configura os fields do DropDownTree
                            ddlIconeObj.fields = {
                                dataSource: result.data,
                                value: 'id',
                                text: 'text',
                                parentValue: 'parentId',
                                hasChildren: 'hasChild',
                                child: 'child'
                            };
                            ddlIconeObj.dataBind();
                            console.log('DropDownTree de √≠cones populado com', result.data.length, 'categorias');
                        }
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarIconesFontAwesome", erro);
                });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarIconesFontAwesome", erro);
        }
    }

    // ‚úÖ EVENTO SELECT: Dispara AO CLICAR no √≠cone (n√£o precisa clicar fora)
    function onIconeSelect(args) {
        try {
            console.log('=== onIconeSelect disparado (AO CLICAR) ===');
            console.log('args.nodeData:', args.nodeData);

            if (!args.nodeData || args.nodeData.isCategory) {
                console.log('Categoria clicada - n√£o atualiza campo');
                return;
            }

            // No evento SELECT, os dados v√™m em args.nodeData
            var iconClass = args.nodeData.id;      // "fa-duotone fa-bat"
            var iconLabel = args.nodeData.text;    // "Bast√£o"

            var txtIconClass = document.getElementById('txtIconClass');
            if (txtIconClass) {
                txtIconClass.value = iconClass;
                console.log('‚úÖ Classe CSS atualizada IMEDIATAMENTE:', iconClass, '| Label:', iconLabel);
            } else {
                console.error('‚ùå Elemento txtIconClass n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onIconeSelect", erro);
        }
    }

    // ‚úÖ EVENTO CHANGE: Backup para quando setado programaticamente
    function onIconeChange(args) {
        try {
            console.log('=== onIconeChange disparado ===');
            console.log('args completo:', args);
            console.log('args.itemData:', args.itemData);
            console.log('args.value:', args.value);

            // Quando setado programaticamente, itemData vem undefined
            // Preciso buscar o item no dataSource
            var itemData = args.itemData;

            if (!itemData && args.value && args.value.length > 0) {
                console.log('itemData undefined - buscando no dataSource...');
                var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                if (ddlIconeObj && ddlIconeObj.fields && ddlIconeObj.fields.dataSource) {
                    var iconId = args.value[0];
                    console.log('Buscando iconId:', iconId);

                    itemData = findIconById(iconId);
                    if (itemData) {
                        console.log('‚úÖ √çcone encontrado no dataSource:', itemData);
                    }

                    // Se n√£o encontrou, pode ser que seja a pr√≥pria classe
                    if (!itemData) {
                        console.log('‚ùå √çcone n√£o encontrado no dataSource - usando iconId diretamente');
                        itemData = { id: iconId, text: iconId, isCategory: false };
                    }
                }
            }

            // Se n√£o h√° dados ou √© uma categoria, limpa o campo
            if (!itemData || itemData.isCategory) {
                document.getElementById('txtIconClass').value = '';
                console.log('Categoria selecionada ou campo limpo');
                return;
            }

            // Apenas √≠cones v√°lidos (n√£o categorias)
            var iconClass = itemData.id;      // "fa-duotone fa-bat"
            var iconLabel = itemData.text;    // "Bast√£o"

            // Atualiza campo de texto bloqueado com a classe CSS
            var txtIconClass = document.getElementById('txtIconClass');
            if (txtIconClass) {
                txtIconClass.value = iconClass;
                console.log('‚úÖ Classe CSS atualizada:', iconClass, '| Label:', iconLabel);
            } else {
                console.error('‚ùå Elemento txtIconClass n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onIconeChange", erro);
        }
    }

    // Carrega p√°ginas do sistema
    function carregarPaginasSistema() {
        try {
            fetch('/api/Navigation/GetPaginasHierarquico')
                .then(r => r.json())
                .then(result => {
                    console.log('P√°ginas carregadas:', result);
                    if (result.success && result.data) {
                        var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                        if (ddlPaginaObj) {
                            ddlPaginaObj.fields = {
                                dataSource: result.data,
                                value: 'id',
                                text: 'text',
                                parentValue: 'parentId',
                                hasChildren: 'hasChild',
                                child: 'child'
                            };
                            ddlPaginaObj.dataBind();
                            console.log('DropDownTree de p√°ginas populado com', result.data.length, 'm√≥dulos');
                        }
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarPaginasSistema", erro);
                });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarPaginasSistema", erro);
        }
    }

    function onPaginaDropdownCreated() {
        try {
            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
            if (ddlPaginaObj) {
                ddlPaginaObj.itemTemplate = function(data) {
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="fa-duotone fa-file-lines" style="font-size: 16px; width: 20px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                ddlPaginaObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    var displayText = data.displayText || data.text;
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="fa-duotone fa-file-lines" style="font-size: 14px; width: 18px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span>' + displayText + '</span>' +
                           '</div>';
                };

                // ‚úÖ Evento SELECTING: dispara ANTES de confirmar sele√ß√£o (mais confi√°vel)
                ddlPaginaObj.selecting = function(args) {
                    console.log('=== SELECTING p√°gina (ANTES) ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a sele√ß√£o na vari√°vel global IMEDIATAMENTE
                        ultimaPaginaSelecionada = {
                            id: args.nodeData.id,
                            paginaRef: args.nodeData.paginaRef
                        };

                        var txtHref = document.getElementById('txtHref');
                        if (txtHref && args.nodeData.paginaRef) {
                            txtHref.value = args.nodeData.paginaRef;
                            console.log('‚úÖ URL atualizada via SELECTING:', args.nodeData.paginaRef);
                        }
                    }
                };

                // ‚úÖ Evento SELECT: dispara ao selecionar item
                ddlPaginaObj.select = function(args) {
                    console.log('=== SELECT p√°gina ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a sele√ß√£o na vari√°vel global
                        ultimaPaginaSelecionada = {
                            id: args.nodeData.id,
                            paginaRef: args.nodeData.paginaRef
                        };

                        var txtHref = document.getElementById('txtHref');
                        if (txtHref && args.nodeData.paginaRef) {
                            txtHref.value = args.nodeData.paginaRef;
                            console.log('‚úÖ URL atualizada via SELECT:', args.nodeData.paginaRef);
                        }

                        // for√ßa valor e dispara change manual para refletir na primeira escolha
                        ddlPaginaObj.value = [args.nodeData.id];
                        onPaginaChange({ itemData: args.nodeData, value: [args.nodeData.id] });
                        ddlPaginaObj.hidePopup();
                    }
                };

                // ‚úÖ Evento CHANGE: backup
                ddlPaginaObj.change = function(args) {
                    onPaginaChange(args);
                };

                // N√£o depende de blur para aplicar mudan√ßa
                ddlPaginaObj.changeOnBlur = false;

                // ‚úÖ Evento CLOSE do popup: garante atualiza√ß√£o ao fechar
                ddlPaginaObj.close = function(args) {
                    console.log('=== CLOSE p√°gina ===');

                    var paginaRef = null;
                    var pageId = null;

                    // Tenta pegar o valor atual do componente
                    var valor = ddlPaginaObj.value;
                    if (valor && valor.length > 0) {
                        pageId = valor[0];
                        console.log('Valor do componente:', pageId);

                        // Busca a paginaRef no dataSource
                        if (ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                            var dataSource = ddlPaginaObj.fields.dataSource;
                            for (var i = 0; i < dataSource.length; i++) {
                                var modulo = dataSource[i];
                                if (modulo.child && modulo.child.length > 0) {
                                    for (var j = 0; j < modulo.child.length; j++) {
                                        var page = modulo.child[j];
                                        if (page.id === pageId && page.paginaRef) {
                                            paginaRef = page.paginaRef;
                                            break;
                                        }
                                    }
                                }
                                if (paginaRef) break;
                            }
                        }
                    }

                    // Se n√£o encontrou, usa a √∫ltima sele√ß√£o armazenada
                    if (!paginaRef && ultimaPaginaSelecionada) {
                        paginaRef = ultimaPaginaSelecionada.paginaRef;
                        console.log('Usando √∫ltima p√°gina selecionada:', paginaRef);
                    }

                    // Atualiza o campo se tiver uma URL v√°lida
                    if (paginaRef) {
                        var txtHref = document.getElementById('txtHref');
                        if (txtHref) {
                            txtHref.value = paginaRef;
                            console.log('‚úÖ URL atualizada via CLOSE:', paginaRef);
                        }
                    }
                };

                console.log('DropDownTree de p√°ginas configurado');
            }
        } catch (error) {
            console.error('Erro ao configurar DropDownTree de p√°ginas:', error);
        }
    }

    // ‚úÖ EVENTO SELECT: Dispara AO CLICAR no item (n√£o precisa clicar fora)
    function onPaginaSelect(args) {
        try {
            console.log('=== onPaginaSelect disparado (AO CLICAR) ===');
            console.log('args.nodeData:', args.nodeData);

            if (!args.nodeData || args.nodeData.isCategory) {
                console.log('Categoria clicada - n√£o gera URL');
                return;
            }

            // No evento SELECT, os dados v√™m em args.nodeData
            var paginaRef = args.nodeData.paginaRef;
            console.log('paginaRef extra√≠da:', paginaRef);

            var txtHref = document.getElementById('txtHref');
            if (txtHref) {
                txtHref.value = paginaRef;
                console.log('‚úÖ URL atualizada IMEDIATAMENTE:', paginaRef);
            } else {
                console.error('‚ùå Elemento txtHref n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPaginaSelect", erro);
        }
    }

    // ‚úÖ EVENTO CHANGE: Backup para quando setado programaticamente
    function onPaginaChange(args) {
        try {
            console.log('=== onPaginaChange disparado ===');
            console.log('args completo:', args);
            console.log('args.itemData:', args.itemData);
            console.log('args.value:', args.value);

            // Quando setado programaticamente, itemData vem undefined
            // Preciso buscar o item no dataSource
            var itemData = args.itemData;

            if (!itemData && args.value && args.value.length > 0) {
                console.log('itemData undefined - buscando no dataSource...');
                var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                if (ddlPaginaObj && ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                    var pageId = args.value[0];
                    console.log('Buscando pageId:', pageId);

                    // Busca em todas as categorias
                    var dataSource = ddlPaginaObj.fields.dataSource;
                    for (var i = 0; i < dataSource.length; i++) {
                        var category = dataSource[i];
                        if (category.child && category.child.length > 0) {
                            for (var j = 0; j < category.child.length; j++) {
                                if (category.child[j].id === pageId) {
                                    itemData = category.child[j];
                                    console.log('‚úÖ Item encontrado no dataSource:', itemData);
                                    break;
                                }
                            }
                        }
                        if (itemData) break;
                    }
                }
            }

            // Se n√£o h√° dados ou √© uma categoria, n√£o faz nada
            if (!itemData || itemData.isCategory) {
                console.log('Categoria selecionada ou campo limpo - n√£o gera URL');
                return;
            }

            // Obt√©m a URL gerada (formato: modulo_pagina.html)
            var paginaRef = itemData.paginaRef;
            console.log('paginaRef extra√≠da:', paginaRef);

            var txtHref = document.getElementById('txtHref');
            if (txtHref) {
                txtHref.value = paginaRef;
                console.log('‚úÖ URL atualizada no campo txtHref:', paginaRef);
            } else {
                console.error('‚ùå Elemento txtHref n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPaginaChange", erro);
        }
    }

    // Carrega lista de usuarios com acesso
    function carregarControleAcesso(recursoId) {
        try {
            if (!recursoId) {
                document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
                return;
            }

            fetch('/api/Navigation/GetUsuariosAcesso?recursoId=' + recursoId)
                .then(r => r.json())
                .then(result => {
                    console.log('Acessos carregados:', result);
                    var container = document.getElementById('listaAcessos');
                    if (result.success && result.data && result.data.length > 0) {
                        container.innerHTML = result.data.map(u =>
                            '<div class="acesso-item">' +
                            '<input type="checkbox" class="form-check-input me-2" ' +
                            'id="acesso_' + u.usuarioId + '" ' +
                            (u.acesso ? 'checked' : '') +
                            ' onchange="atualizarAcesso(\'' + u.usuarioId + '\', this.checked)" />' +
                            '<label for="acesso_' + u.usuarioId + '">' + u.nome + '</label>' +
                            '</div>'
                        ).join('');
                    } else {
                        container.innerHTML = '<p class="text-muted text-center">Nenhum usu√°rio encontrado</p>';
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarControleAcesso", erro);
                });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarControleAcesso", erro);
        }
    }

    // Atualiza acesso de usuario
    function atualizarAcesso(usuarioId, acesso) {
        try {
            if (!selectedItem) return;

            fetch('/api/Navigation/UpdateAcesso', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usuarioId: usuarioId,
                    recursoId: selectedItem.id,
                    acesso: acesso
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    mostrarAlerta('Acesso atualizado!', 'success');
                } else {
                    mostrarAlerta('Erro ao atualizar acesso: ' + result.message, 'danger');
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarAcesso", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarAcesso", erro);
        }
    }

    // Salva propriedades do item
    function salvarPropriedades() {
        return new Promise(function(resolve, reject) {
            try {
                // ‚úÖ Obt√©m o tipo de item do toggle
                var tipoItem = document.getElementById('tipoItem').value;
                var ehGrupo = (tipoItem === 'grupo');
                
                // ‚úÖ CODIFICA valores antes de enviar ao backend
                var txtHref = document.getElementById('txtHref').value;
                var parentIdValue = document.getElementById('parentId').value;
                
                // ‚úÖ Define href baseado no tipo
                var hrefFinal;
                if (ehGrupo) {
                    // Grupo n√£o tem URL de p√°gina
                    hrefFinal = 'javascript:void(0);';
                } else {
                    // P√°gina deve ter URL
                    hrefFinal = txtHref || null;
                    
                    if (!hrefFinal) {
                        Alerta.Warning('Aten√ß√£o', 'Para itens do tipo P√°gina, selecione uma p√°gina do sistema!');
                        reject(new Error('URL n√£o informada'));
                        return;
                    }
                }
            
            // ‚úÖ Obt√©m posi√ß√£o selecionada no dropdown
            var posicaoSelecionada = null;
            var ddlPosicaoObj = document.getElementById('ddlPosicao');
            if (ddlPosicaoObj && ddlPosicaoObj.ej2_instances && ddlPosicaoObj.ej2_instances[0]) {
                var ddlPosicao = ddlPosicaoObj.ej2_instances[0];
                posicaoSelecionada = ddlPosicao.value && ddlPosicao.value.length > 0 ? ddlPosicao.value[0] : null;
            }
            console.log('[SALVAR] Posi√ß√£o selecionada:', posicaoSelecionada);
            
            // ‚úÖ Calcula parentId baseado na posi√ß√£o (para novos itens ou quando alterado)
            var parentIdFinal = parentIdValue || null;
            var ehNovoItem = !document.getElementById('recursoId').value;
            
            if (ehNovoItem && posicaoSelecionada && posicaoSelecionada !== '_INICIO_') {
                // Se posicionou abaixo de um item, herda o parentId desse item
                var itemReferencia = buscarItemPorId(treeData, posicaoSelecionada);
                if (itemReferencia) {
                    parentIdFinal = itemReferencia.parentId || null;
                }
            }
            
            var dto = {
                id: document.getElementById('recursoId').value,
                text: encodeHtml(document.getElementById('txtNome').value),
                nomeMenu: encodeHtml(document.getElementById('txtNomeMenu').value),
                href: hrefFinal,
                icon: document.getElementById('txtIconClass').value,
                ordem: 0,  // ‚úÖ Backend calcula automaticamente
                descricao: encodeHtml(document.getElementById('txtDescricao').value),
                ativo: document.getElementById('chkAtivo').checked,
                parentId: parentIdFinal,
                posicaoAbaixoDe: posicaoSelecionada  // ‚úÖ Envia para backend posicionar corretamente
            };

                console.log('DTO codificado para envio:', dto);

                if (!dto.text || !dto.nomeMenu) {
                    Alerta.Warning('Aten√ß√£o', 'Preencha Nome e NomeMenu!');
                    reject(new Error('Campos obrigat√≥rios n√£o preenchidos'));
                    return;
                }

                var ehNovoItem = !dto.id;  // Se n√£o tem ID, √© novo item

                fetch('/api/Navigation/SaveRecurso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');

                        // ‚úÖ Atualiza √°rvore ap√≥s pequeno delay para garantir que backend processou
                        setTimeout(function() {
                            carregarArvore();
                        }, 300);

                        // ‚úÖ Atualiza navega√ß√£o lateral ap√≥s salvar
                        atualizarNavegacaoLateral();

                        var recursoId = result.id || dto.id;

                        // ‚úÖ APENAS para NOVO ITEM: habilita acesso e pergunta sobre gerenciamento
                        if (ehNovoItem && recursoId) {
                            // Habilita acesso para todos usu√°rios automaticamente
                            habilitarAcessoTodosUsuarios(recursoId);

                            // Pergunta se deseja fazer controle de acesso
                            Alerta.Confirmar(
                                'Gerenciar Controle de Acesso',
                                'Deseja gerenciar o controle de acesso deste item agora?',
                                'Sim',
                                'N√£o'
                            ).then(function(result) {
                                if (result) {
                                    // Atualiza selectedItem com o ID retornado
                                    selectedItem = {
                                        id: recursoId,
                                        text: dto.text,
                                        nomeMenu: dto.nomeMenu,
                                        href: dto.href,
                                        icon: dto.icon,
                                        ordem: dto.ordem,
                                        descricao: dto.descricao,
                                        ativo: dto.ativo,
                                        parentId: dto.parentId
                                    };
                                    document.getElementById('recursoId').value = recursoId;

                                    // Desabilita Card de Propriedades
                                    habilitarCardPropriedades(false);

                                    // Carrega controle de acesso
                                    carregarControleAcesso(recursoId);

                                    // Mostra Card de Controle de Acesso
                                    document.getElementById('acessoCard').style.display = 'block';
                                } else {
                                    // N√£o quer gerenciar acesso, fecha os cards
                                    document.getElementById('propsCard').style.display = 'none';
                                    document.getElementById('acessoCard').style.display = 'none';
                                    habilitarCardPropriedades(true);
                                }
                            });
                        } else {
                            // ‚úÖ EDI√á√ÉO de item existente: apenas fecha card de propriedades
                            document.getElementById('propsCard').style.display = 'none';
                            habilitarCardPropriedades(true);
                        }
                        
                        // Resolve a Promise ap√≥s sucesso
                        resolve(result);
                    } else {
                        mostrarAlerta('Erro: ' + result.message, 'danger');
                        reject(new Error(result.message));
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarPropriedades", erro);
                    reject(erro);
                });
            } catch (erro) {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarPropriedades", erro);
                reject(erro);
            }
        });
    }

    // Adiciona novo item
    function adicionarNovoItem() {
        try {
            // Limpa formulario mas mant√©m card vis√≠vel
            limparFormulario(false);  // false = N√ÉO esconde o card

            // ‚úÖ Habilita Card de Propriedades
            habilitarCardPropriedades(true);

            // Mostra card de propriedades
            document.getElementById('propsCard').style.display = 'block';

            // ‚úÖ Garante que Card de Controle de Acesso est√° escondido ao criar novo item
            document.getElementById('acessoCard').style.display = 'none';

            document.getElementById('txtNome').focus();
            document.getElementById('selectedItemName').textContent = 'Novo Item';

            // Atualiza indicador de modo para "Criar"
            document.getElementById('modoEdicao').textContent = 'Criar';
            document.getElementById('modoEdicao').className = 'badge bg-success ms-2';
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "adicionarNovoItem", erro);
        }
    }

    // Exclui item selecionado
    function excluirItem() {
        try {
            if (!selectedItem || !selectedItem.id) {
                mostrarAlerta('Selecione um item para excluir!', 'warning');
                return;
            }

            Alerta.Confirmar(
                'Confirmar Exclus√£o',
                'Tem certeza que deseja excluir "' + decodeHtml(selectedItem.text) + '"?',
                'Excluir',
                'Cancelar'
            ).then(function(result) {
                if (!result) return;

                fetch('/api/Navigation/DeleteRecurso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recursoId: selectedItem.id })
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');
                        limparFormulario();
                        carregarArvore();
                    } else {
                        mostrarAlerta('Erro: ' + result.message, 'danger');
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "excluirItem", erro);
                });
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "excluirItem", erro);
        }
    }

    // Limpa formulario
    // ‚úÖ Valida se campos obrigat√≥rios est√£o preenchidos
    function validarCamposObrigatorios() {
        var nome = document.getElementById('txtNome').value.trim();
        var nomeMenu = document.getElementById('txtNomeMenu').value.trim();
        var pagina = document.getElementById('ddlPagina')?.ej2_instances?.[0]?.value;
        var icone = document.getElementById('ddlIcone')?.ej2_instances?.[0]?.value;
        
        return nome && nomeMenu && pagina && pagina.length > 0 && icone && icone.length > 0;
    }

    // ‚úÖ REMOVIDO: Bot√µes de ordena√ß√£o agora est√£o inline na TreeView
    // Fun√ß√£o mantida vazia para compatibilidade
    function atualizarEstadoBotoesOrdenacao() {
        // Bot√µes de navega√ß√£o agora est√£o inline na TreeView
        // N√£o h√° mais bot√µes externos para atualizar
    }

    // ‚úÖ Verifica se pode mover para cima
    function podeMoverParaCima() {
        if (!selectedItem || !selectedItem.id || !treeData) return false;
        
        var item = buscarItemPorId(treeData, selectedItem.id);
        if (!item) return false;
        
        // Encontra a lista que cont√©m o item e seu √≠ndice
        var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
        if (!resultado) return false;
        
        return resultado.indice > 0; // Pode mover se n√£o √© o primeiro
    }

    // ‚úÖ Verifica se pode mover para baixo
    function podeMoverParaBaixo() {
        if (!selectedItem || !selectedItem.id || !treeData) return false;
        
        var item = buscarItemPorId(treeData, selectedItem.id);
        if (!item) return false;
        
        // Encontra a lista que cont√©m o item e seu √≠ndice
        var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
        if (!resultado) return false;
        
        return resultado.indice < resultado.lista.length - 1; // Pode mover se n√£o √© o √∫ltimo
    }

    // ‚úÖ Busca a lista pai que cont√©m um item e retorna refer√™ncia √† lista e √≠ndice
    function encontrarListaPaiEIndice(lista, targetId, targetParentId) {
        for (var i = 0; i < lista.length; i++) {
            var currentItem = lista[i];
            var currentParentId = currentItem.parentId || null;
            
            // Verifica se este item √© o alvo
            if (String(currentItem.id) === String(targetId)) {
                return { lista: lista, indice: i };
            }
            
            // Busca recursivamente nos filhos
            if (currentItem.items && currentItem.items.length > 0) {
                var resultado = encontrarListaPaiEIndice(currentItem.items, targetId, targetParentId);
                if (resultado) return resultado;
            }
        }
        return null;
    }

    // =====================================================
    // ‚úÖ NOVAS FUN√á√ïES DE NAVEGA√á√ÉO (chamadas pelos bot√µes inline)
    // =====================================================

    // ‚úÖ Move item para CIMA (ordena√ß√£o vertical)
    function moverItemCima(itemId, event) {
        console.log('[MOVER-CIMA] === FUN√á√ÉO CHAMADA ===');
        console.log('[MOVER-CIMA] itemId recebido:', itemId, 'tipo:', typeof itemId);
        
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        
        try {
            console.log('[MOVER-CIMA] treeData:', treeData);
            var item = buscarItemPorId(treeData, itemId);
            console.log('[MOVER-CIMA] Item encontrado:', item);
            if (!item) {
                console.error('[MOVER-CIMA] Item n√£o encontrado:', itemId);
                return;
            }

            // Encontra a lista que cont√©m o item e seu √≠ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice <= 0) {
                console.log('[MOVER-CIMA] Item j√° est√° na primeira posi√ß√£o');
                return;
            }

            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;

            // Troca posi√ß√£o com o item anterior
            var temp = listaIrmaos[indexAtual];
            listaIrmaos[indexAtual] = listaIrmaos[indexAtual - 1];
            listaIrmaos[indexAtual - 1] = temp;

            console.log('[MOVER-CIMA] ‚úÖ Item movido para cima:', item.text);
            
            // For√ßa reconstru√ß√£o e atualiza TreeView
            atualizarTreeViewAposMovimento(itemId);
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemCima", erro);
        }
    }

    // ‚úÖ Move item para BAIXO (ordena√ß√£o vertical)
    function moverItemBaixo(itemId, event) {
        console.log('[MOVER-BAIXO] === FUN√á√ÉO CHAMADA ===');
        console.log('[MOVER-BAIXO] itemId recebido:', itemId, 'tipo:', typeof itemId);
        
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        
        try {
            var item = buscarItemPorId(treeData, itemId);
            console.log('[MOVER-BAIXO] Item encontrado:', item);
            if (!item) {
                console.error('[MOVER-BAIXO] Item n√£o encontrado:', itemId);
                return;
            }

            // Encontra a lista que cont√©m o item e seu √≠ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice >= resultado.lista.length - 1) {
                console.log('[MOVER-BAIXO] Item j√° est√° na √∫ltima posi√ß√£o');
                return;
            }

            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;

            // Troca posi√ß√£o com o item seguinte
            var temp = listaIrmaos[indexAtual];
            listaIrmaos[indexAtual] = listaIrmaos[indexAtual + 1];
            listaIrmaos[indexAtual + 1] = temp;

            console.log('[MOVER-BAIXO] ‚úÖ Item movido para baixo:', item.text);
            
            // For√ßa reconstru√ß√£o e atualiza TreeView
            atualizarTreeViewAposMovimento(itemId);
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemBaixo", erro);
        }
    }

    // ‚úÖ Move item para ESQUERDA (sobe n√≠vel - vira irm√£o do pai)
    function moverItemEsquerda(itemId, event) {
        console.log('[MOVER-ESQ] === FUN√á√ÉO CHAMADA ===');
        console.log('[MOVER-ESQ] itemId recebido:', itemId, 'tipo:', typeof itemId);
        
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        
        try {
            var item = buscarItemPorId(treeData, itemId);
            console.log('[MOVER-ESQ] Item encontrado:', item);
            if (!item) {
                console.error('[MOVER-ESQ] Item n√£o encontrado:', itemId);
                return;
            }

            // Se j√° est√° na raiz, n√£o pode subir mais
            if (!item.parentId) {
                console.log('[MOVER-ESQ] Item j√° est√° na raiz');
                return;
            }

            // Encontra o pai atual
            var paiAtual = buscarItemPorId(treeData, item.parentId);
            if (!paiAtual) {
                console.error('[MOVER-ESQ] Pai n√£o encontrado:', item.parentId);
                return;
            }

            console.log('[MOVER-ESQ] Movendo item para n√≠vel do pai:', paiAtual.text);

            // Remove item da lista de filhos do pai atual
            if (paiAtual.items) {
                var indexNoFilho = paiAtual.items.findIndex(function(i) { return i.id === item.id; });
                if (indexNoFilho !== -1) {
                    paiAtual.items.splice(indexNoFilho, 1);
                }
            }

            // Item agora tem o parentId do av√¥ (ou null se pai era raiz)
            var novoParentId = paiAtual.parentId || null;
            item.parentId = novoParentId;

            // Se novo pai √© null (raiz), adiciona ao treeData
            if (!novoParentId) {
                // Encontra posi√ß√£o do pai antigo e insere depois dele
                var indexPai = treeData.findIndex(function(i) { return i.id === paiAtual.id; });
                if (indexPai !== -1) {
                    treeData.splice(indexPai + 1, 0, item);
                } else {
                    treeData.push(item);
                }
            } else {
                // Adiciona na lista de filhos do av√¥
                var avo = buscarItemPorId(treeData, novoParentId);
                if (avo) {
                    if (!avo.items) avo.items = [];
                    // Insere depois do pai antigo
                    var indexPaiNoAvo = avo.items.findIndex(function(i) { return i.id === paiAtual.id; });
                    if (indexPaiNoAvo !== -1) {
                        avo.items.splice(indexPaiNoAvo + 1, 0, item);
                    } else {
                        avo.items.push(item);
                    }
                }
            }

            // Se pai ficou sem filhos, transforma em p√°gina
            if (paiAtual.items && paiAtual.items.length === 0) {
                console.log('[MOVER-ESQ] Pai ficou sem filhos, transformando em p√°gina');
                paiAtual.items = [];
                // Marca para usu√°rio escolher href depois
            }

            console.log('[MOVER-ESQ] ‚úÖ Item movido para esquerda (subiu n√≠vel)');
            
            // For√ßa reconstru√ß√£o e atualiza TreeView
            atualizarTreeViewAposMovimento(itemId);
            
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemEsquerda", erro);
        }
    }

    // ‚úÖ Move item para DIREITA (desce n√≠vel - vira filho do item acima)
    // Se o item acima for uma P√°gina, exibe aviso de que ser√° transformado em Grupo e perder√° o link HTML
    function moverItemDireita(itemId, event) {
        console.log('[MOVER-DIR] === FUN√á√ÉO CHAMADA ===');
        console.log('[MOVER-DIR] itemId recebido:', itemId, 'tipo:', typeof itemId);

        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        try {
            var item = buscarItemPorId(treeData, itemId);
            console.log('[MOVER-DIR] Item encontrado:', item);
            if (!item) {
                console.error('[MOVER-DIR] Item n√£o encontrado:', itemId);
                return;
            }

            // Encontra a lista que cont√©m o item
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice <= 0) {
                console.log('[MOVER-DIR] N√£o h√° item acima para virar pai');
                return;
            }

            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;
            var itemAcima = listaIrmaos[indexAtual - 1];

            console.log('[MOVER-DIR] Item acima que virar√° pai:', itemAcima.text);

            // ‚úÖ VERIFICA√á√ÉO: Se o item acima √© uma P√°gina (tem href v√°lido), avisar que ser√° transformado em Grupo
            var itemAcimaEhPagina = itemAcima.href && itemAcima.href !== 'javascript:void(0);' && itemAcima.href.trim() !== '';

            if (itemAcimaEhPagina) {
                // Exibir aviso de que a p√°gina acima ser√° transformada em Grupo
                console.log('[MOVER-DIR] Item acima √© uma P√°gina - exibindo aviso de transforma√ß√£o');

                Alerta.Confirmar(
                    'Transforma√ß√£o em Grupo',
                    '<div style="text-align: left; padding: 10px;">' +
                        '<p style="margin-bottom: 15px;">Ao subordinar <strong>"' + item.text + '"</strong> como filho de <strong>"' + itemAcima.text + '"</strong>, ' +
                        'a p√°gina <strong>"' + itemAcima.text + '"</strong> ser√° <span style="color: #d9534f; font-weight: bold;">transformada em GRUPO</span>.</p>' +
                        '<div style="background: linear-gradient(135deg, #ff6b35, #e55a2b); color: white; padding: 12px 15px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.5); margin: 10px 0;">' +
                            '<i class="fa-duotone fa-triangle-exclamation" style="--fa-primary-color:#ffffff; --fa-secondary-color:#ffcc00; margin-right: 8px;"></i>' +
                            '<strong>ATEN√á√ÉO:</strong> O link HTML da p√°gina ser√° removido permanentemente e ela n√£o acessar√° mais nenhuma funcionalidade diretamente!' +
                        '</div>' +
                        '<p style="margin-top: 15px;">Deseja prosseguir com esta opera√ß√£o?</p>' +
                    '</div>',
                    '<i class="fa-duotone fa-check" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right: 6px;"></i>Sim, Transformar em Grupo',
                    '<i class="fa-duotone fa-xmark" style="--fa-primary-color:#ff6b35; --fa-secondary-color:#6c757d; margin-right: 6px;"></i>Cancelar'
                ).then(function(confirmado) {
                    if (confirmado) {
                        console.log('[MOVER-DIR] Usu√°rio confirmou transforma√ß√£o - executando movimenta√ß√£o');
                        executarMovimentacaoDireita(item, listaIrmaos, indexAtual, itemAcima, itemId);
                    } else {
                        console.log('[MOVER-DIR] Usu√°rio cancelou - opera√ß√£o revertida');
                        Alerta.Info('Opera√ß√£o Cancelada', 'A movimenta√ß√£o foi cancelada. Nenhuma altera√ß√£o foi feita.', 'OK');
                    }
                });
            } else {
                // Item acima j√° √© grupo, executa diretamente sem aviso
                console.log('[MOVER-DIR] Item acima j√° √© Grupo - executando movimenta√ß√£o direta');
                executarMovimentacaoDireita(item, listaIrmaos, indexAtual, itemAcima, itemId);
            }

        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemDireita", erro);
        }
    }

    // ‚úÖ Fun√ß√£o auxiliar para executar a movimenta√ß√£o para direita (ap√≥s confirma√ß√£o, se necess√°rio)
    // Param: item - O item sendo movido
    // Param: listaIrmaos - Lista de irm√£os onde o item est√° atualmente
    // Param: indexAtual - √çndice atual do item na lista
    // Param: itemAcima - O item que ser√° o novo pai
    // Param: itemId - ID do item para manter selecionado ap√≥s atualiza√ß√£o
    function executarMovimentacaoDireita(item, listaIrmaos, indexAtual, itemAcima, itemId) {
        try {
            // Remove item da lista atual
            listaIrmaos.splice(indexAtual, 1);

            // Define novo parentId
            item.parentId = itemAcima.id;

            // Adiciona item como filho do item acima
            if (!itemAcima.items) {
                itemAcima.items = [];
            }
            itemAcima.items.push(item);

            // Item acima agora √© grupo (se n√£o tinha href, continua sem)
            if (!itemAcima.href || itemAcima.href === 'javascript:void(0);') {
                // J√° era grupo, mant√©m
            } else {
                // Era p√°gina, vira grupo - limpa href
                console.log('[MOVER-DIR] Item acima transformado em grupo');
                itemAcima.href = 'javascript:void(0);';
            }

            console.log('[MOVER-DIR] ‚úÖ Item movido para direita (desceu n√≠vel, virou filho de ' + itemAcima.text + ')');

            // For√ßa reconstru√ß√£o e atualiza TreeView
            atualizarTreeViewAposMovimento(itemId);

        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "executarMovimentacaoDireita", erro);
        }
    }

    // ‚úÖ Fun√ß√£o auxiliar para atualizar TreeView ap√≥s movimentos
    // Param: itemIdParaManter - ID do item a manter selecionado (ou null para limpar sele√ß√£o)
    // Param: marcarPendentes - Se true (padr√£o), marca altera√ß√µes pendentes. Se false, n√£o marca (usado quando j√° salvou direto no banco)
    function atualizarTreeViewAposMovimento(itemIdParaManter, marcarPendentes) {
        try {
            // Se marcarPendentes n√£o for informado, assume true (comportamento padr√£o)
            if (marcarPendentes === undefined) marcarPendentes = true;

            console.log('[ATUALIZAR] Atualizando TreeView ap√≥s movimento... marcarPendentes=' + marcarPendentes);

            // For√ßa reconstru√ß√£o completa
            treeData = JSON.parse(JSON.stringify(treeData));

            // Atualiza TreeView
            if (treeObj) {
                treeObj.fields.dataSource = treeData;
                treeObj.dataBind();
                treeObj.refresh();
                treeObj.expandAll();
            }

            // ‚úÖ Reconfigura event listeners (necess√°rio ap√≥s refresh)
            configurarBotoesNavegacao();

            // Repopula dropdowns
            popularDropdownItemPai();
            popularDropdownPosicao();

            // Mant√©m sele√ß√£o no item movido (se itemIdParaManter for informado)
            if (itemIdParaManter) {
                var itemAtualizado = buscarItemPorId(treeData, itemIdParaManter);
                if (itemAtualizado) {
                    selectedItem = itemAtualizado;
                    // N√ÉO chama selecionarItem aqui para evitar recarregar dados antigos
                    // selecionarItem ser√° chamado separadamente se necess√°rio
                }
            } else {
                // ‚úÖ Se itemIdParaManter for null/undefined/false, limpa a sele√ß√£o
                selectedItem = null;
                if (treeObj) {
                    treeObj.selectedNodes = [];
                }
            }

            // ‚úÖ Marca altera√ß√µes pendentes apenas se solicitado (movimentos de posi√ß√£o)
            // Transforma√ß√µes de tipo (Grupo ‚Üî P√°gina) passam marcarPendentes=false pois salvam imediatamente
            if (marcarPendentes) {
                marcarAlteracoesPendentes();
                console.log('[ATUALIZAR] ‚úÖ TreeView atualizado (altera√ß√µes pendentes)');
            } else {
                console.log('[ATUALIZAR] ‚úÖ TreeView atualizado (sem marcar pendentes - j√° salvo no banco)');
            }

        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarTreeViewAposMovimento", erro);
        }
    }

    // =====================================================
    // ‚úÖ FUN√á√ïES ANTIGAS (mantidas para compatibilidade)
    // =====================================================

    // ‚úÖ Move item para cima (move grupo inteiro se for grupo)
    function moverItemParaCima() {
        try {
            if (!selectedItem || !selectedItem.id) {
                mostrarAlerta('Selecione um item primeiro', 'warning');
                return;
            }
            
            var item = buscarItemPorId(treeData, selectedItem.id);
            if (!item) {
                mostrarAlerta('Item n√£o encontrado na √°rvore', 'danger');
                return;
            }
            
            // Encontra a lista que cont√©m o item e seu √≠ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice <= 0) {
                mostrarAlerta('Item j√° est√° na primeira posi√ß√£o', 'info');
                return;
            }
            
            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;
            
            // ‚úÖ Troca posi√ß√£o com o item anterior (modifica refer√™ncia original)
            var temp = listaIrmaos[indexAtual];
            listaIrmaos[indexAtual] = listaIrmaos[indexAtual - 1];
            listaIrmaos[indexAtual - 1] = temp;
            
            console.log('[MOVER-CIMA] ‚úÖ Posi√ß√µes trocadas na lista original');
            console.log('[MOVER-CIMA] Lista ap√≥s troca:', listaIrmaos.map(function(i) { return i.text; }));
            
            // ‚úÖ Recria treeData para for√ßar atualiza√ß√£o do TreeView
            var treeDataNovo = JSON.parse(JSON.stringify(treeData));
            treeData = treeDataNovo;
            
            // ‚úÖ Atualiza TreeView com nova estrutura
            treeObj.fields.dataSource = treeData;
            treeObj.dataBind();
            
            console.log('[MOVER-CIMA] ‚úÖ TreeView atualizado');
            
            // Seleciona o item novamente ap√≥s mover
            setTimeout(function() {
                var itemAtualizado = buscarItemPorId(treeData, item.id);
                if (itemAtualizado) {
                    selecionarItem(itemAtualizado);
                }
                salvarOrdenacaoAutomatica();
            }, 300);
            
        } catch (erro) {
            console.error('[moverItemParaCima] Erro:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemParaCima", erro);
        }
    }

    // ‚úÖ Move item para baixo (move grupo inteiro se for grupo)
    function moverItemParaBaixo() {
        try {
            if (!selectedItem || !selectedItem.id) {
                mostrarAlerta('Selecione um item primeiro', 'warning');
                return;
            }
            
            var item = buscarItemPorId(treeData, selectedItem.id);
            if (!item) {
                mostrarAlerta('Item n√£o encontrado na √°rvore', 'danger');
                return;
            }
            
            // Encontra a lista que cont√©m o item e seu √≠ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice >= resultado.lista.length - 1) {
                mostrarAlerta('Item j√° est√° na √∫ltima posi√ß√£o', 'info');
                return;
            }
            
            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;
            
            console.log('[MOVER-BAIXO] Lista encontrada:', listaIrmaos.length, 'itens');
            console.log('[MOVER-BAIXO] √çndice atual:', indexAtual);
            console.log('[MOVER-BAIXO] Item atual:', item.text);
            console.log('[MOVER-BAIXO] Item seguinte:', listaIrmaos[indexAtual + 1].text);
            
            // Troca posi√ß√£o com o item seguinte (move grupo inteiro se for grupo)
            var temp = listaIrmaos[indexAtual];
            listaIrmaos[indexAtual] = listaIrmaos[indexAtual + 1];
            listaIrmaos[indexAtual + 1] = temp;
            
            console.log('[MOVER-BAIXO] ‚úÖ Posi√ß√µes trocadas na lista');
            
            // ‚úÖ Recria treeData completamente para for√ßar atualiza√ß√£o do TreeView
            var treeDataNovo = JSON.parse(JSON.stringify(treeData));
            treeData = treeDataNovo;
            
            // Atualiza TreeView com nova estrutura
            treeObj.fields.dataSource = treeData;
            treeObj.dataBind();
            
            console.log('[MOVER-BAIXO] ‚úÖ TreeView atualizado');
            
            // Seleciona o item novamente ap√≥s mover
            setTimeout(function() {
                var itemAtualizado = buscarItemPorId(treeData, item.id);
                if (itemAtualizado) {
                    selecionarItem(itemAtualizado);
                }
                salvarOrdenacaoAutomatica();
            }, 300);
            
        } catch (erro) {
            console.error('[moverItemParaBaixo] Erro:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemParaBaixo", erro);
        }
    }

    function limparFormulario(esconderCard = true) {
        try {
            selectedItem = null;

            // ‚úÖ Reseta vari√°veis de rastreamento
            ultimoIconeSelecionado = null;
            ultimaPaginaSelecionada = null;

            document.getElementById('formPropriedades').reset();
            document.getElementById('recursoId').value = '';
            document.getElementById('parentId').value = '';
            document.getElementById('txtIconClass').value = '';
            document.getElementById('selectedItemName').textContent = 'Nenhum item selecionado';

            // Limpa DropDownTree de √≠cones
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj) {
                ddlIconeObj.value = [];
                ddlIconeObj.text = '';
                ddlIconeObj.refresh();
            }

            // Limpa DropDownTree de p√°ginas
            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
            if (ddlPaginaObj) {
                ddlPaginaObj.value = null;
            }

            // ‚úÖ Limpa campo oculto parentId (dropdown foi removido)
            document.getElementById('parentId').value = '';

            document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));

        // Reseta indicador de modo
        document.getElementById('modoEdicao').textContent = 'Selecione';
        document.getElementById('modoEdicao').className = 'badge bg-secondary ms-2';

        // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
        atualizarEstadoBotoesOrdenacao();
        
        // Esconde card apenas se solicitado
        if (esconderCard) {
            document.getElementById('propsCard').style.display = 'none';
        }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "limparFormulario", erro);
        }
    }

    /*
    // ‚ùå DEPRECATED: Salvamento agora √© autom√°tico - fun√ß√£o mantida apenas como backup
    function salvarOrdenacao() {
        try {
            if (!treeObj) return;
            var dataSource = treeObj.getTreeData();
            var items = extrairItensDoTreeView(dataSource, null, 0);
            fetch('/api/Navigation/SaveTreeToDb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(items)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    mostrarAlerta('Ordena√ß√£o salva com sucesso!', 'success');
                    carregarArvore();
                    atualizarNavegacaoLateral();
                } else {
                    mostrarAlerta('Erro: ' + result.message, 'danger');
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacao", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacao", erro);
        }
    }
    */

    // ‚úÖ AUTO-SAVE: Salva ordena√ß√£o automaticamente ap√≥s drag-drop ou transforma√ß√£o
    function salvarOrdenacaoAutomatica() {
        try {
            if (!treeObj && !treeData) {
                console.error('[AUTO-SAVE] Nem treeObj nem treeData existem!');
                return;
            }

            // ‚úÖ Usa treeData diretamente (mais confi√°vel ap√≥s modifica√ß√µes manuais)
            // O treeData √© a fonte de verdade ap√≥s transforma√ß√µes
            var dataSource = treeData || treeObj.getTreeData();
            console.log('[AUTO-SAVE] DataSource obtido (treeData):', dataSource);

            var items = extrairItensDoTreeView(dataSource, null, 0);
            console.log('[AUTO-SAVE] Items extra√≠dos para salvar:', items);
            console.log('[AUTO-SAVE] Total de items:', items.length);

            if (items.length === 0) {
                console.warn('[AUTO-SAVE] Nenhum item para salvar!');
                return;
            }

            console.log('[AUTO-SAVE] Enviando para backend...');

            var jsonPayload = JSON.stringify(items);
            console.log('[AUTO-SAVE] JSON Payload (primeiros 500 chars):', jsonPayload.substring(0, 500));

            fetch('/api/Navigation/SaveTreeToDb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: jsonPayload
            })
            .then(r => {
                console.log('[AUTO-SAVE] Response status:', r.status);
                // Se n√£o for 2xx, ainda precisamos ler o body para ver o erro
                return r.json().then(data => ({ ok: r.ok, status: r.status, data: data }));
            })
            .then(response => {
                console.log('[AUTO-SAVE] Response do backend:', response.data);

                if (!response.ok) {
                    // Erro HTTP - mostra detalhes do erro de valida√ß√£o
                    console.error('[AUTO-SAVE] ‚ùå HTTP Error:', response.status);

                    if (response.data.errors) {
                        console.error('[AUTO-SAVE] ‚ùå Erros de Valida√ß√£o:', JSON.stringify(response.data.errors, null, 2));
                        var erroMsg = 'Erro de valida√ß√£o: ';
                        for (var campo in response.data.errors) {
                            erroMsg += campo + ': ' + response.data.errors[campo].join(', ') + '; ';
                        }
                        mostrarAlerta(erroMsg, 'danger');
                    } else {
                        mostrarAlerta('Erro HTTP ' + response.status + ': ' + (response.data.message || response.data.title || 'Erro desconhecido'), 'danger');
                    }
                    return;
                }

                if (response.data.success) {
                    console.log('[AUTO-SAVE] ‚úÖ Ordena√ß√£o salva automaticamente!');
                    // Toast discreto ao inv√©s de alerta grande
                    var msg = 'Ordena√ß√£o salva automaticamente';
                    if (lastDragInfo && lastDragInfo.itemName) {
                        msg = "Item '" + lastDragInfo.itemName + "' movido de '" +
                            (lastDragInfo.fromParentName || 'Sem grupo') + "' para '" +
                            (lastDragInfo.toParentName || 'Sem grupo') + "'";
                    }
                    mostrarToastSucesso(msg);

                    // ‚úÖ Recarrega √°rvore com dados atualizados do banco
                    carregarArvore();

                    // ‚úÖ Atualiza menu lateral
                    atualizarNavegacaoLateral();
                } else {
                    console.error('[AUTO-SAVE] ‚ùå Erro no backend:', response.data.message);
                    mostrarAlerta('Erro ao salvar ordena√ß√£o: ' + response.data.message, 'danger');
                }
            })
            .catch(erro => {
                console.error('[AUTO-SAVE] ‚ùå Erro no fetch:', erro);
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacaoAutomatica", erro);
            });
        } catch (erro) {
            console.error('[AUTO-SAVE] ‚ùå Erro no try-catch:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacaoAutomatica", erro);
        }
    }

    // ‚úÖ AUTO-SAVE SEM RELOAD: Vers√£o que retorna Promise e n√£o faz reload
    // Usada para transforma√ß√µes de tipo (Grupo ‚Üî P√°gina) onde o reload √© controlado externamente
    function salvarOrdenacaoAutomaticaSemReload() {
        return new Promise(function(resolve, reject) {
            try {
                if (!treeObj && !treeData) {
                    console.error('[AUTO-SAVE-SR] Nem treeObj nem treeData existem!');
                    reject(new Error('Dados da √°rvore n√£o dispon√≠veis'));
                    return;
                }

                // ‚úÖ Usa treeData diretamente (mais confi√°vel ap√≥s modifica√ß√µes manuais)
                var dataSource = treeData || treeObj.getTreeData();
                console.log('[AUTO-SAVE-SR] DataSource obtido (treeData):', dataSource);

                var items = extrairItensDoTreeView(dataSource, null, 0);
                console.log('[AUTO-SAVE-SR] Items extra√≠dos para salvar:', items.length);

                if (items.length === 0) {
                    console.warn('[AUTO-SAVE-SR] Nenhum item para salvar!');
                    reject(new Error('Nenhum item para salvar'));
                    return;
                }

                console.log('[AUTO-SAVE-SR] Enviando para backend...');

                fetch('/api/Navigation/SaveTreeToDb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(items)
                })
                .then(function(r) {
                    console.log('[AUTO-SAVE-SR] Response status:', r.status);
                    return r.json().then(function(data) {
                        return { ok: r.ok, status: r.status, data: data };
                    });
                })
                .then(function(response) {
                    console.log('[AUTO-SAVE-SR] Response do backend:', response.data);

                    if (!response.ok) {
                        console.error('[AUTO-SAVE-SR] ‚ùå HTTP Error:', response.status);
                        reject(new Error(response.data.message || 'Erro HTTP ' + response.status));
                        return;
                    }

                    if (response.data.success) {
                        console.log('[AUTO-SAVE-SR] ‚úÖ Ordena√ß√£o salva com sucesso (sem reload)!');
                        resolve(response.data);
                    } else {
                        console.error('[AUTO-SAVE-SR] ‚ùå Erro no backend:', response.data.message);
                        reject(new Error(response.data.message));
                    }
                })
                .catch(function(erro) {
                    console.error('[AUTO-SAVE-SR] ‚ùå Erro no fetch:', erro);
                    reject(erro);
                });
            } catch (erro) {
                console.error('[AUTO-SAVE-SR] ‚ùå Erro no try-catch:', erro);
                reject(erro);
            }
        });
    }

    // ‚úÖ Atualiza a navega√ß√£o lateral (menu do sistema)
    function atualizarNavegacaoLateral() {
        try {
            console.log('[NAV-UPDATE] Atualizando navega√ß√£o lateral...');

            // ‚úÖ SOLU√á√ÉO SIMPLES E EFICAZ: Recarrega a p√°gina inteira ap√≥s 1 segundo
            // Isso garante que o menu lateral seja atualizado com os dados mais recentes do banco
            setTimeout(function() {
                console.log('[NAV-UPDATE] Recarregando p√°gina para atualizar navega√ß√£o...');
                window.location.reload();
            }, 1000);
        } catch (erro) {
            console.error('[NAV-UPDATE] Erro:', erro);
        }
    }

    // Helper: Toast discreto para auto-save
    function mostrarToastSucesso(mensagem) {
        try {
            if (window.AppToast && typeof window.AppToast.show === 'function') {
                // Converte entidades HTML para texto vis√≠vel no toast
                var msgDecodificada = decodeHtml(mensagem);
                window.AppToast.show('Verde', msgDecodificada, 4000);
            } else if (typeof showSyncfusionToast === 'function') {
                showSyncfusionToast(decodeHtml(mensagem), 'success', '‚úÖ');
            } else if (typeof Alerta !== 'undefined' && Alerta.Toast) {
                Alerta.Toast('success', decodeHtml(mensagem));
            } else {
                console.log('[TOAST]', mensagem);
            }
        } catch (erro) {
            console.log('[TOAST]', mensagem);
        }
    }

    // Extrai itens do TreeView para salvar
    function extrairItensDoTreeView(items, parentId, nivel) {
        try {
            if (!items) return [];

            var result = [];

            items.forEach(function(item, index) {
                var newItem = {
                    id: item.id,
                    text: item.text,
                    nomeMenu: item.nomeMenu,
                    icon: item.icon,
                    href: item.href,
                    parentId: parentId,
                    ordem: (nivel * 100) + index + 1,
                    nivel: nivel,
                    ativo: item.ativo !== false,
                    descricao: item.descricao,
                    items: []
                };

                if (item.items && item.items.length > 0) {
                    newItem.items = extrairItensDoTreeView(item.items, item.id, nivel + 1);
                }

                result.push(newItem);
            });

            return result;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "extrairItensDoTreeView", erro);
            return [];
        }
    }

    // Atualiza contagem de itens
    function atualizarContagem() {
        try {
            var total = contarItens(treeData);
            document.getElementById('itemCount').textContent = total + ' itens';
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarContagem", erro);
        }
    }

    function contarItens(items) {
        try {
            if (!items) return 0;
            var count = items.length;
            items.forEach(function(item) {
                if (item.items && item.items.length > 0) {
                    count += contarItens(item.items);
                }
            });
            return count;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "contarItens", erro);
            return 0;
        }
    }

    // Migra dados do JSON
    function migrarDadosJson() {
        try {
            Alerta.Confirmar(
                'Confirmar Migra√ß√£o',
                'Isso ir√° migrar os dados do nav.json para o banco de dados. Continuar?',
                'Migrar',
                'Cancelar'
            ).then(function(result) {
                if (!result) return;

                mostrarAlerta('Migrando dados...', 'info');

                fetch('/api/Navigation/MigrateFromJson', {
                    method: 'POST'
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');
                        carregarArvore();
                    } else {
                        mostrarAlerta('Erro: ' + result.message, 'danger');
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "migrarDadosJson", erro);
                });
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "migrarDadosJson", erro);
        }
    }

    // Seleciona todos os acessos
    function selecionarTodosAcessos() {
        try {
            document.querySelectorAll('#listaAcessos input[type="checkbox"]').forEach(function(cb) {
                if (!cb.checked) {
                    cb.checked = true;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "selecionarTodosAcessos", erro);
        }
    }

    // Verifica se h√° mudan√ßas n√£o salvas no formul√°rio
    function verificarMudancasNaoSalvas() {
        try {
            if (!selectedItem) return false;

            // Pega valores atuais do formul√°rio
            var txtNome = document.getElementById('txtNome').value;
            var txtNomeMenu = document.getElementById('txtNomeMenu').value;
            var txtHref = document.getElementById('txtHref').value;
            var txtIconClass = document.getElementById('txtIconClass').value;
            var txtOrdem = parseFloat(document.getElementById('txtOrdem').value) || 0;
            var txtDescricao = document.getElementById('txtDescricao').value;
            var chkAtivo = document.getElementById('chkAtivo').checked;
            var parentId = document.getElementById('parentId').value;

            // Compara com valores originais do selectedItem (decodificados)
            var nomeOriginal = decodeHtml(selectedItem.text) || '';
            var nomeMenuOriginal = decodeHtml(selectedItem.nomeMenu) || '';
            var hrefOriginal = selectedItem.href || '';
            var iconOriginal = selectedItem.icon || '';
            var ordemOriginal = selectedItem.ordem || 0;
            var descricaoOriginal = decodeHtml(selectedItem.descricao) || '';
            var ativoOriginal = selectedItem.ativo !== false;
            var parentIdOriginal = selectedItem.parentId || '';

            // Retorna true se houver alguma diferen√ßa
            return txtNome !== nomeOriginal ||
                   txtNomeMenu !== nomeMenuOriginal ||
                   txtHref !== hrefOriginal ||
                   txtIconClass !== iconOriginal ||
                   txtOrdem !== ordemOriginal ||
                   txtDescricao !== descricaoOriginal ||
                   chkAtivo !== ativoOriginal ||
                   parentId !== parentIdOriginal;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "verificarMudancasNaoSalvas", erro);
            return false;
        }
    }

    // Fecha ambos os cards (Propriedades e Controle de Acesso)
    function fecharCards() {
        try {
            // Verifica se est√° em modo edi√ß√£o (tem selectedItem com ID)
            var emModoEdicao = selectedItem && selectedItem.id;

            // Se estiver em modo edi√ß√£o e houver mudan√ßas n√£o salvas
            if (emModoEdicao && verificarMudancasNaoSalvas()) {
                Alerta.Confirmar(
                    'Mudan√ßas N√£o Salvas',
                    'Voc√™ tem mudan√ßas n√£o salvas. Deseja salvar antes de fechar?',
                    'Salvar',
                    'Descartar'
                ).then(function(result) {
                    if (result) {
                        // Usu√°rio escolheu SALVAR
                        salvarPropriedades();
                        // N√£o fecha os cards aqui, salvarPropriedades j√° gerencia isso
                    } else {
                        // Usu√°rio escolheu DESCARTAR - fecha os cards
                        document.getElementById('propsCard').style.display = 'none';
                        document.getElementById('acessoCard').style.display = 'none';
                        habilitarCardPropriedades(true);
                        limparFormulario(true);
                    }
                });
                return;
            }

            // Fecha os cards normalmente
            document.getElementById('propsCard').style.display = 'none';
            document.getElementById('acessoCard').style.display = 'none';
            habilitarCardPropriedades(true);
            limparFormulario(true);
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "fecharCards", erro);
        }
    }

    // Habilita ou desabilita todos os campos do Card de Propriedades
    function habilitarCardPropriedades(habilitar) {
        try {
            var campos = document.querySelectorAll('#formPropriedades input, #formPropriedades textarea, #formPropriedades select, #formPropriedades button');
            campos.forEach(function(campo) {
                if (habilitar) {
                    campo.removeAttribute('disabled');
                    campo.style.opacity = '1';
                    campo.style.cursor = 'auto';
                } else {
                    campo.setAttribute('disabled', 'disabled');
                    campo.style.opacity = '0.6';
                    campo.style.cursor = 'not-allowed';
                }
            });

            // Mant√©m o bot√£o Salvar Propriedades desabilitado quando est√° no modo de controle de acesso
            var btnSalvar = document.querySelector('#formPropriedades button[onclick*="salvarPropriedades"]');
            if (btnSalvar && !habilitar) {
                btnSalvar.setAttribute('disabled', 'disabled');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarCardPropriedades", erro);
        }
    }

    // Habilita acesso para todos os usu√°rios (chamado ao criar novo item)
    function habilitarAcessoTodosUsuarios(recursoId) {
        try {
            fetch('/api/Navigation/HabilitarAcessoTodosUsuarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recursoId: recursoId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    console.log('Acessos habilitados para todos os usu√°rios');
                    carregarControleAcesso(recursoId);
                } else {
                    console.error('Erro ao habilitar acessos:', result.message);
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarAcessoTodosUsuarios", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarAcessoTodosUsuarios", erro);
        }
    }

    // Mostra alerta toast
    // Fun√ß√£o wrapper para mostrar alertas usando SweetAlert
    function mostrarAlerta(mensagem, tipo) {
        try {
            // Mapeia tipos Bootstrap para fun√ß√µes SweetAlert
            switch(tipo) {
                case 'success':
                    return Alerta.Sucesso('Sucesso', mensagem);
                case 'danger':
                case 'error':
                    return Alerta.Erro('Erro', mensagem);
                case 'warning':
                    return Alerta.Warning('Aten√ß√£o', mensagem);
                case 'info':
                    return Alerta.Info('Informa√ß√£o', mensagem);
                default:
                    return Alerta.Info('Aviso', mensagem);
            }
        } catch (erro) {
            // Fallback para console se SweetAlert falhar
            console.error('[mostrarAlerta] Erro ao exibir alerta:', erro);
            console.log(`[${tipo}] ${mensagem}`);
        }
    }
</script>
}
