@page
@model FrotiX.Pages.Administracao.GestaoRecursosNavegacaoModel

@{
    ViewData["Title"] = "Gest√£o de Recursos e Navega√ß√£o";
    ViewData["PageName"] = "administracao_gestaorecursosnavegacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-sitemap'></i> Administra√ß√£o: <span class='fw-300'>Gest√£o de Recursos e Navega√ß√£o</span>";
    ViewData["Category1"] = "Administra√ß√£o";
    ViewData["PageIcon"] = "fa-duotone fa-sitemap";
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADRAO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .ftx-card-header .header-actions {
            display: flex;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* ====== LAYOUT PRINCIPAL ====== */
        .gestao-container {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            min-height: calc(100vh - 200px);
        }

        /* ====== COLUNA ESQUERDA - TREEVIEW ====== */
        .tree-panel {
            flex: 0 0 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .tree-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: calc(100vh - 350px);
        }

        .tree-actions {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.5rem;
        }

        /* ====== COLUNA DIREITA - PROPRIEDADES ====== */
        .props-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Card de propriedades */
        .props-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .props-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .props-header h5 {
            margin: 0;
            font-weight: 600;
            color: #3D5771;
        }

        .props-body {
            padding: 1.5rem;
        }

        /* ====== FORMULARIO DE PROPRIEDADES ====== */
        .form-group {
            margin-bottom: 2rem;  /* Espa√ßamento vertical aumentado significativamente */
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.375rem;  /* Mant√©m label pr√≥xima ao controle */
            font-size: 0.875rem;
        }

        /* Asteriscos obrigat√≥rios nas labels */
        .form-group label .required-asterisk {
            font-size: calc(0.875rem - 2px);
            color: #dc3545;
            font-style: italic;
            margin-left: 0.25rem;
        }

        /* Bot√µes de ordena√ß√£o */
        .order-controls {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .btn-order {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            background: #fff;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 24px;
        }

        .btn-order:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #3D5771;
            color: #3D5771;
        }

        .btn-order:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-order i {
            font-size: 0.875rem;
        }

        .order-input-group {
            display: flex;
            align-items: center;
        }

        .form-group .form-control {
            border-radius: 6px;
            border: 1px solid #ced4da;
            padding: 0.5rem 0.75rem;
        }

        .form-group .form-control:focus {
            border-color: #3D5771;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15);
        }

        /* ====== CARD DE CONTROLE DE ACESSO ====== */
        .acesso-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .acesso-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .acesso-item:last-child {
            border-bottom: none;
        }

        .acesso-item label {
            flex: 1;
            margin: 0;
            cursor: pointer;
        }

        /* ====== TREEVIEW CUSTOMIZADO ====== */
        #gestaoTreeView .e-treeview {
            background: transparent;
        }

        /* REMOVE o √≠cone padr√£o do Syncfusion (evita duplica√ß√£o) */
        #gestaoTreeView .e-treeview .e-list-icon {
            display: none !important;
        }

        /* REMOVE o fundo azul de sele√ß√£o padr√£o do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-item.e-active,
        #gestaoTreeView .e-treeview .e-list-item.e-node-focus,
        #gestaoTreeView .e-treeview .e-list-item:focus,
        #gestaoTreeView .e-treeview .e-fullrow.e-active,
        #gestaoTreeView .e-treeview .e-text-content.e-active {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Remove fullrow highlight */
        #gestaoTreeView .e-treeview .e-fullrow {
            display: none !important;
        }

        #gestaoTreeView .e-list-item {
            padding: 2px 0;
            background: transparent !important;
        }

        #gestaoTreeView .e-text-content {
            background: transparent !important;
            border: none !important;
        }

        #gestaoTreeView .tree-node {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #gestaoTreeView .tree-node:hover {
            background: #f1f3f5;
        }

        #gestaoTreeView .tree-node.selected {
            background: rgba(61, 87, 113, 0.15) !important;
            border-left: 3px solid #3D5771;
        }

        /* Garante que o texto N√ÉO desaparece ao selecionar */
        #gestaoTreeView .tree-node .node-text,
        #gestaoTreeView .tree-node.selected .node-text,
        #gestaoTreeView .e-list-item .tree-node .node-text,
        #gestaoTreeView .e-list-item.e-active .tree-node .node-text,
        #gestaoTreeView .e-list-item.e-node-focus .tree-node .node-text {
            color: #333 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Texto em NEGRITO quando item est√° selecionado */
        #gestaoTreeView .tree-node.selected .node-text {
            font-weight: 700 !important;
        }

        /* Texto em NEGRITO para grupos (n√≥s com filhos ou href vazio) */
        #gestaoTreeView .tree-node .node-text.node-group {
            font-weight: 700;
        }

        /* FOR√áA texto vis√≠vel em TODOS os estados do Syncfusion */
        #gestaoTreeView .e-treeview .e-list-text,
        #gestaoTreeView .e-treeview .e-text-content,
        #gestaoTreeView .e-treeview .e-list-item span,
        #gestaoTreeView .e-treeview .e-active .e-list-text,
        #gestaoTreeView .e-treeview .e-node-focus .e-list-text {
            color: #333 !important;
        }

        /* Classe para √≠cones duotone padr√£o FrotiX (reutiliz√°vel) */
        .icon-duotone-ftx {
            --fa-primary-color: #ff6b35;      /* Laranja forte */
            --fa-secondary-color: #6c757d;    /* Cinza m√©dio */
            --fa-primary-opacity: 1;
            --fa-secondary-opacity: 1;
            margin-right: 0.5rem;  /* Espa√ßamento de 2 caracteres */
        }

        /* √çcones duotone com cores FrotiX padr√£o */
        #gestaoTreeView .tree-node i,
        #gestaoTreeView .tree-node i.fa-duotone {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* √çcone do item selecionado mant√©m cores padr√£o */
        #gestaoTreeView .tree-node.selected i,
        #gestaoTreeView .tree-node.selected i.fa-duotone {
            --fa-primary-color: #ff6b35;
            --fa-secondary-color: #6c757d;
        }

        /* Drop como filho - destaca item inteiro */
        #gestaoTreeView .e-drop-target-child {
            background-color: rgba(0, 123, 255, 0.2) !important;
            border: 2px dashed #007bff !important;
            border-radius: 6px;
        }

        /* Drop como irm√£o - linha indicadora */
        #gestaoTreeView .e-drop-target-sibling {
            position: relative;
        }

        #gestaoTreeView .e-drop-target-sibling::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: -2px;
            height: 3px;
            background-color: #007bff;
            border-radius: 2px;
            z-index: 10;
        }

        #gestaoTreeView .tree-node .node-text {
            flex: 1;
            font-size: 0.9rem;
            color: #333;
        }

        #gestaoTreeView .tree-node .node-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #e9ecef;
            color: #6c757d;
        }

        /* Drag and drop */
        #gestaoTreeView .e-drag-item {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
        }

        /* ‚úÖ Destaca item quando pode soltar sobre ele (como filho) */
        #gestaoTreeView .e-treeview .e-list-item.e-drop-target {
            background-color: rgba(198, 119, 80, 0.1) !important;
            border: 2px dashed #c67750 !important;
            border-radius: 6px;
        }

        /* ‚úÖ Remove a seta azul padr√£o (drop indicator) entre itens quando queremos drop sobre item */
        #gestaoTreeView .e-treeview .e-drop-indicator {
            display: none !important;
        }

        /* ‚úÖ Mostra indicador visual quando pode soltar sobre item */
        #gestaoTreeView .e-treeview .e-list-item.e-drop-target::before {
            content: "üìÅ Soltar aqui para criar grupo";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: #c67750;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 1000;
            pointer-events: none;
        }

        /* ====== BOTOES ====== */
        /* Os bot√µes usam classes globais do FrotiX: btn-azul, btn-ftx-fechar, btn-voltar */

        /* Estado vazio */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* ====== MENSAGENS ====== */
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @@keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ====== DROPDOWNTREE DE √çCONES - BORDAS SEMPRE VIS√çVEIS ====== */
        .ddl-icone-border .e-ddt-wrapper,
        .ddl-icone-border .e-input-group,
        .ddl-icone-border.e-dropdowntree .e-input-group,
        .ddl-icone-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-icone-border .e-input-group.e-input-focus,
        .ddl-icone-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* For√ßa bordas mesmo quando vazio */
        #ddlIcone.e-dropdowntree,
        #ddlIcone .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }

        /* ====== DROPDOWNTREE DE P√ÅGINAS - BORDAS SEMPRE VIS√çVEIS ====== */
        .ddl-pagina-border .e-ddt-wrapper,
        .ddl-pagina-border .e-input-group,
        .ddl-pagina-border.e-dropdowntree .e-input-group,
        .ddl-pagina-border.e-input-group {
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
        }

        .ddl-pagina-border .e-input-group.e-input-focus,
        .ddl-pagina-border.e-input-group.e-input-focus {
            border-color: #3D5771 !important;
            box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.15) !important;
        }

        /* For√ßa bordas mesmo quando vazio */
        #ddlPagina.e-dropdowntree,
        #ddlPagina .e-ddt-wrapper {
            border: 1px solid #ced4da !important;
        }
    </style>
}

<div class="ftx-card-header">
    <h2 class="titulo-paginas mb-0">
        <i class="fa-duotone fa-sitemap"></i>
        Gest√£o de Recursos e Navega√ß√£o
    </h2>
    <div class="header-actions">
        <button type="button" class="btn btn-header-orange" onclick="migrarDadosJson()">
            <i class="fa-duotone fa-database icon-space"></i> Migrar do JSON
        </button>
        <a asp-page="/Index" class="btn btn-header-orange">
            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar
        </a>
    </div>
</div>

<div class="gestao-container">
    <!-- Coluna Esquerda: TreeView -->
    <div class="tree-panel">
        <div class="tree-header">
            <h5><i class="fa-duotone fa-folder-tree"></i> Estrutura do Menu</h5>
            <span id="itemCount" class="badge bg-secondary">0 itens</span>
        </div>
        <div class="tree-content" id="gestaoTreeView">
            <div class="empty-state" id="emptyTreeState">
                <i class="fa-duotone fa-folder-open"></i>
                <p>Nenhum recurso encontrado.<br>Clique em "Migrar do JSON" para importar ou adicione novos itens.</p>
            </div>
        </div>
        <div class="tree-actions">
            <button type="button" class="btn btn-header-orange btn-submit-spin" onclick="adicionarNovoItem()">
                <i class="fa-duotone fa-plus icon-space icon-pulse"></i> Novo Item
            </button>
            <!-- ‚úÖ REMOVIDO: Salvamento agora √© autom√°tico ap√≥s drag-drop -->
        </div>
    </div>

    <!-- Coluna Direita: Propriedades -->
    <div class="props-panel">
        <!-- Card: Propriedades do Item -->
        <div class="props-card" id="propsCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-sliders"></i> Propriedades do Item <span id="modoEdicao" class="badge bg-secondary ms-2">Selecione</span></h5>
                <span id="selectedItemName" class="text-muted">Nenhum item selecionado</span>
            </div>
            <div class="props-body">
                <form id="formPropriedades">
                    <input type="hidden" id="recursoId" />
                    <input type="hidden" id="parentId" />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNome">Nome (exibido no menu)<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="txtNome" placeholder="Ex: Veiculos" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="txtNomeMenu">NomeMenu (identificador √∫nico)<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="txtNomeMenu" placeholder="Ex: veiculo" />
                            </div>
                        </div>
                    </div>

                    <!-- DropDownTree de P√°ginas - DEVE FICAR ANTES DO CAMPO URL -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlPagina">Selecione a P√°gina do Sistema</label>

                                <ejs-dropdowntree id="ddlPagina"
                                                 placeholder="Busque ou selecione uma p√°gina..."
                                                 popupHeight="400px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline ddl-pagina-border"
                                                 created="onPaginaDropdownCreated">
                                </ejs-dropdowntree>

                                <small class="form-text text-muted mt-1">
                                    Ao selecionar uma p√°gina, a URL ser√° preenchida automaticamente abaixo
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- DropDown de Sele√ß√£o do Item Pai (Grupo) -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="ddlItemPai">Item Pai (Grupo)</label>
                                <ejs-dropdownlist id="ddlItemPai"
                                                 placeholder="Selecione o grupo pai deste item..."
                                                 popupHeight="300px"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline"
                                                 change="onItemPaiChange">
                                </ejs-dropdownlist>
                                <small class="form-text text-muted mt-1">
                                    Ao mudar o Item Pai, a Ordem ser√° recalculada automaticamente
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="txtHref">URL da P√°gina (gerada automaticamente)</label>
                                <input type="text" class="form-control" id="txtHref" readonly
                                       placeholder="Selecione uma p√°gina acima para gerar a URL..."
                                       style="background-color: #f8f9fa; cursor: not-allowed;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="txtOrdem">Ordem (calculada automaticamente)</label>
                                <div class="order-input-group">
                                    <input type="number" class="form-control" id="txtOrdem" value="0" readonly
                                           style="background-color: #f8f9fa;" />
                                    <div class="order-controls" id="orderControls">
                                        <button type="button" class="btn-order" id="btnOrderUp" 
                                                data-bs-toggle="tooltip" 
                                                data-bs-custom-class="tooltip-ftx-azul"
                                                data-bs-placement="top"
                                                title="Mover item para cima">
                                            <i class="fa-duotone fa-arrow-up"></i>
                                        </button>
                                        <button type="button" class="btn-order" id="btnOrderDown"
                                                data-bs-toggle="tooltip"
                                                data-bs-custom-class="tooltip-ftx-azul"
                                                data-bs-placement="bottom"
                                                title="Mover item para baixo">
                                            <i class="fa-duotone fa-arrow-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="ddlIcone">Selecione o √çcone (FontAwesome 7 Pro)<span class="required-asterisk">*</span></label>

                                <!-- DropDownTree para sele√ß√£o hier√°rquica -->
                                <ejs-dropdowntree id="ddlIcone"
                                                 placeholder="Busque ou selecione um √≠cone..."
                                                 popupHeight="400px"
                                                 showCheckBox="false"
                                                 showClearButton="true"
                                                 allowFiltering="true"
                                                 filterType="Contains"
                                                 ignoreCase="true"
                                                 cssClass="e-outline ddl-icone-border"
                                                 created="onIconeDropdownCreated"
                                                 change="onIconeChange">
                                </ejs-dropdowntree>

                                <!-- Campo bloqueado exibindo a classe CSS completa do √≠cone selecionado -->
                                <small class="form-text text-muted mt-1">Classe CSS:</small>
                                <input type="text" class="form-control form-control-sm mt-1" id="txtIconClass" readonly
                                       placeholder="A classe do √≠cone aparecer√° aqui..."
                                       style="background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem;" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="chkAtivo">Status</label>
                                <div class="form-check mt-2">
                                    <input type="checkbox" class="form-check-input" id="chkAtivo" checked />
                                    <label class="form-check-label" for="chkAtivo">Ativo no menu</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="txtDescricao">Descri√ß√£o</label>
                        <textarea class="form-control" id="txtDescricao" rows="2" placeholder="Descri√ß√£o do recurso..."></textarea>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-azul btn-submit-spin" onclick="salvarPropriedades()">
                            <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Salvar Propriedades
                        </button>
                        <button type="button" class="btn btn-ftx-fechar" onclick="excluirItem()">
                            <i class="fa-duotone fa-trash icon-space icon-pulse"></i> Excluir
                        </button>
                        <button type="button" class="btn btn-voltar" onclick="limparFormulario()">
                            <i class="fa-duotone fa-eraser icon-space icon-pulse"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card: Controle de Acesso -->
        <div class="props-card" id="acessoCard" style="display: none;">
            <div class="props-header">
                <h5><i class="fa-duotone fa-users"></i> Controle de Acesso</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodosAcessos()">
                    Marcar Todos
                </button>
            </div>
            <div class="props-body">
                <div class="acesso-list" id="listaAcessos">
                    <div class="empty-state">
                        <p class="text-muted mb-0">Selecione um item para gerenciar acessos</p>
                    </div>
                </div>
            </div>
            <div class="props-footer" style="padding: 15px; border-top: 1px solid #dee2e6; text-align: center;">
                <button type="button" class="btn btn-ftx-fechar" onclick="fecharCards()">
                    <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar Item
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
<script>
    var treeData = [];
    var treeObj = null;
    var selectedItem = null;
    var lastDragInfo = null; // guarda informa√ß√£o do movimento para o toast

    // Helper para achar √≠cone no dataSource do DropDownTree
    function findIconById(iconId) {
        try {
            var ddlIconeObj = document.getElementById('ddlIcone')?.ej2_instances?.[0];
            if (!ddlIconeObj || !ddlIconeObj.fields || !ddlIconeObj.fields.dataSource) return null;
            var ds = ddlIconeObj.fields.dataSource;
            for (var i = 0; i < ds.length; i++) {
                var cat = ds[i];
                if (cat.child && cat.child.length > 0) {
                    for (var j = 0; j < cat.child.length; j++) {
                        if (cat.child[j].id === iconId) return cat.child[j];
                    }
                }
            }
            return null;
        } catch (e) {
            console.warn('[findIconById] Erro:', e);
            return null;
        }
    }

    // ‚úÖ Vari√°veis para rastrear √∫ltima sele√ß√£o nos DropDownTrees
    var ultimoIconeSelecionado = null;
    var ultimaPaginaSelecionada = null;

    // Callback AP√ìS o DropDownTree de √≠cones ser criado
    function onIconeDropdownCreated() {
        try {
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj) {
                ddlIconeObj.itemTemplate = function(data) {
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                    }
                    // ‚úÖ Garante que seja duotone e aplica cores padr√£o FrotiX
                    var iconClass = data.id || '';
                    if (iconClass && !iconClass.includes('fa-duotone')) {
                        iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + iconClass + '" style="font-size: 16px; width: 20px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span style="color: #5f6b7a;">' + data.text + '</span>' +
                           '</div>';
                };

                ddlIconeObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    // ‚úÖ Garante que seja duotone e aplica cores padr√£o FrotiX
                    var iconClass = data.id || '';
                    if (iconClass && !iconClass.includes('fa-duotone')) {
                        iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="' + iconClass + '" style="font-size: 14px; width: 18px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span style="color: #5f6b7a;">' + data.text + '</span>' +
                           '</div>';
                };

                // Eventos alinhados ao comportamento de p√°ginas (aplica no primeiro clique)
                ddlIconeObj.selecting = function(args) {
                    if (args.nodeData && !args.nodeData.isCategory) {
                        ultimoIconeSelecionado = args.nodeData.id;
                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = args.nodeData.id;
                        }
                    }
                };

                ddlIconeObj.select = function(args) {
                    console.log('=== SELECT √≠cone ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        ultimoIconeSelecionado = args.nodeData.id;
                        var txtIconClass = document.getElementById('txtIconClass');
                        if (txtIconClass) {
                            txtIconClass.value = args.nodeData.id;
                        }
                        // ‚úÖ Define o valor e fecha o popup IMEDIATAMENTE
                        ddlIconeObj.value = [args.nodeData.id];
                        ddlIconeObj.dataBind();
                        setTimeout(function() {
                            ddlIconeObj.hidePopup();
                            // ‚úÖ Dispara change manualmente ap√≥s fechar
                            onIconeChange({ itemData: args.nodeData, value: [args.nodeData.id] });
                            // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
                            atualizarEstadoBotoesOrdenacao();
                        }, 50);
                    }
                };

                ddlIconeObj.change = function(args) {
                    onIconeChange(args);
                };

                ddlIconeObj.changeOnBlur = false;

                console.log('Templates e eventos de √≠cone configurados');
            }
        } catch (error) {
            console.error('Erro ao configurar template do DropDownTree:', error);
        }
    }

    // ========== FUN√á√ïES DE CODIFICA√á√ÉO/DECODIFICA√á√ÉO HTML ==========

    // Decodifica entidades HTML para caracteres normais (para exibi√ß√£o)
    function decodeHtml(html) {
        try {
            if (!html) return html;
            var txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        } catch (erro) {
            console.error('[decodeHtml] Erro:', erro);
            return html; // Retorna valor original em caso de erro
        }
    }

    // Codifica TODOS caracteres especiais e acentuados para entidades HTML (para grava√ß√£o)
    function encodeHtml(text) {
        try {
            if (!text) return text;

            var result = '';
            for (var i = 0; i < text.length; i++) {
                var char = text[i];
                var code = char.charCodeAt(0);

                // Se for caractere ASCII b√°sico (32-126) exceto < > & " '
                if (code >= 32 && code <= 126 && char !== '<' && char !== '>' && char !== '&' && char !== '"' && char !== "'") {
                    result += char;
                } else {
                    // Converte para entidade HTML num√©rica
                    result += '&#' + code + ';';
                }
            }
            return result;
        } catch (erro) {
            console.error('[encodeHtml] Erro:', erro);
            return text; // Retorna valor original em caso de erro
        }
    }

    // Carrega dados ao iniciar
    document.addEventListener('DOMContentLoaded', function() {
        carregarArvore();
        carregarIconesFontAwesome();
        carregarPaginasSistema();
    });

    // Popula dropdown de Item Pai com todos os grupos (n√£o-p√°gina)
    function popularDropdownItemPai() {
        try {
            var grupos = [];

            // ‚úÖ Adiciona op√ß√£o "<sem grupo>" no in√≠cio
            grupos.push({
                id: null,
                text: '<sem grupo>',
                textFormatado: '<sem grupo>',
                nivel: -1
            });

            // Fun√ß√£o recursiva para extrair todos os grupos da √°rvore
            function extrairGrupos(items) {
                if (!items) return;

                items.forEach(function(item) {
                    // Grupo = href vazio ou 'javascript:void(0);'
                    var isGrupo = !item.href || item.href === 'javascript:void(0);';

                    if (isGrupo) {
                        grupos.push({
                            id: item.id,
                            text: item.text,
                            nivel: calcularNivel(item.id)
                        });
                    }

                    // Recurs√£o nos filhos
                    if (item.items && item.items.length > 0) {
                        extrairGrupos(item.items);
                    }
                });
            }

            // Calcula n√≠vel do item na hierarquia (quantos pais tem)
            function calcularNivel(itemId) {
                var nivel = 0;
                var item = buscarItemPorId(treeData, itemId);

                while (item && item.parentId) {
                    nivel++;
                    item = buscarItemPorId(treeData, item.parentId);
                }

                return nivel;
            }

            // Extrai todos os grupos da √°rvore
            extrairGrupos(treeData);

            // Formata texto com indenta√ß√£o baseada no n√≠vel E decodifica HTML
            grupos.forEach(function(grupo) {
                if (grupo.id === null) {
                    // "<sem grupo>" n√£o precisa indenta√ß√£o
                    grupo.textFormatado = '<sem grupo>';
                } else {
                    var indentacao = '  '.repeat(grupo.nivel);
                    grupo.textFormatado = indentacao + decodeHtml(grupo.text);  // ‚úÖ DECODIFICA
                }
            });

            // ‚úÖ Ordena alfabeticamente (exceto "<sem grupo>" que fica primeiro)
            grupos.sort(function(a, b) {
                if (a.id === null) return -1; // "<sem grupo>" sempre primeiro
                if (b.id === null) return 1;
                return a.textFormatado.localeCompare(b.textFormatado);
            });

            console.log('Grupos encontrados:', grupos.length - 1, '+ <sem grupo>');

            // Popula o DropDownList
            var ddlItemPai = document.getElementById('ddlItemPai');
            if (ddlItemPai && ddlItemPai.ej2_instances && ddlItemPai.ej2_instances[0]) {
                var ddl = ddlItemPai.ej2_instances[0];
                ddl.dataSource = grupos;
                ddl.fields = { text: 'textFormatado', value: 'id' };
                ddl.dataBind();
                console.log('‚úÖ DropDownList de Item Pai populado');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "popularDropdownItemPai", erro);
        }
    }

    // Evento change do dropdown de Item Pai
    function onItemPaiChange(args) {
        try {
            console.log('=== Item Pai alterado ===');
            console.log('Novo Pai ID:', args.value);

            if (!selectedItem || !selectedItem.id) {
                console.warn('Nenhum item selecionado');
                return;
            }

            var novoPaiId = args.value; // null se "<sem grupo>"
            var item = buscarItemPorId(treeData, selectedItem.id);

            if (!item) {
                console.error('Item n√£o encontrado na √°rvore');
                return;
            }

            // ‚úÖ Se selecionou "<sem grupo>" e item √© grupo (sem href)
            if (novoPaiId === null && (!item.href || item.href === 'javascript:void(0);')) {
                console.log('[TRANSFORMAR] Transformando grupo em p√°gina raiz');
                
                // Transforma grupo em p√°gina raiz
                // Remove href vazio, mant√©m apenas √≠cone e nome
                item.href = null; // Ser√° definido quando selecionar p√°gina
                item.parentId = null;
                
                // Remove filhos se houver (grupo n√£o pode ter filhos se vira p√°gina)
                if (item.items && item.items.length > 0) {
                    Alerta.Warning(
                        'Aten√ß√£o',
                        'Este grupo possui ' + item.items.length + ' filho(s). Ao transform√°-lo em p√°gina, os filhos ser√£o movidos para a raiz. Deseja continuar?',
                        'OK'
                    );
                    // Move filhos para raiz
                    item.items.forEach(function(filho) {
                        filho.parentId = null;
                        if (!treeData.find(function(i) { return i.id === filho.id; })) {
                            treeData.push(filho);
                        }
                    });
                    item.items = [];
                }
                
                // Atualiza TreeView
                treeObj.fields.dataSource = treeData;
                treeObj.dataBind();
                
                // Atualiza formul√°rio
                document.getElementById('parentId').value = '';
                var txtHref = document.getElementById('txtHref');
                if (txtHref) txtHref.value = '';
                
                // Limpa campo de p√°gina para usu√°rio escolher
                var ddlPagina = document.getElementById('ddlPagina');
                if (ddlPagina && ddlPagina.ej2_instances && ddlPagina.ej2_instances[0]) {
                    ddlPagina.ej2_instances[0].value = null;
                    ddlPagina.ej2_instances[0].dataBind();
                }
                
                // Atualiza item selecionado
                selecionarItem(item);
                
                // Salva altera√ß√µes
                salvarOrdenacaoAutomatica();
                return;
            }

            if (!novoPaiId) {
                console.log('Pai removido - mant√©m ordem atual');
                return;
            }

            // Calcula nova ordem baseada nos filhos do novo pai
            calcularOrdemAutomatica(novoPaiId);

            // Atualiza campo parentId oculto
            document.getElementById('parentId').value = args.value;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onItemPaiChange", erro);
        }
    }

    // Calcula ordem automaticamente baseada nos filhos do pai
    function calcularOrdemAutomatica(paiId) {
        try {
            console.log('Calculando ordem para pai:', paiId);

            // Busca o item pai no treeData
            var pai = buscarItemPorId(treeData, paiId);

            if (!pai) {
                console.warn('Pai n√£o encontrado no treeData');
                document.getElementById('txtOrdem').value = 0;
                return;
            }

            // Busca todos os filhos do pai
            var filhos = pai.items || [];
            console.log('Filhos encontrados:', filhos.length);

            if (filhos.length === 0) {
                // Primeiro filho
                document.getElementById('txtOrdem').value = 0;
                console.log('‚úÖ Ordem definida: 0 (primeiro filho)');
                return;
            }

            // Encontra a maior ordem entre os filhos
            var maiorOrdem = -1;
            filhos.forEach(function(filho) {
                var ordem = parseFloat(filho.ordem) || 0;
                if (ordem > maiorOrdem) {
                    maiorOrdem = ordem;
                }
            });

            // Nova ordem = maior + 1
            var novaOrdem = maiorOrdem + 1;
            document.getElementById('txtOrdem').value = novaOrdem;
            console.log('‚úÖ Ordem calculada:', novaOrdem, '(maior atual:', maiorOrdem, ')');
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "calcularOrdemAutomatica", erro);
        }
    }

    // Carrega arvore do banco de dados
    function carregarArvore() {
        try {
            console.log('[DEBUG] Iniciando carregamento da √°rvore...');
            fetch('/api/Navigation/GetTreeAdmin')
                .then(r => {
                    console.log('[DEBUG] Response recebido:', r.status, r.statusText);
                    return r.json();
                })
                .then(result => {
                    console.log('[DEBUG] Dados recebidos da API:', result);
                    console.log('[DEBUG] result.success:', result.success);
                    console.log('[DEBUG] result.data:', result.data);
                    console.log('[DEBUG] result.data.length:', result.data ? result.data.length : 'undefined');

                    if (result.success && result.data && result.data.length > 0) {
                        console.log('[DEBUG] ‚úÖ Condi√ß√£o OK - Renderizando √°rvore com', result.data.length, 'itens');
                        treeData = result.data;

                        // Esconde estado vazio (com verifica√ß√£o de exist√™ncia)
                        var emptyState = document.getElementById('emptyTreeState');
                        if (emptyState) {
                            emptyState.style.display = 'none';
                        }

                        console.log('[DEBUG] Chamando renderizarTreeView()...');
                        renderizarTreeView();
                        console.log('[DEBUG] Chamando atualizarContagem()...');
                        atualizarContagem();
                        console.log('[DEBUG] Chamando popularDropdownItemPai()...');
                        // ‚úÖ Popula dropdown de Item Pai ap√≥s carregar √°rvore
                        popularDropdownItemPai();
                        console.log('[DEBUG] ‚úÖ √Årvore carregada com sucesso!');
                    } else {
                        console.log('[DEBUG] ‚ùå Condi√ß√£o falhou - Mostrando estado vazio');
                        console.log('[DEBUG] Motivo: success=' + result.success + ', data=' + (result.data ? 'existe' : 'null/undefined') + ', length=' + (result.data ? result.data.length : 'N/A'));

                        // Mostra estado vazio (com verifica√ß√£o de exist√™ncia)
                        var emptyState = document.getElementById('emptyTreeState');
                        if (emptyState) {
                            emptyState.style.display = 'block';
                        }

                        var itemCount = document.getElementById('itemCount');
                        if (itemCount) {
                            itemCount.textContent = '0 itens';
                        }
                    }
                })
                .catch(erro => {
                    console.error('[DEBUG] ‚ùå ERRO no fetch:', erro);
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarArvore", erro);
                });
        } catch (erro) {
            console.error('[DEBUG] ‚ùå ERRO no try-catch:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarArvore", erro);
        }
    }

    // Renderiza TreeView com Syncfusion
    function renderizarTreeView() {
        try {
            console.log('[DEBUG renderizarTreeView] Iniciando renderiza√ß√£o...');
            console.log('[DEBUG renderizarTreeView] treeData:', treeData);
            console.log('[DEBUG renderizarTreeView] treeData.length:', treeData ? treeData.length : 'undefined');

            // ‚úÖ Destr√≥i inst√¢ncia anterior do TreeView se existir
            if (treeObj) {
                console.log('[DEBUG renderizarTreeView] Destruindo inst√¢ncia anterior do TreeView...');
                try {
                    treeObj.destroy();
                    treeObj = null;
                } catch (error) {
                    console.warn('[DEBUG renderizarTreeView] Erro ao destruir TreeView anterior:', error);
                }
            }

            var container = document.getElementById('gestaoTreeView');
            console.log('[DEBUG renderizarTreeView] Container encontrado:', container);
            container.innerHTML = '<div id="treeViewControl"></div>';

            console.log('[DEBUG renderizarTreeView] Criando nova inst√¢ncia do TreeView com', treeData.length, 'itens');

            treeObj = new ej.navigations.TreeView({
                fields: {
                    dataSource: treeData,
                    id: 'id',
                    text: 'text',
                    child: 'items'
                },
                nodeTemplate: function(data) {
                    var isGroup = !data.href || data.href === 'javascript:void(0);' || (data.items && data.items.length > 0);
                    var badge = isGroup ? 'Grupo' : 'P√°gina';
                    var badgeClass = badge === 'P√°gina' ? 'bg-info' : 'bg-warning text-dark';
                    var displayText = decodeHtml(data.text);  // ‚úÖ DECODIFICA para exibi√ß√£o
                    
                    // ‚úÖ Normaliza √≠cone para DUOTONE
                    var iconClass = data.icon || 'fa-duotone fa-folder';
                    if (iconClass && !iconClass.includes('fa-duotone')) {
                        iconClass = iconClass.replace(/fa-(regular|solid|light)/g, 'fa-duotone');
                    }
                    
                    return '<div class="tree-node" data-id="' + data.id + '">' +
                           '<i class="' + iconClass + ' icon-duotone-ftx"></i>' +
                           '<span class="node-text ' + (isGroup ? 'node-group' : '') + '">' + displayText + '</span>' +
                           '<span class="node-badge ' + badgeClass + '">' + badge + '</span>' +
                           '</div>';
                },
                allowDragAndDrop: false,  // ‚úÖ DESABILITADO - usar apenas Propriedades
                allowDropSibling: false,
                allowDropChild: false,
                allowMultiSelection: false,
                nodeClicked: function(args) {
                    try {
                        console.log('=== nodeClicked event ===', args);

                        // Verifica se h√° elemento node
                        if (!args || !args.node) {
                            console.warn('Node clicado sem elemento v√°lido:', args);
                            return;
                        }

                        // Obt√©m o ID do data-id do elemento DOM
                        var nodeElement = args.node;
                        var treeNodeDiv = nodeElement.querySelector('.tree-node');

                        if (!treeNodeDiv) {
                            console.error('Elemento .tree-node n√£o encontrado dentro do node');
                            return;
                        }

                        var nodeId = treeNodeDiv.getAttribute('data-id');
                        console.log('Node clicado - ID extra√≠do do DOM:', nodeId);

                        if (!nodeId) {
                            console.error('data-id n√£o encontrado no elemento');
                            return;
                        }

                        // Busca dados completos no treeData
                        var itemCompleto = buscarItemPorId(treeData, nodeId);
                        console.log('Item encontrado no treeData:', itemCompleto);

                        if (itemCompleto) {
                            selecionarItem(itemCompleto);
                        } else {
                            console.error('Item n√£o encontrado no treeData para ID:', nodeId);
                        }
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "renderizarTreeView.nodeClicked", error);
                    }
                },
                expandOn: 'Click'
            });

            treeObj.appendTo('#treeViewControl');
            console.log('‚úÖ TreeView renderizado com sucesso! Total de itens:', treeData.length);
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "renderizarTreeView", erro);
        }
    }

    // Seleciona item e carrega propriedades
    function selecionarItem(itemData) {
        try {
            console.log('=== INICIO selecionarItem ===');
            console.log('itemData recebido:', itemData);

            if (!itemData) {
                console.error('itemData √© null ou undefined');
                return;
            }

            selectedItem = itemData;

            // Mostra card de propriedades
            var propsCard = document.getElementById('propsCard');
            if (!propsCard) {
                console.error('Elemento propsCard n√£o encontrado!');
                return;
            }
            propsCard.style.display = 'block';
            console.log('Card de propriedades mostrado');

            // Marca visualmente
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
            var node = document.querySelector('.tree-node[data-id="' + selectedItem.id + '"]');
            if (node) {
                node.classList.add('selected');
                console.log('Node marcado visualmente');
            }

            // Preenche formulario - usa os nomes corretos das propriedades (camelCase do JSON)
            var recursoId = document.getElementById('recursoId');
            var parentId = document.getElementById('parentId');
            var txtNome = document.getElementById('txtNome');
            var txtNomeMenu = document.getElementById('txtNomeMenu');
            var txtHref = document.getElementById('txtHref');
            var txtIconClass = document.getElementById('txtIconClass');
            var txtOrdem = document.getElementById('txtOrdem');
            var txtDescricao = document.getElementById('txtDescricao');
            var chkAtivo = document.getElementById('chkAtivo');
            var selectedItemName = document.getElementById('selectedItemName');
            var modoEdicao = document.getElementById('modoEdicao');

            // ‚úÖ Preenche campos com valores DECODIFICADOS
            if (recursoId) recursoId.value = selectedItem.id || '';
            if (parentId) parentId.value = selectedItem.parentId || '';
            if (txtNome) txtNome.value = decodeHtml(selectedItem.text) || '';
            if (txtNomeMenu) txtNomeMenu.value = decodeHtml(selectedItem.nomeMenu) || '';
            if (txtHref) txtHref.value = selectedItem.href || '';
            if (txtOrdem) txtOrdem.value = selectedItem.ordem || 0;
            if (txtDescricao) txtDescricao.value = decodeHtml(selectedItem.descricao) || '';
            if (chkAtivo) chkAtivo.checked = selectedItem.ativo !== false;
            if (selectedItemName) selectedItemName.textContent = decodeHtml(selectedItem.text);

            console.log('Campos b√°sicos preenchidos (decodificados)');
            
            // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
            atualizarEstadoBotoesOrdenacao();

            // ========== ATUALIZA DROPDOWNTREE DE √çCONE ==========
            var iconClass = selectedItem.icon || 'fa-duotone fa-file';
            if (txtIconClass) txtIconClass.value = iconClass;

            var ddlIconeObj = document.getElementById('ddlIcone');
            if (ddlIconeObj && ddlIconeObj.ej2_instances && ddlIconeObj.ej2_instances[0]) {
                var ddlIcone = ddlIconeObj.ej2_instances[0];
                
                // ‚úÖ Converte fa-regular/fa-solid/fa-light para fa-duotone se necess√°rio
                var iconClassNormalizado = iconClass;
                if (iconClass) {
                    // Remove qualquer prefixo e adiciona fa-duotone
                    iconClassNormalizado = iconClass.replace(/^fa-(regular|solid|light|duotone)\s+/, 'fa-duotone ');
                    // Se n√£o tinha prefixo, adiciona fa-duotone
                    if (!iconClassNormalizado.startsWith('fa-')) {
                        iconClassNormalizado = 'fa-duotone ' + iconClassNormalizado;
                    }
                }
                
                // Limpa sele√ß√£o anterior
                ddlIcone.value = null;
                ddlIcone.dataBind();
                
                // Define novo valor ap√≥s um pequeno delay para garantir que o componente est√° pronto
                setTimeout(function() {
                    if (ddlIcone.fields && ddlIcone.fields.dataSource) {
                        var dataSource = ddlIcone.fields.dataSource;
                        var iconEncontrado = null;
                        
                        // Busca em todas as categorias
                        for (var i = 0; i < dataSource.length; i++) {
                            var cat = dataSource[i];
                            if (cat.child && cat.child.length > 0) {
                                for (var j = 0; j < cat.child.length; j++) {
                                    var icon = cat.child[j];
                                    // Compara com ID normalizado, original, ou apenas o nome do √≠cone
                                    var iconIdStr = String(icon.id || '');
                                    var iconClassStr = String(iconClassNormalizado || '');
                                    var iconClassOriginalStr = String(iconClass || '');
                                    
                                    // Extrai apenas o nome do √≠cone (ex: "fa-file" de "fa-duotone fa-file")
                                    var iconNameNormalizado = iconClassNormalizado.replace(/^fa-duotone\s+/, '');
                                    var iconNameOriginal = iconClassOriginalStr.replace(/^fa-(regular|solid|light|duotone)\s+/, '');
                                    
                                    if (iconIdStr === iconClassNormalizado || 
                                        iconIdStr === iconClassOriginalStr ||
                                        iconIdStr.endsWith(' ' + iconNameNormalizado) ||
                                        iconIdStr.endsWith(' ' + iconNameOriginal)) {
                                        iconEncontrado = icon;
                                        break;
                                    }
                                }
                            }
                            if (iconEncontrado) break;
                        }
                        
                        if (iconEncontrado) {
                            ddlIcone.value = [iconEncontrado.id];
                            ddlIcone.dataBind();
                            console.log('‚úÖ DropDownTree de √≠cone atualizado para:', iconEncontrado.id);
                        } else {
                            console.warn('√çcone n√£o encontrado no dataSource. Tentando:', iconClassNormalizado, 'ou', iconClass);
                        }
                    }
                }, 500);
            }

            // ========== ATUALIZA DROPDOWNTREE DE P√ÅGINA ==========
            // Busca pela paginaRef (URL) ao inv√©s de tentar reconstruir o ID
            var href = selectedItem.href || '';
            console.log('URL do item (href):', href);

            if (href && href.endsWith('.html')) {
                var ddlPaginaObj = document.getElementById('ddlPagina');
                if (ddlPaginaObj && ddlPaginaObj.ej2_instances && ddlPaginaObj.ej2_instances[0]) {
                    var ddlPagina = ddlPaginaObj.ej2_instances[0];

                    // Busca o item pela paginaRef no dataSource
                    var pageId = null;
                    if (ddlPagina.fields && ddlPagina.fields.dataSource) {
                        var dataSource = ddlPagina.fields.dataSource;
                        console.log('Buscando p√°gina com paginaRef:', href);

                        // Itera todas as categorias (m√≥dulos)
                        for (var i = 0; i < dataSource.length; i++) {
                            var category = dataSource[i];
                            if (category.child && category.child.length > 0) {
                                // Busca nos filhos (p√°ginas)
                                for (var j = 0; j < category.child.length; j++) {
                                    var page = category.child[j];
                                    if (page.paginaRef === href) {
                                        pageId = page.id;
                                        console.log('‚úÖ P√°gina encontrada! ID:', pageId, '| M√≥dulo:', category.text, '| P√°gina:', page.text);
                                        break;
                                    }
                                }
                            }
                            if (pageId) break;
                        }
                    }

                    if (pageId) {
                        // Limpa sele√ß√£o anterior
                        ddlPagina.value = null;
                        // Define novo valor
                        setTimeout(function() {
                            ddlPagina.value = [pageId];
                            console.log('‚úÖ DropDownTree de p√°gina atualizado para:', pageId);
                        }, 100);
                    } else {
                        console.warn('‚ö†Ô∏è P√°gina n√£o encontrada no DropDownTree para href:', href);
                    }
                }
            } else {
                console.log('URL n√£o est√° no formato esperado ou est√° vazia');
            }

            // ========== ATUALIZA DROPDOWN DE ITEM PAI ==========
            var parentId = selectedItem.parentId;
            console.log('Parent ID do item:', parentId);

            var ddlItemPaiObj = document.getElementById('ddlItemPai');
            if (ddlItemPaiObj && ddlItemPaiObj.ej2_instances && ddlItemPaiObj.ej2_instances[0]) {
                var ddlItemPai = ddlItemPaiObj.ej2_instances[0];
                if (parentId) {
                    ddlItemPai.value = parentId;
                    console.log('‚úÖ DropDownList de Item Pai atualizado para:', parentId);
                } else {
                    ddlItemPai.value = null;
                    console.log('Item n√£o tem pai (√© raiz)');
                }
            }

            // Atualiza indicador de modo
            if (modoEdicao) {
                modoEdicao.textContent = 'Editar';
                modoEdicao.className = 'badge bg-warning text-dark ms-2';
            }

            // ‚úÖ Habilita Card de Propriedades (caso esteja desabilitado)
            habilitarCardPropriedades(true);

            // ‚úÖ Carrega e mostra controle de acesso
            carregarControleAcesso(selectedItem.id);
            document.getElementById('acessoCard').style.display = 'block';

            console.log('=== FIM selecionarItem (sucesso) ===');
        } catch (error) {
            console.error('ERRO em selecionarItem:', error);
            console.error('Stack:', error.stack);
            mostrarAlerta('Erro ao selecionar item: ' + error.message, 'danger');
        }
    }

    // Busca item por ID recursivamente no treeData
    function buscarItemPorId(items, id) {
        try {
            if (!items || !id) return null;

            for (var i = 0; i < items.length; i++) {
                // Compara como string para garantir
                if (String(items[i].id) === String(id)) {
                    return items[i];
                }
                if (items[i].items && items[i].items.length > 0) {
                    var found = buscarItemPorId(items[i].items, id);
                    if (found) return found;
                }
            }
            return null;
        } catch (erro) {
            console.error('[buscarItemPorId] Erro:', erro);
            return null;
        }
    }

    // ‚úÖ Remove um item da √°rvore recursivamente
    function removerItemDaArvore(items, id) {
        try {
            if (!items || !id) return false;

            for (var i = 0; i < items.length; i++) {
                if (String(items[i].id) === String(id)) {
                    // Remove o item encontrado
                    items.splice(i, 1);
                    return true;
                }
                // Busca recursivamente nos filhos
                if (items[i].items && items[i].items.length > 0) {
                    if (removerItemDaArvore(items[i].items, id)) {
                        return true;
                    }
                }
            }
            return false;
        } catch (erro) {
            console.error('[removerItemDaArvore] Erro:', erro);
            return false;
        }
    }

    // ‚úÖ Busca item por texto (usado quando n√£o temos ID direto do DOM)
    function buscarItemPorTexto(items, texto) {
        try {
            if (!items || !texto) return null;

            for (var i = 0; i < items.length; i++) {
                var itemText = items[i].text || items[i].nomeMenu || '';
                if (itemText.trim() === texto.trim()) {
                    return items[i];
                }
                if (items[i].items && items[i].items.length > 0) {
                    var found = buscarItemPorTexto(items[i].items, texto);
                    if (found) return found;
                }
            }
            return null;
        } catch (erro) {
            console.error('[buscarItemPorTexto] Erro:', erro);
            return null;
        }
    }

    // Carrega √≠cones FontAwesome do endpoint
    function carregarIconesFontAwesome() {
        try {
            fetch('/api/Navigation/GetIconesFontAwesomeHierarquico')
                .then(r => r.json())
                .then(result => {
                    console.log('√çcones FontAwesome carregados:', result);
                    if (result.success && result.data) {
                        var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                        if (ddlIconeObj) {
                            // Configura os fields do DropDownTree
                            ddlIconeObj.fields = {
                                dataSource: result.data,
                                value: 'id',
                                text: 'text',
                                parentValue: 'parentId',
                                hasChildren: 'hasChild',
                                child: 'child'
                            };
                            ddlIconeObj.dataBind();
                            console.log('DropDownTree de √≠cones populado com', result.data.length, 'categorias');
                        }
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarIconesFontAwesome", erro);
                });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarIconesFontAwesome", erro);
        }
    }

    // ‚úÖ EVENTO SELECT: Dispara AO CLICAR no √≠cone (n√£o precisa clicar fora)
    function onIconeSelect(args) {
        try {
            console.log('=== onIconeSelect disparado (AO CLICAR) ===');
            console.log('args.nodeData:', args.nodeData);

            if (!args.nodeData || args.nodeData.isCategory) {
                console.log('Categoria clicada - n√£o atualiza campo');
                return;
            }

            // No evento SELECT, os dados v√™m em args.nodeData
            var iconClass = args.nodeData.id;      // "fa-duotone fa-bat"
            var iconLabel = args.nodeData.text;    // "Bast√£o"

            var txtIconClass = document.getElementById('txtIconClass');
            if (txtIconClass) {
                txtIconClass.value = iconClass;
                console.log('‚úÖ Classe CSS atualizada IMEDIATAMENTE:', iconClass, '| Label:', iconLabel);
            } else {
                console.error('‚ùå Elemento txtIconClass n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onIconeSelect", erro);
        }
    }

    // ‚úÖ EVENTO CHANGE: Backup para quando setado programaticamente
    function onIconeChange(args) {
        try {
            console.log('=== onIconeChange disparado ===');
            console.log('args completo:', args);
            console.log('args.itemData:', args.itemData);
            console.log('args.value:', args.value);

            // Quando setado programaticamente, itemData vem undefined
            // Preciso buscar o item no dataSource
            var itemData = args.itemData;

            if (!itemData && args.value && args.value.length > 0) {
                console.log('itemData undefined - buscando no dataSource...');
                var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
                if (ddlIconeObj && ddlIconeObj.fields && ddlIconeObj.fields.dataSource) {
                    var iconId = args.value[0];
                    console.log('Buscando iconId:', iconId);

                    itemData = findIconById(iconId);
                    if (itemData) {
                        console.log('‚úÖ √çcone encontrado no dataSource:', itemData);
                    }

                    // Se n√£o encontrou, pode ser que seja a pr√≥pria classe
                    if (!itemData) {
                        console.log('‚ùå √çcone n√£o encontrado no dataSource - usando iconId diretamente');
                        itemData = { id: iconId, text: iconId, isCategory: false };
                    }
                }
            }

            // Se n√£o h√° dados ou √© uma categoria, limpa o campo
            if (!itemData || itemData.isCategory) {
                document.getElementById('txtIconClass').value = '';
                console.log('Categoria selecionada ou campo limpo');
                return;
            }

            // Apenas √≠cones v√°lidos (n√£o categorias)
            var iconClass = itemData.id;      // "fa-duotone fa-bat"
            var iconLabel = itemData.text;    // "Bast√£o"

            // Atualiza campo de texto bloqueado com a classe CSS
            var txtIconClass = document.getElementById('txtIconClass');
            if (txtIconClass) {
                txtIconClass.value = iconClass;
                console.log('‚úÖ Classe CSS atualizada:', iconClass, '| Label:', iconLabel);
            } else {
                console.error('‚ùå Elemento txtIconClass n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onIconeChange", erro);
        }
    }

    // Carrega p√°ginas do sistema
    function carregarPaginasSistema() {
        try {
            fetch('/api/Navigation/GetPaginasHierarquico')
                .then(r => r.json())
                .then(result => {
                    console.log('P√°ginas carregadas:', result);
                    if (result.success && result.data) {
                        var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                        if (ddlPaginaObj) {
                            ddlPaginaObj.fields = {
                                dataSource: result.data,
                                value: 'id',
                                text: 'text',
                                parentValue: 'parentId',
                                hasChildren: 'hasChild',
                                child: 'child'
                            };
                            ddlPaginaObj.dataBind();
                            console.log('DropDownTree de p√°ginas populado com', result.data.length, 'm√≥dulos');
                        }
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarPaginasSistema", erro);
                });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarPaginasSistema", erro);
        }
    }

    function onPaginaDropdownCreated() {
        try {
            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
            if (ddlPaginaObj) {
                ddlPaginaObj.itemTemplate = function(data) {
                    if (data.isCategory) {
                        return '<div style="font-weight: 600; padding: 4px 0; color: #3D5771;">' + data.text + '</div>';
                    }
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="fa-duotone fa-file-lines" style="font-size: 16px; width: 20px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span>' + data.text + '</span>' +
                           '</div>';
                };

                ddlPaginaObj.valueTemplate = function(data) {
                    if (!data || data.isCategory) return '';
                    var displayText = data.displayText || data.text;
                    return '<div style="display: flex; align-items: center; gap: 8px;">' +
                           '<i class="fa-duotone fa-file-lines" style="font-size: 14px; width: 18px; --fa-primary-color: #ff6b35; --fa-secondary-color: #6c757d;"></i>' +
                           '<span>' + displayText + '</span>' +
                           '</div>';
                };

                // ‚úÖ Evento SELECTING: dispara ANTES de confirmar sele√ß√£o (mais confi√°vel)
                ddlPaginaObj.selecting = function(args) {
                    console.log('=== SELECTING p√°gina (ANTES) ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a sele√ß√£o na vari√°vel global IMEDIATAMENTE
                        ultimaPaginaSelecionada = {
                            id: args.nodeData.id,
                            paginaRef: args.nodeData.paginaRef
                        };

                        var txtHref = document.getElementById('txtHref');
                        if (txtHref && args.nodeData.paginaRef) {
                            txtHref.value = args.nodeData.paginaRef;
                            console.log('‚úÖ URL atualizada via SELECTING:', args.nodeData.paginaRef);
                        }
                    }
                };

                // ‚úÖ Evento SELECT: dispara ao selecionar item
                ddlPaginaObj.select = function(args) {
                    console.log('=== SELECT p√°gina ===', args);
                    if (args.nodeData && !args.nodeData.isCategory) {
                        // Armazena a sele√ß√£o na vari√°vel global
                        ultimaPaginaSelecionada = {
                            id: args.nodeData.id,
                            paginaRef: args.nodeData.paginaRef
                        };

                        var txtHref = document.getElementById('txtHref');
                        if (txtHref && args.nodeData.paginaRef) {
                            txtHref.value = args.nodeData.paginaRef;
                            console.log('‚úÖ URL atualizada via SELECT:', args.nodeData.paginaRef);
                        }

                        // for√ßa valor e dispara change manual para refletir na primeira escolha
                        ddlPaginaObj.value = [args.nodeData.id];
                        onPaginaChange({ itemData: args.nodeData, value: [args.nodeData.id] });
                        ddlPaginaObj.hidePopup();
                    }
                };

                // ‚úÖ Evento CHANGE: backup
                ddlPaginaObj.change = function(args) {
                    onPaginaChange(args);
                };

                // N√£o depende de blur para aplicar mudan√ßa
                ddlPaginaObj.changeOnBlur = false;

                // ‚úÖ Evento CLOSE do popup: garante atualiza√ß√£o ao fechar
                ddlPaginaObj.close = function(args) {
                    console.log('=== CLOSE p√°gina ===');

                    var paginaRef = null;
                    var pageId = null;

                    // Tenta pegar o valor atual do componente
                    var valor = ddlPaginaObj.value;
                    if (valor && valor.length > 0) {
                        pageId = valor[0];
                        console.log('Valor do componente:', pageId);

                        // Busca a paginaRef no dataSource
                        if (ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                            var dataSource = ddlPaginaObj.fields.dataSource;
                            for (var i = 0; i < dataSource.length; i++) {
                                var modulo = dataSource[i];
                                if (modulo.child && modulo.child.length > 0) {
                                    for (var j = 0; j < modulo.child.length; j++) {
                                        var page = modulo.child[j];
                                        if (page.id === pageId && page.paginaRef) {
                                            paginaRef = page.paginaRef;
                                            break;
                                        }
                                    }
                                }
                                if (paginaRef) break;
                            }
                        }
                    }

                    // Se n√£o encontrou, usa a √∫ltima sele√ß√£o armazenada
                    if (!paginaRef && ultimaPaginaSelecionada) {
                        paginaRef = ultimaPaginaSelecionada.paginaRef;
                        console.log('Usando √∫ltima p√°gina selecionada:', paginaRef);
                    }

                    // Atualiza o campo se tiver uma URL v√°lida
                    if (paginaRef) {
                        var txtHref = document.getElementById('txtHref');
                        if (txtHref) {
                            txtHref.value = paginaRef;
                            console.log('‚úÖ URL atualizada via CLOSE:', paginaRef);
                        }
                    }
                };

                console.log('DropDownTree de p√°ginas configurado');
            }
        } catch (error) {
            console.error('Erro ao configurar DropDownTree de p√°ginas:', error);
        }
    }

    // ‚úÖ EVENTO SELECT: Dispara AO CLICAR no item (n√£o precisa clicar fora)
    function onPaginaSelect(args) {
        try {
            console.log('=== onPaginaSelect disparado (AO CLICAR) ===');
            console.log('args.nodeData:', args.nodeData);

            if (!args.nodeData || args.nodeData.isCategory) {
                console.log('Categoria clicada - n√£o gera URL');
                return;
            }

            // No evento SELECT, os dados v√™m em args.nodeData
            var paginaRef = args.nodeData.paginaRef;
            console.log('paginaRef extra√≠da:', paginaRef);

            var txtHref = document.getElementById('txtHref');
            if (txtHref) {
                txtHref.value = paginaRef;
                console.log('‚úÖ URL atualizada IMEDIATAMENTE:', paginaRef);
            } else {
                console.error('‚ùå Elemento txtHref n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPaginaSelect", erro);
        }
    }

    // ‚úÖ EVENTO CHANGE: Backup para quando setado programaticamente
    function onPaginaChange(args) {
        try {
            console.log('=== onPaginaChange disparado ===');
            console.log('args completo:', args);
            console.log('args.itemData:', args.itemData);
            console.log('args.value:', args.value);

            // Quando setado programaticamente, itemData vem undefined
            // Preciso buscar o item no dataSource
            var itemData = args.itemData;

            if (!itemData && args.value && args.value.length > 0) {
                console.log('itemData undefined - buscando no dataSource...');
                var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
                if (ddlPaginaObj && ddlPaginaObj.fields && ddlPaginaObj.fields.dataSource) {
                    var pageId = args.value[0];
                    console.log('Buscando pageId:', pageId);

                    // Busca em todas as categorias
                    var dataSource = ddlPaginaObj.fields.dataSource;
                    for (var i = 0; i < dataSource.length; i++) {
                        var category = dataSource[i];
                        if (category.child && category.child.length > 0) {
                            for (var j = 0; j < category.child.length; j++) {
                                if (category.child[j].id === pageId) {
                                    itemData = category.child[j];
                                    console.log('‚úÖ Item encontrado no dataSource:', itemData);
                                    break;
                                }
                            }
                        }
                        if (itemData) break;
                    }
                }
            }

            // Se n√£o h√° dados ou √© uma categoria, n√£o faz nada
            if (!itemData || itemData.isCategory) {
                console.log('Categoria selecionada ou campo limpo - n√£o gera URL');
                return;
            }

            // Obt√©m a URL gerada (formato: modulo_pagina.html)
            var paginaRef = itemData.paginaRef;
            console.log('paginaRef extra√≠da:', paginaRef);

            var txtHref = document.getElementById('txtHref');
            if (txtHref) {
                txtHref.value = paginaRef;
                console.log('‚úÖ URL atualizada no campo txtHref:', paginaRef);
            } else {
                console.error('‚ùå Elemento txtHref n√£o encontrado!');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "onPaginaChange", erro);
        }
    }

    // Carrega lista de usuarios com acesso
    function carregarControleAcesso(recursoId) {
        try {
            if (!recursoId) {
                document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
                return;
            }

            fetch('/api/Navigation/GetUsuariosAcesso?recursoId=' + recursoId)
                .then(r => r.json())
                .then(result => {
                    console.log('Acessos carregados:', result);
                    var container = document.getElementById('listaAcessos');
                    if (result.success && result.data && result.data.length > 0) {
                        container.innerHTML = result.data.map(u =>
                            '<div class="acesso-item">' +
                            '<input type="checkbox" class="form-check-input me-2" ' +
                            'id="acesso_' + u.usuarioId + '" ' +
                            (u.acesso ? 'checked' : '') +
                            ' onchange="atualizarAcesso(\'' + u.usuarioId + '\', this.checked)" />' +
                            '<label for="acesso_' + u.usuarioId + '">' + u.nome + '</label>' +
                            '</div>'
                        ).join('');
                    } else {
                        container.innerHTML = '<p class="text-muted text-center">Nenhum usu√°rio encontrado</p>';
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarControleAcesso", erro);
                });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "carregarControleAcesso", erro);
        }
    }

    // Atualiza acesso de usuario
    function atualizarAcesso(usuarioId, acesso) {
        try {
            if (!selectedItem) return;

            fetch('/api/Navigation/UpdateAcesso', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usuarioId: usuarioId,
                    recursoId: selectedItem.id,
                    acesso: acesso
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    mostrarAlerta('Acesso atualizado!', 'success');
                } else {
                    mostrarAlerta('Erro ao atualizar acesso: ' + result.message, 'danger');
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarAcesso", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarAcesso", erro);
        }
    }

    // Salva propriedades do item
    function salvarPropriedades() {
        try {
            // ‚úÖ CODIFICA valores antes de enviar ao backend
            var dto = {
                id: document.getElementById('recursoId').value,
                text: encodeHtml(document.getElementById('txtNome').value),
                nomeMenu: encodeHtml(document.getElementById('txtNomeMenu').value),
                href: document.getElementById('txtHref').value,
                icon: document.getElementById('txtIconClass').value,
                ordem: parseFloat(document.getElementById('txtOrdem').value) || 0,
                descricao: encodeHtml(document.getElementById('txtDescricao').value),
                ativo: document.getElementById('chkAtivo').checked,
                parentId: document.getElementById('parentId').value
            };

            console.log('DTO codificado para envio:', dto);

            if (!dto.text || !dto.nomeMenu) {
                mostrarAlerta('Preencha Nome e NomeMenu!', 'warning');
                return;
            }

            var ehNovoItem = !dto.id;  // Se n√£o tem ID, √© novo item

            fetch('/api/Navigation/SaveRecurso', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dto)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    mostrarAlerta(result.message, 'success');

                    // ‚úÖ Atualiza √°rvore ap√≥s pequeno delay para garantir que backend processou
                    setTimeout(function() {
                        carregarArvore();
                    }, 300);

                    // ‚úÖ Atualiza navega√ß√£o lateral ap√≥s salvar
                    atualizarNavegacaoLateral();

                    var recursoId = result.id || dto.id;

                    // ‚úÖ APENAS para NOVO ITEM: habilita acesso e pergunta sobre gerenciamento
                    if (ehNovoItem && recursoId) {
                        // Habilita acesso para todos usu√°rios automaticamente
                        habilitarAcessoTodosUsuarios(recursoId);

                        // Pergunta se deseja fazer controle de acesso
                        Alerta.Confirmar(
                            'Gerenciar Controle de Acesso',
                            'Deseja gerenciar o controle de acesso deste item agora?',
                            'Sim',
                            'N√£o'
                        ).then(function(result) {
                            if (result) {
                                // Atualiza selectedItem com o ID retornado
                                selectedItem = {
                                    id: recursoId,
                                    text: dto.text,
                                    nomeMenu: dto.nomeMenu,
                                    href: dto.href,
                                    icon: dto.icon,
                                    ordem: dto.ordem,
                                    descricao: dto.descricao,
                                    ativo: dto.ativo,
                                    parentId: dto.parentId
                                };
                                document.getElementById('recursoId').value = recursoId;

                                // Desabilita Card de Propriedades
                                habilitarCardPropriedades(false);

                                // Carrega controle de acesso
                                carregarControleAcesso(recursoId);

                                // Mostra Card de Controle de Acesso
                                document.getElementById('acessoCard').style.display = 'block';
                            } else {
                                // N√£o quer gerenciar acesso, fecha os cards
                                document.getElementById('propsCard').style.display = 'none';
                                document.getElementById('acessoCard').style.display = 'none';
                                habilitarCardPropriedades(true);
                            }
                        });
                    } else {
                        // ‚úÖ EDI√á√ÉO de item existente: apenas fecha card de propriedades
                        document.getElementById('propsCard').style.display = 'none';
                        habilitarCardPropriedades(true);
                    }
                } else {
                    mostrarAlerta('Erro: ' + result.message, 'danger');
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarPropriedades", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarPropriedades", erro);
        }
    }

    // Adiciona novo item
    function adicionarNovoItem() {
        try {
            // Limpa formulario mas mant√©m card vis√≠vel
            limparFormulario(false);  // false = N√ÉO esconde o card

            // ‚úÖ Habilita Card de Propriedades
            habilitarCardPropriedades(true);

            // Mostra card de propriedades
            document.getElementById('propsCard').style.display = 'block';

            // ‚úÖ Garante que Card de Controle de Acesso est√° escondido ao criar novo item
            document.getElementById('acessoCard').style.display = 'none';

            document.getElementById('txtNome').focus();
            document.getElementById('selectedItemName').textContent = 'Novo Item';

            // Atualiza indicador de modo para "Criar"
            document.getElementById('modoEdicao').textContent = 'Criar';
            document.getElementById('modoEdicao').className = 'badge bg-success ms-2';
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "adicionarNovoItem", erro);
        }
    }

    // Exclui item selecionado
    function excluirItem() {
        try {
            if (!selectedItem || !selectedItem.id) {
                mostrarAlerta('Selecione um item para excluir!', 'warning');
                return;
            }

            Alerta.Confirmar(
                'Confirmar Exclus√£o',
                'Tem certeza que deseja excluir "' + decodeHtml(selectedItem.text) + '"?',
                'Excluir',
                'Cancelar'
            ).then(function(result) {
                if (!result) return;

                fetch('/api/Navigation/DeleteRecurso', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recursoId: selectedItem.id })
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');
                        limparFormulario();
                        carregarArvore();
                    } else {
                        mostrarAlerta('Erro: ' + result.message, 'danger');
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "excluirItem", erro);
                });
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "excluirItem", erro);
        }
    }

    // Limpa formulario
    // ‚úÖ Valida se campos obrigat√≥rios est√£o preenchidos
    function validarCamposObrigatorios() {
        var nome = document.getElementById('txtNome').value.trim();
        var nomeMenu = document.getElementById('txtNomeMenu').value.trim();
        var pagina = document.getElementById('ddlPagina')?.ej2_instances?.[0]?.value;
        var icone = document.getElementById('ddlIcone')?.ej2_instances?.[0]?.value;
        
        return nome && nomeMenu && pagina && pagina.length > 0 && icone && icone.length > 0;
    }

    // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
    function atualizarEstadoBotoesOrdenacao() {
        try {
            var btnUp = document.getElementById('btnOrderUp');
            var btnDown = document.getElementById('btnOrderDown');
            
            if (!btnUp || !btnDown) return;
            
            var ehNovoItem = !selectedItem || !selectedItem.id;
            var camposValidos = validarCamposObrigatorios();
            
            // Para itens novos, s√≥ habilita se campos obrigat√≥rios estiverem preenchidos
            if (ehNovoItem) {
                var habilitado = camposValidos;
                btnUp.disabled = !habilitado;
                btnDown.disabled = !habilitado;
                
                // Atualiza tooltip se desabilitado
                if (!habilitado) {
                    var tooltipText = 'Preencha os campos obrigat√≥rios: Nome, NomeMenu, P√°gina do Sistema e √çcone';
                    btnUp.setAttribute('data-bs-original-title', tooltipText);
                    btnDown.setAttribute('data-bs-original-title', tooltipText);
                    // Reinicializa tooltip
                    var tooltipUp = bootstrap.Tooltip.getInstance(btnUp);
                    var tooltipDown = bootstrap.Tooltip.getInstance(btnDown);
                    if (tooltipUp) tooltipUp.setContent({ '.tooltip-inner': tooltipText });
                    if (tooltipDown) tooltipDown.setContent({ '.tooltip-inner': tooltipText });
                } else {
                    btnUp.setAttribute('data-bs-original-title', 'Mover item para cima');
                    btnDown.setAttribute('data-bs-original-title', 'Mover item para baixo');
                    var tooltipUp = bootstrap.Tooltip.getInstance(btnUp);
                    var tooltipDown = bootstrap.Tooltip.getInstance(btnDown);
                    if (tooltipUp) tooltipUp.setContent({ '.tooltip-inner': 'Mover item para cima' });
                    if (tooltipDown) tooltipDown.setContent({ '.tooltip-inner': 'Mover item para baixo' });
                }
            } else {
                // Para itens existentes, verifica se pode mover
                var podeMoverCima = podeMoverParaCima();
                var podeMoverBaixo = podeMoverParaBaixo();
                
                btnUp.disabled = !podeMoverCima;
                btnDown.disabled = !podeMoverBaixo;
            }
        } catch (erro) {
            console.error('[atualizarEstadoBotoesOrdenacao] Erro:', erro);
        }
    }

    // ‚úÖ Verifica se pode mover para cima
    function podeMoverParaCima() {
        if (!selectedItem || !selectedItem.id || !treeData) return false;
        
        var item = buscarItemPorId(treeData, selectedItem.id);
        if (!item) return false;
        
        // Encontra a lista que cont√©m o item e seu √≠ndice
        var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
        if (!resultado) return false;
        
        return resultado.indice > 0; // Pode mover se n√£o √© o primeiro
    }

    // ‚úÖ Verifica se pode mover para baixo
    function podeMoverParaBaixo() {
        if (!selectedItem || !selectedItem.id || !treeData) return false;
        
        var item = buscarItemPorId(treeData, selectedItem.id);
        if (!item) return false;
        
        // Encontra a lista que cont√©m o item e seu √≠ndice
        var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
        if (!resultado) return false;
        
        return resultado.indice < resultado.lista.length - 1; // Pode mover se n√£o √© o √∫ltimo
    }

    // ‚úÖ Busca a lista pai que cont√©m um item e retorna refer√™ncia √† lista e √≠ndice
    function encontrarListaPaiEIndice(lista, targetId, targetParentId) {
        for (var i = 0; i < lista.length; i++) {
            var currentItem = lista[i];
            var currentParentId = currentItem.parentId || null;
            
            // Verifica se este item √© o alvo
            if (String(currentItem.id) === String(targetId)) {
                return { lista: lista, indice: i };
            }
            
            // Busca recursivamente nos filhos
            if (currentItem.items && currentItem.items.length > 0) {
                var resultado = encontrarListaPaiEIndice(currentItem.items, targetId, targetParentId);
                if (resultado) return resultado;
            }
        }
        return null;
    }


    // ‚úÖ Move item para cima (move grupo inteiro se for grupo)
    function moverItemParaCima() {
        try {
            if (!selectedItem || !selectedItem.id) {
                mostrarAlerta('Selecione um item primeiro', 'warning');
                return;
            }
            
            var item = buscarItemPorId(treeData, selectedItem.id);
            if (!item) {
                mostrarAlerta('Item n√£o encontrado na √°rvore', 'danger');
                return;
            }
            
            // Encontra a lista que cont√©m o item e seu √≠ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice <= 0) {
                mostrarAlerta('Item j√° est√° na primeira posi√ß√£o', 'info');
                return;
            }
            
            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;
            
            // ‚úÖ Troca posi√ß√£o com o item anterior (modifica refer√™ncia original)
            var temp = listaIrmaos[indexAtual];
            listaIrmaos[indexAtual] = listaIrmaos[indexAtual - 1];
            listaIrmaos[indexAtual - 1] = temp;
            
            console.log('[MOVER-CIMA] ‚úÖ Posi√ß√µes trocadas na lista original');
            console.log('[MOVER-CIMA] Lista ap√≥s troca:', listaIrmaos.map(function(i) { return i.text; }));
            
            // ‚úÖ Recria treeData para for√ßar atualiza√ß√£o do TreeView
            var treeDataNovo = JSON.parse(JSON.stringify(treeData));
            treeData = treeDataNovo;
            
            // ‚úÖ Atualiza TreeView com nova estrutura
            treeObj.fields.dataSource = treeData;
            treeObj.dataBind();
            
            console.log('[MOVER-CIMA] ‚úÖ TreeView atualizado');
            
            // Seleciona o item novamente ap√≥s mover
            setTimeout(function() {
                var itemAtualizado = buscarItemPorId(treeData, item.id);
                if (itemAtualizado) {
                    selecionarItem(itemAtualizado);
                }
                salvarOrdenacaoAutomatica();
            }, 300);
            
        } catch (erro) {
            console.error('[moverItemParaCima] Erro:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemParaCima", erro);
        }
    }

    // ‚úÖ Move item para baixo (move grupo inteiro se for grupo)
    function moverItemParaBaixo() {
        try {
            if (!selectedItem || !selectedItem.id) {
                mostrarAlerta('Selecione um item primeiro', 'warning');
                return;
            }
            
            var item = buscarItemPorId(treeData, selectedItem.id);
            if (!item) {
                mostrarAlerta('Item n√£o encontrado na √°rvore', 'danger');
                return;
            }
            
            // Encontra a lista que cont√©m o item e seu √≠ndice
            var resultado = encontrarListaPaiEIndice(treeData, item.id, item.parentId);
            if (!resultado || resultado.indice >= resultado.lista.length - 1) {
                mostrarAlerta('Item j√° est√° na √∫ltima posi√ß√£o', 'info');
                return;
            }
            
            var listaIrmaos = resultado.lista;
            var indexAtual = resultado.indice;
            
            console.log('[MOVER-BAIXO] Lista encontrada:', listaIrmaos.length, 'itens');
            console.log('[MOVER-BAIXO] √çndice atual:', indexAtual);
            console.log('[MOVER-BAIXO] Item atual:', item.text);
            console.log('[MOVER-BAIXO] Item seguinte:', listaIrmaos[indexAtual + 1].text);
            
            // Troca posi√ß√£o com o item seguinte (move grupo inteiro se for grupo)
            var temp = listaIrmaos[indexAtual];
            listaIrmaos[indexAtual] = listaIrmaos[indexAtual + 1];
            listaIrmaos[indexAtual + 1] = temp;
            
            console.log('[MOVER-BAIXO] ‚úÖ Posi√ß√µes trocadas na lista');
            
            // ‚úÖ Recria treeData completamente para for√ßar atualiza√ß√£o do TreeView
            var treeDataNovo = JSON.parse(JSON.stringify(treeData));
            treeData = treeDataNovo;
            
            // Atualiza TreeView com nova estrutura
            treeObj.fields.dataSource = treeData;
            treeObj.dataBind();
            
            console.log('[MOVER-BAIXO] ‚úÖ TreeView atualizado');
            
            // Seleciona o item novamente ap√≥s mover
            setTimeout(function() {
                var itemAtualizado = buscarItemPorId(treeData, item.id);
                if (itemAtualizado) {
                    selecionarItem(itemAtualizado);
                }
                salvarOrdenacaoAutomatica();
            }, 300);
            
        } catch (erro) {
            console.error('[moverItemParaBaixo] Erro:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "moverItemParaBaixo", erro);
        }
    }

    function limparFormulario(esconderCard = true) {
        try {
            selectedItem = null;

            // ‚úÖ Reseta vari√°veis de rastreamento
            ultimoIconeSelecionado = null;
            ultimaPaginaSelecionada = null;

            document.getElementById('formPropriedades').reset();
            document.getElementById('recursoId').value = '';
            document.getElementById('parentId').value = '';
            document.getElementById('txtIconClass').value = '';
            document.getElementById('selectedItemName').textContent = 'Nenhum item selecionado';

            // Limpa DropDownTree de √≠cones
            var ddlIconeObj = document.getElementById('ddlIcone').ej2_instances[0];
            if (ddlIconeObj) {
                ddlIconeObj.value = [];
                ddlIconeObj.text = '';
                ddlIconeObj.refresh();
            }

            // Limpa DropDownTree de p√°ginas
            var ddlPaginaObj = document.getElementById('ddlPagina').ej2_instances[0];
            if (ddlPaginaObj) {
                ddlPaginaObj.value = null;
            }

            // Limpa DropDownList de Item Pai
            var ddlItemPaiObj = document.getElementById('ddlItemPai').ej2_instances[0];
            if (ddlItemPaiObj) {
                ddlItemPaiObj.value = null;
            }

            document.getElementById('listaAcessos').innerHTML = '<p class="text-muted text-center">Selecione um item para gerenciar acessos</p>';
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));

        // Reseta indicador de modo
        document.getElementById('modoEdicao').textContent = 'Selecione';
        document.getElementById('modoEdicao').className = 'badge bg-secondary ms-2';

        // ‚úÖ Atualiza estado dos bot√µes de ordena√ß√£o
        atualizarEstadoBotoesOrdenacao();
        
        // Esconde card apenas se solicitado
        if (esconderCard) {
            document.getElementById('propsCard').style.display = 'none';
        }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "limparFormulario", erro);
        }
    }

    /*
    // ‚ùå DEPRECATED: Salvamento agora √© autom√°tico - fun√ß√£o mantida apenas como backup
    function salvarOrdenacao() {
        try {
            if (!treeObj) return;
            var dataSource = treeObj.getTreeData();
            var items = extrairItensDoTreeView(dataSource, null, 0);
            fetch('/api/Navigation/SaveTreeToDb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(items)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    mostrarAlerta('Ordena√ß√£o salva com sucesso!', 'success');
                    carregarArvore();
                    atualizarNavegacaoLateral();
                } else {
                    mostrarAlerta('Erro: ' + result.message, 'danger');
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacao", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacao", erro);
        }
    }
    */

    // ‚úÖ AUTO-SAVE: Salva ordena√ß√£o automaticamente ap√≥s drag-drop
    function salvarOrdenacaoAutomatica() {
        try {
            if (!treeObj) {
                console.error('[AUTO-SAVE] treeObj n√£o existe!');
                return;
            }

            // Pega o dataSource atualizado do TreeView
            var dataSource = treeObj.getTreeData();
            console.log('[AUTO-SAVE] DataSource obtido:', dataSource);

            var items = extrairItensDoTreeView(dataSource, null, 0);
            console.log('[AUTO-SAVE] Items extra√≠dos para salvar:', items);
            console.log('[AUTO-SAVE] Total de items:', items.length);

            if (items.length === 0) {
                console.warn('[AUTO-SAVE] Nenhum item para salvar!');
                return;
            }

            console.log('[AUTO-SAVE] Enviando para backend...');

            var jsonPayload = JSON.stringify(items);
            console.log('[AUTO-SAVE] JSON Payload (primeiros 500 chars):', jsonPayload.substring(0, 500));

            fetch('/api/Navigation/SaveTreeToDb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: jsonPayload
            })
            .then(r => {
                console.log('[AUTO-SAVE] Response status:', r.status);
                // Se n√£o for 2xx, ainda precisamos ler o body para ver o erro
                return r.json().then(data => ({ ok: r.ok, status: r.status, data: data }));
            })
            .then(response => {
                console.log('[AUTO-SAVE] Response do backend:', response.data);

                if (!response.ok) {
                    // Erro HTTP - mostra detalhes do erro de valida√ß√£o
                    console.error('[AUTO-SAVE] ‚ùå HTTP Error:', response.status);

                    if (response.data.errors) {
                        console.error('[AUTO-SAVE] ‚ùå Erros de Valida√ß√£o:', JSON.stringify(response.data.errors, null, 2));
                        var erroMsg = 'Erro de valida√ß√£o: ';
                        for (var campo in response.data.errors) {
                            erroMsg += campo + ': ' + response.data.errors[campo].join(', ') + '; ';
                        }
                        mostrarAlerta(erroMsg, 'danger');
                    } else {
                        mostrarAlerta('Erro HTTP ' + response.status + ': ' + (response.data.message || response.data.title || 'Erro desconhecido'), 'danger');
                    }
                    return;
                }

                if (response.data.success) {
                    console.log('[AUTO-SAVE] ‚úÖ Ordena√ß√£o salva automaticamente!');
                    // Toast discreto ao inv√©s de alerta grande
                    var msg = 'Ordena√ß√£o salva automaticamente';
                    if (lastDragInfo && lastDragInfo.itemName) {
                        msg = "Item '" + lastDragInfo.itemName + "' movido de '" +
                            (lastDragInfo.fromParentName || 'Sem grupo') + "' para '" +
                            (lastDragInfo.toParentName || 'Sem grupo') + "'";
                    }
                    mostrarToastSucesso(msg);

                    // ‚úÖ Recarrega √°rvore com dados atualizados do banco
                    carregarArvore();

                    // ‚úÖ Atualiza menu lateral
                    atualizarNavegacaoLateral();
                } else {
                    console.error('[AUTO-SAVE] ‚ùå Erro no backend:', response.data.message);
                    mostrarAlerta('Erro ao salvar ordena√ß√£o: ' + response.data.message, 'danger');
                }
            })
            .catch(erro => {
                console.error('[AUTO-SAVE] ‚ùå Erro no fetch:', erro);
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacaoAutomatica", erro);
            });
        } catch (erro) {
            console.error('[AUTO-SAVE] ‚ùå Erro no try-catch:', erro);
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "salvarOrdenacaoAutomatica", erro);
        }
    }

    // ‚úÖ Atualiza a navega√ß√£o lateral (menu do sistema)
    function atualizarNavegacaoLateral() {
        try {
            console.log('[NAV-UPDATE] Atualizando navega√ß√£o lateral...');

            // ‚úÖ SOLU√á√ÉO SIMPLES E EFICAZ: Recarrega a p√°gina inteira ap√≥s 1 segundo
            // Isso garante que o menu lateral seja atualizado com os dados mais recentes do banco
            setTimeout(function() {
                console.log('[NAV-UPDATE] Recarregando p√°gina para atualizar navega√ß√£o...');
                window.location.reload();
            }, 1000);
        } catch (erro) {
            console.error('[NAV-UPDATE] Erro:', erro);
        }
    }

    // Helper: Toast discreto para auto-save
    function mostrarToastSucesso(mensagem) {
        try {
            if (window.AppToast && typeof window.AppToast.show === 'function') {
                // Converte entidades HTML para texto vis√≠vel no toast
                var msgDecodificada = decodeHtml(mensagem);
                window.AppToast.show('Verde', msgDecodificada, 4000);
            } else if (typeof showSyncfusionToast === 'function') {
                showSyncfusionToast(decodeHtml(mensagem), 'success', '‚úÖ');
            } else if (typeof Alerta !== 'undefined' && Alerta.Toast) {
                Alerta.Toast('success', decodeHtml(mensagem));
            } else {
                console.log('[TOAST]', mensagem);
            }
        } catch (erro) {
            console.log('[TOAST]', mensagem);
        }
    }

    // Extrai itens do TreeView para salvar
    function extrairItensDoTreeView(items, parentId, nivel) {
        try {
            if (!items) return [];

            var result = [];

            items.forEach(function(item, index) {
                var newItem = {
                    id: item.id,
                    text: item.text,
                    nomeMenu: item.nomeMenu,
                    icon: item.icon,
                    href: item.href,
                    parentId: parentId,
                    ordem: (nivel * 100) + index + 1,
                    nivel: nivel,
                    ativo: item.ativo !== false,
                    descricao: item.descricao,
                    items: []
                };

                if (item.items && item.items.length > 0) {
                    newItem.items = extrairItensDoTreeView(item.items, item.id, nivel + 1);
                }

                result.push(newItem);
            });

            return result;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "extrairItensDoTreeView", erro);
            return [];
        }
    }

    // Atualiza contagem de itens
    function atualizarContagem() {
        try {
            var total = contarItens(treeData);
            document.getElementById('itemCount').textContent = total + ' itens';
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "atualizarContagem", erro);
        }
    }

    function contarItens(items) {
        try {
            if (!items) return 0;
            var count = items.length;
            items.forEach(function(item) {
                if (item.items && item.items.length > 0) {
                    count += contarItens(item.items);
                }
            });
            return count;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "contarItens", erro);
            return 0;
        }
    }

    // Migra dados do JSON
    function migrarDadosJson() {
        try {
            Alerta.Confirmar(
                'Confirmar Migra√ß√£o',
                'Isso ir√° migrar os dados do nav.json para o banco de dados. Continuar?',
                'Migrar',
                'Cancelar'
            ).then(function(result) {
                if (!result) return;

                mostrarAlerta('Migrando dados...', 'info');

                fetch('/api/Navigation/MigrateFromJson', {
                    method: 'POST'
                })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');
                        carregarArvore();
                    } else {
                        mostrarAlerta('Erro: ' + result.message, 'danger');
                    }
                })
                .catch(erro => {
                    Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "migrarDadosJson", erro);
                });
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "migrarDadosJson", erro);
        }
    }

    // Seleciona todos os acessos
    function selecionarTodosAcessos() {
        try {
            document.querySelectorAll('#listaAcessos input[type="checkbox"]').forEach(function(cb) {
                if (!cb.checked) {
                    cb.checked = true;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "selecionarTodosAcessos", erro);
        }
    }

    // Verifica se h√° mudan√ßas n√£o salvas no formul√°rio
    function verificarMudancasNaoSalvas() {
        try {
            if (!selectedItem) return false;

            // Pega valores atuais do formul√°rio
            var txtNome = document.getElementById('txtNome').value;
            var txtNomeMenu = document.getElementById('txtNomeMenu').value;
            var txtHref = document.getElementById('txtHref').value;
            var txtIconClass = document.getElementById('txtIconClass').value;
            var txtOrdem = parseFloat(document.getElementById('txtOrdem').value) || 0;
            var txtDescricao = document.getElementById('txtDescricao').value;
            var chkAtivo = document.getElementById('chkAtivo').checked;
            var parentId = document.getElementById('parentId').value;

            // Compara com valores originais do selectedItem (decodificados)
            var nomeOriginal = decodeHtml(selectedItem.text) || '';
            var nomeMenuOriginal = decodeHtml(selectedItem.nomeMenu) || '';
            var hrefOriginal = selectedItem.href || '';
            var iconOriginal = selectedItem.icon || '';
            var ordemOriginal = selectedItem.ordem || 0;
            var descricaoOriginal = decodeHtml(selectedItem.descricao) || '';
            var ativoOriginal = selectedItem.ativo !== false;
            var parentIdOriginal = selectedItem.parentId || '';

            // Retorna true se houver alguma diferen√ßa
            return txtNome !== nomeOriginal ||
                   txtNomeMenu !== nomeMenuOriginal ||
                   txtHref !== hrefOriginal ||
                   txtIconClass !== iconOriginal ||
                   txtOrdem !== ordemOriginal ||
                   txtDescricao !== descricaoOriginal ||
                   chkAtivo !== ativoOriginal ||
                   parentId !== parentIdOriginal;
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "verificarMudancasNaoSalvas", erro);
            return false;
        }
    }

    // Fecha ambos os cards (Propriedades e Controle de Acesso)
    function fecharCards() {
        try {
            // Verifica se est√° em modo edi√ß√£o (tem selectedItem com ID)
            var emModoEdicao = selectedItem && selectedItem.id;

            // Se estiver em modo edi√ß√£o e houver mudan√ßas n√£o salvas
            if (emModoEdicao && verificarMudancasNaoSalvas()) {
                Alerta.Confirmar(
                    'Mudan√ßas N√£o Salvas',
                    'Voc√™ tem mudan√ßas n√£o salvas. Deseja salvar antes de fechar?',
                    'Salvar',
                    'Descartar'
                ).then(function(result) {
                    if (result) {
                        // Usu√°rio escolheu SALVAR
                        salvarPropriedades();
                        // N√£o fecha os cards aqui, salvarPropriedades j√° gerencia isso
                    } else {
                        // Usu√°rio escolheu DESCARTAR - fecha os cards
                        document.getElementById('propsCard').style.display = 'none';
                        document.getElementById('acessoCard').style.display = 'none';
                        habilitarCardPropriedades(true);
                        limparFormulario(true);
                    }
                });
                return;
            }

            // Fecha os cards normalmente
            document.getElementById('propsCard').style.display = 'none';
            document.getElementById('acessoCard').style.display = 'none';
            habilitarCardPropriedades(true);
            limparFormulario(true);
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "fecharCards", erro);
        }
    }

    // Habilita ou desabilita todos os campos do Card de Propriedades
    function habilitarCardPropriedades(habilitar) {
        try {
            var campos = document.querySelectorAll('#formPropriedades input, #formPropriedades textarea, #formPropriedades select, #formPropriedades button');
            campos.forEach(function(campo) {
                if (habilitar) {
                    campo.removeAttribute('disabled');
                    campo.style.opacity = '1';
                    campo.style.cursor = 'auto';
                } else {
                    campo.setAttribute('disabled', 'disabled');
                    campo.style.opacity = '0.6';
                    campo.style.cursor = 'not-allowed';
                }
            });

            // Mant√©m o bot√£o Salvar Propriedades desabilitado quando est√° no modo de controle de acesso
            var btnSalvar = document.querySelector('#formPropriedades button[onclick*="salvarPropriedades"]');
            if (btnSalvar && !habilitar) {
                btnSalvar.setAttribute('disabled', 'disabled');
            }
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarCardPropriedades", erro);
        }
    }

    // Habilita acesso para todos os usu√°rios (chamado ao criar novo item)
    function habilitarAcessoTodosUsuarios(recursoId) {
        try {
            fetch('/api/Navigation/HabilitarAcessoTodosUsuarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recursoId: recursoId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    console.log('Acessos habilitados para todos os usu√°rios');
                    carregarControleAcesso(recursoId);
                } else {
                    console.error('Erro ao habilitar acessos:', result.message);
                }
            })
            .catch(erro => {
                Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarAcessoTodosUsuarios", erro);
            });
        } catch (erro) {
            Alerta.TratamentoErroComLinha("GestaoRecursosNavegacao.cshtml", "habilitarAcessoTodosUsuarios", erro);
        }
    }

    // Mostra alerta toast
    // Fun√ß√£o wrapper para mostrar alertas usando SweetAlert
    function mostrarAlerta(mensagem, tipo) {
        try {
            // Mapeia tipos Bootstrap para fun√ß√µes SweetAlert
            switch(tipo) {
                case 'success':
                    return Alerta.Sucesso('Sucesso', mensagem);
                case 'danger':
                case 'error':
                    return Alerta.Erro('Erro', mensagem);
                case 'warning':
                    return Alerta.Warning('Aten√ß√£o', mensagem);
                case 'info':
                    return Alerta.Info('Informa√ß√£o', mensagem);
                default:
                    return Alerta.Info('Aviso', mensagem);
            }
        } catch (erro) {
            // Fallback para console se SweetAlert falhar
            console.error('[mostrarAlerta] Erro ao exibir alerta:', erro);
            console.log(`[${tipo}] ${mensagem}`);
        }
    }
</script>
}
