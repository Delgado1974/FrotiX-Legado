@page
@model FrotiX.Pages.Administracao.GerenciadorNavegacaoModel

@{
    ViewData["Title"] = "Gerenciador de Navegação";
    ViewData["PageName"] = "administracao_gerenciadornavegacao";
    ViewData["Heading"] = "<i class='fa-duotone fa-sitemap'></i> Administração: <span class='fw-300'>Gerenciador de Navegação</span>";
    ViewData["Category1"] = "Administração";
    ViewData["PageIcon"] = "fa-duotone fa-sitemap";
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADRÃO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        /* Ícone do header: cores definidas no frotix.css global */
        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .ftx-card-header .header-actions {
            display: flex;
            gap: 0.5rem;
            position: relative;
            z-index: 1;
        }

        /* ====== PANEL CONTENT ====== */
        .panel-content {
            padding: 1.25rem;
            background: #f8f9fa;
        }

        /* ====== TREE VIEW CONTAINER ====== */
        .nav-tree-container {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            min-height: 400px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        /* ====== TREE NODE CUSTOMIZADO ====== */
        .e-treeview .e-list-item {
            padding: 4px 0;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            width: 100%;
        }

        .tree-node-content:hover {
            background: #f0f4f8;
        }

        .nav-item-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3D5771, #2d4559);
            border-radius: 6px;
            color: #fff;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .nav-item-text {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .nav-item-href {
            font-size: 0.75rem;
            color: #6c757d;
            margin-left: 0.5rem;
        }

        .tree-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tree-node-content:hover .tree-actions {
            opacity: 1;
        }

        .tree-actions .btn {
            width: 26px;
            height: 26px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        /* ====== MODAL HEADER AZUL ====== */
        .modal-header-azul {
            background: linear-gradient(180deg, #3D5771 0%, #2d4559 100%);
            border-bottom: none;
            padding: 1rem 1.5rem;
        }

        .modal-header-azul .modal-title {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 700 !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header-azul .modal-title i {
            color: #fff !important;
        }

        /* ====== GRID DE ÍCONES ====== */
        .icon-results-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .icon-result-item {
            cursor: pointer;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            transition: all 0.2s ease;
            background: #fff;
        }

        .icon-result-item:hover {
            border-color: #3D5771;
            background: #f0f4f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .icon-result-item.selected {
            border-color: #3D5771;
            background: #e8f0f5;
            box-shadow: 0 0 0 2px rgba(61, 87, 113, 0.3);
        }

        .icon-result-item i {
            font-size: 1.5rem;
            color: #3D5771;
            margin-bottom: 0.25rem;
            display: block;
        }

        .icon-result-item .icon-name {
            font-size: 0.65rem;
            color: #6c757d;
            word-break: break-word;
        }

        /* ====== SELETOR DE ESTILO ====== */
        .style-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .style-selector .btn-check:checked + .btn {
            background: #3D5771;
            color: #fff;
            border-color: #3D5771;
        }

        /* ====== PREVIEW DE ÍCONE ====== */
        .icon-preview-box {
            width: 50px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border: 1px solid #ced4da;
            border-right: none;
            border-radius: 0.375rem 0 0 0.375rem;
            font-size: 1.2rem;
            color: #3D5771;
        }

        /* ====== LOADING ====== */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 8px;
        }

        /* ====== ALTERAÇÕES PENDENTES ====== */
        .has-changes .btn-salvar {
            animation: pulse-green 1.5s infinite;
        }

        @@keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }

        /* ====== ALERTA INFO ====== */
        .alert-instrucoes {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e8ed 100%);
            border: 1px solid #b8d4e3;
            border-radius: 8px;
        }

        .alert-instrucoes i {
            color: #3D5771;
        }

        /* ====== RESPONSIVO ====== */
        @@media (max-width: 768px) {
            .ftx-card-header {
                flex-direction: column;
                text-align: center;
            }

            .ftx-card-header .titulo-paginas {
                font-size: 1.2rem;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .tree-actions {
                opacity: 1;
            }
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">

                <!-- HEADER AZUL PADRÃO FROTIX -->
                <div class="ftx-card-header">
                    <h2 class="titulo-paginas">
                        <i class="fa-duotone fa-sitemap"></i>
                        Gerenciador de Navegação do Sistema
                    </h2>
                    <div class="header-actions">
                        <button type="button" id="btnExpandir" class="btn btn-light" data-ejtip="Expandir todos">
                            <i class="fa-duotone fa-arrows-maximize"></i>
                        </button>
                        <button type="button" id="btnRecolher" class="btn btn-light" data-ejtip="Recolher todos">
                            <i class="fa-duotone fa-arrows-minimize"></i>
                        </button>
                        <button type="button" id="btnAddRoot" class="btn btn-fundo-laranja">
                            <i class="fa-duotone fa-plus icon-space icon-pulse"></i> Adicionar Item
                        </button>
                        <button type="button" id="btnSave" class="btn btn-verde btn-salvar">
                            <i class="fa-duotone fa-save icon-space"></i> Salvar Alterações
                        </button>
                    </div>
                </div>

                <!-- CONTEÚDO -->
                <div class="panel-content">

                    <!-- INSTRUÇÕES -->
                    <div class="alert alert-instrucoes mb-3">
                        <i class="fa-duotone fa-info-circle me-2"></i>
                        <strong>Instruções:</strong> Arraste itens para reorganizar a estrutura do menu.
                        Clique nos botões à direita de cada item para editar, adicionar subitem ou excluir.
                    </div>

                    <!-- TREEVIEW CONTAINER -->
                    <div class="nav-tree-container position-relative" id="treeContainer">
                        <div id="treeNav"></div>
                        <div class="loading-overlay" id="loadingOverlay">
                            <div class="text-center">
                                <i class="fa-duotone fa-spinner fa-spin fa-2x text-primary mb-2"></i>
                                <p class="text-muted mb-0">Carregando navegação...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ADICIONAR/EDITAR ITEM -->
<div class="modal fade" id="modalItem" tabindex="-1" aria-labelledby="modalItemTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h3 class="modal-title" id="modalItemTitle">
                    <i class="fa-duotone fa-plus-circle"></i>
                    <span id="modalItemTitleText">Adicionar Item</span>
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="frmItem">
                    <input type="hidden" id="txtItemId" />
                    <input type="hidden" id="txtOldNomeMenu" />
                    <input type="hidden" id="txtParentId" />

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Título (exibido no menu) <span class="text-danger">*</span></label>
                            <input type="text" id="txtTitle" class="form-control" required placeholder="Ex: Gestão de Veículos" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Nome Menu (identificador único) <span class="text-danger">*</span></label>
                            <input type="text" id="txtNomeMenu" class="form-control" required placeholder="Ex: Gestão de Veículos" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">URL (href)</label>
                            <input type="text" id="txtHref" class="form-control" placeholder="Ex: veiculo_index.html (deixe vazio para submenu)" />
                            <small class="text-muted">Formato: pagina_acao.html - Deixe vazio se for um item pai com subitens.</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Item Pai</label>
                            <select id="selParent" class="form-select">
                                <option value="">-- Raiz (Nível Principal) --</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Ícone FontAwesome</label>
                            <div class="input-group">
                                <span class="icon-preview-box" id="iconPreview">
                                    <i class="fa-regular fa-icons"></i>
                                </span>
                                <input type="text" id="txtIcon" class="form-control" placeholder="Ex: fa-regular fa-car" />
                                <button type="button" class="btn btn-azul" id="btnSearchIcon">
                                    <i class="fa-duotone fa-search icon-space"></i> Buscar Ícone
                                </button>
                            </div>
                            <small class="text-muted">Clique em "Buscar Ícone" para encontrar o ícone ideal.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-voltar" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Cancelar
                </button>
                <button type="button" class="btn btn-verde" id="btnSaveItem">
                    <i class="fa-duotone fa-check icon-space"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL BUSCA DE ÍCONES FONTAWESOME -->
<div class="modal fade" id="modalIconSearch" tabindex="-1" aria-labelledby="modalIconSearchTitle" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header modal-header-azul">
                <h3 class="modal-title" id="modalIconSearchTitle">
                    <i class="fa-duotone fa-icons"></i>
                    Buscar Ícone FontAwesome
                </h3>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Busca -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Buscar (em inglês)</label>
                        <div class="input-group">
                            <input type="text" id="txtIconSearch" class="form-control" placeholder="Ex: car, home, user, truck, calendar..." />
                            <button type="button" class="btn btn-fundo-laranja" id="btnDoIconSearch">
                                <i class="fa-duotone fa-search icon-space"></i> Buscar
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Estilo do Ícone</label>
                        <div class="style-selector">
                            <input type="radio" class="btn-check" name="iconStyle" id="styleRegular" value="fa-regular" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="styleRegular">Regular</label>

                            <input type="radio" class="btn-check" name="iconStyle" id="styleSolid" value="fa-solid">
                            <label class="btn btn-outline-secondary btn-sm" for="styleSolid">Solid</label>

                            <input type="radio" class="btn-check" name="iconStyle" id="styleLight" value="fa-light">
                            <label class="btn btn-outline-secondary btn-sm" for="styleLight">Light</label>

                            <input type="radio" class="btn-check" name="iconStyle" id="styleDuotone" value="fa-duotone">
                            <label class="btn btn-outline-secondary btn-sm" for="styleDuotone">Duotone</label>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div class="icon-results-container">
                    <div id="iconResults" class="row g-2">
                        <div class="col-12 text-center text-muted py-4">
                            <i class="fa-duotone fa-icons fa-3x mb-3 opacity-50"></i>
                            <p>Digite um termo e clique em "Buscar" para encontrar ícones.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-voltar" data-bs-dismiss="modal">
                    <i class="fa-duotone fa-xmark icon-space"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

@section ScriptsBlock {
    <script>
        (function() {
            "use strict";

            // ====== VARIÁVEIS GLOBAIS ======
            var treeData = [];
            var flatData = [];
            var editingItemId = null;
            var editingMode = 'add'; // 'add' ou 'edit'
            var hasUnsavedChanges = false;
            var modalItem = null;
            var modalIconSearch = null;

            // Lista de ícones comuns do FontAwesome
            var iconesDisponiveis = [
                'home', 'house', 'car', 'car-side', 'truck', 'bus', 'taxi', 'van-shuttle',
                'user', 'users', 'user-plus', 'user-gear', 'user-shield', 'user-pen',
                'gear', 'cog', 'gears', 'wrench', 'screwdriver-wrench', 'tools', 'toolbox',
                'file', 'file-alt', 'file-lines', 'files', 'folder', 'folder-open', 'folders',
                'calendar', 'calendar-alt', 'calendar-days', 'calendar-check', 'clock',
                'chart-bar', 'chart-line', 'chart-pie', 'chart-area', 'chart-simple',
                'gas-pump', 'oil-can', 'battery-full', 'charging-station',
                'map', 'map-marker', 'map-marker-alt', 'location-dot', 'route', 'road',
                'bell', 'bells', 'bell-on', 'envelope', 'inbox',
                'shield', 'shield-check', 'shield-keyhole', 'lock', 'key',
                'plus', 'minus', 'check', 'xmark', 'times',
                'pen', 'pen-to-square', 'pencil', 'edit', 'trash', 'trash-can',
                'search', 'magnifying-glass', 'filter', 'sort',
                'list', 'list-ul', 'list-check', 'table', 'grid',
                'building', 'building-columns', 'city', 'warehouse',
                'money-bill', 'dollar-sign', 'coins', 'credit-card', 'wallet',
                'box', 'box-open', 'boxes', 'archive', 'clipboard',
                'sitemap', 'network-wired', 'diagram-project',
                'caret-right', 'caret-down', 'chevron-right', 'chevron-down',
                'arrow-right', 'arrow-left', 'arrows-rotate', 'rotate-left',
                'download', 'upload', 'cloud-arrow-up', 'cloud-arrow-down',
                'print', 'file-pdf', 'file-excel', 'file-word',
                'bug', 'code', 'terminal', 'database',
                'circle-info', 'circle-question', 'circle-exclamation', 'triangle-exclamation',
                'star', 'heart', 'bookmark', 'flag',
                'eye', 'eye-slash', 'expand', 'compress',
                'play', 'pause', 'stop', 'forward', 'backward',
                'sun', 'moon', 'cloud', 'bolt',
                'phone', 'mobile', 'laptop', 'desktop', 'tv',
                'image', 'camera', 'video', 'microphone',
                'link', 'unlink', 'paperclip', 'share',
                'save', 'floppy-disk', 'copy', 'paste', 'scissors',
                'undo', 'redo', 'rotate', 'sync', 'refresh',
                'bars', 'ellipsis', 'ellipsis-vertical', 'grip',
                'address-book', 'address-card', 'id-card', 'id-badge',
                'briefcase', 'briefcase-clock', 'suitcase',
                'car-wrench', 'car-battery', 'car-burst',
                'gauge', 'gauge-high', 'tachometer-alt',
                'receipt', 'file-invoice', 'file-invoice-dollar',
                'hands-helping', 'handshake', 'people-arrows',
                'industry', 'store', 'shop',
                'keyboard', 'mouse', 'headphones',
                'medal', 'trophy', 'award', 'certificate',
                'percent', 'percentage', 'calculator',
                'qrcode', 'barcode', 'fingerprint',
                'robot', 'wand-magic-sparkles', 'sparkles',
                'rocket', 'plane', 'helicopter', 'ship',
                'signal', 'wifi', 'bluetooth',
                'tags', 'tag', 'hashtag', 'at'
            ];

            // ====== INICIALIZAÇÃO ======
            $(document).ready(function() {
                try {
                    // Inicializa modais Bootstrap
                    modalItem = new bootstrap.Modal(document.getElementById('modalItem'));
                    modalIconSearch = new bootstrap.Modal(document.getElementById('modalIconSearch'));

                    // Carrega dados
                    carregarNavegacao();

                    // Configura eventos
                    configurarEventos();

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "document.ready", error);
                }
            });

            // ====== NORMALIZAR DADOS DA API (PascalCase -> camelCase) ======
            function normalizarItem(item) {
                if (!item) return null;

                var normalizado = {
                    id: item.id || item.Id,
                    text: item.text || item.Text || item.nomeMenu || item.NomeMenu,
                    title: item.title || item.Title,
                    nomeMenu: item.nomeMenu || item.NomeMenu,
                    href: item.href || item.Href,
                    icon: item.icon || item.Icon,
                    iconCss: item.iconCss || item.IconCss,
                    parentId: item.parentId || item.ParentId,
                    hasChild: item.hasChild || item.HasChild || false,
                    expanded: item.expanded !== undefined ? item.expanded : (item.Expanded !== undefined ? item.Expanded : true),
                    items: []
                };

                var filhos = item.items || item.Items;
                if (filhos && filhos.length > 0) {
                    normalizado.items = filhos.map(function(filho) {
                        return normalizarItem(filho);
                    });
                    normalizado.hasChild = true;
                }

                return normalizado;
            }

            function normalizarDados(dados) {
                if (!dados || !Array.isArray(dados)) return [];
                return dados.map(function(item) {
                    return normalizarItem(item);
                });
            }

            // ====== CARREGAR NAVEGAÇÃO ======
            function carregarNavegacao() {
                try {
                    $('#loadingOverlay').show();

                    $.ajax({
                        url: '/api/Navigation/GetTree',
                        type: 'GET',
                        dataType: 'json',
                        success: function(res) {
                            try {
                                if (res && res.success) {
                                    // Normaliza os dados da API (PascalCase -> camelCase)
                                    treeData = normalizarDados(res.data || []);
                                    renderizarTreeView();
                                    atualizarDropdownPais();
                                } else {
                                    AppToast.show('Vermelho', res.message || 'Erro ao carregar navegação', 3000);
                                }
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "carregarNavegacao.success", error);
                            }
                            $('#loadingOverlay').hide();
                        },
                        error: function(err) {
                            $('#loadingOverlay').hide();
                            Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "carregarNavegacao.error", err);
                            AppToast.show('Vermelho', 'Erro ao conectar com o servidor', 3000);
                        }
                    });
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "carregarNavegacao", error);
                }
            }

            // ====== RENDERIZAR TREEVIEW ======
            function renderizarTreeView() {
                try {
                    var html = '<ul class="tree-list">';
                    html += renderizarNos(treeData, 0);
                    html += '</ul>';

                    $('#treeNav').html(html);

                    // Inicializa sortable para drag & drop
                    inicializarSortable();

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "renderizarTreeView", error);
                }
            }

            function renderizarNos(items, nivel) {
                var html = '';

                if (!items || items.length === 0) return html;

                items.forEach(function(item, index) {
                    var hasChildren = item.items && item.items.length > 0;
                    var iconClass = item.icon || 'fa-regular fa-file';

                    html += '<li class="tree-item" data-id="' + item.id + '" data-nivel="' + nivel + '">';
                    html += '<div class="tree-node-content">';

                    // Ícone de expansão (se tiver filhos)
                    if (hasChildren) {
                        html += '<span class="expand-icon" onclick="toggleExpand(this)"><i class="fa-solid fa-caret-down"></i></span>';
                    } else {
                        html += '<span class="expand-icon-placeholder" style="width:16px;"></span>';
                    }

                    // Ícone do menu
                    html += '<span class="nav-item-icon"><i class="' + iconClass + '"></i></span>';

                    // Texto
                    html += '<span class="nav-item-text">' + escapeHtml(item.text || item.nomeMenu || 'Sem nome') + '</span>';

                    // Href (se tiver)
                    if (item.href) {
                        html += '<span class="nav-item-href">(' + escapeHtml(item.href) + ')</span>';
                    }

                    // Ações
                    html += '<span class="tree-actions">';
                    html += '<button type="button" class="btn btn-azul btn-edit" data-id="' + item.id + '" title="Editar">';
                    html += '<i class="fa-duotone fa-pen-to-square"></i></button>';
                    html += '<button type="button" class="btn btn-fundo-laranja btn-add-child" data-id="' + item.id + '" title="Adicionar Subitem">';
                    html += '<i class="fa-duotone fa-plus"></i></button>';
                    html += '<button type="button" class="btn btn-vinho btn-delete" data-id="' + item.id + '" title="Excluir">';
                    html += '<i class="fa-duotone fa-trash-can"></i></button>';
                    html += '</span>';

                    html += '</div>'; // tree-node-content

                    // Filhos
                    if (hasChildren) {
                        html += '<ul class="tree-children">';
                        html += renderizarNos(item.items, nivel + 1);
                        html += '</ul>';
                    }

                    html += '</li>';
                });

                return html;
            }

            // ====== INICIALIZAR SORTABLE (DRAG & DROP) ======
            function inicializarSortable() {
                try {
                    // Usa jQuery UI Sortable para drag & drop
                    $('.tree-list, .tree-children').sortable({
                        connectWith: '.tree-list, .tree-children',
                        placeholder: 'sortable-placeholder',
                        handle: '.nav-item-icon, .nav-item-text',
                        tolerance: 'pointer',
                        cursor: 'move',
                        opacity: 0.8,
                        revert: 100,
                        update: function(event, ui) {
                            marcarAlteracoesPendentes();
                            atualizarTreeDataFromDOM();
                            atualizarDropdownPais();
                        }
                    }).disableSelection();

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "inicializarSortable", error);
                }
            }

            // ====== ATUALIZAR TREEDATA A PARTIR DO DOM ======
            function atualizarTreeDataFromDOM() {
                try {
                    treeData = [];

                    $('#treeNav > .tree-list > .tree-item').each(function() {
                        var item = extrairItemDoDOM($(this));
                        if (item) treeData.push(item);
                    });

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "atualizarTreeDataFromDOM", error);
                }
            }

            function extrairItemDoDOM($li) {
                try {
                    var id = $li.data('id');
                    var itemOriginal = encontrarItemPorId(id, treeData) || {};

                    var item = {
                        id: id,
                        text: itemOriginal.text || itemOriginal.nomeMenu,
                        title: itemOriginal.title,
                        nomeMenu: itemOriginal.nomeMenu,
                        href: itemOriginal.href,
                        icon: itemOriginal.icon,
                        iconCss: itemOriginal.iconCss,
                        parentId: null,
                        hasChild: false,
                        expanded: true,
                        items: []
                    };

                    // Processa filhos
                    $li.find('> .tree-children > .tree-item').each(function() {
                        var filho = extrairItemDoDOM($(this));
                        if (filho) {
                            filho.parentId = id;
                            item.items.push(filho);
                        }
                    });

                    item.hasChild = item.items.length > 0;

                    return item;
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "extrairItemDoDOM", error);
                    return null;
                }
            }

            // ====== SALVAR NAVEGAÇÃO ======
            function salvarNavegacao() {
                try {
                    $('#loadingOverlay').show();

                    // Atualiza dados do DOM
                    atualizarTreeDataFromDOM();

                    $.ajax({
                        url: '/api/Navigation/SaveTree',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(treeData),
                        success: function(res) {
                            try {
                                if (res && res.success) {
                                    AppToast.show('Verde', res.message || 'Navegação salva com sucesso!', 3000);
                                    limparAlteracoesPendentes();
                                } else {
                                    AppToast.show('Vermelho', res.message || 'Erro ao salvar navegação', 3000);
                                }
                            } catch (error) {
                                Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "salvarNavegacao.success", error);
                            }
                            $('#loadingOverlay').hide();
                        },
                        error: function(err) {
                            $('#loadingOverlay').hide();
                            Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "salvarNavegacao.error", err);
                            AppToast.show('Vermelho', 'Erro ao salvar navegação', 3000);
                        }
                    });
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "salvarNavegacao", error);
                }
            }

            // ====== MODAL ADICIONAR/EDITAR ======
            function abrirModalItem(modo, itemData, parentId) {
                try {
                    editingMode = modo;

                    if (modo === 'edit' && itemData) {
                        $('#modalItemTitleText').text('Editar Item');
                        $('#modalItemTitle i').removeClass('fa-plus-circle').addClass('fa-pen-to-square');

                        editingItemId = itemData.id;
                        $('#txtItemId').val(itemData.id);
                        $('#txtOldNomeMenu').val(itemData.nomeMenu);
                        $('#txtTitle').val(itemData.title || itemData.text);
                        $('#txtNomeMenu').val(itemData.nomeMenu);
                        $('#txtHref').val(itemData.href);
                        $('#txtIcon').val(itemData.icon);
                        $('#txtParentId').val(itemData.parentId || '');
                        $('#selParent').val(itemData.parentId || '');
                        atualizarPreviewIcone(itemData.icon);
                    } else {
                        $('#modalItemTitleText').text('Adicionar Item');
                        $('#modalItemTitle i').removeClass('fa-pen-to-square').addClass('fa-plus-circle');

                        editingItemId = null;
                        $('#frmItem')[0].reset();
                        $('#txtItemId').val('');
                        $('#txtOldNomeMenu').val('');
                        $('#txtParentId').val(parentId || '');
                        $('#selParent').val(parentId || '');
                        atualizarPreviewIcone('fa-regular fa-file');
                    }

                    modalItem.show();
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "abrirModalItem", error);
                }
            }

            function salvarItem() {
                try {
                    var title = $('#txtTitle').val().trim();
                    var nomeMenu = $('#txtNomeMenu').val().trim();
                    var href = $('#txtHref').val().trim();
                    var icon = $('#txtIcon').val().trim() || 'fa-regular fa-file';
                    var parentId = $('#selParent').val();

                    if (!title) {
                        AppToast.show('Vermelho', 'Informe o título do item', 3000);
                        return;
                    }

                    if (!nomeMenu) {
                        AppToast.show('Vermelho', 'Informe o nome de menu', 3000);
                        return;
                    }

                    if (editingMode === 'add') {
                        // Adiciona novo item
                        var novoId = 'item_' + Date.now();
                        var novoItem = {
                            id: novoId,
                            text: nomeMenu,
                            title: title,
                            nomeMenu: nomeMenu,
                            href: href,
                            icon: icon,
                            iconCss: icon,
                            parentId: parentId,
                            hasChild: false,
                            expanded: true,
                            items: []
                        };

                        if (parentId) {
                            // Adiciona como filho
                            var pai = encontrarItemPorId(parentId, treeData);
                            if (pai) {
                                if (!pai.items) pai.items = [];
                                pai.items.push(novoItem);
                                pai.hasChild = true;
                            }
                        } else {
                            // Adiciona na raiz
                            treeData.push(novoItem);
                        }

                        // Sincroniza com BD
                        $.ajax({
                            url: '/api/Navigation/AddItem',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                id: novoId,
                                title: title,
                                nomeMenu: nomeMenu,
                                href: href,
                                icon: icon,
                                parentId: parentId
                            }),
                            success: function(res) {
                                if (!res.success) {
                                    AppToast.show('Vermelho', res.message || 'Erro ao adicionar item', 3000);
                                }
                            }
                        });

                    } else {
                        // Edita item existente
                        var item = encontrarItemPorId(editingItemId, treeData);
                        if (item) {
                            var oldNomeMenu = item.nomeMenu;
                            item.text = nomeMenu;
                            item.title = title;
                            item.nomeMenu = nomeMenu;
                            item.href = href;
                            item.icon = icon;
                            item.iconCss = icon;

                            // Sincroniza com BD
                            $.ajax({
                                url: '/api/Navigation/UpdateItem',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    id: editingItemId,
                                    title: title,
                                    nomeMenu: nomeMenu,
                                    oldNomeMenu: oldNomeMenu,
                                    href: href,
                                    icon: icon
                                }),
                                success: function(res) {
                                    if (!res.success) {
                                        AppToast.show('Vermelho', res.message || 'Erro ao atualizar item', 3000);
                                    }
                                }
                            });
                        }
                    }

                    renderizarTreeView();
                    atualizarDropdownPais();
                    marcarAlteracoesPendentes();
                    modalItem.hide();
                    AppToast.show('Verde', editingMode === 'add' ? 'Item adicionado!' : 'Item atualizado!', 2000);

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "salvarItem", error);
                }
            }

            function excluirItem(itemId) {
                try {
                    var item = encontrarItemPorId(itemId, treeData);
                    if (!item) return;

                    if (item.items && item.items.length > 0) {
                        Swal.fire({
                            title: 'Item com subitens',
                            text: 'Este item possui subitens. Deseja excluir tudo?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#8B0000',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'Sim, excluir tudo',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                realizarExclusao(itemId, item.nomeMenu);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Confirmar Exclusão',
                            html: 'Deseja excluir o item <strong>' + escapeHtml(item.text || item.nomeMenu) + '</strong>?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#8B0000',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'Sim, excluir',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                realizarExclusao(itemId, item.nomeMenu);
                            }
                        });
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "excluirItem", error);
                }
            }

            function realizarExclusao(itemId, nomeMenu) {
                try {
                    removerItemPorId(itemId, treeData);
                    renderizarTreeView();
                    atualizarDropdownPais();
                    marcarAlteracoesPendentes();

                    // Sincroniza com BD
                    $.ajax({
                        url: '/api/Navigation/DeleteItem',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ nomeMenu: nomeMenu }),
                        success: function(res) {
                            if (res.success) {
                                AppToast.show('Verde', 'Item excluído!', 2000);
                            }
                        }
                    });
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "realizarExclusao", error);
                }
            }

            // ====== BUSCA DE ÍCONES ======
            function buscarIcones(termo) {
                try {
                    var estilo = $('input[name="iconStyle"]:checked').val() || 'fa-regular';

                    if (!termo || termo.length < 2) {
                        $('#iconResults').html('<div class="col-12 text-center text-muted py-4">Digite pelo menos 2 caracteres para buscar.</div>');
                        return;
                    }

                    var termoLower = termo.toLowerCase();
                    var resultados = iconesDisponiveis.filter(function(icon) {
                        return icon.indexOf(termoLower) >= 0;
                    });

                    renderizarResultadosIcones(resultados, estilo);

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "buscarIcones", error);
                }
            }

            function renderizarResultadosIcones(icones, estilo) {
                try {
                    if (!icones || icones.length === 0) {
                        $('#iconResults').html('<div class="col-12 text-center text-muted py-4"><i class="fa-duotone fa-face-frown fa-2x mb-2"></i><br>Nenhum ícone encontrado. Tente outro termo.</div>');
                        return;
                    }

                    var html = '';
                    icones.forEach(function(icon) {
                        var classeCompleta = estilo + ' fa-' + icon;
                        html += '<div class="col-6 col-sm-4 col-md-3 col-lg-2">';
                        html += '<div class="icon-result-item" data-icon="' + classeCompleta + '">';
                        html += '<i class="' + classeCompleta + '"></i>';
                        html += '<div class="icon-name">' + icon + '</div>';
                        html += '</div></div>';
                    });

                    $('#iconResults').html(html);
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "renderizarResultadosIcones", error);
                }
            }

            // ====== FUNÇÕES AUXILIARES ======
            function encontrarItemPorId(id, items) {
                if (!items) return null;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].id === id) return items[i];
                    if (items[i].items && items[i].items.length > 0) {
                        var encontrado = encontrarItemPorId(id, items[i].items);
                        if (encontrado) return encontrado;
                    }
                }
                return null;
            }

            function removerItemPorId(id, items) {
                for (var i = 0; i < items.length; i++) {
                    if (items[i].id === id) {
                        items.splice(i, 1);
                        return true;
                    }
                    if (items[i].items && items[i].items.length > 0) {
                        if (removerItemPorId(id, items[i].items)) {
                            if (items[i].items.length === 0) {
                                items[i].hasChild = false;
                            }
                            return true;
                        }
                    }
                }
                return false;
            }

            function atualizarDropdownPais() {
                try {
                    var $select = $('#selParent');
                    var valorAtual = $select.val();

                    $select.find('option:not(:first)').remove();

                    adicionarOpcoesPai(treeData, '', $select);

                    $select.val(valorAtual);
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "atualizarDropdownPais", error);
                }
            }

            function adicionarOpcoesPai(items, prefixo, $select) {
                items.forEach(function(item) {
                    var texto = prefixo + (item.text || item.nomeMenu || 'Sem nome');
                    $select.append('<option value="' + item.id + '">' + escapeHtml(texto) + '</option>');

                    if (item.items && item.items.length > 0) {
                        adicionarOpcoesPai(item.items, prefixo + '— ', $select);
                    }
                });
            }

            function atualizarPreviewIcone(iconClass) {
                try {
                    if (iconClass) {
                        $('#iconPreview i').attr('class', iconClass);
                    } else {
                        $('#iconPreview i').attr('class', 'fa-regular fa-icons');
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "atualizarPreviewIcone", error);
                }
            }

            function marcarAlteracoesPendentes() {
                hasUnsavedChanges = true;
                $('body').addClass('has-changes');
            }

            function limparAlteracoesPendentes() {
                hasUnsavedChanges = false;
                $('body').removeClass('has-changes');
            }

            function escapeHtml(text) {
                if (!text) return '';
                return $('<div>').text(text).html();
            }

            // Função global para toggle expand
            window.toggleExpand = function(element) {
                try {
                    var $li = $(element).closest('.tree-item');
                    var $children = $li.find('> .tree-children');
                    var $icon = $(element).find('i');

                    if ($children.is(':visible')) {
                        $children.slideUp(200);
                        $icon.removeClass('fa-caret-down').addClass('fa-caret-right');
                    } else {
                        $children.slideDown(200);
                        $icon.removeClass('fa-caret-right').addClass('fa-caret-down');
                    }
                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "toggleExpand", error);
                }
            };

            // ====== CONFIGURAR EVENTOS ======
            function configurarEventos() {
                try {
                    // Botão Adicionar Raiz
                    $('#btnAddRoot').on('click', function() {
                        abrirModalItem('add', null, null);
                    });

                    // Botão Salvar
                    $('#btnSave').on('click', function() {
                        salvarNavegacao();
                    });

                    // Botão Salvar Item (modal)
                    $('#btnSaveItem').on('click', function() {
                        salvarItem();
                    });

                    // Botão Buscar Ícone
                    $('#btnSearchIcon').on('click', function() {
                        modalIconSearch.show();
                        $('#txtIconSearch').val('').focus();
                    });

                    // Executar busca de ícones
                    $('#btnDoIconSearch').on('click', function() {
                        buscarIcones($('#txtIconSearch').val());
                    });

                    // Enter no campo de busca
                    $('#txtIconSearch').on('keypress', function(e) {
                        if (e.which === 13) {
                            e.preventDefault();
                            buscarIcones($(this).val());
                        }
                    });

                    // Mudar estilo do ícone
                    $('input[name="iconStyle"]').on('change', function() {
                        var termo = $('#txtIconSearch').val();
                        if (termo) buscarIcones(termo);
                    });

                    // Selecionar ícone
                    $(document).on('click', '.icon-result-item', function() {
                        var icon = $(this).data('icon');
                        $('#txtIcon').val(icon);
                        atualizarPreviewIcone(icon);
                        modalIconSearch.hide();
                    });

                    // Atualizar preview ao digitar
                    $('#txtIcon').on('input', function() {
                        atualizarPreviewIcone($(this).val());
                    });

                    // Botão Editar (delegação)
                    $(document).on('click', '.btn-edit', function(e) {
                        e.stopPropagation();
                        var id = $(this).data('id');
                        var item = encontrarItemPorId(id, treeData);
                        if (item) abrirModalItem('edit', item, null);
                    });

                    // Botão Adicionar Filho (delegação)
                    $(document).on('click', '.btn-add-child', function(e) {
                        e.stopPropagation();
                        var parentId = $(this).data('id');
                        abrirModalItem('add', null, parentId);
                    });

                    // Botão Excluir (delegação)
                    $(document).on('click', '.btn-delete', function(e) {
                        e.stopPropagation();
                        var id = $(this).data('id');
                        excluirItem(id);
                    });

                    // Expandir todos
                    $('#btnExpandir').on('click', function() {
                        $('.tree-children').slideDown(200);
                        $('.expand-icon i').removeClass('fa-caret-right').addClass('fa-caret-down');
                    });

                    // Recolher todos
                    $('#btnRecolher').on('click', function() {
                        $('.tree-children').slideUp(200);
                        $('.expand-icon i').removeClass('fa-caret-down').addClass('fa-caret-right');
                    });

                    // Aviso ao sair com alterações pendentes
                    $(window).on('beforeunload', function() {
                        if (hasUnsavedChanges) {
                            return 'Existem alterações não salvas. Deseja realmente sair?';
                        }
                    });

                } catch (error) {
                    Alerta.TratamentoErroComLinha("GerenciadorNavegacao.cshtml", "configurarEventos", error);
                }
            }

        })();
    </script>

    <style>
        /* Estilos adicionais para a TreeView customizada */
        .tree-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tree-children {
            list-style: none;
            padding-left: 2rem;
            margin: 0;
        }

        .tree-item {
            margin: 2px 0;
        }

        .expand-icon {
            cursor: pointer;
            width: 20px;
            text-align: center;
            color: #6c757d;
        }

        .expand-icon:hover {
            color: #3D5771;
        }

        /* Placeholder para drag */
        .sortable-placeholder {
            height: 40px;
            background: rgba(61, 87, 113, 0.1);
            border: 2px dashed #3D5771;
            border-radius: 6px;
            margin: 4px 0;
        }

        /* Estilo durante drag */
        .ui-sortable-helper {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-radius: 6px;
        }
    </style>
}
