@page
@model FrotiX.Pages.Administracao.LogErrosModel

@{
    ViewData["Title"] = "Log de Erros";
    ViewData["PageName"] = "logerros_index";
    ViewData["Heading"] = "<i class='fa-duotone fa-bug'></i> Administra√ß√£o: <span class='fw-300'>Log de Erros</span>";
    ViewData["Category1"] = "Administra√ß√£o";
    ViewData["PageIcon"] = "fa-duotone fa-bug";
}

@section HeadBlock {
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====== HEADER AZUL PADR√ÉO FROTIX ====== */
        .ftx-card-header {
            background-color: #3D5771;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            overflow: hidden;
        }

        .ftx-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @@keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .ftx-card-header .titulo-paginas {
            color: #fff !important;
            font-family: 'Outfit', sans-serif !important;
            font-weight: 900 !important;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        /* √çcone do header: cores definidas no frotix.css global */
        .ftx-card-header .titulo-paginas i.fa-duotone {
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        /* ====== PANEL CONTENT ====== */
        .panel-content {
            padding: 1.25rem;
            background: #f8f9fa;
        }

        /* ====== CARDS DE ESTAT√çSTICAS (CLIC√ÅVEIS) ====== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border-left: 4px solid #3D5771;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card:active {
            transform: translateY(-1px);
        }

        .stat-card.active {
            box-shadow: 0 0 0 3px rgba(61, 87, 113, 0.3), 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .stat-card.errors { border-left-color: #dc3545; }
        .stat-card.errors.active { box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3), 0 4px 12px rgba(0,0,0,0.15); }

        .stat-card.warnings { border-left-color: #ffc107; }
        .stat-card.warnings.active { box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3), 0 4px 12px rgba(0,0,0,0.15); }

        .stat-card.info { border-left-color: #17a2b8; }
        .stat-card.info.active { box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.3), 0 4px 12px rgba(0,0,0,0.15); }

        .stat-card.js-errors { border-left-color: #6f42c1; }
        .stat-card.js-errors.active { box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.3), 0 4px 12px rgba(0,0,0,0.15); }

        .stat-card.http-errors { border-left-color: #fd7e14; }
        .stat-card.http-errors.active { box-shadow: 0 0 0 3px rgba(253, 126, 20, 0.3), 0 4px 12px rgba(0,0,0,0.15); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3D5771;
            line-height: 1;
        }

        .stat-card.errors .stat-value { color: #dc3545; }
        .stat-card.warnings .stat-value { color: #ffc107; }
        .stat-card.info .stat-value { color: #17a2b8; }
        .stat-card.js-errors .stat-value { color: #6f42c1; }
        .stat-card.http-errors .stat-value { color: #fd7e14; }

        .stat-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        .stat-card .stat-icon {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
            opacity: 0.7;
        }

        /* ====== FILTROS ====== */
        .filtros-container {
            background: #fff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        .filtro-ativo {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e8ed 100%);
            border: 1px solid #3D5771;
        }

        .filtro-ativo-label {
            display: none;
            font-size: 0.8rem;
            color: #3D5771;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .filtro-ativo .filtro-ativo-label {
            display: block;
        }

        /* ====== √ÅREA DE LOGS ====== */
        .logs-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            color: #d4d4d4;
            max-height: 600px;
            overflow-y: auto;
        }

        /* ====== BLOCO DE LOG (AGRUPADO) ====== */
        .log-block {
            margin-bottom: 0.75rem;
            border-radius: 4px;
            background: #252526;
            border-left: 3px solid #3D5771;
            overflow: hidden;
        }

        .log-block:hover {
            background: #2d2d30;
        }

        .log-block.error { border-left-color: #f14c4c; }
        .log-block.warning { border-left-color: #cca700; }
        .log-block.info { border-left-color: #3794ff; }
        .log-block.http-error { border-left-color: #e67e22; background: #2d2a26; }
        .log-block.js-error { border-left-color: #b388ff; }
        .log-block.user { border-left-color: #c586c0; }

        /* ====== CABE√áALHO DO LOG (VERDE/COLORIDO) ====== */
        .log-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(90deg, #2e7d32 0%, #1b5e20 100%);
            font-weight: 600;
            color: #fff;
            flex-wrap: wrap;
        }

        .log-header.error { background: linear-gradient(90deg, #c62828 0%, #b71c1c 100%); }
        .log-header.warning { background: linear-gradient(90deg, #f9a825 0%, #f57f17 100%); color: #000; }
        .log-header.info { background: linear-gradient(90deg, #1565c0 0%, #0d47a1 100%); }
        .log-header.http-error { background: linear-gradient(90deg, #d35400 0%, #a04000 100%); }
        .log-header.js-error { background: linear-gradient(90deg, #7b1fa2 0%, #4a148c 100%); }
        .log-header.user { background: linear-gradient(90deg, #7b1fa2 0%, #6a1b9a 100%); }
        .log-header.operation { background: linear-gradient(90deg, #00695c 0%, #004d40 100%); }

        .log-header .log-datetime {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.15);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .log-header .log-type {
            background: rgba(0,0,0,0.25);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .log-header .log-summary {
            flex: 1;
            font-size: 0.8rem;
            opacity: 0.95;
        }

        /* ====== DETALHES DO LOG ====== */
        .log-details {
            padding: 0.5rem 0.75rem;
            line-height: 1.5;
            font-size: 0.78rem;
        }

        .log-details .detail-line {
            padding: 0.15rem 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Cores para cada tipo de detalhe */
        .detail-line.usuario { color: #9cdcfe; }
        .detail-line.message { color: #ce9178; }
        .detail-line.method { color: #dcdcaa; }
        .detail-line.path { color: #4ec9b0; }
        .detail-line.arquivo { color: #9cdcfe; }
        .detail-line.metodo { color: #dcdcaa; }
        .detail-line.linha { color: #b5cea8; }
        .detail-line.url { color: #4ec9b0; }
        .detail-line.stack { color: #808080; font-size: 0.72rem; }
        .detail-line.exception { color: #f14c4c; }

        /* ====== RESPONSIVO ====== */
        @@media (max-width: 768px) {
            .ftx-card-header {
                flex-direction: column;
                text-align: center;
            }

            .ftx-card-header .titulo-paginas {
                font-size: 1.2rem;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .log-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
}

<div class="row">
    <div class="col-xl-12">
        <div id="panel-1" class="panel">
            <div class="panel-container show">

                <!-- HEADER AZUL PADR√ÉO FROTIX -->
                <div class="ftx-card-header">
                    <h2 class="titulo-paginas">
                        <i class="fa-duotone fa-bug"></i>
                        Log de Erros do Sistema
                    </h2>
                </div>

                <!-- CONTE√öDO -->
                <div class="panel-content">
                    
                    <!-- ESTAT√çSTICAS (CLIC√ÅVEIS COMO FILTROS) -->
                    <div class="stats-container">
                        <div class="stat-card active" data-filter="" title="Clique para ver todos os logs">
                            <div class="stat-icon"><i class="fa-duotone fa-list-ul"></i></div>
                            <div class="stat-value" id="statTotal">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-card errors" data-filter="ERROR" title="Clique para filtrar apenas erros">
                            <div class="stat-icon"><i class="fa-duotone fa-circle-exclamation"></i></div>
                            <div class="stat-value" id="statErrors">0</div>
                            <div class="stat-label">Erros</div>
                        </div>
                        <div class="stat-card js-errors" data-filter="ERROR-JS" title="Clique para filtrar erros JavaScript">
                            <div class="stat-icon"><i class="fa-duotone fa-js"></i></div>
                            <div class="stat-value" id="statJsErrors">0</div>
                            <div class="stat-label">JS Errors</div>
                        </div>
                        <div class="stat-card http-errors" data-filter="HTTP-ERROR" title="Clique para filtrar erros HTTP">
                            <div class="stat-icon"><i class="fa-duotone fa-globe"></i></div>
                            <div class="stat-value" id="statHttpErrors">0</div>
                            <div class="stat-label">HTTP Errors</div>
                        </div>
                        <div class="stat-card warnings" data-filter="WARN" title="Clique para filtrar avisos">
                            <div class="stat-icon"><i class="fa-duotone fa-triangle-exclamation"></i></div>
                            <div class="stat-value" id="statWarnings">0</div>
                            <div class="stat-label">Avisos</div>
                        </div>
                        <div class="stat-card info" data-filter="INFO" title="Clique para filtrar informa√ß√µes">
                            <div class="stat-icon"><i class="fa-duotone fa-circle-info"></i></div>
                            <div class="stat-value" id="statInfo">0</div>
                            <div class="stat-label">Info</div>
                        </div>
                    </div>

                    <!-- FILTROS -->
                    <div class="filtros-container" id="filtrosContainer">
                        <div class="filtro-ativo-label">
                            <i class="fa-duotone fa-filter"></i> Filtro ativo: <span id="filtroAtivoNome">Todos</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="limparTodosFiltros()" title="Limpar filtro">
                                <i class="fa-duotone fa-xmark"></i>
                            </button>
                        </div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Data</label>
                                <input type="date" id="dataFiltro" class="form-control" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Tipo</label>
                                <select id="tipoFiltro" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="ERROR">Erros</option>
                                    <option value="ERROR-JS">JS Errors</option>
                                    <option value="HTTP-ERROR">HTTP Errors</option>
                                    <option value="WARN">Avisos</option>
                                    <option value="INFO">Info</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Buscar</label>
                                <input type="text" id="buscaFiltro" class="form-control" placeholder="Filtrar por texto..." />
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-azul w-100" onclick="aplicarFiltros()">
                                    <i class="fa-duotone fa-filter icon-space"></i> Filtrar
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-vinho w-100" onclick="limparLogs()">
                                    <i class="fa-duotone fa-trash icon-space"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- LOGS -->
                    <div class="logs-container" id="logsContainer">
                        <div class="text-center text-muted py-5">
                            <i class="fa-duotone fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Carregando logs...</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- OVERLAY DE LOADING - PADR√ÉO FROTIX -->
<div id="loadingOverlayLogErros" class="ftx-spin-overlay" style="z-index: 999999; cursor: wait; display: none;">
    <div class="ftx-spin-box" style="text-align: center; min-width: 300px;">
        <img src="/images/logo_gota_frotix_transparente.png" alt="FrotiX" class="ftx-loading-logo" style="display: block;" />
        <div class="ftx-loading-bar"></div>
        <div class="ftx-loading-text">Carregando Logs...</div>
        <div class="ftx-loading-subtext">Aguarde, por favor</div>
    </div>
</div>

@section ScriptsBlock {
    <script>
        // Vari√°veis globais
        var blocosParsed = [];
        var dataLogAtual = '';

        // ====== FUN√á√ïES DE LOADING OVERLAY ======
        function mostrarLoading() {
            $('#loadingOverlayLogErros').css('display', 'flex');
        }

        function esconderLoading() {
            $('#loadingOverlayLogErros').css('display', 'none');
        }

        $(document).ready(function () {
            try {
                // Define data atual no filtro
                var hoje = new Date().toISOString().split('T')[0];
                $('#dataFiltro').val(hoje);
                dataLogAtual = formatarDataBR(hoje);

                // Configura clique nos cards de estat√≠sticas
                $('.stat-card').on('click', function() {
                    try {
                        var filtro = $(this).data('filter');
                        
                        // Remove active de todos e adiciona no clicado
                        $('.stat-card').removeClass('active');
                        $(this).addClass('active');
                        
                        // Atualiza select
                        $('#tipoFiltro').val(filtro);
                        
                        // Aplica filtro
                        aplicarFiltros();
                    } catch (error) {
                        Alerta.TratamentoErroComLinha("LogErros.cshtml", "stat-card.click", error);
                    }
                });

                // Carrega logs
                carregarLogs();

                // Event listeners
                $('#tipoFiltro').on('change', aplicarFiltros);
                $('#buscaFiltro').on('keypress', function(e) {
                    if (e.which === 13) aplicarFiltros();
                });
                $('#dataFiltro').on('change', function() {
                    dataLogAtual = formatarDataBR($(this).val());
                    carregarLogs();
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "document.ready", error);
            }
        });

        function formatarDataBR(dataISO) {
            if (!dataISO) return '';
            var partes = dataISO.split('-');
            return partes[2] + '/' + partes[1] + '/' + partes[0];
        }

        function carregarLogs() {
            try {
                mostrarLoading();
                $('#logsContainer').html('<div class="text-center text-muted py-5"><i class="fa-duotone fa-spinner fa-spin fa-2x mb-3"></i><p>Carregando logs...</p></div>');

                // Usa fetch nativo para evitar interceptadores do jQuery
                fetch('/api/LogErros/ObterLogs', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(function(response) {
                    console.log('[LogErros] Response status:', response.status);
                    console.log('[LogErros] Response headers:', response.headers.get('content-type'));
                    
                    // Pega como texto primeiro para debug
                    return response.text();
                })
                .then(function(textoResposta) {
                    console.log('[LogErros] Resposta bruta (primeiros 200 chars):', textoResposta.substring(0, 200));
                    
                    // Agora faz o parse manual
                    var res;
                    try {
                        res = JSON.parse(textoResposta);
                    } catch (parseErr) {
                        console.error('[LogErros] Erro ao parsear JSON:', parseErr);
                        console.error('[LogErros] Texto completo:', textoResposta);
                        $('#logsContainer').html('<div class="text-danger p-3">Erro ao processar resposta JSON</div>');
                        esconderLoading();
                        return;
                    }
                    
                    console.log('[LogErros] JSON parseado com sucesso');
                    
                    if (res && res.success) {
                        // Atualiza estat√≠sticas
                        if (res.stats) {
                            $('#statTotal').text(res.stats.TotalLogs || res.stats.totalLogs || 0);
                            $('#statErrors').text(res.stats.ErrorCount || res.stats.errorCount || 0);
                            $('#statJsErrors').text(res.stats.JSErrorCount || res.stats.jsErrorCount || 0);
                            $('#statHttpErrors').text(res.stats.HttpErrorCount || res.stats.httpErrorCount || 0);
                            $('#statWarnings').text(res.stats.WarningCount || res.stats.warningCount || 0);
                            $('#statInfo').text(res.stats.InfoCount || res.stats.infoCount || 0);
                        }
                        
                        var logsTexto = res.logs || '';
                        console.log('[LogErros] Logs recebidos, tamanho:', logsTexto.length);
                        
                        // Parseia os logs em blocos
                        blocosParsed = parsearLogsEmBlocos(logsTexto);
                        
                        console.log('[LogErros] Blocos parseados:', blocosParsed.length);

                        // Renderiza
                        aplicarFiltros();
                        esconderLoading();
                    } else {
                        console.error('[LogErros] Resposta n√£o sucesso:', res);
                        $('#logsContainer').html('<div class="text-warning p-3">Erro ao carregar logs: ' + (res && res.error ? res.error : 'desconhecido') + '</div>');
                        esconderLoading();
                    }
                })
                .catch(function(error) {
                    console.error('[LogErros] Erro fetch:', error);
                    $('#logsContainer').html('<div class="text-danger p-3">Erro ao conectar: ' + error.message + '</div>');
                    esconderLoading();
                });

            } catch (error) {
                console.error('[LogErros] Erro geral:', error);
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "carregarLogs", error);
                esconderLoading();
            }
        }

        /**
         * Parseia o texto de logs em blocos estruturados
         */
        function parsearLogsEmBlocos(logsTexto) {
            try {
                console.log('[LogErros] Iniciando parsing, tamanho:', logsTexto ? logsTexto.length : 0);
                
                if (!logsTexto || logsTexto.trim() === '' || logsTexto.startsWith('Nenhum log')) {
                    console.log('[LogErros] Logs vazio ou mensagem de nenhum log');
                    return [];
                }

                var blocos = [];
                
                // IMPORTANTE: Normaliza quebras de linha (Windows usa \r\n)
                var logsNormalizados = logsTexto.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                var linhas = logsNormalizados.split('\n');
                var blocoAtual = null;

                console.log('[LogErros] Total de linhas:', linhas.length);

                // Regex para linha principal: [HH:mm:ss.fff] [TIPO] ...
                var regexPrincipal = /^\[(\d{2}:\d{2}:\d{2}\.\d{3})\]\s*\[([A-Z0-9_-]+)\]\s*(.*)$/;

                for (var i = 0; i < linhas.length; i++) {
                    var linha = linhas[i];
                    
                    // Pula linhas vazias
                    if (!linha || !linha.trim()) continue;

                    var match = linha.match(regexPrincipal);

                    if (match) {
                        // Linha principal com timestamp - salva bloco anterior e inicia novo
                        if (blocoAtual) {
                            blocos.push(blocoAtual);
                        }

                        blocoAtual = {
                            hora: match[1],
                            tipo: match[2],
                            resumo: match[3] || '',
                            detalhes: []
                        };
                    } else if (blocoAtual) {
                        // Linha de detalhe - adiciona ao bloco atual
                        blocoAtual.detalhes.push(linha);
                    }
                }

                // Adiciona √∫ltimo bloco
                if (blocoAtual) {
                    blocos.push(blocoAtual);
                }

                console.log('[LogErros] Blocos parseados:', blocos.length);

                // Inverte para ordem decrescente (mais recente primeiro)
                blocos.reverse();

                return blocos;
            } catch (error) {
                console.error('[LogErros] Erro no parsing:', error);
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "parsearLogsEmBlocos", error);
                return [];
            }
        }

        /**
         * Aplica filtros de tipo e busca e renderiza
         */
        function aplicarFiltros() {
            try {
                var tipoFiltro = $('#tipoFiltro').val() || '';
                var buscaFiltro = ($('#buscaFiltro').val() || '').toLowerCase().trim();

                console.log('[LogErros] Aplicando filtros - tipo:', tipoFiltro, 'busca:', buscaFiltro);
                console.log('[LogErros] Total blocos para filtrar:', blocosParsed.length);

                // Atualiza visual do filtro ativo
                atualizarVisualFiltro(tipoFiltro, buscaFiltro);

                // Se n√£o h√° filtros, renderiza todos
                if (!tipoFiltro && !buscaFiltro) {
                    console.log('[LogErros] Sem filtros, renderizando todos');
                    renderizarBlocos(blocosParsed);
                    return;
                }

                // Filtra os blocos
                var blocosFiltrados = blocosParsed.filter(function(bloco) {
                    // Filtro por tipo
                    var passaTipo = true;
                    if (tipoFiltro) {
                        if (tipoFiltro === 'ERROR') {
                            passaTipo = (bloco.tipo === 'ERROR' || bloco.tipo === 'OPERATION-FAIL');
                        } else if (tipoFiltro === 'INFO') {
                            passaTipo = (bloco.tipo === 'INFO' || bloco.tipo === 'USER' || bloco.tipo === 'OPERATION' || bloco.tipo === 'DEBUG');
                        } else {
                            passaTipo = (bloco.tipo === tipoFiltro);
                        }
                    }

                    // Filtro por busca de texto
                    var passaBusca = true;
                    if (buscaFiltro) {
                        var textoCompleto = (bloco.resumo || '') + ' ' + (bloco.detalhes || []).join(' ');
                        passaBusca = textoCompleto.toLowerCase().indexOf(buscaFiltro) >= 0;
                    }

                    return passaTipo && passaBusca;
                });

                console.log('[LogErros] Blocos ap√≥s filtro:', blocosFiltrados.length);

                // Renderiza
                renderizarBlocos(blocosFiltrados);

            } catch (error) {
                console.error('[LogErros] Erro no filtro:', error);
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "aplicarFiltros", error);
            }
        }

        function atualizarVisualFiltro(tipo, busca) {
            // Sincroniza cards com select
            $('.stat-card').removeClass('active');
            if (tipo) {
                $('.stat-card[data-filter="' + tipo + '"]').addClass('active');
            } else {
                $('.stat-card[data-filter=""]').addClass('active');
            }

            // Mostra/esconde indicador de filtro ativo
            if (tipo || busca) {
                $('#filtrosContainer').addClass('filtro-ativo');
                var nomes = {
                    '': 'Todos',
                    'ERROR': 'Erros',
                    'ERROR-JS': 'JS Errors',
                    'HTTP-ERROR': 'HTTP Errors',
                    'WARN': 'Avisos',
                    'INFO': 'Info'
                };
                var nomeFiltro = nomes[tipo] || 'Todos';
                if (busca) nomeFiltro += ' + "' + busca + '"';
                $('#filtroAtivoNome').text(nomeFiltro);
            } else {
                $('#filtrosContainer').removeClass('filtro-ativo');
                $('#filtroAtivoNome').text('Todos');
            }
        }

        /**
         * Renderiza os blocos de log na tela
         */
        function renderizarBlocos(blocos) {
            try {
                console.log('[LogErros] Renderizando blocos:', blocos ? blocos.length : 0);
                
                if (!blocos || blocos.length === 0) {
                    $('#logsContainer').html('<div class="text-muted p-3 text-center"><i class="fa-duotone fa-inbox fa-2x mb-2"></i><br>Nenhum log encontrado</div>');
                    return;
                }

                var html = '';

                blocos.forEach(function(bloco, index) {
                    var classeBloco = getClasseBloco(bloco.tipo);
                    var classeHeader = getClasseHeader(bloco.tipo);

                    html += '<div class="log-block ' + classeBloco + '">';
                    
                    // Cabe√ßalho com data, hora e tipo
                    html += '<div class="log-header ' + classeHeader + '">';
                    html += '<div class="log-datetime">';
                    html += '<i class="fa-duotone fa-calendar-day"></i> ' + dataLogAtual;
                    html += ' &nbsp;|&nbsp; ';
                    html += '<i class="fa-duotone fa-clock"></i> ' + (bloco.hora || '--:--:--');
                    html += '</div>';
                    html += '<span class="log-type">' + (bloco.tipo || 'LOG') + '</span>';
                    if (bloco.resumo) {
                        html += '<span class="log-summary">' + escapeHtml(bloco.resumo) + '</span>';
                    }
                    html += '</div>';

                    // Detalhes
                    if (bloco.detalhes && bloco.detalhes.length > 0) {
                        html += '<div class="log-details">';
                        bloco.detalhes.forEach(function(detalhe) {
                            var classeDetalhe = getClasseDetalhe(detalhe);
                            html += '<div class="detail-line ' + classeDetalhe + '">' + escapeHtml(detalhe) + '</div>';
                        });
                        html += '</div>';
                    }

                    html += '</div>';
                });

                console.log('[LogErros] HTML gerado, tamanho:', html.length);
                $('#logsContainer').html(html);
                console.log('[LogErros] Renderiza√ß√£o conclu√≠da');
            } catch (error) {
                console.error('[LogErros] Erro na renderiza√ß√£o:', error);
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "renderizarBlocos", error);
                $('#logsContainer').html('<div class="text-danger p-3">Erro ao renderizar logs: ' + error.message + '</div>');
            }
        }

        function getClasseBloco(tipo) {
            var map = {
                'ERROR': 'error',
                'ERROR-JS': 'js-error',
                'HTTP-ERROR': 'http-error',
                'WARN': 'warning',
                'INFO': 'info',
                'USER': 'user',
                'OPERATION': 'info',
                'OPERATION-FAIL': 'error',
                'DEBUG': 'info'
            };
            return map[tipo] || '';
        }

        function getClasseHeader(tipo) {
            var map = {
                'ERROR': 'error',
                'ERROR-JS': 'js-error',
                'HTTP-ERROR': 'http-error',
                'WARN': 'warning',
                'INFO': 'info',
                'USER': 'user',
                'OPERATION': 'operation',
                'OPERATION-FAIL': 'error',
                'DEBUG': 'info'
            };
            return map[tipo] || '';
        }

        function getClasseDetalhe(linha) {
            if (linha.includes('üë§') || linha.includes('Usu√°rio:')) return 'usuario';
            if (linha.includes('üí¨') || linha.includes('Message:')) return 'message';
            if (linha.includes('üîß') || linha.includes('Method:') || linha.includes('M√©todo:') || linha.includes('Fun√ß√£o:')) return 'metodo';
            if (linha.includes('üìç') || linha.includes('Path:') || linha.includes('Linha:')) return 'path';
            if (linha.includes('üìÑ') || linha.includes('Arquivo:')) return 'arquivo';
            if (linha.includes('üåê') || linha.includes('URL:')) return 'url';
            if (linha.includes('üìö') || linha.includes('Stack') || linha.includes('   at ')) return 'stack';
            if (linha.includes('‚ö°') || linha.includes('Exception:')) return 'exception';
            return '';
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function limparTodosFiltros() {
            try {
                $('#tipoFiltro').val('');
                $('#buscaFiltro').val('');
                $('.stat-card').removeClass('active');
                $('.stat-card[data-filter=""]').addClass('active');
                $('#filtrosContainer').removeClass('filtro-ativo');
                $('#filtroAtivoNome').text('Todos');
                renderizarBlocos(blocosParsed);
            } catch (error) {
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "limparTodosFiltros", error);
            }
        }

        function limparLogs() {
            try {
                Swal.fire({
                    title: 'Limpar Logs?',
                    text: 'Esta a√ß√£o ir√° apagar todos os logs do dia atual.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sim, limpar!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            type: "POST",
                            url: '/api/LogErros/LimparLogs',
                            success: function (res) {
                                try {
                                    if (res.success) {
                                        AppToast.show('verde', 'Logs limpos com sucesso!', 3000);
                                        carregarLogs();
                                    } else {
                                        AppToast.show('vermelho', 'Erro ao limpar logs', 3000);
                                    }
                                } catch (error) {
                                    Alerta.TratamentoErroComLinha("LogErros.cshtml", "limparLogs.success", error);
                                }
                            },
                            error: function (err) {
                                Alerta.TratamentoErroComLinha("LogErros.cshtml", "limparLogs.error", err);
                            }
                        });
                    }
                });
            } catch (error) {
                Alerta.TratamentoErroComLinha("LogErros.cshtml", "limparLogs", error);
            }
        }
    </script>
}
