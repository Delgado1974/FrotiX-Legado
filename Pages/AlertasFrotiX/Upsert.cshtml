@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, Syncfusion.EJ2

@model FrotiX.Pages.AlertasFrotiX.UpsertModel

@{
	ViewData["Title"] = Model.AlertasFrotiXId == Guid.Empty ? "Novo Alerta" : "Editar Alerta";
	ViewData["PageName"] = "alertasfrotix_upsert";
	ViewData["Heading"] = "<i class='fa-duotone fa-bell'></i> Sistema: <span class='fw-300'>Alertas</span>";
	ViewData["Category1"] = "Alertas";
	ViewData["PageIcon"] = "fa-duotone fa-bell";
}

@section HeadBlock {
	<link rel="stylesheet" href="~/css/alertaupsert.css" asp-append-version="true" />
	<style>
		/* Estilos específicos para controles de recorrência */
		#divRecorrenciaAlerta .section-card {
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			margin-top: 1rem;
		}
		#divRecorrenciaAlerta .section-card-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 0.75rem 1rem;
			border-radius: 8px 8px 0 0;
			font-weight: 600;
		}
		#divRecorrenciaAlerta .section-card-body {
			padding: 1rem;
		}
	</style>
}

<script>
	// Captura erros globais
	window.onerror = function(msg, url, line, col, error) {
		try {
			console.error('Erro Global:', {
				mensagem: msg,
				arquivo: url,
				linha: line,
				coluna: col,
				erro: error
			});
			return true;
		} catch (err) {
			Alerta.TratamentoErroComLinha("Upsert.cshtml", "window.onerror", err);
			return true;
		}
	};

	// Monitora erros de Promise
	window.addEventListener('unhandledrejection', function(e) {
		try {
			console.error('Promise rejeitada:', e.reason);
			e.preventDefault();
		} catch (error) {
			Alerta.TratamentoErroComLinha("Upsert.cshtml", "unhandledrejection", error);
		}
	});
</script>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<!-- ===== HEADER FROTIX ===== -->
			<div class="ftx-card-header">
				<h2 class="titulo-paginas">
					<i class="fa-duotone fa-bell-plus"></i>
					@(Model.AlertasFrotiXId == Guid.Empty ? "Cadastrar Novo Alerta" : "Editar Alerta")
				</h2>
			</div>

			<div class="panel-container show">
				<div class="panel-content">
					<form id="formAlerta" method="post">
						<input type="hidden" id="AlertasFrotiXId" name="AlertasFrotiXId" value="@Model.AlertasFrotiXId" />

						<!-- Seção: Informações Básicas -->
						<div class="section-legend">
							<i class="fa-duotone fa-info-circle"></i>
							<span>Informações Básicas</span>
						</div>

						<div class="row">
							<div class="col-md-8">
								<label class="label required-field">Título do Alerta</label>
								<ejs-textbox id="Titulo" name="Titulo" placeholder="Digite o título do alerta"
											 value="@Model.Titulo"
											 floatLabelType="Never"
											 cssClass="e-outline">
								</ejs-textbox>
								<span class="text-danger field-validation-valid" data-valmsg-for="Titulo"></span>
							</div>

							<div class="col-md-4">
								<label class="label required-field">Prioridade</label>
								<ejs-dropdownlist id="Prioridade" name="Prioridade"
												  placeholder="Selecione a prioridade"
												  dataSource="@Model.PrioridadesList"
												  value="@((int)Model.Prioridade)"
												  floatLabelType="Never">
									<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
								</ejs-dropdownlist>
								<span class="text-danger field-validation-valid" data-valmsg-for="Prioridade"></span>
							</div>
						</div>

						<div class="row mt-3">
							<div class="col-md-12">
								<label class="label required-field">Descrição</label>
								<ejs-textbox id="Descricao" name="Descricao"
											 placeholder="Digite a descrição detalhada do alerta"
											 value="@Model.Descricao"
											 multiline="true"
											 rows="3"
											 floatLabelType="Never"
											 cssClass="e-outline">
								</ejs-textbox>
								<span class="text-danger field-validation-valid" data-valmsg-for="Descricao"></span>
							</div>
						</div>

						<!-- Seção: Tipo de Alerta -->
						<div class="section-legend">
							<i class="fa-duotone fa-tags"></i>
							<span>Tipo de Alerta</span>
							<span class="legend-note">(Selecione o tipo)</span>
						</div>

						<div class="row mb-3">
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="1" data-ejtip="Selecionar tipo: Agendamento">
									<i class="fa-duotone fa-calendar-check" style="color: #0ea5e9;"></i>
									<div>Agendamento</div>
									<span class="preview-badge" style="background-color: #0ea5e9;">Agendamento</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="2" data-ejtip="Selecionar tipo: Manutenção">
									<i class="fa-duotone fa-screwdriver-wrench" style="color: #f59e0b;"></i>
									<div>Manutenção</div>
									<span class="preview-badge" style="background-color: #f59e0b;">Manutenção</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="3" data-ejtip="Selecionar tipo: Motorista">
									<i class="fa-duotone fa-id-card-clip" style="color: #14b8a6;"></i>
									<div>Motorista</div>
									<span class="preview-badge" style="background-color: #14b8a6;">Motorista</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="4" data-ejtip="Selecionar tipo: Veículo">
									<i class="fa-duotone fa-car-bus" style="color: #7c3aed;"></i>
									<div>Veículo</div>
									<span class="preview-badge" style="background-color: #7c3aed;">Veículo</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="5" data-ejtip="Selecionar tipo: Anúncio">
									<i class="fa-duotone fa-bullhorn" style="color: #dc2626;"></i>
									<div>Anúncio</div>
									<span class="preview-badge" style="background-color: #dc2626;">Anúncio</span>
								</div>
							</div>
							<div class="col-lg-2 col-md-4 col-sm-6 mb-3">
								<div class="tipo-alerta-card" data-tipo="6" data-ejtip="Selecionar tipo: Diversos">
									<i class="fa-duotone fa-circle-info" style="color: #6c757d;"></i>
									<div>Diversos</div>
									<span class="preview-badge" style="background-color: #6c757d;">Diversos</span>
								</div>
							</div>
						</div>
						<input type="hidden" id="TipoAlerta" name="TipoAlerta" value="@((int)Model.TipoAlerta)" />

						<!-- Seção: Vínculos (aparece dinamicamente) -->
						<div id="secaoVinculos" style="display: none;">
							<div class="section-legend">
								<i class="fa-duotone fa-link"></i>
								<span>Vínculos</span>
								<span class="legend-note">(Opcional)</span>
							</div>

							<div class="row">
								<div class="col-md-6" id="divViagem" style="display: none;">
									<label class="label">Agendamento Relacionado</label>
									<ejs-dropdownlist id="ViagemId"
													  name="ViagemId"
													  placeholder="Selecione o agendamento"
													  dataSource="@Model.ViagensListCompleta"
													  value="@Model.ViagemId"
													  allowFiltering="true"
													  filterType="Contains"
													  floatLabelType="Never"
													  popupHeight="400px"
													  popupWidth="600px">
										<e-dropdownlist-fields text="DataInicial" value="ViagemId"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>

								<div class="col-md-6" id="divManutencao" style="display: none;">
									<label class="label">Manutenção Relacionada</label>
									<ejs-dropdownlist id="ManutencaoId" name="ManutencaoId"
													  placeholder="Selecione a manutenção"
													  dataSource="@Model.ManutencoesListCompleta"
													  value="@Model.ManutencaoId"
													  allowFiltering="true"
													  floatLabelType="Never">
										<e-dropdownlist-fields text="NumOS" value="ManutencaoId"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>

								<div class="col-md-6" id="divMotorista" style="display: none;">
									<label class="label">Motorista Relacionado</label>
									<ejs-dropdownlist id="MotoristaId" name="MotoristaId"
													  placeholder="Selecione o motorista"
													  dataSource="@Model.MotoristasList"
													  value="@Model.MotoristaId"
													  allowFiltering="true"
													  floatLabelType="Never">
										<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>

								<div class="col-md-6" id="divVeiculo" style="display: none;">
									<label class="label">Veículo Relacionado</label>
									<ejs-dropdownlist id="VeiculoId" name="VeiculoId"
													  placeholder="Selecione o veículo"
													  dataSource="@Model.VeiculosList"
													  value="@Model.VeiculoId"
													  allowFiltering="true"
													  floatLabelType="Never">
										<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
									</ejs-dropdownlist>
								</div>
							</div>
						</div>

						<!-- Seção: Configurações de Exibição -->
						<div class="section-legend">
							<i class="fa-duotone fa-clock"></i>
							<span>Configurações de Exibição</span>
						</div>

						<!-- Linha 1: Tipo de Exibição (sempre visível) -->
						<div class="row">
							<div class="col-md-4">
								<label class="label required-field">Tipo de Exibição</label>
								<ejs-dropdownlist id="TipoExibicao"
												  placeholder="Quando exibir o alerta"
												  dataSource="@Model.TipoExibicaoList"
												  value="@((int)Model.TipoExibicao)"
												  allowFiltering="true"
												  floatLabelType="Never"
												  popupHeight="300px"
												  zIndex="1000">
									<e-dropdownlist-fields text="Text" value="Value"></e-dropdownlist-fields>
								</ejs-dropdownlist>
							</div>
						</div>

						<!-- Linha 2: Campos dinâmicos de Data/Horário/Expiração -->
						<div class="row mt-3" id="rowCamposExibicao">
							<!-- Data de Exibição (TipoExibicao 3, 4, 5, 6, 7, 8) -->
							<div class="col-md-2" id="divDataExibicao" style="display: none;">
								<label class="label" id="lblDataExibicao">Data de Exibição</label>
								<ejs-datepicker id="DataExibicao"
												name="DataExibicao"
												placeholder="Selecione"
												value="@Model.DataExibicao"
												format="dd/MM/yyyy"
												floatLabelType="Never"
												locale="pt-BR">
								</ejs-datepicker>
							</div>

							<!-- Horário de Exibição (TipoExibicao 2, 3, 4, 5, 6, 7, 8) -->
							<div class="col-md-2" id="divHorarioExibicao" style="display: none;">
								<label class="label" id="lblHorarioExibicao">Horário de Exibição</label>
								<ejs-timepicker id="HorarioExibicao"
												name="HorarioExibicao"
												value="@Model.HorarioExibicao?.ToString(@"hh\:mm")"
												format="HH:mm"
												step="15"
												floatLabelType="Never"
												locale="pt-BR"
												allowEdit="false"
												placeholder="Selecione">
								</ejs-timepicker>
								<span class="text-danger field-validation-valid" data-valmsg-for="HorarioExibicao"></span>
							</div>

							<!-- Data de Expiração (Todos os tipos) -->
							<div class="col-md-2" id="divDataExpiracao" style="display: none;">
								<label class="label">Data de Expiração</label>
								<ejs-datepicker id="DataExpiracao"
												name="DataExpiracao"
												placeholder="Selecione"
												value="@Model.DataExpiracao"
												format="dd/MM/yyyy"
												floatLabelType="Never"
												locale="pt-BR">
								</ejs-datepicker>
							</div>
						</div>

						<!-- ============================================================ -->
						<!-- SEÇÃO: CONFIGURAÇÕES DE RECORRÊNCIA V2                       -->
						<!-- Controle via TipoExibicao (valores 4-8 são recorrentes)     -->
						<!-- DataExibicao = início, DataExpiracao = fim                   -->
						<!-- ============================================================ -->

						<!-- Campos de Recorrência (aparecem dinamicamente baseado em TipoExibicao) -->
						<div class="row mt-3" id="rowCamposRecorrencia">
							<!-- lstDiasAlerta - Dias da Semana (TipoExibicao = 5 Semanal ou 6 Quinzenal) -->
							<div class="col-md-6" id="divDiasAlerta" style="display: none;">
								<label class="label font-weight-bold">
									Dias da Semana
									<i class="fa-duotone fa-calendar-week field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<ejs-multiselect id="lstDiasAlerta"
												name="DiasSemana"
												placeholder="Selecione os dias..."
												mode="CheckBox"
												showSelectAll="true"
												selectAllText="Selecionar todos"
												unSelectAllText="Desmarcar todos"
												popupHeight="250px"
												floatLabelType="Never">
									<e-multiselect-fields value="Value" text="Text"></e-multiselect-fields>
								</ejs-multiselect>
							</div>

							<!-- lstDiasMesAlerta - Dia do Mês (TipoExibicao = 7 Mensal) -->
							<div class="col-md-2" id="divDiaMesAlerta" style="display: none;">
								<label class="label font-weight-bold">
									Dia do Mês
									<i class="fa-duotone fa-calendar-clock field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<ejs-dropdownlist id="lstDiasMesAlerta"
												name="DiaMesRecorrencia"
												placeholder="Selecione..."
												value="@Model.DiaMesRecorrencia"
												popupHeight="250px"
												floatLabelType="Never"
												cssClass="e-outline">
									<e-dropdownlist-fields value="Value" text="Text"></e-dropdownlist-fields>
								</ejs-dropdownlist>
							</div>
						</div>

						<!-- Calendário para Dias Variados (TipoExibicao = 8) -->
						<div class="row mt-3" id="calendarContainerAlerta" style="display: none;">
							<div class="col-md-4 col-lg-3">
								<label class="label font-weight-bold d-block mb-2">
									Selecione as Datas
									<i class="fa-duotone fa-calendar-days field-icon" style="font-size: 1.25em; cursor: pointer;"></i>
								</label>
								<div style="position: relative; display: inline-block;">
									<!-- Badge laranja no canto superior direito do calendário (40% dentro, 60% fora) -->
									<span id="badgeDatasSelecionadas" style="
										position: absolute;
										top: -10px;
										right: -10px;
										background: #ff8800;
										color: white;
										border-radius: 50%;
										width: 28px;
										height: 28px;
										display: none;
										align-items: center;
										justify-content: center;
										font-size: 12px;
										font-weight: 700;
										z-index: 100;
										box-shadow: 0 2px 4px rgba(0,0,0,0.2);
										border: 2px solid white;">0</span>
									
									<!-- Calendário Syncfusion (sem card) -->
									<div id="calDatasSelecionadasAlerta"></div>
									
									<input type="hidden" id="DatasSelecionadas" name="DatasSelecionadas" value="@Model.DatasSelecionadas" />
								</div>
							</div>
						</div>

						<!-- FIM DA SEÇÃO DE RECORRÊNCIA -->

						<!-- Seção: Destinatários -->
						<div class="section-legend">
							<i class="fa-duotone fa-users"></i>
							<span>Destinatários</span>
							<span class="legend-note">(Selecione os usuários que receberão o alerta)</span>
						</div>

						<div class="row">
							<div class="col-md-12">
								<label class="label required-field">Usuários</label>
								<ejs-multiselect id="UsuariosIds" name="UsuariosIds"
												 placeholder="Selecione os usuários"
												 dataSource="@Model.UsuariosList"
												 value="@Model.UsuariosIds"
												 mode="Box"
												 showSelectAll="true"
												 selectAllText="Selecionar Todos"
												 unSelectAllText="Desmarcar Todos"
												 floatLabelType="Never"
												 cssClass="multiselect-usuarios"
												 closePopupOnSelect="false"
												 appendTo="body">
									<e-multiselect-fields text="Text" value="Value"></e-multiselect-fields>
								</ejs-multiselect>
								<span class="text-danger field-validation-valid" data-valmsg-for="UsuariosIds"></span>
							</div>
						</div>

						<!-- Botões de Ação -->
						<div class="row mt-4">
							<div class="col-md-12 d-flex justify-content-end gap-2">
								<button type="button" class="btn btn-ftx-fechar form-control" onclick="window.location.href='/AlertasFrotiX'" data-ftx-loading>
									<i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Operação
								</button>
								<button type="submit" class="btn btn-azul btn-submit-spin form-control">
									<i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i>
									@(Model.AlertasFrotiXId == Guid.Empty ? "Criar Alerta" : "Atualizar Alerta")
								</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

@section ScriptsBlock {
	<script src="~/js/alertasfrotix/alertas_upsert.js" asp-append-version="true"></script>
	<script src="~/js/alertasfrotix/alertas_recorrencia.js" asp-append-version="true"></script>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			try {
				// ================================================================
				// INICIALIZAÇÃO DOS DROPDOWNS DE RECORRÊNCIA V2
				// Controle via TipoExibicao (não há mais Recorrente e Período)
				// ================================================================

				// DataSource para dias da semana
				var dataDiasSemana = [
					{ Text: 'Domingo', Value: 0 },
					{ Text: 'Segunda-Feira', Value: 1 },
					{ Text: 'Terça-Feira', Value: 2 },
					{ Text: 'Quarta-Feira', Value: 3 },
					{ Text: 'Quinta-Feira', Value: 4 },
					{ Text: 'Sexta-Feira', Value: 5 },
					{ Text: 'Sábado', Value: 6 }
				];

				// DataSource para dias do mês (1-31)
				var dataDiasMes = [];
				for (var i = 1; i <= 31; i++) {
					dataDiasMes.push({ Text: i.toString(), Value: i });
				}

				// Configurar lstDiasAlerta (MultiSelect)
				var lstDiasAlerta = document.getElementById('lstDiasAlerta');
				if (lstDiasAlerta && lstDiasAlerta.ej2_instances && lstDiasAlerta.ej2_instances[0]) {
					var diasMultiSelect = lstDiasAlerta.ej2_instances[0];
					diasMultiSelect.dataSource = dataDiasSemana;
					diasMultiSelect.fields = { text: 'Text', value: 'Value' };
					diasMultiSelect.dataBind();
				}

				// Configurar lstDiasMesAlerta
				var lstDiasMesAlerta = document.getElementById('lstDiasMesAlerta');
				if (lstDiasMesAlerta && lstDiasMesAlerta.ej2_instances && lstDiasMesAlerta.ej2_instances[0]) {
					var diasMesDropdown = lstDiasMesAlerta.ej2_instances[0];
					diasMesDropdown.dataSource = dataDiasMes;
					diasMesDropdown.fields = { text: 'Text', value: 'Value' };
					diasMesDropdown.value = @(Model.DiaMesRecorrencia ?? 0);
					diasMesDropdown.dataBind();
				}

				// Inicializar Calendário para datas variadas
				if (typeof initCalendarioAlerta === 'function') {
					initCalendarioAlerta();
				}

				// Verificar estado inicial (modo edição)
				// O script alertas_recorrencia.js detecta TipoExibicao automaticamente
				if (typeof verificarEstadoRecorrenciaAlerta === 'function') {
					verificarEstadoRecorrenciaAlerta();
				}

			} catch (error) {
				console.error('Erro na inicialização:', error);
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.recorrencia", error);
			}
		});
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			try {
				var timePicker = document.getElementById('HorarioExibicao').ej2_instances[0];

				if (timePicker) {
					timePicker.locale = 'pt-BR';
					timePicker.format = 'HH:mm';
					timePicker.step = 15;
					timePicker.dataBind();
				}

				timePicker.popupCreated = function(args) {
					try {
						console.log('Popup criado com sucesso');
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.popupCreated", error);
					}
				};

				timePicker.open = function(args) {
					try {
						if (args && args.popup) {
							args.popup.position = { X: 'left', Y: 'bottom' };
						}
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.open", error);
					}
				};

				timePicker.beforeOpen = function(args) {
					try {
						if (!args || !args.popup) {
							args.cancel = true;
							console.error('Popup não pode ser criado');
						}
					} catch (error) {
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.beforeOpen", error);
					}
				};

				timePicker.inputElement.addEventListener('click', function(e) {
					try {
						if (!timePicker.isPopupOpen()) {
							timePicker.show();
						}
					} catch (error) {
						console.error('Erro ao abrir TimePicker:', error);
						Alerta.TratamentoErroComLinha("Upsert.cshtml", "timePicker.inputElement.click", error);
						e.preventDefault();
					}
				});

			} catch (error) {
				console.error('Erro na inicialização:', error);
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.timePicker", error);
			}
		});
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			try {
				flatpickr("#dtpHorarioExibicao", {
					enableTime: true,
					noCalendar: true,
					dateFormat: "H:i",
					time_24hr: true,
					minuteIncrement: 15
				});
			} catch (error) {
				Alerta.TratamentoErroComLinha("Upsert.cshtml", "DOMContentLoaded.flatpickr", error);
			}
		});
	</script>
}
