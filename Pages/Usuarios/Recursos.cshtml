@page
@model FrotiX.Models.Unidade

@{
	ViewData["Title"] = "Recursos";
	ViewData["PageName"] = "usuarios_recursos";
	ViewData["Heading"] = "<i class='fa-duotone fa-book-journal-whills'></i> Cadastros: <span class='fw-300'>Recursos</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-light fa-book-journal-whills";
}

@section HeadBlock {
}

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-container show">
				<div class="panel-content float-right">
					<a href="/Usuarios/UpsertRecurso" class="btn btn-azul" aria-label="Adicionar Recurso" data-ejtip="Adicionar novo recurso ao sistema">
						<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Adicionar Recurso
					</a>
				</div>
				<div class="panel-content">
					<div class="box-body">
						<br /><br />
						<table id="tblRecurso" class="table table-bordered table-striped" width="100%">
							<thead>
								<tr>
									<th>Nome</th>
									<th>Nome Menu</th>
									<th>Ordem</th>
									<th>Ação</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@*----------------- MODAL de Usuários  ------------------------*@
@*=============================================================*@
<div class="modal fade" id="modalControleAcesso" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header modal-header-azul">
				<h3 class="modal-title" id="h3Titulo">Exibe os Usuários e seu acesso ao recurso</h3>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
			</div>
			<div class="modal-body">
				<form id="frmStatus">
					<input type="hidden" id="txtRecursoId" />
					<div class="panel-content">
						<div class="box-body">
							<br /><br />
							<table id="tblRecursos" class="table table-bordered table-striped" width="100%">
								<thead>
									<tr>
										<th>Nome Completo do Usuário</th>
										<th>Status de Acesso</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
				</form>
				<br /><br />
				<div class="modal-footer">
					<button id="btnFechar" type="button" class="btn btn-vinho form-control" data-bs-dismiss="modal">
						<i class="fa-solid fa-rotate-left icon-space icon-rotate-left"></i> Fechar
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

@section ScriptsBlock {

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script>
		(function() {
			"use strict";

			var dataTable;
			var dataTableRecursos;

			$(document).ready(function () {
				try {
					loadList();

					// Excluir recurso
					$(document).on('click', '.btn-delete', function () {
						try {
							var id = $(this).data('id');
							var $btn = $(this);

							Alerta.Confirmar(
								"Confirmar Exclusão",
								"Você tem certeza que deseja apagar este Recurso? Não será possível recuperar os dados eliminados!",
								"Sim, excluir",
								"Cancelar"
							).then(function (confirmed) {
								try {
									if (!confirmed) return;

									$btn.prop("disabled", true);

									var url = '/api/Usuario/DeleteRecurso';
									$.ajax({
										url: url,
										type: "POST",
										data: JSON.stringify(id),
										contentType: "application/json; charset=utf-8",
										dataType: "json",
										success: function (data) {
											try {
												if (data && data.success) {
													AppToast.show('Verde', data.message || "Recurso excluído com sucesso.", 2000);
													if (dataTable) {
														dataTable.ajax.reload(null, false);
													}
												} else {
													AppToast.show('Vermelho', (data && data.message) || "Falha ao excluir o recurso.", 2000);
												}
											} catch (inner) {
												Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.ajax.success", inner);
											}
										},
										error: function (err) {
											try {
												console.error(err);
												AppToast.show('Vermelho', "Algo deu errado ao excluir o recurso.", 2000);
											} catch (inner) {
												Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.ajax.error", inner);
											}
										},
										complete: function () {
											try {
												$btn.prop("disabled", false);
											} catch (inner) {
												Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.ajax.complete", inner);
											}
										}
									});
								} catch (error) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.confirmar.then", error);
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.click", error);
						}
					});

					// Toggle status do Recurso (Ativo/Inativo)
					$(document).on('click', '.updateStatusRecurso', function () {
						try {
							var url = $(this).data('url');
							var $el = $(this);

							$.get(url, function (data) {
								try {
									if (data && data.success) {
										AppToast.show('Verde', "Status alterado com sucesso!", 2000);
										var text = (data.type == 1) ? 'Inativo' : 'Ativo';
										if (data.type == 1) {
											$el.removeClass('btn-verde').addClass('fundo-cinza');
										} else {
											$el.removeClass('fundo-cinza').addClass('btn-verde');
										}
										$el.text(text);
									} else {
										AppToast.show('Vermelho', "Não foi possível alterar o status.", 2000);
									}
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusRecurso.get.success", inner);
								}
							}).fail(function () {
								try {
									AppToast.show('Vermelho', "Não foi possível alterar o status.", 2000);
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusRecurso.get.fail", inner);
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusRecurso.click", error);
						}
					});

					// Toggle de acesso do usuário ao recurso (Com Acesso / Sem Acesso)
					$(document).on('click', '.updateStatusAcesso', function () {
						try {
							var url = $(this).data('url');
							var $el = $(this);

							$.get(url, function (data) {
								try {
									if (data && data.success) {
										AppToast.show('Verde', "Status alterado com sucesso!", 2000);
										var texto = (data.type == 1) ? 'Sem Acesso' : 'Com Acesso';
										if (data.type == 1) {
											$el.removeClass('btn-verde').addClass('fundo-cinza');
										} else {
											$el.removeClass('fundo-cinza').addClass('btn-verde');
										}
										$el.text(texto);
									} else {
										AppToast.show('Vermelho', "Não foi possível alterar o status de acesso.", 2000);
									}
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusAcesso.get.success", inner);
								}
							}).fail(function () {
								try {
									AppToast.show('Vermelho', "Não foi possível alterar o status de acesso.", 2000);
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusAcesso.get.fail", inner);
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusAcesso.click", error);
						}
					});

				} catch (error) {
					Alerta.TratamentoErroComLinha("Recursos.cshtml", "document.ready", error);
				}
			});

			function loadList() {
				try {
					if ($.fn.DataTable.isDataTable('#tblRecurso')) {
						$('#tblRecurso').DataTable().destroy();
					}

					dataTable = $('#tblRecurso').DataTable({
						order: [],
						columnDefs: [
							{ targets: 0, className: "text-left", width: "30%" },
							{ targets: 1, className: "text-left", width: "20%" },
							{ targets: 2, className: "text-center", width: "8%" },
							{ targets: 3, className: "text-center", width: "8%" }
						],
						responsive: true,
						ajax: {
							url: "/api/recurso",
							type: "GET",
							datatype: "json"
						},
						columns: [
							{ data: "nome" },
							{ data: "nomeMenu" },
							{ data: "ordem" },
							{
								data: "recursoId",
								render: function (data) {
									return `
										<div class="text-center">
											<a href="/Usuarios/UpsertRecurso?id=${data}" class="btn btn-azul text-white" data-ejtip="Editar Recurso" aria-label="Editar Recurso" role="button" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;">
												<i class="far fa-edit"></i>
											</a>
											<a class="btn-delete btn btn-vinho text-white" data-ejtip="Excluir Recurso" aria-label="Excluir Recurso" role="button" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;" data-id='${data}'>
												<i class="far fa-trash-alt"></i>
											</a>
											<a class="btn btn-foto text-white btn-fundo-laranja" data-bs-toggle="modal" data-bs-target="#modalControleAcesso" data-ejtip="Controle de Acesso" aria-label="Controle de Acesso" role="button" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;" data-id='${data}'>
												<i class="fa-thin fa-diagram-successor"></i>
											</a>
										</div>`;
								}
							}
						],
						language: {
							url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
							emptyTable: "Sem Dados para Exibição"
						},
						width: "100%"
					});

				} catch (error) {
					Alerta.TratamentoErroComLinha("Recursos.cshtml", "loadList", error);
				}
			}

			// MODAL: lista de usuários x acesso ao recurso
			const modalControleAcesso = document.getElementById('modalControleAcesso');

			if (modalControleAcesso) {
				modalControleAcesso.addEventListener('shown.bs.modal', function (event) {
					try {
						var button = event.relatedTarget;
						var recursoId = button.getAttribute('data-id');

						document.getElementById('txtRecursoId').value = recursoId;

						if ($.fn.DataTable.isDataTable('#tblRecursos')) {
							$('#tblRecursos').DataTable().destroy();
						}

						dataTableRecursos = $('#tblRecursos').DataTable({
							order: [],
							columnDefs: [
								{ targets: 0, className: "text-left", width: "40%" },
								{ targets: 1, className: "text-center", width: "10%" }
							],
							responsive: true,
							ajax: {
								url: "/api/Usuario/PegaUsuariosRecurso",
								type: "GET",
								datatype: "json",
								data: { recursoId: recursoId }
							},
							columns: [
								{ data: "nomeCompleto" },
								{
									data: "acesso",
									render: function (data, type, row) {
										return data
											? `<a href="javascript:void(0)" class="updateStatusAcesso btn btn-verde text-white" data-url="/api/Usuario/UpdateStatusAcesso?IDS=${row.ids}" data-ejtip="Remover acesso" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;">Com Acesso</a>`
											: `<a href="javascript:void(0)" class="updateStatusAcesso btn fundo-cinza text-white text-bold" data-url="/api/Usuario/UpdateStatusAcesso?IDS=${row.ids}" data-ejtip="Conceder acesso" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;">Sem Acesso</a>`;
									}
								}
							],
							language: {
								url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
								emptyTable: "Sem Dados para Exibição"
							},
							width: "100%"
						});

					} catch (error) {
						Alerta.TratamentoErroComLinha("Recursos.cshtml", "modalControleAcesso.shown", error);
					}
				});

				modalControleAcesso.addEventListener('hide.bs.modal', function () {
					try {
						if ($.fn.DataTable.isDataTable('#tblRecursos')) {
							$('#tblRecursos').DataTable().destroy();
						}
						$('#tblRecursos tbody').empty();
						document.getElementById('txtRecursoId').value = '';
					} catch (error) {
						Alerta.TratamentoErroComLinha("Recursos.cshtml", "modalControleAcesso.hide", error);
					}
				});
			}
		})();
	</script>
}
