@page
@model FrotiX.Models.Unidade

@{
	ViewData["Title"] = "Recursos";
	ViewData["PageName"] = "usuarios_recursos";
	ViewData["Heading"] = "<i class='fa-duotone fa-book-journal-whills'></i> Cadastros: <span class='fw-300'>Recursos</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fa-duotone fa-book-journal-whills";
}

@section HeadBlock {
	<link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

	<style>
		/* ====== FONTE OUTFIT ====== */
		@@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap');

		/* ====== ANIMAÇÃO GLOW FROTIX ====== */
		@@keyframes buttonWiggle {
			0% { transform: translateY(0) rotate(0deg); }
			25% { transform: translateY(-2px) rotate(-1deg); }
			50% { transform: translateY(-3px) rotate(0deg); }
			75% { transform: translateY(-2px) rotate(1deg); }
			100% { transform: translateY(0) rotate(0deg); }
		}

		/* ====== VARIÁVEIS LOCAIS ====== */
		:root {
			--ftx-recurso-azul: #3D5771;
			--ftx-recurso-azul-hover: #2d4559;
		}

		/* ======== OUTLINE BRANCO NO BOTÃO DO HEADER (Padrão FrotiX) ======== */
		.ftx-card-header .btn-fundo-laranja {
			outline: 2px solid rgba(255, 255, 255, 0.5) !important;
			outline-offset: 1px;
			transition: all 0.2s ease;
		}

		.ftx-card-header .btn-fundo-laranja:hover {
			outline: 2px solid rgba(255, 255, 255, 0.8) !important;
			outline-offset: 2px;
		}

		/* ====== OVERRIDE HEADER ====== */
		.ftx-card-header .ftx-card-title {
			font-family: 'Outfit', sans-serif !important;
			font-weight: 900 !important;
			color: #fff !important;
		}

		.ftx-card-header .ftx-card-title i {
			color: #fff !important;
			--fa-primary-color: #fff !important;
			--fa-secondary-color: rgba(255,255,255,0.7) !important;
		}

		/* ====== TABELA ====== */
		#tblRecurso {
			font-size: 0.85rem;
		}

		#tblRecurso thead {
			background: linear-gradient(180deg, #3D5771 0%, #2d4559 100%);
		}

		#tblRecurso thead th {
			color: #fff !important;
			font-weight: 600;
			font-size: 0.80rem;
			text-transform: uppercase;
			letter-spacing: 0.3px;
			padding: 0.75rem 0.625rem;
			text-align: center;
			border: none !important;
			vertical-align: middle !important;
		}

		#tblRecurso tbody tr {
			transition: background-color 0.15s ease;
		}

		#tblRecurso tbody tr:hover {
			background-color: rgba(50, 93, 136, 0.06) !important;
		}

		#tblRecurso tbody td {
			padding: 0.625rem;
			vertical-align: middle !important;
			border-color: rgba(0,0,0,0.05) !important;
		}

		/* ====== BOTÕES DE AÇÃO NA TABELA - COM GLOW FROTIX ====== */
		.ftx-btn-icon {
			width: 28px;
			height: 28px;
			padding: 0 !important;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			border-radius: .375rem !important;
			border: none !important;
			color: #fff !important;
			font-size: 0.85rem;
			cursor: pointer;
			transition: all .3s ease, transform .2s ease !important;
			position: relative;
			overflow: hidden;
			margin: 1px !important;
		}

		.ftx-btn-icon:hover:not([aria-disabled="true"]) {
			transform: translateY(-2px);
			animation: buttonWiggle 0.5s ease-in-out !important;
		}

		.ftx-btn-icon:active:not([aria-disabled="true"]),
		.ftx-btn-icon:focus:not([aria-disabled="true"]) {
			transform: translateY(0) scale(1) !important;
		}

		.ftx-btn-icon i {
			font-size: var(--ftx-action-icon, 0.90rem);
			line-height: 1;
			color: #fff !important;
		}

		/* Editar - Azul com GLOW */
		.ftx-btn-editar {
			background-color: #3D5771 !important;
			box-shadow: 0 0 8px rgba(61, 87, 113, 0.5), 0 2px 4px rgba(61, 87, 113, 0.3) !important;
		}
		.ftx-btn-editar:hover:not([aria-disabled="true"]) {
			background-color: #2d4559 !important;
			box-shadow: 0 0 20px rgba(61, 87, 113, 0.8), 0 6px 12px rgba(61, 87, 113, 0.5) !important;
		}
		.ftx-btn-editar:active, .ftx-btn-editar:focus {
			box-shadow: 0 0 0 0.2rem rgba(61, 87, 113, 0.35) !important;
		}

		/* Apagar - Vinho com GLOW */
		.ftx-btn-apagar {
			background-color: #722f37 !important;
			box-shadow: 0 0 8px rgba(114, 47, 55, 0.5), 0 2px 4px rgba(114, 47, 55, 0.3) !important;
		}
		.ftx-btn-apagar:hover:not([aria-disabled="true"]) {
			background-color: #5a252c !important;
			box-shadow: 0 0 20px rgba(114, 47, 55, 0.8), 0 6px 12px rgba(114, 47, 55, 0.5) !important;
		}
		.ftx-btn-apagar:active, .ftx-btn-apagar:focus {
			box-shadow: 0 0 0 0.2rem rgba(114, 47, 55, 0.25) !important;
		}

		/* Controle Acesso - Laranja com GLOW */
		.ftx-btn-acesso {
			background-color: #d35400 !important;
			box-shadow: 0 0 8px rgba(211, 84, 0, 0.5), 0 2px 4px rgba(211, 84, 0, 0.3) !important;
		}
		.ftx-btn-acesso:hover:not([aria-disabled="true"]) {
			background-color: #b84800 !important;
			box-shadow: 0 0 20px rgba(211, 84, 0, 0.8), 0 6px 12px rgba(211, 84, 0, 0.5) !important;
		}
		.ftx-btn-acesso:active, .ftx-btn-acesso:focus {
			box-shadow: 0 0 0 0.2rem rgba(211, 84, 0, 0.35) !important;
		}

		/* ====== DATATABLE CONTROLS ====== */
		.dataTables_wrapper .dataTables_filter input {
			font-size: 0.82rem;
			height: 32px;
			padding: 0.25rem 0.5rem;
			border-radius: 6px;
		}

		.dataTables_wrapper .dataTables_length select {
			font-size: 0.82rem;
			height: 32px;
			padding: 0.15rem 0.35rem;
			border-radius: 6px;
		}

		.dataTables_wrapper .dataTables_info,
		.dataTables_wrapper .dataTables_paginate,
		.dataTables_wrapper .dataTables_length label,
		.dataTables_wrapper .dataTables_filter label {
			font-size: 0.80rem;
		}

		/* ====== RESPONSIVIDADE ====== */
		@@media (max-width: 768px) {
			.ftx-card-header {
				flex-direction: column;
				align-items: stretch;
				text-align: center;
			}
		}
	</style>
}

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel ftx-card-styled">
			<div class="panel-container show">

				<!-- Header Padrão FrotiX -->
				<div class="ftx-card-header">
					<h2 class="titulo-paginas">
						<i class="fa-duotone fa-book-journal-whills"></i>
						Cadastros: Recursos
					</h2>
					<div class="ftx-card-actions">
						<a href="/Usuarios/UpsertRecurso" class="btn btn-fundo-laranja" data-ftx-loading>
							<i class="fa-duotone fa-clone-plus icon-pulse me-1"></i>
							Adicionar Recurso
						</a>
					</div>
				</div>

				<!-- Tabela -->
				<div class="panel-content">
					<div id="divRecursos">
						<table id="tblRecurso" class="table table-bordered table-striped ftx-table" width="100%">
							<thead>
								<tr>
									<th>Nome</th>
									<th>Nome Menu</th>
									<th>Ordem</th>
									<th>Ação</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
				</div>

			</div>
		</div>
	</div>
</div>

@*----------------- MODAL de Usuários  ------------------------*@
@*=============================================================*@
<div class="modal fade" id="modalControleAcesso" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header modal-header-azul">
				<h3 class="modal-title" id="h3Titulo">Exibe os Usuários e seu acesso ao recurso</h3>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
			</div>
			<div class="modal-body">
				<form id="frmStatus">
					<input type="hidden" id="txtRecursoId" />
					<div class="panel-content">
						<div class="box-body">
							<br /><br />
							<table id="tblRecursos" class="table table-bordered table-striped" width="100%">
								<thead>
									<tr>
										<th>Nome Completo do Usuário</th>
										<th>Status de Acesso</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div>
				</form>
				<br /><br />
				<div class="modal-footer">
					<button id="btnFechar" type="button" class="btn btn-vinho form-control" data-bs-dismiss="modal">
						<i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Fechar
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

@section ScriptsBlock {

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script>
		(function() {
			"use strict";

			var dataTable;
			var dataTableRecursos;

			$(document).ready(function () {
				try {
					loadList();

					// Excluir recurso
					$(document).on('click', '.btn-delete', function () {
						try {
							var id = $(this).data('id');
							var $btn = $(this);

							Alerta.Confirmar(
								"Confirmar Exclusão",
								"Você tem certeza que deseja apagar este Recurso? Não será possível recuperar os dados eliminados!",
								"Sim, excluir",
								"Cancelar"
							).then(function (confirmed) {
								try {
									if (!confirmed) return;

									$btn.prop("disabled", true);

									var url = '/api/Usuario/DeleteRecurso';
									$.ajax({
										url: url,
										type: "POST",
										data: JSON.stringify(id),
										contentType: "application/json; charset=utf-8",
										dataType: "json",
										success: function (data) {
											try {
												if (data && data.success) {
													AppToast.show('Verde', data.message || "Recurso excluído com sucesso.", 2000);
													if (dataTable) {
														dataTable.ajax.reload(null, false);
													}
												} else {
													AppToast.show('Vermelho', (data && data.message) || "Falha ao excluir o recurso.", 2000);
												}
											} catch (inner) {
												Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.ajax.success", inner);
											}
										},
										error: function (err) {
											try {
												console.error(err);
												AppToast.show('Vermelho', "Algo deu errado ao excluir o recurso.", 2000);
											} catch (inner) {
												Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.ajax.error", inner);
											}
										},
										complete: function () {
											try {
												$btn.prop("disabled", false);
											} catch (inner) {
												Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.ajax.complete", inner);
											}
										}
									});
								} catch (error) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.confirmar.then", error);
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "btn-delete.click", error);
						}
					});

					// Toggle status do Recurso (Ativo/Inativo)
					$(document).on('click', '.updateStatusRecurso', function () {
						try {
							var url = $(this).data('url');
							var $el = $(this);

							$.get(url, function (data) {
								try {
									if (data && data.success) {
										AppToast.show('Verde', "Status alterado com sucesso!", 2000);
										var text = (data.type == 1) ? 'Inativo' : 'Ativo';
										if (data.type == 1) {
											$el.removeClass('btn-verde').addClass('fundo-cinza');
										} else {
											$el.removeClass('fundo-cinza').addClass('btn-verde');
										}
										$el.text(text);
									} else {
										AppToast.show('Vermelho', "Não foi possível alterar o status.", 2000);
									}
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusRecurso.get.success", inner);
								}
							}).fail(function () {
								try {
									AppToast.show('Vermelho', "Não foi possível alterar o status.", 2000);
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusRecurso.get.fail", inner);
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusRecurso.click", error);
						}
					});

					// Toggle de acesso do usuário ao recurso (Com Acesso / Sem Acesso)
					$(document).on('click', '.updateStatusAcesso', function () {
						try {
							var url = $(this).data('url');
							var $el = $(this);

							$.get(url, function (data) {
								try {
									if (data && data.success) {
										AppToast.show('Verde', "Status alterado com sucesso!", 2000);
										var texto = (data.type == 1) ? 'Sem Acesso' : 'Com Acesso';
										if (data.type == 1) {
											$el.removeClass('btn-verde').addClass('fundo-cinza');
										} else {
											$el.removeClass('fundo-cinza').addClass('btn-verde');
										}
										$el.text(texto);
									} else {
										AppToast.show('Vermelho', "Não foi possível alterar o status de acesso.", 2000);
									}
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusAcesso.get.success", inner);
								}
							}).fail(function () {
								try {
									AppToast.show('Vermelho', "Não foi possível alterar o status de acesso.", 2000);
								} catch (inner) {
									Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusAcesso.get.fail", inner);
								}
							});
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "updateStatusAcesso.click", error);
						}
					});

					// Abrir modal de Controle de Acesso (elementos dinâmicos)
					$(document).on('click', '.ftx-btn-acesso', function (e) {
						try {
							e.preventDefault();
							var recursoId = $(this).data('id');
							$('#txtRecursoId').val(recursoId);
							var modal = new bootstrap.Modal(document.getElementById('modalControleAcesso'));
							modal.show();
						} catch (error) {
							Alerta.TratamentoErroComLinha("Recursos.cshtml", "ftx-btn-acesso.click", error);
						}
					});

				} catch (error) {
					Alerta.TratamentoErroComLinha("Recursos.cshtml", "document.ready", error);
				}
			});

			function loadList() {
				try {
					if ($.fn.DataTable.isDataTable('#tblRecurso')) {
						$('#tblRecurso').DataTable().destroy();
					}

					dataTable = $('#tblRecurso').DataTable({
						order: [],
						columnDefs: [
							{ targets: 0, className: "text-left", width: "30%" },
							{ targets: 1, className: "text-left", width: "20%" },
							{ targets: 2, className: "text-center", width: "8%" },
							{ targets: 3, className: "text-center", width: "8%" }
						],
						responsive: true,
						ajax: {
							url: "/api/recurso",
							type: "GET",
							datatype: "json"
						},
						columns: [
							{ data: "nome" },
							{ data: "nomeMenu" },
							{ data: "ordem" },
							{
								data: "recursoId",
								render: function (data) {
									return `
										<div class="text-center">
											<a href="/Usuarios/UpsertRecurso?id=${data}" class="btn ftx-btn-icon ftx-btn-editar" data-ejtip="Editar Recurso" aria-label="Editar Recurso" role="button">
												<i class="fa-duotone fa-edit"></i>
											</a>
											<a class="btn-delete btn ftx-btn-icon ftx-btn-apagar" data-ejtip="Excluir Recurso" aria-label="Excluir Recurso" role="button" data-id='${data}'>
												<i class="fa-duotone fa-trash-alt"></i>
											</a>
											<a class="btn ftx-btn-icon ftx-btn-acesso" data-ejtip="Controle de Acesso" aria-label="Controle de Acesso" role="button" data-id='${data}'>
												<i class="fa-duotone fa-users-gear"></i>
											</a>
										</div>`;
								}
							}
						],
						language: {
							url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
							emptyTable: "Sem Dados para Exibição"
						},
						width: "100%"
					});

				} catch (error) {
					Alerta.TratamentoErroComLinha("Recursos.cshtml", "loadList", error);
				}
			}

			// MODAL: lista de usuários x acesso ao recurso
			const modalControleAcesso = document.getElementById('modalControleAcesso');

			if (modalControleAcesso) {
				modalControleAcesso.addEventListener('shown.bs.modal', function (event) {
					try {
						// Pega o recursoId do campo hidden (já definido antes de abrir o modal)
						var recursoId = document.getElementById('txtRecursoId').value;

						if ($.fn.DataTable.isDataTable('#tblRecursos')) {
							$('#tblRecursos').DataTable().destroy();
						}

						dataTableRecursos = $('#tblRecursos').DataTable({
							order: [],
							columnDefs: [
								{ targets: 0, className: "text-left", width: "40%" },
								{ targets: 1, className: "text-center", width: "10%" }
							],
							responsive: true,
							ajax: {
								url: "/api/Usuario/PegaUsuariosRecurso",
								type: "GET",
								datatype: "json",
								data: { recursoId: recursoId }
							},
							columns: [
								{ data: "nomeCompleto" },
								{
									data: "acesso",
									render: function (data, type, row) {
										return data
											? `<a href="javascript:void(0)" class="updateStatusAcesso btn btn-verde text-white" data-url="/api/Usuario/UpdateStatusAcesso?IDS=${row.ids}" data-ejtip="Remover acesso" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;">Com Acesso</a>`
											: `<a href="javascript:void(0)" class="updateStatusAcesso btn fundo-cinza text-white text-bold" data-url="/api/Usuario/UpdateStatusAcesso?IDS=${row.ids}" data-ejtip="Conceder acesso" style="cursor:pointer; padding: 2px 6px !important; font-size: 12px !important; margin: 1px !important;">Sem Acesso</a>`;
									}
								}
							],
							language: {
								url: "https://cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
								emptyTable: "Sem Dados para Exibição"
							},
							width: "100%"
						});

					} catch (error) {
						Alerta.TratamentoErroComLinha("Recursos.cshtml", "modalControleAcesso.shown", error);
					}
				});

				modalControleAcesso.addEventListener('hide.bs.modal', function () {
					try {
						if ($.fn.DataTable.isDataTable('#tblRecursos')) {
							$('#tblRecursos').DataTable().destroy();
						}
						$('#tblRecursos tbody').empty();
						document.getElementById('txtRecursoId').value = '';
					} catch (error) {
						Alerta.TratamentoErroComLinha("Recursos.cshtml", "modalControleAcesso.hide", error);
					}
				});
			}
		})();
	</script>
}
