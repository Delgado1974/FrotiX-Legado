@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Usuarios.UpsertModel

@{
    ViewData["Title"] = "Usuários";
    ViewData["PageName"] = "Usuarios_upsert";
    ViewData["Heading"] = "<i class='fa-duotone fa-users'></i> Cadastros: <span class='fw-300'>Usuários</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-users";

    var isEdicao = Model.UsuarioObj?.AspNetUsers?.Id != null;
    var statusChecked = Model.UsuarioObj?.AspNetUsers?.Status == true;
    var detentorChecked = Model.UsuarioObj?.AspNetUsers?.DetentorCargaPatrimonial == true;
    var fotoBase64 = Model.UsuarioObj?.AspNetUsers?.Foto != null 
        ? Convert.ToBase64String(Model.UsuarioObj.AspNetUsers.Foto) 
        : null;
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        .form-control-sm {
            height: calc(1.5em + .5rem + 2px);
            padding: .25rem .5rem;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .25rem;
        }

        .label-ftx {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* Checkbox Switch Estilizado */
        .ftx-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 0.75rem;
        }

        .ftx-switch input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ftx-switch-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: linear-gradient(135deg, #94a3b8, #cbd5e1);
            border-radius: 26px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .ftx-switch-slider::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .ftx-switch input:checked + .ftx-switch-slider {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .ftx-switch input:checked + .ftx-switch-slider::before {
            transform: translateX(24px);
        }

        .ftx-switch-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .ftx-switch:hover .ftx-switch-slider {
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }

        /* ====== SEÇÃO DE FOTO (Padrão Encarregado) ====== */
        .ftx-foto-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .ftx-foto-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #3D5771;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .ftx-foto-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ftx-foto-upload {
            width: 100%;
        }

        .ftx-foto-upload .form-control {
            font-size: 0.8rem;
            padding: 0.35rem 0.5rem;
        }

        .foto-container {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(180deg, #f8f9fa, #fff);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
    </style>
}

<form method="post" asp-action="Upsert" enctype="multipart/form-data">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel ftx-card-styled">
                <div class="panel-container show">

                    <!-- Header Padrão FrotiX -->
                    <div class="ftx-card-header d-flex justify-content-between align-items-center">
                        <h2 class="titulo-paginas mb-0">
                            <i class="fa-duotone fa-user-pen"></i>
                            @(isEdicao ? "Editar" : "Criar") Usuário
                        </h2>
                        <a asp-page="./Index" class="btn btn-header-orange" data-ftx-loading>
                            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar à Lista
                        </a>
                    </div>

                    <div class="panel-content">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        @if (isEdicao)
                        {
                            <input type="hidden" asp-for="UsuarioObj.AspNetUsers.Id" />
                        }

                        <div class="row">
                            <!-- Coluna dos Dados -->
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <!-- Ponto -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.Ponto">Ponto</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.Ponto"></span>
                                            <input id="txtPonto" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.Ponto" placeholder="Ex: p_12345" />
                                        </div>
                                    </div>

                                    <!-- Nome Completo -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.NomeCompleto">Nome Completo</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.NomeCompleto"></span>
                                            <input id="txtNomeCompleto" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.NomeCompleto" placeholder="Nome completo" />
                                        </div>
                                    </div>

                                    <!-- Ramal -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.Ramal">Ramal</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.Ramal"></span>
                                            <input id="txtRamal" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.Ramal" placeholder="1234" type="number" min="0" max="99999" />
                                        </div>
                                    </div>

                                    <!-- Login (UserName) -->
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.UserName">Login</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.UserName"></span>
                                            <input id="txtUserName" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.UserName" disabled style="background-color: #e9ecef;" />
                                        </div>
                                    </div>

                                    <!-- Email -->
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.Email">Email</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.Email"></span>
                                            <input id="txtEmail" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.Email" placeholder="usuario@camara.leg.br" />
                                        </div>
                                    </div>

                                    <!-- Celular -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.PhoneNumber">Celular</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.PhoneNumber"></span>
                                            <input id="txtCelular" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.PhoneNumber" placeholder="(xx) xxxx-xxxx" maxlength="14" />
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-3" />

                                <!-- Checkboxes com Switch Estilizado -->
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label class="ftx-switch">
                                            <input type="hidden" name="UsuarioObj.AspNetUsers.Status" value="false" />
                                            <input type="checkbox" 
                                                   id="chkStatus" 
                                                   name="UsuarioObj.AspNetUsers.Status" 
                                                   value="true" 
                                                   @(statusChecked ? "checked" : "") />
                                            <span class="ftx-switch-slider"></span>
                                            <span class="ftx-switch-label">Status (Ativo/Inativo)</span>
                                        </label>
                                    </div>

                                    <div class="col-md-7">
                                        <label class="ftx-switch">
                                            <input type="hidden" name="UsuarioObj.AspNetUsers.DetentorCargaPatrimonial" value="false" />
                                            <input type="checkbox" 
                                                   id="chkDetentorCarga" 
                                                   name="UsuarioObj.AspNetUsers.DetentorCargaPatrimonial" 
                                                   value="true" 
                                                   @(detentorChecked ? "checked" : "") />
                                            <span class="ftx-switch-slider"></span>
                                            <span class="ftx-switch-label">Detentor de Carga Patrimonial</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna da Foto (à direita) - Padrão Encarregado -->
                            <div class="col-md-4">
                                <div class="foto-container">
                                    <h6 class="label-ftx mb-3">
                                        <i class="fa-duotone fa-camera me-1"></i> Foto do Usuário
                                    </h6>
                                    <div class="ftx-foto-section">
                                        <div class="ftx-foto-container">
                                            @if (fotoBase64 != null)
                                            {
                                                <img id="imgPreview" src="data:image/png;base64,@fotoBase64" alt="Foto do Usuário" />
                                            }
                                            else
                                            {
                                                <img id="imgPreview" src="/Images/sucesso_transparente.png" alt="Foto do Usuário" />
                                            }
                                        </div>
                                        <div class="ftx-foto-upload">
                                            <input class="form-control" 
                                                   id="inputFoto" 
                                                   type="file" 
                                                   accept="image/*" 
                                                   name="FotoUpload" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Botões de Ação -->
                        <div class="d-flex gap-2">
                            @if (isEdicao)
                            {
                                <button type="submit"
                                        asp-page-handler="Edit"
                                        asp-route-id="@Model.UsuarioObj.AspNetUsers.Id"
                                        class="btn btn-azul btn-submit-spin"
                                        data-ejtip="Atualizar dados do usuário">
                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Atualizar Usuário
                                </button>
                            }
                            else
                            {
                                <button type="submit"
                                        asp-page-handler="Submit"
                                        class="btn btn-azul btn-submit-spin"
                                        data-ejtip="Criar novo usuário">
                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Criar Usuário
                                </button>
                            }

                            <a asp-page="./Index" class="btn btn-ftx-fechar" data-ftx-loading>
                                <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Operação
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section ScriptsBlock {
    <script>
        (function () {
            "use strict";

            try {
                // =====================================================
                // PREVIEW DA FOTO (Padrão Encarregado - Simples)
                // =====================================================
                const inputFoto = document.getElementById('inputFoto');
                const imgPreview = document.getElementById('imgPreview');

                // Preview da foto ao selecionar arquivo
                if (inputFoto) {
                    inputFoto.addEventListener('change', function (e) {
                        try {
                            const files = e.target.files;
                            if (files && files[0]) {
                                imgPreview.src = window.URL.createObjectURL(files[0]);
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "inputFoto.change", error);
                        }
                    });
                }

                // =====================================================
                // FUNÇÃO: Converter para Camel Case (exceto conectores)
                // =====================================================
                function toCamelCase(str) {
                    // Lista de conectores que devem permanecer em minúsculo
                    const conectores = ['da', 'de', 'do', 'das', 'dos', 'e', 'ou', 'a', 'o', 'as', 'os', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com'];

                    return str
                        .toLowerCase()
                        .split(' ')
                        .map(function (palavra, index) {
                            if (!palavra) return '';
                            // Primeira palavra sempre em Camel Case, demais verificar se é conector
                            if (index === 0 || !conectores.includes(palavra)) {
                                return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                            }
                            return palavra;
                        })
                        .join(' ');
                }

                // =====================================================
                // VALIDAÇÃO: Nome Completo em Camel Case
                // =====================================================
                const txtNomeCompleto = document.getElementById('txtNomeCompleto');
                if (txtNomeCompleto) {
                    txtNomeCompleto.addEventListener('blur', function () {
                        try {
                            const valor = txtNomeCompleto.value.trim();
                            if (valor) {
                                txtNomeCompleto.value = toCamelCase(valor);
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtNomeCompleto.blur", error);
                        }
                    });
                }

                // =====================================================
                // VALIDAÇÃO: Ponto com prefixo p_ (minúsculo) seguido de números
                // =====================================================
                const txtPonto = document.getElementById('txtPonto');
                const txtUserName = document.getElementById('txtUserName');

                if (txtPonto && txtUserName) {
                    txtPonto.addEventListener('blur', function () {
                        try {
                            let valor = txtPonto.value.trim().toLowerCase();

                            if (valor) {
                                // Remove qualquer prefixo p_ ou P_ existente
                                valor = valor.replace(/^[pP]_/, '');
                                
                                // Remove tudo que não é número
                                valor = valor.replace(/\D/g, '');
                                
                                // Se tiver números, formata como p_XXXX
                                if (valor.length > 0) {
                                    valor = 'p_' + valor;
                                } else {
                                    valor = '';
                                }
                            }

                            txtPonto.value = valor;
                            txtUserName.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtPonto.blur", error);
                        }
                    });

                    txtPonto.addEventListener('input', function () {
                        try {
                            let valor = txtPonto.value.trim().toLowerCase();
                            
                            // Remove qualquer prefixo p_ ou P_ existente
                            valor = valor.replace(/^[pP]_/, '');
                            
                            // Remove tudo que não é número
                            valor = valor.replace(/\D/g, '');
                            
                            // Se tiver números, formata como p_XXXX
                            if (valor.length > 0) {
                                valor = 'p_' + valor;
                            } else {
                                valor = '';
                            }

                            txtPonto.value = valor;
                            txtUserName.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtPonto.input", error);
                        }
                    });
                }

                // =====================================================
                // VALIDAÇÃO: Email obrigatoriamente terminando em @@camara.leg.br
                // =====================================================
                const txtEmail = document.getElementById('txtEmail');
                if (txtEmail) {
                    txtEmail.addEventListener('blur', function () {
                        try {
                            let valor = txtEmail.value.trim().toLowerCase();

                            if (valor) {
                                // Remove @@camara.leg.br se já existir para evitar duplicação
                                valor = valor.replace(/@@camara\.leg\.br$/i, '');
                                // Remove qualquer @@ que possa existir no final
                                valor = valor.replace(/@@+$/, '');
                                
                                // Valida se tem conteúdo antes do @@
                                if (valor.length > 0) {
                                    // Adiciona o domínio obrigatório
                                    valor = valor + '@@camara.leg.br';
                                } else {
                                    // Se não tiver conteúdo, limpa o campo
                                    valor = '';
                                }
                                
                                txtEmail.value = valor;
                                
                                // Valida formato final
                                const regex = /^[^@@]+@@camara\.leg\.br$/;
                                if (valor && !regex.test(valor)) {
                                    txtEmail.classList.add('is-invalid');
                                } else {
                                    txtEmail.classList.remove('is-invalid');
                                }
                            } else {
                                txtEmail.classList.add('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtEmail.blur", error);
                        }
                    });

                    // Força minúsculo enquanto digita
                    txtEmail.addEventListener('input', function () {
                        try {
                            txtEmail.value = txtEmail.value.toLowerCase();
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtEmail.input", error);
                        }
                    });
                }

                // =====================================================
                // VALIDAÇÃO: Celular com máscara (xx) xxxx-xxxx
                // =====================================================
                const txtCelular = document.getElementById('txtCelular');
                if (txtCelular) {
                    txtCelular.addEventListener('input', function (e) {
                        try {
                            // Remove tudo que não é número
                            let valor = txtCelular.value.replace(/\D/g, '');

                            // Limita a 10 dígitos
                            valor = valor.substring(0, 10);

                            // Aplica a máscara (xx) xxxx-xxxx
                            if (valor.length > 6) {
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2, 6) + '-' + valor.substring(6);
                            } else if (valor.length > 2) {
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2);
                            } else if (valor.length > 0) {
                                valor = '(' + valor;
                            }

                            txtCelular.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtCelular.input", error);
                        }
                    });

                    // Valida formato completo ao sair do campo
                    txtCelular.addEventListener('blur', function () {
                        try {
                            const valor = txtCelular.value;
                            const regex = /^\(\d{2}\) \d{4}-\d{4}$/;

                            if (valor && !regex.test(valor)) {
                                txtCelular.classList.add('is-invalid');
                            } else {
                                txtCelular.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtCelular.blur", error);
                        }
                    });
                }

                // =====================================================
                // ANIMAÇÃO: Spinning nos botões de submit ao clicar
                // =====================================================
                document.querySelectorAll('.btn-submit-spin').forEach(function (btn) {
                    btn.addEventListener('click', function () {
                        try {
                            const icon = btn.querySelector('i');
                            if (icon) {
                                // Remove pulse e adiciona spin
                                icon.classList.remove('icon-pulse');
                                icon.classList.add('icon-spin');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btn-submit-spin.click", error);
                        }
                    });
                });

            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "script.init", error);
            }
        })();
    </script>
}
