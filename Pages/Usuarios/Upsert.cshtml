@*
 * ╔══════════════════════════════════════════════════════════════════════════╗
 * ║                                                                          ║
 * ║  DOCUMENTACAO DISPONIVEL                                                 ║
 * ║                                                                          ║
 * ║  Este arquivo esta completamente documentado em:                         ║
 * ║  Documentacao/Pages/Usuarios - Upsert.md                                 ║
 * ║                                                                          ║
 * ║  A documentacao inclui:                                                  ║
 * ║  - Visao geral da funcionalidade                                         ║
 * ║  - Explicacao detalhada de cada metodo                                   ║
 * ║  - Interconexoes com outros arquivos                                     ║
 * ║  - Exemplos de uso                                                       ║
 * ║  - Troubleshooting                                                       ║
 * ║                                                                          ║
 * ║  Ultima atualizacao: 11/01/2026                                          ║
 * ║                                                                          ║
 * ╚══════════════════════════════════════════════════════════════════════════╝
 *@

@page
@addTagHelper*, Microsoft.AspNetCore.Mvc.TagHelpers

@model FrotiX.Pages.Usuarios.UpsertModel

@{
    ViewData["Title"] = "Usuários";
    ViewData["PageName"] = "Usuarios_upsert";
    ViewData["Heading"] = "<i class='fa-duotone fa-users'></i> Cadastros: <span class='fw-300'>Usuários</span>";
    ViewData["Category1"] = "Cadastros";
    ViewData["PageIcon"] = "fa-duotone fa-users";

    var isEdicao = Model.UsuarioObj?.AspNetUsers?.Id != null;
    var statusChecked = isEdicao ? (Model.UsuarioObj?.AspNetUsers?.Status == true) : true; // Novo usuário começa Ativo
    var detentorChecked = Model.UsuarioObj?.AspNetUsers?.DetentorCargaPatrimonial == true;
    var fotoBase64 = Model.UsuarioObj?.AspNetUsers?.Foto != null 
        ? Convert.ToBase64String(Model.UsuarioObj.AspNetUsers.Foto) 
        : null;
}

@section HeadBlock {
    <link href="~/css/ftx-card-styled.css" rel="stylesheet" asp-append-version="true" />

    <style>
        .form-control-sm {
            height: calc(1.5em + .5rem + 2px);
            padding: .25rem .5rem;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .25rem;
        }

        .label-ftx {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* Checkbox Switch Estilizado */
        .ftx-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 0.75rem;
        }

        .ftx-switch input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ftx-switch-slider {
            position: relative;
            width: 50px;
            height: 26px;
            background: linear-gradient(135deg, #94a3b8, #cbd5e1);
            border-radius: 26px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .ftx-switch-slider::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .ftx-switch input:checked + .ftx-switch-slider {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .ftx-switch input:checked + .ftx-switch-slider::before {
            transform: translateX(24px);
        }

        .ftx-switch-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .ftx-switch:hover .ftx-switch-slider {
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }

        /* ====== SEÇÃO DE FOTO - Dropzone Estilizado ====== */
        .ftx-foto-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .ftx-foto-container {
            position: relative !important;
            width: 180px;
            height: 180px;
            border-radius: 12px;
            overflow: visible !important; /* Permite o botão sair da área */
            border: 3px solid #3D5771;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #fff;
        }

        .ftx-foto-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 9px; /* Arredonda a imagem para não vazar */
        }

        /* Botão de Limpar Foto (lixeira) - 40% dentro, 60% fora */
        /* Por padrão, o botão está COMPLETAMENTE OCULTO - múltiplas camadas de proteção */
        .ftx-foto-container .ftx-foto-clear {
            position: absolute !important;
            bottom: -14px !important;  /* 40% dentro = 14.4px */
            right: -22px !important;   /* 60% fora = 21.6px */
            width: 36px !important;
            height: 36px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #722F37, #8B3A3A) !important;
            border: 3px solid #fff !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25) !important;
            display: none !important; /* OCULTO por padrão */
            visibility: hidden !important; /* Backup: oculta mesmo se display falhar */
            opacity: 0 !important; /* Backup: torna invisível */
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            z-index: 999 !important;
            margin: 0 !important;
            padding: 0 !important;
            top: auto !important;
            left: auto !important;
        }

        /* Só mostra quando tiver a classe show - remove TODAS as proteções */
        .ftx-foto-container .ftx-foto-clear.show {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .ftx-foto-clear:hover {
            background: linear-gradient(135deg, #8B3A3A, #A04040);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }

        .ftx-foto-clear i {
            color: #fff;
            font-size: 0.9rem;
        }

        /* Dropzone Visual Elegante */
        .ftx-dropzone {
            position: relative;
            width: 100%;
            cursor: pointer;
        }

        /* Esconde completamente o input file nativo (incluindo texto "Nenhum arquivo escolhido") */
        .ftx-dropzone-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .ftx-dropzone-input::-webkit-file-upload-button {
            visibility: hidden;
        }

        .ftx-dropzone-input::file-selector-button {
            visibility: hidden;
        }

        .ftx-dropzone-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transition: all 0.3s ease;
        }

        .ftx-dropzone:hover .ftx-dropzone-area {
            border-color: #3D5771;
            background: linear-gradient(135deg, #e8f4fc 0%, #dbeafe 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(61, 87, 113, 0.15);
        }

        .ftx-dropzone-icon {
            font-size: 2rem;
            color: #3D5771;
            margin-bottom: 0.5rem;
            --fa-primary-color: #3D5771;
            --fa-secondary-color: #6b8ba3;
            --fa-secondary-opacity: 0.7;
        }

        .ftx-dropzone-text {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
            font-weight: 500;
        }

        .ftx-dropzone-hint {
            font-size: 0.75rem;
            color: #94a3b8;
            margin: 0.25rem 0 0 0;
        }

        /* Estado com arquivo selecionado */
        .ftx-dropzone.has-file .ftx-dropzone-area {
            border-color: #22c55e;
            border-style: solid;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .ftx-dropzone.has-file .ftx-dropzone-icon {
            color: #22c55e;
            --fa-primary-color: #22c55e;
            --fa-secondary-color: #86efac;
        }

        .ftx-dropzone.has-file .ftx-dropzone-text {
            color: #166534;
        }

        .foto-container {
            text-align: center;
            padding: 1.25rem;
            background: linear-gradient(180deg, #f8f9fa, #fff);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
    </style>
}

<form method="post" enctype="multipart/form-data">
    <div class="row">
        <div class="col-xl-12">
            <div id="panel-1" class="panel ftx-card-styled">
                <div class="panel-container show">

                    <!-- Header Padrão FrotiX -->
                    <div class="ftx-card-header d-flex justify-content-between align-items-center">
                        <h2 class="titulo-paginas mb-0">
                            <i class="fa-duotone fa-user-pen"></i>
                            @(isEdicao ? "Editar" : "Criar") Usuário
                        </h2>
                        <a asp-page="./Index" class="btn btn-header-orange" data-ftx-loading>
                            <i class="fa-duotone fa-rotate-left icon-space icon-rotate-left"></i> Voltar à Lista
                        </a>
                    </div>

                    <div class="panel-content">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        @if (isEdicao)
                        {
                            <input type="hidden" asp-for="UsuarioObj.AspNetUsers.Id" />
                        }

                        <div class="row">
                            <!-- Coluna dos Dados -->
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <!-- Ponto -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.Ponto">Ponto</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.Ponto"></span>
                                            <input id="txtPonto" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.Ponto" placeholder="Ex: p_1234567890" maxlength="12" />
                                        </div>
                                    </div>

                                    <!-- Nome Completo -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.NomeCompleto">Nome Completo</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.NomeCompleto"></span>
                                            <input id="txtNomeCompleto" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.NomeCompleto" placeholder="Nome completo" maxlength="80" />
                                        </div>
                                    </div>

                                    <!-- Ramal -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.Ramal">Ramal</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.Ramal"></span>
                                            <input id="txtRamal" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.Ramal" placeholder="12345678" type="text" maxlength="8" inputmode="numeric" pattern="[1-9][0-9]{7}" />
                                        </div>
                                    </div>

                                    <!-- Login (UserName) -->
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.UserName">Login</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.UserName"></span>
                                            <input id="txtUserName" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.UserName" disabled style="background-color: #e9ecef;" />
                                        </div>
                                    </div>

                                    <!-- Email -->
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.Email">Email</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.Email"></span>
                                            <input id="txtEmail" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.Email" placeholder="usuario@camara.leg.br" maxlength="256" />
                                        </div>
                                    </div>

                                    <!-- Celular -->
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label class="label-ftx" asp-for="UsuarioObj.AspNetUsers.PhoneNumber">Celular</label>
                                            <span class="text-danger" asp-validation-for="UsuarioObj.AspNetUsers.PhoneNumber"></span>
                                            <input id="txtCelular" class="form-control form-control-sm" asp-for="UsuarioObj.AspNetUsers.PhoneNumber" placeholder="(xx) xxxx-xxxx" maxlength="14" />
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-3" />

                                <!-- Checkboxes com Switch Estilizado -->
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label class="ftx-switch">
                                            <input type="hidden" name="UsuarioObj.AspNetUsers.Status" value="false" />
                                            <input type="checkbox" 
                                                   id="chkStatus" 
                                                   name="UsuarioObj.AspNetUsers.Status" 
                                                   value="true" 
                                                   @(statusChecked ? "checked" : "") />
                                            <span class="ftx-switch-slider"></span>
                                            <span class="ftx-switch-label">Status (Ativo/Inativo)</span>
                                        </label>
                                    </div>

                                    <div class="col-md-7">
                                        <label class="ftx-switch">
                                            <input type="hidden" name="UsuarioObj.AspNetUsers.DetentorCargaPatrimonial" value="false" />
                                            <input type="checkbox" 
                                                   id="chkDetentorCarga" 
                                                   name="UsuarioObj.AspNetUsers.DetentorCargaPatrimonial" 
                                                   value="true" 
                                                   @(detentorChecked ? "checked" : "") />
                                            <span class="ftx-switch-slider"></span>
                                            <span class="ftx-switch-label">Detentor de Carga Patrimonial</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna da Foto (à direita) -->
                            <div class="col-md-4">
                                <div class="foto-container">
                                    <h6 class="label-ftx mb-3">
                                        <i class="fa-duotone fa-camera me-1"></i> Foto do Usuário
                                    </h6>
                                    <div class="ftx-foto-section">
                                        <!-- Preview da Foto com Botão de Limpar -->
                                        <div class="ftx-foto-container">
                                            @if (fotoBase64 != null)
                                            {
                                                <img id="imgPreview" src="data:image/png;base64,@fotoBase64" alt="Foto do Usuário" />
                                            }
                                            else
                                            {
                                                <img id="imgPreview" src="/Images/sucesso_transparente.png" alt="Foto do Usuário" />
                                            }
                                            <!-- Botão Limpar: SEMPRE oculto no HTML, JS controla visibilidade -->
                                            <button type="button"
                                                    class="ftx-foto-clear"
                                                    id="btnLimparFoto"
                                                    style="display: none !important;">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </div>

                                        <!-- Dropzone Estilizado -->
                                        <div class="ftx-dropzone" id="dropzoneArea">
                                            <input type="file"
                                                   class="ftx-dropzone-input"
                                                   id="inputFoto"
                                                   name="FotoUpload"
                                                   accept="image/*" />
                                            <div class="ftx-dropzone-area">
                                                <i class="fa-duotone fa-cloud-arrow-up ftx-dropzone-icon"></i>
                                                <p class="ftx-dropzone-text">Clique ou arraste uma imagem</p>
                                                <p class="ftx-dropzone-hint">JPG, PNG ou GIF</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Botões de Ação -->
                        <div class="d-flex gap-2">
                            @if (isEdicao)
                            {
                                <button type="submit"
                                        asp-page-handler="Edit"
                                        asp-route-id="@Model.UsuarioObj.AspNetUsers.Id"
                                        class="btn btn-azul btn-submit-spin">
                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Atualizar Usuário
                                </button>
                            }
                            else
                            {
                                <button type="submit"
                                        asp-page-handler="Submit"
                                        class="btn btn-azul btn-submit-spin">
                                    <i class="fa-duotone fa-floppy-disk icon-space icon-pulse"></i> Criar Usuário
                                </button>
                            }

                            <a asp-page="./Index" class="btn btn-ftx-fechar" data-ftx-loading>
                                <i class="fa-duotone fa-circle-xmark icon-space icon-pulse"></i> Cancelar Operação
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section ScriptsBlock {
    <script>
        (function () {
            "use strict";

            try {
                // =====================================================
                // PREVIEW DA FOTO - Dropzone Estilizado
                // =====================================================
                const inputFoto = document.getElementById('inputFoto');
                const imgPreview = document.getElementById('imgPreview');
                const dropzoneArea = document.getElementById('dropzoneArea');
                const dropzoneText = dropzoneArea ? dropzoneArea.querySelector('.ftx-dropzone-text') : null;
                const dropzoneIcon = dropzoneArea ? dropzoneArea.querySelector('.ftx-dropzone-icon') : null;
                const btnLimparFoto = document.getElementById('btnLimparFoto');
                const fotoPadraoPath = '/Images/sucesso_transparente.png';
                const hasFotoInicial = @(fotoBase64 != null ? "true" : "false") === "true";

                // Ajusta estado inicial do botão e dropzone
                // Botão SEMPRE começa oculto no HTML - JS decide se mostra
                if (hasFotoInicial && btnLimparFoto) {
                    // Só mostra se há foto inicial (edição com foto)
                    btnLimparFoto.style.cssText = 'display: flex !important; position: absolute !important; bottom: -14px !important; right: -22px !important; z-index: 999 !important;';
                    btnLimparFoto.classList.add('show');
                    if (dropzoneArea) dropzoneArea.classList.add('has-file');
                } else {
                    // Sem foto - mantém oculto (já está oculto no HTML)
                    if (dropzoneArea) dropzoneArea.classList.remove('has-file');
                }

                // Preview da foto ao selecionar arquivo
                if (inputFoto) {
                    inputFoto.addEventListener('change', function (e) {
                        try {
                            const files = e.target.files;
                            if (files && files[0]) {
                                // Atualiza preview
                                imgPreview.src = window.URL.createObjectURL(files[0]);
                                
                                // Mostra botão de limpar - usa cssText para sobrescrever display:none
                                if (btnLimparFoto) {
                                    btnLimparFoto.style.cssText = 'display: flex !important; position: absolute !important; bottom: -14px !important; right: -22px !important; z-index: 999 !important;';
                                    btnLimparFoto.classList.add('show');
                                }
                                
                                // Atualiza visual do dropzone
                                if (dropzoneArea) {
                                    dropzoneArea.classList.add('has-file');
                                }
                                if (dropzoneText) {
                                    dropzoneText.textContent = files[0].name;
                                }
                                if (dropzoneIcon) {
                                    dropzoneIcon.className = 'fa-duotone fa-circle-check ftx-dropzone-icon';
                                }
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "inputFoto.change", error);
                        }
                    });

                    // Drag and drop visual feedback
                    if (dropzoneArea) {
                        dropzoneArea.addEventListener('dragover', function (e) {
                            e.preventDefault();
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '#3D5771';
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
                        });

                        dropzoneArea.addEventListener('dragleave', function (e) {
                            e.preventDefault();
                            if (!dropzoneArea.classList.contains('has-file')) {
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '';
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.background = '';
                            }
                        });

                        dropzoneArea.addEventListener('drop', function (e) {
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '';
                            dropzoneArea.querySelector('.ftx-dropzone-area').style.background = '';
                        });
                    }
                }

                // =====================================================
                // BOTÃO LIMPAR FOTO (Lixeira)
                // =====================================================
                if (btnLimparFoto) {
                    btnLimparFoto.addEventListener('click', function (e) {
                        try {
                            e.preventDefault();
                            e.stopPropagation();

                            // Limpa o input file
                            if (inputFoto) {
                                inputFoto.value = '';
                            }

                            // Volta para a foto padrão
                            if (imgPreview) {
                                imgPreview.src = fotoPadraoPath;
                            }

                            // Esconde o botão de limpar
                            btnLimparFoto.classList.remove('show');
                            btnLimparFoto.style.cssText = 'display: none !important;';

                            // Reseta o visual do dropzone
                            if (dropzoneArea) {
                                dropzoneArea.classList.remove('has-file');
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.borderColor = '';
                                dropzoneArea.querySelector('.ftx-dropzone-area').style.background = '';
                            }
                            if (dropzoneText) {
                                dropzoneText.textContent = 'Clique ou arraste uma imagem';
                            }
                            if (dropzoneIcon) {
                                dropzoneIcon.className = 'fa-duotone fa-cloud-arrow-up ftx-dropzone-icon';
                            }

                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "btnLimparFoto.click", error);
                        }
                    });
                }

                // =====================================================
                // FUNÇÃO: Converter para Camel Case (exceto conectores)
                // =====================================================
                function toCamelCase(str) {
                    // Lista de conectores que devem permanecer em minúsculo
                    const conectores = ['da', 'de', 'do', 'das', 'dos', 'e', 'ou', 'a', 'o', 'as', 'os', 'em', 'na', 'no', 'nas', 'nos', 'para', 'por', 'com'];

                    return str
                        .toLowerCase()
                        .split(' ')
                        .map(function (palavra, index) {
                            if (!palavra) return '';
                            // Primeira palavra sempre em Camel Case, demais verificar se é conector
                            if (index === 0 || !conectores.includes(palavra)) {
                                return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                            }
                            return palavra;
                        })
                        .join(' ');
                }

                // =====================================================
                // VALIDAÇÃO: Nome Completo em Camel Case
                // =====================================================
                function sanitizeNomeCompleto(valor) {
                    let limpo = valor.replace(/[^\p{L} ]+/gu, '');
                    if (limpo.length > 80) {
                        limpo = limpo.substring(0, 80);
                    }
                    return limpo;
                }

                const txtNomeCompleto = document.getElementById('txtNomeCompleto');
                if (txtNomeCompleto) {
                    txtNomeCompleto.addEventListener('input', function () {
                        try {
                            txtNomeCompleto.value = sanitizeNomeCompleto(txtNomeCompleto.value);
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtNomeCompleto.input", error);
                        }
                    });

                    txtNomeCompleto.addEventListener('blur', function () {
                        try {
                            const valor = sanitizeNomeCompleto(txtNomeCompleto.value.trim());
                            if (valor) {
                                txtNomeCompleto.value = toCamelCase(valor);
                                txtNomeCompleto.classList.remove('is-invalid');
                            } else {
                                txtNomeCompleto.classList.add('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtNomeCompleto.blur", error);
                        }
                    });
                }

                // =====================================================
                // VALIDAÇÃO: Ponto com prefixo p_ (minúsculo) seguido de números
                // =====================================================
                const txtPonto = document.getElementById('txtPonto');
                const txtUserName = document.getElementById('txtUserName');
                const maxPontoDigits = 10;

                function formatPonto(valor) {
                    let digits = valor.trim().toLowerCase();
                    digits = digits.replace(/^[pP]_/, '');
                    digits = digits.replace(/\D/g, '');

                    const overflow = digits.length > maxPontoDigits;
                    if (overflow) {
                        digits = digits.substring(0, maxPontoDigits);
                    }

                    return {
                        formatted: digits.length > 0 ? 'p_' + digits : '',
                        digitsLength: digits.length,
                        overflow: overflow
                    };
                }

                if (txtPonto && txtUserName) {
                    txtPonto.addEventListener('blur', function () {
                        try {
                            const info = formatPonto(txtPonto.value);

                            txtPonto.value = info.formatted;
                            txtUserName.value = info.formatted;

                            if (info.digitsLength === 0 || info.overflow) {
                                txtPonto.classList.add('is-invalid');
                            } else {
                                txtPonto.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtPonto.blur", error);
                        }
                    });

                    txtPonto.addEventListener('input', function () {
                        try {
                            const info = formatPonto(txtPonto.value);

                            txtPonto.value = info.formatted;
                            txtUserName.value = info.formatted;

                            if (info.digitsLength === 0 || info.overflow) {
                                txtPonto.classList.add('is-invalid');
                            } else {
                                txtPonto.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtPonto.input", error);
                        }
                    });
                }


                // =====================================================
                // VALIDAÇÃO: Ramal - apenas números (máx 5 dígitos)
                // =====================================================
                const txtRamal = document.getElementById('txtRamal');
                if (txtRamal) {
                    txtRamal.addEventListener('input', function () {
                        try {
                            let valor = txtRamal.value.replace(/\D/g, '');

                            valor = valor.substring(0, 8);

                            txtRamal.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtRamal.input", error);
                        }
                    });

                    txtRamal.addEventListener('blur', function () {
                        try {
                            const valor = txtRamal.value.trim();
                            const regex = /^[1-9]\d{7}$/;

                            if (valor && !regex.test(valor)) {
                                txtRamal.classList.add('is-invalid');
                            } else {
                                txtRamal.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtRamal.blur", error);
                        }
                    });
                }


                // =====================================================
                // VALIDAÇÃO: Email obrigatoriamente terminando em @@camara.leg.br
                // Caracteres válidos antes do @@: letras, números, ponto, hífen, underscore
                // =====================================================
                const txtEmail = document.getElementById('txtEmail');
                if (txtEmail) {
                    txtEmail.addEventListener('blur', function () {
                        try {
                            let valor = txtEmail.value.trim().toLowerCase();

                            if (valor) {
                                // Remove @@camara.leg.br se já existir para evitar duplicação
                                valor = valor.replace(/@@camara\.leg\.br$/i, '');
                                // Remove qualquer @@ que possa existir
                                valor = valor.replace(/@@/g, '');

                                // Remove caracteres inválidos (permite apenas: letras, números, ponto, hífen, underscore)
                                valor = valor.replace(/[^a-z0-9._-]/g, '');

                                // Valida se tem conteúdo antes do @@
                                if (valor.length > 0) {
                                    // Adiciona o domínio obrigatório
                                    valor = valor + '@@camara.leg.br';
                                } else {
                                    // Se não tiver conteúdo, limpa o campo
                                    valor = '';
                                }

                                txtEmail.value = valor;

                                // Valida formato final (apenas caracteres válidos antes do @@)
                                const regex = /^[a-z0-9._-]+@@camara\.leg\.br$/;
                                if (valor && !regex.test(valor)) {
                                    txtEmail.classList.add('is-invalid');
                                } else {
                                    txtEmail.classList.remove('is-invalid');
                                }
                            } else {
                                txtEmail.classList.add('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtEmail.blur", error);
                        }
                    });

                    // Força minúsculo e remove caracteres inválidos enquanto digita
                    txtEmail.addEventListener('input', function () {
                        try {
                            // Converte para minúsculo
                            let valor = txtEmail.value.toLowerCase();

                            // Remove TUDO que não é letra, número, ponto, hífen, underscore ou @@
                            valor = valor.replace(/[^a-z0-9._@@-]/g, '');

                            // Conta quantos @@ existem
                            const numArrobas = (valor.match(/@@/g) || []).length;

                            // Se tem mais de 1 @@, remove os extras
                            if (numArrobas > 1) {
                                // Mantém apenas o primeiro @@
                                const partes = valor.split('@@');
                                valor = partes[0] + '@@' + partes.slice(1).join('');
                            }

                            txtEmail.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtEmail.input", error);
                        }
                    });
                }

                // =====================================================
                // VALIDAÇÃO: Celular com máscara (xx) xxxx-xxxx
                // =====================================================
                const txtCelular = document.getElementById('txtCelular');
                if (txtCelular) {
                    txtCelular.addEventListener('input', function (e) {
                        try {
                            // Remove tudo que não é número
                            let valor = txtCelular.value.replace(/\D/g, '');

                            // Limita a 10 dígitos
                            valor = valor.substring(0, 10);

                            // Aplica a máscara (xx) xxxx-xxxx
                            if (valor.length > 6) {
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2, 6) + '-' + valor.substring(6);
                            } else if (valor.length > 2) {
                                valor = '(' + valor.substring(0, 2) + ') ' + valor.substring(2);
                            } else if (valor.length > 0) {
                                valor = '(' + valor;
                            }

                            txtCelular.value = valor;
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtCelular.input", error);
                        }
                    });

                    // Valida formato completo ao sair do campo
                    txtCelular.addEventListener('blur', function () {
                        try {
                            const valor = txtCelular.value;
                            const regex = /^\(\d{2}\) \d{4}-\d{4}$/;

                            if (valor && !regex.test(valor)) {
                                txtCelular.classList.add('is-invalid');
                            } else {
                                txtCelular.classList.remove('is-invalid');
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "txtCelular.blur", error);
                        }
                    });
                }

                // =====================================================
                // VALIDAÇÃO: Impedir submit se houver campos inválidos
                // =====================================================
                const formulario = document.querySelector('form');
                if (formulario) {
                    formulario.addEventListener('submit', function (e) {
                        try {
                            // Força validação de todos os campos antes de submeter
                            if (txtPonto) {
                                txtPonto.dispatchEvent(new Event('blur'));
                            }
                            if (txtNomeCompleto) {
                                txtNomeCompleto.dispatchEvent(new Event('blur'));
                            }
                            if (txtEmail) {
                                txtEmail.dispatchEvent(new Event('blur'));
                            }
                            if (txtCelular) {
                                txtCelular.dispatchEvent(new Event('blur'));
                            }
                            if (txtRamal) {
                                txtRamal.dispatchEvent(new Event('blur'));
                            }

                            // Verifica se existe algum campo com is-invalid
                            const camposInvalidos = formulario.querySelectorAll('.is-invalid');

                            if (camposInvalidos.length > 0) {
                                e.preventDefault();
                                e.stopPropagation();

                                // Mostra alerta ao usuário
                                Alerta.Warning(
                                    'Campos Inválidos',
                                    'Por favor, corrija os campos destacados em vermelho antes de salvar.',
                                    'OK'
                                );

                                // Foca no primeiro campo inválido
                                camposInvalidos[0].focus();
                                return false;
                            }
                        } catch (error) {
                            Alerta.TratamentoErroComLinha("Upsert.cshtml", "form.submit", error);
                        }
                    });
                }


            } catch (error) {
                Alerta.TratamentoErroComLinha("Upsert.cshtml", "script.init", error);
            }
        })();
    </script>
}
