@page
@model FrotiX.Models.Motorista

@{
	ViewData["Title"] = "Motoristas";
	ViewData["PageName"] = "motorista_index";
	ViewData["Heading"] = "<i class='fad fa-user-tie'></i> Cadastros: <span class='fw-300'>Motoristas</span>";
	ViewData["Category1"] = "Cadastros";
	ViewData["PageIcon"] = "fal fa-user-tie";
}

@section HeadBlock {
	@* Inclua aqui CSS adicionais se necessário (DataTables, Toast, etc.) *@
}

<style>
	.fundo-cinza {
		background-color: #2F4F4F;
		color: aliceblue;
	}

	.label {
		color: white;
	}

	.imgViewer {
		display: flex;
		justify-content: center;
	}

	/* diminuir espaço interno do container acima da tabela */
	#panel-1 .panel-content{
		padding-top:10px !important;     /* ajuste fino entre header e conteúdo */
	}

	/* DataTables: compactar a faixa de controles (Show rows/Buttons/Pesquisar) */
	#tblMotorista_wrapper .row{ 
		margin-top:.25rem; 
		margin-bottom:.5rem;
	}
	#tblMotorista_wrapper .dataTables_length,
	#tblMotorista_wrapper .dt-buttons,
	#tblMotorista_wrapper .dataTables_filter{
		margin-top:.25rem;
		margin-bottom:.25rem;
	}
</style>

<div class="row">
	<div class="col-xl-12">
		<div id="panel-1" class="panel">
			<div class="panel-container show">

				<!-- Cabeçalho com botão alinhado na horizontal -->
				<div class="col-12 px-3">
					<div class="header-toolbar">
						<h2 class="titulo-paginas">
							<i class="fa-duotone fa-user-tie" aria-hidden="true"></i>
							Listagem de Motoristas
						</h2>

						<a href="/Motorista/Upsert"
						   class="btn btn-azul form-control"
						   style="width: 250px;"
						   data-ejtip="Adicionar novo motorista ao sistema">
							<i class="fa-duotone fa-file-plus icon-space icon-pulse"></i> Adicionar Motorista
						</a>
					</div>
				</div>
				<div class="panel-content">
					<div class="box-body">
						<table id="tblMotorista" class="table table-bordered table-striped" width="100%">
							<thead>
								<tr>
									<th>Nome</th>
									<th>Ponto</th>
									<th>CNH</th>
									<th>Categoria</th>
									<th>Celular</th>
									<th>Unidade</th>
									<th>Contrato</th>
									<th>Tipo</th>
									<th>Status</th>
									<th>Ação</th>
								</tr>
							</thead>
							<tbody>
								@* Preenchido via JS (~/js/cadastros/motorista_001.js) *@
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@* -------------- Modal da Foto do Motorista -------------- *@
<div class="modal fade" id="modalFoto" tabindex="-1" role="dialog" aria-labelledby="DynamicModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-md" role="document">
		<div class="modal-content">
			<div class="modal-header modal-header-azul">
				<h4 class="modal-title" id="DynamicModalLabel">Foto do Motorista</h4>
			</div>

			<div class="modal-body table-bordered container-fluid">
				<img id="imgViewer" width="300" alt="Foto do motorista" style="border: 1px solid #000000; margin-top: 10px;" />
				<div class="modal-footer">
					<button type="button" class="btn btn-vinho form-control" data-bs-dismiss="modal" aria-label="Fechar">
						<i class="fa-solid fa-rotate-left icon-space icon-rotate-left"></i> Fechar
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

@section ScriptsBlock {

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" crossorigin="anonymous" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script src="~/js/cadastros/motorista.js" asp-append-version="true"></script>

	<script>
		$(document).ready(function () {
			try {
				const modalFotoElement = document.getElementById('modalFoto');
				const modalFoto = new bootstrap.Modal(modalFotoElement, {
					keyboard: true,
					backdrop: 'static'
				});

				modalFotoElement.addEventListener('show.bs.modal', function (event) {
					try {
						const button = event.relatedTarget;
						const motoristaId = button.getAttribute('data-id');

						const label = document.getElementById("DynamicModalLabel");
						label.innerHTML = "";

						$("#imgViewer").attr("src", "").attr("alt", "Foto do motorista");

						$.ajax({
							type: "GET",
							url: "/api/Motorista/PegaFotoModal",
							data: { id: motoristaId },
							success: function (res) {
								try {
									const motoristaNome = $(button).closest("tr").find("td:eq(0)").text().trim();
									const possuiFoto = (res === false || res === "false" || res === null || res === "" || typeof res === "undefined") ? false : true;

									if (!possuiFoto) {
										label.innerHTML = "Motorista sem Foto: <b>" + motoristaNome + "</b>";
										$("#imgViewer").attr("src", "/Images/barbudo.jpg").attr("alt", "Sem foto - imagem padrío");
									} else {
										label.innerHTML = "Foto do Motorista: <b>" + motoristaNome + "</b>";
										$("#imgViewer").attr("src", "data:image/jpg;base64," + res).attr("alt", "Foto de " + motoristaNome);
									}
								} catch (error) {
									Alerta.TratamentoErroComLinha("Index.cshtml", "modalFoto.ajax.success", error);
								}
							},
							error: function (xhr) {
								try {
									console.error("Erro ao recuperar foto do motorista:", xhr);
									const motoristaNome = $(button).closest("tr").find("td:eq(0)").text().trim();
									label.innerHTML = "Não foi possível carregar a foto de: <b>" + motoristaNome + "</b>";
									$("#imgViewer").attr("src", "/Images/barbudo.jpg").attr("alt", "Erro ao carregar - imagem padrío");
								} catch (error) {
									Alerta.TratamentoErroComLinha("Index.cshtml", "modalFoto.ajax.error", error);
								}
							}
						});
					} catch (error) {
						Alerta.TratamentoErroComLinha("Index.cshtml", "modalFoto.show.bs.modal", error);
					}
				});

				modalFotoElement.addEventListener('hide.bs.modal', function () {
					try {
						$("#imgViewer").attr("src", "").attr("alt", "Foto do motorista");
					} catch (error) {
						Alerta.TratamentoErroComLinha("Index.cshtml", "modalFoto.hide.bs.modal", error);
					}
				});

			} catch (error) {
				Alerta.TratamentoErroComLinha("Index.cshtml", "document.ready", error);
			}
		});
	</script>
}
