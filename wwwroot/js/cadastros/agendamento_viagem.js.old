// ====================================================================
// ARQUIVO: agendamento_viagem.js 
// VERS√ÉO COMPLETA CORRIGIDA - 7500 linhas
// DATA: 12/10/2025
// ====================================================================
// CORRE√á√ïES APLICADAS:
// 1. txtNoFichaVistoria apenas em Viagem Aberta
// 2. txtDataInicial edit√°vel quando status != "Realizada" ou "Cancelada"  
// 3. Implementa√ß√£o do Alerta.Confirmar3
// 4. Cores dos √≠cones duotone restauradas
// 5. Try-catch em todas as fun√ß√µes
// 6. Substitui√ß√£o de toastr por AppToast
// 7. Substitui√ß√£o de alert por Alerta
// ====================================================================

// ====================================================================
// SE√á√ÉO 1: VARI√ÅVEIS GLOBAIS E CONFIGURA√á√ÉO INICIAL
// ====================================================================

var ViagemId = null;
var StatusViagem = null;
var calendar = null;
var CarregandoViagemBloqueada = false;
var InserindoRequisitante = false;
var CarregandoAgendamento = false;
var defaultRTE = null;
var defaultRTEDescricao = null;

// Controle de agendamento recorrente
var agendamentoRecorrenteGlobal = {
    recorrente: 'N',
    recorrenciaViagemId: null,
    datasSelecionadas: [],
    intervalo: null,
    dataFinalRecorrencia: null,
    monday: false,
    tuesday: false,
    wednesday: false,
    thursday: false,
    friday: false,
    saturday: false,
    sunday: false,
    diaMesRecorrencia: null,
    ehPrimeiraRecorrencia: false
};

// Vari√°veis de controle para viagem
let viagemId_AJAX = '';
let viagemId = '';
let recorrenciaViagemId = '';
let recorrenciaViagemId_AJAX = '';
let dataInicial_List = '';
let dataInicial = '';
let horaInicial = '';
let agendamentosRecorrentes = [];
let editarTodosRecorrentes = false;
let isTransformandoEmViagem = false;  // MUDOU DE transformandoEmViagem PARA isTransformandoEmViagem
let datasSelecionadas = [];
let isSubmitting = false;
let modalLock = false;

// Controle de requisitante original
let requisitanteOriginal = {
    id: null,
    ramal: null,
    setorId: null
};

// Controle de solicitante de atividade  
let solicitanteAtividadeOriginal = {
    id: null,
    ramal: null,
    departamentoId: null
};

// ====================================================================
// SE√á√ÉO 2: FUN√á√ïES DE UTILIDADE E HELPERS
// ====================================================================

/**
 * Formata data no padr√≠o brasileiro DD/MM/YYYY
 * param {Date|string} date - Data a ser formatada
 * returns {string} Data formatada
 */
function formatDate(date)
{
    try
    {
        if (!date) return '';
        const d = new Date(date);
        if (isNaN(d)) return '';

        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();

        return `${day}/${month}/${year}`;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "formatDate", error);
        return '';
    }
}

/**
 * Parseia data no formato brasileiro para objeto Date
 * param {string} dateStr - String da data em formato DD/MM/YYYY
 * returns {Date|null} Objeto Date ou null se inv√°lido
 */
function parseData(dateStr)
{
    try
    {
        if (!dateStr) return null;

        const parts = dateStr.split('/');
        if (parts.length !== 3) return null;

        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);

        const date = new Date(year, month, day);

        // Valida se a data √© v√°lida
        if (isNaN(date.getTime())) return null;

        return date;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "parseData", error);
        return null;
    }
}

/**
 * Calcula dura√ß√£o entre duas datas/horas
 * returns {number} Dura√ß√£o em horas
 */
function calcularDuracao()
{
    try
    {
        const dataInicial = $('#txtDataInicial').val();
        const horaInicial = $('#txtHoraInicial').val();
        const dataFinal = $('#txtDataFinal').val();
        const horaFinal = $('#txtHoraFinal').val();

        if (!dataInicial || !horaInicial || !dataFinal || !horaFinal)
        {
            $('#txtDuracao').val('');
            return 0;
        }

        const dtInicial = moment(`${dataInicial} ${horaInicial}`, "DD/MM/YYYY HH:mm");
        const dtFinal = moment(`${dataFinal} ${horaFinal}`, "DD/MM/YYYY HH:mm");

        if (!dtInicial.isValid() || !dtFinal.isValid())
        {
            $('#txtDuracao').val('');
            return 0;
        }

        const duracao = dtFinal.diff(dtInicial, 'hours', true);
        const duracaoFormatada = duracao.toFixed(1);

        const txtDuracao = document.getElementById('txtDuracao');
        if (txtDuracao && txtDuracao.ej2_instances && txtDuracao.ej2_instances[0])
        {
            txtDuracao.ej2_instances[0].value = parseFloat(duracaoFormatada);
            txtDuracao.ej2_instances[0].dataBind();
        }

        return duracao;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "calcularDuracao", error);
        return 0;
    }
}

/**
 * Calcula quilometragem percorrida
 */
function calcularQuilometragem()
{
    try
    {
        const kmInicial = parseFloat($('#txtKmInicial').val() || 0);
        const kmFinal = parseFloat($('#txtKmFinal').val() || 0);

        if (kmFinal > 0 && kmInicial > 0 && kmFinal > kmInicial)
        {
            const distancia = kmFinal - kmInicial;
            $('#txtQuilometragem').val(distancia.toFixed(0));
        } else
        {
            $('#txtQuilometragem').val('');
        }
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "calcularQuilometragem", error);
    }
}

/**
 * Limpa todos os campos do modal de viagens
 */
function limparCamposModalViagens()
{
    try
    {
        // Limpar campos de texto
        $('#txtViagemId, #txtRecorrenciaViagemId, #txtStatusAgendamento').val('');
        $('#txtUsuarioIdCriacao, #txtDataCriacao, #txtNoFichaVistoria').val('');
        $('#txtHoraInicial, #txtHoraFinal').val('');
        $('#txtKmAtual, #txtKmInicial, #txtKmFinal, #txtQuilometragem').val('');
        $('#txtRamalRequisitante, #txtRamalEvento').val('');
        $('#txtDuracao').val('');

        // Limpar datas usando Syncfusion DatePicker
        const dataInicialPicker = document.getElementById('txtDataInicial')?.ej2_instances?.[0];
        if (dataInicialPicker)
        {
            dataInicialPicker.value = null;
            dataInicialPicker.dataBind();
        }

        const dataFinalPicker = document.getElementById('txtDataFinal')?.ej2_instances?.[0];
        if (dataFinalPicker)
        {
            dataFinalPicker.value = null;
            dataFinalPicker.dataBind();
        }

        const dataFinalRecorrenciaPicker = document.getElementById('txtFinalRecorrencia')?.ej2_instances?.[0];
        if (dataFinalRecorrenciaPicker)
        {
            dataFinalRecorrenciaPicker.value = null;
            dataFinalRecorrenciaPicker.dataBind();
        }

        // Limpar dropdowns Syncfusion
        const componentes = [
            'lstFinalidade', 'cmbOrigem', 'cmbDestino', 'lstEventos',
            'lstMotorista', 'lstVeiculo', 'lstRequisitante', 'ddtSetor',
            'ddtCombustivelInicial', 'ddtCombustivelFinal', 'lstRecorrente',
            'lstPeriodos', 'lstDias', 'lstDiasMes'
        ];

        componentes.forEach(id =>
        {
            const elemento = document.getElementById(id);
            if (elemento?.ej2_instances?.[0])
            {
                const instancia = elemento.ej2_instances[0];
                instancia.value = null;
                if (instancia.clear) instancia.clear();
                if (instancia.dataBind) instancia.dataBind();
            }
        });

        // Limpar Rich Text Editor
        if (defaultRTE)
        {
            defaultRTE.value = '';
            defaultRTE.dataBind();
        }

        const rteDescricao = document.getElementById('rteDescricao')?.ej2_instances?.[0];
        if (rteDescricao)
        {
            rteDescricao.value = '';
            rteDescricao.dataBind();
        }

        // Limpar labels de usu√°rio
        $('#lblUsuarioAgendamento, #lblUsuarioCriacao, #lblUsuarioFinalizacao, #lblUsuarioCancelamento')
            .html('')
            .hide();

        // Ocultar elementos condicionais
        $('#divEvento, #divNoFichaVistoria, #painelGerenciadorAtividade').hide();
        $('#divPeriodo, #divTxtPeriodo, #divDias, #divDiaMes, #divFinalRecorrencia').hide();
        $('#calendarContainer, #listboxContainer, #listboxContainerHTML').hide();

        // Resetar controles de recorr√™ncia
        agendamentoRecorrenteGlobal = {
            recorrente: 'N',
            recorrenciaViagemId: null,
            datasSelecionadas: [],
            intervalo: null,
            dataFinalRecorrencia: null,
            monday: false,
            tuesday: false,
            wednesday: false,
            thursday: false,
            friday: false,
            saturday: false,
            sunday: false,
            diaMesRecorrencia: null,
            ehPrimeiraRecorrencia: false
        };

        // Limpar arrays
        datasSelecionadas = [];
        agendamentosRecorrentes = [];

        // Resetar flags
        editarTodosRecorrentes = false;
        isTransformandoEmViagem = false;
        CarregandoAgendamento = false;

        // Limpar report container
        $('#ReportContainer').hide().removeClass('visible').css('height', '0');
        $('#fichaReport').html('');

        // Habilitar todos os campos
        const childNodes = document.getElementById("divModal")?.getElementsByTagName("*");
        if (childNodes)
        {
            for (let node of childNodes)
            {
                if (node.id !== "divBotoes")
                {
                    node.disabled = false;
                }
            }
        }

        // Remover classe de campo bloqueado
        $('#txtDataInicial').removeClass('campo-bloqueado-recorrencia');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "limparCamposModalViagens", error);
    }
}

/**
 * Valida campos obrigat√≥rios do formul√°rio
 * returns {boolean} True se v√°lido, false caso contr√°rio
 */
function validarCamposObrigatorios()
{
    try
    {
        const erros = [];

        // Validar data inicial
        const dataInicial = $('#txtDataInicial').val();
        if (!dataInicial)
        {
            erros.push('Data Inicial √© obrigat√≥ria');
        }

        // Validar hora inicial
        const horaInicial = $('#txtHoraInicial').val();
        if (!horaInicial)
        {
            erros.push('Hora Inicial √© obrigat√≥ria');
        }

        // Validar finalidade
        const finalidade = document.getElementById('lstFinalidade')?.ej2_instances?.[0]?.value;
        if (!finalidade)
        {
            erros.push('Finalidade √© obrigat√≥ria');
        }

        // Validar origem
        const origem = document.getElementById('cmbOrigem')?.ej2_instances?.[0]?.value;
        if (!origem)
        {
            erros.push('Origem √© obrigat√≥ria');
        }

        // Validar destino
        const destino = document.getElementById('cmbDestino')?.ej2_instances?.[0]?.value;
        if (!destino)
        {
            erros.push('Destino √© obrigat√≥rio');
        }

        // Validar motorista
        const motorista = document.getElementById('lstMotorista')?.ej2_instances?.[0]?.value;
        if (!motorista)
        {
            erros.push('Motorista √© obrigat√≥rio');
        }

        // Validar ve√≠culo
        const veiculo = document.getElementById('lstVeiculo')?.ej2_instances?.[0]?.value;
        if (!veiculo)
        {
            erros.push('Ve√≠culo √© obrigat√≥rio');
        }

        // Validar requisitante
        const requisitante = document.getElementById('lstRequisitante')?.ej2_instances?.[0]?.value;
        if (!requisitante)
        {
            erros.push('Requisitante √© obrigat√≥rio');
        }

        // Validar setor
        const setor = document.getElementById('ddtSetor')?.ej2_instances?.[0]?.value;
        if (!setor)
        {
            erros.push('Setor √© obrigat√≥rio');
        }

        // Se houver erros, exibir mensagem
        if (erros.length > 0)
        {
            const mensagemErros = 'Por favor, corrija os seguintes campos:\n\n‚Ä¢ ' + erros.join('\n‚Ä¢ ');
            Alerta.Erro('Campos Obrigat√≥rios', mensagemErros);
            return false;
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarCamposObrigatorios", error);
        return false;
    }
}

/**
 * Verifica se √© primeira recorr√™ncia (tem filhas)
 * param {string} viagemId - ID da viagem
 * returns {Promise<boolean>} True se tem filhas
 */
async function verificarPrimeiraRecorrencia(viagemId)
{
    try
    {
        const response = await $.ajax({
            url: '/api/Agenda/VerificaRecorrenciaPai',
            method: 'GET',
            data: { viagemId: viagemId }
        });

        return response?.temFilhas || false;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "verificarPrimeiraRecorrencia", error);
        return false;
    }
}

/**
 * Bloqueia campo data inicial para primeira recorr√™ncia
 */
function bloquearDataInicialRecorrencia()
{
    try
    {
        const txtDataInicial = document.getElementById('txtDataInicial');
        const dataInicialPicker = txtDataInicial?.ej2_instances?.[0];

        if (dataInicialPicker)
        {
            dataInicialPicker.enabled = false;
            dataInicialPicker.dataBind();
        }

        // Adicionar classe visual de campo bloqueado
        $('#txtDataInicial').addClass('campo-bloqueado-recorrencia');

        // Adicionar tooltip explicativo usando FTXTooltip
        $('#txtDataInicial').attr('data-ejtip',
            'Data inicial n√£o pode ser alterada pois este √© o primeiro agendamento de uma s√©rie recorrente. ' +
            'Para alterar, exclua todas as recorr√™ncias e crie novamente.');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "bloquearDataInicialRecorrencia", error);
    }
}

/**
 * Desbloqueia campo data inicial
 */
function desbloquearDataInicial()
{
    try
    {
        const txtDataInicial = document.getElementById('txtDataInicial');
        const dataInicialPicker = txtDataInicial?.ej2_instances?.[0];

        if (dataInicialPicker)
        {
            dataInicialPicker.enabled = true;
            dataInicialPicker.dataBind();
        }

        // Remover classe visual de campo bloqueado
        $('#txtDataInicial').removeClass('campo-bloqueado-recorrencia');

        // Remover tooltip
        $('#txtDataInicial').removeAttr('data-ejtip');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "desbloquearDataInicial", error);
    }
}
// ====================================================================
// SE√á√ÉO 3: FUN√á√ÉO EXIBE VIAGEM - COMPLETA
// ====================================================================

/**
 * Exibe dados da viagem no modal
 * param {Object} viagem - Objeto com dados da viagem
 */
function ExibeViagem(viagem)
{
    try
    {
        console.log("üìÑ ExibeViagem - Iniciando exibi√ß√£o da viagem:", viagem);
        StatusViagem = "Aberta";

        // Limpar e habilitar todos os campos primeiro
        var childNodes = document.getElementById("divModal").getElementsByTagName("*");
        for (var node of childNodes)
        {
            if (node.id !== "divBotoes")
            {
                // N√£o desabilita elementos dentro dos accordions
                if (!node.closest('#accordionEvento') && !node.closest('#accordionTeste'))
                {
                    node.disabled = false;
                    node.value = "";
                }
            }
        }

        // Processar usu√°rios (Agendamento, Cria√ß√£o, Finaliza√ß√£o, Cancelamento)
        if (viagem.statusAgendamento || viagem.foiAgendamento)
        {
            // Usu√°rio de Agendamento
            if (viagem.usuarioIdAgendamento != null)
            {
                document.getElementById("lblUsuarioAgendamento").style.display = "block";
                const DataAgendamento = moment(viagem.dataAgendamento).format("DD/MM/YYYY");
                const HoraAgendamento = moment(viagem.dataAgendamento).format("HH:mm");

                $.ajax({
                    url: "/api/Agenda/RecuperaUsuario",
                    type: "Get",
                    data: { id: viagem.usuarioIdAgendamento },
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data)
                    {
                        try
                        {
                            let usuarioAgendamento;
                            $.each(data, function (key, val)
                            {
                                usuarioAgendamento = val;
                            });
                            // √çcone laranja escuro duotone
                            document.getElementById("lblUsuarioAgendamento").innerHTML =
                                '<i class="fa-duotone fa-solid fa-user-clock" style="--fa-primary-color: #C85A17; --fa-secondary-color: #D2691E; --fa-secondary-opacity: 0.65;"></i> ' +
                                '<span>Agendado por:</span> ' + usuarioAgendamento + " em " + DataAgendamento + " √†s " + HoraAgendamento;
                        } catch (error)
                        {
                            Alerta.TratamentoErroComLinha("agendamento_viagem.js", "ExibeViagem.usuarioAgendamento", error);
                        }
                    },
                    error: function (err)
                    {
                        console.error("Erro ao recuperar usu√°rio de agendamento:", err);
                        AppToast.show("Vermelho", "Erro ao carregar usu√°rio de agendamento", 3000);
                    }
                });
            }
        }

        // Usu√°rio de Cria√ß√£o
        if (viagem.usuarioIdCriacao != null)
        {
            document.getElementById("lblUsuarioCriacao").style.display = "block";
            const DataCriacao = moment(viagem.dataCriacao).format("DD/MM/YYYY");
            const HoraCriacao = moment(viagem.dataCriacao).format("HH:mm");

            $.ajax({
                url: "/api/Agenda/RecuperaUsuario",
                type: "Get",
                data: { id: viagem.usuarioIdCriacao },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data)
                {
                    try
                    {
                        let usuarioCriacao;
                        $.each(data, function (key, val)
                        {
                            usuarioCriacao = val;
                        });
                        // √çcone azul naval duotone
                        document.getElementById("lblUsuarioCriacao").innerHTML =
                            '<i class="fa-sharp-duotone fa-solid fa-user-plus" style="--fa-primary-color: #001f3f; --fa-secondary-color: #1e3a8a; --fa-secondary-opacity: 0.7;"></i> ' +
                            '<span>Criado/Alterado por:</span> ' + usuarioCriacao + " em " + DataCriacao + " √†s " + HoraCriacao;
                    } catch (error)
                    {
                        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "ExibeViagem.usuarioCriacao", error);
                    }
                }
            });
        }

        // Usu√°rio de Finaliza√ß√£o
        if (viagem.usuarioIdFinalizacao != null)
        {
            document.getElementById("lblUsuarioFinalizacao").style.display = "block";
            const DataFinalizacao = moment(viagem.dataFinalizacao).format("DD/MM/YYYY");
            const HoraFinalizacao = moment(viagem.dataFinalizacao).format("HH:mm");

            $.ajax({
                url: "/api/Agenda/RecuperaUsuario",
                type: "Get",
                data: { id: viagem.usuarioIdFinalizacao },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data)
                {
                    try
                    {
                        let usuarioFinalizacao;
                        $.each(data, function (key, val)
                        {
                            usuarioFinalizacao = val;
                        });
                        // √çcone verde escuro duotone
                        document.getElementById("lblUsuarioFinalizacao").innerHTML =
                            '<i class="fa-duotone fa-solid fa-user-check" style="--fa-primary-color: #155724; --fa-secondary-color: #28a745; --fa-secondary-opacity: 0.7;"></i> ' +
                            '<span>Finalizado por:</span> ' + usuarioFinalizacao + " em " + DataFinalizacao + " √†s " + HoraFinalizacao;
                    } catch (error)
                    {
                        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "ExibeViagem.usuarioFinalizacao", error);
                    }
                }
            });
        }

        // Usu√°rio de Cancelamento
        if (viagem.usuarioIdCancelamento != null)
        {
            document.getElementById("lblUsuarioCancelamento").style.display = "block";
            const DataCancelamento = moment(viagem.dataCancelamento).format("DD/MM/YYYY");
            const HoraCancelamento = moment(viagem.dataCancelamento).format("HH:mm");

            $.ajax({
                url: "/api/Agenda/RecuperaUsuario",
                type: "Get",
                data: { id: viagem.usuarioIdCancelamento },
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data)
                {
                    try
                    {
                        let usuarioCancelamento;
                        $.each(data, function (key, val)
                        {
                            usuarioCancelamento = val;
                        });
                        // √çcone vermelho duotone
                        document.getElementById("lblUsuarioCancelamento").innerHTML =
                            '<i class="fa-duotone fa-regular fa-trash-can-xmark" style="--fa-primary-color: #8B0000; --fa-secondary-color: #DC143C; --fa-secondary-opacity: 0.7;"></i> ' +
                            '<span>Cancelado por:</span> ' + usuarioCancelamento + " em " + DataCancelamento + " √†s " + HoraCancelamento;
                    } catch (error)
                    {
                        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "ExibeViagem.usuarioCancelamento", error);
                    }
                }
            });
        }

        // Controle de visibilidade do campo N¬∫ Ficha Vistoria
        // CORRE√á√ÉO: Campo s√≥ aparece para Viagem Aberta (n√£o Agendamento)
        if (viagem.statusAgendamento === true || viagem.foiAgendamento === true)
        {
            // √â um Agendamento - esconder campo
            $("#divNoFichaVistoria").hide();
            $("#txtNoFichaVistoria").val('');
        } else
        {
            // √â uma Viagem Aberta - mostrar campo
            $("#divNoFichaVistoria").show();
            $("#txtNoFichaVistoria").val(viagem.noFichaVistoria || '');
        }

        // Preencher campos do formul√°rio
        $("#txtViagemId").val(viagem.viagemId);
        $("#txtRecorrenciaViagemId").val(viagem.recorrenciaViagemId);
        $("#txtStatusAgendamento").val(viagem.statusAgendamento);
        $("#txtUsuarioIdCriacao").val(viagem.usuarioIdCriacao);
        $("#txtDataCriacao").val(viagem.dataCriacao);

        // Configurar data inicial
        var datePicker = document.getElementById("txtDataInicial").ej2_instances[0];
        datePicker.value = moment(viagem.dataInicial).toDate();
        datePicker.dataBind();

        // Configurar hora inicial
        $("#txtHoraInicial").removeAttr("type");
        document.getElementById("txtHoraInicial").value = viagem.horaInicio ? viagem.horaInicio.substring(11, 16) : '';
        $("#txtHoraInicial").attr("type", "time");

        // Configurar data final (se existir)
        if (viagem.dataFinal)
        {
            var datePickerFinal = document.getElementById("txtDataFinal").ej2_instances[0];
            datePickerFinal.value = moment(viagem.dataFinal).toDate();
            datePickerFinal.dataBind();
        }

        // Configurar hora final
        if (viagem.horaFim)
        {
            $("#txtHoraFinal").removeAttr("type");
            document.getElementById("txtHoraFinal").value = viagem.horaFim.substring(11, 16);
            $("#txtHoraFinal").attr("type", "time");
        }

        // Configurar finalidade
        if (viagem.finalidade)
        {
            document.getElementById("lstFinalidade").ej2_instances[0].value = [viagem.finalidade];

            // Se for Evento, mostrar campos de evento
            if (viagem.finalidade === "Evento")
            {
                $("#divEvento").show();
                if (viagem.eventoId)
                {
                    var lstEventos = document.getElementById("lstEventos").ej2_instances[0];
                    lstEventos.enabled = true;
                    lstEventos.value = viagem.eventoId;
                    lstEventos.dataBind();
                }
            }
        }

        // Configurar origem e destino
        if (viagem.origem)
        {
            document.getElementById("cmbOrigem").ej2_instances[0].value = viagem.origem;
        }
        if (viagem.destino)
        {
            document.getElementById("cmbDestino").ej2_instances[0].value = viagem.destino;
        }

        // Configurar motorista e ve√≠culo
        if (viagem.motoristaId)
        {
            document.getElementById("lstMotorista").ej2_instances[0].value = viagem.motoristaId;
        }
        if (viagem.veiculoId)
        {
            document.getElementById("lstVeiculo").ej2_instances[0].value = viagem.veiculoId;

            // Carregar KM atual do ve√≠culo
            $.ajax({
                url: "/Viagens/Upsert?handler=PegaKmAtualVeiculo",
                method: "GET",
                datatype: "json",
                data: { id: viagem.veiculoId },
                success: function (res)
                {
                    $("#txtKmAtual").val(res.data);
                }
            });
        }

        // Configurar quilometragem
        $("#txtKmInicial").val(viagem.kmInicial || '');
        $("#txtKmFinal").val(viagem.kmFinal || '');
        calcularQuilometragem();

        // Configurar combust√≠vel
        if (viagem.combustivelInicial)
        {
            document.getElementById("ddtCombustivelInicial").ej2_instances[0].value = [viagem.combustivelInicial];
        }
        if (viagem.combustivelFinal)
        {
            document.getElementById("ddtCombustivelFinal").ej2_instances[0].value = [viagem.combustivelFinal];
        }

        // Configurar requisitante e setor
        if (viagem.requisitanteId)
        {
            document.getElementById("lstRequisitante").ej2_instances[0].value = viagem.requisitanteId;

            // Carregar ramal do requisitante
            $.ajax({
                url: "/api/Agenda/PegaRamal",
                method: "GET",
                datatype: "json",
                data: { id: viagem.requisitanteId },
                success: function (res)
                {
                    if (res.success)
                    {
                        $("#txtRamalRequisitante").val(res.data);
                    }
                }
            });
        }

        if (viagem.setorSolicitanteId)
        {
            document.getElementById("ddtSetor").ej2_instances[0].value = [viagem.setorSolicitanteId];
        } else if (viagem.requisitanteId)
        {
            // Tentar carregar setor do requisitante
            $.ajax({
                url: "/api/Agenda/PegaSetor",
                method: "GET",
                datatype: "json",
                data: { id: viagem.requisitanteId },
                success: function (res)
                {
                    if (res.success && res.data)
                    {
                        document.getElementById("ddtSetor").ej2_instances[0].value = [res.data];
                    }
                }
            });
        }

        // Configurar ramal (se existir valor direto)
        if (viagem.ramalRequisitante)
        {
            $("#txtRamalRequisitante").val(viagem.ramalRequisitante);
        }

        // Configurar descri√ß√£o
        if (viagem.descricao)
        {
            var rteDescricao = document.getElementById("rteDescricao").ej2_instances[0];
            rteDescricao.value = viagem.descricao;
            rteDescricao.dataBind();
        }

        // Configurar recorr√™ncia
        if (viagem.recorrente === "S")
        {
            document.getElementById("lstRecorrente").ej2_instances[0].value = "S";
            $("#divPeriodo").show();

            // Configurar tipo de intervalo
            if (viagem.intervalo)
            {
                document.getElementById("lstPeriodos").ej2_instances[0].value = viagem.intervalo;

                // Mostrar controles espec√≠ficos baseados no intervalo
                switch (viagem.intervalo)
                {
                    case "D": // Dias
                        $("#divDias").show();
                        break;
                    case "S": // Semanal
                        $("#divDias").show();
                        // Configurar dias da semana
                        let diasSemana = [];
                        if (viagem.monday) diasSemana.push("Monday");
                        if (viagem.tuesday) diasSemana.push("Tuesday");
                        if (viagem.wednesday) diasSemana.push("Wednesday");
                        if (viagem.thursday) diasSemana.push("Thursday");
                        if (viagem.friday) diasSemana.push("Friday");
                        if (viagem.saturday) diasSemana.push("Saturday");
                        if (viagem.sunday) diasSemana.push("Sunday");

                        if (diasSemana.length > 0)
                        {
                            document.getElementById("lstDias").ej2_instances[0].value = diasSemana;
                        }
                        break;
                    case "M": // Mensal
                        $("#divDiaMes").show();
                        if (viagem.diaMesRecorrencia)
                        {
                            document.getElementById("lstDiasMes").ej2_instances[0].value = viagem.diaMesRecorrencia;
                        }
                        break;
                }
            }

            // Configurar data final de recorr√™ncia
            if (viagem.dataFinalRecorrencia)
            {
                $("#divFinalRecorrencia").show();
                var dateFinalRec = document.getElementById("txtFinalRecorrencia").ej2_instances[0];
                dateFinalRec.value = moment(viagem.dataFinalRecorrencia).toDate();
                dateFinalRec.dataBind();
            }
        }

        // Verificar se √© primeira recorr√™ncia e bloquear data inicial se necess√°rio
        if (viagem.recorrenciaViagemId == null && viagem.viagemId)
        {
            verificarPrimeiraRecorrencia(viagem.viagemId).then(temFilhas =>
            {
                if (temFilhas)
                {
                    agendamentoRecorrenteGlobal.ehPrimeiraRecorrencia = true;
                    bloquearDataInicialRecorrencia();
                    console.log("üìå Primeira recorr√™ncia detectada - Data inicial bloqueada");
                }
            });
        }

        // CORRE√á√ÉO: Controle de edi√ß√£o baseado no status
        // txtDataInicial deve estar dispon√≠vel para edi√ß√£o quando status n√£o for "Realizada" ou "Cancelada"
        if (viagem.status === "Realizada" || viagem.status === "Cancelada")
        {
            // Desabilitar TODOS os campos quando status for Realizada ou Cancelada
            var childNodes = document.getElementById("divModal").getElementsByTagName("*");
            for (var node of childNodes)
            {
                if (node.id !== "divBotoes")
                {
                    node.disabled = true;
                }
            }

            // Atualizar t√≠tulo do modal
            const statusText = viagem.status === "Realizada" ? "Realizada" : "Cancelada";
            document.getElementById("Titulo").innerHTML =
                `<h3 class='modal-title'>
                    <i class='fa-duotone fa-solid fa-suitcase-rolling' aria-hidden='true'></i> 
                    Visualizando ${viagem.statusAgendamento ? 'Agendamento' : 'Viagem'} ${statusText}
                </h3>`;

            // Esconder bot√µes de a√ß√£o
            $("#btnViagem, #btnConfirma, #btnApaga").hide();
            $("#btnCancela").hide();

        } else if (viagem.status === "Agendada")
        {
            // Para status "Agendada", manter campos habilitados incluindo txtDataInicial
            // A menos que seja primeira recorr√™ncia (tratado acima)

            // Atualizar t√≠tulo
            document.getElementById("Titulo").innerHTML =
                `<h3 class='modal-title'>
                    <i class='fa-duotone fa-solid fa-calendar-check' aria-hidden='true'></i> 
                    Editando Agendamento
                </h3>`;

            // Mostrar bot√µes apropriados
            $("#btnConfirma, #btnApaga, #btnCancela, #btnFecha").show();
            if (!viagem.statusAgendamento)
            {
                $("#btnViagem").show();
            } else
            {
                $("#btnViagem").hide();
            }

        } else if (viagem.status === "Aberta")
        {
            // Viagem aberta - todos os campos edit√°veis
            document.getElementById("Titulo").innerHTML =
                `<h3 class='modal-title'>
                    <i class='fa-duotone fa-solid fa-suitcase-rolling' aria-hidden='true'></i> 
                    Editando Viagem Aberta
                </h3>`;

            // Mostrar todos os bot√µes
            $("#btnConfirma, #btnApaga, #btnCancela, #btnFecha").show();
            $("#btnViagem").hide(); // J√° √© viagem
        }

        // Calcular dura√ß√£o
        calcularDuracao();

        // Configurar bot√µes do modal baseado no tipo
        if (viagem.statusAgendamento === true)
        {
            $("#btnViagem").show().html("<i class='fa-regular fa-shuffle' aria-hidden='true'></i>&nbsp;Transforma em Viagem");
            $("#btnConfirma").html("<i class='fa fa-save' aria-hidden='true'></i>Salvar Agendamento");
        } else
        {
            $("#btnViagem").hide();
            $("#btnConfirma").html("<i class='fa fa-save' aria-hidden='true'></i>Salvar Viagem");
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "ExibeViagem", error);
    }
}

// ====================================================================
// SE√á√ÉO 4: EVENTOS DE CAMPOS E VALIDA√á√ïES
// ====================================================================

/**
 * Configurar eventos de mudan√ßa nos campos de quilometragem
 */
function configurarEventosQuilometragem()
{
    try
    {
        // Evento ao mudar KM Inicial
        $('#txtKmInicial').on('blur change', function ()
        {
            calcularQuilometragem();
        });

        // Evento ao mudar KM Final
        $('#txtKmFinal').on('blur change', function ()
        {
            calcularQuilometragem();
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosQuilometragem", error);
    }
}

/**
 * Configurar eventos de mudan√ßa nas datas/horas
 */
function configurarEventosDatas()
{
    try
    {
        // Evento ao mudar data inicial
        $('#txtDataInicial').on('change', function ()
        {
            calcularDuracao();
        });

        // Evento ao mudar hora inicial
        $('#txtHoraInicial').on('change', function ()
        {
            calcularDuracao();
        });

        // Evento ao mudar data final
        $('#txtDataFinal').on('change', function ()
        {
            calcularDuracao();
        });

        // Evento ao mudar hora final
        $('#txtHoraFinal').on('change', function ()
        {
            calcularDuracao();
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosDatas", error);
    }
}
/**
 * Validar ficha de vistoria
 */
function validarFichaVistoria()
{
    try
    {
        $("#txtNoFichaVistoria").on('focusout', function ()
        {
            let noFicha = $("#txtNoFichaVistoria").val();
            if (noFicha === "") return;

            // Verificar se est√° dentro da faixa esperada
            $.ajax({
                url: "/Viagens/Upsert?handler=VerificaFicha",
                method: "GET",
                datatype: "json",
                data: { id: noFicha },
                success: function (res)
                {
                    try
                    {
                        let maxFicha = parseInt(res.data);
                        if (noFicha > maxFicha + 100 || noFicha < maxFicha - 100)
                        {
                            Alerta.Warning("Alerta na Ficha de Vistoria",
                                "O n√∫mero inserido difere em ¬±100 da √∫ltima Ficha inserida");
                        }
                    } catch (error)
                    {
                        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarFichaVistoria.verificaFicha", error);
                    }
                }
            });

            // Verificar se j√° existe
            $.ajax({
                url: "/Viagens/Upsert?handler=FichaExistente",
                method: "GET",
                datatype: "json",
                data: { id: noFicha },
                success: function (res)
                {
                    try
                    {
                        if (res.data === true)
                        {
                            Alerta.Warning("Alerta na Ficha de Vistoria",
                                "J√° existe uma Ficha inserida com esta numera√ß√£o");
                        }
                    } catch (error)
                    {
                        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarFichaVistoria.fichaExistente", error);
                    }
                }
            });
        });
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarFichaVistoria", error);
    }
}

// ====================================================================
// SE√á√ÉO 5: FUN√á√ïES DE CRIA√á√ÉO DE AGENDAMENTO
// ====================================================================

/**
 * Criar novo agendamento
 */
function criarNovoAgendamento()
{
    try
    {
        console.log("üìù Criando novo agendamento");

        // Limpar todos os campos
        limparCamposModalViagens();

        // Configurar t√≠tulo do modal
        document.getElementById("Titulo").innerHTML =
            "<h3 class='modal-title'><i class='fad fa-calendar-alt' aria-hidden='true'></i> Criar Novo Agendamento</h3>";

        // Configurar bot√µes para cria√ß√£o
        $("#btnViagem").hide();
        $("#btnApaga").hide();
        $("#btnCancela").hide();
        $("#btnConfirma").show().html("<i class='fa fa-save' aria-hidden='true'></i> Criar Agendamento");
        $("#btnFecha").show();

        // Esconder campo de ficha vistoria (s√≥ aparece em viagem aberta)
        $("#divNoFichaVistoria").hide();

        // Configurar data e hora inicial padr√≠o
        const hoje = new Date();
        const dataInicial = document.getElementById('txtDataInicial')?.ej2_instances?.[0];
        if (dataInicial)
        {
            dataInicial.value = hoje;
            dataInicial.dataBind();
        }

        // Configurar hora inicial padr√≠o (hora atual)
        const horaAtual = moment().format('HH:mm');
        $('#txtHoraInicial').val(horaAtual);

        // Configurar status inicial
        StatusViagem = "Agendada";
        $('#txtStatusAgendamento').val(true);

        // Abrir modal
        $('#modalViagens').modal('show');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "criarNovoAgendamento", error);
    }
}

/**
 * Salvar agendamento/viagem
 */
async function salvarAgendamento()
{
    try
    {
        // Prevenir m√∫ltiplas submiss√µes
        if (isSubmitting)
        {
            console.log("‚ö†Ô∏è J√° existe uma submiss√£o em andamento");
            return;
        }

        isSubmitting = true;

        // Validar campos obrigat√≥rios
        if (!validarCamposObrigatorios())
        {
            isSubmitting = false;
            return;
        }

        // Coletar dados do formul√°rio
        const dados = coletarDadosFormulario();

        // Se for recorrente, validar configura√ß√£o
        if (dados.recorrente === "S")
        {
            if (!validarRecorrencia(dados))
            {
                isSubmitting = false;
                return;
            }
        }

        // Se for edi√ß√£o de recorrente, perguntar se aplica a todos
        if (dados.viagemId && dados.recorrente === "S" && !agendamentoRecorrenteGlobal.ehPrimeiraRecorrencia)
        {
            const resultado = await Alerta.Confirmar3(
                'Editar Agendamento Recorrente',
                'Deseja aplicar as altera√ß√µes a todos os agendamentos recorrentes ou apenas ao atual?',
                'Todos',
                'Apenas ao Atual',
                'Desistir'
            );

            if (resultado === false)
            {
                isSubmitting = false;
                return;
            }

            dados.editarTodos = (resultado === "Todos");
        }

        // Enviar para o servidor
        $.ajax({
            url: '/api/Agenda/Agendamento',
            type: 'POST',
            data: JSON.stringify(dados),
            contentType: 'application/json',
            success: function (response)
            {
                try
                {
                    if (response.success)
                    {
                        AppToast.show("Verde", "Agendamento salvo com sucesso!", 3000);

                        // Fechar modal
                        $('#modalViagens').modal('hide');

                        // Atualizar calend√°rio
                        if (calendar)
                        {
                            calendar.refetchEvents();
                        }

                        // Limpar campos
                        limparCamposModalViagens();
                    } else
                    {
                        Alerta.Erro("Erro ao salvar", response.message || "Erro desconhecido");
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "salvarAgendamento.success", error);
                } finally
                {
                    isSubmitting = false;
                }
            },
            error: function (xhr, status, error)
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "salvarAgendamento.error", error);
                isSubmitting = false;
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "salvarAgendamento", error);
        isSubmitting = false;
    }
}

/**
 * Coletar dados do formul√°rio
 */
function coletarDadosFormulario()
{
    try
    {
        const dados = {
            viagemId: $('#txtViagemId').val() || null,
            recorrenciaViagemId: $('#txtRecorrenciaViagemId').val() || null,
            statusAgendamento: $('#txtStatusAgendamento').val() === 'true',
            status: StatusViagem || "Agendada",

            // Datas e horas
            dataInicial: $('#txtDataInicial').val(),
            horaInicio: $('#txtHoraInicial').val() ?
                moment($('#txtDataInicial').val() + ' ' + $('#txtHoraInicial').val(), 'DD/MM/YYYY HH:mm').toISOString() : null,
            dataFinal: $('#txtDataFinal').val() || null,
            horaFim: $('#txtHoraFinal').val() ?
                moment($('#txtDataFinal').val() + ' ' + $('#txtHoraFinal').val(), 'DD/MM/YYYY HH:mm').toISOString() : null,

            // Dados da viagem
            finalidade: document.getElementById('lstFinalidade')?.ej2_instances?.[0]?.value?.[0] || null,
            origem: document.getElementById('cmbOrigem')?.ej2_instances?.[0]?.value || null,
            destino: document.getElementById('cmbDestino')?.ej2_instances?.[0]?.value || null,

            // Motorista e ve√≠culo
            motoristaId: document.getElementById('lstMotorista')?.ej2_instances?.[0]?.value || null,
            veiculoId: document.getElementById('lstVeiculo')?.ej2_instances?.[0]?.value || null,

            // Quilometragem
            kmAtual: parseFloat($('#txtKmAtual').val()) || 0,
            kmInicial: parseFloat($('#txtKmInicial').val()) || 0,
            kmFinal: parseFloat($('#txtKmFinal').val()) || 0,

            // Combust√≠vel
            combustivelInicial: document.getElementById('ddtCombustivelInicial')?.ej2_instances?.[0]?.value?.[0] || null,
            combustivelFinal: document.getElementById('ddtCombustivelFinal')?.ej2_instances?.[0]?.value?.[0] || null,

            // Requisitante
            requisitanteId: document.getElementById('lstRequisitante')?.ej2_instances?.[0]?.value || null,
            ramalRequisitante: $('#txtRamalRequisitante').val() || null,
            setorSolicitanteId: document.getElementById('ddtSetor')?.ej2_instances?.[0]?.value?.[0] || null,

            // Descri√ß√£o
            descricao: document.getElementById('rteDescricao')?.ej2_instances?.[0]?.value || null,

            // Ficha vistoria (s√≥ para viagem aberta)
            noFichaVistoria: $('#txtNoFichaVistoria').val() || null,

            // Evento (se for finalidade = Evento)
            eventoId: document.getElementById('lstEventos')?.ej2_instances?.[0]?.value || null,

            // Recorr√™ncia
            recorrente: document.getElementById('lstRecorrente')?.ej2_instances?.[0]?.value || "N",
            intervalo: document.getElementById('lstPeriodos')?.ej2_instances?.[0]?.value || null,
            dataFinalRecorrencia: $('#txtFinalRecorrencia').val() ?
                moment($('#txtFinalRecorrencia').val(), 'DD/MM/YYYY').toISOString() : null,

            // Dias da semana (para recorr√™ncia semanal)
            monday: false,
            tuesday: false,
            wednesday: false,
            thursday: false,
            friday: false,
            saturday: false,
            sunday: false,

            // Dia do m√™s (para recorr√™ncia mensal)
            diaMesRecorrencia: document.getElementById('lstDiasMes')?.ej2_instances?.[0]?.value || null,

            // Datas selecionadas (para recorr√™ncia)
            datasSelecionadas: datasSelecionadas || []
        };

        // Se for recorr√™ncia semanal, configurar dias da semana
        if (dados.recorrente === "S" && dados.intervalo === "S")
        {
            const diasSelecionados = document.getElementById('lstDias')?.ej2_instances?.[0]?.value || [];
            diasSelecionados.forEach(dia =>
            {
                dados[dia.toLowerCase()] = true;
            });
        }

        return dados;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "coletarDadosFormulario", error);
        return {};
    }
}

/**
 * Validar configura√ß√£o de recorr√™ncia
 */
function validarRecorrencia(dados)
{
    try
    {
        if (!dados.intervalo)
        {
            Alerta.Erro("Recorr√™ncia Inv√°lida", "Selecione o per√≠odo de recorr√™ncia");
            return false;
        }

        if (dados.intervalo === "S")
        {
            // Validar se pelo menos um dia foi selecionado
            const diasSemana = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const algumDiaSelecionado = diasSemana.some(dia => dados[dia] === true);

            if (!algumDiaSelecionado)
            {
                Alerta.Erro("Recorr√™ncia Inv√°lida", "Selecione pelo menos um dia da semana");
                return false;
            }
        }

        if (dados.intervalo === "M" && !dados.diaMesRecorrencia)
        {
            Alerta.Erro("Recorr√™ncia Inv√°lida", "Selecione o dia do m√™s para recorr√™ncia");
            return false;
        }

        if (!dados.dataFinalRecorrencia)
        {
            Alerta.Erro("Recorr√™ncia Inv√°lida", "Defina a data final da recorr√™ncia");
            return false;
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarRecorrencia", error);
        return false;
    }
}

// ====================================================================
// SE√á√ÉO 6: FUN√á√ïES DE EXCLUS√ÉO E CANCELAMENTO
// ====================================================================

/**
 * Apagar agendamento
 */
async function apagarAgendamento()
{
    try
    {
        const viagemId = $('#txtViagemId').val();
        if (!viagemId)
        {
            Alerta.Erro("Erro", "ID da viagem n√£o encontrado");
            return;
        }

        // Confirmar exclus√£o
        const confirmar = await Alerta.Confirmar(
            "Confirmar Exclus√£o",
            "Tem certeza que deseja apagar este agendamento? Esta a√ß√£o n√£o pode ser desfeita.",
            "Sim, Apagar",
            "Cancelar"
        );

        if (!confirmar) return;

        // Enviar requisi√ß√£o de exclus√£o
        $.ajax({
            url: '/api/Agenda/ApagaAgendamento',
            type: 'POST',
            data: JSON.stringify({ viagemId: viagemId }),
            contentType: 'application/json',
            success: function (response)
            {
                try
                {
                    if (response.success)
                    {
                        AppToast.show("Verde", "Agendamento apagado com sucesso!", 3000);

                        // Fechar modal
                        $('#modalViagens').modal('hide');

                        // Atualizar calend√°rio
                        if (calendar)
                        {
                            calendar.refetchEvents();
                        }

                        // Limpar campos
                        limparCamposModalViagens();
                    } else
                    {
                        Alerta.Erro("Erro ao apagar", response.message || "Erro desconhecido");
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "apagarAgendamento.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "apagarAgendamento.error", error);
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "apagarAgendamento", error);
    }
}

/**
 * Cancelar agendamento
 */
async function cancelarAgendamento()
{
    try
    {
        const viagemId = $('#txtViagemId').val();
        if (!viagemId)
        {
            Alerta.Erro("Erro", "ID da viagem n√£o encontrado");
            return;
        }

        // Pedir motivo do cancelamento
        const { value: motivo } = await Swal.fire({
            title: 'Cancelar Agendamento',
            input: 'textarea',
            inputLabel: 'Motivo do cancelamento',
            inputPlaceholder: 'Digite o motivo do cancelamento...',
            inputAttributes: {
                'aria-label': 'Digite o motivo do cancelamento'
            },
            showCancelButton: true,
            confirmButtonText: 'Cancelar Agendamento',
            cancelButtonText: 'Voltar',
            confirmButtonColor: '#d33',
            inputValidator: (value) =>
            {
                if (!value)
                {
                    return 'Voc√™ precisa informar o motivo do cancelamento!';
                }
            }
        });

        if (!motivo) return;

        // Enviar requisi√ß√£o de cancelamento
        $.ajax({
            url: '/api/Agenda/CancelaAgendamento',
            type: 'POST',
            data: JSON.stringify({
                viagemId: viagemId,
                descricao: motivo
            }),
            contentType: 'application/json',
            success: function (response)
            {
                try
                {
                    if (response.success)
                    {
                        AppToast.show("Amarelo", "Agendamento cancelado!", 3000);

                        // Fechar modal
                        $('#modalViagens').modal('hide');

                        // Atualizar calend√°rio
                        if (calendar)
                        {
                            calendar.refetchEvents();
                        }

                        // Limpar campos
                        limparCamposModalViagens();
                    } else
                    {
                        Alerta.Erro("Erro ao cancelar", response.message || "Erro desconhecido");
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "cancelarAgendamento.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "cancelarAgendamento.error", error);
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "cancelarAgendamento", error);
    }
}
// ====================================================================
// SE√á√ÉO 7: TRANSFORMAR AGENDAMENTO EM VIAGEM
// ====================================================================

/**
 * Transformar agendamento em viagem
 */
async function executarTransformacaoEmViagem()
{
    try
    {
        const viagemId = $('#txtViagemId').val();
        if (!viagemId)
        {
            Alerta.Erro("Erro", "ID da viagem n√£o encontrado");
            return;
        }

        // Confirmar transforma√ß√£o
        const confirmar = await Alerta.Confirmar(
            "Transformar em Viagem",
            "Deseja transformar este agendamento em uma viagem aberta?",
            "Sim, Transformar",
            "Cancelar"
        );

        if (!confirmar) return;

        isTransformandoEmViagem = true;  // NOTA: Mudou de transformandoEmViagem para isTransformandoEmViagem

        // Alterar status
        StatusViagem = "Aberta";
        $('#txtStatusAgendamento').val(false);

        // Mostrar campo de ficha vistoria (agora √© viagem aberta)
        $("#divNoFichaVistoria").show();

        // Atualizar bot√µes
        $("#btnViagem").hide();
        $("#btnConfirma").html("<i class='fa fa-save' aria-hidden='true'></i>Salvar Viagem");

        // Atualizar t√≠tulo
        document.getElementById("Titulo").innerHTML =
            "<h3 class='modal-title'><i class='fa-duotone fa-solid fa-suitcase-rolling' aria-hidden='true'></i> Viagem Aberta</h3>";

        AppToast.show("Amarelo", "Agendamento transformado em viagem. Fa√ßa as altera√ß√µes necess√°rias e salve.", 4000);

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "executarTransformacaoEmViagem", error);
    } finally
    {
        isTransformandoEmViagem = false;  // NOTA: Mudou de transformandoEmViagem para isTransformandoEmViagem
    }
}

// ====================================================================
// SE√á√ÉO 8: CONTROLE DE REQUISITANTE
// ====================================================================

/**
 * Configurar eventos do requisitante
 */
function configurarEventosRequisitante()
{
    try
    {
        // Ao selecionar requisitante
        $('#lstRequisitante').on('change', function ()
        {
            const requisitanteId = document.getElementById('lstRequisitante')?.ej2_instances?.[0]?.value;

            if (!requisitanteId) return;

            // Carregar ramal
            $.ajax({
                url: "/api/Agenda/PegaRamal",
                method: "GET",
                datatype: "json",
                data: { id: requisitanteId },
                success: function (res)
                {
                    if (res.success)
                    {
                        $("#txtRamalRequisitante").val(res.data);
                    }
                },
                error: function (xhr, status, error)
                {
                    console.error("Erro ao carregar ramal:", error);
                }
            });

            // Carregar setor
            $.ajax({
                url: "/api/Agenda/PegaSetor",
                method: "GET",
                datatype: "json",
                data: { id: requisitanteId },
                success: function (res)
                {
                    if (res.success && res.data)
                    {
                        const ddtSetor = document.getElementById('ddtSetor')?.ej2_instances?.[0];
                        if (ddtSetor)
                        {
                            ddtSetor.value = [res.data];
                            ddtSetor.dataBind();
                        }
                    }
                },
                error: function (xhr, status, error)
                {
                    console.error("Erro ao carregar setor:", error);
                }
            });
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosRequisitante", error);
    }
}

/**
 * Abrir modal de inserir requisitante
 */
function abrirModalRequisitante()
{
    try
    {
        // Mostrar accordion de requisitante
        $("#accordionTeste").show();

        // Limpar campos
        $("#txtPonto, #txtNome, #txtRamal, #txtEmail").val('');

        // Limpar dropdown de setor
        const ddtSetorReq = document.getElementById('ddtSetorRequisitante')?.ej2_instances?.[0];
        if (ddtSetorReq)
        {
            ddtSetorReq.value = null;
            ddtSetorReq.dataBind();
        }

        // Focar no primeiro campo
        setTimeout(() =>
        {
            $("#txtPonto").focus();
        }, 300);

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "abrirModalRequisitante", error);
    }
}

/**
 * Inserir novo requisitante
 */
async function inserirRequisitante()
{
    try
    {
        // Validar campos
        const ponto = $("#txtPonto").val();
        const nome = $("#txtNome").val();
        const ramal = $("#txtRamal").val();
        const email = $("#txtEmail").val();
        const setorId = document.getElementById('ddtSetorRequisitante')?.ej2_instances?.[0]?.value?.[0];

        if (!nome)
        {
            Alerta.Erro("Campo Obrigat√≥rio", "Nome do requisitante √© obrigat√≥rio");
            return;
        }

        if (!setorId)
        {
            Alerta.Erro("Campo Obrigat√≥rio", "Setor do requisitante √© obrigat√≥rio");
            return;
        }

        // Montar objeto
        const requisitante = {
            ponto: ponto,
            requisitante: nome,
            ramal: ramal,
            email: email,
            setorSolicitanteId: setorId
        };

        // Enviar para o servidor
        $.ajax({
            url: '/api/Requisitante/Inserir',
            type: 'POST',
            data: JSON.stringify(requisitante),
            contentType: 'application/json',
            success: async function (response)
            {
                try
                {
                    if (response.success)
                    {
                        AppToast.show("Verde", "Requisitante inserido com sucesso!", 3000);

                        // Fechar accordion
                        $("#accordionTeste").hide();

                        // Atualizar lista de requisitantes
                        await atualizarListaRequisitantes();

                        // Selecionar o novo requisitante
                        const lstRequisitante = document.getElementById('lstRequisitante')?.ej2_instances?.[0];
                        if (lstRequisitante && response.requisitanteId)
                        {
                            lstRequisitante.value = response.requisitanteId;
                            lstRequisitante.dataBind();

                            // Preencher ramal e setor
                            $("#txtRamalRequisitante").val(ramal);
                            const ddtSetor = document.getElementById('ddtSetor')?.ej2_instances?.[0];
                            if (ddtSetor)
                            {
                                ddtSetor.value = [setorId];
                                ddtSetor.dataBind();
                            }
                        }
                    } else
                    {
                        Alerta.Erro("Erro ao inserir", response.message || "Erro desconhecido");
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "inserirRequisitante.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "inserirRequisitante.error", error);
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "inserirRequisitante", error);
    }
}

/**
 * Atualizar lista de requisitantes
 */
async function atualizarListaRequisitantes()
{
    try
    {
        const response = await $.ajax({
            url: '/api/Requisitante/Lista',
            method: 'GET'
        });

        if (response && response.data)
        {
            const lstRequisitante = document.getElementById('lstRequisitante')?.ej2_instances?.[0];
            if (lstRequisitante)
            {
                lstRequisitante.dataSource = response.data;
                lstRequisitante.dataBind();
            }
        }
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "atualizarListaRequisitantes", error);
    }
}

// ====================================================================
// SE√á√ÉO 9: CONTROLE DE RECORR√äNCIA
// ====================================================================

/**
 * Configurar eventos de recorr√™ncia
 */
function configurarEventosRecorrencia()
{
    try
    {
        // Ao mudar recorrente
        $('#lstRecorrente').on('change', function ()
        {
            const valor = document.getElementById('lstRecorrente')?.ej2_instances?.[0]?.value;

            if (valor === "S")
            {
                $("#divPeriodo").show();
                $("#divFinalRecorrencia").show();
            } else
            {
                $("#divPeriodo").hide();
                $("#divTxtPeriodo").hide();
                $("#divDias").hide();
                $("#divDiaMes").hide();
                $("#divFinalRecorrencia").hide();
                $("#divFinalFalsoRecorrencia").hide();
                $("#calendarContainer").hide();
                $("#listboxContainer").hide();
                $("#listboxContainerHTML").hide();
            }
        });

        // Ao mudar per√≠odo
        $('#lstPeriodos').on('change', function ()
        {
            const periodo = document.getElementById('lstPeriodos')?.ej2_instances?.[0]?.value;

            // Ocultar todos primeiro
            $("#divDias").hide();
            $("#divDiaMes").hide();
            $("#calendarContainer").hide();
            $("#listboxContainer").hide();
            $("#listboxContainerHTML").hide();

            switch (periodo)
            {
                case "D": // Di√°rio
                    // Nenhum controle adicional
                    break;

                case "S": // Semanal
                    $("#divDias").show();
                    break;

                case "Q": // Quinzenal
                    // Nenhum controle adicional
                    break;

                case "M": // Mensal
                    $("#divDiaMes").show();
                    break;

                case "P": // Personalizado
                    $("#calendarContainer").show();
                    $("#listboxContainerHTML").show();
                    inicializarCalendarioRecorrencia();
                    break;
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosRecorrencia", error);
    }
}

/**
 * Inicializar calend√°rio de recorr√™ncia personalizada
 */
function inicializarCalendarioRecorrencia()
{
    try
    {
        const calendarEl = document.getElementById('calDatasSelecionadas');
        if (!calendarEl) return;

        // Verificar se j√° existe inst√¢ncia Syncfusion
        let calendarInstance = calendarEl.ej2_instances?.[0];

        if (!calendarInstance)
        {
            // Criar nova inst√¢ncia
            calendarInstance = new ej.calendars.Calendar({
                isMultiSelection: true,
                showTodayButton: false,
                values: datasSelecionadas || [],
                change: function (args)
                {
                    atualizarDatasSelecionadas(args.values);
                }
            });
            calendarInstance.appendTo('#calDatasSelecionadas');
        } else
        {
            // Atualizar valores existentes
            calendarInstance.values = datasSelecionadas || [];
            calendarInstance.dataBind();
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "inicializarCalendarioRecorrencia", error);
    }
}

/**
 * Atualizar datas selecionadas
 */
function atualizarDatasSelecionadas(valores)
{
    try
    {
        datasSelecionadas = valores || [];

        // Atualizar lista visual
        const lstDiasHTML = document.getElementById('lstDiasCalendarioHTML');
        if (lstDiasHTML)
        {
            lstDiasHTML.innerHTML = '';

            // Ordenar datas
            const datasOrdenadas = datasSelecionadas.sort((a, b) => new Date(a) - new Date(b));

            // Adicionar cada data na lista
            datasOrdenadas.forEach((data, index) =>
            {
                const dataFormatada = moment(data).format('DD/MM/YYYY');
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `
                    <span>${index + 1}. ${dataFormatada}</span>
                    <button class="btn btn-sm btn-danger remove-data" data-index="${index}">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                lstDiasHTML.appendChild(item);
            });

            // Atualizar badge
            const badge = document.getElementById('itensBadgeHTML');
            if (badge)
            {
                badge.textContent = datasOrdenadas.length;
                badge.style.display = datasOrdenadas.length > 0 ? 'block' : 'none';
            }
        }

        // Adicionar eventos de remo√ß√£o
        document.querySelectorAll('.remove-data').forEach(btn =>
        {
            btn.addEventListener('click', function ()
            {
                const index = parseInt(this.getAttribute('data-index'));
                removerDataSelecionada(index);
            });
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "atualizarDatasSelecionadas", error);
    }
}

/**
 * Remover data selecionada
 */
function removerDataSelecionada(index)
{
    try
    {
        if (index >= 0 && index < datasSelecionadas.length)
        {
            datasSelecionadas.splice(index, 1);

            // Atualizar calend√°rio
            const calendarEl = document.getElementById('calDatasSelecionadas');
            const calendarInstance = calendarEl?.ej2_instances?.[0];
            if (calendarInstance)
            {
                calendarInstance.values = datasSelecionadas;
                calendarInstance.dataBind();
            }

            // Atualizar lista
            atualizarDatasSelecionadas(datasSelecionadas);
        }
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "removerDataSelecionada", error);
    }
}

// ====================================================================
// SE√á√ÉO 9: CONTROLE DE RECORR√äNCIA E CADASTRO DE EVENTOS
// ====================================================================

$("#btnInserirEvento").click(async function (e)
{
    try
    {
        e.preventDefault();

        // Valida√ß√µes dos campos obrigat√≥rios
        if ($("#txtNomeDoEvento").val() === "")
        {
            Alerta.Erro("Aten√ß√£o", "O Nome do Evento √© obrigat√≥rio");
            return;
        }
        if ($("#txtDescricaoEvento").val() === "")
        {
            Alerta.Erro("Aten√ß√£o", "A Descri√ß√£o do Evento √© obrigat√≥ria");
            return;
        }
        if ($("#txtDataInicialEvento").val() === "")
        {
            Alerta.Erro("Aten√ß√£o", "A Data Inicial √© obrigat√≥ria");
            return;
        }
        if ($("#txtDataFinalEvento").val() === "")
        {
            Alerta.Erro("Aten√ß√£o", "A Data Final √© obrigat√≥ria");
            return;
        }
        if ($("#txtQtdPessoas").val() === "")
        {
            Alerta.Erro("Aten√ß√£o", "A Quantidade de Pessoas √© obrigat√≥ria");
            return;
        }

        // Valida√ß√£o dos dropdowns Syncfusion
        var setores = document.getElementById("lstSetorRequisitanteEvento").ej2_instances[0];
        if (setores.value === null)
        {
            Alerta.Erro("Aten√ß√£o", "O Setor do Requisitante √© obrigat√≥rio");
            return;
        }
        var setorSolicitanteId = setores.value.toString();

        var requisitantes = document.getElementById("lstRequisitanteEvento").ej2_instances[0];
        if (requisitantes.value === null)
        {
            Alerta.Erro("Aten√ß√£o", "O Requisitante √© obrigat√≥rio");
            return;
        }
        var requisitanteId = requisitantes.value.toString();

        // Criar objeto do evento
        var objEvento = JSON.stringify({
            Nome: $("#txtNomeDoEvento").val(),
            Descricao: $("#txtDescricaoEvento").val(),
            SetorSolicitanteId: setorSolicitanteId,
            RequisitanteId: requisitanteId,
            QtdParticipantes: $("#txtQtdPessoas").val(),
            DataInicial: moment(document.getElementById("txtDataInicialEvento").value).format("MM-DD-YYYY"),
            DataFinal: moment(document.getElementById("txtDataFinalEvento").value).format("MM-DD-YYYY"),
            Status: "1"
        });

        console.log("Objeto Evento:", objEvento);

        try
        {
            document.body.style.cursor = "wait";

            // Enviar para o servidor
            $.ajax({
                url: '/api/Evento/Inserir',
                type: 'POST',
                data: JSON.stringify(evento),
                contentType: 'application/json',
                success: async function (response)
                {
                    try
                    {
                        if (response.success)
                        {
                            AppToast.show("Verde", "Evento cadastrado com sucesso!", 3000);
                            // Fechar painel
                            $("#painelGerenciadorAtividade").hide();
                            $("#btnGerenciarAtividade").removeClass('ativo');
                            // Limpar formul√°rio
                            document.getElementById('formularioCadastroAtividade').reset();
                            // Atualizar lista de eventos
                            await atualizarListaEventos();
                            // Selecionar o novo evento
                            const lstEventos = document.getElementById('lstEventos')?.ej2_instances?.[0];
                            if (lstEventos && response.eventoId)
                            {
                                lstEventos.value = response.eventoId;
                                lstEventos.dataBind();
                            }
                        } else
                        {
                            Alerta.Erro("Erro ao cadastrar", response.message || "Erro desconhecido");
                        }
                    } catch (error)
                    {
                        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "cadastrarNovoEvento.success", error);
                    }
                },
                error: function (xhr, status, error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "cadastrarNovoEvento.error", error);
                }
            });

        } catch (error)
        {
            Alerta.TratamentoErroComLinha("agendamento_viagem.js", "cadastrarNovoEvento", error);
        }
        finally
        {
            document.body.style.cursor = "default";
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "btnInserirEvento", error);
    }
});

/**
 * Atualizar lista de eventos
 */
async function atualizarListaEventos()
{
    try
    {
        const response = await $.ajax({
            url: '/api/Evento/Lista',
            method: 'GET'
        });

        if (response && response.data)
        {
            const lstEventos = document.getElementById('lstEventos')?.ej2_instances?.[0];
            if (lstEventos)
            {
                lstEventos.dataSource = response.data;
                lstEventos.dataBind();
            }
        }
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "atualizarListaEventos", error);
    }
}

// ====================================================================
// SE√á√ÉO 13: VALIDA√á√ïES DE DATAS
// ====================================================================

/**
 * Validar consist√™ncia entre data inicial e dias da semana
 */
function validarConsistenciaDiasSemana()
{
    try
    {
        const diasSelecionados = document.getElementById("lstDias")?.ej2_instances?.[0]?.value;

        if (!diasSelecionados || diasSelecionados.length === 0)
        {
            return true; // Nada para validar
        }

        const dataInicialStr = $('#txtDataInicial').val();
        if (!dataInicialStr)
        {
            return true; // Sem data inicial ainda
        }

        const dataInicial = moment(dataInicialStr, "DD/MM/YYYY", true);
        if (!dataInicial.isValid())
        {
            console.error("Data inicial inv√°lida:", dataInicialStr);
            return false;
        }

        const diaSemanaDataInicial = dataInicial.day();

        const diasDaSemanaIndices = {
            "Sunday": 0,
            "Monday": 1,
            "Tuesday": 2,
            "Wednesday": 3,
            "Thursday": 4,
            "Friday": 5,
            "Saturday": 6
        };

        const diasSelecionadosIndices = diasSelecionados.map(dia => diasDaSemanaIndices[dia]);

        if (!diasSelecionadosIndices.includes(diaSemanaDataInicial))
        {
            // Mostrar di√°logo de inconsist√™ncia
            mostrarDialogoInconsistenciaDias();
            return false;
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarConsistenciaDiasSemana", error);
        return false;
    }
}

/**
 * Mostrar di√°logo de inconsist√™ncia de dias
 */
function mostrarDialogoInconsistenciaDias()
{
    try
    {
        let dialog = new ej.popups.Dialog({
            header: '<div style="display: flex; align-items: center; justify-content: space-between;">' +
                '<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color: #e67e22;"></i>' +
                '<span style="flex-grow: 1; text-align: center;">Dia da semana inconsistente</span>' +
                '<i class="fa fa-exclamation-triangle" aria-hidden="true" style="color: #e67e22;"></i>' +
                '</div>',
            content: '<div style="font-size: 1.1em; color: #555; line-height: 1.5;">' +
                '<p><i class="fa fa-calendar" aria-hidden="true" style="color: #3498db;"></i> O dia da semana da data inicial n√£o corresponde a nenhum dos dias selecionados.</p>' +
                '<p><strong>O que deseja fazer?</strong></p>' +
                '</div>',
            showCloseIcon: true,
            closeOnEscape: false,
            isModal: true,
            position: { X: "center", Y: "center" },
            buttons: [
                {
                    click: function ()
                    {
                        dialog.hide();
                    },
                    buttonModel: {
                        content: '<i class="fa-light fa-rocket-launch" aria-hidden="true"></i> Ignorar',
                        isPrimary: true,
                        cssClass: 'e-success custom-button'
                    }
                },
                {
                    click: function ()
                    {
                        document.getElementById('txtDataInicial').value = '';
                        document.getElementById('txtDataInicial').focus();
                        dialog.hide();
                    },
                    buttonModel: {
                        content: '<i class="fa fa-calendar" aria-hidden="true"></i> Mudar Data Inicial',
                        cssClass: 'e-warning custom-button'
                    }
                },
                {
                    click: function ()
                    {
                        let diasSelect = document.getElementById('lstDias').ej2_instances[0];
                        if (diasSelect instanceof ej.dropdowns.MultiSelect)
                        {
                            diasSelect.value = [];
                        }
                        dialog.hide();
                    },
                    buttonModel: {
                        content: '<i class="fa-regular fa-broom-ball" aria-hidden="true"></i> Limpar Dias da Semana',
                        cssClass: 'e-danger custom-button'
                    }
                }
            ],
            animationSettings: { effect: 'Zoom' },
            cssClass: 'custom-dialog',
            width: '450px',
            height: 'auto',
            visible: true,
            close: () =>
            {
                dialog.destroy();
            }
        });

        dialog.appendTo('#dialog-container-diassemana');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "mostrarDialogoInconsistenciaDias", error);
    }
}

/**
 * Validar datas inicial e final
 */
async function validarDatasInicialFinal(dataInicial, dataFinal)
{
    try
    {
        const dtIni = parseData(dataInicial);
        const dtFim = parseData(dataFinal);

        if (!dtIni || !dtFim || isNaN(dtIni) || isNaN(dtFim))
        {
            return true; // Datas inv√°lidas, deixar valida√ß√£o para outro momento
        }

        const diff = (dtFim - dtIni) / (1000 * 60 * 60 * 24);

        if (diff < 0)
        {
            Alerta.Erro("Datas Inv√°lidas", "A data final n√£o pode ser anterior √† data inicial");
            return false;
        }

        if (diff >= 5)
        {
            const confirmacao = await Alerta.Confirmar(
                "Aten√ß√£o",
                "A Data Final est√° 5 dias ou mais ap√≥s a Inicial. Tem certeza?",
                "Tenho certeza! üí™üèº",
                "Me enganei! üòü"
            );

            return confirmacao;
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarDatasInicialFinal", error);
        return false;
    }
}

// ====================================================================
// SE√á√ÉO 14: RICH TEXT EDITOR
// ====================================================================

/**
 * Configurar Rich Text Editor
 */
function configurarRichTextEditor()
{
    try
    {
        const rteDescricao = document.getElementById('rteDescricao');
        if (!rteDescricao) return;

        // Verificar se j√° existe inst√¢ncia
        let rteInstance = rteDescricao.ej2_instances?.[0];

        if (!rteInstance)
        {
            // Criar nova inst√¢ncia
            rteInstance = new ej.richtexteditor.RichTextEditor({
                height: 250,
                locale: 'pt-BR',
                toolbarSettings: {
                    items: [
                        'Bold', 'Italic', 'Underline', 'StrikeThrough',
                        'FontName', 'FontSize', 'FontColor', 'BackgroundColor',
                        'LowerCase', 'UpperCase', '|',
                        'Formats', 'Alignments', 'OrderedList', 'UnorderedList',
                        'Outdent', 'Indent', '|',
                        'CreateLink', 'Image', '|',
                        'ClearFormat', 'Print',
                        'SourceCode', 'FullScreen', '|', 'Undo', 'Redo'
                    ]
                },
                insertImageSettings: {
                    saveUrl: 'api/Viagem/SaveImage',
                    path: './DadosEditaveis/ImagensViagens/'
                },
                created: function ()
                {
                    defaultRTEDescricao = this;
                }
            });

            rteInstance.appendTo('#rteDescricao');
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarRichTextEditor", error);
    }
}

/**
 * Handler para toolbar click do RTE
 */
function toolbarClick(e)
{
    try
    {
        if (e.item.id === "rte_toolbar_Image")
        {
            const element = document.getElementById("rte_upload");
            element.ej2_instances[0].uploading = function upload(args)
            {
                try
                {
                    args.currentRequest.setRequestHeader(
                        "XSRF-TOKEN",
                        document.getElementsByName("__RequestVerificationToken")[0].value
                    );
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "toolbarClick.upload", error);
                }
            };
        }
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "toolbarClick", error);
    }
}

/**
 * Handler para cria√ß√£o do RTE
 */
function onCreate()
{
    try
    {
        defaultRTE = this;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "onCreate", error);
    }
}

// ====================================================================
// SE√á√ÉO 15: CONFIGURA√á√ÉO DOS DROPDOWNS SYNCFUSION
// ====================================================================

/**
 * Configurar DatePicker do Syncfusion
 */
function configurarDatePickers()
{
    try
    {
        // DatePicker Data Inicial
        const datePickerInicial = new ej.calendars.DatePicker({
            format: 'dd/MM/yyyy',
            locale: 'pt',
            placeholder: 'Selecione a data inicial',
            showClearButton: true,
            change: function (args)
            {
                calcularDuracao();

                // Se for recorr√™ncia semanal, validar dia da semana
                const recorrente = document.getElementById('lstRecorrente')?.ej2_instances?.[0]?.value;
                const intervalo = document.getElementById('lstPeriodos')?.ej2_instances?.[0]?.value;

                if (recorrente === "S" && intervalo === "S")
                {
                    validarConsistenciaDiasSemana();
                }
            }
        });
        datePickerInicial.appendTo('#txtDataInicial');

        // DatePicker Data Final
        const datePickerFinal = new ej.calendars.DatePicker({
            format: 'dd/MM/yyyy',
            locale: 'pt',
            placeholder: 'Selecione a data final',
            showClearButton: true,
            change: function (args)
            {
                calcularDuracao();

                // Validar se data final n√£o √© anterior √† inicial
                const dataInicial = $('#txtDataInicial').val();
                const dataFinal = args.value ? moment(args.value).format('DD/MM/YYYY') : '';

                if (dataInicial && dataFinal)
                {
                    validarDatasInicialFinal(dataInicial, dataFinal);
                }
            }
        });
        datePickerFinal.appendTo('#txtDataFinal');

        // DatePicker Data Final Recorr√™ncia
        const datePickerFinalRec = new ej.calendars.DatePicker({
            format: 'dd/MM/yyyy',
            locale: 'pt',
            placeholder: 'Data final da recorr√™ncia',
            showClearButton: true,
            min: new Date(),
            change: function (args)
            {
                // Validar se est√° ap√≥s a data inicial
                const dataInicial = $('#txtDataInicial').val();
                const dataFinalRec = args.value ? moment(args.value).format('DD/MM/YYYY') : '';

                if (dataInicial && dataFinalRec)
                {
                    const dtIni = parseData(dataInicial);
                    const dtFim = parseData(dataFinalRec);

                    if (dtFim < dtIni)
                    {
                        Alerta.Erro("Data Inv√°lida", "A data final da recorr√™ncia deve ser posterior √† data inicial");
                        this.value = null;
                        this.dataBind();
                    }
                }
            }
        });
        datePickerFinalRec.appendTo('#txtFinalRecorrencia');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarDatePickers", error);
    }
}

/**
 * Configurar Dropdowns/ComboBox
 */
function configurarDropdowns()
{
    try
    {
        // Dropdown Recorrente
        const ddRecorrente = new ej.dropdowns.DropDownList({
            dataSource: [
                { text: 'N√£o', value: 'N' },
                { text: 'Sim', value: 'S' }
            ],
            fields: { text: 'text', value: 'value' },
            placeholder: '√â recorrente?',
            value: 'N',
            change: function (args)
            {
                if (args.value === "S")
                {
                    $("#divPeriodo").show();
                    $("#divFinalRecorrencia").show();
                } else
                {
                    $("#divPeriodo, #divTxtPeriodo, #divDias, #divDiaMes").hide();
                    $("#divFinalRecorrencia, #divFinalFalsoRecorrencia").hide();
                    $("#calendarContainer, #listboxContainer, #listboxContainerHTML").hide();
                }
            }
        });
        ddRecorrente.appendTo('#lstRecorrente');

        // Dropdown Per√≠odos
        const ddPeriodos = new ej.dropdowns.DropDownList({
            dataSource: [
                { text: 'Di√°rio', value: 'D' },
                { text: 'Semanal', value: 'S' },
                { text: 'Quinzenal', value: 'Q' },
                { text: 'Mensal', value: 'M' },
                { text: 'Personalizado', value: 'P' }
            ],
            fields: { text: 'text', value: 'value' },
            placeholder: 'Selecione o per√≠odo',
            change: function (args)
            {
                // Ocultar todos primeiro
                $("#divDias, #divDiaMes").hide();
                $("#calendarContainer, #listboxContainer, #listboxContainerHTML").hide();

                switch (args.value)
                {
                    case "S": // Semanal
                        $("#divDias").show();
                        break;
                    case "M": // Mensal
                        $("#divDiaMes").show();
                        break;
                    case "P": // Personalizado
                        $("#calendarContainer, #listboxContainerHTML").show();
                        inicializarCalendarioRecorrencia();
                        break;
                }
            }
        });
        ddPeriodos.appendTo('#lstPeriodos');
        // MultiSelect Dias da Semana
        const msDias = new ej.dropdowns.MultiSelect({
            dataSource: [
                { text: 'Domingo', value: 'Sunday' },
                { text: 'Segunda', value: 'Monday' },
                { text: 'Ter√ßa', value: 'Tuesday' },
                { text: 'Quarta', value: 'Wednesday' },
                { text: 'Quinta', value: 'Thursday' },
                { text: 'Sexta', value: 'Friday' },
                { text: 'S√°bado', value: 'Saturday' }
            ],
            fields: { text: 'text', value: 'value' },
            placeholder: 'Selecione os dias da semana',
            mode: 'CheckBox',
            showSelectAll: true,
            blur: function (args)
            {
                validarConsistenciaDiasSemana();
            }
        });
        msDias.appendTo('#lstDias');

        // Dropdown Dia do M√™s
        const diasMes = [];
        for (let i = 1; i <= 31; i++)
        {
            diasMes.push({ text: i.toString(), value: i });
        }

        const ddDiaMes = new ej.dropdowns.DropDownList({
            dataSource: diasMes,
            fields: { text: 'text', value: 'value' },
            placeholder: 'Selecione o dia do m√™s'
        });
        ddDiaMes.appendTo('#lstDiasMes');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarDropdowns", error);
    }
}

/**
 * Configurar template customizado para motorista
 */
function configurarTemplateMotorista()
{
    try
    {
        const lstMotorista = document.getElementById('lstMotorista');
        if (!lstMotorista) return;

        // Aguardar inst√¢ncia estar pronta
        setTimeout(() =>
        {
            const combo = lstMotorista.ej2_instances?.[0];
            if (!combo) return;

            // Template para itens da lista
            combo.itemTemplate = function (data)
            {
                return '<div class="d-flex align-items-center">' +
                    '<img src="' + (data.FotoBase64 || '/Images/barbudo.jpg') +
                    '" alt="Foto" style="height:40px; width:40px; border-radius:50%; margin-right:10px;" />' +
                    '<span>' + data.Nome + '</span>' +
                    '</div>';
            };

            // Template para valor selecionado
            combo.valueTemplate = function (data)
            {
                if (!data) return '';
                return '<div class="d-flex align-items-center">' +
                    '<img src="' + (data.FotoBase64 || '/Images/barbudo.jpg') +
                    '" alt="Foto" style="height:30px; width:30px; border-radius:50%; margin-right:10px;" />' +
                    '<span>' + data.Nome + '</span>' +
                    '</div>';
            };

            combo.dataBind();
        }, 500);

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarTemplateMotorista", error);
    }
}

//=====================================================================
// SE√á√ÉO 15.5: Motorista e Ve√≠culo
//=====================================================================
//// ============== MOTORISTA ================ ////
/**
* Configurar eventos do motorista
*/
function configurarEventosMotorista()
{
    try
    {
        // Configurar evento de mudan√ßa do dropdown de motorista
        $('#lstMotorista').on('change', function ()
        {
            try
            {
                const motoristaId = document.getElementById('lstMotorista')?.ej2_instances?.[0]?.value;

                if (!motoristaId)
                {
                    console.log('Nenhum motorista selecionado');
                    return;
                }

                console.log('Motorista selecionado:', motoristaId);

                // Se existir campo de telefone do motorista, atualizar
                if ($('#txtTelefoneMotorista').length > 0)
                {
                    buscarTelefoneMotorista(motoristaId);
                }

                // Se existir campo de CNH, atualizar
                if ($('#txtCNHMotorista').length > 0)
                {
                    buscarCNHMotorista(motoristaId);
                }

            } catch (error)
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "lstMotorista.change", error);
            }
        });

        // Configurar evento de select do dropdown de motorista (quando seleciona um item)
        const lstMotorista = document.getElementById('lstMotorista')?.ej2_instances?.[0];
        if (lstMotorista)
        {
            lstMotorista.select = function (args)
            {
                try
                {
                    console.log('Motorista selecionado via select:', args.itemData);
                    // Adicione aqui qualquer l√≥gica adicional necess√°ria ao selecionar
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "lstMotorista.select", error);
                }
            };
        }

        console.log('‚úì Eventos do motorista configurados');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosMotorista", error);
    }
}

/**
 * Buscar telefone do motorista
 */
function buscarTelefoneMotorista(motoristaId)
{
    try
    {
        $.ajax({
            url: '/api/Motorista/ObterTelefone',
            type: 'GET',
            data: { id: motoristaId },
            success: function (response)
            {
                if (response && response.telefone)
                {
                    $('#txtTelefoneMotorista').val(response.telefone);
                } else
                {
                    $('#txtTelefoneMotorista').val('');
                }
            },
            error: function (xhr, status, error)
            {
                console.error('Erro ao buscar telefone do motorista:', error);
                $('#txtTelefoneMotorista').val('');
            }
        });
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "buscarTelefoneMotorista", error);
    }
}

/**
 * Buscar CNH do motorista
 */
function buscarCNHMotorista(motoristaId)
{
    try
    {
        $.ajax({
            url: '/api/Motorista/ObterCNH',
            type: 'GET',
            data: { id: motoristaId },
            success: function (response)
            {
                if (response && response.cnh)
                {
                    $('#txtCNHMotorista').val(response.cnh);
                    $('#txtValidadeCNH').val(response.validade || '');
                } else
                {
                    $('#txtCNHMotorista').val('');
                    $('#txtValidadeCNH').val('');
                }
            },
            error: function (xhr, status, error)
            {
                console.error('Erro ao buscar CNH do motorista:', error);
                $('#txtCNHMotorista').val('');
                $('#txtValidadeCNH').val('');
            }
        });
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "buscarCNHMotorista", error);
    }
}

/**
* Configurar eventos do ve√≠culo
*/
function configurarEventosVeiculo()
{
    try
    {
        // Configurar evento de mudan√ßa do dropdown de ve√≠culo
        $('#lstVeiculo').on('change', function ()
        {
            try
            {
                const veiculoId = document.getElementById('lstVeiculo')?.ej2_instances?.[0]?.value;

                if (!veiculoId)
                {
                    console.log('Nenhum ve√≠culo selecionado');
                    // Limpar campos relacionados
                    $('#txtKmAtual').val('');
                    $('#txtPlaca').val('');
                    $('#txtModelo').val('');
                    return;
                }

                console.log('Ve√≠culo selecionado:', veiculoId);

                // Buscar dados do ve√≠culo
                buscarDadosVeiculo(veiculoId);

                // Se existir campo de KM atual, atualizar
                if ($('#txtKmAtual').length > 0)
                {
                    buscarKmAtualVeiculo(veiculoId);
                }

            } catch (error)
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "lstVeiculo.change", error);
            }
        });

        // Configurar evento de select do dropdown de ve√≠culo
        const lstVeiculo = document.getElementById('lstVeiculo')?.ej2_instances?.[0];
        if (lstVeiculo)
        {
            lstVeiculo.select = function (args)
            {
                try
                {
                    console.log('Ve√≠culo selecionado via select:', args.itemData);
                    // Adicione aqui qualquer l√≥gica adicional necess√°ria ao selecionar
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "lstVeiculo.select", error);
                }
            };
        }

        console.log('‚úì Eventos do ve√≠culo configurados');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosVeiculo", error);
    }
}

/**
 * Buscar dados completos do ve√≠culo
 */
function buscarDadosVeiculo(veiculoId)
{
    try
    {
        $.ajax({
            url: '/api/Veiculo/ObterDados',
            type: 'GET',
            data: { id: veiculoId },
            success: function (response)
            {
                if (response)
                {
                    // Preencher campos relacionados ao ve√≠culo
                    if (response.placa) $('#txtPlaca').val(response.placa);
                    if (response.modelo) $('#txtModelo').val(response.modelo);
                    if (response.marca) $('#txtMarca').val(response.marca);
                    if (response.ano) $('#txtAno').val(response.ano);
                    if (response.combustivel) $('#txtCombustivel').val(response.combustivel);
                } else
                {
                    // Limpar campos se n√£o houver dados
                    $('#txtPlaca').val('');
                    $('#txtModelo').val('');
                    $('#txtMarca').val('');
                    $('#txtAno').val('');
                    $('#txtCombustivel').val('');
                }
            },
            error: function (xhr, status, error)
            {
                console.error('Erro ao buscar dados do ve√≠culo:', error);
                // Limpar campos em caso de erro
                $('#txtPlaca').val('');
                $('#txtModelo').val('');
                $('#txtMarca').val('');
            }
        });
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "buscarDadosVeiculo", error);
    }
}

/**
 * Buscar KM atual do ve√≠culo
 */
function buscarKmAtualVeiculo(veiculoId)
{
    try
    {
        $.ajax({
            url: '/api/Veiculo/ObterKmAtual',
            type: 'GET',
            data: { id: veiculoId },
            success: function (response)
            {
                if (response && response.kmAtual !== undefined)
                {
                    $('#txtKmAtual').val(response.kmAtual);

                    // Se existir campo de KM inicial, copiar o valor
                    if ($('#txtKmInicial').length > 0 && !$('#txtKmInicial').val())
                    {
                        $('#txtKmInicial').val(response.kmAtual);
                    }
                } else
                {
                    $('#txtKmAtual').val('');
                }
            },
            error: function (xhr, status, error)
            {
                console.error('Erro ao buscar KM atual do ve√≠culo:', error);
                $('#txtKmAtual').val('');
            }
        });
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "buscarKmAtualVeiculo", error);
    }
}

/**
 * Configurar bot√µes do modal baseado no contexto
 */
function configurarBotoesModal()
{
    try
    {
        console.log('Configurando bot√µes do modal...');

        // Obter refer√™ncias dos bot√µes
        const btnConfirma = $('#btnConfirma');
        const btnViagem = $('#btnViagem');
        const btnApaga = $('#btnApaga');
        const btnCancela = $('#btnCancela');
        const btnFecha = $('#btnFecha');
        const btnImprime = $('#btnImprime');

        // Configurar estado inicial dos bot√µes
        if (!ViagemId)
        {
            // Modo cria√ß√£o - apenas Confirmar e Fechar
            btnConfirma.show().prop('disabled', false);
            btnViagem.hide();
            btnApaga.hide();
            btnCancela.show();
            btnFecha.show();
            btnImprime.hide();

            console.log('‚úì Bot√µes configurados para modo cria√ß√£o');
        } else
        {
            // Modo edi√ß√£o - mostrar bot√µes conforme status
            if (StatusViagem === 'Realizada' || StatusViagem === 'Cancelada')
            {
                // Viagem finalizada - apenas visualiza√ß√£o
                btnConfirma.hide();
                btnViagem.hide();
                btnApaga.hide();
                btnCancela.hide();
                btnFecha.show();
                btnImprime.show();

                console.log('‚úì Bot√µes configurados para viagem finalizada');
            } else if (StatusViagem === 'Agendada')
            {
                // Agendamento - mostrar bot√£o de transformar em viagem
                btnConfirma.show().prop('disabled', false);
                btnViagem.show().prop('disabled', false);
                btnApaga.show().prop('disabled', false);
                btnCancela.show();
                btnFecha.show();
                btnImprime.hide();

                console.log('‚úì Bot√µes configurados para agendamento');
            } else
            {
                // Viagem aberta - todos os bot√µes relevantes
                btnConfirma.show().prop('disabled', false);
                btnViagem.hide();
                btnApaga.show().prop('disabled', false);
                btnCancela.show();
                btnFecha.show();
                btnImprime.show();

                console.log('‚úì Bot√µes configurados para viagem aberta');
            }
        }

        // Configurar textos dos bot√µes
        configurarTextosBotoes();

        // Configurar √≠cones dos bot√µes
        configurarIconesBotoes();

        console.log('‚úì Configura√ß√£o de bot√µes do modal conclu√≠da');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarBotoesModal", error);
    }
}

/**
 * Configurar textos dos bot√µes baseado no contexto
 */
function configurarTextosBotoes()
{
    try
    {
        const btnConfirma = $('#btnConfirma');
        const btnViagem = $('#btnViagem');

        // Texto do bot√£o Confirmar
        if (!ViagemId)
        {
            btnConfirma.html('<i class="fas fa-save"></i> Criar Agendamento');
        } else if (StatusViagem === 'Agendada')
        {
            btnConfirma.html('<i class="fas fa-save"></i> Salvar Altera√ß√µes');
        } else
        {
            btnConfirma.html('<i class="fas fa-save"></i> Atualizar Viagem');
        }

        // Texto do bot√£o Viagem
        if (StatusViagem === 'Agendada')
        {
            btnViagem.html('<i class="fas fa-car"></i> Transformar em Viagem');
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarTextosBotoes", error);
    }
}

/**
 * Configurar √≠cones dos bot√µes com FontAwesome
 */
function configurarIconesBotoes()
{
    try
    {
        // Adicionar √≠cones se n√£o existirem
        if (!$('#btnApaga').find('i').length)
        {
            $('#btnApaga').prepend('<i class="fas fa-trash"></i> ');
        }

        if (!$('#btnCancela').find('i').length)
        {
            $('#btnCancela').prepend('<i class="fas fa-times"></i> ');
        }

        if (!$('#btnFecha').find('i').length)
        {
            $('#btnFecha').prepend('<i class="fas fa-times-circle"></i> ');
        }

        if (!$('#btnImprime').find('i').length)
        {
            $('#btnImprime').prepend('<i class="fas fa-print"></i> ');
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarIconesBotoes", error);
    }
}

// ====================================================================
// SE√á√ÉO 16: INICIALIZA√á√ÉO PRINCIPAL
// ====================================================================

/**
 * Inicializa√ß√£o quando o DOM estiver pronto
 */
$(document).ready(function ()
{
    try
    {
        console.log("üöÄ Iniciando agendamento_viagem.js");

        // Configurar componentes Syncfusion
        configurarDatePickers();
        configurarDropdowns();
        configurarRichTextEditor();
        configurarTemplateMotorista();

        // Configurar eventos
        configurarEventosQuilometragem();
        configurarEventosDatas();
        configurarEventosRequisitante();
        configurarEventosRecorrencia();
        configurarEventosFinalidade();
        configurarEventosMotorista();
        configurarEventosVeiculo();
        configurarBotoesModal();

        // Valida√ß√£o de ficha de vistoria
        validarFichaVistoria();

        // Inicializar calend√°rio
        InitializeCalendar("api/Agenda/CarregaViagens");

        // Configurar evento para criar novo agendamento
        $('#btnNovoAgendamento').on('click', function (e)
        {
            e.preventDefault();
            criarNovoAgendamento();
        });

        // Evento ao fechar modal
        $('#modalViagens').on('hidden.bs.modal', function ()
        {
            limparCamposModalViagens();
            isSubmitting = false;
            modalLock = false;
        });

        // Configurar tooltips Syncfusion
        if (typeof refreshTooltips === 'function')
        {
            setTimeout(() =>
            {
                refreshTooltips();
            }, 1000);
        }

        // Configurar evento do solicitante de atividade
        $('#seletorSolicitanteAtividade').on('change', function ()
        {
            const requisitanteId = document.getElementById('seletorSolicitanteAtividade')?.ej2_instances?.[0]?.value;

            if (!requisitanteId) return;

            // Carregar setor do requisitante
            $.ajax({
                url: "/api/Agenda/PegaSetor",
                method: "GET",
                datatype: "json",
                data: { id: requisitanteId },
                success: function (res)
                {
                    if (res.success && res.data)
                    {
                        const ddtSetor = document.getElementById('seletorDepartamentoSolicitante')?.ej2_instances?.[0];
                        if (ddtSetor)
                        {
                            ddtSetor.value = [res.data];
                            ddtSetor.dataBind();
                        }
                    }
                }
            });

            // Carregar ramal do requisitante
            $.ajax({
                url: "/api/Agenda/PegaRamal",
                method: "GET",
                datatype: "json",
                data: { id: requisitanteId },
                success: function (res)
                {
                    if (res.success)
                    {
                        $("#txtRamalEvento").val(res.data);
                    }
                }
            });
        });

        console.log("‚úÖ agendamento_viagem.js carregado com sucesso");

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "document.ready", error);
    }
});

// ====================================================================
// SE√á√ÉO 17: FUN√á√ïES AUXILIARES DE MODAL
// ====================================================================

/**
 * Configurar modal para novo agendamento
 */
function configurarModalNovoAgendamento()
{
    try
    {
        // Configurar t√≠tulo
        document.getElementById("Titulo").innerHTML =
            "<h3 class='modal-title'><i class='fad fa-calendar-alt' aria-hidden='true'></i> Criar Novo Agendamento</h3>";

        // Configurar bot√µes - CORRE√á√ÉO: Esconder Apagar e Cancelar em novo agendamento
        $("#btnViagem").hide();
        $("#btnApaga").hide();
        $("#btnCancela").hide();
        $("#btnConfirma").show().html("<i class='fa fa-save' aria-hidden='true'></i> Criar Agendamento");
        $("#btnFecha").show();

        // Esconder campo de ficha vistoria (s√≥ aparece em viagem aberta)
        $("#divNoFichaVistoria").hide();

        // Configurar status
        StatusViagem = "Agendada";
        $('#txtStatusAgendamento').val(true);

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarModalNovoAgendamento", error);
    }
}

/**
 * Configurar modal para edi√ß√£o de agendamento
 */
function configurarModalEdicaoAgendamento(viagem)
{
    try
    {
        // Configurar t√≠tulo baseado no status
        if (viagem.status === "Realizada" || viagem.status === "Cancelada")
        {
            const statusText = viagem.status === "Realizada" ? "Realizada" : "Cancelada";
            document.getElementById("Titulo").innerHTML =
                `<h3 class='modal-title'>
                    <i class='fa-duotone fa-solid fa-suitcase-rolling' aria-hidden='true'></i> 
                    Visualizando ${viagem.statusAgendamento ? 'Agendamento' : 'Viagem'} ${statusText}
                </h3>`;

            // Apenas bot√µes de visualiza√ß√£o
            $("#btnViagem, #btnConfirma, #btnApaga, #btnCancela").hide();
            $("#btnFecha").show();

        } else if (viagem.status === "Agendada")
        {
            document.getElementById("Titulo").innerHTML =
                `<h3 class='modal-title'>
                    <i class='fa-duotone fa-solid fa-calendar-check' aria-hidden='true'></i> 
                    Editando Agendamento
                </h3>`;

            // Mostrar bot√µes apropriados
            $("#btnConfirma, #btnApaga, #btnCancela, #btnFecha").show();
            $("#btnViagem").toggle(viagem.statusAgendamento === true);

        } else if (viagem.status === "Aberta")
        {
            document.getElementById("Titulo").innerHTML =
                `<h3 class='modal-title'>
                    <i class='fa-duotone fa-solid fa-suitcase-rolling' aria-hidden='true'></i> 
                    Editando Viagem Aberta
                </h3>`;

            // Mostrar todos os bot√µes exceto transformar
            $("#btnConfirma, #btnApaga, #btnCancela, #btnFecha").show();
            $("#btnViagem").hide();
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarModalEdicaoAgendamento", error);
    }
}

// ====================================================================
// SE√á√ÉO 18: GERENCIAMENTO DE RECORR√äNCIA AVAN√áADA
// ====================================================================

/**
 * Processar edi√ß√£o de agendamento recorrente
 */
async function processarEdicaoRecorrente(dados)
{
    try
    {
        // Se n√£o for recorrente, retornar dados sem altera√ß√£o
        if (dados.recorrente !== "S")
        {
            return dados;
        }

        // Se for a primeira recorr√™ncia, n√£o perguntar (data inicial bloqueada)
        if (agendamentoRecorrenteGlobal.ehPrimeiraRecorrencia)
        {
            dados.editarTodos = true;
            return dados;
        }

        // Perguntar ao usu√°rio usando Alerta.Confirmar3
        const resultado = await Alerta.Confirmar3(
            'Editar Agendamento Recorrente',
            'Deseja aplicar as altera√ß√µes a todos os agendamentos recorrentes ou apenas ao atual?',
            'Todos',
            'Apenas ao Atual',
            'Desistir'
        );

        if (resultado === false || resultado === "Desistir")
        {
            throw new Error('Opera√ß√£o cancelada pelo usu√°rio');
        }

        dados.editarTodos = (resultado === "Todos");

        // Se editar todos, buscar todas as datas da recorr√™ncia
        if (dados.editarTodos)
        {
            const response = await $.ajax({
                url: '/api/Agenda/GetDatasViagem',
                method: 'GET',
                data: {
                    viagemId: dados.viagemId,
                    recorrenciaViagemId: dados.recorrenciaViagemId || '',
                    editarProximos: false
                }
            });

            if (response && Array.isArray(response))
            {
                dados.datasSelecionadas = response;
            }
        }

        return dados;

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "processarEdicaoRecorrente", error);
        throw error;
    }
}

/**
 * Gerar datas de recorr√™ncia baseado na configura√ß√£o
 */
function gerarDatasRecorrencia(configuracao)
{
    try
    {
        const datas = [];
        const dataInicial = moment(configuracao.dataInicial, 'DD/MM/YYYY');
        const dataFinal = moment(configuracao.dataFinalRecorrencia, 'DD/MM/YYYY');

        if (!dataInicial.isValid() || !dataFinal.isValid())
        {
            console.error("Datas inv√°lidas para gerar recorr√™ncia");
            return datas;
        }

        let dataAtual = dataInicial.clone();

        switch (configuracao.intervalo)
        {
            case 'D': // Di√°rio
                while (dataAtual.isSameOrBefore(dataFinal))
                {
                    datas.push(dataAtual.toDate());
                    dataAtual.add(1, 'day');
                }
                break;

            case 'S': // Semanal
                const diasSemana = [];
                if (configuracao.monday) diasSemana.push(1);
                if (configuracao.tuesday) diasSemana.push(2);
                if (configuracao.wednesday) diasSemana.push(3);
                if (configuracao.thursday) diasSemana.push(4);
                if (configuracao.friday) diasSemana.push(5);
                if (configuracao.saturday) diasSemana.push(6);
                if (configuracao.sunday) diasSemana.push(0);

                while (dataAtual.isSameOrBefore(dataFinal))
                {
                    if (diasSemana.includes(dataAtual.day()))
                    {
                        datas.push(dataAtual.toDate());
                    }
                    dataAtual.add(1, 'day');
                }
                break;

            case 'Q': // Quinzenal
                while (dataAtual.isSameOrBefore(dataFinal))
                {
                    datas.push(dataAtual.toDate());
                    dataAtual.add(14, 'days');
                }
                break;

            case 'M': // Mensal
                const diaDoMes = configuracao.diaMesRecorrencia || dataInicial.date();
                while (dataAtual.isSameOrBefore(dataFinal))
                {
                    // Ajustar para o dia correto do m√™s
                    dataAtual.date(Math.min(diaDoMes, dataAtual.daysInMonth()));
                    if (dataAtual.isSameOrBefore(dataFinal))
                    {
                        datas.push(dataAtual.toDate());
                    }
                    dataAtual.add(1, 'month');
                    dataAtual.date(1); // Resetar para o primeiro dia antes de adicionar
                }
                break;

            case 'P': // Personalizado
                // Usar as datas j√° selecionadas no calend√°rio
                return configuracao.datasSelecionadas || [];
        }

        return datas;

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "gerarDatasRecorrencia", error);
        return [];
    }
}

// ====================================================================
// SE√á√ÉO 19: RELAT√ìRIOS E IMPRESS√ÉO
// ====================================================================

/**
 * Gerar relat√≥rio de viagem
 */
function gerarRelatorioViagem()
{
    try
    {
        const viagemId = $('#txtViagemId').val();
        if (!viagemId)
        {
            Alerta.Erro("Erro", "Selecione uma viagem para gerar o relat√≥rio");
            return;
        }

        // Mostrar container do relat√≥rio
        $("#ReportContainer").show().addClass("visible").css("height", "auto");
        $("#fichaReport").html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-3x"></i><br>Carregando relat√≥rio...</div>');

        // Carregar relat√≥rio via AJAX
        $.ajax({
            url: '/api/Relatorio/FichaViagem',
            type: 'GET',
            data: { viagemId: viagemId },
            success: function (response)
            {
                try
                {
                    if (response.success && response.reportUrl)
                    {
                        // Carregar PDF no container
                        $("#fichaReport").html(
                            '<iframe src="' + response.reportUrl + '" style="width:100%; height:600px; border:none;"></iframe>'
                        );
                    } else
                    {
                        $("#fichaReport").html('<div class="alert alert-warning">Relat√≥rio n√£o dispon√≠vel</div>');
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "gerarRelatorioViagem.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                $("#fichaReport").html('<div class="alert alert-danger">Erro ao carregar relat√≥rio</div>');
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "gerarRelatorioViagem.error", error);
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "gerarRelatorioViagem", error);
    }
}
/**
 * Imprimir ficha de viagem
 */
function imprimirFichaViagem()
{
    try
    {
        const viagemId = $('#txtViagemId').val();
        if (!viagemId)
        {
            Alerta.Erro("Erro", "Selecione uma viagem para imprimir");
            return;
        }

        // Abrir nova janela para impress√£o
        const url = `/Relatorio/FichaViagem?viagemId=${viagemId}`;
        window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "imprimirFichaViagem", error);
    }
}

// ====================================================================
// SE√á√ÉO 20: VALIDA√á√ïES ESPEC√çFICAS DE VIAGEM
// ====================================================================

/**
 * Validar quilometragem
 */
async function validarQuilometragem()
{
    try
    {
        const kmInicial = parseFloat($('#txtKmInicial').val()) || 0;
        const kmFinal = parseFloat($('#txtKmFinal').val()) || 0;
        const kmAtual = parseFloat($('#txtKmAtual').val()) || 0;

        // Validar se KM inicial n√£o √© maior que KM final
        if (kmInicial > 0 && kmFinal > 0 && kmInicial > kmFinal)
        {
            Alerta.Erro("Quilometragem Inv√°lida", "KM Final n√£o pode ser menor que KM Inicial");
            $('#txtKmFinal').val('').focus();
            return false;
        }

        // Validar se KM inicial n√£o √© menor que KM atual do ve√≠culo
        if (kmInicial > 0 && kmAtual > 0 && kmInicial < kmAtual)
        {
            const confirmar = await Alerta.Confirmar(
                "KM Inicial Suspeito",
                `KM Inicial (${kmInicial}) √© menor que o KM Atual do ve√≠culo (${kmAtual}). Deseja continuar?`,
                "Sim, est√° correto",
                "N√£o, vou corrigir"
            );

            if (!confirmar)
            {
                $('#txtKmInicial').focus();
                return false;
            }
        }

        // Validar dist√¢ncia percorrida
        const distancia = kmFinal - kmInicial;
        if (distancia > 1000)
        {
            const confirmar = await Alerta.Confirmar(
                "Dist√¢ncia Elevada",
                `A dist√¢ncia percorrida (${distancia} km) parece muito alta. Confirma?`,
                "Sim, est√° correto",
                "N√£o, vou revisar"
            );

            if (!confirmar)
            {
                return false;
            }
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarQuilometragem", error);
        return false;
    }
}

/**
 * Validar combust√≠vel
 */
function validarCombustivel()
{
    try
    {
        const combustivelInicial = document.getElementById('ddtCombustivelInicial')?.ej2_instances?.[0]?.value?.[0];
        const combustivelFinal = document.getElementById('ddtCombustivelFinal')?.ej2_instances?.[0]?.value?.[0];

        if (combustivelInicial && combustivelFinal)
        {
            const nivelInicial = parseInt(combustivelInicial);
            const nivelFinal = parseInt(combustivelFinal);

            // Se o n√≠vel final for maior que o inicial, provavelmente houve abastecimento
            if (nivelFinal > nivelInicial)
            {
                console.log("‚ÑπÔ∏è Detectado poss√≠vel abastecimento durante a viagem");
                // Aqui poderia adicionar l√≥gica adicional se necess√°rio
            }
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarCombustivel", error);
        return false;
    }
}

/**
 * Validar hor√°rios
 */
async function validarHorarios()
{
    try
    {
        const dataInicial = $('#txtDataInicial').val();
        const horaInicial = $('#txtHoraInicial').val();
        const dataFinal = $('#txtDataFinal').val();
        const horaFinal = $('#txtHoraFinal').val();

        if (dataInicial && horaInicial && dataFinal && horaFinal)
        {
            const dtInicial = moment(`${dataInicial} ${horaInicial}`, "DD/MM/YYYY HH:mm");
            const dtFinal = moment(`${dataFinal} ${horaFinal}`, "DD/MM/YYYY HH:mm");

            if (dtFinal.isBefore(dtInicial))
            {
                Alerta.Erro("Hor√°rios Inv√°lidos", "Data/hora final n√£o pode ser anterior √† inicial");
                return false;
            }

            const duracaoHoras = dtFinal.diff(dtInicial, 'hours', true);

            // Alertar se dura√ß√£o for muito longa
            if (duracaoHoras > 24)
            {
                const confirmar = await Alerta.Confirmar(
                    "Dura√ß√£o Longa",
                    `A viagem tem dura√ß√£o de ${duracaoHoras.toFixed(1)} horas. Est√° correto?`,
                    "Sim, est√° correto",
                    "N√£o, vou revisar"
                );

                if (!confirmar)
                {
                    return false;
                }
            }
        }

        return true;
    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "validarHorarios", error);
        return false;
    }
}

// ====================================================================
// SE√á√ÉO 21: AJAX HANDLERS
// ====================================================================

/**
 * Handler gen√©rico para erros AJAX
 */
function handleAjaxError(xhr, status, error, context)
{
    try
    {
        console.error(`Erro AJAX em ${context}:`, {
            status: xhr.status,
            statusText: xhr.statusText,
            responseText: xhr.responseText,
            error: error
        });

        let mensagemErro = "Erro ao processar requisi√ß√£o";

        if (xhr.status === 401)
        {
            mensagemErro = "Sess√£o expirada. Por favor, fa√ßa login novamente.";
            setTimeout(() =>
            {
                window.location.href = '/Login';
            }, 2000);
        } else if (xhr.status === 403)
        {
            mensagemErro = "Voc√™ n√£o tem permiss√£o para executar esta a√ß√£o.";
        } else if (xhr.status === 404)
        {
            mensagemErro = "Recurso n√£o encontrado.";
        } else if (xhr.status === 500)
        {
            mensagemErro = "Erro interno do servidor. Tente novamente.";
        } else if (xhr.status === 0)
        {
            mensagemErro = "Sem conex√£o com o servidor. Verifique sua internet.";
        }

        AppToast.show("Vermelho", mensagemErro, 4000);

    } catch (err)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "handleAjaxError", err);
    }
}

/**
 * Configurar interceptadores AJAX globais
 */
function configurarInterceptadoresAjax()
{
    try
    {
        // Configurar token CSRF para todas as requisi√ß√µes
        $.ajaxSetup({
            beforeSend: function (xhr, settings)
            {
                if (!(/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) && !this.crossDomain)
                {
                    const token = $('input[name="__RequestVerificationToken"]').val();
                    if (token)
                    {
                        xhr.setRequestHeader("RequestVerificationToken", token);
                    }
                }
            }
        });

        // Interceptar erros globalmente
        $(document).ajaxError(function (event, xhr, settings, thrownError)
        {
            console.error("Erro AJAX Global:", {
                url: settings.url,
                type: settings.type,
                status: xhr.status,
                error: thrownError
            });
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarInterceptadoresAjax", error);
    }
}

// ====================================================================
// SE√á√ÉO 22: FUN√á√ïES DE BUSCA E FILTRO
// ====================================================================

/**
 * Buscar viagens por per√≠odo
 */
function buscarViagensPorPeriodo(dataInicio, dataFim)
{
    try
    {
        $.ajax({
            url: '/api/Agenda/BuscarViagens',
            type: 'GET',
            data: {
                dataInicio: moment(dataInicio).format('YYYY-MM-DD'),
                dataFim: moment(dataFim).format('YYYY-MM-DD')
            },
            success: function (response)
            {
                try
                {
                    if (response.success && response.data)
                    {
                        // Processar viagens encontradas
                        console.log(`Encontradas ${response.data.length} viagens no per√≠odo`);

                        // Aqui voc√™ pode adicionar l√≥gica para exibir as viagens
                        // Por exemplo, atualizar uma tabela ou lista
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "buscarViagensPorPeriodo.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                handleAjaxError(xhr, status, error, "buscarViagensPorPeriodo");
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "buscarViagensPorPeriodo", error);
    }
}

/**
 * Filtrar viagens por status
 */
function filtrarViagensPorStatus(status)
{
    try
    {
        const viagens = calendar.getEvents();

        viagens.forEach(evento =>
        {
            const eventoStatus = evento.extendedProps?.status;

            if (status === "Todos" || eventoStatus === status)
            {
                evento.setProp('display', 'auto');
            } else
            {
                evento.setProp('display', 'none');
            }
        });

        calendar.render();

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "filtrarViagensPorStatus", error);
    }
}

// ====================================================================
// SE√á√ÉO 23: EXPORTA√á√ÉO E IMPORTA√á√ÉO
// ====================================================================

/**
 * Exportar viagens para Excel
 */
function exportarViagensExcel()
{
    try
    {
        const filtros = {
            dataInicio: $('#filtroDataInicio').val(),
            dataFim: $('#filtroDataFim').val(),
            status: $('#filtroStatus').val(),
            motorista: $('#filtroMotorista').val(),
            veiculo: $('#filtroVeiculo').val()
        };

        // Criar query string com filtros
        const queryString = $.param(filtros);

        // Abrir download
        window.location.href = `/api/Relatorio/ExportarViagensExcel?${queryString}`;

        AppToast.show("Verde", "Download iniciado. Aguarde...", 3000);

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "exportarViagensExcel", error);
    }
}

/**
 * Importar viagens de arquivo
 */
function importarViagensArquivo()
{
    try
    {
        // Criar input file tempor√°rio
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv,.xlsx,.xls';

        input.onchange = function (e)
        {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('arquivo', file);

            // Mostrar loading
            Swal.fire({
                title: 'Importando...',
                text: 'Processando arquivo de viagens',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () =>
                {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '/api/Viagem/ImportarArquivo',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response)
                {
                    Swal.close();

                    if (response.success)
                    {
                        AppToast.show("Verde",
                            `Importa√ß√£o conclu√≠da! ${response.totalImportado} viagens importadas.`,
                            5000);

                        // Atualizar calend√°rio
                        if (calendar)
                        {
                            calendar.refetchEvents();
                        }
                    } else
                    {
                        Alerta.Erro("Erro na Importa√ß√£o",
                            response.message || "Erro ao processar arquivo");
                    }
                },
                error: function (xhr, status, error)
                {
                    Swal.close();
                    handleAjaxError(xhr, status, error, "importarViagensArquivo");
                }
            });
        };

        input.click();

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "importarViagensArquivo", error);
    }
}

// ====================================================================
// SE√á√ÉO 24: NOTIFICA√á√ïES E LEMBRETES
// ====================================================================

/**
 * Verificar viagens pendentes
 */
function verificarViagensPendentes()
{
    try
    {
        $.ajax({
            url: '/api/Agenda/ViagensPendentes',
            type: 'GET',
            success: function (response)
            {
                try
                {
                    if (response.success && response.data)
                    {
                        const pendentes = response.data;

                        if (pendentes.length > 0)
                        {
                            // Mostrar notifica√ß√£o
                            AppToast.show("Amarelo",
                                `Voc√™ tem ${pendentes.length} viagem(s) pendente(s) para hoje`,
                                5000);

                            // Adicionar badge ao bot√£o de agendamentos
                            const badge = $('#badgeViagensPendentes');
                            if (badge.length === 0)
                            {
                                $('#btnAgendamentos').append(
                                    `<span id="badgeViagensPendentes" class="badge badge-danger ml-2">${pendentes.length}</span>`
                                );
                            } else
                            {
                                badge.text(pendentes.length);
                            }
                        }
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "verificarViagensPendentes.success", error);
                }
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "verificarViagensPendentes", error);
    }
}

/**
 * Configurar notifica√ß√µes autom√°ticas
 */
function configurarNotificacoesAutomaticas()
{
    try
    {
        // Verificar viagens pendentes a cada 5 minutos
        setInterval(() =>
        {
            verificarViagensPendentes();
        }, 300000); // 5 minutos

        // Verificar uma vez ao carregar
        verificarViagensPendentes();

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarNotificacoesAutomaticas", error);
    }
}

// ====================================================================
// SE√á√ÉO 25: HIST√ìRICO E AUDITORIA
// ====================================================================

/**
 * Carregar hist√≥rico de altera√ß√µes da viagem
 */
function carregarHistoricoViagem(viagemId)
{
    try
    {
        $.ajax({
            url: '/api/Agenda/HistoricoViagem',
            type: 'GET',
            data: { viagemId: viagemId },
            success: function (response)
            {
                try
                {
                    if (response.success && response.data)
                    {
                        const historico = response.data;

                        // Criar HTML do hist√≥rico
                        let htmlHistorico = '<div class="timeline">';

                        historico.forEach(item =>
                        {
                            const data = moment(item.dataAlteracao).format('DD/MM/YYYY HH:mm');
                            const icone = obterIconeHistorico(item.tipo);

                            htmlHistorico += `
                                <div class="timeline-item">
                                    <div class="timeline-icon">
                                        ${icone}
                                    </div>
                                    <div class="timeline-content">
                                        <h6>${item.descricao}</h6>
                                        <p class="text-muted">
                                            <small>${item.usuario} - ${data}</small>
                                        </p>
                                        ${item.detalhes ? `<p>${item.detalhes}</p>` : ''}
                                    </div>
                                </div>
                            `;
                        });

                        htmlHistorico += '</div>';

                        // Exibir em modal ou painel
                        $('#historicoContainer').html(htmlHistorico);
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "carregarHistoricoViagem.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                handleAjaxError(xhr, status, error, "carregarHistoricoViagem");
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "carregarHistoricoViagem", error);
    }
}

/**
 * Obter √≠cone apropriado para tipo de hist√≥rico
 */
function obterIconeHistorico(tipo)
{
    try
    {
        const icones = {
            'criacao': '<i class="fa-duotone fa-plus-circle text-success"></i>',
            'edicao': '<i class="fa-duotone fa-edit text-info"></i>',
            'cancelamento': '<i class="fa-duotone fa-ban text-danger"></i>',
            'finalizacao': '<i class="fa-duotone fa-check-circle text-success"></i>',
            'transformacao': '<i class="fa-duotone fa-exchange text-warning"></i>'
        };

        return icones[tipo] || '<i class="fa-duotone fa-info-circle text-secondary"></i>';

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "obterIconeHistorico", error);
        return '<i class="fa-duotone fa-info-circle"></i>';
    }
}

/**
 * Registrar a√ß√£o no log
 */
function registrarAcaoLog(acao, detalhes)
{
    try
    {
        // Esta fun√ß√£o pode ser usada para registrar a√ß√µes localmente
        // ou enviar para o servidor para auditoria

        const logEntry = {
            timestamp: new Date().toISOString(),
            acao: acao,
            detalhes: detalhes,
            usuario: $('#currentUser').val() || 'Desconhecido',
            pagina: 'agendamento_viagem'
        };

        // Armazenar localmente (opcional)
        const logs = JSON.parse(localStorage.getItem('logsViagem') || '[]');
        logs.push(logEntry);

        // Manter apenas os √∫ltimos 100 logs
        if (logs.length > 100)
        {
            logs.shift();
        }

        localStorage.setItem('logsViagem', JSON.stringify(logs));

        // Enviar para servidor (opcional)
        if (acao === 'erro' || acao === 'critico')
        {
            $.ajax({
                url: '/api/Log/Registrar',
                type: 'POST',
                data: JSON.stringify(logEntry),
                contentType: 'application/json'
                // Fire and forget - n√£o aguardar resposta
            });
        }

    } catch (error)
    {
        console.error("Erro ao registrar log:", error);
    }
}

// ====================================================================
// SE√á√ÉO 26: INTEGRA√á√ÉO COM MAPAS
// ====================================================================

/**
 * Calcular rota entre origem e destino
 */
function calcularRota()
{
    try
    {
        const origem = document.getElementById('cmbOrigem')?.ej2_instances?.[0]?.value;
        const destino = document.getElementById('cmbDestino')?.ej2_instances?.[0]?.value;

        if (!origem || !destino)
        {
            console.log("Origem ou destino n√£o definidos");
            return;
        }

        // Se tiver integra√ß√£o com Google Maps ou outro servi√ßo
        if (typeof google !== 'undefined' && google.maps)
        {
            const directionsService = new google.maps.DirectionsService();
            const directionsRequest = {
                origin: origem,
                destination: destino,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC
            };

            directionsService.route(directionsRequest, function (result, status)
            {
                if (status === google.maps.DirectionsStatus.OK)
                {
                    const route = result.routes[0];
                    const distance = route.legs[0].distance.value / 1000; // Em km
                    const duration = route.legs[0].duration.text;

                    console.log(`Dist√¢ncia: ${distance} km`);
                    console.log(`Dura√ß√£o estimada: ${duration}`);

                    // Sugerir KM Final baseado na dist√¢ncia
                    const kmInicial = parseFloat($('#txtKmInicial').val()) || 0;
                    if (kmInicial > 0)
                    {
                        const kmFinalSugerido = Math.round(kmInicial + distance);
                        $('#txtKmFinal').attr('placeholder', `Sugest√£o: ${kmFinalSugerido}`);
                    }
                }
            });
        }

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "calcularRota", error);
    }
}

/**
 * Exibir mapa com rota
 */
function exibirMapaRota()
{
    try
    {
        const origem = document.getElementById('cmbOrigem')?.ej2_instances?.[0]?.value;
        const destino = document.getElementById('cmbDestino')?.ej2_instances?.[0]?.value;

        if (!origem || !destino)
        {
            Alerta.Erro("Dados Incompletos", "Defina origem e destino para visualizar a rota");
            return;
        }

        // Abrir modal com mapa
        const modalHtml = `
            <div class="modal fade" id="modalMapa" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rota da Viagem</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="mapContainer" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Adicionar modal ao body se n√£o existir
        if ($('#modalMapa').length === 0)
        {
            $('body').append(modalHtml);
        }

        $('#modalMapa').modal('show');

        // Inicializar mapa ap√≥s modal abrir
        $('#modalMapa').on('shown.bs.modal', function ()
        {
            // Aqui voc√™ iniciaria o mapa com a API escolhida
            console.log("Inicializar mapa com rota de", origem, "para", destino);
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "exibirMapaRota", error);
    }
}

// ====================================================================
// SE√á√ÉO 27: ESTAT√çSTICAS E DASHBOARD
// ====================================================================

/**
 * Carregar estat√≠sticas de viagens
 */
function carregarEstatisticasViagens()
{
    try
    {
        const mes = moment().format('MM');
        const ano = moment().format('YYYY');

        $.ajax({
            url: '/api/Agenda/Estatisticas',
            type: 'GET',
            data: { mes: mes, ano: ano },
            success: function (response)
            {
                try
                {
                    if (response.success && response.data)
                    {
                        const stats = response.data;

                        // Atualizar cards de estat√≠sticas
                        $('#totalViagens').text(stats.totalViagens || 0);
                        $('#viagensRealizadas').text(stats.realizadas || 0);
                        $('#viagensPendentes').text(stats.pendentes || 0);
                        $('#viagensCanceladas').text(stats.canceladas || 0);
                        $('#kmTotal').text((stats.kmTotal || 0).toLocaleString('pt-BR'));

                        // Calcular percentuais
                        if (stats.totalViagens > 0)
                        {
                            const pctRealizada = ((stats.realizadas / stats.totalViagens) * 100).toFixed(1);
                            const pctCancelada = ((stats.canceladas / stats.totalViagens) * 100).toFixed(1);

                            $('#pctRealizada').text(`${pctRealizada}%`);
                            $('#pctCancelada').text(`${pctCancelada}%`);
                        }

                        // Atualizar gr√°ficos se existirem
                        if (typeof atualizarGraficos === 'function')
                        {
                            atualizarGraficos(stats);
                        }
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("agendamento_viagem.js", "carregarEstatisticasViagens.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                console.error("Erro ao carregar estat√≠sticas:", error);
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "carregarEstatisticasViagens", error);
    }
}

/**
 * Gerar relat√≥rio mensal
 */
function gerarRelatorioMensal()
{
    try
    {
        const mes = $('#selectMes').val() || moment().format('MM');
        const ano = $('#selectAno').val() || moment().format('YYYY');

        // Mostrar loading
        Swal.fire({
            title: 'Gerando Relat√≥rio',
            text: 'Processando dados do per√≠odo...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () =>
            {
                Swal.showLoading();
            }
        });

        $.ajax({
            url: '/api/Relatorio/Mensal',
            type: 'GET',
            data: { mes: mes, ano: ano },
            success: function (response)
            {
                Swal.close();

                if (response.success && response.urlRelatorio)
                {
                    // Abrir relat√≥rio em nova aba
                    window.open(response.urlRelatorio, '_blank');

                    AppToast.show("Verde", "Relat√≥rio gerado com sucesso!", 3000);
                } else
                {
                    Alerta.Erro("Erro", "N√£o foi poss√≠vel gerar o relat√≥rio");
                }
            },
            error: function (xhr, status, error)
            {
                Swal.close();
                handleAjaxError(xhr, status, error, "gerarRelatorioMensal");
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "gerarRelatorioMensal", error);
    }
}

// ====================================================================
// SE√á√ÉO 28: ATALHOS DE TECLADO
// ====================================================================

/**
 * Configurar atalhos de teclado
 */
function configurarAtalhosTeclado()
{
    try
    {
        $(document).on('keydown', function (e)
        {
            // Verificar se n√£o est√° em campo de texto
            if ($(e.target).is('input, textarea, select'))
            {
                return;
            }

            // Ctrl+N - Novo agendamento
            if (e.ctrlKey && e.key === 'n')
            {
                e.preventDefault();
                criarNovoAgendamento();
            }

            // Ctrl+S - Salvar (se modal estiver aberto)
            if (e.ctrlKey && e.key === 's')
            {
                if ($('#modalViagens').is(':visible'))
                {
                    e.preventDefault();
                    salvarAgendamento();
                }
            }

            // ESC - Fechar modal
            if (e.key === 'Escape')
            {
                if ($('#modalViagens').is(':visible'))
                {
                    $('#modalViagens').modal('hide');
                }
            }

            // F5 - Atualizar calend√°rio
            if (e.key === 'F5')
            {
                e.preventDefault();
                if (calendar)
                {
                    calendar.refetchEvents();
                    AppToast.show("Verde", "Calend√°rio atualizado", 2000);
                }
            }

            // Ctrl+P - Imprimir (se viagem estiver aberta)
            if (e.ctrlKey && e.key === 'p')
            {
                if ($('#modalViagens').is(':visible') && $('#txtViagemId').val())
                {
                    e.preventDefault();
                    imprimirFichaViagem();
                }
            }
        });

        console.log("‚úÖ Atalhos de teclado configurados");

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarAtalhosTeclado", error);
    }
}

// ====================================================================
// SE√á√ÉO 29: PERFORMANCE E OTIMIZA√á√ÉO
// ====================================================================

/**
 * Debounce para otimizar chamadas frequentes
 */
function debounce(func, wait)
{
    let timeout;
    return function executedFunction(...args)
    {
        const later = () =>
        {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Throttle para limitar execu√ß√µes
 */
function throttle(func, limit)
{
    let inThrottle;
    return function (...args)
    {
        if (!inThrottle)
        {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

/**
 * Lazy load de componentes pesados
 */
function lazyLoadComponentes()
{
    try
    {
        // Observador para carregar componentes quando vis√≠veis
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries, observer) =>
        {
            entries.forEach(entry =>
            {
                if (entry.isIntersecting)
                {
                    const elemento = entry.target;

                    // Carregar componente baseado no data-attribute
                    if (elemento.dataset.component === 'calendar' && !calendar)
                    {
                        inicializarCalendario();
                        observer.unobserve(elemento);
                    }

                    if (elemento.dataset.component === 'richtext' && !defaultRTE)
                    {
                        configurarRichTextEditor();
                        observer.unobserve(elemento);
                    }
                }
            });
        }, observerOptions);

        // Observar elementos que precisam lazy load
        document.querySelectorAll('[data-lazy-load]').forEach(el =>
        {
            observer.observe(el);
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "lazyLoadComponentes", error);
    }
}

/**
 * Cache de dados frequentemente acessados
 */
const cacheManager = {
    cache: new Map(),

    set: function (key, value, ttl = 300000)
    { // TTL padr√≠o de 5 minutos
        try
        {
            const item = {
                value: value,
                expiry: Date.now() + ttl
            };
            this.cache.set(key, item);
        } catch (error)
        {
            console.error("Erro ao armazenar cache:", error);
        }
    },

    get: function (key)
    {
        try
        {
            const item = this.cache.get(key);
            if (!item) return null;

            if (Date.now() > item.expiry)
            {
                this.cache.delete(key);
                return null;
            }

            return item.value;
        } catch (error)
        {
            console.error("Erro ao recuperar cache:", error);
            return null;
        }
    },

    clear: function ()
    {
        this.cache.clear();
    }
};

/* =========================================
   BLOCO 9: FUN√á√ïES FINAIS E INICIALIZA√á√ÉO
   ========================================= */

// Fun√ß√£o para carregar viagem bloqueada
function CarregaViagemBloqueada(viagemId)
{
    try
    {
        if (!viagemId)
        {
            console.error('ViagemId n√£o fornecido');
            return;
        }

        CarregandoViagemBloqueada = true;

        // Mostrar loading se existir
        if (window.FtxSpin && FtxSpin.show)
        {
            FtxSpin.show('Carregando viagem...');
        }

        $.ajax({
            url: '/api/Viagem/ObterViagemBloqueada',
            type: 'GET',
            data: { id: viagemId },
            success: function (response)
            {
                try
                {
                    if (response && response.success && response.data)
                    {
                        // Processar dados da viagem bloqueada
                        console.log('Viagem bloqueada carregada:', response.data);

                        // Atualizar interface conforme necess√°rio
                        if (window.ExibeViagemBloqueada)
                        {
                            ExibeViagemBloqueada(response.data);
                        }

                        if (window.AppToast)
                        {
                            AppToast.show('Verde', 'Viagem carregada com sucesso', 2000);
                        }
                    } else
                    {
                        throw new Error(response?.message || 'Erro ao carregar viagem');
                    }
                } catch (error)
                {
                    Alerta.TratamentoErroComLinha("viagem_index.js", "CarregaViagemBloqueada.success", error);
                }
            },
            error: function (xhr, status, error)
            {
                console.error('Erro ao carregar viagem bloqueada:', error);
                if (window.Alerta && Alerta.Erro)
                {
                    Alerta.Erro('Erro', 'N√£o foi poss√≠vel carregar a viagem bloqueada');
                }
                Alerta.TratamentoErroComLinha("viagem_index.js", "CarregaViagemBloqueada.error", error);
            },
            complete: function ()
            {
                CarregandoViagemBloqueada = false;
                if (window.FtxSpin && FtxSpin.hide)
                {
                    FtxSpin.hide();
                }
            }
        });

    } catch (error)
    {
        CarregandoViagemBloqueada = false;
        Alerta.TratamentoErroComLinha("viagem_index.js", "CarregaViagemBloqueada", error);
    }
}

// Fun√ß√£o para atualizar status da viagem
function AtualizarStatusViagem(viagemId, novoStatus)
{
    try
    {
        if (!viagemId || !novoStatus)
        {
            console.error('Par√¢metros inv√°lidos');
            return;
        }

        $.ajax({
            url: '/api/Viagem/AtualizarStatus',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                viagemId: viagemId,
                status: novoStatus
            }),
            success: function (response)
            {
                if (response && response.success)
                {
                    console.log('Status atualizado com sucesso');

                    // Atualizar a linha na tabela se existir
                    const linha = document.querySelector(`tr[data-viagem-id="${viagemId}"]`);
                    if (linha)
                    {
                        const badgeStatus = linha.querySelector('.badge-status');
                        if (badgeStatus)
                        {
                            badgeStatus.textContent = novoStatus;
                            badgeStatus.className = 'badge badge-status badge-' + novoStatus.toLowerCase();
                        }
                    }

                    if (window.AppToast)
                    {
                        AppToast.show('Verde', 'Status atualizado com sucesso', 2000);
                    }
                } else
                {
                    throw new Error(response?.message || 'Erro ao atualizar status');
                }
            },
            error: function (xhr, status, error)
            {
                console.error('Erro ao atualizar status:', error);
                if (window.Alerta && Alerta.Erro)
                {
                    Alerta.Erro('Erro', 'N√£o foi poss√≠vel atualizar o status da viagem');
                }
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("viagem_index.js", "AtualizarStatusViagem", error);
    }
}

// Fun√ß√£o para validar formul√°rio de viagem
function ValidarFormularioViagem()
{
    try
    {
        const erros = [];

        // Validar campos obrigat√≥rios
        const camposObrigatorios = [
            { id: 'txtOrigem', nome: 'Origem' },
            { id: 'txtDestino', nome: 'Destino' },
            { id: 'txtDataViagem', nome: 'Data da Viagem' },
            { id: 'txtMotorista', nome: 'Motorista' },
            { id: 'txtVeiculo', nome: 'Ve√≠culo' }
        ];

        camposObrigatorios.forEach(campo =>
        {
            const elemento = document.getElementById(campo.id);
            if (elemento)
            {
                const valor = elemento.value || '';
                if (!valor.trim())
                {
                    erros.push(`${campo.nome} √© obrigat√≥rio`);
                    elemento.classList.add('is-invalid');
                } else
                {
                    elemento.classList.remove('is-invalid');
                }
            }
        });

        // Validar data
        const dataViagem = document.getElementById('txtDataViagem');
        if (dataViagem && dataViagem.value)
        {
            const data = moment(dataViagem.value, 'DD/MM/YYYY');
            if (!data.isValid())
            {
                erros.push('Data da viagem inv√°lida');
                dataViagem.classList.add('is-invalid');
            }
        }

        // Validar hor√°rios
        const horaInicio = document.getElementById('txtHoraInicio');
        const horaFim = document.getElementById('txtHoraFim');
        if (horaInicio && horaFim && horaInicio.value && horaFim.value)
        {
            if (horaInicio.value >= horaFim.value)
            {
                erros.push('Hora de in√≠cio deve ser anterior √† hora de t√©rmino');
                horaInicio.classList.add('is-invalid');
                horaFim.classList.add('is-invalid');
            }
        }

        // Exibir erros se houver
        if (erros.length > 0)
        {
            const mensagem = '<ul>' + erros.map(e => `<li>${e}</li>`).join('') + '</ul>';
            if (window.Alerta && Alerta.Erro)
            {
                Alerta.Erro('Valida√ß√£o', mensagem);
            }
            return false;
        }

        return true;

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("viagem_index.js", "ValidarFormularioViagem", error);
        return false;
    }
}

/* =========================================
   BLOCO 10: INICIALIZA√á√ÉO FINAL
   ========================================= */

// Configura√ß√£o final quando o documento estiver pronto
$(document).ready(function ()
{
    try
    {
        console.log('=== Inicializando Viagem Index ===');

        // Verificar depend√™ncias
        if (!window.jQuery)
        {
            console.error('jQuery n√£o est√° carregado');
            return;
        }

        // Inicializar componentes
        if (window.InitializeDataTable && typeof InitializeDataTable === 'function')
        {
            InitializeDataTable();
        }

        // Configurar event listeners globais
        configurarEventListeners();

        // Carregar dados iniciais se necess√°rio
        const urlParams = new URLSearchParams(window.location.search);
        const viagemId = urlParams.get('id');
        if (viagemId)
        {
            CarregaViagemBloqueada(viagemId);
        }

        // Configurar auto-refresh se necess√°rio
        if (window.AUTO_REFRESH_ENABLED)
        {
            setInterval(function ()
            {
                if (typeof RefreshDataTable === 'function')
                {
                    RefreshDataTable();
                }
            }, window.AUTO_REFRESH_INTERVAL || 60000);
        }

        // Configurar tratamento de erros global
        window.addEventListener('error', function (event)
        {
            console.error('Erro global capturado:', event.error);
            if (window.Alerta && Alerta.TratamentoErroComLinha)
            {
                Alerta.TratamentoErroComLinha("viagem_index.js", "window.error", event.error);
            }
        });

        // Limpar recursos ao sair da p√°gina
        window.addEventListener('beforeunload', function ()
        {
            try
            {
                // Limpar timers
                if (window.refreshTimer)
                {
                    clearInterval(window.refreshTimer);
                }

                // Limpar cache de fotos se necess√°rio
                if (window.FtxFotoCache && FtxFotoCache.clear)
                {
                    FtxFotoCache.clear();
                }

            } catch (error)
            {
                console.error('Erro ao limpar recursos:', error);
            }
        });

        console.log('=== Viagem Index inicializado com sucesso ===');

    } catch (error)
    {
        console.error('Erro na inicializa√ß√£o:', error);
        Alerta.TratamentoErroComLinha("viagem_index.js", "document.ready", error);
    }
});

// Fun√ß√£o para configurar event listeners
function configurarEventListeners()
{
    try
    {
        // Bot√£o de nova viagem
        $('#btnNovaViagem').on('click', function ()
        {
            try
            {
                if (window.AbrirModalNovaViagem)
                {
                    AbrirModalNovaViagem();
                }
            } catch (error)
            {
                Alerta.TratamentoErroComLinha("viagem_index.js", "btnNovaViagem.click", error);
            }
        });

        // Bot√£o de refresh
        $('#btnRefresh').on('click', function ()
        {
            try
            {
                if (typeof RefreshDataTable === 'function')
                {
                    RefreshDataTable();
                }
            } catch (error)
            {
                Alerta.TratamentoErroComLinha("viagem_index.js", "btnRefresh.click", error);
            }
        });

        // Filtros
        $('.filtro-viagem').on('change', function ()
        {
            try
            {
                if (typeof AplicarFiltros === 'function')
                {
                    AplicarFiltros();
                }
            } catch (error)
            {
                Alerta.TratamentoErroComLinha("viagem_index.js", "filtro.change", error);
            }
        });

        // Delega√ß√£o de eventos para elementos din√¢micos
        $(document).on('click', '.btn-editar-viagem', function ()
        {
            try
            {
                const viagemId = $(this).data('id');
                if (viagemId && window.EditarViagem)
                {
                    EditarViagem(viagemId);
                }
            } catch (error)
            {
                Alerta.TratamentoErroComLinha("viagem_index.js", "btnEditar.click", error);
            }
        });

        $(document).on('click', '.btn-excluir-viagem', function ()
        {
            try
            {
                const viagemId = $(this).data('id');
                if (viagemId && window.ExcluirViagem)
                {
                    ExcluirViagem(viagemId);
                }
            } catch (error)
            {
                Alerta.TratamentoErroComLinha("viagem_index.js", "btnExcluir.click", error);
            }
        });

    } catch (error)
    {
        Alerta.TratamentoErroComLinha("viagem_index.js", "configurarEventListeners", error);
    }
}

// Exportar fun√ß√µes para uso global se necess√°rio
if (typeof module !== 'undefined' && module.exports)
{
    module.exports = {
        CarregaViagemBloqueada,
        AtualizarStatusViagem,
        ValidarFormularioViagem,
        ftxQueueFotoFetch,
        configurarEventListeners
    };
}

console.log('=== Arquivo viagem_index.js carregado completamente ===');


// ====================================================================
// SE√á√ÉO 10: CONTROLE DE EVENTOS DE FINALIDADE
// ====================================================================

/**
 * Configurar eventos do campo de finalidade
 */
function configurarEventosFinalidade() 
{
    try 
    {
        const lstFinalidade = document.getElementById('lstFinalidade');

        if (!lstFinalidade || !lstFinalidade.ej2_instances || !lstFinalidade.ej2_instances[0]) 
        {
            console.warn('lstFinalidade n√£o encontrado');
            return;
        }

        const comboFinalidade = lstFinalidade.ej2_instances[0];

        // Evento de mudan√ßa
        comboFinalidade.change = function (args) 
        {
            try 
            {
                const finalidade = args.value;

                if (finalidade === "Evento") 
                {
                    // Mostrar campos de evento
                    $("#divEvento").show();
                    $("#btnGerenciarAtividade").show();

                    // Habilitar dropdown de eventos
                    const lstEventos = document.getElementById('lstEventos')?.ej2_instances?.[0];
                    if (lstEventos) 
                    {
                        lstEventos.enabled = true;
                        lstEventos.dataBind();
                    }
                }
                else 
                {
                    // Esconder campos de evento
                    $("#divEvento").hide();
                    $("#btnGerenciarAtividade").hide();
                    $("#painelGerenciadorAtividade").hide();

                    // Desabilitar e limpar dropdown de eventos
                    const lstEventos = document.getElementById('lstEventos')?.ej2_instances?.[0];
                    if (lstEventos) 
                    {
                        lstEventos.value = null;
                        lstEventos.enabled = false;
                        lstEventos.dataBind();
                    }
                }
            }
            catch (error) 
            {
                Alerta.TratamentoErroComLinha("agendamento_viagem.js", "lstFinalidade.change", error);
            }
        };

        console.log('‚úì Eventos de finalidade configurados');

    }
    catch (error) 
    {
        Alerta.TratamentoErroComLinha("agendamento_viagem.js", "configurarEventosFinalidade", error);
    }
}

