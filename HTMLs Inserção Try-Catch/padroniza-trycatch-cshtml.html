<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8" />
        <title>Padronizar try/catch (CSHTML) ‚Ä¢ LITE</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <style>
            :root {
                --bg: #0f172a;
                --fg: #e2e8f0;
                --muted: #94a3b8;
                --accent: #10b981;
                --border: #1f2937;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: #0f172a;
                color: #e2e8f0;
                font: 14px/1.45 ui-sans-serif, system-ui, -apple-system,
                    Segoe UI, Roboto, Ubuntu;
            }
            header {
                padding: 20px 24px;
                border-bottom: 1px solid var(--border);
            }
            h1 {
                margin: 0;
                font-size: 18px;
            }
            .sub {
                color: #94a3b8;
                margin-top: 6px;
            }
            main {
                display: grid;
                grid-template-columns: 1fr 420px;
                gap: 14px;
                height: calc(100% - 118px);
                padding: 14px;
                box-sizing: border-box;
            }
            .col {
                display: flex;
                flex-direction: column;
                min-height: 0;
            }
            .drop {
                flex: 0 0 auto;
                border: 2px dashed #334155;
                border-radius: 12px;
                padding: 18px;
                margin-bottom: 12px;
                text-align: center;
                background: #0b1022;
            }
            .drop.drag {
                background: #0d182b;
                border-color: var(--accent);
            }
            .btns {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                align-items: center;
            }
            button,
            .btnlike {
                background: #1f2937;
                color: #e5e7eb;
                border: 1px solid #334155;
                border-radius: 8px;
                padding: 10px 12px;
                cursor: pointer;
                display: inline-block;
            }
            .primary {
                background: var(--accent);
                border-color: #059669;
                color: #062d20;
                font-weight: 600;
            }
            textarea,
            pre {
                flex: 1 1 auto;
                background: #0b1022;
                color: #e2e8f0;
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px;
                overflow: auto;
                white-space: pre;
            }
            .panel {
                display: flex;
                flex-direction: column;
                gap: 10px;
                min-height: 0;
            }
            .list {
                background: #0b1022;
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 12px;
                overflow: auto;
            }
            code.k {
                color: #a4cafe;
            }
            .hint {
                color: #94a3b8;
            }
            footer {
                padding: 10px 14px;
                color: #93a3b8;
                border-top: 1px solid var(--border);
            }
            label {
                color: #cbd5e1;
            }
            select,
            input[type="text"] {
                background: #0b1022;
                color: #e2e8f0;
                border: 1px solid #334155;
                border-radius: 8px;
                padding: 8px;
            }
            .opt {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .offscreen {
                position: absolute;
                left: -9999px;
                top: auto;
                width: 1px;
                height: 1px;
                opacity: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>
                Padronizar <code class="k">try/catch</code> em
                <code class="k">.cshtml</code> (LITE)
            </h1>
            <div class="sub">
                Catch padr√≠o ‚Üí
                <code class="k"
                    >Alerta.TratamentoErroComLinha("&lt;ARQUIVO&gt;.cshtml",
                    "<<< nome da fun√ß√£o>>>", error);</code
                >
            </div>
        </header>

        <main>
            <section class="col">
                <div id="drop" class="drop">
                    <input
                        id="file"
                        class="offscreen"
                        type="file"
                        accept=".cshtml,.razor,.html,.htm,.txt"
                        onchange="__onFileChange(this)"
                    />
                    <label
                        id="pick"
                        for="file"
                        class="btnlike primary"
                        role="button"
                        tabindex="0"
                        >Selecionar arquivo</label
                    >
                    <p style="margin-top: 10px" class="hint">
                        Ou arraste e solte aqui. O r√≥tulo usa o nome do arquivo
                        (ex.: <code>UpsertCupons.cshtml</code>).
                    </p>
                </div>

                <div class="panel">
                    <div
                        class="btns"
                        style="gap: 12px; align-items: center; flex-wrap: wrap"
                    >
                        <label class="opt"
                            >R√≥tulo:
                            <input
                                id="labelPreview"
                                type="text"
                                readonly
                                style="width: 300px"
                            />
                        </label>
                        <label class="opt" title="Sempre ativo">
                            <input
                                type="checkbox"
                                id="includeAnon"
                                checked
                                disabled
                            />
                            Incluir callbacks an√¥nimos (sempre)
                        </label>
                        <label class="opt"
                            ><input type="checkbox" id="formatIndent" />
                            Formatar JS (4 espa√ßos)</label
                        >
                        <label class="opt"
                            ><input type="checkbox" id="collapse" checked />
                            Compactar linhas em branco</label
                        >
                    </div>

                    <div class="btns">
                        <button id="copyOut">Copiar HTML final</button>
                        <label for="ext">Baixar como:</label>
                        <select id="ext">
                            <option value=".cshtml">.cshtml</option>
                            <option value=".html">.html</option>
                            <option value=".txt">.txt</option>
                        </select>
                        <button id="downloadOut" class="primary">Baixar</button>
                        <button id="copyList">Copiar lista de fun√ß√µes</button>
                    </div>

                    <textarea
                        id="out"
                        placeholder="HTML final aparecer√° aqui‚Ä¶"
                        spellcheck="false"
                    ></textarea>
                </div>
            </section>

            <aside class="col">
                <div class="panel">
                    <div class="list" id="info">‚Ä¢ Aguardando arquivo‚Ä¶</div>
                    <div class="list">
                        <strong>Resumo:</strong>
                        <pre id="summary">(vazio)</pre>
                    </div>
                    <div class="list">
                        <strong>Fun√ß√µes alteradas:</strong>
                        <pre id="changed">(vazio)</pre>
                    </div>
                    <div class="list">
                        <strong>Log:</strong>
                        <pre id="log"></pre>
                    </div>
                </div>
            </aside>
        </main>

        <footer>Processamento 100% local. Nada √© enviado. üîê</footer>

        <script>
            /* ===== Utilidades ===== */
            function $(s) {
                return document.querySelector(s);
            }
            function toast(msg) {
                $("#info").textContent = "‚Ä¢ " + msg;
            }
            function log(line) {
                $("#log").textContent += line + "\n";
            }
            function downloadBlob(data, name, mime) {
                var b =
                    data instanceof Blob
                        ? data
                        : new Blob([data], {
                              type: mime || "text/plain;charset=utf-8",
                          });
                var a = document.createElement("a");
                a.href = URL.createObjectURL(b);
                a.download = name;
                a.click();
                setTimeout(function () {
                    URL.revokeObjectURL(a.href);
                }, 1500);
            }
            function baseName(n) {
                return String(n || "").replace(/^.*[\\/]/, "");
            }
            function labelFromFileName(n) {
                var bn = baseName(n || "arquivo.cshtml");
                return /\.cshtml$/i.test(bn)
                    ? bn
                    : bn.replace(/\.[^.]+$/, "") + ".cshtml";
            }
            function normalizeWhitespace(s, maxBlank) {
                s = String(s)
                    .replace(/\r\n/g, "\n")
                    .replace(/[ \t]+$/gm, "");
                if (typeof maxBlank === "number") {
                    var re = new RegExp("\\n{" + (maxBlank + 2) + ",}", "g");
                    s = s.replace(re, "\n".repeat(maxBlank + 1));
                }
                return s;
            }

            window.addEventListener("error", function (ev) {
                try {
                    log("[onerror] " + (ev.message || ev.error || "erro"));
                } catch (_) {}
            });
            window.addEventListener("unhandledrejection", function (ev) {
                try {
                    log(
                        "[unhandledrejection] " +
                            ((ev.reason &&
                                (ev.reason.stack || ev.reason.message)) ||
                                String(ev.reason))
                    );
                } catch (_) {}
            });

            /* ===== Parser de <script> (case-insensitive) ===== */
            function indexOfCI(h, n, from) {
                return h.toLowerCase().indexOf(n.toLowerCase(), from || 0);
            }
            function parseScriptsCI(html) {
                var blocks = [],
                    lo = html.toLowerCase(),
                    pos = 0,
                    n = html.length,
                    endTag = "</scr" + "ipt>";
                while (pos < n) {
                    var open = indexOfCI(lo, "<script", pos);
                    if (open < 0) break;
                    var gt = lo.indexOf(">", open);
                    if (gt < 0) break;
                    var attrs = html.slice(open + 7, gt),
                        bodyStart = gt + 1;
                    var close = indexOfCI(lo, endTag, bodyStart);
                    if (close < 0) break;
                    var body = html.slice(bodyStart, close),
                        end = close + endTag.length;
                    blocks.push({
                        start: open,
                        end: end,
                        attrs: attrs,
                        body: body,
                    });
                    pos = end;
                }
                return blocks;
            }

            /* ===== Razor masking (apenas dentro do JS) ===== */
            function maskRazorGeneric(src) {
                src = String(src);
                var out = [],
                    markers = [],
                    i = 0,
                    len = src.length,
                    k = 0;
                function tag(original) {
                    var t = "__RZ" + k++ + "__";
                    markers.push({ tag: t, original: original });
                    return "/*" + t + "*/0/*" + t + "_END*/";
                }
                while (i < len) {
                    var ch = src[i];
                    if (ch === "'" || ch === '"' || ch === "`") {
                        var q = ch,
                            j = i + 1;
                        while (j < len) {
                            var c = src[j];
                            if (c === "\\") {
                                j += 2;
                                continue;
                            }
                            if (q === "`" && c === "$" && src[j + 1] === "{") {
                                j += 2;
                                for (var nest = 1; j < len && nest > 0; j++) {
                                    var d = src[j];
                                    if (d === "\\") {
                                        j += 2;
                                        continue;
                                    }
                                    if (d === "{") nest++;
                                    else if (d === "}") nest--;
                                }
                                continue;
                            }
                            if (c === q) {
                                j++;
                                break;
                            }
                            j++;
                        }
                        out.push(src.slice(i, j));
                        i = j;
                        continue;
                    }
                    if (ch === "/" && src[i + 1] === "/") {
                        var j1 = i + 2;
                        while (j1 < len && src[j1] !== "\n") j1++;
                        out.push(src.slice(i, j1));
                        i = j1;
                        continue;
                    }
                    if (ch === "/" && src[i + 1] === "*") {
                        var j2 = (i = i + 2);
                        while (
                            j2 < len &&
                            !(src[j2] === "*" && src[j2 + 1] === "/")
                        )
                            j2++;
                        j2 = Math.min(len, j2 + 2);
                        out.push(src.slice(i, j2));
                        i = j2;
                        continue;
                    }
                    // N√ÉO mascarar @section {...} aqui (s√≥ JS usa o masking)
                    if (ch === "@" && src[i + 1] === "{") {
                        var j4 = i + 2,
                            n = 1;
                        while (j4 < len && n > 0) {
                            var c2 = src[j4];
                            if (c2 === "'" || c2 === '"' || c2 === "`") {
                                var q2 = c2;
                                j4++;
                                while (j4 < len) {
                                    var d2 = src[j4];
                                    if (d2 === "\\") {
                                        j4 += 2;
                                        continue;
                                    }
                                    if (d2 === q2) {
                                        j4++;
                                        break;
                                    }
                                    j4++;
                                }
                            } else if (c2 === "{") n++;
                            else if (c2 === "}") n--;
                            j4++;
                        }
                        out.push(tag(src.slice(i, j4)));
                        i = j4;
                        continue;
                    }
                    if (ch === "@" && src[i + 1] === "(") {
                        var j5 = i + 2,
                            n2 = 1;
                        while (j5 < len && n2 > 0) {
                            var c3 = src[j5];
                            if (c3 === "'" || c3 === '"' || c3 === "`") {
                                var q3 = c3;
                                j5++;
                                while (j5 < len) {
                                    var d3 = src[j5];
                                    if (d3 === "\\") {
                                        j5 += 2;
                                        continue;
                                    }
                                    if (d3 === q3) {
                                        j5++;
                                        break;
                                    }
                                    j5++;
                                }
                            } else if (c3 === "(") n2++;
                            else if (c3 === ")") n2--;
                            j5++;
                        }
                        out.push(tag(src.slice(i, j5)));
                        i = j5;
                        continue;
                    }
                    if (ch === "@" && /[A-Za-z_]/.test(src[i + 1] || "")) {
                        var j6 = i + 2;
                        while (j6 < len && /[A-Za-z0-9_\.]/.test(src[j6])) j6++;
                        if (src[j6] === "(") {
                            var n3 = 1;
                            j6++;
                            while (j6 < len && n3 > 0) {
                                var c4 = src[j6];
                                if (c4 === "'" || c4 === '"' || c4 === "`") {
                                    var q4 = c4;
                                    j6++;
                                    while (j6 < len) {
                                        var d4 = src[j6];
                                        if (d4 === "\\") {
                                            j6 += 2;
                                            continue;
                                        }
                                        if (d4 === q4) {
                                            j6++;
                                            break;
                                        }
                                        j6++;
                                    }
                                } else if (c4 === "(") n3++;
                                else if (c4 === ")") n3--;
                                j6++;
                            }
                        }
                        out.push(tag(src.slice(i, j6)));
                        i = j6;
                        continue;
                    }
                    out.push(ch);
                    i++;
                }
                return { masked: out.join(""), markers: markers };
            }
            function restoreRazorGeneric(text, markers) {
                var s = text;
                for (var i = 0; i < markers.length; i++) {
                    var m = markers[i],
                        re = new RegExp(
                            "/\\*" +
                                m.tag +
                                "\\*/\\s*0\\s*/\\*" +
                                m.tag +
                                "_END\\*/",
                            "g"
                        );
                    s = s.replace(re, m.original);
                }
                return s;
            }

            /* ===== Helpers JS ===== */
            function isWs(c) {
                return (
                    c === " " ||
                    c === "\t" ||
                    c === "\r" ||
                    c === "\n" ||
                    c === "\u00A0" ||
                    c === "\u200B" ||
                    c === "\u200C" ||
                    c === "\u200D" ||
                    c === "\uFEFF"
                );
            }
            function skipWs(t, i) {
                var n = t.length;
                while (i < n) {
                    var c = t[i];
                    if (isWs(c)) {
                        i++;
                        continue;
                    }
                    if (c === "/" && t[i + 1] === "/") {
                        i += 2;
                        while (i < n && t[i] !== "\n") i++;
                        continue;
                    }
                    if (c === "/" && t[i + 1] === "*") {
                        i += 2;
                        while (i < n && !(t[i] === "*" && t[i + 1] === "/"))
                            i++;
                        i = Math.min(n, i + 2);
                        continue;
                    }
                    break;
                }
                return i;
            }
            function skipIgn(t, i) {
                var n = t.length,
                    adv = true;
                while (adv && i < n) {
                    adv = false;
                    var j = i;
                    i = skipWs(t, i);
                    if (i !== j) {
                        adv = true;
                        continue;
                    }
                    if (t[i] === ";") {
                        i++;
                        adv = true;
                        continue;
                    }
                }
                return i;
            }
            function matchBlock(t, i, open, close) {
                var n = t.length,
                    d = 0;
                while (i < n) {
                    var c = t[i];
                    if (c === '"' || c === "'" || c === "`") {
                        var q = c;
                        i++;
                        while (i < n) {
                            var d2 = t[i];
                            if (d2 === "\\") {
                                i += 2;
                                continue;
                            }
                            if (q === "`" && d2 === "$" && t[i + 1] === "{") {
                                i += 2;
                                for (var nest = 1; i < n && nest > 0; i++) {
                                    var e = t[i];
                                    if (e === "\\") {
                                        i += 2;
                                        continue;
                                    }
                                    if (e === "{") nest++;
                                    else if (e === "}") nest--;
                                }
                                continue;
                            }
                            if (d2 === q) {
                                i++;
                                break;
                            }
                            i++;
                        }
                        continue;
                    }
                    if (c === "/" && t[i + 1] === "/") {
                        i += 2;
                        while (i < n && t[i] !== "\n") i++;
                        continue;
                    }
                    if (c === "/" && t[i + 1] === "*") {
                        i += 2;
                        while (i < n && !(t[i] === "*" && t[i + 1] === "/"))
                            i++;
                        i = Math.min(n, i + 2);
                        continue;
                    }
                    if (c === open) {
                        d++;
                        i++;
                        continue;
                    }
                    if (c === close) {
                        d--;
                        i++;
                        if (d === 0) return i;
                        continue;
                    }
                    i++;
                }
                return -1;
            }

            /* ===== Motor try/catch ===== */
            function transformOneScript(js, fileLabel, collapse, includeAnon) {
                var masked = maskRazorGeneric(js),
                    code = masked.masked;
                var funcs = [];
                function pushFunc(name, openBrace, bodyStart, closeIndex) {
                    funcs.push({
                        name: name,
                        openBrace: openBrace,
                        bodyStart: bodyStart,
                        closeIndex: closeIndex,
                    });
                }
                function safe(n) {
                    return String(n || "").replace(/"/g, '\\"');
                }
                function short(s) {
                    s = String(s || "").trim();
                    if (s.length > 40) s = s.slice(0, 40) + "‚Ä¶";
                    return s;
                }

                /* fun√ß√µes nomeadas */
                (function () {
                    var re =
                            /([^A-Za-z0-9_$]|^)function\s+([A-Za-z_$][\w$]*)\s*\([^)]*\)\s*\{/g,
                        m;
                    while ((m = re.exec(code)) !== null) {
                        var b = m.index + m[0].length - 1;
                        var e = matchBlock(code, b, "{", "}");
                        if (e > b) pushFunc(m[2], b, b + 1, e);
                    }
                })();
                (function () {
                    var re =
                            /([A-Za-z_$][\w$]*(?:\.[A-Za-z_$][\w$]*|\[['"][^'"]+['"]\])?)\s*=\s*function\s*\([^)]*\)\s*\{/g,
                        m;
                    while ((m = re.exec(code)) !== null) {
                        var left = m[1],
                            name,
                            md = /\.([A-Za-z_$][\w$]*)$/.exec(left),
                            mb = /\[['"]([^'"]+)['"]\]$/.exec(left);
                        name = md
                            ? md[1]
                            : mb
                            ? mb[1]
                            : left.replace(/^.*\./, "");
                        var b = m.index + m[0].length - 1;
                        var e = matchBlock(code, b, "{", "}");
                        if (e > b) pushFunc(name, b, b + 1, e);
                    }
                })();
                (function () {
                    var re =
                            /([A-Za-z_$][\w$]*(?:\.[A-Za-z_$][\w$]*|\[['"]([^'"]+)['"]\])?)\s*=\s*(?:\([^)]*\)|[A-Za-z_$][\w$]*)\s*=>\s*\{/g,
                        m;
                    while ((m = re.exec(code)) !== null) {
                        var left = m[1],
                            name,
                            md = /\.([A-Za-z_$][\w$]*)$/.exec(left),
                            mb = /\[['"]([^'"]+)['"]\]$/.exec(left);
                        name = md
                            ? md[1]
                            : mb
                            ? mb[1]
                            : left.replace(/^.*\./, "");
                        var b = m.index + m[0].length - 1;
                        var e = matchBlock(code, b, "{", "}");
                        if (e > b) pushFunc(name, b, b + 1, e);
                    }
                })();

                if (includeAnon) {
                    /* propriedades de objeto (ajax.success/error etc.) */
                    (function () {
                        var re =
                                /\b([A-Za-z_$][\w$]*)\s*:\s*(?:function\s*\([^)]*\)|(?:\([^)]*\)|[A-Za-z_$][\w$]*)\s*=>)\s*\{/g,
                            m;
                        while ((m = re.exec(code)) !== null) {
                            var prop = m[1],
                                name = prop;
                            var before = code.slice(
                                Math.max(0, m.index - 200),
                                m.index
                            );
                            if (/\$\s*\.ajax\s*\(/.test(before))
                                name = "ajax." + prop;
                            var b = m.index + m[0].length - 1,
                                e = matchBlock(code, b, "{", "}");
                            if (e > b) pushFunc(name, b, b + 1, e);
                        }
                    })();

                    /* jQuery: m√©todos diretos (.click, .change, ‚Ä¶) */
                    (function () {
                        var re =
                                /\$\(\s*(?:"([^"]+)"|'([^']+)'|document|window|this)\s*\)\s*\.\s*(click|change|keyup|keydown|keypress|submit|focus|blur|input|select)\s*\(\s*(?:function\s*\([^)]*\)|\([^)]*\)\s*=>)\s*\{/g,
                            m;
                        while ((m = re.exec(code)) !== null) {
                            var sel = short(m[1] || m[2] || "this"),
                                method = m[3];
                            var label = sel + "." + method;
                            var b = m.index + m[0].length - 1,
                                e = matchBlock(code, b, "{", "}");
                            if (e > b) pushFunc(label, b, b + 1, e);
                        }
                    })();

                    /* jQuery: .on('evt', handler) */
                    (function () {
                        var re =
                                /\.on\s*\(\s*(?:"([^"]+)"|'([^']+)')\s*,\s*(?:function\s*\([^)]*\)|\([^)]*\)\s*=>)\s*\{/g,
                            m;
                        while ((m = re.exec(code)) !== null) {
                            var evt = m[1] || m[2] || "evento";
                            var b = m.index + m[0].length - 1;
                            var e = matchBlock(code, b, "{", "}");
                            if (e > b) pushFunc("on " + evt, b, b + 1, e);
                        }
                    })();

                    /* ready shorthands */
                    (function () {
                        var re =
                                /\$\s*\(\s*(?:function\s*\([^)]*\)|\([^)]*\)\s*=>)\s*\{/g,
                            m;
                        while ((m = re.exec(code)) !== null) {
                            var b = m.index + m[0].length - 1;
                            var e = matchBlock(code, b, "{", "}");
                            if (e > b) pushFunc("$.ready", b, b + 1, e);
                        }
                    })();
                    (function () {
                        var re =
                                /\$\(\s*document\s*\)\.ready\s*\(\s*(?:function\s*\([^)]*\)|\([^)]*\)\s*=>)\s*\{/g,
                            m;
                        while ((m = re.exec(code)) !== null) {
                            var b = m.index + m[0].length - 1;
                            var e = matchBlock(code, b, "{", "}");
                            if (e > b) pushFunc("document.ready", b, b + 1, e);
                        }
                    })();
                }

                /* nada detectado? s√≥ limpa "undefined" p√≥s Html.Raw */
                if (!funcs.length) {
                    var final0 = restoreRazorGeneric(
                        code,
                        masked.markers
                    ).replace(
                        /^\s*(@Html\.Raw\([^)]*\))\s*undefined\s*$/m,
                        "$1"
                    );
                    if (collapse) final0 = normalizeWhitespace(final0, 1);
                    return { code: final0, changed: [], detected: 0 };
                }

                /* evitar ranges sobrepostos */
                funcs.sort(function (a, b) {
                    return a.bodyStart - b.bodyStart;
                });
                var filtered = [],
                    last = -1;
                for (var i = 0; i < funcs.length; i++) {
                    var f = funcs[i];
                    if (f.bodyStart >= last) {
                        filtered.push(f);
                        last = f.closeIndex;
                    }
                }
                funcs = filtered;

                function bodyIsSingleTry(f) {
                    var i = skipIgn(code, f.bodyStart);
                    if (code.slice(i, i + 3) !== "try") return null;
                    i += 3;
                    i = skipWs(code, i);
                    if (code[i] !== "{") return null;
                    var tryEnd = matchBlock(code, i, "{", "}");
                    if (tryEnd < 0) return null;
                    var j = skipIgn(code, tryEnd);
                    if (code.slice(j, j + 5) !== "catch") return null;
                    var catchHeaderStart = j + 5;
                    j += 5;
                    j = skipWs(code, j);
                    if (code[j] === "(") {
                        var after = matchBlock(code, j, "(", ")");
                        if (after < 0) return null;
                        j = after;
                    }
                    j = skipWs(code, j);
                    if (code[j] !== "{") return null;
                    var cOpen = j,
                        cBodyStart = j + 1,
                        cBodyEnd = matchBlock(code, j, "{", "}");
                    if (cBodyEnd < 0) return null;
                    var k = skipIgn(code, cBodyEnd);
                    if (code.slice(k, k + 7) === "finally") {
                        k += 7;
                        k = skipWs(code, k);
                        if (code[k] !== "{") return null;
                        var finEnd = matchBlock(code, k, "{", "}");
                        if (finEnd < 0) return null;
                        k = skipIgn(code, finEnd);
                    }
                    k = skipIgn(code, k);
                    if (k !== f.closeIndex) return null;
                    return {
                        catchHeaderStart: catchHeaderStart,
                        catchOpenBrace: cOpen,
                        catchBodyStart: cBodyStart,
                        catchBodyEnd: cBodyEnd,
                    };
                }
                function standardizeCatch(name, ci) {
                    var fname = safe(name);
                    var pStart = code.indexOf("(", ci.catchHeaderStart);
                    var pEnd =
                        pStart >= 0 ? matchBlock(code, pStart, "(", ")") : -1;
                    if (pStart >= 0 && pEnd > pStart) {
                        code =
                            code.slice(0, pStart) +
                            "(error)" +
                            code.slice(pEnd);
                        var diff = "(error)".length - (pEnd - pStart);
                        if (ci.catchOpenBrace > pEnd) {
                            ci.catchOpenBrace += diff;
                            ci.catchBodyStart += diff;
                            ci.catchBodyEnd += diff;
                        }
                    } else {
                        code =
                            code.slice(0, ci.catchHeaderStart) +
                            "(error) " +
                            code.slice(ci.catchHeaderStart);
                        var d2 = "(error) ".length;
                        ci.catchOpenBrace += d2;
                        ci.catchBodyStart += d2;
                        ci.catchBodyEnd += d2;
                    }
                    var cBody = code.slice(ci.catchBodyStart, ci.catchBodyEnd);
                    cBody = cBody.replace(
                        /(?:Alerta\.)?TratamentoErroComLinha\s*\([^;]*\)\s*;?/g,
                        ""
                    );
                    var linha =
                        'Alerta.TratamentoErroComLinha("' +
                        fileLabel +
                        '", "' +
                        fname +
                        '", error);';
                    cBody =
                        "\n  " +
                        linha +
                        "\n" +
                        cBody.replace(/^\s+$/gm, "").replace(/\n{3,}/g, "\n\n");
                    code =
                        code.slice(0, ci.catchBodyStart) +
                        cBody +
                        code.slice(ci.catchBodyEnd);
                }
                function wrapWithTry(name, f) {
                    var fname = safe(name),
                        original = code.slice(f.bodyStart, f.closeIndex - 1);
                    var linha =
                        'Alerta.TratamentoErroComLinha("' +
                        fileLabel +
                        '", "' +
                        fname +
                        '", error);';
                    var newBody =
                        "\n  try {\n" +
                        original +
                        "\n  } catch (error) {\n    " +
                        linha +
                        "\n  }\n";
                    code =
                        code.slice(0, f.openBrace) +
                        "{" +
                        newBody +
                        "}" +
                        code.slice(f.closeIndex);
                }

                funcs.sort(function (a, b) {
                    return b.bodyStart - a.bodyStart;
                });
                var changed = [];
                for (var k = 0; k < funcs.length; k++) {
                    var f = funcs[k],
                        ci = bodyIsSingleTry(f);
                    if (ci) standardizeCatch(f.name, ci);
                    else wrapWithTry(f.name, f);
                    changed.push(f.name);
                }

                var final = restoreRazorGeneric(code, masked.markers).replace(
                    /^\s*(@Html\.Raw\([^)]*\))\s*undefined\s*$/m,
                    "$1"
                );
                if (collapse) final = normalizeWhitespace(final, 1);
                return {
                    code: final,
                    changed: changed,
                    detected: funcs.length,
                };
            }

            /* ===== Passo CSHTML (varre direto o DOC ‚Äì pega ScriptsBlock) ===== */
            function transformCshtml(doc, opts) {
                opts = opts || {};
                var fileLabel = opts.fileLabel;
                var collapse = !!opts.collapse;
                var includeAnon = true; // sempre ativo

                // Varre <script> diretamente no documento original
                var blocks = parseScriptsCI(doc);
                log("[scan] scripts totais: " + blocks.length);

                var parts = [],
                    last = 0,
                    changedReport = [];
                var total = 0,
                    changedS = 0,
                    detF = 0,
                    chF = 0;

                for (var i = 0; i < blocks.length; i++) {
                    var b = blocks[i];
                    parts.push(doc.slice(last, b.start));
                    last = b.end;

                    var attrs = b.attrs || "",
                        body = b.body || "";
                    var m =
                        /\btype\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s>]+))/i.exec(
                            attrs
                        );
                    var type = (
                        m ? m[1] || m[2] || m[3] || "" : ""
                    ).toLowerCase();
                    var isJs =
                        !type ||
                        /(java|ecma)script/.test(type) ||
                        type === "module";
                    if (/json|template|html/.test(type) || !isJs) {
                        parts.push(doc.slice(b.start, b.end));
                        continue;
                    }

                    total++;
                    var r = transformOneScript(
                        body,
                        fileLabel,
                        collapse,
                        includeAnon
                    );
                    detF += r.detected;
                    if (r.changed.length) {
                        changedS++;
                        chF += r.changed.length;
                        changedReport.push("‚Ä¢ <script #" + total + ">");
                        r.changed.forEach(function (n) {
                            changedReport.push("   - " + n);
                        });
                    }
                    parts.push(
                        "<" +
                            "script" +
                            (attrs.trim() ? " " + attrs.trim() : "") +
                            ">" +
                            r.code +
                            "</scr" +
                            "ipt>"
                    );
                }
                parts.push(doc.slice(last));

                return {
                    htmlOut: parts.join(""),
                    changedReport: changedReport,
                    stats: {
                        totalScripts: blocks.length,
                        detectedFunctions: detF,
                        changedScripts: changedS,
                        changedFunctions: chF,
                    },
                };
            }

            /* ===== Formatadores (opcionais) ===== */
            function indent(n) {
                return " ".repeat(n * 4);
            }
            function reindentJs(s) {
                s = String(s).replace(/\r\n/g, "\n");
                var out = "",
                    i = 0,
                    n = s.length,
                    level = 0,
                    atStart = true,
                    inStr = null,
                    esc = false,
                    inSL = false,
                    inML = false,
                    lineBegClose = false;
                while (i < n) {
                    var ch = s[i];
                    if (ch === "\n") {
                        out += "\n";
                        atStart = true;
                        inSL = false;
                        lineBegClose = false;
                        i++;
                        continue;
                    }
                    if (atStart) {
                        while (i < n && (s[i] === " " || s[i] === "\t")) i++;
                        ch = s[i];
                        if (
                            !inStr &&
                            !inSL &&
                            !inML &&
                            (ch === "}" || ch === "]")
                        ) {
                            level = Math.max(0, level - 1);
                            lineBegClose = true;
                        }
                        out += indent(level);
                        atStart = false;
                    }
                    if (inSL) {
                        out += ch;
                        i++;
                        continue;
                    }
                    if (inML) {
                        out += ch;
                        if (ch === "*" && s[i + 1] === "/") {
                            out += "/";
                            i += 2;
                            inML = false;
                        } else i++;
                        continue;
                    }
                    if (inStr) {
                        out += ch;
                        if (esc) {
                            esc = false;
                            i++;
                            continue;
                        }
                        if (ch === "\\") {
                            esc = true;
                            i++;
                            continue;
                        }
                        if (ch === inStr) {
                            inStr = null;
                            i++;
                            continue;
                        }
                        i++;
                        continue;
                    }
                    if (ch === "/" && s[i + 1] === "/") {
                        out += "//";
                        i += 2;
                        inSL = true;
                        continue;
                    }
                    if (ch === "/" && s[i + 1] === "*") {
                        out += "/*";
                        i += 2;
                        inML = true;
                        continue;
                    }
                    if (ch === '"' || ch === "'" || ch === "`") {
                        inStr = ch;
                        out += ch;
                        i++;
                        continue;
                    }
                    if (ch === "{") {
                        out += ch;
                        level++;
                        i++;
                        continue;
                    }
                    if (ch === "[") {
                        out += ch;
                        level++;
                        i++;
                        continue;
                    }
                    if (ch === "}" || ch === "]") {
                        if (lineBegClose) {
                            lineBegClose = false;
                            out += ch;
                            i++;
                            continue;
                        }
                        level = Math.max(0, level - 1);
                        out += ch;
                        i++;
                        continue;
                    }
                    out += ch;
                    i++;
                }
                return out;
            }

            // LITE: quando marcado, s√≥ reidenta o JS dentro dos <script>
            function formatWholeDocument(html) {
                var blocks = parseScriptsCI(html);
                var last = 0,
                    parts = [];
                for (var i = 0; i < blocks.length; i++) {
                    var b = blocks[i];
                    parts.push(html.slice(last, b.start));
                    var js = reindentJs(b.body);
                    parts.push(
                        "<script" +
                            (b.attrs.trim() ? " " + b.attrs.trim() : "") +
                            ">" +
                            js +
                            "</scr" +
                            "ipt>"
                    );
                    last = b.end;
                }
                parts.push(html.slice(last));
                return parts.join("");
            }

            /* ===== Pipeline ===== */
            function runPipeline(rawHtml, fileName) {
                var fileLabel = labelFromFileName(fileName);
                var result = transformCshtml(rawHtml, {
                    fileLabel: fileLabel,
                    collapse: $("#collapse").checked,
                });
                var out = result.htmlOut;
                if ($("#formatIndent").checked) {
                    log("[format] reindent JS‚Ä¶");
                    out = formatWholeDocument(out);
                }
                if ($("#collapse").checked) out = normalizeWhitespace(out, 1);
                return {
                    htmlOut: out,
                    changedReport: result.changedReport,
                    stats: result.stats,
                    fileLabel: fileLabel,
                };
            }

            /* ===== UI ===== */
            var outEl = $("#out"),
                changedEl = $("#changed"),
                summaryEl = $("#summary");
            var fileInput = $("#file"),
                pick = $("#pick");

            // permitir reprocessar o mesmo arquivo
            pick.addEventListener("click", function (ev) {
                try {
                    ev.preventDefault();
                    fileInput.value = "";
                    fileInput.click();
                } catch (_) {}
            });
            pick.addEventListener("mousedown", function () {
                try {
                    fileInput.value = "";
                } catch (_) {}
            });

            // handlers padr√≠o (al√©m do onchange inline)
            fileInput.addEventListener("change", function (e) {
                try {
                    if (e.target && e.target.files && e.target.files.length)
                        handleFiles(e.target.files);
                } catch (err) {
                    log("[onFile change] " + ((err && err.stack) || err));
                }
            });
            fileInput.addEventListener("input", function (e) {
                try {
                    if (e.target && e.target.files && e.target.files.length)
                        handleFiles(e.target.files);
                } catch (err) {
                    log("[onFile input] " + ((err && err.stack) || err));
                }
            });

            var drop = $("#drop");
            ["dragenter", "dragover"].forEach(function (ev) {
                drop.addEventListener(ev, function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    drop.classList.add("drag");
                });
            });
            ["dragleave", "drop"].forEach(function (ev) {
                drop.addEventListener(ev, function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    drop.classList.remove("drag");
                });
            });
            drop.addEventListener("drop", function (e) {
                handleFiles(e.dataTransfer.files);
            });

            $("#copyOut").addEventListener("click", function () {
                if (!outEl.value) return;
                navigator.clipboard.writeText(outEl.value).then(function () {
                    toast("HTML final copiado ‚úîÔ∏è");
                });
            });
            $("#copyList").addEventListener("click", function () {
                var t = changedEl.textContent || "";
                navigator.clipboard.writeText(t).then(function () {
                    toast("Lista copiada ‚úîÔ∏è");
                });
            });
            $("#downloadOut").addEventListener("click", function () {
                if (!outEl.value) return;
                var base = (window.__lastOutName || "arquivo").replace(
                    /\.(cshtml|html|htm|txt)$/i,
                    ""
                );
                var ext = $("#ext").value || ".cshtml";
                downloadBlob(outEl.value, base + ".padronizado" + ext);
            });

            function handleFiles(files) {
                var f = files && files[0];
                if (!f) return;
                log(
                    "[file] " +
                        (f.name || "?") +
                        " (" +
                        (f.size || 0) +
                        " bytes)"
                );
                var reader = new FileReader();
                reader.onload = function () {
                    try {
                        var html = String(reader.result || "");
                        log("[onload] bytes: " + html.length);
                        window.__lastOutName = f.name || "arquivo.cshtml";
                        $("#labelPreview").value = labelFromFileName(f.name);
                        var res = runPipeline(html, f.name);
                        outEl.value = res.htmlOut;
                        changedEl.textContent = res.changedReport.length
                            ? res.changedReport.join("\n")
                            : "(nenhuma fun√ß√£o alterada)";
                        summaryEl.textContent =
                            "scripts: " +
                            res.stats.totalScripts +
                            " | detectadas: " +
                            res.stats.detectedFunctions +
                            " | alteradas: " +
                            res.stats.changedFunctions +
                            " | scripts alterados: " +
                            res.stats.changedScripts;
                        toast("Processado: " + (f.name || "arquivo") + " ‚úîÔ∏è");
                        setTimeout(function () {
                            try {
                                fileInput.value = "";
                            } catch (_) {}
                        }, 0);
                    } catch (e) {
                        log("[onload catch] " + ((e && e.stack) || e));
                        toast("Falha ao processar ‚ùó");
                    }
                };
                reader.onerror = function (e) {
                    log("[FileReader.onerror] " + ((e && e.message) || e));
                    toast("Falha ao ler arquivo ‚ùó");
                };
                reader.readAsText(f);
            }

            function __onFileChange(el) {
                try {
                    var fl = el && el.files;
                    if (fl && fl.length) handleFiles(fl);
                } catch (err) {
                    log("[__onFileChange] " + ((err && err.stack) || err));
                }
            }
            window.__onFileChange = __onFileChange;

            log("[init] LITE carregado (callbacks an√¥nimos sempre ON)");
        </script>
    </body>
</html>
