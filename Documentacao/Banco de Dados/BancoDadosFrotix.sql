--
-- Script was generated by Devart dbForge Studio for SQL Server, Version 2025.2.91.0
-- Product home page: https://www.devart.com/dbforge/sql/studio
-- Script date 09/01/2026 10:41:21
-- Server version: 16.00.1160
--

USE Frotix
GO

IF DB_NAME() <> N'Frotix' SET NOEXEC ON
GO

--
-- Create table [dbo].[WhatsAppWebhookLogs]
--
PRINT (N'Create table [dbo].[WhatsAppWebhookLogs]')
GO
CREATE TABLE dbo.WhatsAppWebhookLogs (
  Id int IDENTITY,
  Evento nvarchar(100) NULL,
  Payload nvarchar(max) NULL,
  DataRecebimento datetime NOT NULL DEFAULT (getdate()),
  Processado bit NULL DEFAULT (0),
  ErroProcessamento nvarchar(max) NULL,
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[WhatsAppInstancias]
--
PRINT (N'Create table [dbo].[WhatsAppInstancias]')
GO
CREATE TABLE dbo.WhatsAppInstancias (
  Id int IDENTITY,
  NomeInstancia nvarchar(100) NOT NULL,
  NumeroConectado nvarchar(50) NULL,
  Status int NOT NULL DEFAULT (0),
  DataConexao datetime NULL,
  DataCriacao datetime NOT NULL DEFAULT (getdate()),
  UltimaVerificacao datetime NULL,
  QRCode nvarchar(max) NULL,
  Ativa bit NOT NULL DEFAULT (1),
  Principal bit NOT NULL DEFAULT (0),
  ConfiguracoesJson nvarchar(max) NULL,
  PRIMARY KEY CLUSTERED (Id),
  UNIQUE (NomeInstancia)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[WhatsAppMensagens]
--
PRINT (N'Create table [dbo].[WhatsAppMensagens]')
GO
CREATE TABLE dbo.WhatsAppMensagens (
  Id int IDENTITY,
  NumeroDestino nvarchar(50) NOT NULL,
  Mensagem nvarchar(max) NOT NULL,
  Tipo int NOT NULL DEFAULT (0),
  Status int NOT NULL DEFAULT (0),
  DataCriacao datetime NOT NULL DEFAULT (getdate()),
  DataEnvio datetime NULL,
  DataLeitura datetime NULL,
  InstanciaId int NULL,
  ContatoId int NULL,
  UsuarioId int NULL,
  ErroDetalhes nvarchar(max) NULL,
  TentativasEnvio int NULL DEFAULT (0),
  IdWhatsApp nvarchar(100) NULL,
  RespostaJson nvarchar(max) NULL,
  UrlMidia nvarchar(500) NULL,
  TipoMidia nvarchar(50) NULL,
  NomeArquivo nvarchar(255) NULL,
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_WhatsAppMensagens_DataCriacao] on table [dbo].[WhatsAppMensagens]
--
PRINT (N'Create index [IX_WhatsAppMensagens_DataCriacao] on table [dbo].[WhatsAppMensagens]')
GO
CREATE INDEX IX_WhatsAppMensagens_DataCriacao
  ON dbo.WhatsAppMensagens (DataCriacao)
  ON [PRIMARY]
GO

--
-- Create index [IX_WhatsAppMensagens_Status] on table [dbo].[WhatsAppMensagens]
--
PRINT (N'Create index [IX_WhatsAppMensagens_Status] on table [dbo].[WhatsAppMensagens]')
GO
CREATE INDEX IX_WhatsAppMensagens_Status
  ON dbo.WhatsAppMensagens (Status)
  ON [PRIMARY]
GO

--
-- Create foreign key on table [dbo].[WhatsAppMensagens]
--
PRINT (N'Create foreign key on table [dbo].[WhatsAppMensagens]')
GO
ALTER TABLE dbo.WhatsAppMensagens
  ADD FOREIGN KEY (InstanciaId) REFERENCES dbo.WhatsAppInstancias (Id)
GO

--
-- Create table [dbo].[WhatsAppFilaMensagens]
--
PRINT (N'Create table [dbo].[WhatsAppFilaMensagens]')
GO
CREATE TABLE dbo.WhatsAppFilaMensagens (
  Id int IDENTITY,
  MensagemId int NOT NULL,
  Status int NOT NULL DEFAULT (0),
  Prioridade int NOT NULL DEFAULT (5),
  DataAgendamento datetime NOT NULL,
  DataProcessamento datetime NULL,
  Tentativas int NULL DEFAULT (0),
  ErroUltimaTentativa nvarchar(max) NULL,
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_WhatsAppFilaMensagens_DataAgendamento] on table [dbo].[WhatsAppFilaMensagens]
--
PRINT (N'Create index [IX_WhatsAppFilaMensagens_DataAgendamento] on table [dbo].[WhatsAppFilaMensagens]')
GO
CREATE INDEX IX_WhatsAppFilaMensagens_DataAgendamento
  ON dbo.WhatsAppFilaMensagens (DataAgendamento)
  ON [PRIMARY]
GO

--
-- Create index [IX_WhatsAppFilaMensagens_Status] on table [dbo].[WhatsAppFilaMensagens]
--
PRINT (N'Create index [IX_WhatsAppFilaMensagens_Status] on table [dbo].[WhatsAppFilaMensagens]')
GO
CREATE INDEX IX_WhatsAppFilaMensagens_Status
  ON dbo.WhatsAppFilaMensagens (Status)
  ON [PRIMARY]
GO

--
-- Create foreign key on table [dbo].[WhatsAppFilaMensagens]
--
PRINT (N'Create foreign key on table [dbo].[WhatsAppFilaMensagens]')
GO
ALTER TABLE dbo.WhatsAppFilaMensagens
  ADD FOREIGN KEY (MensagemId) REFERENCES dbo.WhatsAppMensagens (Id)
GO

--
-- Create table [dbo].[WhatsAppContatos]
--
PRINT (N'Create table [dbo].[WhatsAppContatos]')
GO
CREATE TABLE dbo.WhatsAppContatos (
  Id int IDENTITY,
  Numero nvarchar(50) NOT NULL,
  Nome nvarchar(100) NULL,
  NomeWhatsApp nvarchar(100) NULL,
  FotoUrl nvarchar(500) NULL,
  Verificado bit NULL DEFAULT (0),
  Bloqueado bit NULL DEFAULT (0),
  UltimaMensagem datetime NULL,
  DataCadastro datetime NOT NULL DEFAULT (getdate()),
  TotalMensagensEnviadas int NULL DEFAULT (0),
  TotalMensagensRecebidas int NULL DEFAULT (0),
  ObservacoesJson nvarchar(max) NULL,
  PRIMARY KEY CLUSTERED (Id),
  UNIQUE (Numero)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[ViagemEstatistica]
--
PRINT (N'Create table [dbo].[ViagemEstatistica]')
GO
CREATE TABLE dbo.ViagemEstatistica (
  Id int IDENTITY,
  DataReferencia datetime2 NOT NULL,
  TotalViagens int NOT NULL DEFAULT (0),
  ViagensFinalizadas int NOT NULL DEFAULT (0),
  ViagensEmAndamento int NOT NULL DEFAULT (0),
  ViagensAgendadas int NOT NULL DEFAULT (0),
  ViagensCanceladas int NOT NULL DEFAULT (0),
  CustoTotal decimal(18, 2) NOT NULL DEFAULT (0),
  CustoMedioPorViagem decimal(18, 2) NOT NULL DEFAULT (0),
  CustoVeiculo decimal(18, 2) NOT NULL DEFAULT (0),
  CustoMotorista decimal(18, 2) NOT NULL DEFAULT (0),
  CustoOperador decimal(18, 2) NOT NULL DEFAULT (0),
  CustoLavador decimal(18, 2) NOT NULL DEFAULT (0),
  CustoCombustivel decimal(18, 2) NOT NULL DEFAULT (0),
  QuilometragemTotal decimal(18, 2) NOT NULL DEFAULT (0),
  QuilometragemMedia decimal(18, 2) NOT NULL DEFAULT (0),
  ViagensPorStatusJson nvarchar(max) NULL,
  ViagensPorMotoristaJson nvarchar(max) NULL,
  ViagensPorVeiculoJson nvarchar(max) NULL,
  ViagensPorFinalidadeJson nvarchar(max) NULL,
  ViagensPorRequisitanteJson nvarchar(max) NULL,
  ViagensPorSetorJson nvarchar(max) NULL,
  CustosPorMotoristaJson nvarchar(max) NULL,
  CustosPorVeiculoJson nvarchar(max) NULL,
  KmPorVeiculoJson nvarchar(max) NULL,
  CustosPorTipoJson nvarchar(max) NULL,
  DataCriacao datetime2 NOT NULL DEFAULT (getdate()),
  DataAtualizacao datetime2 NULL,
  KmTotal int NULL,
  KmMedio decimal(18, 2) NULL,
  MinutosTotal int NULL,
  MinutosMedio int NULL,
  CONSTRAINT PK_ViagemEstatistica PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_ViagemEstatistica_DataAtualizacao] on table [dbo].[ViagemEstatistica]
--
PRINT (N'Create index [IX_ViagemEstatistica_DataAtualizacao] on table [dbo].[ViagemEstatistica]')
GO
CREATE INDEX IX_ViagemEstatistica_DataAtualizacao
  ON dbo.ViagemEstatistica (DataAtualizacao)
  ON [PRIMARY]
GO

--
-- Create index [IX_ViagemEstatistica_DataReferencia] on table [dbo].[ViagemEstatistica]
--
PRINT (N'Create index [IX_ViagemEstatistica_DataReferencia] on table [dbo].[ViagemEstatistica]')
GO
CREATE UNIQUE INDEX IX_ViagemEstatistica_DataReferencia
  ON dbo.ViagemEstatistica (DataReferencia)
  ON [PRIMARY]
GO

--
-- Create index [IX_ViagemEstatistica_DataReferencia_Custos] on table [dbo].[ViagemEstatistica]
--
PRINT (N'Create index [IX_ViagemEstatistica_DataReferencia_Custos] on table [dbo].[ViagemEstatistica]')
GO
CREATE INDEX IX_ViagemEstatistica_DataReferencia_Custos
  ON dbo.ViagemEstatistica (DataReferencia)
  INCLUDE (TotalViagens, QuilometragemTotal, CustoTotal, CustoCombustivel, CustoMotorista)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[Usuarios]
--
PRINT (N'Create table [dbo].[Usuarios]')
GO
CREATE TABLE dbo.Usuarios (
  UsuarioId uniqueidentifier NOT NULL DEFAULT (newid()),
  Ponto varchar(10) NOT NULL,
  PontoUpper varchar(10) NOT NULL,
  Nome varchar(100) NOT NULL,
  Email varchar(100) NOT NULL,
  EmailUpper varchar(100) NULL,
  EmailNaoConfirmado varchar(100) NULL,
  Foto varbinary(max) NULL,
  Status bit NOT NULL,
  SenhaHash varchar(100) NOT NULL,
  SenhaCamaraNetHash varchar(100) NULL,
  PrecisaMudarSenha bit NULL,
  EmailConfirmado bit NULL,
  SecurityStamp varchar(50) NULL,
  AuthenticatorKey varchar(50) NULL,
  RecoveryCodes varchar(200) NULL,
  AccessFailedCount int NULL,
  LockoutEndDate datetime NULL,
  AdministratorRole bit NULL,
  LastLoginDate datetime NULL,
  CreatedDate datetime NULL,
  RowVersion timestamp NULL,
  CONSTRAINT PK_Usuarios_id_usuario PRIMARY KEY CLUSTERED (UsuarioId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[Usuarios]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Usuarios]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Tabela de Usuários', 'SCHEMA', N'dbo', 'TABLE', N'Usuarios'
GO

--
-- Create table [dbo].[Unidade]
--
PRINT (N'Create table [dbo].[Unidade]')
GO
CREATE TABLE dbo.Unidade (
  UnidadeId uniqueidentifier NOT NULL DEFAULT (newid()),
  Sigla varchar(50) NULL,
  Descricao varchar(100) NOT NULL,
  PontoPrimeiroContato varchar(50) NULL,
  PrimeiroContato varchar(100) NULL,
  PrimeiroRamal bigint NULL,
  PontoSegundoContato varchar(50) NULL,
  SegundoContato varchar(100) NULL,
  SegundoRamal bigint NULL,
  PontoTerceiroContato varchar(50) NULL,
  TerceiroContato varchar(100) NULL,
  TerceiroRamal bigint NULL,
  Status bit NULL DEFAULT (1),
  Categoria varchar(100) NULL,
  QtdMotoristas int NULL DEFAULT (0),
  CONSTRAINT PK_Unidades_id_unidade PRIMARY KEY CLUSTERED (UnidadeId)
)
ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[Unidade]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Unidade]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Unidade à qual pertence o veículo', 'SCHEMA', N'dbo', 'TABLE', N'Unidade'
GO

--
-- Create table [dbo].[tr_String]
--
PRINT (N'Create table [dbo].[tr_String]')
GO
CREATE TABLE dbo.tr_String (
  Id varchar(255) NOT NULL,
  Value nvarchar(4000) NOT NULL,
  CONSTRAINT pk_strng_9912B79F PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
GO

SET QUOTED_IDENTIFIER, ANSI_NULLS ON
GO

--
-- Create or alter procedure [dbo].[sp_tr_SetString]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_SetString]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_SetString 
	@Key varchar(255) = 0, 
	@Value nvarchar(4000) = 0
AS
BEGIN
	SET NOCOUNT ON;

	MERGE [dbo].[tr_String] AS T 
	USING (SELECT @Key as Id, @Value as Value) AS S 
		ON (T.Id = S.Id) 
	WHEN NOT MATCHED BY TARGET THEN 
		INSERT(Id, Value) VALUES(S.Id, S.Value) 
	WHEN MATCHED THEN 
		UPDATE SET T.Value = S.Value;
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_GetString]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_GetString]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_GetString 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	SELECT Value 
	FROM [dbo].[tr_String] 
	WHERE Id = @Key
END
GO

--
-- Create table [dbo].[tr_Set]
--
PRINT (N'Create table [dbo].[tr_Set]')
GO
CREATE TABLE dbo.tr_Set (
  Id varchar(255) NOT NULL,
  Member varchar(255) NOT NULL,
  CONSTRAINT pk_st_DE59633C PRIMARY KEY CLUSTERED (Id, Member)
)
ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_tr_GetMembersInSet]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_GetMembersInSet]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_GetMembersInSet 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

SELECT [Member] 
FROM [dbo].[tr_Set] 
WHERE [Id] = @Key
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_GetCountInSet]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_GetCountInSet]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_GetCountInSet 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	SELECT COUNT(1) 
	FROM [dbo].[tr_Set] 
	WHERE [Id] = @Key
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_ExistsInSet]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_ExistsInSet]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_ExistsInSet 
	@Key varchar(255) = 0, 
	@Value varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	IF EXISTS (SELECT 1 FROM [dbo].[tr_Set] WHERE [Id] = @Key AND [Member] = @Value)
		RETURN 1
	ELSE
		RETURN 0
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_DeleteSet]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_DeleteSet]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_DeleteSet 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	DELETE
	FROM [dbo].[tr_Set] 
	WHERE [Id] = @Key
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_DeleteInSet]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_DeleteInSet]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_DeleteInSet 
	@Key varchar(255) = 0, 
	@Value varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	DELETE FROM [dbo].[tr_Set] WHERE [Id] = @Key AND [Member] = @Value
	
	RETURN @@rowcount
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_AddInSet]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_AddInSet]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_AddInSet 
	@Key varchar(255) = 0, 
	@Value varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	MERGE [dbo].[tr_Set] AS T 
	USING (SELECT @Key as [Id], @Value as [Member]) AS S 
		ON (T.Id = S.Id AND T.Member = S.Member) 
	WHEN NOT MATCHED BY TARGET THEN 
		INSERT(Id, Member) VALUES(S.Id, S.Member);
END
GO

--
-- Create table [dbo].[tr_Object]
--
PRINT (N'Create table [dbo].[tr_Object]')
GO
CREATE TABLE dbo.tr_Object (
  Id varchar(255) NOT NULL,
  Value image NOT NULL,
  CONSTRAINT pk_tr_Object PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_tr_SetObject]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_SetObject]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_SetObject 
	@Key varchar(255) = 0, 
	@Value image
AS
BEGIN
	SET NOCOUNT ON;

	MERGE [dbo].[tr_Object] AS T 
	USING (SELECT @Key as Id, @Value as Value) AS S 
		ON (T.Id = S.Id) 
	WHEN NOT MATCHED BY TARGET THEN 
		INSERT(Id, Value) VALUES(S.Id, S.Value) 
	WHEN MATCHED THEN 
		UPDATE SET T.Value = S.Value;
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_GetBytes]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_GetBytes]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_GetBytes 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	SELECT Value 
	FROM [dbo].[tr_Object] 
	WHERE Id = @Key
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_Exists]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_Exists]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_Exists 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	IF EXISTS (SELECT 1 FROM [dbo].[tr_String] WHERE [Id] = @Key)
		RETURN 1
	ELSE 
		IF EXISTS (SELECT 1 FROM [dbo].[tr_Object] WHERE [Id] = @Key)
			RETURN 1
		ELSE
			RETURN 0
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_DeleteLike]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_DeleteLike]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_DeleteLike 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	DELETE 
	FROM [dbo].[tr_String] 
	WHERE [Id] LIKE @Key + '%'
	
	DELETE 
	FROM [dbo].[tr_Object] 
	WHERE [Id] LIKE @Key + '%'

	DELETE 
	FROM [dbo].[tr_Set] 
	WHERE [Id] LIKE @Key + '%'
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_Delete]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_Delete]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_Delete 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	DELETE 
	FROM [dbo].[tr_String] 
	WHERE [Id] = @Key 
	
	DELETE 
	FROM [dbo].[tr_Object] 
	WHERE [Id] = @Key
END
GO

--
-- Create or alter procedure [dbo].[sp_tr_ClearAll]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_ClearAll]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_ClearAll 
AS
BEGIN
	DELETE [dbo].[tr_Set]
	DELETE [dbo].[tr_Object]
	DELETE [dbo].[tr_String]
END
GO

--
-- Create table [dbo].[tr_AppLock]
--
PRINT (N'Create table [dbo].[tr_AppLock]')
GO
CREATE TABLE dbo.tr_AppLock (
  Id nvarchar(255) NOT NULL,
  CONSTRAINT PK_tr_AppLock PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_tr_AcquireLock]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_tr_AcquireLock]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_tr_AcquireLock 
	@Key varchar(255) = 0
AS
BEGIN
	SET NOCOUNT ON;

	INSERT INTO [dbo].[tr_AppLock] 
	VALUES (@Key)
END
GO

--
-- Create table [dbo].[TipoMulta]
--
PRINT (N'Create table [dbo].[TipoMulta]')
GO
CREATE TABLE dbo.TipoMulta (
  TipoMultaId uniqueidentifier NOT NULL DEFAULT (newid()),
  Artigo varchar(100) NULL,
  Descricao varchar(max) NULL,
  Infracao varchar(50) NULL,
  CodigoDenatran varchar(50) NULL,
  Desdobramento varchar(50) NULL,
  CONSTRAINT PK_table1_TipoMultaId PRIMARY KEY CLUSTERED (TipoMultaId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[sysdiagrams]
--
PRINT (N'Create table [dbo].[sysdiagrams]')
GO
CREATE TABLE dbo.sysdiagrams (
  name sysname NOT NULL,
  principal_id int NOT NULL,
  diagram_id int IDENTITY,
  version int NULL,
  definition varbinary(max) NULL,
  PRIMARY KEY CLUSTERED (diagram_id),
  CONSTRAINT UK_principal_name UNIQUE (principal_id, name)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[SetorSolicitante]
--
PRINT (N'Create table [dbo].[SetorSolicitante]')
GO
CREATE TABLE dbo.SetorSolicitante (
  SetorSolicitanteId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome varchar(200) NOT NULL,
  Sigla varchar(50) NULL,
  Ramal int NULL,
  SetorPaiId uniqueidentifier NULL,
  Status bit NULL DEFAULT (1),
  DataAlteracao datetime NULL DEFAULT (getdate()),
  UsuarioIdAlteracao nvarchar(100) NULL,
  CONSTRAINT PK_Setores_id_setor PRIMARY KEY CLUSTERED (SetorSolicitanteId)
)
ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[SetorSolicitante]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[SetorSolicitante]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', 'Setores da Casa', 'SCHEMA', N'dbo', 'TABLE', N'SetorSolicitante'
GO

--
-- Create or alter view [dbo].[ViewSetores]
--
GO
PRINT (N'Create or alter view [dbo].[ViewSetores]')
GO
CREATE OR ALTER VIEW dbo.ViewSetores 
AS SELECT
  SetorSolicitante.SetorSolicitanteId
  ,CASE
    WHEN SetorSolicitante.Sigla IS NULL THEN (SetorSolicitante.Nome) 
    ELSE SetorSolicitante.Nome + ' - (' + SetorSolicitante.Sigla + ')' 
    END AS Nome
 ,SetorSolicitante.SetorPaiId
 ,SetorSolicitante.Status
FROM dbo.SetorSolicitante
WHERE SetorSolicitante.Status = 1
GO

--
-- Create table [dbo].[Requisitante]
--
PRINT (N'Create table [dbo].[Requisitante]')
GO
CREATE TABLE dbo.Requisitante (
  RequisitanteId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome varchar(100) NOT NULL,
  Ponto varchar(50) NOT NULL,
  Ramal int NULL,
  Email varchar(100) NULL,
  SetorSolicitanteId uniqueidentifier NULL,
  Status bit NULL DEFAULT (1),
  UsuarioIdAlteracao nvarchar(50) NOT NULL,
  DataAlteracao datetime NULL,
  CONSTRAINT PK_Requisitantes_id_requisitante PRIMARY KEY CLUSTERED (RequisitanteId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_RequisitanteSetor] on table [dbo].[Requisitante]
--
PRINT (N'Create foreign key [FK_RequisitanteSetor] on table [dbo].[Requisitante]')
GO
ALTER TABLE dbo.Requisitante
  ADD CONSTRAINT FK_RequisitanteSetor FOREIGN KEY (SetorSolicitanteId) REFERENCES dbo.SetorSolicitante (SetorSolicitanteId)
GO

--
-- Add extended property [MS_Description] on table [dbo].[Requisitante]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Requisitante]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Requisitantes dos Serviços de Transporte', 'SCHEMA', N'dbo', 'TABLE', N'Requisitante'
GO

--
-- Create or alter procedure [dbo].[sp_Requisitante_TratarNulos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_Requisitante_TratarNulos]')
GO
-- =============================================
-- SP: Tratamento Anti-Nulos para Requisitante
-- =============================================
CREATE OR ALTER PROCEDURE dbo.sp_Requisitante_TratarNulos
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE dbo.Requisitante
    SET 
        Nome = ISNULL(Nome, ''),
        Ponto = ISNULL(Ponto, ''),
        Ramal = ISNULL(Ramal, 0),
        Email = ISNULL(Email, ''),
        Status = ISNULL(Status, 1),
        UsuarioIdAlteracao = ISNULL(UsuarioIdAlteracao, ''),
        DataAlteracao = ISNULL(DataAlteracao, GETDATE())
    WHERE 
        Nome IS NULL
        OR Ponto IS NULL
        OR Ramal IS NULL
        OR Email IS NULL
        OR Status IS NULL
        OR UsuarioIdAlteracao IS NULL
        OR DataAlteracao IS NULL;
END
GO

--
-- Create or alter trigger [trg_Requisitante_AntiNulos] on table [dbo].[Requisitante]
--
GO
PRINT (N'Create or alter trigger [trg_Requisitante_AntiNulos] on table [dbo].[Requisitante]')
GO
-- =============================================
-- Trigger: Executa SP após INSERT/UPDATE
-- =============================================
CREATE OR ALTER TRIGGER dbo.trg_Requisitante_AntiNulos
ON dbo.Requisitante
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    EXEC dbo.sp_Requisitante_TratarNulos;
END
GO

--
-- Create or alter view [dbo].[ViewRequisitantes]
--
GO
PRINT (N'Create or alter view [dbo].[ViewRequisitantes]')
GO
CREATE OR ALTER VIEW dbo.ViewRequisitantes 
AS SELECT
  Requisitante.RequisitanteId
 ,CASE WHEN Requisitante.Ponto IS NULL AND SetorSolicitante.Sigla IS NULL THEN Requisitante.Nome + '  - (' + SetorSolicitante.Nome + ')' 
       WHEN Requisitante.Ponto IS NOT NULL AND SetorSolicitante.Sigla IS NULL THEN Requisitante.Nome  + ' (' + Requisitante.Ponto + ')' + ' -  (' + SetorSolicitante.Nome + ')' 
       WHEN Requisitante.Ponto IS NOT NULL AND SetorSolicitante.Sigla IS NOT NULL THEN Requisitante.Nome  + ' (' + Requisitante.Ponto + ')' + ' -  (' + SetorSolicitante.Sigla + ')' 
  END AS Requisitante
 ,Requisitante.Status
 ,SetorSolicitante.Nome
 ,SetorSolicitante.Sigla
FROM dbo.Requisitante
INNER JOIN dbo.SetorSolicitante
  ON Requisitante.SetorSolicitanteId = SetorSolicitante.SetorSolicitanteId
WHERE Requisitante.Status = 1
GO

--
-- Create table [dbo].[Evento]
--
PRINT (N'Create table [dbo].[Evento]')
GO
CREATE TABLE dbo.Evento (
  EventoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome varchar(200) NULL,
  Descricao varchar(max) NULL,
  QtdParticipantes int NOT NULL,
  DataInicial datetime NULL,
  DataFinal datetime NULL,
  SetorSolicitanteId uniqueidentifier NOT NULL,
  RequisitanteId uniqueidentifier NOT NULL,
  Status varchar(1) NULL,
  CONSTRAINT PK_Evento_EventoId PRIMARY KEY CLUSTERED (EventoId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_Evento_DataInicial] on table [dbo].[Evento]
--
PRINT (N'Create index [IX_Evento_DataInicial] on table [dbo].[Evento]')
GO
CREATE INDEX IX_Evento_DataInicial
  ON dbo.Evento (DataInicial)
  INCLUDE (EventoId, Nome, DataFinal, SetorSolicitanteId, QtdParticipantes)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Evento_Nome] on table [dbo].[Evento]
--
PRINT (N'Create index [IX_Evento_Nome] on table [dbo].[Evento]')
GO
CREATE INDEX IX_Evento_Nome
  ON dbo.Evento (Nome)
  INCLUDE (EventoId, DataInicial, DataFinal)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Evento_Nome_Completo] on table [dbo].[Evento]
--
PRINT (N'Create index [IX_Evento_Nome_Completo] on table [dbo].[Evento]')
GO
CREATE INDEX IX_Evento_Nome_Completo
  ON dbo.Evento (Nome)
  INCLUDE (EventoId, DataInicial, DataFinal, QtdParticipantes, Status, SetorSolicitanteId, RequisitanteId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Evento_SetorSolicitanteId_DataInicial] on table [dbo].[Evento]
--
PRINT (N'Create index [IX_Evento_SetorSolicitanteId_DataInicial] on table [dbo].[Evento]')
GO
CREATE INDEX IX_Evento_SetorSolicitanteId_DataInicial
  ON dbo.Evento (SetorSolicitanteId, DataInicial)
  INCLUDE (EventoId, Nome, DataFinal, QtdParticipantes, RequisitanteId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Evento_SetorSolicitanteId] on table [dbo].[Evento]
--
PRINT (N'Create foreign key [FK_Evento_SetorSolicitanteId] on table [dbo].[Evento]')
GO
ALTER TABLE dbo.Evento
  ADD CONSTRAINT FK_Evento_SetorSolicitanteId FOREIGN KEY (SetorSolicitanteId) REFERENCES dbo.SetorSolicitante (SetorSolicitanteId)
GO

--
-- Create foreign key [FK_Evento_UsuarioSolicitanteId] on table [dbo].[Evento]
--
PRINT (N'Create foreign key [FK_Evento_UsuarioSolicitanteId] on table [dbo].[Evento]')
GO
ALTER TABLE dbo.Evento
  ADD CONSTRAINT FK_Evento_UsuarioSolicitanteId FOREIGN KEY (RequisitanteId) REFERENCES dbo.Requisitante (RequisitanteId)
GO

--
-- Create table [dbo].[RegistroCupomAbastecimento]
--
PRINT (N'Create table [dbo].[RegistroCupomAbastecimento]')
GO
CREATE TABLE dbo.RegistroCupomAbastecimento (
  RegistroCupomId uniqueidentifier NOT NULL DEFAULT (newid()),
  DataRegistro date NOT NULL,
  Observacoes varchar(max) NULL,
  RegistroPDF varchar(100) NOT NULL,
  CONSTRAINT PK_RegistroCupomAbastecimento_RegistroCupomId PRIMARY KEY CLUSTERED (RegistroCupomId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[Recurso_BACKUP]
--
PRINT (N'Create table [dbo].[Recurso_BACKUP]')
GO
CREATE TABLE dbo.Recurso_BACKUP (
  RecursoId uniqueidentifier NOT NULL,
  Nome nvarchar(200) NOT NULL,
  Descricao varchar(250) NULL,
  NomeMenu nvarchar(200) NOT NULL,
  Ordem float NOT NULL,
  ParentId uniqueidentifier NULL,
  Icon nvarchar(200) NOT NULL,
  Href nvarchar(500) NOT NULL,
  Ativo bit NOT NULL,
  Nivel int NOT NULL,
  HasChild bit NOT NULL
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[Recurso]
--
PRINT (N'Create table [dbo].[Recurso]')
GO
CREATE TABLE dbo.Recurso (
  RecursoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome nvarchar(200) NOT NULL,
  Descricao varchar(250) NULL,
  NomeMenu nvarchar(200) NOT NULL,
  Ordem float NOT NULL,
  ParentId uniqueidentifier NULL,
  Icon nvarchar(200) NOT NULL,
  Href nvarchar(500) NOT NULL,
  Ativo bit NOT NULL DEFAULT (1),
  Nivel int NOT NULL DEFAULT (0),
  HasChild bit NOT NULL DEFAULT (0),
  CONSTRAINT PK_Recurso_RecursoId PRIMARY KEY CLUSTERED (RecursoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_Recurso_ParentId] on table [dbo].[Recurso]
--
PRINT (N'Create index [IX_Recurso_ParentId] on table [dbo].[Recurso]')
GO
CREATE INDEX IX_Recurso_ParentId
  ON dbo.Recurso (ParentId)
  ON [PRIMARY]
GO

--
-- Create index [UK_Recurso_NomeMenu] on table [dbo].[Recurso]
--
PRINT (N'Create index [UK_Recurso_NomeMenu] on table [dbo].[Recurso]')
GO
CREATE UNIQUE INDEX UK_Recurso_NomeMenu
  ON dbo.Recurso (NomeMenu)
  ON [PRIMARY]
GO

--
-- Create index [UK_Recurso_Ordem] on table [dbo].[Recurso]
--
PRINT (N'Create index [UK_Recurso_Ordem] on table [dbo].[Recurso]')
GO
CREATE UNIQUE INDEX UK_Recurso_Ordem
  ON dbo.Recurso (Ordem)
  ON [PRIMARY]
GO

--
-- Create index [UK_Recurso_Parent_Nome] on table [dbo].[Recurso]
--
PRINT (N'Create index [UK_Recurso_Parent_Nome] on table [dbo].[Recurso]')
GO
CREATE UNIQUE INDEX UK_Recurso_Parent_Nome
  ON dbo.Recurso (ParentId, Nome)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Recurso_Parent] on table [dbo].[Recurso]
--
PRINT (N'Create foreign key [FK_Recurso_Parent] on table [dbo].[Recurso]')
GO
ALTER TABLE dbo.Recurso
  ADD CONSTRAINT FK_Recurso_Parent FOREIGN KEY (ParentId) REFERENCES dbo.Recurso (RecursoId)
GO

--
-- Create table [dbo].[PlacaBronze]
--
PRINT (N'Create table [dbo].[PlacaBronze]')
GO
CREATE TABLE dbo.PlacaBronze (
  PlacaBronzeId uniqueidentifier NOT NULL DEFAULT (newid()),
  DescricaoPlaca varchar(100) NULL,
  Status bit NULL DEFAULT (1),
  CONSTRAINT PK_PlacaBronze_PlacaId PRIMARY KEY CLUSTERED (PlacaBronzeId)
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[Perfis]
--
PRINT (N'Create table [dbo].[Perfis]')
GO
CREATE TABLE dbo.Perfis (
  id_perfil int IDENTITY,
  descricao varchar(50) NOT NULL,
  CONSTRAINT PK_Perfis_cod_perfil PRIMARY KEY CLUSTERED (id_perfil)
)
ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[Perfis]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Perfis]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', 'Perfil de Acesso', 'SCHEMA', N'dbo', 'TABLE', N'Perfis'
GO

--
-- Create table [dbo].[OrgaoAutuante]
--
PRINT (N'Create table [dbo].[OrgaoAutuante]')
GO
CREATE TABLE dbo.OrgaoAutuante (
  OrgaoAutuanteId uniqueidentifier NOT NULL DEFAULT (newid()),
  Sigla varchar(50) NOT NULL,
  Nome varchar(100) NULL,
  CONSTRAINT PK_Orgaos_emissores_id_orgao PRIMARY KEY CLUSTERED (OrgaoAutuanteId)
)
ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[OrgaoAutuante]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[OrgaoAutuante]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Órgãos emissores das multas', 'SCHEMA', N'dbo', 'TABLE', N'OrgaoAutuante'
GO

--
-- Create table [dbo].[EmpenhoMulta]
--
PRINT (N'Create table [dbo].[EmpenhoMulta]')
GO
CREATE TABLE dbo.EmpenhoMulta (
  EmpenhoMultaId uniqueidentifier NOT NULL DEFAULT (newid()),
  NotaEmpenho varchar(50) NOT NULL,
  AnoVigencia int NULL,
  SaldoInicial float NULL,
  SaldoAtual float NULL,
  OrgaoAutuanteId uniqueidentifier NULL,
  Status bit NULL,
  CONSTRAINT PK_Empenhos_multas PRIMARY KEY CLUSTERED (EmpenhoMultaId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_EmpenhoMultaOrgao] on table [dbo].[EmpenhoMulta]
--
PRINT (N'Create foreign key [FK_EmpenhoMultaOrgao] on table [dbo].[EmpenhoMulta]')
GO
ALTER TABLE dbo.EmpenhoMulta
  ADD CONSTRAINT FK_EmpenhoMultaOrgao FOREIGN KEY (OrgaoAutuanteId) REFERENCES dbo.OrgaoAutuante (OrgaoAutuanteId)
GO

--
-- Add extended property [MS_Description] on table [dbo].[EmpenhoMulta]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[EmpenhoMulta]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Empenhos por órgão das multas', 'SCHEMA', N'dbo', 'TABLE', N'EmpenhoMulta'
GO

--
-- Create table [dbo].[MovimentacaoEmpenhoMulta]
--
PRINT (N'Create table [dbo].[MovimentacaoEmpenhoMulta]')
GO
CREATE TABLE dbo.MovimentacaoEmpenhoMulta (
  MovimentacaoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Descricao varchar(500) NULL,
  TipoMovimentacao char(1) NULL,
  Valor float NULL,
  DataMovimentacao datetime NULL,
  MultaId uniqueidentifier NULL,
  EmpenhoMultaId uniqueidentifier NULL,
  CONSTRAINT PK_MovimentacaoEmpenhoMulta_MovimentacaoId PRIMARY KEY CLUSTERED (MovimentacaoId)
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[MarcaVeiculo]
--
PRINT (N'Create table [dbo].[MarcaVeiculo]')
GO
CREATE TABLE dbo.MarcaVeiculo (
  MarcaId uniqueidentifier NOT NULL DEFAULT (newid()),
  DescricaoMarca varchar(50) NOT NULL,
  Status bit NULL DEFAULT (1),
  CONSTRAINT PK_MarcaVeiculo_MarcaId PRIMARY KEY CLUSTERED (MarcaId)
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[ModeloVeiculo]
--
PRINT (N'Create table [dbo].[ModeloVeiculo]')
GO
CREATE TABLE dbo.ModeloVeiculo (
  ModeloId uniqueidentifier NOT NULL DEFAULT (newid()),
  MarcaId uniqueidentifier NOT NULL,
  DescricaoModelo varchar(100) NULL,
  Status bit NULL DEFAULT (1),
  CONSTRAINT PK_ModeloVeiculo_ModeloId PRIMARY KEY CLUSTERED (ModeloId)
)
ON [PRIMARY]
GO

--
-- Create index [KEY_ModeloVeiculo] on table [dbo].[ModeloVeiculo]
--
PRINT (N'Create index [KEY_ModeloVeiculo] on table [dbo].[ModeloVeiculo]')
GO
CREATE UNIQUE INDEX KEY_ModeloVeiculo
  ON dbo.ModeloVeiculo (MarcaId, ModeloId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Marca_Modelo] on table [dbo].[ModeloVeiculo]
--
PRINT (N'Create foreign key [FK_Marca_Modelo] on table [dbo].[ModeloVeiculo]')
GO
ALTER TABLE dbo.ModeloVeiculo
  ADD CONSTRAINT FK_Marca_Modelo FOREIGN KEY (MarcaId) REFERENCES dbo.MarcaVeiculo (MarcaId)
GO

--
-- Create table [dbo].[Lavador]
--
PRINT (N'Create table [dbo].[Lavador]')
GO
CREATE TABLE dbo.Lavador (
  LavadorId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome varchar(100) NULL CONSTRAINT DF_Lavador_Nome2 DEFAULT (''),
  Ponto varchar(50) NULL CONSTRAINT DF_Lavador_Ponto2 DEFAULT (''),
  DataNascimento date NULL,
  CPF varchar(50) NULL CONSTRAINT DF_Lavador_CPF2 DEFAULT (''),
  Celular01 varchar(50) NULL CONSTRAINT DF_Lavador_Celular012 DEFAULT (''),
  Celular02 varchar(50) NULL CONSTRAINT DF_Lavador_Celular022 DEFAULT (''),
  DataIngresso date NULL,
  Foto varbinary(max) NULL,
  Status bit NULL DEFAULT (1),
  UsuarioIdAlteracao nvarchar(50) NULL,
  DataAlteracao datetime NULL,
  ContratoId uniqueidentifier NULL,
  CONSTRAINT PK_Lavador_OperadorId PRIMARY KEY CLUSTERED (LavadorId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[Lavador]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Lavador]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Operadores de Tráfego', 'SCHEMA', N'dbo', 'TABLE', N'Lavador'
GO

--
-- Create table [dbo].[ItemVeiculoAta]
--
PRINT (N'Create table [dbo].[ItemVeiculoAta]')
GO
CREATE TABLE dbo.ItemVeiculoAta (
  ItemVeiculoAtaId uniqueidentifier NOT NULL DEFAULT (newid()),
  NumItem int NULL,
  Descricao varchar(100) NULL,
  Quantidade int NULL,
  ValorUnitario float NULL,
  RepactuacaoAtaId uniqueidentifier NULL,
  CONSTRAINT PK_ItemVeiculoAta_ItemVeiculoId PRIMARY KEY CLUSTERED (ItemVeiculoAtaId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_ItemVeiculoAta_ItemVeiculoAtaId] on table [dbo].[ItemVeiculoAta]
--
PRINT (N'Create index [IX_ItemVeiculoAta_ItemVeiculoAtaId] on table [dbo].[ItemVeiculoAta]')
GO
CREATE INDEX IX_ItemVeiculoAta_ItemVeiculoAtaId
  ON dbo.ItemVeiculoAta (ItemVeiculoAtaId, RepactuacaoAtaId)
  INCLUDE (ValorUnitario)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[HeatmapAbastecimentoMensal]
--
PRINT (N'Create table [dbo].[HeatmapAbastecimentoMensal]')
GO
CREATE TABLE dbo.HeatmapAbastecimentoMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  VeiculoId uniqueidentifier NULL,
  TipoVeiculo nvarchar(100) NULL,
  DiaSemana int NOT NULL,
  Hora int NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapAbast_AnoMes] on table [dbo].[HeatmapAbastecimentoMensal]
--
PRINT (N'Create index [IX_HeatmapAbast_AnoMes] on table [dbo].[HeatmapAbastecimentoMensal]')
GO
CREATE INDEX IX_HeatmapAbast_AnoMes
  ON dbo.HeatmapAbastecimentoMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapAbast_Geral] on table [dbo].[HeatmapAbastecimentoMensal]
--
PRINT (N'Create index [IX_HeatmapAbast_Geral] on table [dbo].[HeatmapAbastecimentoMensal]')
GO
CREATE UNIQUE INDEX IX_HeatmapAbast_Geral
  ON dbo.HeatmapAbastecimentoMensal (Ano, Mes, DiaSemana, Hora)
  WHERE ([VeiculoId] IS NULL AND [TipoVeiculo] IS NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapAbast_Tipo] on table [dbo].[HeatmapAbastecimentoMensal]
--
PRINT (N'Create index [IX_HeatmapAbast_Tipo] on table [dbo].[HeatmapAbastecimentoMensal]')
GO
CREATE INDEX IX_HeatmapAbast_Tipo
  ON dbo.HeatmapAbastecimentoMensal (Ano, Mes, TipoVeiculo)
  WHERE ([TipoVeiculo] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapAbast_Veiculo] on table [dbo].[HeatmapAbastecimentoMensal]
--
PRINT (N'Create index [IX_HeatmapAbast_Veiculo] on table [dbo].[HeatmapAbastecimentoMensal]')
GO
CREATE INDEX IX_HeatmapAbast_Veiculo
  ON dbo.HeatmapAbastecimentoMensal (Ano, VeiculoId)
  WHERE ([VeiculoId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[Fornecedor]
--
PRINT (N'Create table [dbo].[Fornecedor]')
GO
CREATE TABLE dbo.Fornecedor (
  FornecedorId uniqueidentifier NULL DEFAULT (newid()),
  DescricaoFornecedor varchar(100) NULL,
  CNPJ varchar(50) NULL,
  Endereco varchar(150) NULL,
  Contato01 varchar(100) NULL,
  Telefone01 varchar(50) NULL,
  Contato02 varchar(100) NULL,
  Telefone02 varchar(50) NULL,
  Status bit NULL
)
ON [PRIMARY]
GO

--
-- Create index [KEY_Fornecedor_FornecedorId] on table [dbo].[Fornecedor]
--
PRINT (N'Create index [KEY_Fornecedor_FornecedorId] on table [dbo].[Fornecedor]')
GO
CREATE UNIQUE INDEX KEY_Fornecedor_FornecedorId
  ON dbo.Fornecedor (FornecedorId)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[Contrato]
--
PRINT (N'Create table [dbo].[Contrato]')
GO
CREATE TABLE dbo.Contrato (
  ContratoId uniqueidentifier NOT NULL DEFAULT (newid()),
  NumeroContrato varchar(10) NULL,
  AnoContrato varchar(10) NULL,
  Vigencia int NULL,
  Prorrogacao int NULL,
  AnoProcesso int NULL,
  NumeroProcesso varchar(50) NULL,
  Objeto varchar(max) NULL,
  Valor float NULL,
  TipoContrato varchar(50) NULL,
  DataInicio date NULL,
  DataFim date NULL,
  ContratoOperadores bit NULL DEFAULT (0),
  ContratoMotoristas bit NULL DEFAULT (0),
  ContratoLavadores bit NULL DEFAULT (0),
  FornecedorId uniqueidentifier NULL,
  Status bit NULL DEFAULT (1),
  UsuarioIdAlteracao nvarchar(100) NULL,
  DataAlteracao datetime NULL,
  CustoMensalOperador float NULL,
  CustoMensalMotorista float NULL,
  CustoMensalLavador float NULL,
  QuantidadeOperador int NULL,
  QuantidadeMotorista int NULL,
  QuantidadeLavador int NULL,
  CustoMensalEncarregado float NULL,
  QuantidadeEncarregado int NULL,
  ContratoEncarregados bit NULL,
  DataRepactuacao date NULL,
  CONSTRAINT PK_Contrato_ContratoId PRIMARY KEY CLUSTERED (ContratoId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_Contrato_TipoContrato_Flags] on table [dbo].[Contrato]
--
PRINT (N'Create index [IX_Contrato_TipoContrato_Flags] on table [dbo].[Contrato]')
GO
CREATE INDEX IX_Contrato_TipoContrato_Flags
  ON dbo.Contrato (TipoContrato, DataInicio DESC)
  INCLUDE (ContratoId, ContratoOperadores, ContratoLavadores)
  WHERE ([TipoContrato]='Terceirização')
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Contrato_Fornecedor] on table [dbo].[Contrato]
--
PRINT (N'Create foreign key [FK_Contrato_Fornecedor] on table [dbo].[Contrato]')
GO
ALTER TABLE dbo.Contrato
  ADD CONSTRAINT FK_Contrato_Fornecedor FOREIGN KEY (FornecedorId) REFERENCES dbo.Fornecedor (FornecedorId)
GO

--
-- Add extended property [MS_Description] on column [dbo].[Contrato].[TipoContrato]
--
PRINT (N'Add extended property [MS_Description] on column [dbo].[Contrato].[TipoContrato]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Terceirização, Serviços, Locação', 'SCHEMA', N'dbo', 'TABLE', N'Contrato', 'COLUMN', N'TipoContrato'
GO

--
-- Create or alter view [dbo].[ViewContratoFornecedor_Veiculos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewContratoFornecedor_Veiculos]')
GO
CREATE OR ALTER VIEW dbo.ViewContratoFornecedor_Veiculos 
AS SELECT TOP 100000
  Contrato.ContratoId
 ,Contrato.AnoContrato + '/' + Contrato.NumeroContrato + ' - ' + Fornecedor.DescricaoFornecedor AS ContratoVeiculo
 ,Contrato.TipoContrato
FROM dbo.Fornecedor
INNER JOIN dbo.Contrato
  ON Fornecedor.FornecedorId = Contrato.FornecedorId
ORDER BY Contrato.AnoContrato DESC
GO

--
-- Create or alter view [dbo].[ViewContratoFornecedor]
--
GO
PRINT (N'Create or alter view [dbo].[ViewContratoFornecedor]')
GO
CREATE OR ALTER VIEW dbo.ViewContratoFornecedor 
AS SELECT TOP 100000
  Contrato.ContratoId
 ,Contrato.AnoContrato + '/' + Contrato.NumeroContrato + ' - ' + Fornecedor.DescricaoFornecedor AS Descricao
 ,Contrato.TipoContrato
FROM dbo.Fornecedor
INNER JOIN dbo.Contrato
  ON Fornecedor.FornecedorId = Contrato.FornecedorId
ORDER BY Contrato.AnoContrato DESC
GO

--
-- Create table [dbo].[RepactuacaoContrato]
--
PRINT (N'Create table [dbo].[RepactuacaoContrato]')
GO
CREATE TABLE dbo.RepactuacaoContrato (
  RepactuacaoContratoId uniqueidentifier NOT NULL DEFAULT (newid()),
  DataRepactuacao date NULL,
  Descricao varchar(100) NULL,
  Valor float NULL,
  ContratoId uniqueidentifier NULL,
  Vigencia int NULL,
  Prorrogacao int NULL,
  Percentual float NULL,
  CONSTRAINT PK_RepactuacaoItemVeiculo_RepactuacaoItemVeiculoId PRIMARY KEY CLUSTERED (RepactuacaoContratoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_RepactuacaoContrato_ContratoId_Data] on table [dbo].[RepactuacaoContrato]
--
PRINT (N'Create index [IX_RepactuacaoContrato_ContratoId_Data] on table [dbo].[RepactuacaoContrato]')
GO
CREATE INDEX IX_RepactuacaoContrato_ContratoId_Data
  ON dbo.RepactuacaoContrato (ContratoId, DataRepactuacao DESC)
  INCLUDE (RepactuacaoContratoId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_RepactuacaoContrato_ContratoId] on table [dbo].[RepactuacaoContrato]
--
PRINT (N'Create foreign key [FK_RepactuacaoContrato_ContratoId] on table [dbo].[RepactuacaoContrato]')
GO
ALTER TABLE dbo.RepactuacaoContrato
  ADD CONSTRAINT FK_RepactuacaoContrato_ContratoId FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create table [dbo].[RepactuacaoTerceirizacao]
--
PRINT (N'Create table [dbo].[RepactuacaoTerceirizacao]')
GO
CREATE TABLE dbo.RepactuacaoTerceirizacao (
  RepactuacaoTerceirizacaoId uniqueidentifier NOT NULL,
  DataRepactuacao date NULL,
  ValorEncarregado float NULL,
  QtdEncarregados int NULL,
  ValorOperador float NULL,
  QtdOperadores int NULL,
  ValorMotorista float NULL,
  QtdMotoristas int NULL,
  ValorLavador float NULL,
  QtdLavadores int NULL,
  RepactuacaoContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_RepactuacaoTerceirizacao_RepactuacaoTerceirizacaoId PRIMARY KEY CLUSTERED (RepactuacaoTerceirizacaoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_RepactuacaoTerceirizacao_RepactuacaoContratoId] on table [dbo].[RepactuacaoTerceirizacao]
--
PRINT (N'Create index [IX_RepactuacaoTerceirizacao_RepactuacaoContratoId] on table [dbo].[RepactuacaoTerceirizacao]')
GO
CREATE INDEX IX_RepactuacaoTerceirizacao_RepactuacaoContratoId
  ON dbo.RepactuacaoTerceirizacao (RepactuacaoContratoId)
  INCLUDE (ValorMotorista, QtdOperadores, ValorOperador, QtdLavadores, ValorLavador)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_RepactuacaoTerceirizacao_RepactuacaoContratoId] on table [dbo].[RepactuacaoTerceirizacao]
--
PRINT (N'Create foreign key [FK_RepactuacaoTerceirizacao_RepactuacaoContratoId] on table [dbo].[RepactuacaoTerceirizacao]')
GO
ALTER TABLE dbo.RepactuacaoTerceirizacao
  ADD CONSTRAINT FK_RepactuacaoTerceirizacao_RepactuacaoContratoId FOREIGN KEY (RepactuacaoContratoId) REFERENCES dbo.RepactuacaoContrato (RepactuacaoContratoId)
GO

--
-- Create table [dbo].[ItemVeiculoContrato]
--
PRINT (N'Create table [dbo].[ItemVeiculoContrato]')
GO
CREATE TABLE dbo.ItemVeiculoContrato (
  ItemVeiculoId uniqueidentifier NOT NULL DEFAULT (newid()),
  NumItem int NULL,
  Descricao varchar(100) NULL,
  Quantidade int NULL,
  ValorUnitario float NULL,
  RepactuacaoContratoId uniqueidentifier NULL,
  CONSTRAINT PK_ItemVeiculoContrato_ItemVeiculoId PRIMARY KEY CLUSTERED (ItemVeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_ItemVeiculoContrato_ItemVeiculoId] on table [dbo].[ItemVeiculoContrato]
--
PRINT (N'Create index [IX_ItemVeiculoContrato_ItemVeiculoId] on table [dbo].[ItemVeiculoContrato]')
GO
CREATE INDEX IX_ItemVeiculoContrato_ItemVeiculoId
  ON dbo.ItemVeiculoContrato (ItemVeiculoId, RepactuacaoContratoId)
  INCLUDE (ValorUnitario)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_ItemVeiculoContrato_RepactuacaoContratoId] on table [dbo].[ItemVeiculoContrato]
--
PRINT (N'Create foreign key [FK_ItemVeiculoContrato_RepactuacaoContratoId] on table [dbo].[ItemVeiculoContrato]')
GO
ALTER TABLE dbo.ItemVeiculoContrato
  ADD CONSTRAINT FK_ItemVeiculoContrato_RepactuacaoContratoId FOREIGN KEY (RepactuacaoContratoId) REFERENCES dbo.RepactuacaoContrato (RepactuacaoContratoId)
GO

--
-- Create table [dbo].[Veiculo]
--
PRINT (N'Create table [dbo].[Veiculo]')
GO
CREATE TABLE dbo.Veiculo (
  VeiculoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Placa varchar(10) NOT NULL,
  Quilometragem int NULL CONSTRAINT DF_Veiculo_Quilometragem2 DEFAULT (0),
  Renavam varchar(20) NULL CONSTRAINT DF_Veiculo_Renavam2 DEFAULT (''),
  PlacaVinculada varchar(50) NULL CONSTRAINT DF_Veiculo_PlacaVinculada2 DEFAULT (''),
  AnoFabricacao int NULL CONSTRAINT DF_Veiculo_AnoFabricacao2 DEFAULT (0),
  AnoModelo int NULL CONSTRAINT DF_Veiculo_AnoModelo2 DEFAULT (0),
  Reserva bit NULL DEFAULT (0),
  VeiculoProprio bit NULL DEFAULT (0),
  Status bit NULL DEFAULT (1),
  CRLV varbinary(max) NULL,
  DataAlteracao datetime NOT NULL DEFAULT (getdate()),
  UsuarioIdAlteracao nvarchar(100) NULL,
  UnidadeId uniqueidentifier NULL,
  MarcaId uniqueidentifier NOT NULL,
  ModeloId uniqueidentifier NOT NULL,
  CombustivelId uniqueidentifier NULL,
  ContratoId uniqueidentifier NULL,
  AtaId uniqueidentifier NULL,
  PlacaBronzeId uniqueidentifier NULL,
  ItemVeiculoId uniqueidentifier NULL,
  Patrimonio varchar(10) NULL CONSTRAINT DF_Veiculo_Patrimonio2 DEFAULT (''),
  ItemVeiculoAtaId uniqueidentifier NULL,
  Categoria varchar(50) NULL CONSTRAINT DF_Veiculo_Categoria2 DEFAULT (''),
  DataIngresso date NULL,
  Economildo bit NULL CONSTRAINT DF_Veiculo_Economildo2 DEFAULT (0),
  ValorMensal float NULL DEFAULT (0),
  Consumo float NULL DEFAULT (0),
  CONSTRAINT PK_Veiculos_id_Veiculo PRIMARY KEY CLUSTERED (VeiculoId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IDX_Modelo] on table [dbo].[Veiculo]
--
PRINT (N'Create index [IDX_Modelo] on table [dbo].[Veiculo]')
GO
CREATE INDEX IDX_Modelo
  ON dbo.Veiculo (ModeloId, MarcaId)
  ON [PRIMARY]
GO

--
-- Create index [IDX_Veiculo_Ativos] on table [dbo].[Veiculo]
--
PRINT (N'Create index [IDX_Veiculo_Ativos] on table [dbo].[Veiculo]')
GO
CREATE INDEX IDX_Veiculo_Ativos
  ON dbo.Veiculo (ModeloId, MarcaId)
  INCLUDE (Placa)
  WHERE ([Status]=(1))
  ON [PRIMARY]
GO

--
-- Create index [IX_Veiculo_ContratoId] on table [dbo].[Veiculo]
--
PRINT (N'Create index [IX_Veiculo_ContratoId] on table [dbo].[Veiculo]')
GO
CREATE INDEX IX_Veiculo_ContratoId
  ON dbo.Veiculo (ContratoId)
  INCLUDE (VeiculoId, Placa, Status, MarcaId, ModeloId, ItemVeiculoId)
  WHERE ([ContratoId] IS NOT NULL)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Veiculo_Placa] on table [dbo].[Veiculo]
--
PRINT (N'Create index [IX_Veiculo_Placa] on table [dbo].[Veiculo]')
GO
CREATE INDEX IX_Veiculo_Placa
  ON dbo.Veiculo (Placa)
  INCLUDE (VeiculoId, Status, MarcaId, ModeloId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Veiculo_UnidadeId_Status] on table [dbo].[Veiculo]
--
PRINT (N'Create index [IX_Veiculo_UnidadeId_Status] on table [dbo].[Veiculo]')
GO
CREATE INDEX IX_Veiculo_UnidadeId_Status
  ON dbo.Veiculo (UnidadeId, Status)
  INCLUDE (VeiculoId, Placa, MarcaId, ModeloId, ContratoId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Veiculo_VeiculoId_Dados] on table [dbo].[Veiculo]
--
PRINT (N'Create index [IX_Veiculo_VeiculoId_Dados] on table [dbo].[Veiculo]')
GO
CREATE INDEX IX_Veiculo_VeiculoId_Dados
  ON dbo.Veiculo (VeiculoId)
  INCLUDE (CombustivelId, ContratoId, AtaId, ItemVeiculoId, ItemVeiculoAtaId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Modelo_Veiculo] on table [dbo].[Veiculo]
--
PRINT (N'Create foreign key [FK_Modelo_Veiculo] on table [dbo].[Veiculo]')
GO
ALTER TABLE dbo.Veiculo
  ADD CONSTRAINT FK_Modelo_Veiculo FOREIGN KEY (MarcaId, ModeloId) REFERENCES dbo.ModeloVeiculo (MarcaId, ModeloId)
GO

--
-- Create foreign key [FK_Veiculo_ItemContrato] on table [dbo].[Veiculo]
--
PRINT (N'Create foreign key [FK_Veiculo_ItemContrato] on table [dbo].[Veiculo]')
GO
ALTER TABLE dbo.Veiculo
  ADD CONSTRAINT FK_Veiculo_ItemContrato FOREIGN KEY (ItemVeiculoId) REFERENCES dbo.ItemVeiculoContrato (ItemVeiculoId)
GO

--
-- Create foreign key [FK_Veiculo_PlacaBronze] on table [dbo].[Veiculo]
--
PRINT (N'Create foreign key [FK_Veiculo_PlacaBronze] on table [dbo].[Veiculo]')
GO
ALTER TABLE dbo.Veiculo
  ADD CONSTRAINT FK_Veiculo_PlacaBronze FOREIGN KEY (PlacaBronzeId) REFERENCES dbo.PlacaBronze (PlacaBronzeId)
GO

--
-- Create foreign key [FK_Veiculo_Unidade] on table [dbo].[Veiculo]
--
PRINT (N'Create foreign key [FK_Veiculo_Unidade] on table [dbo].[Veiculo]')
GO
ALTER TABLE dbo.Veiculo
  ADD CONSTRAINT FK_Veiculo_Unidade FOREIGN KEY (UnidadeId) REFERENCES dbo.Unidade (UnidadeId)
GO

--
-- Create foreign key [FK_VeiculoItemAta] on table [dbo].[Veiculo]
--
PRINT (N'Create foreign key [FK_VeiculoItemAta] on table [dbo].[Veiculo]')
GO
ALTER TABLE dbo.Veiculo
  ADD CONSTRAINT FK_VeiculoItemAta FOREIGN KEY (ItemVeiculoAtaId) REFERENCES dbo.ItemVeiculoAta (ItemVeiculoAtaId)
GO

--
-- Add extended property [MS_Description] on table [dbo].[Veiculo]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Veiculo]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Tabela de Veículos', 'SCHEMA', N'dbo', 'TABLE', N'Veiculo'
GO

--
-- Create or alter view [dbo].[ViewVeiculosManutencaoReserva]
--
GO
PRINT (N'Create or alter view [dbo].[ViewVeiculosManutencaoReserva]')
GO
CREATE OR ALTER VIEW dbo.ViewVeiculosManutencaoReserva 
AS SELECT TOP 1000
    v.VeiculoId,
    (v.Placa + ' - ' + ma.DescricaoMarca + '/' + m.DescricaoModelo) AS Descricao
FROM 
    dbo.Veiculo v
INNER JOIN 
    dbo.ModeloVeiculo m ON v.ModeloId = m.ModeloId
INNER JOIN 
    dbo.MarcaVeiculo ma ON v.MarcaId = ma.MarcaId
WHERE 
    v.Status = 1 AND v.Reserva = 1
ORDER BY 
    Descricao
GO

--
-- Create or alter view [dbo].[ViewVeiculosManutencao]
--
GO
PRINT (N'Create or alter view [dbo].[ViewVeiculosManutencao]')
GO
CREATE OR ALTER VIEW dbo.ViewVeiculosManutencao 
AS SELECT TOP 1000
    v.VeiculoId,
    (v.Placa + ' - ' + ma.DescricaoMarca + '/' + m.DescricaoModelo) AS Descricao
FROM 
    dbo.Veiculo v
INNER JOIN 
    dbo.ModeloVeiculo m ON v.ModeloId = m.ModeloId
INNER JOIN 
    dbo.MarcaVeiculo ma ON v.MarcaId = ma.MarcaId
WHERE 
    v.Status = 1 -- BIT: TRUE
ORDER BY 
    Descricao
GO

--
-- Create or alter view [dbo].[ViewVeiculoCompleto]
--
GO
PRINT (N'Create or alter view [dbo].[ViewVeiculoCompleto]')
GO
CREATE OR ALTER VIEW dbo.ViewVeiculoCompleto 
AS SELECT
    v.VeiculoId,
    v.Status,
    ISNULL(v.Placa, '') AS Placa,
    ISNULL(v.Placa, '') + ' - ' +
        ISNULL(m.DescricaoMarca, 'Sem Marca') + '/' +
        ISNULL(md.DescricaoModelo, 'Sem Modelo') AS VeiculoCompleto
FROM
    dbo.Veiculo v
LEFT JOIN
    dbo.MarcaVeiculo m ON v.MarcaId = m.MarcaId
LEFT JOIN
    dbo.ModeloVeiculo md ON v.ModeloId = md.ModeloId
WHERE v.Status = 1
GO

--
-- Create or alter view [dbo].[ViewExisteItemContrato]
--
GO
PRINT (N'Create or alter view [dbo].[ViewExisteItemContrato]')
GO
CREATE OR ALTER VIEW dbo.ViewExisteItemContrato 
AS SELECT
  ItemVeiculoContrato.ItemVeiculoId
 ,ItemVeiculoContrato.NumItem
 ,ItemVeiculoContrato.Descricao
 ,ItemVeiculoContrato.Quantidade
 ,ItemVeiculoContrato.ValorUnitario AS ValUnitario
 ,ItemVeiculoContrato.RepactuacaoContratoId
 ,(SELECT DISTINCT ItemVeiculoId FROM Veiculo WHERE Veiculo.ItemVeiculoId = ItemVeiculoContrato.ItemVeiculoId) AS ExisteVeiculo
FROM dbo.ItemVeiculoContrato
GO

--
-- Create or alter view [dbo].[ViewAbastecimentosPBIProprio]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAbastecimentosPBIProprio]')
GO
CREATE OR ALTER VIEW dbo.ViewAbastecimentosPBIProprio 
AS SELECT
  Veiculo.VeiculoId
 ,MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS Descricao
 ,Veiculo.Categoria
FROM dbo.Veiculo
LEFT OUTER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
LEFT OUTER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
WHERE VeiculoProprio = 1
GROUP BY Veiculo.VeiculoId
        ,Veiculo.Categoria
        ,MarcaVeiculo.DescricaoMarca
        ,ModeloVeiculo.DescricaoModelo
GO

--
-- Create table [dbo].[VeiculoPadraoViagem]
--
PRINT (N'Create table [dbo].[VeiculoPadraoViagem]')
GO
CREATE TABLE dbo.VeiculoPadraoViagem (
  VeiculoPadraoViagemId int IDENTITY,
  VeiculoId uniqueidentifier NOT NULL,
  AvgDuracaoMinutos decimal(18, 2) NULL,
  DesvioPadraoDuracaoMinutos decimal(18, 2) NULL,
  MinDuracaoMinutos int NULL,
  MaxDuracaoNormalMinutos int NULL,
  MedianaDuracaoMinutos int NULL,
  AvgKmPorViagem decimal(18, 2) NULL,
  DesvioPadraoKm decimal(18, 2) NULL,
  MaxKmNormalPorViagem decimal(18, 2) NULL,
  MedianaKm decimal(18, 2) NULL,
  Q1Km decimal(18, 2) NULL,
  Q3Km decimal(18, 2) NULL,
  IQRKm decimal(18, 2) NULL,
  LimiteInferiorKm decimal(18, 2) NULL,
  LimiteSuperiorKm decimal(18, 2) NULL,
  MedianaMinutos decimal(18, 2) NULL,
  AvgKmPorDia decimal(18, 2) NULL,
  MediaKmEntreAbastecimentos decimal(18, 2) NULL,
  MediaDiasEntreAbastecimentos decimal(18, 2) NULL,
  TotalAbastecimentosAnalisados int NULL DEFAULT (0),
  TotalViagensAnalisadas int NULL DEFAULT (0),
  TotalViagensRealizadas int NULL DEFAULT (0),
  Percentil95Duracao int NULL,
  Percentil99Duracao int NULL,
  TipoUso varchar(50) NULL,
  DataCriacao datetime2 NULL DEFAULT (getdate()),
  DataAtualizacao datetime2 NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (VeiculoPadraoViagemId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_VeiculoPadraoViagem_TipoUso] on table [dbo].[VeiculoPadraoViagem]
--
PRINT (N'Create index [IX_VeiculoPadraoViagem_TipoUso] on table [dbo].[VeiculoPadraoViagem]')
GO
CREATE INDEX IX_VeiculoPadraoViagem_TipoUso
  ON dbo.VeiculoPadraoViagem (TipoUso)
  INCLUDE (AvgDuracaoMinutos, MaxDuracaoNormalMinutos, AvgKmPorViagem)
  ON [PRIMARY]
GO

--
-- Create index [IX_VeiculoPadraoViagem_VeiculoId] on table [dbo].[VeiculoPadraoViagem]
--
PRINT (N'Create index [IX_VeiculoPadraoViagem_VeiculoId] on table [dbo].[VeiculoPadraoViagem]')
GO
CREATE UNIQUE INDEX IX_VeiculoPadraoViagem_VeiculoId
  ON dbo.VeiculoPadraoViagem (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_VeiculoPadraoViagem_Veiculo] on table [dbo].[VeiculoPadraoViagem]
--
PRINT (N'Create foreign key [FK_VeiculoPadraoViagem_Veiculo] on table [dbo].[VeiculoPadraoViagem]')
GO
ALTER TABLE dbo.VeiculoPadraoViagem
  ADD CONSTRAINT FK_VeiculoPadraoViagem_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create table [dbo].[VeiculoContrato]
--
PRINT (N'Create table [dbo].[VeiculoContrato]')
GO
CREATE TABLE dbo.VeiculoContrato (
  VeiculoId uniqueidentifier NOT NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_VeiculoContrato PRIMARY KEY CLUSTERED (VeiculoId, ContratoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_VeiculoContrato_Contrato] on table [dbo].[VeiculoContrato]
--
PRINT (N'Create foreign key [FK_VeiculoContrato_Contrato] on table [dbo].[VeiculoContrato]')
GO
ALTER TABLE dbo.VeiculoContrato
  ADD CONSTRAINT FK_VeiculoContrato_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId) ON DELETE CASCADE
GO

--
-- Create foreign key [FK_VeiculoContrato_Veiculo] on table [dbo].[VeiculoContrato]
--
PRINT (N'Create foreign key [FK_VeiculoContrato_Veiculo] on table [dbo].[VeiculoContrato]')
GO
ALTER TABLE dbo.VeiculoContrato
  ADD CONSTRAINT FK_VeiculoContrato_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId) ON DELETE CASCADE
GO

--
-- Create or alter view [dbo].[ViewAbastecimentosPBIContrato]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAbastecimentosPBIContrato]')
GO
CREATE OR ALTER VIEW dbo.ViewAbastecimentosPBIContrato 
AS SELECT
  Veiculo.VeiculoId
 ,Veiculo.Placa
 ,Veiculo.Categoria
 ,ItemVeiculoContrato.Descricao
FROM dbo.VeiculoContrato
INNER JOIN dbo.Veiculo
  ON VeiculoContrato.VeiculoId = Veiculo.VeiculoId
INNER JOIN dbo.ItemVeiculoContrato
  ON Veiculo.ItemVeiculoId = ItemVeiculoContrato.ItemVeiculoId
INNER JOIN dbo.RepactuacaoContrato
  ON ItemVeiculoContrato.RepactuacaoContratoId = RepactuacaoContrato.RepactuacaoContratoId
    AND VeiculoContrato.ContratoId = RepactuacaoContrato.ContratoId
GO

--
-- Create table [dbo].[RepactuacaoVeiculo]
--
PRINT (N'Create table [dbo].[RepactuacaoVeiculo]')
GO
CREATE TABLE dbo.RepactuacaoVeiculo (
  RepactuacaoVeiculoId uniqueidentifier NOT NULL DEFAULT (newid()),
  RepactuacaoContratoId uniqueidentifier NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  Valor float NULL,
  Observacao nvarchar(500) NULL,
  CONSTRAINT PK_RepactuacaoVeiculo PRIMARY KEY CLUSTERED (RepactuacaoVeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_RepactuacaoVeiculo_RepactuacaoContratoId] on table [dbo].[RepactuacaoVeiculo]
--
PRINT (N'Create index [IX_RepactuacaoVeiculo_RepactuacaoContratoId] on table [dbo].[RepactuacaoVeiculo]')
GO
CREATE INDEX IX_RepactuacaoVeiculo_RepactuacaoContratoId
  ON dbo.RepactuacaoVeiculo (RepactuacaoContratoId)
  ON [PRIMARY]
GO

--
-- Create index [IX_RepactuacaoVeiculo_VeiculoId] on table [dbo].[RepactuacaoVeiculo]
--
PRINT (N'Create index [IX_RepactuacaoVeiculo_VeiculoId] on table [dbo].[RepactuacaoVeiculo]')
GO
CREATE INDEX IX_RepactuacaoVeiculo_VeiculoId
  ON dbo.RepactuacaoVeiculo (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_RepactuacaoVeiculo_RepactuacaoContrato] on table [dbo].[RepactuacaoVeiculo]
--
PRINT (N'Create foreign key [FK_RepactuacaoVeiculo_RepactuacaoContrato] on table [dbo].[RepactuacaoVeiculo]')
GO
ALTER TABLE dbo.RepactuacaoVeiculo
  ADD CONSTRAINT FK_RepactuacaoVeiculo_RepactuacaoContrato FOREIGN KEY (RepactuacaoContratoId) REFERENCES dbo.RepactuacaoContrato (RepactuacaoContratoId)
GO

--
-- Create foreign key [FK_RepactuacaoVeiculo_Veiculo] on table [dbo].[RepactuacaoVeiculo]
--
PRINT (N'Create foreign key [FK_RepactuacaoVeiculo_Veiculo] on table [dbo].[RepactuacaoVeiculo]')
GO
ALTER TABLE dbo.RepactuacaoVeiculo
  ADD CONSTRAINT FK_RepactuacaoVeiculo_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create table [dbo].[Operador]
--
PRINT (N'Create table [dbo].[Operador]')
GO
CREATE TABLE dbo.Operador (
  OperadorId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome varchar(100) NULL CONSTRAINT DF_Operador_Nome2 DEFAULT (''),
  Ponto varchar(50) NULL CONSTRAINT DF_Operador_Ponto2 DEFAULT (''),
  DataNascimento date NULL,
  CPF varchar(50) NULL CONSTRAINT DF_Operador_CPF2 DEFAULT (''),
  Celular01 varchar(50) NULL CONSTRAINT DF_Operador_Celular012 DEFAULT (''),
  Celular02 varchar(50) NULL CONSTRAINT DF_Operador_Celular022 DEFAULT (''),
  DataIngresso date NULL,
  Foto varbinary(max) NULL,
  Status bit NULL DEFAULT (1),
  UsuarioIdAlteracao nvarchar(50) NULL,
  DataAlteracao datetime NULL,
  ContratoId uniqueidentifier NULL,
  CONSTRAINT PK_Operadores_OperadorId PRIMARY KEY CLUSTERED (OperadorId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create foreign key [FK_OperadorContrato] on table [dbo].[Operador]
--
PRINT (N'Create foreign key [FK_OperadorContrato] on table [dbo].[Operador]')
GO
ALTER TABLE dbo.Operador
  ADD CONSTRAINT FK_OperadorContrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Add extended property [MS_Description] on table [dbo].[Operador]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Operador]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Operadores de Tráfego', 'SCHEMA', N'dbo', 'TABLE', N'Operador'
GO

--
-- Create table [dbo].[OperadorContrato]
--
PRINT (N'Create table [dbo].[OperadorContrato]')
GO
CREATE TABLE dbo.OperadorContrato (
  OperadorId uniqueidentifier NOT NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_OperadorContrato PRIMARY KEY CLUSTERED (OperadorId, ContratoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_OperadorContrato_Contrato] on table [dbo].[OperadorContrato]
--
PRINT (N'Create foreign key [FK_OperadorContrato_Contrato] on table [dbo].[OperadorContrato]')
GO
ALTER TABLE dbo.OperadorContrato
  ADD CONSTRAINT FK_OperadorContrato_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create foreign key [FK_OperadorContrato_Operador] on table [dbo].[OperadorContrato]
--
PRINT (N'Create foreign key [FK_OperadorContrato_Operador] on table [dbo].[OperadorContrato]')
GO
ALTER TABLE dbo.OperadorContrato
  ADD CONSTRAINT FK_OperadorContrato_Operador FOREIGN KEY (OperadorId) REFERENCES dbo.Operador (OperadorId)
GO

--
-- Create table [dbo].[LavadorContrato]
--
PRINT (N'Create table [dbo].[LavadorContrato]')
GO
CREATE TABLE dbo.LavadorContrato (
  LavadorId uniqueidentifier NOT NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_LavadorContrato PRIMARY KEY CLUSTERED (LavadorId, ContratoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_LavadorContrato_Contrato] on table [dbo].[LavadorContrato]
--
PRINT (N'Create foreign key [FK_LavadorContrato_Contrato] on table [dbo].[LavadorContrato]')
GO
ALTER TABLE dbo.LavadorContrato
  ADD CONSTRAINT FK_LavadorContrato_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create foreign key [FK_LavadorContrato_Lavador] on table [dbo].[LavadorContrato]
--
PRINT (N'Create foreign key [FK_LavadorContrato_Lavador] on table [dbo].[LavadorContrato]')
GO
ALTER TABLE dbo.LavadorContrato
  ADD CONSTRAINT FK_LavadorContrato_Lavador FOREIGN KEY (LavadorId) REFERENCES dbo.Lavador (LavadorId)
GO

--
-- Create table [dbo].[Encarregado]
--
PRINT (N'Create table [dbo].[Encarregado]')
GO
CREATE TABLE dbo.Encarregado (
  EncarregadoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome nvarchar(100) NOT NULL,
  Ponto nvarchar(20) NOT NULL,
  DataNascimento datetime2 NOT NULL,
  CPF nvarchar(20) NOT NULL,
  Celular01 nvarchar(50) NOT NULL,
  Celular02 nvarchar(50) NULL,
  DataIngresso datetime2 NULL,
  Foto varbinary(max) NULL,
  Status bit NOT NULL DEFAULT (1),
  DataAlteracao datetime2 NULL,
  UsuarioIdAlteracao nvarchar(450) NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_Encarregado PRIMARY KEY CLUSTERED (EncarregadoId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_Encarregado_ContratoId] on table [dbo].[Encarregado]
--
PRINT (N'Create index [IX_Encarregado_ContratoId] on table [dbo].[Encarregado]')
GO
CREATE INDEX IX_Encarregado_ContratoId
  ON dbo.Encarregado (ContratoId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Encarregado_CPF] on table [dbo].[Encarregado]
--
PRINT (N'Create index [IX_Encarregado_CPF] on table [dbo].[Encarregado]')
GO
CREATE UNIQUE INDEX IX_Encarregado_CPF
  ON dbo.Encarregado (CPF)
  ON [PRIMARY]
GO

--
-- Create index [IX_Encarregado_Nome] on table [dbo].[Encarregado]
--
PRINT (N'Create index [IX_Encarregado_Nome] on table [dbo].[Encarregado]')
GO
CREATE INDEX IX_Encarregado_Nome
  ON dbo.Encarregado (Nome)
  ON [PRIMARY]
GO

--
-- Create index [IX_Encarregado_Status] on table [dbo].[Encarregado]
--
PRINT (N'Create index [IX_Encarregado_Status] on table [dbo].[Encarregado]')
GO
CREATE INDEX IX_Encarregado_Status
  ON dbo.Encarregado (Status)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Encarregado_Contrato] on table [dbo].[Encarregado]
--
PRINT (N'Create foreign key [FK_Encarregado_Contrato] on table [dbo].[Encarregado]')
GO
ALTER TABLE dbo.Encarregado
  ADD CONSTRAINT FK_Encarregado_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create table [dbo].[EncarregadoContrato]
--
PRINT (N'Create table [dbo].[EncarregadoContrato]')
GO
CREATE TABLE dbo.EncarregadoContrato (
  EncarregadoId uniqueidentifier NOT NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_EncarregadoContrato PRIMARY KEY CLUSTERED (EncarregadoId, ContratoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EncarregadoContrato_ContratoId] on table [dbo].[EncarregadoContrato]
--
PRINT (N'Create index [IX_EncarregadoContrato_ContratoId] on table [dbo].[EncarregadoContrato]')
GO
CREATE INDEX IX_EncarregadoContrato_ContratoId
  ON dbo.EncarregadoContrato (ContratoId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_EncarregadoContrato_Contrato] on table [dbo].[EncarregadoContrato]
--
PRINT (N'Create foreign key [FK_EncarregadoContrato_Contrato] on table [dbo].[EncarregadoContrato]')
GO
ALTER TABLE dbo.EncarregadoContrato
  ADD CONSTRAINT FK_EncarregadoContrato_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId) ON DELETE CASCADE
GO

--
-- Create foreign key [FK_EncarregadoContrato_Encarregado] on table [dbo].[EncarregadoContrato]
--
PRINT (N'Create foreign key [FK_EncarregadoContrato_Encarregado] on table [dbo].[EncarregadoContrato]')
GO
ALTER TABLE dbo.EncarregadoContrato
  ADD CONSTRAINT FK_EncarregadoContrato_Encarregado FOREIGN KEY (EncarregadoId) REFERENCES dbo.Encarregado (EncarregadoId) ON DELETE CASCADE
GO

--
-- Create table [dbo].[AtaRegistroPrecos]
--
PRINT (N'Create table [dbo].[AtaRegistroPrecos]')
GO
CREATE TABLE dbo.AtaRegistroPrecos (
  AtaId uniqueidentifier NOT NULL DEFAULT (newid()),
  NumeroAta varchar(50) NULL,
  AnoAta varchar(50) NULL,
  AnoProcesso int NULL,
  NumeroProcesso varchar(50) NULL,
  Objeto varchar(max) NULL,
  Valor float NULL,
  DataInicio date NULL,
  DataFim date NULL,
  FornecedorId uniqueidentifier NULL,
  Status bit NULL DEFAULT (1),
  UsuarioIdAlteracao nvarchar(100) NULL,
  DataAlteracao datetime NULL,
  CONSTRAINT PK_AtaRegistroPrecos_ContratoId PRIMARY KEY CLUSTERED (AtaId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create foreign key [FK_AtaRegistroPrecos_Fornecedor] on table [dbo].[AtaRegistroPrecos]
--
PRINT (N'Create foreign key [FK_AtaRegistroPrecos_Fornecedor] on table [dbo].[AtaRegistroPrecos]')
GO
ALTER TABLE dbo.AtaRegistroPrecos
  ADD CONSTRAINT FK_AtaRegistroPrecos_Fornecedor FOREIGN KEY (FornecedorId) REFERENCES dbo.Fornecedor (FornecedorId)
GO

--
-- Create or alter view [dbo].[ViewAtaFornecedor]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAtaFornecedor]')
GO
CREATE OR ALTER VIEW dbo.ViewAtaFornecedor 
AS SELECT
  AtaRegistroPrecos.AtaId
  ,(AtaRegistroPrecos.AnoAta+ '/' + AtaRegistroPrecos.NumeroAta + ' - ' + Fornecedor.DescricaoFornecedor) AS AtaVeiculo

FROM dbo.Fornecedor
INNER JOIN dbo.AtaRegistroPrecos
  ON Fornecedor.FornecedorId = AtaRegistroPrecos.FornecedorId
GO

--
-- Create table [dbo].[VeiculoAta]
--
PRINT (N'Create table [dbo].[VeiculoAta]')
GO
CREATE TABLE dbo.VeiculoAta (
  VeiculoId uniqueidentifier NOT NULL,
  AtaId uniqueidentifier NOT NULL,
  CONSTRAINT PK_AtaContrato PRIMARY KEY CLUSTERED (VeiculoId, AtaId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_VeiculoAta_Ata] on table [dbo].[VeiculoAta]
--
PRINT (N'Create foreign key [FK_VeiculoAta_Ata] on table [dbo].[VeiculoAta]')
GO
ALTER TABLE dbo.VeiculoAta
  ADD CONSTRAINT FK_VeiculoAta_Ata FOREIGN KEY (AtaId) REFERENCES dbo.AtaRegistroPrecos (AtaId)
GO

--
-- Create foreign key [FK_VeiculoAta_Veiculo] on table [dbo].[VeiculoAta]
--
PRINT (N'Create foreign key [FK_VeiculoAta_Veiculo] on table [dbo].[VeiculoAta]')
GO
ALTER TABLE dbo.VeiculoAta
  ADD CONSTRAINT FK_VeiculoAta_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create table [dbo].[RepactuacaoAta]
--
PRINT (N'Create table [dbo].[RepactuacaoAta]')
GO
CREATE TABLE dbo.RepactuacaoAta (
  RepactuacaoAtaId uniqueidentifier NOT NULL DEFAULT (newid()),
  DataRepactuacao date NULL,
  Descricao varchar(100) NULL,
  Valor float NULL,
  AtaId uniqueidentifier NULL,
  CONSTRAINT PK_RepactuacaoItemVeiculo_Ata_RepactuacaoItemVeiculoId PRIMARY KEY CLUSTERED (RepactuacaoAtaId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_RepactuacaoAta_DataRepactuacao] on table [dbo].[RepactuacaoAta]
--
PRINT (N'Create index [IX_RepactuacaoAta_DataRepactuacao] on table [dbo].[RepactuacaoAta]')
GO
CREATE INDEX IX_RepactuacaoAta_DataRepactuacao
  ON dbo.RepactuacaoAta (DataRepactuacao DESC)
  INCLUDE (RepactuacaoAtaId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_RepactuacaoAta_AtaId] on table [dbo].[RepactuacaoAta]
--
PRINT (N'Create foreign key [FK_RepactuacaoAta_AtaId] on table [dbo].[RepactuacaoAta]')
GO
ALTER TABLE dbo.RepactuacaoAta
  ADD CONSTRAINT FK_RepactuacaoAta_AtaId FOREIGN KEY (AtaId) REFERENCES dbo.AtaRegistroPrecos (AtaId)
GO

--
-- Create or alter view [dbo].[ViewAbastecimentosPBIAta]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAbastecimentosPBIAta]')
GO
CREATE OR ALTER VIEW dbo.ViewAbastecimentosPBIAta 
AS SELECT
  Veiculo.VeiculoId
 ,Veiculo.Placa
 ,Veiculo.Categoria
 ,ItemVeiculoAta.Descricao
FROM dbo.VeiculoAta
INNER JOIN dbo.Veiculo
  ON VeiculoAta.VeiculoId = Veiculo.VeiculoId
INNER JOIN dbo.ItemVeiculoAta
  ON Veiculo.ItemVeiculoAtaId = ItemVeiculoAta.ItemVeiculoAtaId
INNER JOIN dbo.RepactuacaoAta
  ON VeiculoAta.AtaId = RepactuacaoAta.AtaId
GO

--
-- Create or alter view [dbo].[ViewAbastecimentosItensPBI]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAbastecimentosItensPBI]')
GO
CREATE OR ALTER VIEW dbo.ViewAbastecimentosItensPBI 
AS SELECT
  ViewAbastecimentosPBIAta.VeiculoID,
  ViewAbastecimentosPBIAta.Descricao,
  ViewAbastecimentosPBIAta.Categoria
FROM dbo.ViewAbastecimentosPBIAta

UNION

SELECT
  ViewAbastecimentosPBIContrato.VeiculoID,
  ViewAbastecimentosPBIContrato.Descricao,
  ViewAbastecimentosPBIContrato.Categoria 
FROM dbo.ViewAbastecimentosPBIContrato
  
UNION 

SELECT
  ViewAbastecimentosPBIProprio.VeiculoID,
  ViewAbastecimentosPBIProprio.Descricao,
  ViewAbastecimentosPBIProprio.Categoria 
FROM dbo.ViewAbastecimentosPBIProprio
GO

--
-- Create table [dbo].[Empenho]
--
PRINT (N'Create table [dbo].[Empenho]')
GO
CREATE TABLE dbo.Empenho (
  EmpenhoId uniqueidentifier NOT NULL DEFAULT (newid()),
  NotaEmpenho varchar(12) NOT NULL,
  DataEmissao date NOT NULL,
  AnoVigencia int NOT NULL,
  SaldoInicial float NOT NULL,
  SaldoFinal float NOT NULL,
  ContratoId uniqueidentifier NULL,
  AtaId uniqueidentifier NULL,
  VigenciaInicial date NULL,
  VigenciaFinal date NULL,
  CONSTRAINT PK_Empenho_EmpenhoId PRIMARY KEY CLUSTERED (EmpenhoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_Empenho_AtaId] on table [dbo].[Empenho]
--
PRINT (N'Create index [IX_Empenho_AtaId] on table [dbo].[Empenho]')
GO
CREATE INDEX IX_Empenho_AtaId
  ON dbo.Empenho (AtaId)
  INCLUDE (EmpenhoId, NotaEmpenho, SaldoInicial, DataEmissao, ContratoId)
  WHERE ([AtaId] IS NOT NULL)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Empenho_ContratoId] on table [dbo].[Empenho]
--
PRINT (N'Create index [IX_Empenho_ContratoId] on table [dbo].[Empenho]')
GO
CREATE INDEX IX_Empenho_ContratoId
  ON dbo.Empenho (ContratoId)
  INCLUDE (EmpenhoId, NotaEmpenho, SaldoInicial, DataEmissao, AtaId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Empenho_Ata] on table [dbo].[Empenho]
--
PRINT (N'Create foreign key [FK_Empenho_Ata] on table [dbo].[Empenho]')
GO
ALTER TABLE dbo.Empenho
  ADD CONSTRAINT FK_Empenho_Ata FOREIGN KEY (AtaId) REFERENCES dbo.AtaRegistroPrecos (AtaId)
GO

--
-- Create foreign key [FK_Empenho_Contrato] on table [dbo].[Empenho]
--
PRINT (N'Create foreign key [FK_Empenho_Contrato] on table [dbo].[Empenho]')
GO
ALTER TABLE dbo.Empenho
  ADD CONSTRAINT FK_Empenho_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create table [dbo].[NotaFiscal]
--
PRINT (N'Create table [dbo].[NotaFiscal]')
GO
CREATE TABLE dbo.NotaFiscal (
  NotaFiscalId uniqueidentifier NOT NULL DEFAULT (newid()),
  NumeroNF int NULL,
  DataEmissao date NULL,
  ValorNF float NULL,
  TipoNF varchar(20) NULL,
  Objeto varchar(100) NULL,
  ValorGlosa float NULL,
  MotivoGlosa varchar(150) NULL,
  EmpenhoId uniqueidentifier NULL,
  ContratoId uniqueidentifier NULL,
  VeiculoId uniqueidentifier NULL,
  AnoReferencia int NULL,
  MesReferencia int NULL,
  AtaId uniqueidentifier NULL,
  CONSTRAINT PK_NotaFiscal_NotaFiscaId PRIMARY KEY CLUSTERED (NotaFiscalId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_NotaFiscal_Ata] on table [dbo].[NotaFiscal]
--
PRINT (N'Create foreign key [FK_NotaFiscal_Ata] on table [dbo].[NotaFiscal]')
GO
ALTER TABLE dbo.NotaFiscal
  ADD CONSTRAINT FK_NotaFiscal_Ata FOREIGN KEY (AtaId) REFERENCES dbo.AtaRegistroPrecos (AtaId)
GO

--
-- Create foreign key [FK_NotaFiscal_do_Contrato] on table [dbo].[NotaFiscal]
--
PRINT (N'Create foreign key [FK_NotaFiscal_do_Contrato] on table [dbo].[NotaFiscal]')
GO
ALTER TABLE dbo.NotaFiscal
  ADD CONSTRAINT FK_NotaFiscal_do_Contrato FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create foreign key [FK_NotaFiscal_do_Empenho] on table [dbo].[NotaFiscal]
--
PRINT (N'Create foreign key [FK_NotaFiscal_do_Empenho] on table [dbo].[NotaFiscal]')
GO
ALTER TABLE dbo.NotaFiscal
  ADD CONSTRAINT FK_NotaFiscal_do_Empenho FOREIGN KEY (EmpenhoId) REFERENCES dbo.Empenho (EmpenhoId)
GO

--
-- Create table [dbo].[CustoMensalItensContrato]
--
PRINT (N'Create table [dbo].[CustoMensalItensContrato]')
GO
CREATE TABLE dbo.CustoMensalItensContrato (
  NotaFiscalId uniqueidentifier NOT NULL,
  Ano int NOT NULL,
  Mes int NOT NULL,
  CustoMensalOperador float NULL,
  CustoMensalMotorista float NULL,
  CustoMensalLavador float NULL,
  CONSTRAINT PK_ValorMensalItensContrato PRIMARY KEY CLUSTERED (NotaFiscalId, Ano, Mes)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_ValorMensalItensContrato_NotaFiscal] on table [dbo].[CustoMensalItensContrato]
--
PRINT (N'Create foreign key [FK_ValorMensalItensContrato_NotaFiscal] on table [dbo].[CustoMensalItensContrato]')
GO
ALTER TABLE dbo.CustoMensalItensContrato
  ADD CONSTRAINT FK_ValorMensalItensContrato_NotaFiscal FOREIGN KEY (NotaFiscalId) REFERENCES dbo.NotaFiscal (NotaFiscalId)
GO

--
-- Create table [dbo].[MovimentacaoEmpenho]
--
PRINT (N'Create table [dbo].[MovimentacaoEmpenho]')
GO
CREATE TABLE dbo.MovimentacaoEmpenho (
  MovimentacaoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Descricao varchar(100) NULL,
  TipoMovimentacao char(1) NULL,
  Valor float NULL,
  DataMovimentacao date NULL,
  EmpenhoId uniqueidentifier NULL,
  CONSTRAINT PK_table1_MovimentacaoId PRIMARY KEY CLUSTERED (MovimentacaoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_Movimentacao_do_Empenho] on table [dbo].[MovimentacaoEmpenho]
--
PRINT (N'Create foreign key [FK_Movimentacao_do_Empenho] on table [dbo].[MovimentacaoEmpenho]')
GO
ALTER TABLE dbo.MovimentacaoEmpenho
  ADD CONSTRAINT FK_Movimentacao_do_Empenho FOREIGN KEY (EmpenhoId) REFERENCES dbo.Empenho (EmpenhoId)
GO

--
-- Create or alter view [dbo].[ViewEmpenhos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewEmpenhos]')
GO
CREATE OR ALTER VIEW dbo.ViewEmpenhos 
AS -- =============================================
-- ViewEmpenhos - Versão sem NULLs
-- Todos os campos retornam valores padrão em vez de NULL
-- =============================================

SELECT
    -- GUID sempre tem valor (é PK, nunca é NULL)
    Empenho.EmpenhoId,
    
    -- Strings: ISNULL retorna string vazia
    ISNULL(Empenho.NotaEmpenho, '') AS NotaEmpenho,
    
    -- Datas: ISNULL retorna data padrão (ou pode manter NULL se preferir)
    Empenho.DataEmissao,
    Empenho.VigenciaInicial,
    Empenho.VigenciaFinal,
    
    -- Inteiros: ISNULL retorna 0
    ISNULL(Empenho.AnoVigencia, 0) AS AnoVigencia,
    
    -- Floats: ISNULL retorna 0
    ISNULL(Empenho.SaldoInicial, 0) AS SaldoInicial,
    ISNULL(Empenho.SaldoFinal, 0) AS SaldoFinal,
    
    -- GUIDs que podem ser NULL: ISNULL retorna GUID vazio
    ISNULL(Empenho.ContratoId, '00000000-0000-0000-0000-000000000000') AS ContratoId,
    ISNULL(Empenho.AtaId, '00000000-0000-0000-0000-000000000000') AS AtaId,
    
    -- Agregações: ISNULL para garantir 0 quando não há registros relacionados
    ISNULL(COUNT(DISTINCT MovimentacaoEmpenho.MovimentacaoId), 0) AS Movimentacoes,
    ISNULL(SUM(MovimentacaoEmpenho.Valor), 0) AS SaldoMovimentacao,
    ISNULL(SUM(NotaFiscal.ValorNF - ISNULL(NotaFiscal.ValorGlosa, 0)), 0) AS SaldoNotas

FROM dbo.Empenho

LEFT OUTER JOIN dbo.MovimentacaoEmpenho
    ON Empenho.EmpenhoId = MovimentacaoEmpenho.EmpenhoId

LEFT OUTER JOIN dbo.NotaFiscal
    ON Empenho.EmpenhoId = NotaFiscal.EmpenhoId

GROUP BY 
    Empenho.EmpenhoId, 
    Empenho.NotaEmpenho, 
    Empenho.DataEmissao, 
    Empenho.AnoVigencia, 
    Empenho.VigenciaInicial, 
    Empenho.VigenciaFinal, 
    Empenho.SaldoInicial, 
    Empenho.SaldoFinal, 
    Empenho.ContratoId, 
    Empenho.AtaId
GO

--
-- Create table [dbo].[EstatisticaVeiculoUnidade]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoUnidade]')
GO
CREATE TABLE dbo.EstatisticaVeiculoUnidade (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  UnidadeId uniqueidentifier NULL,
  Unidade nvarchar(200) NOT NULL,
  TotalVeiculos int NOT NULL DEFAULT (0),
  VeiculosAtivos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicUnidade UNIQUE (Unidade)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicUnidade] on table [dbo].[EstatisticaVeiculoUnidade]
--
PRINT (N'Create index [IX_EstatVeicUnidade] on table [dbo].[EstatisticaVeiculoUnidade]')
GO
CREATE INDEX IX_EstatVeicUnidade
  ON dbo.EstatisticaVeiculoUnidade (Unidade)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoUnidade]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoUnidade]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoUnidade
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DELETE FROM EstatisticaVeiculoUnidade;

        INSERT INTO EstatisticaVeiculoUnidade (
            UnidadeId, Unidade, TotalVeiculos, VeiculosAtivos, DataAtualizacao
        )
        SELECT
            MIN(v.UnidadeId), -- Pega o primeiro UnidadeId encontrado para cada sigla
            ISNULL(u.Sigla, 'Sem Unidade'),
            COUNT(*),
            SUM(CASE WHEN v.Status = 1 THEN 1 ELSE 0 END),
            GETDATE()
        FROM Veiculo v
        LEFT JOIN Unidade u ON v.UnidadeId = u.UnidadeId
        GROUP BY u.Sigla; -- Agrupa apenas pela sigla da unidade

        COMMIT TRANSACTION;
        PRINT 'Estatísticas por unidade recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaVeiculoStatus]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoStatus]')
GO
CREATE TABLE dbo.EstatisticaVeiculoStatus (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Status nvarchar(50) NOT NULL,
  TotalVeiculos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicStatus UNIQUE (Status)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicStatus] on table [dbo].[EstatisticaVeiculoStatus]
--
PRINT (N'Create index [IX_EstatVeicStatus] on table [dbo].[EstatisticaVeiculoStatus]')
GO
CREATE INDEX IX_EstatVeicStatus
  ON dbo.EstatisticaVeiculoStatus (Status)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoStatus]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoStatus]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoStatus
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DELETE FROM EstatisticaVeiculoStatus;

        INSERT INTO EstatisticaVeiculoStatus (Status, TotalVeiculos, DataAtualizacao)
        SELECT
            CASE WHEN Status = 1 THEN 'Ativo' ELSE 'Inativo' END,
            COUNT(*),
            GETDATE()
        FROM Veiculo
        GROUP BY Status;

        COMMIT TRANSACTION;
        PRINT 'Estatísticas por status recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaVeiculoRankingLitros]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoRankingLitros]')
GO
CREATE TABLE dbo.EstatisticaVeiculoRankingLitros (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  Placa nvarchar(20) NULL,
  Modelo nvarchar(100) NULL,
  LitrosAbastecidos decimal(18, 2) NOT NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NOT NULL DEFAULT (0),
  TotalAbastecimentos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicRankLitros UNIQUE (Ano, VeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicRankLitros_Ano] on table [dbo].[EstatisticaVeiculoRankingLitros]
--
PRINT (N'Create index [IX_EstatVeicRankLitros_Ano] on table [dbo].[EstatisticaVeiculoRankingLitros]')
GO
CREATE INDEX IX_EstatVeicRankLitros_Ano
  ON dbo.EstatisticaVeiculoRankingLitros (Ano)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicRankLitros_Litros] on table [dbo].[EstatisticaVeiculoRankingLitros]
--
PRINT (N'Create index [IX_EstatVeicRankLitros_Litros] on table [dbo].[EstatisticaVeiculoRankingLitros]')
GO
CREATE INDEX IX_EstatVeicRankLitros_Litros
  ON dbo.EstatisticaVeiculoRankingLitros (Ano, LitrosAbastecidos DESC)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaVeiculoRankingKm]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoRankingKm]')
GO
CREATE TABLE dbo.EstatisticaVeiculoRankingKm (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  Placa nvarchar(20) NULL,
  Modelo nvarchar(100) NULL,
  KmRodado decimal(18, 2) NOT NULL DEFAULT (0),
  TotalViagens int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicRankKm UNIQUE (Ano, VeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicRankKm_Ano] on table [dbo].[EstatisticaVeiculoRankingKm]
--
PRINT (N'Create index [IX_EstatVeicRankKm_Ano] on table [dbo].[EstatisticaVeiculoRankingKm]')
GO
CREATE INDEX IX_EstatVeicRankKm_Ano
  ON dbo.EstatisticaVeiculoRankingKm (Ano)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicRankKm_Km] on table [dbo].[EstatisticaVeiculoRankingKm]
--
PRINT (N'Create index [IX_EstatVeicRankKm_Km] on table [dbo].[EstatisticaVeiculoRankingKm]')
GO
CREATE INDEX IX_EstatVeicRankKm_Km
  ON dbo.EstatisticaVeiculoRankingKm (Ano, KmRodado DESC)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaVeiculoRankingConsumo]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoRankingConsumo]')
GO
CREATE TABLE dbo.EstatisticaVeiculoRankingConsumo (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  Placa nvarchar(20) NULL,
  Modelo nvarchar(100) NULL,
  KmRodado decimal(18, 2) NOT NULL DEFAULT (0),
  LitrosAbastecidos decimal(18, 2) NOT NULL DEFAULT (0),
  ConsumoKmPorLitro decimal(10, 2) NOT NULL DEFAULT (0),
  TotalAbastecimentos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicRankConsumo UNIQUE (Ano, VeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicRankConsumo_Ano] on table [dbo].[EstatisticaVeiculoRankingConsumo]
--
PRINT (N'Create index [IX_EstatVeicRankConsumo_Ano] on table [dbo].[EstatisticaVeiculoRankingConsumo]')
GO
CREATE INDEX IX_EstatVeicRankConsumo_Ano
  ON dbo.EstatisticaVeiculoRankingConsumo (Ano)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicRankConsumo_Consumo] on table [dbo].[EstatisticaVeiculoRankingConsumo]
--
PRINT (N'Create index [IX_EstatVeicRankConsumo_Consumo] on table [dbo].[EstatisticaVeiculoRankingConsumo]')
GO
CREATE INDEX IX_EstatVeicRankConsumo_Consumo
  ON dbo.EstatisticaVeiculoRankingConsumo (Ano, ConsumoKmPorLitro DESC)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaVeiculoModelo]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoModelo]')
GO
CREATE TABLE dbo.EstatisticaVeiculoModelo (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  ModeloId uniqueidentifier NULL,
  Modelo nvarchar(100) NOT NULL,
  TotalVeiculos int NOT NULL DEFAULT (0),
  VeiculosAtivos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicModelo UNIQUE (Modelo)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicModelo] on table [dbo].[EstatisticaVeiculoModelo]
--
PRINT (N'Create index [IX_EstatVeicModelo] on table [dbo].[EstatisticaVeiculoModelo]')
GO
CREATE INDEX IX_EstatVeicModelo
  ON dbo.EstatisticaVeiculoModelo (Modelo)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoModelo]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoModelo]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoModelo
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DELETE FROM EstatisticaVeiculoModelo;

        INSERT INTO EstatisticaVeiculoModelo (
            ModeloId, Modelo, TotalVeiculos, VeiculosAtivos, DataAtualizacao
        )
        SELECT
            MIN(v.ModeloId), -- Pega o primeiro ModeloId encontrado para cada nome de modelo
            ISNULL(m.DescricaoModelo, 'Não Informado'),
            COUNT(*),
            SUM(CASE WHEN v.Status = 1 THEN 1 ELSE 0 END),
            GETDATE()
        FROM Veiculo v
        LEFT JOIN ModeloVeiculo m ON v.ModeloId = m.ModeloId
        GROUP BY m.DescricaoModelo; -- Agrupa apenas pelo nome do modelo

        COMMIT TRANSACTION;
        PRINT 'Estatísticas por modelo recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaVeiculoCombustivel]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoCombustivel]')
GO
CREATE TABLE dbo.EstatisticaVeiculoCombustivel (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Combustivel nvarchar(100) NOT NULL,
  TotalVeiculos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicCombustivel UNIQUE (Combustivel)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicCombustivel] on table [dbo].[EstatisticaVeiculoCombustivel]
--
PRINT (N'Create index [IX_EstatVeicCombustivel] on table [dbo].[EstatisticaVeiculoCombustivel]')
GO
CREATE INDEX IX_EstatVeicCombustivel
  ON dbo.EstatisticaVeiculoCombustivel (Combustivel)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaVeiculoCategoria]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoCategoria]')
GO
CREATE TABLE dbo.EstatisticaVeiculoCategoria (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Categoria nvarchar(100) NOT NULL,
  TotalVeiculos int NOT NULL DEFAULT (0),
  VeiculosAtivos int NOT NULL DEFAULT (0),
  VeiculosProprios int NOT NULL DEFAULT (0),
  VeiculosLocados int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicCategoria UNIQUE (Categoria)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicCategoria] on table [dbo].[EstatisticaVeiculoCategoria]
--
PRINT (N'Create index [IX_EstatVeicCategoria] on table [dbo].[EstatisticaVeiculoCategoria]')
GO
CREATE INDEX IX_EstatVeicCategoria
  ON dbo.EstatisticaVeiculoCategoria (Categoria)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoCategoria]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoCategoria]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoCategoria
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DELETE FROM EstatisticaVeiculoCategoria;

        INSERT INTO EstatisticaVeiculoCategoria (
            Categoria, TotalVeiculos, VeiculosAtivos,
            VeiculosProprios, VeiculosLocados, DataAtualizacao
        )
        SELECT
            ISNULL(Categoria, 'Sem Categoria'),
            COUNT(*),
            SUM(CASE WHEN Status = 1 THEN 1 ELSE 0 END),
            SUM(CASE WHEN VeiculoProprio = 1 THEN 1 ELSE 0 END),
            SUM(CASE WHEN VeiculoProprio = 0 THEN 1 ELSE 0 END),
            GETDATE()
        FROM Veiculo
        GROUP BY Categoria;

        COMMIT TRANSACTION;
        PRINT 'Estatísticas por categoria recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaAbastecimentoVeiculo]
--
PRINT (N'Create table [dbo].[EstatisticaAbastecimentoVeiculo]')
GO
CREATE TABLE dbo.EstatisticaAbastecimentoVeiculo (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  Placa nvarchar(20) NULL,
  TipoVeiculo nvarchar(100) NULL,
  Categoria nvarchar(100) NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatAbastVeiculo UNIQUE (Ano, VeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastVeiculo_Ano] on table [dbo].[EstatisticaAbastecimentoVeiculo]
--
PRINT (N'Create index [IX_EstatAbastVeiculo_Ano] on table [dbo].[EstatisticaAbastecimentoVeiculo]')
GO
CREATE INDEX IX_EstatAbastVeiculo_Ano
  ON dbo.EstatisticaAbastecimentoVeiculo (Ano)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastVeiculo_Valor] on table [dbo].[EstatisticaAbastecimentoVeiculo]
--
PRINT (N'Create index [IX_EstatAbastVeiculo_Valor] on table [dbo].[EstatisticaAbastecimentoVeiculo]')
GO
CREATE INDEX IX_EstatAbastVeiculo_Valor
  ON dbo.EstatisticaAbastecimentoVeiculo (Ano, ValorTotal DESC)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastVeiculo_Veiculo] on table [dbo].[EstatisticaAbastecimentoVeiculo]
--
PRINT (N'Create index [IX_EstatAbastVeiculo_Veiculo] on table [dbo].[EstatisticaAbastecimentoVeiculo]')
GO
CREATE INDEX IX_EstatAbastVeiculo_Veiculo
  ON dbo.EstatisticaAbastecimentoVeiculo (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaAbastecimentoTipoVeiculo]
--
PRINT (N'Create table [dbo].[EstatisticaAbastecimentoTipoVeiculo]')
GO
CREATE TABLE dbo.EstatisticaAbastecimentoTipoVeiculo (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  TipoVeiculo nvarchar(100) NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatAbastTipo UNIQUE (Ano, Mes, TipoVeiculo)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastTipo_AnoMes] on table [dbo].[EstatisticaAbastecimentoTipoVeiculo]
--
PRINT (N'Create index [IX_EstatAbastTipo_AnoMes] on table [dbo].[EstatisticaAbastecimentoTipoVeiculo]')
GO
CREATE INDEX IX_EstatAbastTipo_AnoMes
  ON dbo.EstatisticaAbastecimentoTipoVeiculo (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastTipo_Tipo] on table [dbo].[EstatisticaAbastecimentoTipoVeiculo]
--
PRINT (N'Create index [IX_EstatAbastTipo_Tipo] on table [dbo].[EstatisticaAbastecimentoTipoVeiculo]')
GO
CREATE INDEX IX_EstatAbastTipo_Tipo
  ON dbo.EstatisticaAbastecimentoTipoVeiculo (TipoVeiculo)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaAbastecimentoCombustivel]
--
PRINT (N'Create table [dbo].[EstatisticaAbastecimentoCombustivel]')
GO
CREATE TABLE dbo.EstatisticaAbastecimentoCombustivel (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  TipoCombustivel nvarchar(100) NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NULL DEFAULT (0),
  MediaValorLitro decimal(18, 4) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatAbastComb UNIQUE (Ano, Mes, TipoCombustivel)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastComb_AnoMes] on table [dbo].[EstatisticaAbastecimentoCombustivel]
--
PRINT (N'Create index [IX_EstatAbastComb_AnoMes] on table [dbo].[EstatisticaAbastecimentoCombustivel]')
GO
CREATE INDEX IX_EstatAbastComb_AnoMes
  ON dbo.EstatisticaAbastecimentoCombustivel (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastComb_Comb] on table [dbo].[EstatisticaAbastecimentoCombustivel]
--
PRINT (N'Create index [IX_EstatAbastComb_Comb] on table [dbo].[EstatisticaAbastecimentoCombustivel]')
GO
CREATE INDEX IX_EstatAbastComb_Comb
  ON dbo.EstatisticaAbastecimentoCombustivel (TipoCombustivel)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaAbastecimentoCategoria]
--
PRINT (N'Create table [dbo].[EstatisticaAbastecimentoCategoria]')
GO
CREATE TABLE dbo.EstatisticaAbastecimentoCategoria (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  Categoria nvarchar(100) NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatAbastCat UNIQUE (Ano, Mes, Categoria)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastCat_AnoMes] on table [dbo].[EstatisticaAbastecimentoCategoria]
--
PRINT (N'Create index [IX_EstatAbastCat_AnoMes] on table [dbo].[EstatisticaAbastecimentoCategoria]')
GO
CREATE INDEX IX_EstatAbastCat_AnoMes
  ON dbo.EstatisticaAbastecimentoCategoria (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastCat_Cat] on table [dbo].[EstatisticaAbastecimentoCategoria]
--
PRINT (N'Create index [IX_EstatAbastCat_Cat] on table [dbo].[EstatisticaAbastecimentoCategoria]')
GO
CREATE INDEX IX_EstatAbastCat_Cat
  ON dbo.EstatisticaAbastecimentoCategoria (Categoria)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[DocumentoContrato]
--
PRINT (N'Create table [dbo].[DocumentoContrato]')
GO
CREATE TABLE dbo.DocumentoContrato (
  DocumentoContratoId uniqueidentifier NOT NULL DEFAULT (newid()),
  TipoDocumento varchar(50) NULL,
  Descricao varchar(150) NULL,
  DocumentoPDF varbinary(max) NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_DocumentoContrato_DocumentoContratoId PRIMARY KEY CLUSTERED (DocumentoContratoId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[CorridasTaxiLeg]
--
PRINT (N'Create table [dbo].[CorridasTaxiLeg]')
GO
CREATE TABLE dbo.CorridasTaxiLeg (
  CorridaId uniqueidentifier NOT NULL DEFAULT (newid()),
  QRU int NULL,
  Origem varchar(200) NULL,
  Setor varchar(200) NULL,
  DescSetor varchar(300) NULL,
  Unidade varchar(200) NULL,
  DescUnidade varchar(200) NULL,
  QtdPassageiros int NULL,
  MotivoUso varchar(200) NULL,
  DataAgenda date NULL,
  HoraAgenda varchar(5) NULL,
  HoraAceite varchar(5) NULL,
  HoraLocal varchar(5) NULL,
  HoraInicio varchar(5) NULL,
  HoraFinal varchar(5) NULL,
  DataFinal date NULL,
  KmReal float NULL,
  Valor float NULL,
  QtdEstrelas int NULL,
  Avaliacao varchar(50) NULL,
  Duracao int NULL,
  Espera int NULL,
  OrigemCorrida varchar(150) NULL,
  DestinoCorrida varchar(150) NULL,
  Glosa bit NULL,
  ValorGlosa float NULL,
  CONSTRAINT PK_CorridasTaxiLeg_CorridaId PRIMARY KEY CLUSTERED (CorridaId)
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[CorridasCanceladasTaxiLeg]
--
PRINT (N'Create table [dbo].[CorridasCanceladasTaxiLeg]')
GO
CREATE TABLE dbo.CorridasCanceladasTaxiLeg (
  CorridaCanceladaId uniqueidentifier NOT NULL DEFAULT (newid()),
  Origem varchar(100) NULL,
  Setor varchar(500) NULL,
  SetorExtra varchar(500) NULL,
  Unidade varchar(500) NULL,
  UnidadeExtra varchar(500) NULL,
  QtdPassageiros int NULL,
  MotivoUso varchar(500) NULL,
  DataAgenda datetime NULL,
  HoraAgenda varchar(5) NULL,
  DataHoraCancelamento datetime NULL,
  HoraCancelamento varchar(5) NULL,
  TipoCancelamento varchar(500) NULL,
  MotivoCancelamento varchar(500) NULL,
  TempoEspera int NULL,
  CONSTRAINT PK_CorridasCanceladasTaxiLeg_CorridaCanceladaId PRIMARY KEY CLUSTERED (CorridaCanceladaId)
)
ON [PRIMARY]
GO

--
-- Create or alter view [dbo].[ViewCalculaMediana (backup)]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCalculaMediana (backup)]')
GO
CREATE OR ALTER VIEW dbo.[ViewCalculaMediana (backup)] 
AS SELECT x.TempoEspera 
FROM   (SELECT TempoEspera, 
               Count(1) OVER (partition BY 'A')        AS TotalRows, 
               Row_number() OVER (ORDER BY TempoEspera ASC) AS AmountOrder 
        FROM   CorridasCanceladasTaxiLeg ft) x 
WHERE  x.AmountOrder = Round(x.TotalRows / 2.0, 0)  
GO

--
-- Create table [dbo].[ControleAcesso_BACKUP]
--
PRINT (N'Create table [dbo].[ControleAcesso_BACKUP]')
GO
CREATE TABLE dbo.ControleAcesso_BACKUP (
  UsuarioId nvarchar(450) NOT NULL,
  RecursoId uniqueidentifier NOT NULL,
  Acesso bit NOT NULL
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[Contatos]
--
PRINT (N'Create table [dbo].[Contatos]')
GO
CREATE TABLE dbo.Contatos (
  ContatoId uniqueidentifier NOT NULL,
  Nome nvarchar(200) NOT NULL,
  Celular nvarchar(20) NULL,
  Telefone nvarchar(20) NULL,
  Email nvarchar(200) NULL,
  Cargo nvarchar(100) NULL,
  Departamento nvarchar(100) NULL,
  Ativo bit NOT NULL DEFAULT (1),
  DataCadastro datetime NOT NULL DEFAULT (getdate()),
  DataAtualizacao datetime NULL,
  Observacoes nvarchar(500) NULL,
  RecebeWhatsApp bit NOT NULL DEFAULT (1),
  OptOutWhatsApp bit NOT NULL DEFAULT (0),
  PRIMARY KEY CLUSTERED (ContatoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_Contatos_Ativo] on table [dbo].[Contatos]
--
PRINT (N'Create index [IX_Contatos_Ativo] on table [dbo].[Contatos]')
GO
CREATE INDEX IX_Contatos_Ativo
  ON dbo.Contatos (Ativo)
  ON [PRIMARY]
GO

--
-- Create index [IX_Contatos_Celular] on table [dbo].[Contatos]
--
PRINT (N'Create index [IX_Contatos_Celular] on table [dbo].[Contatos]')
GO
CREATE INDEX IX_Contatos_Celular
  ON dbo.Contatos (Celular)
  ON [PRIMARY]
GO

--
-- Create index [IX_Contatos_Email] on table [dbo].[Contatos]
--
PRINT (N'Create index [IX_Contatos_Email] on table [dbo].[Contatos]')
GO
CREATE INDEX IX_Contatos_Email
  ON dbo.Contatos (Email)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[CondutorApoio]
--
PRINT (N'Create table [dbo].[CondutorApoio]')
GO
CREATE TABLE dbo.CondutorApoio (
  CondutorId uniqueidentifier NOT NULL DEFAULT (newid()),
  Descricao varchar(50) NULL,
  Status bit NULL,
  CONSTRAINT PK_CondutorApoio_CondutorId PRIMARY KEY CLUSTERED (CondutorId)
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[Combustivel]
--
PRINT (N'Create table [dbo].[Combustivel]')
GO
CREATE TABLE dbo.Combustivel (
  CombustivelId uniqueidentifier NOT NULL DEFAULT (newid()),
  Descricao varchar(50) NOT NULL,
  Status bit NULL DEFAULT (1),
  CONSTRAINT PK_Combustiveis_id_combustivel PRIMARY KEY CLUSTERED (CombustivelId)
)
ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[Combustivel]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Combustivel]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', 'Tipos de Combustivel', 'SCHEMA', N'dbo', 'TABLE', N'Combustivel'
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoCombustivel]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoCombustivel]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoCombustivel
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DELETE FROM EstatisticaVeiculoCombustivel;

        INSERT INTO EstatisticaVeiculoCombustivel (Combustivel, TotalVeiculos, DataAtualizacao)
        SELECT
            ISNULL(c.Descricao, 'Não Informado'),
            COUNT(*),
            GETDATE()
        FROM Veiculo v
        LEFT JOIN Combustivel c ON v.CombustivelId = c.CombustivelId
        GROUP BY c.Descricao; -- Já está correto, agrupa apenas pela descrição

        COMMIT TRANSACTION;
        PRINT 'Estatísticas por combustível recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[MediaCombustivel]
--
PRINT (N'Create table [dbo].[MediaCombustivel]')
GO
CREATE TABLE dbo.MediaCombustivel (
  NotaFiscalId uniqueidentifier NOT NULL,
  CombustivelId uniqueidentifier NOT NULL,
  Ano int NOT NULL,
  Mes int NOT NULL,
  PrecoMedio float NULL,
  CONSTRAINT PK_PrecoCombustivel PRIMARY KEY CLUSTERED (NotaFiscalId, CombustivelId, Ano, Mes)
)
ON [PRIMARY]
GO

--
-- Create index [IX_MediaCombustivel_CombustivelId_AnoMes] on table [dbo].[MediaCombustivel]
--
PRINT (N'Create index [IX_MediaCombustivel_CombustivelId_AnoMes] on table [dbo].[MediaCombustivel]')
GO
CREATE INDEX IX_MediaCombustivel_CombustivelId_AnoMes
  ON dbo.MediaCombustivel (CombustivelId, Ano DESC, Mes DESC)
  INCLUDE (PrecoMedio)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_PrecoCombustivel_Combustivel] on table [dbo].[MediaCombustivel]
--
PRINT (N'Create foreign key [FK_PrecoCombustivel_Combustivel] on table [dbo].[MediaCombustivel]')
GO
ALTER TABLE dbo.MediaCombustivel
  ADD CONSTRAINT FK_PrecoCombustivel_Combustivel FOREIGN KEY (CombustivelId) REFERENCES dbo.Combustivel (CombustivelId)
GO

--
-- Create foreign key [FK_PrecoCombustivel_NotaFiscal] on table [dbo].[MediaCombustivel]
--
PRINT (N'Create foreign key [FK_PrecoCombustivel_NotaFiscal] on table [dbo].[MediaCombustivel]')
GO
ALTER TABLE dbo.MediaCombustivel
  ADD CONSTRAINT FK_PrecoCombustivel_NotaFiscal FOREIGN KEY (NotaFiscalId) REFERENCES dbo.NotaFiscal (NotaFiscalId)
GO

--
-- Create table [dbo].[AspNetUserTokens]
--
PRINT (N'Create table [dbo].[AspNetUserTokens]')
GO
CREATE TABLE dbo.AspNetUserTokens (
  UserId nvarchar(450) NOT NULL,
  LoginProvider nvarchar(450) NOT NULL,
  Name nvarchar(450) NOT NULL,
  Value nvarchar(max) NULL
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[AspNetUsers]
--
PRINT (N'Create table [dbo].[AspNetUsers]')
GO
CREATE TABLE dbo.AspNetUsers (
  Id nvarchar(450) NOT NULL,
  UserName nvarchar(256) NULL,
  NormalizedUserName nvarchar(256) NULL,
  Email nvarchar(256) NULL,
  NormalizedEmail nvarchar(256) NULL,
  EmailConfirmed bit NULL,
  PasswordHash nvarchar(max) NULL,
  SecurityStamp nvarchar(max) NULL,
  ConcurrencyStamp nvarchar(max) NULL,
  PhoneNumber nvarchar(max) NULL,
  PhoneNumberConfirmed bit NULL,
  TwoFactorEnabled bit NULL,
  LockoutEnd datetimeoffset NULL,
  LockoutEnabled bit NULL,
  AccessFailedCount int NULL,
  Discriminator nvarchar(max) NULL,
  NomeCompleto nvarchar(max) NULL,
  Ponto nvarchar(max) NULL,
  PrecisaMudarSenha bit NULL,
  Ramal int NULL,
  Status bit NULL DEFAULT (1),
  Foto varbinary(max) NULL,
  Criacao datetime NULL,
  UltimoLogin datetime NULL,
  DetentorCargaPatrimonial bit NULL,
  UsuarioIdAlteracao varchar(150) NULL,
  Vistoriador bit NULL DEFAULT (1),
  CONSTRAINT PK_AspNetUsers_Id PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[SetorPatrimonial]
--
PRINT (N'Create table [dbo].[SetorPatrimonial]')
GO
CREATE TABLE dbo.SetorPatrimonial (
  SetorId uniqueidentifier NOT NULL,
  NomeSetor varchar(50) NOT NULL,
  DetentorId nvarchar(450) NOT NULL,
  Status bit NOT NULL DEFAULT (1),
  SetorBaixa bit NULL,
  CONSTRAINT PK_Setor_SetorId PRIMARY KEY CLUSTERED (SetorId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_Setor_AspNetUser] on table [dbo].[SetorPatrimonial]
--
PRINT (N'Create foreign key [FK_Setor_AspNetUser] on table [dbo].[SetorPatrimonial]')
GO
ALTER TABLE dbo.SetorPatrimonial
  ADD CONSTRAINT FK_Setor_AspNetUser FOREIGN KEY (DetentorId) REFERENCES dbo.AspNetUsers (Id)
GO

--
-- Create table [dbo].[SecaoPatrimonial]
--
PRINT (N'Create table [dbo].[SecaoPatrimonial]')
GO
CREATE TABLE dbo.SecaoPatrimonial (
  SecaoId uniqueidentifier NOT NULL,
  NomeSecao varchar(50) NOT NULL,
  SetorId uniqueidentifier NOT NULL,
  Status bit NOT NULL,
  CONSTRAINT PK_Secao_SecaoId PRIMARY KEY CLUSTERED (SecaoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_Secao_Setor] on table [dbo].[SecaoPatrimonial]
--
PRINT (N'Create foreign key [FK_Secao_Setor] on table [dbo].[SecaoPatrimonial]')
GO
ALTER TABLE dbo.SecaoPatrimonial
  ADD CONSTRAINT FK_Secao_Setor FOREIGN KEY (SetorId) REFERENCES dbo.SetorPatrimonial (SetorId)
GO

--
-- Create table [dbo].[Patrimonio]
--
PRINT (N'Create table [dbo].[Patrimonio]')
GO
CREATE TABLE dbo.Patrimonio (
  PatrimonioId uniqueidentifier NOT NULL,
  NPR varchar(50) NOT NULL,
  Marca varchar(50) NULL,
  Modelo varchar(50) NULL,
  Descricao varchar(100) NOT NULL,
  NumeroSerie varchar(50) NULL,
  SecaoId uniqueidentifier NOT NULL,
  Situacao varchar(50) NOT NULL,
  SetorId uniqueidentifier NOT NULL,
  LocalizacaoAtual varchar(150) NOT NULL,
  Status bit NULL,
  ImageUrl varchar(500) NULL,
  Imagem varbinary(max) NULL,
  StatusConferencia int NULL,
  LocalizacaoConferencia varchar(150) NULL,
  SetorConferenciaId uniqueidentifier NULL,
  SecaoConferenciaId uniqueidentifier NULL,
  DataEntrada date NULL,
  DataSaida date NULL,
  CONSTRAINT PK_Patrimonio_PatrimonioId PRIMARY KEY CLUSTERED (PatrimonioId),
  CONSTRAINT KEY_PatrimonioNPR UNIQUE (NPR)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create foreign key [FK_Patrimonio_SecaoId] on table [dbo].[Patrimonio]
--
PRINT (N'Create foreign key [FK_Patrimonio_SecaoId] on table [dbo].[Patrimonio]')
GO
ALTER TABLE dbo.Patrimonio
  ADD CONSTRAINT FK_Patrimonio_SecaoId FOREIGN KEY (SecaoId) REFERENCES dbo.SecaoPatrimonial (SecaoId)
GO

--
-- Create foreign key [FK_Patrimonio_SetorId] on table [dbo].[Patrimonio]
--
PRINT (N'Create foreign key [FK_Patrimonio_SetorId] on table [dbo].[Patrimonio]')
GO
ALTER TABLE dbo.Patrimonio
  ADD CONSTRAINT FK_Patrimonio_SetorId FOREIGN KEY (SetorId) REFERENCES dbo.SetorPatrimonial (SetorId)
GO

--
-- Create or alter view [dbo].[ViewPatrimonioConferencia]
--
GO
PRINT (N'Create or alter view [dbo].[ViewPatrimonioConferencia]')
GO
CREATE OR ALTER VIEW dbo.ViewPatrimonioConferencia 
AS SELECT
  Patrimonio.PatrimonioId
 ,Patrimonio.NPR
 ,Patrimonio.Descricao
 ,Patrimonio.LocalizacaoAtual
 ,Patrimonio.Marca
 ,Patrimonio.Modelo
 ,SetorPatrimonial.NomeSetor
 ,SecaoPatrimonial.NomeSecao
 ,Patrimonio.Status
 ,Patrimonio.StatusConferencia
 ,Patrimonio.LocalizacaoConferencia
 ,Patrimonio.SetorConferenciaId
 ,Patrimonio.SecaoConferenciaId
 ,Patrimonio.Situacao
FROM dbo.Patrimonio
INNER JOIN dbo.SetorPatrimonial
  ON Patrimonio.SetorId = SetorPatrimonial.SetorId
INNER JOIN dbo.SecaoPatrimonial
  ON Patrimonio.SecaoId = SecaoPatrimonial.SecaoId
    AND SecaoPatrimonial.SetorId = SetorPatrimonial.SetorId
GO

--
-- Create table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create table [dbo].[MovimentacaoPatrimonio]')
GO
CREATE TABLE dbo.MovimentacaoPatrimonio (
  MovimentacaoPatrimonioId uniqueidentifier NOT NULL,
  DataMovimentacao datetime NOT NULL,
  ResponsavelMovimentacao nvarchar(450) NOT NULL,
  SecaoOrigemId uniqueidentifier NOT NULL,
  SecaoDestinoId uniqueidentifier NOT NULL,
  SetorOrigemId uniqueidentifier NOT NULL,
  SetorDestinoId uniqueidentifier NOT NULL,
  PatrimonioId uniqueidentifier NOT NULL,
  CONSTRAINT PK_MovimentacaoPatrimonio_MovimentacaoPatrimonioId PRIMARY KEY CLUSTERED (MovimentacaoPatrimonioId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_MovimentacaoPatrimonio_PatrimonioId] on table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create foreign key [FK_MovimentacaoPatrimonio_PatrimonioId] on table [dbo].[MovimentacaoPatrimonio]')
GO
ALTER TABLE dbo.MovimentacaoPatrimonio
  ADD CONSTRAINT FK_MovimentacaoPatrimonio_PatrimonioId FOREIGN KEY (PatrimonioId) REFERENCES dbo.Patrimonio (PatrimonioId)
GO

--
-- Create foreign key [FK_MovimentacaoPatrimonio_ResponsavelMovimentacao] on table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create foreign key [FK_MovimentacaoPatrimonio_ResponsavelMovimentacao] on table [dbo].[MovimentacaoPatrimonio]')
GO
ALTER TABLE dbo.MovimentacaoPatrimonio
  ADD CONSTRAINT FK_MovimentacaoPatrimonio_ResponsavelMovimentacao FOREIGN KEY (ResponsavelMovimentacao) REFERENCES dbo.AspNetUsers (Id)
GO

--
-- Create foreign key [FK_MovimentacaoPatrimonio_SecaoDestino] on table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create foreign key [FK_MovimentacaoPatrimonio_SecaoDestino] on table [dbo].[MovimentacaoPatrimonio]')
GO
ALTER TABLE dbo.MovimentacaoPatrimonio
  ADD CONSTRAINT FK_MovimentacaoPatrimonio_SecaoDestino FOREIGN KEY (SecaoDestinoId) REFERENCES dbo.SecaoPatrimonial (SecaoId)
GO

--
-- Create foreign key [FK_MovimentacaoPatrimonio_SecaoOrigem] on table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create foreign key [FK_MovimentacaoPatrimonio_SecaoOrigem] on table [dbo].[MovimentacaoPatrimonio]')
GO
ALTER TABLE dbo.MovimentacaoPatrimonio
  ADD CONSTRAINT FK_MovimentacaoPatrimonio_SecaoOrigem FOREIGN KEY (SecaoOrigemId) REFERENCES dbo.SecaoPatrimonial (SecaoId)
GO

--
-- Create foreign key [FK_MovimentacaoPatrimonio_SetorDestino] on table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create foreign key [FK_MovimentacaoPatrimonio_SetorDestino] on table [dbo].[MovimentacaoPatrimonio]')
GO
ALTER TABLE dbo.MovimentacaoPatrimonio
  ADD CONSTRAINT FK_MovimentacaoPatrimonio_SetorDestino FOREIGN KEY (SetorDestinoId) REFERENCES dbo.SetorPatrimonial (SetorId)
GO

--
-- Create foreign key [FK_MovimentacaoPatrimonio_SetorOrigem] on table [dbo].[MovimentacaoPatrimonio]
--
PRINT (N'Create foreign key [FK_MovimentacaoPatrimonio_SetorOrigem] on table [dbo].[MovimentacaoPatrimonio]')
GO
ALTER TABLE dbo.MovimentacaoPatrimonio
  ADD CONSTRAINT FK_MovimentacaoPatrimonio_SetorOrigem FOREIGN KEY (SetorOrigemId) REFERENCES dbo.SetorPatrimonial (SetorId)
GO

--
-- Create table [dbo].[Manutencao]
--
PRINT (N'Create table [dbo].[Manutencao]')
GO
CREATE TABLE dbo.Manutencao (
  ManutencaoId uniqueidentifier NOT NULL DEFAULT (newid()),
  NumOS varchar(50) NOT NULL,
  DataSolicitacao datetime NOT NULL,
  VeiculoId uniqueidentifier NULL,
  ResumoOS varchar(500) NULL CONSTRAINT DF_Manutencao_ResumoOS DEFAULT (''),
  DataDevolucao datetime NULL,
  StatusOS varchar(50) NULL CONSTRAINT DF_Manutencao_StatusOS DEFAULT (''),
  DataRecolhimento datetime NULL,
  ReservaEnviado bit NULL CONSTRAINT DF_Manutencao_ReservaEnviado DEFAULT (0),
  VeiculoReservaId uniqueidentifier NULL,
  DataRecebimentoReserva datetime NULL,
  DataDevolucaoReserva datetime NULL,
  ManutencaoPreventiva bit NULL CONSTRAINT DF_Manutencao_ManutencaoPreventiva DEFAULT (0),
  QuilometragemManutencao int NULL CONSTRAINT DF_Manutencao_QuilometragemManutencao DEFAULT (0),
  DataEntrega date NULL,
  IdUsuarioAlteracao nvarchar(450) NULL,
  DataAlteracao datetime NULL,
  IdUsuarioCancelamento varchar(100) NULL,
  DataCancelamento datetime NULL,
  IdUsuarioCriacao varchar(100) NULL,
  DataCriacao datetime NULL,
  IdUsuarioFinalizacao varchar(100) NULL,
  DataFinalizacao datetime NULL,
  DataDisponibilidade date NULL,
  CONSTRAINT PK_Manutencao_ManutencaoId PRIMARY KEY CLUSTERED (ManutencaoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_Manutencao_DataSolicitacao] on table [dbo].[Manutencao]
--
PRINT (N'Create index [IX_Manutencao_DataSolicitacao] on table [dbo].[Manutencao]')
GO
CREATE INDEX IX_Manutencao_DataSolicitacao
  ON dbo.Manutencao (DataSolicitacao DESC)
  INCLUDE (ManutencaoId, VeiculoId, StatusOS, ResumoOS, VeiculoReservaId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Manutencao_StatusOS] on table [dbo].[Manutencao]
--
PRINT (N'Create index [IX_Manutencao_StatusOS] on table [dbo].[Manutencao]')
GO
CREATE INDEX IX_Manutencao_StatusOS
  ON dbo.Manutencao (StatusOS)
  INCLUDE (VeiculoId, DataSolicitacao, ResumoOS)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Manutencao_VeiculoId_DataSolicitacao] on table [dbo].[Manutencao]
--
PRINT (N'Create index [IX_Manutencao_VeiculoId_DataSolicitacao] on table [dbo].[Manutencao]')
GO
CREATE INDEX IX_Manutencao_VeiculoId_DataSolicitacao
  ON dbo.Manutencao (VeiculoId, DataSolicitacao DESC)
  INCLUDE (ManutencaoId, StatusOS, ResumoOS, DataDevolucao, DataFinalizacao)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Manutencao_IdUsuarioAlteracao] on table [dbo].[Manutencao]
--
PRINT (N'Create foreign key [FK_Manutencao_IdUsuarioAlteracao] on table [dbo].[Manutencao]')
GO
ALTER TABLE dbo.Manutencao
  ADD CONSTRAINT FK_Manutencao_IdUsuarioAlteracao FOREIGN KEY (IdUsuarioAlteracao) REFERENCES dbo.AspNetUsers (Id)
GO

--
-- Create foreign key [FK_Manutencao_VeiculoReservaId] on table [dbo].[Manutencao]
--
PRINT (N'Create foreign key [FK_Manutencao_VeiculoReservaId] on table [dbo].[Manutencao]')
GO
ALTER TABLE dbo.Manutencao
  ADD CONSTRAINT FK_Manutencao_VeiculoReservaId FOREIGN KEY (VeiculoReservaId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create foreign key [FK_ManutencaoVeiculo] on table [dbo].[Manutencao]
--
PRINT (N'Create foreign key [FK_ManutencaoVeiculo] on table [dbo].[Manutencao]')
GO
ALTER TABLE dbo.Manutencao
  ADD CONSTRAINT FK_ManutencaoVeiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create or alter view [dbo].[ViewManutencaoAberta_Base]
--
GO
PRINT (N'Create or alter view [dbo].[ViewManutencaoAberta_Base]')
GO
CREATE OR ALTER VIEW dbo.ViewManutencaoAberta_Base 
AS SELECT
    m.ManutencaoId,
    m.NumOS,
    m.DataSolicitacao,
    m.ResumoOS,
    m.DataRecolhimento,
    m.DataRecebimentoReserva,
    m.DataDevolucaoReserva,
    m.DataDisponibilidade,
    m.DataEntrega,
    m.StatusOS,
    m.VeiculoId,
    v.ItemVeiculoId,  -- leva para a UI fazer LEFT JOIN
    -- Concatenação determinística para descrição:
    '(' + v.Placa + ') ' + ma.DescricaoMarca + ' / ' + mo.DescricaoModelo AS DescricaoVeiculo,
    CAST(ISNULL(m.ReservaEnviado, 0) AS bit) AS ReservaEnviado,
    m.DataDevolucao,
    -- Cálculo determinístico/preciso:
    DATEDIFF(DAY, ISNULL(m.DataEntrega, m.DataSolicitacao), ISNULL(m.DataDevolucao, m.DataSolicitacao)) AS DiasGlosa
FROM dbo.Manutencao      AS m
JOIN dbo.Veiculo         AS v  ON m.VeiculoId = v.VeiculoId
JOIN dbo.ModeloVeiculo   AS mo ON v.ModeloId  = mo.ModeloId       -- ajuste se o nome for diferente
JOIN dbo.MarcaVeiculo    AS ma ON mo.MarcaId  = ma.MarcaId
WHERE m.StatusOS = 'Aberta'
GO

--
-- Create or alter view [dbo].[ViewManutencao.ATUAL]
--
GO
PRINT (N'Create or alter view [dbo].[ViewManutencao.ATUAL]')
GO
CREATE OR ALTER VIEW dbo.[ViewManutencao.ATUAL] 
AS SELECT
    b.ManutencaoId,
    b.NumOS,
    b.ResumoOS,

    -- strings formatadas
    CONVERT(CHAR(10), b.DataSolicitacao, 103)                                     AS DataSolicitacao,
    CONVERT(CHAR(10), b.DataRecolhimento, 103)                                     AS DataRecolhimento,
    CONVERT(CHAR(10), b.DataRecebimentoReserva, 103)                               AS DataRecebimentoReserva,
    CONVERT(CHAR(10), b.DataDevolucaoReserva, 103)                                 AS DataDevolucaoReserva,
    CONVERT(CHAR(10), b.DataEntrega, 103)                                          AS DataEntrega,
    CONVERT(CHAR(10), b.DataDisponibilidade, 103)                                   AS DataDisponibilidade,

    -- datas cruas para filtro/ordenação no C#
    b.DataSolicitacao                                                               AS DataSolicitacaoRaw,
    b.DataDevolucao                                                                 AS DataDevolucaoRaw,

    b.StatusOS,
    b.VeiculoId,
    b.DescricaoVeiculo,

    -- Reserva como texto
    CASE
        WHEN b.ReservaEnviado = 1 THEN 'Enviado'
        WHEN b.ReservaEnviado = 0 THEN 'Ausente'
        ELSE ''
    END                                                                             AS Reserva,

    -- DataDevolucao formatada com sentinela
    b.DataDevolucao,

    -- DiasGlosa (mantido, como já existia)
    CASE
        WHEN b.DataDevolucao IS NULL THEN 1
        WHEN b.DataEntrega IS NOT NULL THEN DATEDIFF(DAY, b.DataEntrega, b.DataDevolucao)
        ELSE DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END                                                                             AS DiasGlosa,

    -- === NOVOS CAMPOS p/ seu controller ===
    -- Dias (regra do seu trecho: 0 quando nulo/sentinela; caso contrário diff Solicitação->Devolução)
    CASE
        WHEN b.DataDevolucao IS NULL THEN 0
        ELSE DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END                                                                             AS Dias,

    -- Habilitado (atributos do modal quando não fechada/cancelada)
    CASE
        WHEN b.StatusOS IN ('Fechada','Cancelada') THEN ''
        ELSE 'data-toggle=''modal'' data-target=''#modalManutencao'''
    END                                                                             AS Habilitado,

    -- Icon (cadeado quando fechada/cancelada; bandeira caso contrário)
    CASE
        WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'fa-regular fa-lock'
        ELSE 'far fa-flag-checkered'
    END                                                                             AS Icon,

    ivc.NumItem,

    /* ===== Campos "montados" que você já tinha ===== */
    -- Editar
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END     AS HabilitadoEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END AS OpacityEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Visualizar Manutenção' ELSE 'Edita a Ordem de Serviço!' END AS OpacityTooltipEditarEditar,

    -- Baixar
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END     AS HabilitadoBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS ModalBaixarAttrs,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END AS OpacityBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Desabilitado' ELSE 'Fecha a Ordem de Serviço!' END AS Tooltip,

    -- Cancelar
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END     AS HabilitadoCancelar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END AS OpacityCancelar,
    CASE
        WHEN b.StatusOS = 'Cancelada' THEN 'Manutenção Cancelada'
        WHEN b.StatusOS = 'Fechada'   THEN 'OS Fechada/Baixada'
        ELSE 'Cancelar Manutenção'
    END                                                                             AS TooltipCancelar
FROM dbo.ViewManutencaoAberta_Base AS b
LEFT JOIN dbo.ItemVeiculoContrato  AS ivc
       ON ivc.ItemVeiculoId = b.ItemVeiculoId
GO

--
-- Create or alter view [dbo].[ViewManutencao_Ultima]
--
GO
PRINT (N'Create or alter view [dbo].[ViewManutencao_Ultima]')
GO
CREATE OR ALTER VIEW dbo.ViewManutencao_Ultima 
AS SELECT 
    -- Campo inicial solicitado
    ISNULL(v.Placa,'') + ' - ' + ISNULL(ma.DescricaoMarca,'') + '/' + ISNULL(m.DescricaoModelo,'') AS PlacaDescricao,

    -- ===== Chaves e referência ao contrato (para filtrar na LINQ) =====
    vc.ContratoId,

    -- ===== Manutenção =====
    b.ManutencaoId,
    b.NumOS,
    b.ResumoOS,

    -- strings formatadas (dd/MM/yyyy)
    CONVERT(CHAR(10), b.DataSolicitacao, 103)                                       AS DataSolicitacao,
    CONVERT(CHAR(10), b.DataDisponibilidade, 103)                                   AS DataDisponibilidade,
    CONVERT(CHAR(10), b.DataRecolhimento, 103)                                      AS DataRecolhimento,
    CONVERT(CHAR(10), b.DataRecebimentoReserva, 103)                                AS DataRecebimentoReserva,
    CONVERT(CHAR(10), b.DataDevolucaoReserva, 103)                                  AS DataDevolucaoReserva,
    CONVERT(CHAR(10), b.DataEntrega, 103)                                           AS DataEntrega,
    CONVERT(CHAR(10), b.DataDevolucao, 103)                                         AS DataDevolucao,

    -- datas cruas
    b.DataSolicitacao                                                               AS DataSolicitacaoRaw,
    b.DataDevolucao                                                                 AS DataDevolucaoRaw,

    b.StatusOS,
    b.VeiculoId,

    -- Derivado (Marca/Modelo) e informações auxiliares
    ma.DescricaoMarca + '/' + m.DescricaoModelo                                     AS DescricaoVeiculo,
    u.Sigla                                                                          AS Sigla,
    c.Descricao                                                                      AS CombustivelDescricao,
    v.Placa                                                                          AS Placa,

    -- Reserva como texto
    CASE
        WHEN b.ReservaEnviado = 1 THEN 'Enviado'
        WHEN b.ReservaEnviado = 0 THEN 'Ausente'
        ELSE ''
    END                                                                              AS Reserva,

    -- ===== Planilha de Glosa (Item do contrato, via Veiculo.ItemVeiculoId) =====
    ivc.Descricao,
    ivc.Quantidade,
    ivc.ValorUnitario,

    -- DiasGlosa (via APPLY)
    d.DiasCalc                                                                       AS DiasGlosa,

    -- ValorGlosa (trata NULLs e usa DECIMAL p/ precisão)
    CAST(
        d.DiasCalc
        * COALESCE(CAST(ivc.ValorUnitario AS DECIMAL(18,2)), 0)
        AS DECIMAL(18,2)
    )                                                                                AS ValorGlosa,

    -- Dias (0 quando sem devolução, senão diff Solicitação->Devolução)
    CASE
        WHEN b.DataDevolucao IS NULL THEN 0
        ELSE DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END                                                                              AS Dias,

    -- Atributos de UI
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS Habilitado,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'fa-regular fa-lock' ELSE 'far fa-flag-checkered' END                 AS Icon,

    -- Item do contrato
    ivc.NumItem,

    -- Campos "montados"
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Visualizar Manutenção' ELSE 'Edita a Ordem de Serviço!' END        AS OpacityTooltipEditarEditar,

    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS ModalBaixarAttrs,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Desabilitado' ELSE 'Fecha a Ordem de Serviço!' END                 AS Tooltip,

    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoCancelar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityCancelar,
    CASE
        WHEN b.StatusOS = 'Cancelada' THEN 'Manutenção Cancelada'
        WHEN b.StatusOS = 'Fechada'   THEN 'OS Fechada/Baixada'
        ELSE 'Cancelar Manutenção'
    END                                                                                                                      AS TooltipCancelar

FROM dbo.Manutencao               AS b
LEFT JOIN dbo.Veiculo             AS v   ON v.VeiculoId       = b.VeiculoId
LEFT JOIN dbo.VeiculoContrato     AS vc  ON vc.VeiculoId      = v.VeiculoId
LEFT JOIN dbo.ModeloVeiculo       AS m   ON m.ModeloId        = v.ModeloId
LEFT JOIN dbo.MarcaVeiculo        AS ma  ON ma.MarcaId        = v.MarcaId
LEFT JOIN dbo.Combustivel         AS c   ON c.CombustivelId   = v.CombustivelId
LEFT JOIN dbo.Unidade             AS u   ON u.UnidadeId       = v.UnidadeId
LEFT JOIN dbo.ItemVeiculoContrato AS ivc ON ivc.ItemVeiculoId = v.ItemVeiculoId
CROSS APPLY (
  SELECT DiasCalc =
    CASE
      WHEN b.DataDevolucao IS NULL THEN 1
      WHEN b.DataEntrega  IS NOT NULL THEN DATEDIFF(DAY, b.DataEntrega,  b.DataDevolucao)
      ELSE                               DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END
) AS d

--WHERE
--    v.Status = 1
--    AND b.DataDevolucao IS NOT NULL
--    AND DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao) > 0
GO

--
-- Create or alter view [dbo].[ViewManutencao_2025.11.04]
--
GO
PRINT (N'Create or alter view [dbo].[ViewManutencao_2025.11.04]')
GO
CREATE OR ALTER VIEW dbo.[ViewManutencao_2025.11.04] 
AS SELECT 
    -- Campo inicial solicitado
    ISNULL(v.Placa,'') + ' - ' + ISNULL(ma.DescricaoMarca,'') + '/' + ISNULL(m.DescricaoModelo,'') AS PlacaDescricao,

    -- ===== Chaves e referência ao contrato (para filtrar na LINQ) =====
    vc.ContratoId,

    -- ===== Manutenção =====
    b.ManutencaoId,
    b.NumOS,
    b.ResumoOS,

    -- strings formatadas (dd/MM/yyyy)
    CONVERT(CHAR(10), b.DataSolicitacao,     103) AS DataSolicitacao,
    CONVERT(CHAR(10), b.DataDisponibilidade, 103) AS DataDisponibilidade,
    CONVERT(CHAR(10), b.DataRecolhimento,    103) AS DataRecolhimento,
    CONVERT(CHAR(10), b.DataRecebimentoReserva, 103) AS DataRecebimentoReserva,
    CONVERT(CHAR(10), b.DataDevolucaoReserva,   103) AS DataDevolucaoReserva,
    CONVERT(CHAR(10), b.DataEntrega,         103) AS DataEntrega,
    CONVERT(CHAR(10), b.DataDevolucao,       103) AS DataDevolucao,

    -- datas cruas
    b.DataSolicitacao AS DataSolicitacaoRaw,
    b.DataDevolucao   AS DataDevolucaoRaw,

    b.StatusOS,
    b.VeiculoId,

    -- Derivado (Marca/Modelo) e informações auxiliares
    ma.DescricaoMarca + '/' + m.DescricaoModelo AS DescricaoVeiculo,
    u.Sigla                                    AS Sigla,
    c.Descricao                                AS CombustivelDescricao,
    v.Placa                                    AS Placa,

    -- Reserva em texto (compatibilidade)
    CASE
        WHEN b.ReservaEnviado = 1 THEN 'Enviado'
        WHEN b.ReservaEnviado = 0 THEN 'Ausente'
        ELSE ''
    END AS Reserva,

    -- Novo: ReservaEnviado (Sim/Não)
    CASE WHEN b.ReservaEnviado = 1 THEN 'Sim' ELSE 'Não' END AS ReservaEnviado,

    b.VeiculoReservaId,

    -- ===== Planilha de Glosa (Item do contrato, via Veiculo.ItemVeiculoId) =====
    ivc.Descricao,
    ivc.Quantidade,
    ivc.ValorUnitario,

    -- DiasGlosa (via APPLY)
    d.DiasCalc AS DiasGlosa,

    -- ValorGlosa (trata NULLs e usa DECIMAL p/ precisão)
    CAST(
        d.DiasCalc * COALESCE(CAST(ivc.ValorUnitario AS DECIMAL(18,2)), 0)
        AS DECIMAL(18,2)
    ) AS ValorGlosa,

    -- Dias (0 quando sem devolução, senão diff Solicitação->Devolução)
    CASE
        WHEN b.DataDevolucao IS NULL THEN 0
        ELSE DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END AS Dias,

    -- Atributos de UI
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS Habilitado,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'fa-regular fa-lock' ELSE 'far fa-flag-checkered' END                 AS Icon,

    -- Item do contrato
    ivc.NumItem,

    -- Campos "montados"
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Visualizar Manutenção' ELSE 'Edita a Ordem de Serviço!' END        AS OpacityTooltipEditarEditar,

    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS ModalBaixarAttrs,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Desabilitado' ELSE 'Fecha a Ordem de Serviço!' END                 AS Tooltip,

    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoCancelar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityCancelar,
    CASE
        WHEN b.StatusOS = 'Cancelada' THEN 'Manutenção Cancelada'
        WHEN b.StatusOS = 'Fechada'   THEN 'OS Fechada/Baixada'
        ELSE 'Cancelar Manutenção'
    END AS TooltipCancelar,

    -- ========= Novos campos no formato solicitado =========
    -- Veiculo principal: "Placa - (Marca/Modelo)"
    ISNULL(v.Placa,'') + ' - (' + ISNULL(ma.DescricaoMarca,'') + '/' + ISNULL(m.DescricaoModelo,'') + ')' AS Veiculo,

    -- Carro de reserva (quando houver): "Placa - (Marca/Modelo)"
    CASE
        WHEN b.VeiculoReservaId IS NULL THEN NULL
        ELSE ISNULL(vr.Placa,'') + ' - (' + ISNULL(mar.DescricaoMarca,'') + '/' + ISNULL(mr.DescricaoModelo,'') + ')'
    END AS CarroReserva

FROM dbo.Manutencao               AS b
LEFT JOIN dbo.Veiculo             AS v   ON v.VeiculoId       = b.VeiculoId
LEFT JOIN dbo.VeiculoContrato     AS vc  ON vc.VeiculoId      = v.VeiculoId
LEFT JOIN dbo.ModeloVeiculo       AS m   ON m.ModeloId        = v.ModeloId
LEFT JOIN dbo.MarcaVeiculo        AS ma  ON ma.MarcaId        = v.MarcaId
LEFT JOIN dbo.Combustivel         AS c   ON c.CombustivelId   = v.CombustivelId
LEFT JOIN dbo.Unidade             AS u   ON u.UnidadeId       = v.UnidadeId
LEFT JOIN dbo.ItemVeiculoContrato AS ivc ON ivc.ItemVeiculoId = v.ItemVeiculoId

-- === Inclusão pedida: veículo de reserva ===
LEFT JOIN dbo.Veiculo             AS vr  ON vr.VeiculoId      = b.VeiculoReservaId
LEFT JOIN dbo.MarcaVeiculo        AS mar ON mar.MarcaId       = vr.MarcaId
LEFT JOIN dbo.ModeloVeiculo       AS mr  ON mr.ModeloId       = vr.ModeloId

CROSS APPLY (
  SELECT DiasCalc =
    CASE
      WHEN b.DataDevolucao IS NULL THEN 1
      WHEN b.DataEntrega  IS NOT NULL THEN DATEDIFF(DAY, b.DataEntrega,  b.DataDevolucao)
      ELSE                               DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END
) AS d

--WHERE
--    v.Status = 1
--    AND b.DataDevolucao IS NOT NULL
--    AND DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao) > 0
GO

--
-- Create or alter view [dbo].[ViewManutencao]
--
GO
PRINT (N'Create or alter view [dbo].[ViewManutencao]')
GO
CREATE OR ALTER VIEW dbo.ViewManutencao 
AS SELECT 
    -- Campo inicial solicitado
    ISNULL(v.Placa,'') + ' - ' + ISNULL(ma.DescricaoMarca,'') + '/' + ISNULL(m.DescricaoModelo,'') AS PlacaDescricao,
    -- Veiculo principal: "Placa - (Marca/Modelo)"
    ISNULL(v.Placa,'') + ' - (' + ISNULL(ma.DescricaoMarca,'') + '/' + ISNULL(m.DescricaoModelo,'') + ')' AS Veiculo,

    -- ===== Chaves e referência ao contrato (para filtrar na LINQ) =====
    vc.ContratoId,

    -- ===== Manutenção =====
    b.ManutencaoId,
    b.NumOS,
    b.ResumoOS,

    -- strings formatadas (dd/MM/yyyy)
    CONVERT(CHAR(10), b.DataSolicitacao, 103)                                       AS DataSolicitacao,
    CONVERT(CHAR(10), b.DataDisponibilidade, 103)                                   AS DataDisponibilidade,
    CONVERT(CHAR(10), b.DataRecolhimento, 103)                                      AS DataRecolhimento,
    CONVERT(CHAR(10), b.DataRecebimentoReserva, 103)                                AS DataRecebimentoReserva,
    CONVERT(CHAR(10), b.DataDevolucaoReserva, 103)                                  AS DataDevolucaoReserva,
    CONVERT(CHAR(10), b.DataEntrega, 103)                                           AS DataEntrega,
    CONVERT(CHAR(10), b.DataDevolucao, 103)                                         AS DataDevolucao,

    -- datas cruas
    b.DataSolicitacao                                                               AS DataSolicitacaoRaw,
    b.DataDevolucao                                                                 AS DataDevolucaoRaw,

    b.StatusOS,
    b.VeiculoId,
    b.ReservaEnviado,

    -- Derivado (Marca/Modelo) e informações auxiliares
    ma.DescricaoMarca + '/' + m.DescricaoModelo                                     AS DescricaoVeiculo,
    u.Sigla                                                                          AS Sigla,
    c.Descricao                                                                      AS CombustivelDescricao,
    v.Placa                                                                          AS Placa,

    -- Reserva em texto (compatibilidade)
    CASE
        WHEN b.ReservaEnviado = 1 THEN 'Enviado'
        WHEN b.ReservaEnviado = 0 THEN 'Ausente'
        ELSE ''
    END                                                                              AS Reserva,

    -- ===== Planilha de Glosa (Item do contrato, via Veiculo.ItemVeiculoId) =====
    ivc.Descricao,
    ivc.Quantidade,
    ivc.ValorUnitario,

    -- DiasGlosa (via APPLY)
    d.DiasCalc                                                                       AS DiasGlosa,

    -- ValorGlosa (trata NULLs e usa DECIMAL p/ precisão)
    CAST(
        d.DiasCalc
        * COALESCE(CAST(ivc.ValorUnitario AS DECIMAL(18,2)), 0)
        AS DECIMAL(18,2)
    )                                                                                AS ValorGlosa,

    -- Dias (0 quando sem devolução, senão diff Solicitação->Devolução)
    CASE
        WHEN b.DataDevolucao IS NULL THEN 0
        ELSE DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END                                                                              AS Dias,

    -- Atributos de UI
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS Habilitado,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'fa-regular fa-lock' ELSE 'far fa-flag-checkered' END                 AS Icon,

    -- Item do contrato
    ivc.NumItem,

    -- Carro de reserva (quando houver): "Placa - (Marca/Modelo)"
    CASE
        WHEN b.VeiculoReservaId IS NULL THEN NULL
        ELSE ISNULL(v.Placa,'') + ' - (' + ISNULL(ma.DescricaoMarca,'') + '/' + ISNULL(m.DescricaoModelo,'') + ')'
    END AS CarroReserva,

    -- Campos "montados"
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityEditar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Visualizar Manutenção' ELSE 'Edita a Ordem de Serviço!' END        AS OpacityTooltipEditarEditar,

    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN '' ELSE 'data-toggle=''modal'' data-target=''#modalManutencao''' END AS ModalBaixarAttrs,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityBaixar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'Desabilitado' ELSE 'Fecha a Ordem de Serviço!' END                 AS Tooltip,

    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'disabled' ELSE '' END                                              AS HabilitadoCancelar,
    CASE WHEN b.StatusOS IN ('Fechada','Cancelada') THEN 'opacity:0.3; pointer-events:none;' ELSE 'opacity:1;' END           AS OpacityCancelar,
    CASE
        WHEN b.StatusOS = 'Cancelada' THEN 'Manutenção Cancelada'
        WHEN b.StatusOS = 'Fechada'   THEN 'OS Fechada/Baixada'
        ELSE 'Cancelar Manutenção'
    END                                                                                                                      AS TooltipCancelar

FROM dbo.Manutencao               AS b
LEFT JOIN dbo.Veiculo             AS v   ON v.VeiculoId       = b.VeiculoId
LEFT JOIN dbo.VeiculoContrato     AS vc  ON vc.VeiculoId      = v.VeiculoId
LEFT JOIN dbo.ModeloVeiculo       AS m   ON m.ModeloId        = v.ModeloId
LEFT JOIN dbo.MarcaVeiculo        AS ma  ON ma.MarcaId        = v.MarcaId
LEFT JOIN dbo.Combustivel         AS c   ON c.CombustivelId   = v.CombustivelId
LEFT JOIN dbo.Unidade             AS u   ON u.UnidadeId       = v.UnidadeId
LEFT JOIN dbo.ItemVeiculoContrato AS ivc ON ivc.ItemVeiculoId = v.ItemVeiculoId
CROSS APPLY (
  SELECT DiasCalc =
    CASE
      WHEN b.DataDevolucao IS NULL THEN 1
      WHEN b.DataEntrega  IS NOT NULL THEN DATEDIFF(DAY, b.DataEntrega,  b.DataDevolucao)
      ELSE                               DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao)
    END
) AS d

--WHERE
--    v.Status = 1
--    AND b.DataDevolucao IS NOT NULL
--    AND DATEDIFF(DAY, b.DataSolicitacao, b.DataDevolucao) > 0
GO

--
-- Create table [dbo].[ItensManutencao]
--
PRINT (N'Create table [dbo].[ItensManutencao]')
GO
CREATE TABLE dbo.ItensManutencao (
  ItemManutencaoId uniqueidentifier NOT NULL DEFAULT (newid()),
  ManutencaoId uniqueidentifier NOT NULL,
  TipoItem varchar(100) NULL,
  NumFicha varchar(50) NULL,
  DataItem datetime NULL,
  Resumo varchar(max) NULL,
  Descricao varchar(max) NULL,
  Status varchar(100) NULL,
  MotoristaId uniqueidentifier NULL,
  ViagemId uniqueidentifier NULL,
  ImagemOcorrencia varchar(500) NULL,
  CONSTRAINT PK_ItensManutencao PRIMARY KEY CLUSTERED (ItemManutencaoId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_ItensManutencao_ManutencaoId] on table [dbo].[ItensManutencao]
--
PRINT (N'Create index [IX_ItensManutencao_ManutencaoId] on table [dbo].[ItensManutencao]')
GO
CREATE INDEX IX_ItensManutencao_ManutencaoId
  ON dbo.ItensManutencao (ManutencaoId)
  INCLUDE (ItemManutencaoId, ViagemId, Descricao)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_ItensManutencao_ViagemId] on table [dbo].[ItensManutencao]
--
PRINT (N'Create index [IX_ItensManutencao_ViagemId] on table [dbo].[ItensManutencao]')
GO
CREATE INDEX IX_ItensManutencao_ViagemId
  ON dbo.ItensManutencao (ViagemId)
  INCLUDE (ItemManutencaoId, ManutencaoId, Descricao)
  WHERE ([ViagemId] IS NOT NULL)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_ItensManutencao_ManutencaoId] on table [dbo].[ItensManutencao]
--
PRINT (N'Create foreign key [FK_ItensManutencao_ManutencaoId] on table [dbo].[ItensManutencao]')
GO
ALTER TABLE dbo.ItensManutencao
  ADD CONSTRAINT FK_ItensManutencao_ManutencaoId FOREIGN KEY (ManutencaoId) REFERENCES dbo.Manutencao (ManutencaoId)
GO

--
-- Create table [dbo].[ControleAcesso]
--
PRINT (N'Create table [dbo].[ControleAcesso]')
GO
CREATE TABLE dbo.ControleAcesso (
  UsuarioId nvarchar(450) NOT NULL,
  RecursoId uniqueidentifier NOT NULL,
  Acesso bit NOT NULL DEFAULT (1),
  CONSTRAINT PK_ControleAcesso PRIMARY KEY CLUSTERED (UsuarioId, RecursoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_ControleAcesso_RecursoId] on table [dbo].[ControleAcesso]
--
PRINT (N'Create foreign key [FK_ControleAcesso_RecursoId] on table [dbo].[ControleAcesso]')
GO
ALTER TABLE dbo.ControleAcesso WITH NOCHECK
  ADD CONSTRAINT FK_ControleAcesso_RecursoId FOREIGN KEY (RecursoId) REFERENCES dbo.Recurso (RecursoId)
GO

--
-- Create foreign key [FK_ControleAcesso_UsuarioId] on table [dbo].[ControleAcesso]
--
PRINT (N'Create foreign key [FK_ControleAcesso_UsuarioId] on table [dbo].[ControleAcesso]')
GO
ALTER TABLE dbo.ControleAcesso WITH NOCHECK
  ADD CONSTRAINT FK_ControleAcesso_UsuarioId FOREIGN KEY (UsuarioId) REFERENCES dbo.AspNetUsers (Id)
GO

--
-- Add extended property [MS_Description] on table [dbo].[ControleAcesso]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[ControleAcesso]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', 'Controle de Acesso ao Sistema', 'SCHEMA', N'dbo', 'TABLE', N'ControleAcesso'
GO

--
-- Create or alter view [dbo].[ViewControleAcesso]
--
GO
PRINT (N'Create or alter view [dbo].[ViewControleAcesso]')
GO
CREATE OR ALTER VIEW dbo.ViewControleAcesso 
AS SELECT TOP 100000000
  ControleAcesso.UsuarioId
 ,Recurso.RecursoId
 ,ControleAcesso.Acesso
 ,Recurso.Nome
 ,Recurso.Descricao
 ,Recurso.Ordem
 ,AspNetUsers.NomeCompleto
 ,(ControleAcesso.UsuarioId + '|' + CONVERT(NVARCHAR(MAX), ControleAcesso.RecursoId)) AS IDS
FROM dbo.ControleAcesso
INNER JOIN dbo.AspNetUsers
  ON ControleAcesso.UsuarioId = AspNetUsers.Id
INNER JOIN dbo.Recurso
  ON ControleAcesso.RecursoId = Recurso.RecursoId
ORDER BY Recurso.Ordem
GO

--
-- Create table [dbo].[AspNetUserRoles]
--
PRINT (N'Create table [dbo].[AspNetUserRoles]')
GO
CREATE TABLE dbo.AspNetUserRoles (
  UserId nvarchar(450) NOT NULL,
  RoleId nvarchar(450) NOT NULL
)
ON [PRIMARY]
GO

--
-- Create table [dbo].[AspNetUserLogins]
--
PRINT (N'Create table [dbo].[AspNetUserLogins]')
GO
CREATE TABLE dbo.AspNetUserLogins (
  LoginProvider nvarchar(450) NOT NULL,
  ProviderKey nvarchar(450) NOT NULL,
  ProviderDisplayName nvarchar(max) NULL,
  UserId nvarchar(450) NOT NULL
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[AspNetUserClaims]
--
PRINT (N'Create table [dbo].[AspNetUserClaims]')
GO
CREATE TABLE dbo.AspNetUserClaims (
  Id int NOT NULL,
  UserId nvarchar(450) NOT NULL,
  ClaimType nvarchar(max) NULL,
  ClaimValue nvarchar(max) NULL
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[AspNetRoles]
--
PRINT (N'Create table [dbo].[AspNetRoles]')
GO
CREATE TABLE dbo.AspNetRoles (
  Id nvarchar(450) NOT NULL,
  Name nvarchar(256) NULL,
  NormalizedName nvarchar(256) NULL,
  ConcurrencyStamp nvarchar(max) NULL
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create table [dbo].[AspNetRoleClaims]
--
PRINT (N'Create table [dbo].[AspNetRoleClaims]')
GO
CREATE TABLE dbo.AspNetRoleClaims (
  Id int NOT NULL,
  RoleId nvarchar(450) NOT NULL,
  ClaimType nvarchar(max) NULL,
  ClaimValue nvarchar(max) NULL
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create type [dbo].[MotoristaKeyList]
--
PRINT (N'Create type [dbo].[MotoristaKeyList]')
GO
CREATE TYPE dbo.MotoristaKeyList AS TABLE (
  MotoristaId uniqueidentifier NOT NULL,
  PRIMARY KEY CLUSTERED (MotoristaId)
)
GO

--
-- Create table [dbo].[Motorista]
--
PRINT (N'Create table [dbo].[Motorista]')
GO
CREATE TABLE dbo.Motorista (
  MotoristaId uniqueidentifier NOT NULL DEFAULT (newid()),
  Nome varchar(100) NOT NULL CONSTRAINT DF_Motorista_Nome2 DEFAULT (''),
  Ponto varchar(50) NOT NULL CONSTRAINT DF_Motorista_Ponto2 DEFAULT (''),
  DataNascimento date NULL,
  CPF varchar(20) NULL CONSTRAINT DF_Motorista_CPF2 DEFAULT (''),
  CNH varchar(20) NULL CONSTRAINT DF_Motorista_CNH2 DEFAULT (''),
  CategoriaCNH varchar(10) NULL CONSTRAINT DF_Motorista_CategoriaCNH2 DEFAULT (''),
  DataVencimentoCNH date NULL,
  Celular01 varchar(50) NULL CONSTRAINT DF_Motorista_Celular012 DEFAULT (''),
  Celular02 varchar(50) NULL CONSTRAINT DF_Motorista_Celular022 DEFAULT (''),
  DataIngresso date NULL,
  OrigemIndicacao varchar(150) NULL,
  Foto varbinary(max) NULL DEFAULT (0xFFD8FFE000104A46494600010101006000600000FFDB0043000201010201010202020202020202030503030303030604040305070607070706070708090B0908080A0807070A0D0A0A0B0C0C0C0C07090E0F0D0C0E0B0C0C0CFFDB004301020202030303060303060C0807080C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0CFFC000110800EF00F603012200021101031101FFC4001F0000010501010101010100000000000000000102030405060708090A0BFFC400B5100002010303020403050504040000017D01020300041105122131410613516107227114328191A1082342B1C11552D1F02433627282090A161718191A25262728292A3435363738393A434445464748494A535455565758595A636465666768696A737475767778797A838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5E6E7E8E9EAF1F2F3F4F5F6F7F8F9FAFFC4001F0100030101010101010101010000000000000102030405060708090A0BFFC400B51100020102040403040705040400010277000102031104052131061241510761711322328108144291A1B1C109233352F0156272D10A162434E125F11718191A262728292A35363738393A434445464748494A535455565758595A636465666768696A737475767778797A82838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5F6F7F8F9FAFFDA000C03010002110311003F00FDFCA28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A4271400B452039A0B6280168A4DC29739A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A28A0028A29375002D2039A42E00AF1CFDA2FF006B4D0FE0CE99A8092E0CD2DA461245B4DB34F04F2711298B21981CE485F980ED8E6A2A548C23CD234A54A5525CB147ABDD7892CAC2FD2DAE2E62B79A5FF56B2B6CF33827E5CF5E013C7A571DF137F696F087C29B049755D5ED22324AB12C66544639708DF7881F2725875014F15F0AFC67FDA0FE2EFC7BB1B84F09F872E6E341BD0185878918590B691245C3A395123A32E4A82A08C9CF615F3CF8D7FE09C5F193F6814B17F1BFC5BB1D1EDADAEDA55B2D3EDE7D4E45C904112CAD18473F36E001425F38CA8AF9CC5713E0E968E6BF3FC8FA3C370C62AA24F95FE5F99FA829FB70F8224D4DD66F10E99A73D8CA63BAB29AE6333329E8CAA3E624651B0B9E18F3915CFF008C3FE0A85F0A7C0F772C1A9788ECAC5D1D22559DFF00793B3739894644CB8E7F76C4E01E0D7E72E9FF00F0476F09AEA315D6B5E39F895ACCF6D2168C8BF86CA307A745889E800E1AAF6A9FF0485F84FAFEA6B25C5DF8DF744A638646F106FF002B39CB28319DA4F7C63EE8E38AF1E5C7384D95FEE3DB8701E2E4AFA7DE7D89E3FF00F82CAFC3AD0EFAEEC747D7ECB5ABBB291433DADB4CC922144725576E4B2EFF0099494185601B7E16BD5FE177FC1493E17FC4BF045DEA916BB6F6F77A6DB2DC5EE9F9324B0025549C81CA06382C40DA012C14735F97B7BFF045AF869A4BDCCD61AE7C41B2BDB8411ADC7F6A4772C80307F97CC8F00E7BF5E4F35C37863FE0911E22F837ADEA575E09F8AF7B6EDA842F6F2C3AAE9BB9EE21906258A4923605D6452C18107208E9B453A5C6F83E6B4E76F54554F0FF001FCB78453F46BF5B1FB4FE0DFDAF7C1DE2EB7865FED186D23B82C63323821D7E6657057236B46ACF9CE30AD9E86BD3ADEF61BB85248A58E48E450EACAC08653C820F71EF5FCF7F8F7F648FDA3BE179D324D14E95E2AD1F4F8AE545AE8D7E2D260ED2075758A60A325328407E9EA49AD2F837FF00055AF8D5FB20EA5A49F1DF873C45141696D3DBCF65AC7996103C64FCBB25CF901A3DAA54AFDEC1073C57B986E22C2D67684D3F99E062F8631941DA74E4ADE5A7DFB1FD00C332DC461D183AB0C860720D3ABF35FF00649FF82F5780FC4FE19B1D0F5DF36CB5F06794E4C4609C34AD227CC1810E518E542FF0AE07CDB57EFAF865F19F45F8A1A2DA5D595C206BC89268E3DEAFE62B2090146524302A7230738CE40C1AF6A9622153E16785570D529EE8EBA8A40734B5B9CE14514500145145001451450014514500145145001451450014514500145149B86680027158FE33F1859F837467B9BA942658246A0A8695CF451B88193F5ACBF88FF156CFC0B1AC607DAEFDC8DB6C8C01C1EE4F61D2BC97C59E3ED43C5B721A6895E552442A17F7719F503FC724D7CC671C4F87C15E943DEA9DBB7A9EF65790D7C535392B43B9625FDA27C49E2AB5BBB586CEDB47F2E5DB15D310D2CD0F38768F9F2D8FF7727BF22BCFEFFE14E87A778A6FBC5434AB0FF84975B60D77A88B6DD73380000A09C903000C671C02735A773A3195226DFF00BC84979910908C78E3F3E7D6AB98AF66805D5D4E12363B826CCFD001D49FD2BF31CC33BC6E31B555BB744B447E8980CA70D85B4A8DBF529AF86C456AF3FDB3CB79C87CECE483D320F7AA7AA4F6D1C0B17DA1DB68E72E7713EA4F6FA54B6D13EBFA817984A61886C42DF20240E723D7FC6926B38756790348B047191E5F5CE38FA64D7832D763E921EEB4E6EF631F4DD46709B8219999F6AE530001F5A6EB334E6D77B1444279D89F37E55ABADF88B4AD02D80D42E21B4B44C12F249B73EE49E959371AEE99E2A8A49346BFB4BE09F3BF9328700763C1AA707CBABD8F4694DB9A938D97730A4F0BCBBCCFB57ECFBB92CA18FE02AFC36D6490A81B25E70323193F4354AC66B887CC525F8E1413EFEDEF5971C73C9A9B09328A1F3B7AF3EBF4AE35CD1E9AB3DB509D4BF34B635357B6B3424790F1BE325E36C71F4AE635FD12CB5EB7920BC11EA16932F96F1DC2093703C60AB7047D6B7356D31A7833E7AAFF00B321E0FF005ACEB3D123863915418DD9B04939073DF39C56536DCB5475E1D414757A9F38FC51FF0082627C30F1ECB7377A2E983C21ABCE1945DE8E7C8405810D98798C1218F2AAAC339073835E317307ED13FB03EB5A75F78677EBFE1CB29537CFA64AC45AC31B215636AC090E761CBA6EC067C01BDABEE5BDB5974E94AC61FE618272319FA1ACBD46EE58ADFC99809623FC4570457AF97F136370B249CAF1ECFF00CCF3F30E0FCBF31D5C545BEAB4FBD6CCEAFF00670FF8381BC1BF183C19A77F6B68C34AF12DCDC4364F6C93130798F2AC65C1C12B1AEE19DDC8EFD6BF422CB59B5D47CB305C432F98A5936383B8038247B03C57E22FED67FB0D691F16ED5FC49E1BC68FE32814C8B2443641A97FB13018CE703E71871C72718AF3DF82FF00F0574F89BFB21F89341F09F8FEE352B07B2B95BA1F6B855CBC2C64793CA6C92518328601B194E7E6095FAC643C554B1D1E5BFBDDBFADCFC4B89F81713964B9E2AF0FE65B7CFB33FA0656DC296BC97F630FDA12D7F68DF80DA1F8845D5A3DF5EDB896E2088B66DF71255486553903009C6090704E2BD6ABEC632525747C0CA2E2F9585145154485145140051451400514514005145140051452668011E4118C9381EB5E5DF14FE3E5AF8763B98E0D46CB4DB7B60567D42EE648A25F94E76962012304FE150FED13F18EDBC1DE1CBEDD3882CACA3692F2656E485EB18FAF43F5C7AD7E0C7FC151BF6DAD63E33F8ED2C6D276834CB04731C1BFE4DCDB86E23BB638E9C0FA9AF85CF3881CEB7D4B08F5EAD7E47E85C2FC23F5AA2F1D89D20B63F66F43BDB1F1ADB43ACE8DAC58EB1A64EF2336A314E27FB4C81B6B7CC0E38391EBF4ADB9615D16D9EE1E70004C818FBB8FA9AF88BFE086DFDAF1FF00C13AB4BD4354B8856DF57F126A5756A0BE08B749562E067FBF0C9F98AFB3D6E2D352D1CCEF1E639DCAB6481BF1CE7E83A57E7F5A9A8D49536F547D1CA9B495BE1BD8C24F1208A451014904B2B6597A13DF1DBA0AD28FC4A2E6DA479606CC6DB519970318FE11F9F359C0DAEA1AA19A28DFC8B78FCB8D718563C6481FA7E758825BAD77C4840056DA36C671B801CFDDC7EB5E74653B5D6AFF0003D78E1A9D45B5ACAECEBDEFA216C8B02FEE47CEC5980CE7B9AE17E36FC5FB1F873E09BED6F53B816B6B628CE155C0DC3FAE49ADAF13EB163E16D255DA15966DD82A41E79C126BF2F3FE0ADDFB5A492D99F0F35C37CA1A5B85898E2207FD5A9C77FE557CAE55634A3BB3D2CA32B8CE32C554D210EFD4F97FFE0A13FF000534F127C60F185D5A41A8DCD9E8F6D2958EDA27C2CB8FE26C7535C5FEC1DFF051FF0013FC08F8CB67AA43AA4EF6D24889736B2B1305C440F2ACBE9F857C8FF143C5CDA9EA92BE5B0CD9E4F3F5AC2F086B92E97ADC322B38DCDC1AFD2F0592518D0B5B56B73E5331E26AB2C568FDDBEDD2C7F53F77E288FE27F84B46F1369C5ADA0D66259C2237080F51F40735674FD4AD6CAEC07264F9769EA49E73CD793FFC13B7C59FF09E7EC15F0EAFA772EE6D0A127A80AC47F8FE75E8B37878AEB3E65A7CFC9241278AFCAF1D4E54F11251EE7E9980942AE1D45E8BA7E8696B53DAEBCE422C91B43CA1008DC46314D92EECEF3405B7D8AD2FF08039FA7B62A95E6B1368F2FEFA190165DAA71903DEA3D3ADE5D56ED2F20658EE3A3237438AE573BCAD2DD9DAA85A0AFB2DB52878AC3241972E1970A73C607AE6B3A4B191F4FDEB224C9B0B72792315D06ADADDD4774DF68B42F160AB6CF9B3EF8AC4BB36A58B40444244E49EDE9C572558FBCD1EA61A73E5517FE667792F02AA48A446E3721CF4F6E3A7B1AE13F680FD9C3C3DF1FF00C17FD9FAFD8C1702D9BCEB1BD11235CE9B3E30248C90707F43F8576EDE228AF74A65C60F287EBED5CB6A5F18346F08DE7D8AEB508E396642C11837418EA7181D6AB0DED14D3A2DDD763B3134613A3286252E57A3BEC784FEC27FB6078AFF00E09A5F1FF55F0C78BAC750D7B457B40DA70B467788C225204D1073F2615E50C85C8DCDC64906BF70BE19FC53D27E2B787AD752D26759A0BAB68AE800C18A2C80E031048C82AC08CF5535F859FB6CC7E19F1F69B6B75737A74AD47C38C2E6D6ED27314BBC901E239C0DACA470C71903A3609F63FF00823B7ED8579F0E7E377FC21D7DAA94D2F5DB23069897930585AE5596411EF271924C993C9D880292D85AFDCB86B35AF5B0F1FAC2B4BA9FCC7C6D91E1F0B8D9FD565CD1DD5BF23F657345321904A9B958303C820E41A7D7D91F9F8514514005145140051451400514514009B8572FF157C769E0AF0D48EBF35DCEA56141D7DCFE19AD8D77C4763E19B16B9BFBA86D604FBCF23600E09FE86BC33E38FC48B7B7D1752F10B48AF1C10B7D911860051F749CF424E4FE5E95F3BC499A2C1E125CAED27FD367B9906592C662E30B5D5D7CFC8F8BBFE0A5DFB4E3E97E096F0EDA3492B4D96BB31124EEFAF5E01FD49AFC60FDA2F56B99FC512493B6FDB11762A7A0EBCFBE2BED1FDABFE206A1E23F13DFEA17132B2B33F2D9E067939E8739AF8DB47F00EA3FB457ED21E1FF000959234875DD6ED34A91979D904B3470B3FD07983F3AFCBB247294DD599FD1D9DE129603070C253D96FE6FA9FBA5FB08FC39B7F855FB12FC24F0C496EEAD1F862CE4997382D3DC27DAA66C0E33BE63CD7BDC30C1636205DFDF00B204FB910F7F5AE5756B6369E20FB1D947E543A3411471851B844A78550071F7540ABDE2BBC9757B2B530398239087753C9718C607A0CD715577AB39B3E3BD873AA70BD93D49759B39A6856512F97032858A311F1CF4E476FAD41A6DDC6D9B5B7909F2F891C80367AD45712CF7764F6F248FB2DD5488D00F9BD89C741C564FEFB64BD3CE99FCD6CFCBC0E958A52525CA7652A0DC395BD8E13F692F19DB780BC3535ECB34B23AC8A8A09CF0580CF5AFC32FDBBFE25CBE2EF18EB571BCEF9EEA577639C1EC17E83B57EA77FC14B7C6F2693E0F8E32EF1BCB3A7C8BD8673D735F8BFF00B53EB6CF777AA8CC55A76C64F2497E79AEEE1EA0EAE31CFB1F439EBFA9E4D1A77D65A9E05A8C4750BD95DC65223CFA13D854DA6E9F35ECC8CF90A9CA7006D1D71572DEDFF7490951973E638CF7E82BA4D074916B64D2CABFBB2A770C8F9060F4AFD63DA4631B23F1395294A7CCCFDEEFF825189ECFFE09B1F0BD0BAAC971652DC02C3908669001F5E3F5AF7AD36DEE2E6EC476BB8BAAF393F8D713FB1FF822DFE197EC57F08341DA5A6B6F0969F2371C8796112B74F773D6BD574FD5E2D2418EDB6B3ED1BB3D01EF5F8C66094B192E6EACFDB701370C1C792377632AF61BDB6E2E937E0718C715833EA77105D092DD3CB18272C301B15D4EB3ACABEE3348BBE51B4283D3DF1590D3417574B16E1BA31923B1FAD7975E9A52B5CF570B37CBEFC48EC75C9EE641E65BAA71867DDBBF4C566EADA6E5DE446183F786DFBBEF5A5A8DD456C8445D40E401D2B2EE6433C3D71B87237573B56D1EA77E1B47CD15632678E196CC9F2C348A486DA3F957CCFF00F0505F0CCCBF0764D4FCCB7823864563348DE59B603F88B0E80FA9CF6FA8FA7F5146B5B2F353E6E0EEC71835E49FB4AC136B3F0A753716F1CFE4AEF6591C46076C92411C7F3C1C8ADB2F9F26329B5DD1D58DA7EDF015A1D1C5FE47C19E2FF89D2EAD6DA4AC9A7DDDCDADCCB0BA25C5A16921B07B7DD3E5981259024841E76E58F1F2565E8BE35D723D0A0D7F4E16BA6DEDADF25B41E5CAAC21644461F669032E70007DEA30372F4E408F4686F343F1B699A9E990E8103D8AB4713FDAE6316F7769646D872260D864E0E1B2410183679EB8BDD5A2D6A4B896586659248E1BC86D616F22DDCB1F2F6290AA248F214613682CC0B64E2BF73A765EF23F96AAB973B8C9DEC7F46BFF0004C1FDA6B4EFDA6BF656D0757B67C5DC3024379165BE4954147E1B91B9E377C7FB55F46039AFC18FF823FF00EDB4BFB367ED03169FAC3A49A37886D9ED112D836C7B8466512602E43C85946081828D92BC93FBBBA3EA6BABE9B05CAA941346B26D3D5723383EE3A1AF7F075B9E167BA3E6B1941D39DFA32D514515D67205145140051451400536462A848058E0E00C734EAA7ADEA8BA469535C1595C4485B6C4BB9CE013C0E9D01A00F8F3E327ED13AD7C7AFDA1EC7C0DA4E9D77A5F87B458DB53D6AEDA76596E912528902E0EC31BC89F3942FF00229071B883CB7ED85E28FECBF80D7B13CA15A771130C72401B88FE5D2BA8F0078C2CFC7FE23F14F8BACF434D1D7C4BAB35AC4258956E678EDC15919C827ACA5C0E9D09C0CE4F8E7FC14BEF1B4EF869A75AF9B1C0ED13C926E6C1DC481F8F02BF1BE2BC4CAAD6A8FB69F79FB7787F82846BD04D6EF9BEE4D9F971F1C7C489ABDCDC12675B6576531B1E148EA33D0FE15ED9FF0006E37C1EB0F893FB4D7C4AF1D6A96A9369DE15D22182DA59570915DCF7426523238655B407F1AF98BE3F6A2FA369777BA50CB6E851594FDD3D00C7AF3F4E2BF50FFE0DCDF83DFF000817FC13E6EBC52D0990F8FB5FBDBEDC172C62B7C5A46BF4CC521FF815639453B513E9B8D31977CADDAECFAEFC2BF68B9F12BDE3279DE619199CA615D70AAAB8F6EDF4A725BC7AAEB51CD2C6D15AF97B184432A854E0FD012456E4F606CECA1F319647110489BEEAE7764A9E339C76FAD2FD99F42F09C2F1A2978E275950FCBB972481ED8C6335BCF08942CD9F25F5B4E49C16AF4470BE29BFBAD1AE1675477688E369201C1EBF8114E835E3AFC37174B6E079111662570231C0FC6A4BB79E5804D382D6536DFB3394DDB4FF001038FA9E3E959D6F6771A75DCA403B241F7F18C28EC474208AF29A9C365A1F45494254D5D2E65D4FCF9FF82A7F88AE4DA5B4AF2308269731A11D0823FA57E417C75B97D4352604E7328007A73CD7EBA7FC15ADD6FEC2C404DAFE7B6D3938C07C1FE79AFC82F8891FDB35E99403B8484919F435E9F08C6D76F7B9DFC6F52D87A71DB4460693A6869B3B47071C0E7038AF43F01F817FE130F1368FA3C304AF36B777058C43B334B2AC63DBF88D71DA2C07F77C677FCD81CE726BEB7FF825D7C1B97E2C7ED95F0F2C65B5792C6D7526D5AE9B19548ECE279FE6FF0081A47F89AFB5C44B929CE7D933F36C25253AB18BEE7ED1DDA2F868416D6EAA2DACA18ED1370DBB16340800F4031E958BAEF899AC114326DDC73BE339C0EB935435BD46EE7D4DE42C678E491A4DAA3A024F045526D59A5BB0CC768070171C0FC2BF0FAD5B9A6E4DEE7F4160B2F50845B57D0D48AFD6F211264C8EE3099EBEF4B75A4CF716A4C6CD01519CE7249AA97134F2CB14AACCB120F94E06DCE2B6ADF5248F4B092E4FFBA3903BF3D6A7E27FBC35AAA50B4A08AFA3DD17D39B767793F336DDC49AA124335E2B889F2EB9C900707B55CD4354B678C4F0DC30800E513D3EB5534AD61049398D0157FE1E85876A9766ADD10E9A96B38C49ECED5A0B511CAEB238E581FBABEFF5AE77E21E9D6E6D18120EF428AAA0E5890456BDDEB2D21589BE55C617E520E29BE20B68AE74A666C328E8DD08A86D387BAF53A68734669CBA9F995FB497818FC32F8FA23962B9BEB2D488B88E1B70DF20122C843A81B405750EA546438EE188AF32D3EC1F4E7D5C8B3FB7C5E208AF6FEDE3B8B7CC32A6E16FE76573F33C9B5429624B1E842D7D3DFF000522F0DD9F8C1348B191AC2DEF8892457BB67845C90322DDA54C326F38008E738AF9C06ACDA679DA4C2F75A9D90BE904B3DD4DE4DAE9EA4EC015D0E517731D8DF29C82C028271FB2F0F62255F2F8559EFB1FCEBC6781A784CE2AC29EDBFDE4775A23E8761A36BA974E354B69BED7677D07C85BCB954C980BC46C8A30413B8E09C67A7F4B5FB0AF89DBC6BFB2C783F5737115DFF6858AC9E626D2C0AFC85246500348A50866C0C91CF39AFE67746BA9218A495A7B6FEDB9E4B59D2D8CE1D62DB088412CDCCF2326C2EA0E46E1BB3BABF70BFE082DFB48DFFC4DFD9F2EBC35A8097CBD065CD8B48AA8620555EE20033B9B64CE4E4827F79D4F15F4D80ACA35791F53E2332A2E54F9D743EFDA2937734B5EE1E00514514005145140057CF5FB7DFED496BFB3D7C16D626124516B5756B245616D3158DA7765233BD8845419CB3161800E3915F42D7CD9FF00051BF85DE08F1F7C1CFB1F89AEAD74B175751451BA4BE5CF79BDD15A0550407F33210862400C4E2B9B16DC69392E87560E2A555268F3CFD9F7C173F873E05F84ADAE4C1F6CD334F80DD8B740B135CCEC5E4DB8278DCCFCE483D726BE75FF0082B3092F35EB269FCCFB2DBD82BC71452843236E6393DF009FD2BE9FB6D6C687A99B38B0B0492AFDDE83EF0518F4E2BE5BFF0082BFE897975E1AD275085479D7164226901204615D830CF4CE08FCABF10C74D55A739BEE9FE27F4270AD1787CC29296DCB2B7DDFF019F8FDFB42F882E2F635B1B7873757B71B506EDFB9FA20FC58815FD1C7ECB3F0562FD9A7F676F02781EC999AD3C23A0DB697384F9564B958D5A59303A9690C84FBB1AFC3EFF82717ECDE3F6A9FF829AF807C337F6BFDA1A1F848BF89B580A8CC9E45AB6F895FD9E710273D77115FD03DD68B77671092426169A463142A4120B73BDCFD7B671835F5181C3F2D04D23E738A318AA637D9C99475FD5AD23B8B48258B6C92C89739FBAA3A64B7A7F9159FE22D4029FB5CDBFC87CC214F5979CE71EC71526A96726BDE2C96DA6316C991232D8EDD78F4C9E734CF1BADBD9DA3AACE24952648A304E563180491EFC13F856F5ACE32BF43C8A118C6508A5ABFD4E6EFF464B9D3C43332C28B2348154711FF00B4DE9599ABC96DA8DB2C04BA315FDDB8076A01C7EBFE34DF135F5D6B52CB1584EEB0B10AECEA1B2BC13C568E8F6F6765A136264DE8BB420E4903D735E24A9464D9F4F152A708CE4F5ECBA1F9E7FF000553F024FA8784A2962FF973BBE582E06D62076F702BF17BE203FD83C5378AEA37A33027DFFF00D75FD14FED55F04EF7E297C3FB9864758ADE7B9578140E557786E7EA41FD3D6BF9FDFDB47E1D5EFC17F8DDAB691A95B4B6F289F2A2418DCA5B1B87A8CD1C313E4C4CA84BAEABCCF5F8C1AAD9653AF1D79746701A14CB2BA6F246CC0FC2BF587FE0DF1F8797371AC7C41F1CDD89A7D2748B08B46B77745DA67B86F31C83D4958D0027D24F7AFC98F0EDB5C788B5EB2D3AD209AEAFEEA616F6F6B6E85E5B891982471AA8EACC48007539AFE877F623F8003F640FD917C29F0FF559117C552A1D57C42B137C9F6B9467CBC8EA2350883FDC27BD7D2711626387C2B8B7ACB447C4F0E61A58AC5454765AB3ACD55A3649F6C80E6424311DBD2B0356B07B19B79DA3901553919F7C56C6B90A5D5E490617EC6832C54E082474AC1D4AEFFB26E57CA7CA953CBB1F5AFC72A47DD6DFFC31FD098252B251DCD1B5BFC59299158B638C630B8FAD58B4BC8357B73E5CC639173F291F7EB0A3B9FED68DD37379920DAA7B0A6CCB25BDDF959D8FD5580C8AC94925666FF564DB4DD997352D7E6B49BC8F28B4C0FC841DB8FAF4CD1A27DAA0B79A599C4D7127CDB481F27E354AE2010DDC5348E27206DE491CF6AD58ADE482D7CD392AE382B8E94352B5FA1A4D4230B24B5296B7ADC92C00ECFDE02372923B7A557975F92E13ECD2C6E8E5490A3B8FAD57D574E60D2E1DF7E7763BE6ACE8BA348119E77DFC10AB8C56519B72E5E87472D2842E7CA7FF000530F065CEA7F0FAD3528E11235903F310A76B01B829F4CE383D01C1AF9BFE2DF8074ED234ABD8ACA3B781AD341B6BFB69029586ED4EF5F337A9C8CDBCA19406C60E78C367EDFF00DB5ECA5D63E086BB63B2159A58B00C80954078E71CE075E3D2BE2AD2F5A4F14F86F4CD0752B7BF644B596EF4DB9797718144AD0490C6AC0AEC21891B9BEEB9C0E2BF52E10AEE581707F65B3F0AF11B0508E670AB6FE225E9D8E6F5ED47FE121B1B5D66249984622DB0B5D42896EF1C406F08AB9F9C0DA7AB305DFF007B81FA25FF000428F10BCBF1FA67D26DA1B3B8B9D3648AE45E82590472C6ECD0EEE504B193B8E0905578CE6BE09FED1D3BE1699A65D32F3FB3A1BBB732205C3850A1245284670C8C0151F206C83838AFB6BFE09CDA16A769FB51F85BC3FA56A51F9F3EFB55BDB646DF6D66D0BCEF8453932EC4541BBE51E665B2057D1AC4726269249D9B3E23EA0A583AFCCF58AFD4FDB785BCC50D8C6477A7D436831120DA576A0182738A9ABEDD1F9C0514514C028A28A00AFA8BCA901F2B8E0E580CB2FA60773F5AFCF2FF0082C178EEC3C00DA16A3A96A9A78F10C37F6D7FA458CAE0DCA2DB90EE3CC1C246EC0650292EDCE405AFB73E3CF8E17C09E09BDBD5BB6B2BA86D9DEDDDA2DD1BBF00024B2A8E481CB0FBDD6BF087F6F6F1AEBDE3EF1F26B32DA9D4753BCBE7564BCBD81DBCB8D84A41442338DB2AA062C300939C035E4E655172724BA9EBE554FF0079CFD8FA83F641FDB7E6FDA13E2C5CF87F516B379E28BED76E6D50A83B090548273D33C9EB8AFA87E397C18D2BF69AF836BE1DD5AEE4D3E24BC711DDA2E7CB2791CF6F51DABF187E1578F5FF00659F8CFA7EABA1DE1D4B5A862FED3D4919361B6819C02B26402198C98084E5463E5CE4D7EBC7C07FDA134DF8CFE158754D32458D35148E52B21CB40C57A30E8719E7F0F5AFCD71981A746A72DBDD99FB0E031957194A35A0F96A53FF0086BFDC68FEC3BFB13F823F621D3FC4CBE1FD4353D575DF155CC12EADAA5D2279D74B18290C51AA01E5C2A59DB6F3966624F4C7B9F89F5D8E2892E1DE79C9908532B79614632C46DEB8C0183E9F5AF36D7BC484F892CD612EF64C9E65D4E84AED73941D3D49AF08FDA3BFE0A13A7783ECEDED3C26D6D7A2D55A4D43CC6CB98002309BBEFB1C7400F38F5AF530F525ECFD947A1E5E2F01EFAC4D796FABDBFAFF00807D3FA3EB5A778975DB8BE5FF004C5B14DF1846600B1270001D78CF5E0560EBBE20D22FFC4446C6FBA1E38D646DAAB8EA7DF07BD7E75693FF00054AD6FC31E29FB49B816DA2CD0490EA3A6790B03DB4CA32B22B11FEA76E0E41C67208054E76FE35FF00C150F56D13E1BC777E1DB5FECC8268C2ACD7015EE2EA503FD5056CED6CE0631D3D0B2D1570988A915151D7A9A52C5E069CA5579DD96895CFB8F46BCD36FB54B949AE04D04926E508C41FA641AD5BE5D2DD0796AB6BE4E461642011DF39EBFCEBE1BFD9E7F6F487C64F696F75A74B0EB5232C173F2AC6A66E0B91DB033D8771935F4B9F146A3A86A521920B47F9088C1941C630304F3DFF00957875633A0BD9D58EA7D5D1C1D3C5A55F0F52F1B77FD0E93C55AC49A85A4C20BC85103A80506E6C7A63F01F957CDDFB45FF00C132FE167ED89A5DC9F1BE9625BB89B65B6A56D3B5B5D41CF6907BF6208ED5EC965E31D32CF4B78EEAC98DC3487CF65076993A9031D8638FCFAD727E3AF101D5AD6CC5B1920FDF18B2CC563C13BB95FF000F6AF16B62146A2A90934D6DAB47D0E132C9D483C2B5683DEE93BFC8F2BFD9E7FE0975F02BFE09F1E2F4F14691A75EEBDE2C8D8BD9EA1AB5F7DBA5B6638FF5518558E327272FB7760601E6BD2BE2478B9F55F12BEABE52F9970A03846EAC4019EB9FE95A1A7CF0B2B4B341F244864323BEE690F002819CFF00FAEBCB3E29F8820F0C5C8D52FEF20D2AD8A34AB148C173805B2075391CE00F7AE7C7E2F118CF764DBD74EA7A79365183CBD4A4D5AC9DDEC8BDF10FE2945A6581CAC891283E611F2951C8EA7D7B7BE2BC1FC5BFB464FAFF0088A4B0D1E69B315CFD9634DA4BCAD83B70C7E5085B6EE76E150331E833C4FC7EFDA213C6569A869F0EBA34FB3804B3D94D7319306A2A140996218DCA307AB0C37CD8218103C6AE3C65A3EACD6905A5E457FA5087CB8668035959C8CEA049B2378D4A8DD88C16F9CEC27E6079FA5CB786A2A9A9E2136D9F159EF1C54757D86026A30EE7AE27ED43E22D2FC49AEE9F73E23D27EDBA7BE3EC3672BDCBC7128C4AC4C6AE0B44CEB9019771563F2A839F5BF875FB55C7E24D173AA6E8A182DC4FE7F9996908CF1C76C82063A9071C60D7C8FA2F84EC6F7C7767A7DEC8D6363788863BA9267962B7C1675D927DCC80A498C7CDC0C8C9C1DFF14EBFA4E816C8C2EECED098E4CADD9616CF204220791973B2269193FDD217D6BA31F92E1AACA34A30B33CFC9789F1F878CF1156AFB45D9BDFEF3EBFF097ED39A7DEEA6F6DAA412598F31228D8BA9F28BB3040E339072ADF97E27D3FFB5C5E69AAF1CB85E4643715F9991EA034FD6FCED4DF4BD3D350D0F31C725F029A5DDB4896ECCE53276E1199304B1DC320A8AF7AFD9A3E296A92F886D6D74E9EEE4D1EEDD6058EF41F3A58D4E4CB8276AEFDC08030402B919CE3C8CE38623463EDA93B25D0FA5E19E3B962EAAA38B8DDB7BAE9F23EA2D22F2EA3D567324BBAD8B6F04F5CF19FE55D4E97761DC8DF9F419AE15F52FB74CB6D07FAA8DBCB95FA156F4C1E793C55FD32E8C1706489DA6F2F865CF047B1E991FD6BE1A099FAAD6853A91BA657F8E9E128FC4DE1DB81BC879632800C1049E3041E3BF7F4AF897C4FE0CB5F0278DF448A1901B683CCC4601DAA5A5C190EECB22863271C8E78E0E07DCDAADC49AED83BEC021183F7B818E7AD7CAFF1075FF0B4BE2157B509693477EA44AF219228E3DDBCCAC09E198646D18DC71C6057D8F0DD7AB49CB95371EB63F3BE37C061ABD0A7ED649496D7384D53E1DE8D77A2F862DA7B6D4B4DBEB893CC9750B89F79C34C048648CEE0EA47E5C1ED91F48FEC1F75A6FC25FDB0FE1F6AE6E274B38B5382C649AFE493F7523C2F6E64271908EA8BC9EFD700923CA3C79F16B4C7D02CD2F2EE0B9D334F225BD92C2221DA455244484E58A7F7867835BBF087C53A9E9FFB43FC3EB7D1343766B6D774E8DAC220B34AE54CA5E30324162BBF1904361477AFACC155AB3AD0938B5AFEA7E799BD2C2D1C2D6A49A7EEAB35BDEDE47EFF00A75FC29F589E00F14D978C3C2F697B632C7244F126E087FD53145628C3AAB0C8C83823B8ADBAFD42E7E15B051451400514507A50079F7ED0DA8E8EDE04BEB2D596CDE29EDD8FFA4C4D2A4782087D83EF1040207192A32475AFE7B7E3B7ED3BE1EF85BFB48AD8E9718D3FC3D6972E90A5C45E5B5AE015665978F90E07983A1CB6D038AFE8AFE22FC3A8FC7BA6BDBCF717114124652548563DD22E412A1CA965CF4382320D7F3F7FF05C5FD8B27F851F15357D6AE7EC72699E24B97B7F9C8B7922648D0B22851BA44FDE28042807078DA067CDC753E6DD1E9E02A72EDB9C4784BF6629244D52F654FB45EDC286BD8C3AF9840DAE1DCBB1DAC739DCCD851B80E4D5FF0085FF00B4478C3F67EBCB0B7D2350B316C5D84569395FB3C3291865924DC7CE3C8FB8A39520608C577FFB33EA507C67D23E1F785AEB504B3B7F8ADA0C16B6172F324024D4E18CA6C2E083B8CD0040AC76162A304E2BDC7E2AFF00C114B5DF82A3FE1294BE8B5FBBB6B09AFAE923668E1D2E34E7CC5676F9E4404101B73392E7AE01F9EA3416229FEF15EDF99F5D88C4D4C1564A94B96EAEBCEE708FFF00050EF11787BE1D786965D667BDD46EE268D83DAAC26EC82C5A555272B1A8030F8C0FBB9DC0D78978EBE2DA78DFC3F06AD286BABE91CACC66B975124723CC1536B95D9BCC2E594AEDFB876E4B653E237ECCBF12F4886F357F15DA6A36890C72E9F318523B7B881FC840D0BB203B5C208F0B196405D82F28C079A787BC0B731EB76765FDAD7AD696D2C6805DDA98A3937EDDD10DFB5BAA9DABC0DAC7B935AD1C2D2A2F4566CC7139962B151F7DDD22C7C45D4F47F0EF8E25D0AD2779BC412DC32DCDBAA2A851212BBBCCCB048DD2328102E4A20002024D5BBABA4D43C092DDDE5DDDFF006CDA68F68963A7E9F6C1AF2CECEF2EA58A7BE6799938DEAABE603B984BBF05768AA5A978321F0C598D422D3A6BD974B2A88FA9C6A3ED1E5F9A9FBC0DB5891BE28F2EE400CC01C922B998EC7C417D6DAB6ADAC5C7DAF5CF14DE7DB2F269A53998C2E6436C8EBF2AB968D155776D558DB00EE15D3789E6FBEB4B1EA1F07E287528ED64D0D2F348D2ED25922B996EE66371149B6342E590672375B4431FC66438E09ADFF09FED6BE27D3FC0FA4EBF26B3A8C7A7CD7D35835B6F320CC6DB140007618249200DC3825B23C8AD74AD47C2861B2B71BF489B74535D1DC55A0130BE863CE482769F9DCE0B188A90326B43E22F84E4B9F03787E1763FD97A0CF756F74CC821794CF2F99E618CE49332C9247E67213686232EA2B8EA616954D248F628E6189C3461EC9B47D6137FC149750F0CFC38B7BE6D1C5FC4974C8F752C8A2461D063767E5C14C7196C9206D5245BD57F6DAFF849AD639E0B48BFB496E88B7D3CB73267257763A0006E3923D7A0CD7C7F7BE0FBCF887ACF843C3F231961D6219F5ABE9121212FE7788618BE18AA442310AC7B720C639EC353C1DADDAC9F14D22B3BF926B881E4BE5D49124F2A6990A82B1A00C7CA50595E57E1C938185E7C3C46418693565A23EB307C6B98528B77D5EDA1F4E4DFB6A59CBF0E63D66196E1EE241261262A23900214B0C1E465801C639EB8AF0AFDA17E31EB7A9F88BC63A56AB3B5EAC308B217CEA008A406274840EDE6C60907A32BB63A1AE76FBE156ABE0BD546913DBCFF00D9C935D269F1005E49A0DC244640389181DBB42673851B4834B6DE01F14F88E2D77EDB62CFAC788AC2D3ED221B47DB24B0CA1ADEE5237242CC550865C6DF9D9801F329D3019561E849C97F999677C458EC728C2A3E9AAE9F338AB9D38EABA6436F3C364BAA5AD9AFDA99F5195D44A5B16E64831B32D191B933CA1195DC2B4757B0BED12CA4D2FC3BA6E91AA6873CBF649358D6AC648E2B0B95DACE628B77EF542C8A633B7707E70A3207B741FB2B5EEA5E3886E34AD0F55B9BF3E45B5D5C04CA49E5204494B1C06B82B957900C1EA39635ED2FFF0004EFF88DE3EBAB5B5FEC5D2742D261F921B6B897CF48C3B29C98D460B36C40C49C903078E2BD7E7C449DA9536D7A1F3B1C161D53E6AF56316FCCF923C07F0F6E7C4C678ADF50D42EA2823B76375079CF0DCDE217494342D8486D50011A2A664DC0B13805475D3FC247B0D32E0CB6D616D7D205315ECF7725B14CC615A39515B63C7D71D1832AB6EE063EF7F837FF00048CD5F4BB511EBDE209EDAD0A24CF6BA340B6A18761B8EE238F4C63B0AF63F0CFFC13DBE1BF8574669A1F0DC5A85DB312D3DFEEBB9481D397271D3B62B279563EAD4F692B412F9B3A29E6B92E1287B25CD565F72B9F8D9A97C35D3EC6F66FEDABD59EE2E239A196EA091A4499A42CC9B8AE721493F7586558824E05761F0F59B4C54598DBE966CADC5C5C1FB5790648B7190322B60ECC65147CCCC0F000E6BEDBFF0082AB687E13FD9EFF0064BD7B57BDB7B5D296CAC261024482166948C468A3FBCCD8007D7DEBF34BF61CD5AE7E2C7ECDB7971E24D42596EBC3DB638EE64883CC8876A8E40DCC405039249C0CD4E6583F6547F78F993D0DF22C547138B4F0D0E46937BDF63DAEDFF69CD7B5BF12343A2DE5B0B296D96578AEA6F27CA9CB7CE924878895B076C8DFBB0C8159973CFB47C27F8FB1F896C6E9F51D4C4D1594881C3C4609ADB7E766F1928558AB60AB9EC0E0D7C66FAAC5F123C75636774E3C1BE22B695AE6C750D3A302CE59252ED3ACCBB880240242ACADE5E58E4287C26D7C349F52F1478ACD88630691696727F6898360851A549B6A9501049955F40373A0EAB93E66278730B5296D6F33D6CBB8E331C3E2B9B9B9A37F85EC7E8078F7C7DA78F849757F6CF14F17D98C8764AA8814A927E7C803A1E4F18AF8ABC71713789BC19143149FDAD1EB5AA497570208B6B471189B6AC7BC6F651C125BA818C004553BBF8AF736BE15F136836B28D412D657927B3690112C6BF3C926EC00553EE94E06D555190403C778EFC5F77632E89A75947259DE5F3DC5CA29949611BA0545918632E7A6D0383C573651944F08A5677BBFC0EBE25E25A79854846A2B28A77F537EEA4FF84BE0F223786FA2D9F635FB35C2B3DB3103619D490CA0E554BE39C8E735EA9FB01F8F957F6F5F076BD7163FDAD12F89A38E29A26D86CE740E76C8157728C31DB90771EBCD783698267F0E5DDECB18FF008A7A57B1B536AC8D7B7B63F2C50CC5BB0126E0CC416DA00E4E08FA87FE08B3A25DD8FED97E1E58B46B4D4AD750BD7B9DF2C685ED7727C92FCEC772A3E73CEEC12572C307E9E8D2B4E3DCFCEB135DFB3693DCFDECF03783ACFC1F6573F648BCA6D4EE5EFEE40006E9A40379E3E82B72A2B499A6811993612A0953FC27D2A5AFAB8AD0F8F77BEA14514558828A28A002BF1EBFE0E54F0B58EAB6DA0B086F25D90B5C5ECB6A079D96223545918E76F4DCA9C92EB9ED8FD85AF8E7FE0AE7E1DD3FC51F0456CED2C5EE75EB65786C0C502BF94CEB8E4B0F97601B830E5481D33918625374DD8E8C3492A8AE7E0F780B465F177EC553DB69D713DBDF7C32F14CD04B1C4E37D85B5E2ADD44C1971B4ACA971F7402AC08072335FAEFFF00047AFF0082C7E85FB66784ACBE107C5EBDB28BE275BC06D6D2EEE18476FE3289571B90F18BADBF7E31F7F05D38DCA9F929FB2078823F097ED17E28F86FAAC4D1699F123449B46D3A2DBB4AEAB196B8B303D725658BAE0998019CD789FC5DF095DF8475A9ECA759E09ECA7CC2EA5A2923756E08230559594608E41039AF91A18A785C5CE1D1EA97F5E67E8988C2D3CC32CA551FC51F76FDADB7E163FAE4F0E7C2DD03C3312259E9F027952CB32E46E65795D9DDB279C96663C9FE42B93F8A3FB23FC3EF8B53432EB7E13D1AFA68A613094C0A926E0081965C161C9F94E47B57E14FFC13EBFE0E76F8A1FB2FDB5BF863E33585D7C58F09DA811C5AAACAB1788ECA3040C348D88EEC019FF59B243DE46AFD82FD967FE0B29FB367ED7FE1EB7BCF0BFC55F0CD85F4EC236D1F5FBA4D2354864254796609CA973965198F7A92C304E6BEAE954A55A3A7DC7C156C3E2284BAFAA2A7C5BFF82437C1CF88F0CB2C1E185D2AE662ADBAD6E25409B4EFF957760127BE38CE792057CF3AFF00FC10E3C19AE59DADA47AB6B76D70F0CF7CD2DC386856ED61550BE5E0854196524F3C0E497C8FD308E649E157560C8C32ACA73907D291ED629C7CE8B2718F986720FF00914DE128BFB2898E63898FDB7F33F32E6FF8216E97AAE8EF8F10EA502DFD9179AD6582268CCAC776D2001C659F383D188F4C731F127FE0897043E0CD1EC74892FEF1ADF4CB913587998925705323CDEE18C6806718F931CE4D7EAD0B55576217EF1C9C9CD43169B14372EFE5A969392C793F4A8FECFC3FF29ABCDB152D272B9F970DFF00046C8AF51A681B535B2BD013CA4B9683CA8D398D04600002838E80FAE4D75DF0EBFE0897E12D275FD32E6EECE5FB3CC863B84133A6F0A08E70475E7F135FA3D169F1431612351CE692480074E0639AD3EA5875F644F36C5DACA6CF90F51FF8261F803C277D60DA16896B651C971E64AA9BBE67CEEDE79E4E4647A55CD1BF623D37C3576161B3924F2A5F2A27B83E6BC484E76AB124EDE4F53DEBEA5D62F2CF4D30BDC4D1424380BBDB19FF003CD79CFC69FDB13E147ECFD612DF78CFC7DE14F0DC513072750D4E180FE019813F857453A54A3AA8A3278AC4D4D1C9B30F4BFD94F4EF0869CD3436B0993CE49090BC81BB9AE87C47A059F87EE256C27C92467AF515F09FED61FF00074AFECF1F0B34DB9B0F04DC6B5F12754E554E936A52D011EB3CBB571EEA1ABF30FF006B6FF83917E3A7ED032DD5B785574BF871A64E3024B35FB66A2476FDF480221FF763CFBD4CB154E2ACBF034A582AD37CD33F7F3E30FED05E15F829E1A935BF116B7A3E85A6C302896E6FEF12DE2007FB4E40AFCCAFDB3BFE0E92F863F0A61974EF85DA55C7C42D5EDD0A24D07FA36961F279699D773AE7FB8873FDE15F895F1B3E3778DBF683F1036ADE37F156BFE2ED458E44BAADE34E221E88A4EC41ECA057976AD2379FB493C76F7AE6FAC73EC767D55533DF7F6B2FF828AFC5BFF828D7C459756F88BAF0B8B4B2C8D3F45B2430E9D61E636DCAA7F136DC8DEE59BAF20715F54FEC71A34DE04FD953C4B28B38E796E8C10A348A4A190B12338F61F4AF85FE00F835F5DD42102324DC5C8CFF00B61785FF00C798FE55FA81E28F0B47F067F64EF0DE8BB961BBD73515D41FCC6DABE42BC719DD93D0AF998E79C1AF9ACF3109D5850F33ECF84B0AE34AB629E89459E3DA7780B439355D360B1D264D091F5097EC4268D5DE5B746027830AC7CC8585CB90E49718240C1AC0D1E687C2B7D793477AF368DA45CC514D1468D6C6F2E248F74780DF33919E38C2E19B1C56E78AE78F43D1604D45756D3BC41E17D70A4770D69BEE61628583C90F0CD04A862762BB861DFCBC8C2561F887E1EB5C69BADEA33CB65AC6912DBDB7D8B50B39FCC16FE534ED348D183BD190B28DACA0B79919FBA41AE9E4EC7CCDDAD4CDF86DA1FF0064F897C5A90DE306D4A19934F9E7E678435B4170F2A3679405D72C72A4000E09AE83C6835D9BC476575E2B682F2C162B5B98EE2C06C9621E70170C800CB7FA859954F03B7DD7DD81A4EA572FAB6976B6655AEF46921562045BD4AC6F146C198E12450AE8DD898C6E53F293DFE97F11B4FF001369D19F11E83069DE208AE228A3BDB75FB3DADD2452AB02F093B2290AEF2F84C139C8CE6870B25617B5937A985F10238345F0BEBD6B25A5BBDAEB36B235A4B14DE524534572850BE060E705F2DF290E318E83F413FE0839E119ACFF0068686E2F2CE296E2E7C3B10B98E35D861691D8CBD094287E53B467800673D7F3AFE2AA3F8C2E7478A2314D73A5DD5CC97565800A2F971E77BA131C9952A1411DCB119040FD5DFF00837BFE174973E1D97C432CBAA8B86816249A6986405DE08DA465F1C2B76240279C13AD085EA44C3112B41B67EACDB422DFE55185FAE6A6A8E00C07CC413EC315257D11F3EC28A28A041451450015C97C69D0E7D5FE156BF6B616D6D737B73672A411DC3110995C6D05F1CED04E5B1CE0102BADA4650E3919FAD26AEAC34ECEE7F2D9FF000535F833AC7C0BFDA72FB584BED43EDFA46B4977632CE3CBBE86E512094DD24430A228A49542104824F56539ABDFB5E7F66FED0DE09F0A7C5AF0F5A456BA678D2D84F796F08F92C7528C6CBCB527D5650587AABA9E86BF537FE0BDFF00B22E8BE3DF0F43E33D334AB68F5FB10B36A1750BB799751C68556195114EE5C3E7E7E319EC0E3F1F7F669F88963F0CBC6DABFC2AF19DD4165E10F1EDC471D9DDDC4984D235807CBB7BA2013B63976B43201C0431B9385AF95CDF08F4A94D6B1FC8FBCE18CC6316E857F827A7A3E8CF9CBC596DB09574F98821BE5AE3A4D3EC8DBCF67A95AFDAADE7042767B690E40910E3A804F1D0F19E95F4CFED23FB3DEA1F09FC6FA8E91A8412C17761298E48E55DB8F707B8F435E27AFF0087CAC84B2ED7E47D6B1C163538DD1E8E6797384F944F815FB7F7C7CFD8EAE63D3BC19F15BE2078520B2C18EC2D75999EC0A9195616F21688A90723E4EF5F5FFC26FF0083A4BF6B8F02DBC51DF78A3C23E304880006B5E1D855DC0F57B6F2493F5E79AF86757F0A2F89AD16CE79160B882361657246467AF97277DA79C1EC48EC4D708565D275192DAE2378268CFCC8E30457AFED652578B3CAA54A93972D6827F23F657C37FF00077D7C71FB2A8BEF865F0A6E65DA0168E4BE8013C738F35EB525FF0083BE3E302A607C28F865BF1FF3FD7C47F3AFC6BD3B50C38DC4FB56BC1A947E84374393927E9DAA1622AAEA76BC9F04F58C11FAB5E23FF83B8BF683BC19B1F02FC2AD3958F00C57B70547E32AD794FC4EFF00839B3F6B1F8816CF0DBF88BC25E1C8D8EE56D2F4141221E3A34ACFFCABE02F39668F712E074C629A595F81F99347D6AB7561FD8F855B411EDFF167FE0A73FB44FC74DFFF000927C61F1E5E249C3C56FA91B28CFF00C060082BC2B56BAB8D73527BAD427B8BFBA93EFCF752B4F2B7D598927F3A7BB7964F3F91A89CEE6CD2F6D27B99BC1421F0E822AE4F53F9F4A7E06DA825B8F24FF2AAF2EA6533C8FCBA53898CA9A5A12EA0E210A41E33CD72AFA7CDAE6B896B082D2DC385503B1F5FA71FA5696AFA979AB95232A3919C57B57ECD7FB306A9E20D6E396EE064BDBB01766DF9ADD0F453E8EDDFD071D4F173AAA9479A6732C3CEBD554A9AB9ECDFF04F5FD99AEBE237C43D06DA186478DA58A28C018C46A416627A0EEDCFAD7BFF00FC147BC7DF6FF8910E91630FDA34DF0F3C1A6BB47C94851595153B191A419C772C33F2835ECDF05BC17A3FEC43FB325E78A75295A1D735E89ECB4E8F6ED29101F3C8A7B678507DABE36BDF8DD0DCFC460BE22B38AE747F155B4B298C398EE942BB2C5229E9200EA4BC6C0AC8A3B1E6BE4B0F2962F31759FC313EF7358432AC9BEAC9FEF2674B36A5A643F03AD6E35231F88DE2692D748BAF36449AD62906FBBB190924848F67991090660666504C6EB8E7F534B9F0DF81351D36CEF566B258F2DAAEA512C935C1674F9BE4211B6A1951B920A155CA1EBAF15E697E0CF0FC3A4497A2E1754BE9675B58FF0074B1F951C8F09690A379A8C4C89927FD5BA608318CF8DF863C11AFF896C2779EE60B74B8F3A4B69D665B8B688A45F345BF2F1C60BA479CB20C4EE73C1AFA8B58FCC75B16BC77A07FC24FF11B5ABB8269608ECB4EFB54E6F668D92297967818E414911DCA2EE23181CE0EE296FA92EBBA6CB6F786DCDECEF6EF66B673C854C931667525BE6DADE43004E3E6E87613567E31783AF2DF59B6875AB53A645E31820B8F3AD161BAC5D1855A5564C65E094C7B7E46EAE0E48016BADFF8456C6F7418EF86A3A76A73C111B7782DB123E9F3C5E6496E049F2302385E7A962090C4D4D848EC7F647D1E5F8EBE39D1346F22EEFB5A8AE8C56DAA47BB6A2A1DF134D1A9DB24670D19C2963B8E3AE0FF00441FB077ECCD67FB37FC0AB0D191313F98679548F96391B9217201DB9C9048DD8201E95F953FF0444FD96B57F8D5E3ED2FC7BAFE9D3D8D87CF73FE8F9FB18B82A70AAEA7742A719084FCACD8395618FDC0D32C134CB28A0891523891515546028030001E800AEDC1D0F7DD467063AB2FE1A270B8A5A28AF50F3428A28A0028A28A0028A28A00E07E3EFC228BE2F780EFF499A213C376159E063B52774E5039EA50300703AF4E99AFE797FE0A33FF0004DAD43E14789B57D46FF4C9A3B1B0716526E9772B170092B248C23624E4B609DBC0E8463FA58AF17FDB3FF666F0CFED09F0BAF6CB5CD36DEE5B6130CED08964B49328C24453C6F213603D70F8C804D72E228F36A75E1B10E9BB1FCFCFC0AF8896DFB5FF00C35B2F85FE287857E27F8660FB3F8675AB9601BC536718E2CA591B86BA8957E423EFA003EF0E7C23E2A7C1BB9F0B6B777697F65716D756D23472C4CBB5E161D5594F22BA2FDAB3E12EA7A17C68F12C434B1E146D235973A6A09DACDAD8452BF2240094C48B1E1C00728D803191EC5F0BFF006A8F02FED27A75BF853E3C6A90F853E2369D6BE5D9F8AA3B7DB0EBD1EEF255EF06331B2B91FBC7003AA3B6062BE2F1D829E1E6EB61D5E3D52E8CFD3F27CDE963292C3E29DA6B6977F267C4BA9783D9257CA9D873CFA0AC0D73C1F6BAB598B4D4A1DFE5A95B6BC887FA45B1EC0FF7D3FD93F8115F6E7ED19FB0CF887E10CECD3D9452E9F2AEFB5BFB693CDB4BA4EBB95C7078C7E75F3D7887E184B14B200863231B7DCFF856982C7A9AB958FC9A54E5AA3E6CF14782751F078134C9E769EE7115D44A7CA73E849FBADFEC9E7D33D6AA596AA5795E7B722BDFE4F0DDE693BBCD042EDC323A87471D30CBC823D88AE4BC43F07B47D5049243E769176C42A24081ED33FDE2A4EE5CFA29C0EC3B57AD0A909EE791FBCA5A743CE97532E73BC6EEE076FE9563CEE3756E4BFB3DF8A2273F608ECF5819C06B19D59B1EA51B0DFA567DF7C2EF16E9AEA971E1DD753270BFE832107F10B8AD542FB14F1892D4A9F69DF1E7EEFB66A29EE318F97EBCD6959FC2FF0016DDCC513C31E217751923FB3E5181EA72BD2BA6B1FD977C677578B15F5AD9E83B86E65D46E9524418CE4C6BB9C76FE11D69BA76F88CBEB0E4ED1D4F3BBCBEDA07F4352786BC2DAB78FF0059163A3D9CD753B73211854857BB3B9C2A0F762057BE783BF644D174EBB83FB567BFD76EA460C21881B3B6C77CF0D2B0FF00BE3F0AFA17E0BFC09FED5FB3D95B6931DBDB236F1676F12C509EBB4E39C9F76CB7E35CF5B1B4A8C799BD8E8A197D7C54D452B1E09FB3DFEC9B2693A95B5E5D4516AFAF67746A0F9969A73103073CACB2007AF28A7A6EC66BF49BF641FD93743F85DE0C97C7BE359841A1693996E1DCFCF7F37510A03C9663E9F526BA5FD9E3F639D23C21E0C97C65E33957C35E1CB242CF231C493E1788E3C9C1638EC3D7A578AFEDBFFB695BFC65BB5F0F6953DBF877C2DA45BCB2D858162008A35049C28CB4D27006E2A0938C8CD7CB62B32AD8DA8A9D2D8FAFC0E59432CA4EBD4D65FD69EBF91C77ED65F1FEEFF6B3F8B36BBCFF0063F8716416B6D0A1CEC823059BCB41FC2A8BE9CB32FB91F3F7C63D77FE164698F638FECFD51A11FD996E6D0456DA7AAAB9778AE4E163568C24214139740F8C9DD5E89A0CFE1CD506BFA149A9BACFA3B5B4BA76B96C648E78E5440D66A916EDAB1869DD8A637972B8CE003E4DF16B568B45F15D828D422BEF0C4374EB74B75A77916F2C72C8AFBFCAC131AE24EC11F24B05F9B27E9B0583850A694773F39CE333AB8DACEA547E8BC8A3E17F88D6FA0C179A8DCC116A3AFDF59C969A75A451B27941891713CAB8DB26079A91AB8F99932493B6BA293C117BF0826FB7F8662874CB68ED2444B2B66FB458C5296F9D264390D9899D983820AC83D0566FC49D17C396EDA2FF00C230E66B9B9844934AC1BF725554C854900B42CAB1B86002E769C64B11D17C3FF14C50EAFA3E95672EB1777F676D776ED25E223AC8EDFBD8C22E4966FDE6CC9C9FDE9EC2BA99E62663F8AB45D1F50F89934D36A71E970CD6E97D0C3B372A347179863548B2A0231F2911906522009C035E89F033E103FC79F10CBA0785A2935CD6B547B39E48ADA42C93618129B8A7980B2EF186DC4155C018AE23C23E12B9D63E2935EC56D692E8F78B25D24D2BBDC476D7725BAA94C03B9544C5D553924ED1C8E6BF563FE085DFB096B7E07F1BD8FC46D4F4B32D9DCCF2431C52848CAA16919655E7736C60AC08CE33C104105C21CEEC4CE7CAAE7E8F7EC59FB3CC1FB3C7C20D23C390C689FD916AD692BADBF92B724B821F6E48E00C0E4F1DF1803DA6A3B78FCA8554F2546093DEA4AF6A9C145591E1CE4E52BB0A28A2B42428A28A0028A28A0028A28A002A1BDB51796EC87BFA8CD4D4526AFB81F0FF00FC1423FE095BE1AF8EDE1CBDD5349D1AC46B37B334F76F25C345E6B34864762CC481C7627686DA40FBD9FC3FFDA67F64CBEF873E21BDB5BE48EE63B8582EA57B80C8615684EC91A3C6E74099DB9254201D599ABFA9E96159D0AB80CA46083D08AF37F897FB2EF83BE24447EDFE1DD16E64685EDFCD9ED95E4457EB8623240EC84ED1E95C95F0CA6B43AE862793491FCD2FECD3FB6F78DFF65EB2D6BC397D6969E36F8451468CFA26BA5BCD86360C4C9039CBC476A9383F27A0E01AF70F0BF817E157EDC119D43E14EBB1DBEA291EE97C29A9325B6A566DCFC91EE2165008C0C1AF7BFF008289FF00C127AC3E19F8775AF11E876BE57DBA692F2EADED205DB32868C44B1C6178DBB1F2BFECAF18241FCB5F8B3F0235BF847E0FD065B19B50D335DB4BC0DA85E42A61680A6E28B1B8E7392739C0C9F506BE63199346A3E783E497E1F347DC651C555682F655573C3B3DD7A33DCFE21FECBBAC785F52920D4B4EBBD3663CB45759464FAA9C7A7E95C44DF071BED73218D664840DF853B493CFE3DFA576FF00083FE0A3BF137C29E217D07C61A3DBFC52D02C108F37506C5CC512AA8E66193CE7F46EC39F61F0CFEDA9FB33FC6BD26157D3BC4BE03D52E63DED6E664B981F2482537609C107F01C57913FAE61DFBF1BAEE8FB2A35F29C6B4A94F95F696963E528FE10431C92CAC1A18339CA96DA9F4CF5FC2AC69BF0D355BA72D6D717925B478643F7772E71F28EA2BED54D3FE05CFE0E1369FF0013A0B6B846063FB65A146018F2095DC33DEAEAE8FF00046EADD1DFE24DBCB7322AA136D10DFB88E3392A00EFCD64F389A5F0BFB8ED5C3D425AA9AB7A9F21E9BF08B50BAB632DE49A8470BBEF7F325624A8E31824D77DE0EFD9BBEDB6F0DC2A2EC490310CA3793C1E4F423A6735EFBAA7ED01FB3FF8134EDF73AA6B1E2496DD3C8F96286049769EBD491F5E3A572FAD7FC1557C31E05B49BFE10AF87560D36E511DC5C31BB9559802A318D809C82A3AF3EF50B1D8AACED08317F67E5F867CF5AA2FBCE97E17FEC23AA5FDABEA3771DBE9D63BCCB717B78CB144148F56E3B0E7AFA75AE9B5EFDA93E10FEC676F70639AC7C55E25B74C3111E6D519790403CB638ED8F6AF903E2AFEDD3F147F6C0F125CDB5CEA12E91A7AC2F335C2C6CF0C089C36D8C71DBB7271C67A5703A17C31D2AC7C63ABEA9AD6B573776DE1FB585D649B625C992E62F385CCC03B4707CA0F951B393911E412715AD1CA7135DDF132B2EC7062F8AF03858B86123CCFFAFEBA1EC5F1DBF6D9F17FEDD3F16F48D127BD7D03C292AB5C46A1C24569631EEDF2A45951B723032324E07522BC1F48D334A86EA78751D43CCB9F13343E53342D27905A5DD6F6B1B6D6DCD9659642060189179C8AEDFC67AC2E99A769577A5DD595BBDF698E6DB5670971706C12785DD64208087CE556C290CC1BAA80A2B86D5F4B9FC6B6FA6F886182F74A81B56B87B152034DF64B54F38DE961951F322AB718DF8038AFA6C2E0A8D08DA08FCF71F9B6231536EA3D3B2D121B2E91A8783FE1D4B77F6657BC86F6E64D4C2069D11E26587E629BB1C8057A8C479E08C5711E33F0B5E789B48CC174BAB2CF752CD750DDDC117171E62C667667C90D8090AAB4791823E5DD907DBFE0CFC678F53D1EE6E34DD0B4BBDFB7C329D4B4EBE412411CAEBFBC0B93BF61DF952A031E57EF05CE37C7B9BC0FA869F7B6DE11D2E7B0B1D46D925B0BA97519EEAE2DD9247568E44906028F99720EE6F97270307A6F63CDB2E8606B8A35AF055A597DB2CC22594366CD0A63EC500C4321DBC8DCCAA910233B40C923380DF87FA85FEBA2E2DADB4D47D5ACAF63B8B449E2C989D515832100123E6627E604360E0AE6BD9BF634FF00827EEB9FB607C50D174DD0AD64974ED5E548EE669008EDE06F2B127EF00CA8108126319E4000915FB3BFB267FC1083E15FECE5FD97A96A2F75E27F13D848F2CB7B39D91C8FE68646541F7488D44679390CDEB5A4694A7AC48A95A14D5A5B9F3AFF00C124BFE094F65E32BE5F887E30D06C3EC170A1CD9EFF00DD8B89115EE2131636B20731C892A9043A942B8193FAADE0FF0002699E03D256C74AB386CED5092B1C68AA01249278F524D68E99A641A45A886DE18A0897A246A140FCAACD7A74A82823CAAB5A537A8514515B9885145140051451400514514005145140051451400523207EA334B450064F89FC1BA7F8BAD7C8BEB68AE23E70B22060338CF07E95F257EDA9FF00048AF01FED1FE19D4E76B7960D5259DAE21B8462ED006DC762213B00DEDB89E49E7D057D9748E8245C1E878A8942325665C6728BBA3F9DAFDA7FFE0973E32F829E1EB0B896CEEBED5E294FECED4ADE25C8B77F302860990DB4A16393FDEEB9CE3E2EBCFD9E25F0B5F9D4EEB4737705A3DB69D1C2AF88DE5952551927E6C2AA4AEC78237738DA6BFAD8F1AFC35D23C7D0A0D46CE19CC4B22296456CABAED60410411D0F3D08046315F137ED2FFF000473F0A7C50B9D4278ECDE6B0B7B48960B24215A79B2DE6461C8F915B79DCE4B70ED9202D704F0AD691D8F4296313F88FC06D0FE1AD9EA3A2C6C9386B7BFBEB8136617587CA50BE5C71F209C3AB3138E018C0C8DD5497E08FF00C27B7D6167A6ACDA7CB3C99BB6791414B4876EF6DDD15A5FC8046C71923F62FE297FC10F2E64F85FA7B6870CD7770D0BC8D2595A2C2D2C935C09B795DDCC6119D1464B0C26781CFCB9F13BFE0955F143C0DE07D403D95BE9F6B6B6F0C1A82F124C6323FD4952A0E11A36638277614927A560F0CD2D4EB8E31CB4523E24D4BC2DA45BDFEB7AD0B327C39A3CEEB77A9163E56A73E0225B4249F9608F0C59829694A37280AE76BC27E0E5D4B4A8B4AFB7491DE5B4BFDADAA5E6140B4BA572CB0A2B0C1296A0B93C8241DA7E4E7E93D3FF00E09B9F11468979FDB5A0DF6A9611C93D8B34A6312DD3B0E6323EEF9849E33C2EEC6E1815CEF847F628F885F0FF005AD5AEE6D2B57363A859452BDADD5A3C535E69EC4AC720DC4EE8CC8CAACCA4B1193D2A153B6C83DAB6F5679C7C3DF0F689A86926CF464B987C9B174BDBCF29C2C76A55C02D23B6362898BB11F2E4E0738AE2FC4B0FFC245E21D6E1D3205BEF0FACE6F63821E2DE611BC5129380BBE54883202DB8A966C60735F5AF85FF00E09FFF00163C5F6DA7E91A1E8EB16837C26B8B37B38B62CF1DBBC6AD6F21C7EF1C619D63936A15DD9E4AE619FF00E0933F1566D52696D7C2D3E9D770B4AB3C102F9913300AECC9C8C0C88C8EA0EE0323032D527D88BC5753E51B5BAFECFB2B68BCC58ADA1F384F6772B931C4DE5B88F18CB6EDAA83271C1F4E22D5B4AD627D1EDDD22DB3C76325BDC30BD6C0973E63246A5803BF0493CE3233C707F48FF66BFF00820378A7C5FA741ABEBD75258EA176B235DC135BA8F3832B14521B20AA09148008CB023383C7D6DFB39FFC10CBC35F093C4FA45EEA176FA80B13E73DB48886349410FE6860031DCCA80C6490029C11C0AD63426CCE55A08FC70F835FB19EBDE3FBDB2874BD0446F3DC9FB3F9EA13ECF2FCD888C876E46DE46391CAF51CFDCFF0A3FE0827E2AF16EB3A45FF008DA4B7B2B5BAB577FB3DD209258F79F9A371BC159159980C82000849C96DBFB27E1CF863A1785B468B4FD3F48D3ECACE17691628605452CC58B3600EA77B67FDE35B91DA469185D80055DA07B574470ABA9C8F16DEC78AFEC87FB17F85FF00652F0E7D97C3F632D9A38855ADD8A345198E111ABA607DEC6ECB0C121C839C0C7B7018A51C515D708282B2396537277614514559214514500145145001451450014514500145145001451450014514500145145001515DDA25E5BBC522EE4906D65F5152D1400C8E208300003D0551D53C27A76B5E67DAAD229C4A30E1875E315A3450062FFC203A57F659B3FB15B881A33090100F9339DBFCA96F3C05A4EA1A7595B4D616B2C7A700B6C248C39846369009CE015E0FB56CD14AC87CCCC2D2FE1D691A2C70ADAD8DBC22079248F620010BAED6C7D5401F856847A25BC4D16215FDC7FAB39FBB5768A39505D91880039C007A53B6714EA2988451814B4514005145140051451400514514005145140051451401FFD9),
  CNHDigital varbinary(max) NULL,
  Status bit NULL DEFAULT (1),
  UsuarioIdAlteracao nvarchar(100) NULL,
  DataAlteracao datetime NULL DEFAULT (getdate()),
  UnidadeId uniqueidentifier NULL,
  ContratoId uniqueidentifier NULL,
  CondutorId uniqueidentifier NULL,
  TipoCondutor varchar(50) NULL CONSTRAINT DF_Motorista_TipoCondutor2 DEFAULT (''),
  EfetivoFerista varchar(50) NULL CONSTRAINT DF_Motorista_EfetivoFerista2 DEFAULT (''),
  CodMotoristaQCard int NULL,
  CONSTRAINT PK_Motorista_bkp_MotoristaId PRIMARY KEY CLUSTERED (MotoristaId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_Motorista_ContratoId_Status] on table [dbo].[Motorista]
--
PRINT (N'Create index [IX_Motorista_ContratoId_Status] on table [dbo].[Motorista]')
GO
CREATE INDEX IX_Motorista_ContratoId_Status
  ON dbo.Motorista (ContratoId, Status)
  INCLUDE (MotoristaId, Nome, Ponto, TipoCondutor)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Motorista_MotoristaId_ContratoId] on table [dbo].[Motorista]
--
PRINT (N'Create index [IX_Motorista_MotoristaId_ContratoId] on table [dbo].[Motorista]')
GO
CREATE INDEX IX_Motorista_MotoristaId_ContratoId
  ON dbo.Motorista (MotoristaId)
  INCLUDE (ContratoId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Motorista_Status_DataVencimentoCNH] on table [dbo].[Motorista]
--
PRINT (N'Create index [IX_Motorista_Status_DataVencimentoCNH] on table [dbo].[Motorista]')
GO
CREATE INDEX IX_Motorista_Status_DataVencimentoCNH
  ON dbo.Motorista (Status, DataVencimentoCNH)
  WHERE ([Status]=(1))
  ON [PRIMARY]
GO

--
-- Create index [IX_Motorista_Status_EfetivoFerista] on table [dbo].[Motorista]
--
PRINT (N'Create index [IX_Motorista_Status_EfetivoFerista] on table [dbo].[Motorista]')
GO
CREATE INDEX IX_Motorista_Status_EfetivoFerista
  ON dbo.Motorista (Status, EfetivoFerista)
  INCLUDE (Nome, DataVencimentoCNH, DataIngresso)
  ON [PRIMARY]
GO

--
-- Create index [IX_Motorista_Status_Nome] on table [dbo].[Motorista]
--
PRINT (N'Create index [IX_Motorista_Status_Nome] on table [dbo].[Motorista]')
GO
CREATE INDEX IX_Motorista_Status_Nome
  ON dbo.Motorista (Status, Nome)
  INCLUDE (MotoristaId, Ponto, TipoCondutor, ContratoId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Add extended property [MS_Description] on table [dbo].[Motorista]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Motorista]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', 'Tabela de Motoristas', 'SCHEMA', N'dbo', 'TABLE', N'Motorista'
GO

--
-- Create or alter procedure [dbo].[usp_PreencheNulos_Motorista]
--
GO
PRINT (N'Create or alter procedure [dbo].[usp_PreencheNulos_Motorista]')
GO

-- ==========================================================================================

CREATE OR ALTER PROCEDURE dbo.usp_PreencheNulos_Motorista
    @Keys dbo.MotoristaKeyList READONLY
AS
BEGIN
    SET NOCOUNT ON;

    -- Atualiza somente colunas NULL e somente linhas passadas em @Keys
    UPDATE M
       SET
         -- strings
         CPF               = ISNULL(M.CPF,               ''),
         CNH               = ISNULL(M.CNH,               ''),
         CategoriaCNH      = ISNULL(M.CategoriaCNH,      ''),
         Celular01         = ISNULL(M.Celular01,         ''),
         Celular02         = ISNULL(M.Celular02,         ''),
         OrigemIndicacao   = ISNULL(M.OrigemIndicacao,   ''),
         UsuarioIdAlteracao= ISNULL(M.UsuarioIdAlteracao,''),
         TipoCondutor      = ISNULL(M.TipoCondutor,      ''),
         EfetivoFerista    = ISNULL(M.EfetivoFerista,    ''),

         -- datas
         DataNascimento    = ISNULL(M.DataNascimento,     CONVERT(date,'19000101')),
         DataVencimentoCNH = ISNULL(M.DataVencimentoCNH,  CONVERT(date,'19000101')),
         DataIngresso      = ISNULL(M.DataIngresso,       CONVERT(date,'19000101')),
         DataAlteracao     = ISNULL(M.DataAlteracao,      GETDATE()),

         -- binário (mantenho excluído por padrão)
         -- Foto           = ISNULL(M.Foto,        0x),
         -- CNHDigital     = ISNULL(M.CNHDigital,  0x),

         -- numéricos/bit
         Status            = ISNULL(M.Status, 0),
         CodMotoristaQCard = ISNULL(M.CodMotoristaQCard, 0),

         -- GUIDs
         UnidadeId         = ISNULL(M.UnidadeId, CONVERT(uniqueidentifier,'00000000-0000-0000-0000-000000000000')),
         ContratoId        = ISNULL(M.ContratoId,CONVERT(uniqueidentifier,'00000000-0000-0000-0000-000000000000')),
         CondutorId        = ISNULL(M.CondutorId,CONVERT(uniqueidentifier,'00000000-0000-0000-0000-000000000000'))
    FROM dbo.Motorista AS M
    INNER JOIN @Keys      AS K ON K.MotoristaId = M.MotoristaId
    WHERE
         M.CPF                IS NULL OR
         M.CNH                IS NULL OR
         M.CategoriaCNH       IS NULL OR
         M.Celular01          IS NULL OR
         M.Celular02          IS NULL OR
         M.OrigemIndicacao    IS NULL OR
         M.UsuarioIdAlteracao IS NULL OR
         M.TipoCondutor       IS NULL OR
         M.EfetivoFerista     IS NULL OR

         M.DataNascimento     IS NULL OR
         M.DataVencimentoCNH  IS NULL OR
         M.DataIngresso       IS NULL OR
         M.DataAlteracao      IS NULL OR

         -- M.Foto            IS NULL OR
         -- M.CNHDigital      IS NULL OR

         M.Status             IS NULL OR
         M.CodMotoristaQCard  IS NULL OR

         M.UnidadeId          IS NULL OR
         M.ContratoId         IS NULL OR
         M.CondutorId         IS NULL;
END
GO

--
-- Create or alter trigger [trg_Motorista_FillNulls_OnChange] on table [dbo].[Motorista]
--
GO
PRINT (N'Create or alter trigger [trg_Motorista_FillNulls_OnChange] on table [dbo].[Motorista]')
GO
-- ==========================================================================================

CREATE OR ALTER TRIGGER dbo.trg_Motorista_FillNulls_OnChange
ON dbo.Motorista
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;

    -- evita loop (o UPDATE dentro da proc dispararia de novo este trigger)
    IF TRIGGER_NESTLEVEL() > 1 RETURN;

    DECLARE @Keys dbo.MotoristaKeyList;

    INSERT INTO @Keys (MotoristaId)
    SELECT DISTINCT i.MotoristaId
    FROM inserted AS i
    WHERE i.MotoristaId IS NOT NULL;

    IF EXISTS (SELECT 1 FROM @Keys)
        EXEC dbo.usp_PreencheNulos_Motorista @Keys = @Keys;
END
GO

--
-- Create or alter view [dbo].[ViewMotoristasViagem_Ultimo]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristasViagem_Ultimo]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristasViagem_Ultimo 
AS SELECT TOP 10000
    m.MotoristaId,
    m.Nome,
    m.TipoCondutor,
    m.Status,
    m.Foto,
    CAST(m.Nome + ' (' + m.TipoCondutor + ')' AS NVARCHAR(300)) AS MotoristaCondutor
FROM dbo.Motorista AS m
WHERE m.Status = 1
ORDER BY m.Nome
GO

--
-- Create or alter view [dbo].[ViewMotoristasViagem]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristasViagem]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristasViagem 
AS SELECT TOP 10000
    m.MotoristaId,
    m.Nome,
    m.TipoCondutor,
    m.Status,
    m.Foto,
    CAST(m.Nome + ' (' + m.TipoCondutor + ')' AS NVARCHAR(300)) AS MotoristaCondutor
FROM dbo.Motorista AS m
WHERE m.Status = 1
ORDER BY m.Nome
GO

--
-- Create or alter view [dbo].[ViewMotoristas_Ultimo]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristas_Ultimo]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristas_Ultimo 
AS SELECT TOP 10000
  Motorista.MotoristaId
 ,Motorista.Nome
 ,Motorista.Ponto
 ,Motorista.CNH
 ,Motorista.CategoriaCNH
 ,Motorista.Celular01
 ,Motorista.Status
 ,Unidade.Sigla
 ,Contrato.AnoContrato
 ,Contrato.NumeroContrato
 ,Fornecedor.DescricaoFornecedor
 ,AspNetUsers.NomeCompleto
 ,Motorista.DataAlteracao
 ,Motorista.ContratoId
 ,Motorista.TipoCondutor 
 ,Motorista.Foto
 ,Motorista.EfetivoFerista   
,Motorista.Nome + ' (' + Motorista.TipoCondutor + ')' AS MotoristaCondutor
 ,ROW_NUMBER() OVER (ORDER BY Motorista.Nome) AS RowNum
FROM dbo.Motorista
LEFT OUTER JOIN dbo.Contrato
  ON Motorista.ContratoId = Contrato.ContratoId
LEFT OUTER JOIN dbo.Fornecedor
  ON Contrato.FornecedorId = Fornecedor.FornecedorId
INNER JOIN dbo.AspNetUsers
  ON Motorista.UsuarioIdAlteracao = AspNetUsers.Id
LEFT OUTER JOIN dbo.Unidade
  ON Motorista.UnidadeId = Unidade.UnidadeId
ORDER BY Motorista.Nome
GO

--
-- Create or alter view [dbo].[ViewMotoristas_original]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristas_original]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristas_original 
AS SELECT
  Motorista.MotoristaId
 ,Motorista.Nome
 ,Motorista.Ponto
 ,Motorista.CNH
 ,Motorista.CategoriaCNH
 ,Motorista.Celular01
 ,Motorista.Status
 ,Unidade.Sigla
 ,Contrato.AnoContrato
 ,Contrato.NumeroContrato
 ,Fornecedor.DescricaoFornecedor
 ,AspNetUsers.NomeCompleto
 ,Motorista.DataAlteracao
 ,Motorista.ContratoId
 ,Motorista.CondutorId
 ,Motorista.Foto
 ,CondutorApoio.Descricao
 ,CASE
    WHEN CondutorApoio.Descricao IS NULL THEN (Motorista.Nome + '(Terceirizado)') 
    ELSE Motorista.Nome + '(' + CondutorApoio.Descricao + ')' 
    END AS MotoristaCondutor
  ,ROW_NUMBER() OVER (ORDER BY Motorista.Nome) AS RowNum
FROM dbo.Motorista
LEFT OUTER JOIN dbo.Contrato
  ON Motorista.ContratoId = Contrato.ContratoId
LEFT OUTER JOIN dbo.Fornecedor
  ON Contrato.FornecedorId = Fornecedor.FornecedorId
INNER JOIN dbo.AspNetUsers
  ON Motorista.UsuarioIdAlteracao = AspNetUsers.Id
LEFT OUTER JOIN dbo.Unidade
  ON Motorista.UnidadeId = Unidade.UnidadeId
LEFT OUTER JOIN dbo.CondutorApoio
  ON Motorista.CondutorId = CondutorApoio.CondutorId
GO

--
-- Create or alter view [dbo].[ViewMotoristas]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristas]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristas 
AS SELECT TOP 10000
  Motorista.MotoristaId
 ,Motorista.Nome
 ,Motorista.Ponto
 ,Motorista.CNH
 ,Motorista.CategoriaCNH
 ,Motorista.Celular01
 ,Motorista.Status
 ,Unidade.Sigla
 ,Contrato.AnoContrato
 ,Contrato.NumeroContrato
 ,Fornecedor.DescricaoFornecedor
 ,AspNetUsers.NomeCompleto
 ,Motorista.DataAlteracao
 ,Motorista.ContratoId
 ,Motorista.TipoCondutor 
 ,Motorista.Foto
 ,Motorista.EfetivoFerista   
,Motorista.Nome + ' (' + Motorista.TipoCondutor + ')' AS MotoristaCondutor
 ,ROW_NUMBER() OVER (ORDER BY Motorista.Nome) AS RowNum
FROM dbo.Motorista
LEFT OUTER JOIN dbo.Contrato
  ON Motorista.ContratoId = Contrato.ContratoId
LEFT OUTER JOIN dbo.Fornecedor
  ON Contrato.FornecedorId = Fornecedor.FornecedorId
INNER JOIN dbo.AspNetUsers
  ON Motorista.UsuarioIdAlteracao = AspNetUsers.Id
LEFT OUTER JOIN dbo.Unidade
  ON Motorista.UnidadeId = Unidade.UnidadeId
ORDER BY Motorista.Nome
GO

--
-- Create or alter view [dbo].[ViewItensManutencao]
--
GO
PRINT (N'Create or alter view [dbo].[ViewItensManutencao]')
GO
CREATE OR ALTER VIEW dbo.ViewItensManutencao 
AS SELECT
   im.ItemManutencaoId,
   im.ManutencaoId,
   im.TipoItem,
   im.NumFicha,
   CONVERT(varchar(10), im.DataItem, 103) AS DataItem,  -- dd/MM/yyyy
   im.Resumo,
   im.Descricao,
   im.Status,
   im.ImagemOcorrencia,
   m.Nome AS NomeMotorista,
   im.MotoristaId,
   im.ViagemId
FROM dbo.ItensManutencao AS im
LEFT JOIN dbo.Motorista  AS m
  ON m.MotoristaId = im.MotoristaId
GO

--
-- Create or alter view [dbo].[ViewAlocacaoMotorista]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAlocacaoMotorista]')
GO
CREATE OR ALTER VIEW dbo.ViewAlocacaoMotorista 
AS SELECT DISTINCT
  COUNT(Motorista.MotoristaId) AS Motoristas
 ,Unidade.QtdMotoristas
 ,(COUNT(Motorista.MotoristaId) - Unidade.QtdMotoristas) AS Deficit
 ,Unidade.Descricao
FROM dbo.Motorista
INNER JOIN dbo.Unidade
  ON Motorista.UnidadeId = Unidade.UnidadeId
WHERE Motorista.Status = 1 AND Motorista.TipoCondutor = 'Terceirizado'
GROUP BY Unidade.QtdMotoristas
        ,Unidade.Descricao
GO

--
-- Create table [dbo].[ViagensEconomildo]
--
PRINT (N'Create table [dbo].[ViagensEconomildo]')
GO
CREATE TABLE dbo.ViagensEconomildo (
  VIagemEconomildoId uniqueidentifier NOT NULL DEFAULT (newid()),
  Data date NULL,
  VeiculoId uniqueidentifier NULL,
  MotoristaId uniqueidentifier NULL,
  MOB varchar(50) NULL,
  Responsavel varchar(50) NULL,
  IdaVolta varchar(5) NULL,
  Trajeto varchar(500) NULL,
  HoraInicio varchar(5) NULL,
  HoraFim varchar(5) NULL,
  Duracao int NULL,
  QtdPassageiros int NULL,
  CONSTRAINT PK_table1_VIagemEconomildoId PRIMARY KEY CLUSTERED (VIagemEconomildoId)
)
ON [PRIMARY]
GO

--
-- Create or alter trigger [TR_ViagensEconomildo_CalcularDuracao] on table [dbo].[ViagensEconomildo]
--
GO
PRINT (N'Create or alter trigger [TR_ViagensEconomildo_CalcularDuracao] on table [dbo].[ViagensEconomildo]')
GO
CREATE OR ALTER TRIGGER dbo.TR_ViagensEconomildo_CalcularDuracao
ON dbo.ViagensEconomildo
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Normalizar MOB (remover acentos de Rodoviaria)
    UPDATE V
    SET MOB = 'Rodoviaria'
    FROM dbo.ViagensEconomildo V
    INNER JOIN inserted I ON V.VIagemEconomildoId = I.VIagemEconomildoId
    WHERE I.MOB = N'Rodoviária';
    
    -- Atualizar Trajeto e Duracao
    UPDATE V
    SET 
        -- Trajeto com setas (sem acentos)
        Trajeto = CASE 
            WHEN I.MOB = 'Cefor' AND UPPER(LTRIM(RTRIM(I.IdaVolta))) IN ('IDA', 'I') THEN '-> Chapelaria'
            WHEN I.MOB = 'Cefor' AND UPPER(LTRIM(RTRIM(I.IdaVolta))) IN ('VOLTA', 'V') THEN '-> Cefor'
            WHEN I.MOB = 'PGR' AND UPPER(LTRIM(RTRIM(I.IdaVolta))) IN ('IDA', 'I') THEN '-> Anexo II'
            WHEN I.MOB = 'PGR' AND UPPER(LTRIM(RTRIM(I.IdaVolta))) IN ('VOLTA', 'V') THEN '-> PGR'
            WHEN I.MOB = 'Rodoviaria' AND UPPER(LTRIM(RTRIM(I.IdaVolta))) IN ('IDA', 'I') THEN '-> Camara'
            WHEN I.MOB = 'Rodoviaria' AND UPPER(LTRIM(RTRIM(I.IdaVolta))) IN ('VOLTA', 'V') THEN '-> Rodoviaria'
            ELSE V.Trajeto
        END,
        -- Duracao em minutos (23:50 -> 00:10 = 20 min)
        Duracao = CASE 
            WHEN I.HoraInicio IS NULL OR I.HoraFim IS NULL OR I.HoraInicio = I.HoraFim THEN NULL
            WHEN TRY_CAST(I.HoraInicio AS TIME) IS NULL OR TRY_CAST(I.HoraFim AS TIME) IS NULL THEN NULL
            WHEN TRY_CAST(I.HoraFim AS TIME) < TRY_CAST(I.HoraInicio AS TIME) THEN
                1440 + DATEDIFF(MINUTE, TRY_CAST(I.HoraInicio AS TIME), TRY_CAST(I.HoraFim AS TIME))
            ELSE
                DATEDIFF(MINUTE, TRY_CAST(I.HoraInicio AS TIME), TRY_CAST(I.HoraFim AS TIME))
        END
    FROM dbo.ViagensEconomildo V
    INNER JOIN inserted I ON V.VIagemEconomildoId = I.VIagemEconomildoId;
END
GO

--
-- Create foreign key [FK_ViagensEconomildo_MotoristaId] on table [dbo].[ViagensEconomildo]
--
PRINT (N'Create foreign key [FK_ViagensEconomildo_MotoristaId] on table [dbo].[ViagensEconomildo]')
GO
ALTER TABLE dbo.ViagensEconomildo
  ADD CONSTRAINT FK_ViagensEconomildo_MotoristaId FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_ViagensEconomildo_VeiculoId] on table [dbo].[ViagensEconomildo]
--
PRINT (N'Create foreign key [FK_ViagensEconomildo_VeiculoId] on table [dbo].[ViagensEconomildo]')
GO
ALTER TABLE dbo.ViagensEconomildo
  ADD CONSTRAINT FK_ViagensEconomildo_VeiculoId FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create or alter view [dbo].[ViewFluxoEconomildo]
--
GO
PRINT (N'Create or alter view [dbo].[ViewFluxoEconomildo]')
GO
CREATE OR ALTER VIEW dbo.ViewFluxoEconomildo 
AS SELECT TOP 10000000
  ViagensEconomildo.Data
 ,Motorista.Nome AS NomeMotorista
 ,Motorista.TipoCondutor
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,ViagensEconomildo.VIagemEconomildoId
 ,ViagensEconomildo.VeiculoId
 ,ViagensEconomildo.MotoristaId
 ,ViagensEconomildo.MOB
 ,ViagensEconomildo.Responsavel
 ,ViagensEconomildo.IdaVolta
 ,ViagensEconomildo.HoraInicio
 ,ViagensEconomildo.HoraFim
 ,ViagensEconomildo.QtdPassageiros
FROM dbo.Veiculo
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
INNER JOIN dbo.ViagensEconomildo
  ON ViagensEconomildo.VeiculoId = Veiculo.VeiculoId
INNER JOIN dbo.Motorista
  ON ViagensEconomildo.MotoristaId = Motorista.MotoristaId
ORDER BY Data DESC, MOB, HoraInicio DESC
GO

--
-- Create or alter view [dbo].[ViewMotoristaFluxo]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristaFluxo]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristaFluxo 
AS SELECT DISTINCT
  convert(nvarchar(50), ViewFluxoEconomildo.MotoristaId) AS MotoristaId,
  ViewFluxoEconomildo.NomeMotorista
FROM dbo.ViewFluxoEconomildo
GO

--
-- Create table [dbo].[RankingMotoristasMensal]
--
PRINT (N'Create table [dbo].[RankingMotoristasMensal]')
GO
CREATE TABLE dbo.RankingMotoristasMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  TipoRanking varchar(50) NOT NULL,
  Posicao int NOT NULL,
  MotoristaId uniqueidentifier NOT NULL,
  NomeMotorista nvarchar(200) NULL,
  TipoMotorista nvarchar(50) NULL,
  ValorPrincipal decimal(18, 2) NULL DEFAULT (0),
  ValorSecundario decimal(18, 2) NULL DEFAULT (0),
  ValorTerciario decimal(18, 2) NULL DEFAULT (0),
  ValorQuaternario int NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_RankingMot UNIQUE (Ano, Mes, TipoRanking, Posicao)
)
ON [PRIMARY]
GO

--
-- Create index [IX_RankingMot_AnoMesTipo] on table [dbo].[RankingMotoristasMensal]
--
PRINT (N'Create index [IX_RankingMot_AnoMesTipo] on table [dbo].[RankingMotoristasMensal]')
GO
CREATE INDEX IX_RankingMot_AnoMesTipo
  ON dbo.RankingMotoristasMensal (Ano, Mes, TipoRanking)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_RankingMot_Motorista] on table [dbo].[RankingMotoristasMensal]
--
PRINT (N'Create foreign key [FK_RankingMot_Motorista] on table [dbo].[RankingMotoristasMensal]')
GO
ALTER TABLE dbo.RankingMotoristasMensal
  ADD CONSTRAINT FK_RankingMot_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create table [dbo].[MotoristaContrato]
--
PRINT (N'Create table [dbo].[MotoristaContrato]')
GO
CREATE TABLE dbo.MotoristaContrato (
  MotoristaId uniqueidentifier NOT NULL,
  ContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_MotoristaContrato PRIMARY KEY CLUSTERED (MotoristaId, ContratoId)
)
ON [PRIMARY]
GO

--
-- Create foreign key [FK_Contrato_Motorista] on table [dbo].[MotoristaContrato]
--
PRINT (N'Create foreign key [FK_Contrato_Motorista] on table [dbo].[MotoristaContrato]')
GO
ALTER TABLE dbo.MotoristaContrato
  ADD CONSTRAINT FK_Contrato_Motorista FOREIGN KEY (ContratoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create foreign key [FK_Motorista_Contrato] on table [dbo].[MotoristaContrato]
--
PRINT (N'Create foreign key [FK_Motorista_Contrato] on table [dbo].[MotoristaContrato]')
GO
ALTER TABLE dbo.MotoristaContrato
  ADD CONSTRAINT FK_Motorista_Contrato FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create table [dbo].[LotacaoMotorista]
--
PRINT (N'Create table [dbo].[LotacaoMotorista]')
GO
CREATE TABLE dbo.LotacaoMotorista (
  LotacaoMotoristaId uniqueidentifier NOT NULL,
  MotoristaId uniqueidentifier NULL,
  UnidadeId uniqueidentifier NULL,
  DataInicio date NULL,
  DataFim date NULL,
  Lotado bit NULL,
  Motivo varchar(50) NULL,
  MotoristaCoberturaId uniqueidentifier NULL,
  CONSTRAINT PK_LotacaoMotorista_LotacaoMotoristaId PRIMARY KEY CLUSTERED (LotacaoMotoristaId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_LotacaoMotorista_MotoristaId_UnidadeId] on table [dbo].[LotacaoMotorista]
--
PRINT (N'Create index [IX_LotacaoMotorista_MotoristaId_UnidadeId] on table [dbo].[LotacaoMotorista]')
GO
CREATE INDEX IX_LotacaoMotorista_MotoristaId_UnidadeId
  ON dbo.LotacaoMotorista (MotoristaId, UnidadeId)
  INCLUDE (LotacaoMotoristaId, DataInicio, DataFim, Lotado)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_LotacaoMotorista_UnidadeId] on table [dbo].[LotacaoMotorista]
--
PRINT (N'Create index [IX_LotacaoMotorista_UnidadeId] on table [dbo].[LotacaoMotorista]')
GO
CREATE INDEX IX_LotacaoMotorista_UnidadeId
  ON dbo.LotacaoMotorista (UnidadeId)
  INCLUDE (LotacaoMotoristaId, MotoristaId, DataInicio, DataFim, Lotado)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_LotacaoMotorista_MotoristaId] on table [dbo].[LotacaoMotorista]
--
PRINT (N'Create foreign key [FK_LotacaoMotorista_MotoristaId] on table [dbo].[LotacaoMotorista]')
GO
ALTER TABLE dbo.LotacaoMotorista
  ADD CONSTRAINT FK_LotacaoMotorista_MotoristaId FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_LotacaoMotorista_UnidadeId] on table [dbo].[LotacaoMotorista]
--
PRINT (N'Create foreign key [FK_LotacaoMotorista_UnidadeId] on table [dbo].[LotacaoMotorista]')
GO
ALTER TABLE dbo.LotacaoMotorista
  ADD CONSTRAINT FK_LotacaoMotorista_UnidadeId FOREIGN KEY (UnidadeId) REFERENCES dbo.Unidade (UnidadeId)
GO

--
-- Create or alter view [dbo].[ViewLotacoes]
--
GO
PRINT (N'Create or alter view [dbo].[ViewLotacoes]')
GO
CREATE OR ALTER VIEW dbo.ViewLotacoes 
AS SELECT
  Unidade.Categoria AS NomeCategoria
 ,Unidade.Descricao + ' ('+ Unidade.Sigla + ')' AS Unidade
 ,Motorista.Nome AS Motorista
 ,CONVERT(VARCHAR, LotacaoMotorista.DataInicio, 103) AS DataInicio
 ,LotacaoMotorista.LotacaoMotoristaId
 ,LotacaoMotorista.Lotado
 ,Motorista.MotoristaId
 ,Unidade.UnidadeId
FROM dbo.LotacaoMotorista
INNER JOIN dbo.Unidade
  ON LotacaoMotorista.UnidadeId = Unidade.UnidadeId
INNER JOIN dbo.Motorista
  ON LotacaoMotorista.MotoristaId = Motorista.MotoristaId
GO

--
-- Create or alter view [dbo].[ViewLotacaoMotorista]
--
GO
PRINT (N'Create or alter view [dbo].[ViewLotacaoMotorista]')
GO
CREATE OR ALTER VIEW dbo.ViewLotacaoMotorista 
AS SELECT TOP 1000000
  Unidade.UnidadeId
 ,LotacaoMotorista.LotacaoMotoristaId
 ,Motorista.MotoristaId
 ,LotacaoMotorista.Lotado
 ,LotacaoMotorista.Motivo
 ,Unidade.Descricao AS Unidade
 ,CONVERT(VARCHAR, LotacaoMotorista.DataInicio, 103) AS DataInicial
 ,CONVERT(VARCHAR, LotacaoMotorista.DataFim, 103) AS DataFim
 ,Motorista_1.Nome AS MotoristaCobertura
FROM dbo.LotacaoMotorista
LEFT OUTER JOIN dbo.Unidade
  ON LotacaoMotorista.UnidadeId = Unidade.UnidadeId
INNER JOIN dbo.Motorista
  ON LotacaoMotorista.MotoristaId = Motorista.MotoristaId
LEFT OUTER JOIN dbo.Motorista Motorista_1
  ON Motorista_1.MotoristaId = LotacaoMotorista.MotoristaCoberturaId
ORDER BY LotacaoMotorista.DataInicio DESC
GO

--
-- Create table [dbo].[Lavagem]
--
PRINT (N'Create table [dbo].[Lavagem]')
GO
CREATE TABLE dbo.Lavagem (
  LavagemId uniqueidentifier NOT NULL DEFAULT (newid()),
  VeiculoId uniqueidentifier NULL,
  MotoristaId uniqueidentifier NULL,
  HorarioInicio datetime NULL,
  HorarioFim datetime NULL,
  Data datetime NULL,
  CONSTRAINT PK_Lavagem_LavagemId PRIMARY KEY CLUSTERED (LavagemId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_Lavagem_Data] on table [dbo].[Lavagem]
--
PRINT (N'Create index [IX_Lavagem_Data] on table [dbo].[Lavagem]')
GO
CREATE INDEX IX_Lavagem_Data
  ON dbo.Lavagem (Data)
  INCLUDE (VeiculoId, MotoristaId, HorarioInicio)
  ON [PRIMARY]
GO

--
-- Create index [IX_Lavagem_MotoristaId] on table [dbo].[Lavagem]
--
PRINT (N'Create index [IX_Lavagem_MotoristaId] on table [dbo].[Lavagem]')
GO
CREATE INDEX IX_Lavagem_MotoristaId
  ON dbo.Lavagem (MotoristaId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Lavagem_VeiculoId] on table [dbo].[Lavagem]
--
PRINT (N'Create index [IX_Lavagem_VeiculoId] on table [dbo].[Lavagem]')
GO
CREATE INDEX IX_Lavagem_VeiculoId
  ON dbo.Lavagem (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_Lavagem_MotoristaId] on table [dbo].[Lavagem]
--
PRINT (N'Create foreign key [FK_Lavagem_MotoristaId] on table [dbo].[Lavagem]')
GO
ALTER TABLE dbo.Lavagem
  ADD CONSTRAINT FK_Lavagem_MotoristaId FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_Lavagem_VeiculoId] on table [dbo].[Lavagem]
--
PRINT (N'Create foreign key [FK_Lavagem_VeiculoId] on table [dbo].[Lavagem]')
GO
ALTER TABLE dbo.Lavagem
  ADD CONSTRAINT FK_Lavagem_VeiculoId FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create table [dbo].[LavadoresLavagem]
--
PRINT (N'Create table [dbo].[LavadoresLavagem]')
GO
CREATE TABLE dbo.LavadoresLavagem (
  LavagemId uniqueidentifier NOT NULL,
  LavadorId uniqueidentifier NOT NULL,
  CONSTRAINT PK_LavadoresLavagem PRIMARY KEY CLUSTERED (LavagemId, LavadorId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_LavadoresLavagem_LavadorId] on table [dbo].[LavadoresLavagem]
--
PRINT (N'Create index [IX_LavadoresLavagem_LavadorId] on table [dbo].[LavadoresLavagem]')
GO
CREATE INDEX IX_LavadoresLavagem_LavadorId
  ON dbo.LavadoresLavagem (LavadorId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_LavadoresLavagem_LavadorId] on table [dbo].[LavadoresLavagem]
--
PRINT (N'Create foreign key [FK_LavadoresLavagem_LavadorId] on table [dbo].[LavadoresLavagem]')
GO
ALTER TABLE dbo.LavadoresLavagem
  ADD CONSTRAINT FK_LavadoresLavagem_LavadorId FOREIGN KEY (LavadorId) REFERENCES dbo.Lavador (LavadorId)
GO

--
-- Create foreign key [FK_LavadoresLavagem_LavagemId] on table [dbo].[LavadoresLavagem]
--
PRINT (N'Create foreign key [FK_LavadoresLavagem_LavagemId] on table [dbo].[LavadoresLavagem]')
GO
ALTER TABLE dbo.LavadoresLavagem
  ADD CONSTRAINT FK_LavadoresLavagem_LavagemId FOREIGN KEY (LavagemId) REFERENCES dbo.Lavagem (LavagemId)
GO

--
-- Create or alter view [dbo].[ViewLavagem]
--
GO
PRINT (N'Create or alter view [dbo].[ViewLavagem]')
GO
CREATE OR ALTER VIEW dbo.ViewLavagem 
AS SELECT
  Lavagem.LavagemId
  ,Lavagem.VeiculoId
  ,Lavagem.MotoristaId
 ,CONVERT(VARCHAR, Lavagem.Data, 103) AS Data
 ,CONVERT(VARCHAR, Lavagem.Horario, 8) AS Horario
 ,STRING_AGG(Lavador.Nome, ',') AS Lavadores
 ,STRING_AGG(convert(nvarchar(50),Lavador.LavadorId), ',') AS LavadoresId
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,Motorista.Nome
FROM dbo.LavadoresLavagem
LEFT OUTER JOIN dbo.Lavador
  ON LavadoresLavagem.LavadorId = Lavador.LavadorId
RIGHT OUTER JOIN dbo.Lavagem
  ON LavadoresLavagem.LavagemId = Lavagem.LavagemId
LEFT OUTER JOIN dbo.Veiculo
  ON Lavagem.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
LEFT OUTER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
LEFT OUTER JOIN dbo.Motorista
  ON Lavagem.MotoristaId = Motorista.MotoristaId
GROUP BY Lavagem.LavagemId
        ,Lavagem.VeiculoId
        ,Lavagem.MotoristaId
        ,Lavagem.Data
        ,Lavagem.Horario
        ,Veiculo.Placa
        ,MarcaVeiculo.DescricaoMarca
        ,ModeloVeiculo.DescricaoModelo
        ,Motorista.Nome
GO

--
-- Create table [dbo].[EstatisticaMotoristasMensal]
--
PRINT (N'Create table [dbo].[EstatisticaMotoristasMensal]')
GO
CREATE TABLE dbo.EstatisticaMotoristasMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  MotoristaId uniqueidentifier NOT NULL,
  Ano int NOT NULL,
  Mes int NOT NULL,
  TotalViagens int NULL DEFAULT (0),
  KmTotal decimal(18, 2) NULL DEFAULT (0),
  MinutosTotais int NULL DEFAULT (0),
  TotalMultas int NULL DEFAULT (0),
  ValorTotalMultas decimal(18, 2) NULL DEFAULT (0),
  TotalAbastecimentos int NULL DEFAULT (0),
  LitrosTotais decimal(18, 2) NULL DEFAULT (0),
  ValorTotalAbastecimentos decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatMotMensal UNIQUE (MotoristaId, Ano, Mes)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatMotMensal_AnoMes] on table [dbo].[EstatisticaMotoristasMensal]
--
PRINT (N'Create index [IX_EstatMotMensal_AnoMes] on table [dbo].[EstatisticaMotoristasMensal]')
GO
CREATE INDEX IX_EstatMotMensal_AnoMes
  ON dbo.EstatisticaMotoristasMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatMotMensal_Motorista] on table [dbo].[EstatisticaMotoristasMensal]
--
PRINT (N'Create index [IX_EstatMotMensal_Motorista] on table [dbo].[EstatisticaMotoristasMensal]')
GO
CREATE INDEX IX_EstatMotMensal_Motorista
  ON dbo.EstatisticaMotoristasMensal (MotoristaId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_EstatMotMensal_Motorista] on table [dbo].[EstatisticaMotoristasMensal]
--
PRINT (N'Create foreign key [FK_EstatMotMensal_Motorista] on table [dbo].[EstatisticaMotoristasMensal]')
GO
ALTER TABLE dbo.EstatisticaMotoristasMensal
  ADD CONSTRAINT FK_EstatMotMensal_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create table [dbo].[AbastecimentoPendente]')
GO
CREATE TABLE dbo.AbastecimentoPendente (
  AbastecimentoPendenteId uniqueidentifier NOT NULL,
  AutorizacaoQCard int NULL,
  Placa nvarchar(20) NULL,
  CodMotorista int NULL,
  NomeMotorista nvarchar(200) NULL,
  Produto nvarchar(100) NULL,
  DataHora datetime2 NULL,
  KmAnterior int NULL,
  Km int NULL,
  KmRodado int NULL,
  Litros float NULL,
  ValorUnitario float NULL,
  VeiculoId uniqueidentifier NULL,
  MotoristaId uniqueidentifier NULL,
  CombustivelId uniqueidentifier NULL,
  DescricaoPendencia nvarchar(2000) NULL,
  TipoPendencia nvarchar(50) NULL,
  TemSugestao bit NOT NULL DEFAULT (0),
  CampoCorrecao nvarchar(20) NULL,
  ValorAtualErrado int NULL,
  ValorSugerido int NULL,
  JustificativaSugestao nvarchar(500) NULL,
  MediaConsumoVeiculo float NULL,
  DataImportacao datetime2 NOT NULL,
  NumeroLinhaOriginal int NOT NULL DEFAULT (0),
  ArquivoOrigem nvarchar(255) NULL,
  Status int NOT NULL DEFAULT (0),
  CONSTRAINT PK_AbastecimentoPendente PRIMARY KEY CLUSTERED (AbastecimentoPendenteId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_AbastecimentoPendente_AutorizacaoQCard] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create index [IX_AbastecimentoPendente_AutorizacaoQCard] on table [dbo].[AbastecimentoPendente]')
GO
CREATE UNIQUE INDEX IX_AbastecimentoPendente_AutorizacaoQCard
  ON dbo.AbastecimentoPendente (AutorizacaoQCard)
  WHERE ([AutorizacaoQCard] IS NOT NULL AND [Status]=(0))
  ON [PRIMARY]
GO

--
-- Create index [IX_AbastecimentoPendente_DataImportacao] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create index [IX_AbastecimentoPendente_DataImportacao] on table [dbo].[AbastecimentoPendente]')
GO
CREATE INDEX IX_AbastecimentoPendente_DataImportacao
  ON dbo.AbastecimentoPendente (DataImportacao DESC, Status)
  ON [PRIMARY]
GO

--
-- Create index [IX_AbastecimentoPendente_Status] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create index [IX_AbastecimentoPendente_Status] on table [dbo].[AbastecimentoPendente]')
GO
CREATE INDEX IX_AbastecimentoPendente_Status
  ON dbo.AbastecimentoPendente (Status)
  INCLUDE (DataImportacao, TipoPendencia)
  ON [PRIMARY]
GO

--
-- Create index [IX_AbastecimentoPendente_TipoPendencia] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create index [IX_AbastecimentoPendente_TipoPendencia] on table [dbo].[AbastecimentoPendente]')
GO
CREATE INDEX IX_AbastecimentoPendente_TipoPendencia
  ON dbo.AbastecimentoPendente (TipoPendencia, Status)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_AbastecimentoPendente_Combustivel] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create foreign key [FK_AbastecimentoPendente_Combustivel] on table [dbo].[AbastecimentoPendente]')
GO
ALTER TABLE dbo.AbastecimentoPendente
  ADD CONSTRAINT FK_AbastecimentoPendente_Combustivel FOREIGN KEY (CombustivelId) REFERENCES dbo.Combustivel (CombustivelId)
GO

--
-- Create foreign key [FK_AbastecimentoPendente_Motorista] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create foreign key [FK_AbastecimentoPendente_Motorista] on table [dbo].[AbastecimentoPendente]')
GO
ALTER TABLE dbo.AbastecimentoPendente
  ADD CONSTRAINT FK_AbastecimentoPendente_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_AbastecimentoPendente_Veiculo] on table [dbo].[AbastecimentoPendente]
--
PRINT (N'Create foreign key [FK_AbastecimentoPendente_Veiculo] on table [dbo].[AbastecimentoPendente]')
GO
ALTER TABLE dbo.AbastecimentoPendente
  ADD CONSTRAINT FK_AbastecimentoPendente_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create table [dbo].[EstatisticaGeralMensal]
--
PRINT (N'Create table [dbo].[EstatisticaGeralMensal]')
GO
CREATE TABLE dbo.EstatisticaGeralMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  TotalMotoristas int NULL DEFAULT (0),
  MotoristasAtivos int NULL DEFAULT (0),
  MotoristasInativos int NULL DEFAULT (0),
  Efetivos int NULL DEFAULT (0),
  Feristas int NULL DEFAULT (0),
  Cobertura int NULL DEFAULT (0),
  TotalViagens int NULL DEFAULT (0),
  KmTotal decimal(18, 2) NULL DEFAULT (0),
  HorasTotais decimal(18, 2) NULL DEFAULT (0),
  TotalMultas int NULL DEFAULT (0),
  ValorTotalMultas decimal(18, 2) NULL DEFAULT (0),
  TotalAbastecimentos int NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatGeralMensal UNIQUE (Ano, Mes)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatGeralMensal_AnoMes] on table [dbo].[EstatisticaGeralMensal]
--
PRINT (N'Create index [IX_EstatGeralMensal_AnoMes] on table [dbo].[EstatisticaGeralMensal]')
GO
CREATE INDEX IX_EstatGeralMensal_AnoMes
  ON dbo.EstatisticaGeralMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[Multa]
--
PRINT (N'Create table [dbo].[Multa]')
GO
CREATE TABLE dbo.Multa (
  MultaId uniqueidentifier NOT NULL DEFAULT (newid()),
  Data datetime NOT NULL,
  Hora datetime NOT NULL,
  Localizacao varchar(200) NOT NULL,
  Vencimento datetime NULL,
  ValorAteVencimento float NULL CONSTRAINT DF_Multa_ValorAteVencimento2 DEFAULT (0),
  ValorPosVencimento float NULL CONSTRAINT DF_Multa_ValorPosVencimento2 DEFAULT (0),
  Observacao varchar(max) NULL CONSTRAINT DF_Multa_Observacao2 DEFAULT (''),
  AutuacaoPDF varchar(max) NULL CONSTRAINT DF_Multa_AutuacaoPDF2 DEFAULT (''),
  PenalidadePDF varchar(max) NULL CONSTRAINT DF_Multa_PenalidadePDF2 DEFAULT (''),
  Paga bit NOT NULL,
  EnviadaSecle bit NOT NULL,
  MotoristaId uniqueidentifier NULL,
  VeiculoId uniqueidentifier NULL,
  OrgaoAutuanteId uniqueidentifier NULL,
  TipoMultaId uniqueidentifier NULL,
  EmpenhoMultaId uniqueidentifier NULL,
  Fase varchar(50) NULL CONSTRAINT DF_Multa_Fase2 DEFAULT (''),
  ProcessoEDoc varchar(50) NULL CONSTRAINT DF_Multa_ProcessoEDoc2 DEFAULT (''),
  NumInfracao varchar(50) NULL,
  Status varchar(50) NULL CONSTRAINT DF_Multa_Status2 DEFAULT (''),
  DataNotificacao datetime NULL,
  DataLimite datetime NULL,
  ContratoVeiculoId uniqueidentifier NULL,
  ContratoMotoristaId uniqueidentifier NULL,
  NoFichaVistoria int NULL CONSTRAINT DF_Multa_NoFichaVistoria2 DEFAULT (0),
  ComprovantePDF varchar(max) NULL CONSTRAINT DF_Multa_ComprovantePDF2 DEFAULT (''),
  DataPagamento datetime NULL,
  ValorPago float NULL CONSTRAINT DF_Multa_ValorPago2 DEFAULT (0),
  FormaPagamento varchar(50) NULL CONSTRAINT DF_Multa_FormaPagamento2 DEFAULT (''),
  AtaVeiculoId uniqueidentifier NULL,
  ProcessoEdocPDF varchar(max) NULL,
  OutrosDocumentosPDF varchar(max) NULL,
  CONSTRAINT PK_Multas_id_multa PRIMARY KEY CLUSTERED (MultaId),
  CONSTRAINT KEY_NumInfracao UNIQUE (NumInfracao)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_Multa_Data_Completo] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_Data_Completo] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_Data_Completo
  ON dbo.Multa (Data DESC)
  INCLUDE (MultaId, VeiculoId, MotoristaId, Status, Fase, ValorAteVencimento, OrgaoAutuanteId, TipoMultaId, NumInfracao, AutuacaoPDF, PenalidadePDF, ComprovantePDF)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Multa_Data_MotoristaId] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_Data_MotoristaId] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_Data_MotoristaId
  ON dbo.Multa (Data, MotoristaId)
  INCLUDE (ValorAteVencimento)
  ON [PRIMARY]
GO

--
-- Create index [IX_Multa_MotoristaId] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_MotoristaId] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_MotoristaId
  ON dbo.Multa (MotoristaId)
  INCLUDE (VeiculoId, Status, Data, ValorAteVencimento, NumInfracao)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Multa_OrgaoAutuanteId] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_OrgaoAutuanteId] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_OrgaoAutuanteId
  ON dbo.Multa (OrgaoAutuanteId)
  INCLUDE (Status, Data, ValorAteVencimento)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Multa_Status_Data] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_Status_Data] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_Status_Data
  ON dbo.Multa (Status, Data DESC)
  INCLUDE (VeiculoId, MotoristaId, ValorAteVencimento, NumInfracao, Fase)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Multa_TipoMultaId] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_TipoMultaId] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_TipoMultaId
  ON dbo.Multa (TipoMultaId)
  INCLUDE (Status, Data, ValorAteVencimento)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Multa_VeiculoId] on table [dbo].[Multa]
--
PRINT (N'Create index [IX_Multa_VeiculoId] on table [dbo].[Multa]')
GO
CREATE INDEX IX_Multa_VeiculoId
  ON dbo.Multa (VeiculoId)
  INCLUDE (MotoristaId, Status, Data, ValorAteVencimento, NumInfracao)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create or alter trigger [trg_Multa_AtualizarEstatisticasMotoristas] on table [dbo].[Multa]
--
GO
PRINT (N'Create or alter trigger [trg_Multa_AtualizarEstatisticasMotoristas] on table [dbo].[Multa]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Multa_AtualizarEstatisticasMotoristas
ON Multa
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Afetados TABLE (MotoristaId UNIQUEIDENTIFIER, Ano INT, Mes INT);

    INSERT INTO @Afetados (MotoristaId, Ano, Mes)
    SELECT DISTINCT MotoristaId, YEAR(Data), MONTH(Data)
    FROM inserted
    WHERE MotoristaId IS NOT NULL AND Data IS NOT NULL;

    INSERT INTO @Afetados (MotoristaId, Ano, Mes)
    SELECT DISTINCT MotoristaId, YEAR(Data), MONTH(Data)
    FROM deleted
    WHERE MotoristaId IS NOT NULL AND Data IS NOT NULL
      AND NOT EXISTS (
          SELECT 1 FROM @Afetados a
          WHERE a.MotoristaId = deleted.MotoristaId
            AND a.Ano = YEAR(deleted.Data)
            AND a.Mes = MONTH(deleted.Data)
      );

    DECLARE @MotoristaId UNIQUEIDENTIFIER, @Ano INT, @Mes INT;
    DECLARE cur CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT MotoristaId, Ano, Mes FROM @Afetados;

    OPEN cur;
    FETCH NEXT FROM cur INTO @MotoristaId, @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Atualiza apenas multas do motorista
        UPDATE e
        SET e.TotalMultas = ISNULL(m.Total, 0),
            e.ValorTotalMultas = ISNULL(m.Valor, 0),
            e.DataAtualizacao = GETDATE()
        FROM EstatisticaMotoristasMensal e
        LEFT JOIN (
            SELECT COUNT(*) as Total, SUM(ISNULL(ValorAteVencimento, 0)) as Valor
            FROM Multa
            WHERE MotoristaId = @MotoristaId
              AND YEAR(Data) = @Ano AND MONTH(Data) = @Mes
        ) m ON 1=1
        WHERE e.MotoristaId = @MotoristaId AND e.Ano = @Ano AND e.Mes = @Mes;

        -- Atualiza estatísticas gerais de multas
        UPDATE EstatisticaGeralMensal
        SET TotalMultas = ISNULL((SELECT SUM(TotalMultas) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
            ValorTotalMultas = ISNULL((SELECT SUM(ValorTotalMultas) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
            DataAtualizacao = GETDATE()
        WHERE Ano = @Ano AND Mes = @Mes;

        FETCH NEXT FROM cur INTO @MotoristaId, @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;
END
GO

--
-- Create foreign key [FK_Multa_AtaVeiculoId] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_Multa_AtaVeiculoId] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_Multa_AtaVeiculoId FOREIGN KEY (AtaVeiculoId) REFERENCES dbo.AtaRegistroPrecos (AtaId)
GO

--
-- Create foreign key [FK_MultaContratoMotorista] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaContratoMotorista] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaContratoMotorista FOREIGN KEY (ContratoMotoristaId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create foreign key [FK_MultaContratoVeiculo] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaContratoVeiculo] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaContratoVeiculo FOREIGN KEY (ContratoVeiculoId) REFERENCES dbo.Contrato (ContratoId)
GO

--
-- Create foreign key [FK_MultaEmpenho] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaEmpenho] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaEmpenho FOREIGN KEY (EmpenhoMultaId) REFERENCES dbo.EmpenhoMulta (EmpenhoMultaId)
GO

--
-- Create foreign key [FK_MultaMotorista] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaMotorista] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaMotorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_MultaOrgaoAutuante] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaOrgaoAutuante] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaOrgaoAutuante FOREIGN KEY (OrgaoAutuanteId) REFERENCES dbo.OrgaoAutuante (OrgaoAutuanteId)
GO

--
-- Create foreign key [FK_MultaTipoMulta] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaTipoMulta] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaTipoMulta FOREIGN KEY (TipoMultaId) REFERENCES dbo.TipoMulta (TipoMultaId)
GO

--
-- Create foreign key [FK_MultaVeiculo] on table [dbo].[Multa]
--
PRINT (N'Create foreign key [FK_MultaVeiculo] on table [dbo].[Multa]')
GO
ALTER TABLE dbo.Multa
  ADD CONSTRAINT FK_MultaVeiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Add extended property [MS_Description] on table [dbo].[Multa]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Multa]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Multas de Trânsito', 'SCHEMA', N'dbo', 'TABLE', N'Multa'
GO

--
-- Add extended property [MS_Description] on column [dbo].[Multa].[Status]
--
PRINT (N'Add extended property [MS_Description] on column [dbo].[Multa].[Status]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', 'Pendente, Notificado, Reconhecido', 'SCHEMA', N'dbo', 'TABLE', N'Multa', 'COLUMN', N'Status'
GO

--
-- Create or alter view [dbo].[ViewMultas]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMultas]')
GO
CREATE OR ALTER VIEW dbo.ViewMultas 
AS SELECT TOP 100000
  Multa.MultaId
 ,Multa.NumInfracao
 ,Multa.Data AS DataOriginal
 ,CONVERT(VARCHAR, Multa.Data, 103) AS Data
 ,FORMAT(Multa.Hora, 'HH:mm') AS Hora
 ,(Motorista.Nome + ' - (' + Motorista.TipoCondutor + ')') AS Nome
 ,Motorista.MotoristaId
 ,CASE
    WHEN Motorista.Celular02 IS NULL THEN Motorista.Celular01
    ELSE (Motorista.Celular01 + ' / ' + Motorista.Celular02) 
  END AS Telefone
 ,Veiculo.Placa
 ,Veiculo.VeiculoId
 ,OrgaoAutuante.Sigla
 ,OrgaoAutuante.OrgaoAutuanteId
 ,Multa.Localizacao
 ,TipoMulta.Artigo
 ,CONVERT(VARCHAR, Multa.Vencimento, 103) AS Vencimento
 ,Multa.AutuacaoPDF
 ,Multa.PenalidadePDF
 ,Multa.ValorAteVencimento
 ,Multa.ComprovantePDF
 ,Multa.ValorPosVencimento
 ,Multa.ProcessoEDoc
 ,Multa.Status
 ,Multa.Fase
 ,TipoMulta.Descricao
 ,Multa.Observacao
 ,Multa.Paga
 ,Multa.ValorPago
 ,Multa.TipoMultaId
 ,CONVERT(VARCHAR, Multa.DataPagamento, 103) AS DataPagamento
FROM dbo.Multa
LEFT OUTER JOIN dbo.Motorista
  ON Multa.MotoristaId = Motorista.MotoristaId
LEFT OUTER JOIN dbo.Veiculo
  ON Multa.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.OrgaoAutuante
  ON Multa.OrgaoAutuanteId = OrgaoAutuante.OrgaoAutuanteId
LEFT OUTER JOIN dbo.TipoMulta
  ON Multa.TipoMultaId = TipoMulta.TipoMultaId
LEFT OUTER JOIN dbo.EmpenhoMulta
  ON Multa.EmpenhoMultaId = EmpenhoMulta.EmpenhoMultaId
    AND EmpenhoMulta.OrgaoAutuanteId = OrgaoAutuante.OrgaoAutuanteId
ORDER BY DataOriginal DESC
GO

--
-- Create or alter view [dbo].[ViewMotoristasMulta]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMotoristasMulta]')
GO
CREATE OR ALTER VIEW dbo.ViewMotoristasMulta 
AS SELECT TOP 1000000
  Motorista.Nome
 ,SUM(Multa.ValorPago) AS 'Valor Pago'
 ,SUM(Multa.ValorPosVencimento) AS 'Valor a Pagar'
FROM dbo.Multa
INNER JOIN dbo.Motorista
  ON Multa.MotoristaId = Motorista.MotoristaId
GROUP BY Motorista.Nome
ORDER BY SUM(Multa.ValorPosVencimento) DESC
GO

--
-- Create or alter view [dbo].[ViewEmpenhoMulta]
--
GO
PRINT (N'Create or alter view [dbo].[ViewEmpenhoMulta]')
GO
CREATE OR ALTER VIEW dbo.ViewEmpenhoMulta 
AS SELECT
  EmpenhoMulta.EmpenhoMultaId,
  EmpenhoMulta.NotaEmpenho,
  EmpenhoMulta.AnoVigencia,
  EmpenhoMulta.SaldoInicial,
  EmpenhoMulta.SaldoAtual,
  EmpenhoMulta.OrgaoAutuanteId,
  COUNT(DISTINCT MovimentacaoEmpenhoMulta.MovimentacaoId) AS Movimentacoes,
  SUM(DISTINCT MovimentacaoEmpenhoMulta.Valor) AS SaldoMovimentacao,
  SUM(DISTINCT Multa.ValorPago) AS SaldoMultas
FROM dbo.EmpenhoMulta
LEFT OUTER JOIN dbo.MovimentacaoEmpenhoMulta
  ON EmpenhoMulta.EmpenhoMultaId = MovimentacaoEmpenhoMulta.EmpenhoMultaId 
LEFT OUTER JOIN dbo.Multa
  ON EmpenhoMulta.EmpenhoMultaId = Multa.EmpenhoMultaId
GROUP BY EmpenhoMulta.EmpenhoMultaId, EmpenhoMulta.NotaEmpenho, EmpenhoMulta.AnoVigencia, EmpenhoMulta.SaldoInicial, EmpenhoMulta.SaldoAtual, EmpenhoMulta.OrgaoAutuanteId
GO

--
-- Create or alter view [dbo].[ViewEdocMultas]
--
GO
PRINT (N'Create or alter view [dbo].[ViewEdocMultas]')
GO
CREATE OR ALTER VIEW dbo.ViewEdocMultas 
AS SELECT
  Multa.MultaId
 ,Multa.NumInfracao
 ,CONVERT(VARCHAR, Multa.Data, 103) AS Data
 ,FORMAT(Multa.Hora, 'HH:mm') AS Hora
 ,Motorista.Nome
 ,Motorista.MotoristaId
 ,CASE
    WHEN Motorista.Celular02 IS NULL THEN Motorista.Celular01
    ELSE Motorista.Celular01 + ' / ' + Motorista.Celular02
  END AS Telefone
 ,Veiculo.Placa
 ,Veiculo.VeiculoId
 ,OrgaoAutuante.Sigla
 ,OrgaoAutuante.OrgaoAutuanteId
 ,Multa.Localizacao
 ,TipoMulta.Artigo
 ,CONVERT(VARCHAR, Multa.Vencimento, 103) AS Vencimento
 ,Multa.ValorAteVencimento
 ,Multa.ValorPosVencimento
 ,Multa.ProcessoEDoc
 ,Multa.Status
 ,Multa.Fase
 ,TipoMulta.Descricao
 ,Multa.Observacao
 ,Multa.Paga
 ,Motorista.Ponto
 ,Contrato.AnoContrato + '/' + Contrato.NumeroContrato AS NumContrato
 ,CASE
    WHEN Multa.Paga = -1 THEN 'Pago'
  END AS Pago
 ,Fornecedor.DescricaoFornecedor
FROM dbo.Multa
LEFT OUTER JOIN dbo.Motorista
  ON Multa.MotoristaId = Motorista.MotoristaId
LEFT OUTER JOIN dbo.Veiculo
  ON Multa.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.OrgaoAutuante
  ON Multa.OrgaoAutuanteId = OrgaoAutuante.OrgaoAutuanteId
LEFT OUTER JOIN dbo.TipoMulta
  ON Multa.TipoMultaId = TipoMulta.TipoMultaId
LEFT OUTER JOIN dbo.EmpenhoMulta
  ON Multa.EmpenhoMultaId = EmpenhoMulta.EmpenhoMultaId
    AND EmpenhoMulta.OrgaoAutuanteId = OrgaoAutuante.OrgaoAutuanteId
LEFT OUTER JOIN dbo.Contrato
  ON Multa.ContratoMotoristaId = Contrato.ContratoId
LEFT OUTER JOIN dbo.Fornecedor
  ON Contrato.FornecedorId = Fornecedor.FornecedorId
GO

--
-- Create table [dbo].[Abastecimento]
--
PRINT (N'Create table [dbo].[Abastecimento]')
GO
CREATE TABLE dbo.Abastecimento (
  AbastecimentoId uniqueidentifier NOT NULL DEFAULT (newid()),
  VeiculoId uniqueidentifier NOT NULL,
  CombustivelId uniqueidentifier NOT NULL,
  MotoristaId uniqueidentifier NOT NULL,
  Litros float NOT NULL,
  ValorUnitario float NOT NULL,
  DataHora datetime NOT NULL,
  KmRodado int NOT NULL,
  Hodometro int NOT NULL,
  AutorizacaoQCard int NULL DEFAULT (0),
  KmRodadoNormalizado int NULL,
  LitrosNormalizado float NULL,
  ConsumoCalculado decimal(18, 2) NULL,
  ConsumoNormalizado decimal(18, 2) NULL,
  EhOutlier bit NULL DEFAULT (0),
  CONSTRAINT PK_Abastecimento_AbastecimentoId PRIMARY KEY CLUSTERED (AbastecimentoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_Abastecimento_DataHora_MotoristaId] on table [dbo].[Abastecimento]
--
PRINT (N'Create index [IX_Abastecimento_DataHora_MotoristaId] on table [dbo].[Abastecimento]')
GO
CREATE INDEX IX_Abastecimento_DataHora_MotoristaId
  ON dbo.Abastecimento (DataHora, MotoristaId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Abastecimento_VeiculoId_DataHora] on table [dbo].[Abastecimento]
--
PRINT (N'Create index [IX_Abastecimento_VeiculoId_DataHora] on table [dbo].[Abastecimento]')
GO
CREATE INDEX IX_Abastecimento_VeiculoId_DataHora
  ON dbo.Abastecimento (VeiculoId, DataHora DESC)
  INCLUDE (ValorUnitario)
  ON [PRIMARY]
GO

--
-- Create or alter trigger [trg_Abastecimento_AtualizarEstatisticasMotoristas] on table [dbo].[Abastecimento]
--
GO
PRINT (N'Create or alter trigger [trg_Abastecimento_AtualizarEstatisticasMotoristas] on table [dbo].[Abastecimento]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Abastecimento_AtualizarEstatisticasMotoristas
ON Abastecimento
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Afetados TABLE (MotoristaId UNIQUEIDENTIFIER, Ano INT, Mes INT);

    INSERT INTO @Afetados (MotoristaId, Ano, Mes)
    SELECT DISTINCT MotoristaId, YEAR(DataHora), MONTH(DataHora)
    FROM inserted
    WHERE MotoristaId IS NOT NULL
      AND MotoristaId <> '00000000-0000-0000-0000-000000000000'
      AND DataHora IS NOT NULL;

    INSERT INTO @Afetados (MotoristaId, Ano, Mes)
    SELECT DISTINCT MotoristaId, YEAR(DataHora), MONTH(DataHora)
    FROM deleted
    WHERE MotoristaId IS NOT NULL
      AND MotoristaId <> '00000000-0000-0000-0000-000000000000'
      AND DataHora IS NOT NULL
      AND NOT EXISTS (
          SELECT 1 FROM @Afetados a
          WHERE a.MotoristaId = deleted.MotoristaId
            AND a.Ano = YEAR(deleted.DataHora)
            AND a.Mes = MONTH(deleted.DataHora)
      );

    DECLARE @MotoristaId UNIQUEIDENTIFIER, @Ano INT, @Mes INT;
    DECLARE cur CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT MotoristaId, Ano, Mes FROM @Afetados;

    OPEN cur;
    FETCH NEXT FROM cur INTO @MotoristaId, @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Atualiza apenas abastecimentos do motorista
        UPDATE e
        SET e.TotalAbastecimentos = ISNULL(a.Total, 0),
            e.LitrosTotais = ISNULL(a.Litros, 0),
            e.ValorTotalAbastecimentos = ISNULL(a.Valor, 0),
            e.DataAtualizacao = GETDATE()
        FROM EstatisticaMotoristasMensal e
        LEFT JOIN (
            SELECT COUNT(*) as Total,
                   SUM(ISNULL(Litros, 0)) as Litros,
                   SUM(ISNULL(Litros, 0) * ISNULL(ValorUnitario, 0)) as Valor
            FROM Abastecimento
            WHERE MotoristaId = @MotoristaId
              AND YEAR(DataHora) = @Ano AND MONTH(DataHora) = @Mes
        ) a ON 1=1
        WHERE e.MotoristaId = @MotoristaId AND e.Ano = @Ano AND e.Mes = @Mes;

        -- Atualiza estatísticas gerais de abastecimentos
        UPDATE EstatisticaGeralMensal
        SET TotalAbastecimentos = ISNULL((SELECT SUM(TotalAbastecimentos) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
            DataAtualizacao = GETDATE()
        WHERE Ano = @Ano AND Mes = @Mes;

        FETCH NEXT FROM cur INTO @MotoristaId, @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;
END
GO

--
-- Create or alter trigger [trg_Abastecimento_NormalizacaoAutomatica] on table [dbo].[Abastecimento]
--
GO
PRINT (N'Create or alter trigger [trg_Abastecimento_NormalizacaoAutomatica] on table [dbo].[Abastecimento]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Abastecimento_NormalizacaoAutomatica
ON dbo.Abastecimento
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON
    
    -- Apenas processa se campos relevantes foram afetados
    IF NOT UPDATE(KmRodado) AND NOT UPDATE(Litros)
        RETURN

    BEGIN TRY
        DECLARE @VeiculosAfetados TABLE (VeiculoId UNIQUEIDENTIFIER)
        
        INSERT INTO @VeiculosAfetados (VeiculoId)
        SELECT DISTINCT VeiculoId
        FROM INSERTED
        WHERE Litros > 0 AND KmRodado > 0

        IF NOT EXISTS (SELECT 1 FROM @VeiculosAfetados)
            RETURN

        -- Calcular consumo original
        UPDATE A
        SET A.ConsumoCalculado = CAST(A.KmRodado AS FLOAT) / A.Litros
        FROM Abastecimento A
        INNER JOIN @VeiculosAfetados V ON A.VeiculoId = V.VeiculoId
        WHERE A.Litros > 0 AND A.KmRodado > 0

        -- Normalizar usando IQR
        ;WITH EstatisticasVeiculo AS (
            SELECT 
                VeiculoId,
                PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY ConsumoCalculado) OVER (PARTITION BY VeiculoId) AS Q1,
                PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY ConsumoCalculado) OVER (PARTITION BY VeiculoId) AS Q3,
                PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY ConsumoCalculado) OVER (PARTITION BY VeiculoId) AS Mediana,
                PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY KmRodado) OVER (PARTITION BY VeiculoId) AS MedianaKm,
                PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY Litros) OVER (PARTITION BY VeiculoId) AS MedianaLitros
            FROM Abastecimento
            WHERE Litros > 0 AND KmRodado > 0 AND ConsumoCalculado IS NOT NULL
        ),
        LimitesVeiculo AS (
            SELECT DISTINCT
                VeiculoId, Q1, Q3, Mediana, MedianaKm, MedianaLitros,
                CASE WHEN Q1 - 1.5 * (Q3 - Q1) < 3 THEN 3 ELSE Q1 - 1.5 * (Q3 - Q1) END AS LimiteInf,
                CASE WHEN Q3 + 1.5 * (Q3 - Q1) > 30 THEN 30 ELSE Q3 + 1.5 * (Q3 - Q1) END AS LimiteSup
            FROM EstatisticasVeiculo
        )
        UPDATE A
        SET 
            A.EhOutlier = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN 1 ELSE 0 END,
            A.KmRodadoNormalizado = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN CAST(L.MedianaKm AS INT) ELSE A.KmRodado END,
            A.LitrosNormalizado = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN L.MedianaLitros ELSE A.Litros END,
            A.ConsumoNormalizado = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN L.Mediana ELSE A.ConsumoCalculado END
        FROM Abastecimento A
        INNER JOIN @VeiculosAfetados V ON A.VeiculoId = V.VeiculoId
        INNER JOIN LimitesVeiculo L ON A.VeiculoId = L.VeiculoId
        WHERE A.Litros > 0 AND A.KmRodado > 0 AND A.ConsumoCalculado IS NOT NULL

    END TRY
    BEGIN CATCH
        -- Silencioso - não interrompe operação principal
    END CATCH
END
GO

--
-- Create foreign key [FK_Abastecimento_Combustivel] on table [dbo].[Abastecimento]
--
PRINT (N'Create foreign key [FK_Abastecimento_Combustivel] on table [dbo].[Abastecimento]')
GO
ALTER TABLE dbo.Abastecimento
  ADD CONSTRAINT FK_Abastecimento_Combustivel FOREIGN KEY (CombustivelId) REFERENCES dbo.Combustivel (CombustivelId)
GO

--
-- Create foreign key [FK_Abastecimento_Motorista] on table [dbo].[Abastecimento]
--
PRINT (N'Create foreign key [FK_Abastecimento_Motorista] on table [dbo].[Abastecimento]')
GO
ALTER TABLE dbo.Abastecimento
  ADD CONSTRAINT FK_Abastecimento_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_Abastecimento_Veiculo] on table [dbo].[Abastecimento]
--
PRINT (N'Create foreign key [FK_Abastecimento_Veiculo] on table [dbo].[Abastecimento]')
GO
ALTER TABLE dbo.Abastecimento
  ADD CONSTRAINT FK_Abastecimento_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Add extended property [MS_Description] on table [dbo].[Abastecimento]
--
PRINT (N'Add extended property [MS_Description] on table [dbo].[Abastecimento]')
GO
EXEC sys.sp_addextendedproperty N'MS_Description', N'Registro dos Abastecimentos dos Veículos', 'SCHEMA', N'dbo', 'TABLE', N'Abastecimento'
GO

--
-- Create or alter function [dbo].[fn_GetValorCombustivelProximo]
--
GO
PRINT (N'Create or alter function [dbo].[fn_GetValorCombustivelProximo]')
GO

CREATE OR ALTER FUNCTION dbo.fn_GetValorCombustivelProximo(
    @VeiculoId UNIQUEIDENTIFIER,
    @DataReferencia DATETIME
)
RETURNS FLOAT
AS
BEGIN
    DECLARE @ValorUnitario FLOAT
    
    -- Busca abastecimento mais próximo da data (antes ou depois)
    SELECT TOP 1 @ValorUnitario = ValorUnitario
    FROM Abastecimento
    WHERE VeiculoId = @VeiculoId
      AND ValorUnitario > 0
      AND DataHora IS NOT NULL
    ORDER BY ABS(DATEDIFF(DAY, DataHora, @DataReferencia))
    
    -- Fallback: média dos últimos 6 meses do veículo
    IF @ValorUnitario IS NULL
    BEGIN
        SELECT @ValorUnitario = AVG(ValorUnitario)
        FROM Abastecimento
        WHERE VeiculoId = @VeiculoId
          AND ValorUnitario > 0
          AND DataHora >= DATEADD(MONTH, -6, GETDATE())
    END
    
    -- Fallback: média geral dos últimos 6 meses
    IF @ValorUnitario IS NULL
    BEGIN
        SELECT @ValorUnitario = AVG(ValorUnitario)
        FROM Abastecimento
        WHERE ValorUnitario > 0
          AND DataHora >= DATEADD(MONTH, -6, GETDATE())
    END
    
    RETURN @ValorUnitario
END
GO

--
-- Create or alter function [dbo].[fn_CalculaConsumoVeiculo]
--
GO
PRINT (N'Create or alter function [dbo].[fn_CalculaConsumoVeiculo]')
GO

CREATE OR ALTER FUNCTION dbo.fn_CalculaConsumoVeiculo(@VeiculoId UNIQUEIDENTIFIER)
RETURNS FLOAT
AS
BEGIN
    DECLARE @Consumo FLOAT
    
    -- Prioriza consumo normalizado (sem outliers)
    SELECT @Consumo = AVG(ConsumoNormalizado)
    FROM Abastecimento
    WHERE VeiculoId = @VeiculoId
      AND ConsumoNormalizado IS NOT NULL
      AND ConsumoNormalizado > 0
      AND (EhOutlier IS NULL OR EhOutlier = 0)
    
    -- Fallback: consumo calculado original
    IF @Consumo IS NULL
    BEGIN
        SELECT @Consumo = AVG(CAST(KmRodado AS FLOAT) / NULLIF(Litros, 0))
        FROM Abastecimento
        WHERE VeiculoId = @VeiculoId
          AND KmRodado > 0
          AND Litros > 0
          AND (CAST(KmRodado AS FLOAT) / Litros) BETWEEN 3 AND 30
    END
    
    -- Fallback final: consumo cadastrado no veículo
    IF @Consumo IS NULL
    BEGIN
        SELECT @Consumo = Consumo
        FROM Veiculo
        WHERE VeiculoId = @VeiculoId
          AND Consumo > 0
    END
    
    RETURN @Consumo
END
GO

--
-- Create or alter procedure [dbo].[sp_NormalizarAbastecimentos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_NormalizarAbastecimentos]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_NormalizarAbastecimentos
AS
BEGIN
    SET NOCOUNT ON
    
    DECLARE @TotalRegistros INT
    DECLARE @OutliersDetectados INT

    BEGIN TRY
        BEGIN TRANSACTION

        -- STEP 1: Calcular consumo original
        PRINT '  [STEP 1] Calculando consumo original...'
        
        UPDATE Abastecimento
        SET ConsumoCalculado = CAST(KmRodado AS FLOAT) / Litros
        WHERE Litros > 0 AND KmRodado > 0
        
        SELECT @TotalRegistros = @@ROWCOUNT
        PRINT '           ' + CAST(@TotalRegistros AS VARCHAR) + ' registros calculados'

        -- STEP 2: Calcular estatísticas e normalizar por veículo
        PRINT '  [STEP 2] Detectando outliers (método IQR)...'
        
        ;WITH EstatisticasVeiculo AS (
            SELECT DISTINCT
                VeiculoId,
                PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY ConsumoCalculado) OVER (PARTITION BY VeiculoId) AS Q1,
                PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY ConsumoCalculado) OVER (PARTITION BY VeiculoId) AS Q3,
                PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY ConsumoCalculado) OVER (PARTITION BY VeiculoId) AS Mediana,
                PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY KmRodado) OVER (PARTITION BY VeiculoId) AS MedianaKm,
                PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY Litros) OVER (PARTITION BY VeiculoId) AS MedianaLitros
            FROM Abastecimento
            WHERE Litros > 0 AND KmRodado > 0 AND ConsumoCalculado IS NOT NULL
        ),
        LimitesVeiculo AS (
            SELECT 
                VeiculoId, Q1, Q3, Mediana, MedianaKm, MedianaLitros,
                -- IQR com limites de sanidade (3 a 30 km/l)
                CASE WHEN Q1 - 1.5 * (Q3 - Q1) < 3 THEN 3 ELSE Q1 - 1.5 * (Q3 - Q1) END AS LimiteInf,
                CASE WHEN Q3 + 1.5 * (Q3 - Q1) > 30 THEN 30 ELSE Q3 + 1.5 * (Q3 - Q1) END AS LimiteSup
            FROM EstatisticasVeiculo
        )
        UPDATE A
        SET 
            A.EhOutlier = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN 1 ELSE 0 END,
            A.KmRodadoNormalizado = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN CAST(L.MedianaKm AS INT) ELSE A.KmRodado END,
            A.LitrosNormalizado = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN L.MedianaLitros ELSE A.Litros END,
            A.ConsumoNormalizado = CASE WHEN A.ConsumoCalculado < L.LimiteInf OR A.ConsumoCalculado > L.LimiteSup THEN L.Mediana ELSE A.ConsumoCalculado END
        FROM Abastecimento A
        INNER JOIN LimitesVeiculo L ON A.VeiculoId = L.VeiculoId
        WHERE A.Litros > 0 AND A.KmRodado > 0 AND A.ConsumoCalculado IS NOT NULL

        SELECT @OutliersDetectados = COUNT(*) FROM Abastecimento WHERE EhOutlier = 1
        PRINT '           ' + CAST(@OutliersDetectados AS VARCHAR) + ' outliers detectados e normalizados'

        COMMIT TRANSACTION
        
        PRINT ''
        PRINT '  ✓ Normalização de abastecimentos concluída!'

    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
        DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE()
        RAISERROR(@ErrorMessage, 16, 1)
    END CATCH
END
GO

--
-- Create or alter procedure [dbo].[sp_CalcularConsumoVeiculos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_CalcularConsumoVeiculos]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_CalcularConsumoVeiculos
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @VeiculosAtualizados INT = 0;
    DECLARE @TemTriggers BIT = 0;

    BEGIN TRY
        -- Verifica se as colunas necessárias existem
        IF NOT EXISTS (
            SELECT 1 FROM sys.columns 
            WHERE object_id = OBJECT_ID('Veiculo') AND name = 'Consumo'
        )
        BEGIN
            RAISERROR('Coluna Veiculo.Consumo não existe!', 16, 1);
            RETURN;
        END

        IF NOT EXISTS (
            SELECT 1 FROM sys.columns 
            WHERE object_id = OBJECT_ID('Abastecimento') AND name IN ('Litros', 'KmRodado')
        )
        BEGIN
            RAISERROR('Colunas Abastecimento.Litros ou KmRodado não existem!', 16, 1);
            RETURN;
        END

        BEGIN TRANSACTION;

        -- Verifica se existem triggers na tabela Veiculo
        IF EXISTS (
            SELECT 1 FROM sys.triggers 
            WHERE parent_id = OBJECT_ID('Veiculo') AND is_disabled = 0
        )
        BEGIN
            SET @TemTriggers = 1;
            PRINT '  [INFO] Desabilitando triggers em Veiculo para evitar recursão...';
            
            -- Desabilita TODOS os triggers ativos na tabela Veiculo
            DECLARE @TriggerName NVARCHAR(128);
            DECLARE trigger_cursor CURSOR FOR
                SELECT name FROM sys.triggers 
                WHERE parent_id = OBJECT_ID('Veiculo') AND is_disabled = 0;
            
            OPEN trigger_cursor;
            FETCH NEXT FROM trigger_cursor INTO @TriggerName;
            
            WHILE @@FETCH_STATUS = 0
            BEGIN
                EXEC('ALTER TABLE Veiculo DISABLE TRIGGER ' + @TriggerName);
                PRINT '  [INFO] Trigger desabilitado: ' + @TriggerName;
                FETCH NEXT FROM trigger_cursor INTO @TriggerName;
            END
            
            CLOSE trigger_cursor;
            DEALLOCATE trigger_cursor;
        END

        -- Atualiza o consumo de cada veículo baseado na média de seus abastecimentos
        PRINT '  [EXEC] Calculando consumo médio por veículo...';
        
        UPDATE V
        SET V.Consumo = ROUND(Calc.ConsumoMedio, 2)
        FROM Veiculo V
        INNER JOIN (
            SELECT 
                VeiculoId,
                AVG(CAST(KmRodado AS FLOAT) / NULLIF(Litros, 0)) AS ConsumoMedio
            FROM Abastecimento
            WHERE Litros > 0 
              AND KmRodado > 0
            GROUP BY VeiculoId
            HAVING AVG(CAST(KmRodado AS FLOAT) / NULLIF(Litros, 0)) > 0
        ) Calc ON V.VeiculoId = Calc.VeiculoId;

        SET @VeiculosAtualizados = @@ROWCOUNT;

        -- Reabilita triggers se foram desabilitados
        IF @TemTriggers = 1
        BEGIN
            PRINT '  [INFO] Reabilitando triggers em Veiculo...';
            
            DECLARE trigger_cursor2 CURSOR FOR
                SELECT name FROM sys.triggers 
                WHERE parent_id = OBJECT_ID('Veiculo');
            
            OPEN trigger_cursor2;
            FETCH NEXT FROM trigger_cursor2 INTO @TriggerName;
            
            WHILE @@FETCH_STATUS = 0
            BEGIN
                EXEC('ALTER TABLE Veiculo ENABLE TRIGGER ' + @TriggerName);
                PRINT '  [INFO] Trigger reabilitado: ' + @TriggerName;
                FETCH NEXT FROM trigger_cursor2 INTO @TriggerName;
            END
            
            CLOSE trigger_cursor2;
            DEALLOCATE trigger_cursor2;
        END

        COMMIT TRANSACTION;

        -- Log de sucesso
        PRINT '  [OK]   Cálculo de consumo concluído com sucesso!';
        PRINT '  [INFO] Total de veículos atualizados: ' + CAST(@VeiculosAtualizados AS VARCHAR(10));

    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;

        -- Tenta reabilitar triggers mesmo em caso de erro
        IF @TemTriggers = 1
        BEGIN
            BEGIN TRY
                PRINT '  [WARN] Tentando reabilitar triggers após erro...';
                
                DECLARE trigger_cursor3 CURSOR FOR
                    SELECT name FROM sys.triggers 
                    WHERE parent_id = OBJECT_ID('Veiculo');
                
                OPEN trigger_cursor3;
                FETCH NEXT FROM trigger_cursor3 INTO @TriggerName;
                
                WHILE @@FETCH_STATUS = 0
                BEGIN
                    EXEC('ALTER TABLE Veiculo ENABLE TRIGGER ' + @TriggerName);
                    FETCH NEXT FROM trigger_cursor3 INTO @TriggerName;
                END
                
                CLOSE trigger_cursor3;
                DEALLOCATE trigger_cursor3;
            END TRY
            BEGIN CATCH
                PRINT '  [ERROR] Falha ao reabilitar triggers!';
            END CATCH
        END

        DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE();
        DECLARE @ErrorSeverity INT = ERROR_SEVERITY();
        DECLARE @ErrorState INT = ERROR_STATE();

        RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState);
    END CATCH
END
GO

--
-- Create or alter view [dbo].[ViewVeiculos_Ultima]
--
GO
PRINT (N'Create or alter view [dbo].[ViewVeiculos_Ultima]')
GO
CREATE OR ALTER VIEW dbo.ViewVeiculos_Ultima 
AS SELECT
  Veiculo.VeiculoId
 ,Veiculo.Placa
 ,LEFT(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'), LEN(SUBSTRING(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'), CHARINDEX(' ', REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'), CHARINDEX(' ', REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'))), LEN(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.')))) - 2) AS Quilometragem
 ,MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS MarcaModelo
 ,Unidade.Sigla
 ,Combustivel.Descricao
 ,CASE
    WHEN CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2)) IS NULL THEN 0
    ELSE CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2))
  END AS Consumo
 ,CASE
    WHEN ViewContratoFornecedor_Veiculos.ContratoVeiculo IS NOT NULL THEN ViewContratoFornecedor_Veiculos.ContratoVeiculo
    WHEN ViewAtaFornecedor.AtaVeiculo IS NOT NULL THEN ViewAtaFornecedor.AtaVeiculo + ' <b>(Ata)</b> '
    ELSE '<b>(Veículo Próprio)</b>'
  END AS OrigemVeiculo
 ,CONVERT(VARCHAR, Veiculo.DataAlteracao, 103) AS DataAlteracao
 ,AspNetUsers.NomeCompleto
 ,CASE
    WHEN Veiculo.Reserva = 0 THEN 'Efetivo'
    ELSE 'Reserva'
  END AS VeiculoReserva
 ,Veiculo.Status
 ,Veiculo.CombustivelId
 ,ROW_NUMBER() OVER (ORDER BY Veiculo.Placa) AS RowNum
 ,ViewContratoFornecedor_Veiculos.ContratoId
 ,ViewAtaFornecedor.AtaId
 ,ViewContratoFornecedor_Veiculos.ContratoVeiculo
 ,ViewAtaFornecedor.AtaVeiculo
 ,Veiculo.VeiculoProprio
 ,Veiculo.ItemVeiculoAtaId
 ,Veiculo.ItemVeiculoId
 ,Veiculo.ValorMensal
FROM dbo.Abastecimento
RIGHT OUTER JOIN dbo.Veiculo
  ON Abastecimento.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
LEFT OUTER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
LEFT OUTER JOIN dbo.Unidade
  ON Unidade.UnidadeId = Veiculo.UnidadeId
LEFT OUTER JOIN dbo.Combustivel
  ON Combustivel.CombustivelId = Veiculo.CombustivelId
LEFT OUTER JOIN dbo.ViewContratoFornecedor_Veiculos
  ON ViewContratoFornecedor_Veiculos.ContratoId = Veiculo.ContratoId
LEFT OUTER JOIN dbo.ViewAtaFornecedor
  ON ViewAtaFornecedor.AtaId = Veiculo.AtaId
INNER JOIN dbo.AspNetUsers
  ON AspNetUsers.Id = Veiculo.UsuarioIdAlteracao
GROUP BY Veiculo.VeiculoId
        ,Veiculo.Placa
        ,Veiculo.Quilometragem
        ,MarcaVeiculo.DescricaoMarca
        ,ModeloVeiculo.DescricaoModelo
        ,Unidade.Sigla
        ,Combustivel.Descricao
        ,ViewContratoFornecedor_Veiculos.ContratoId
        ,Veiculo.DataAlteracao
        ,AspNetUsers.NomeCompleto
        ,Veiculo.Reserva
        ,Veiculo.Status
        ,Veiculo.CombustivelId
        ,ViewAtaFornecedor.AtaId
        ,ViewContratoFornecedor_Veiculos.ContratoVeiculo
        ,ViewAtaFornecedor.AtaVeiculo
        ,Veiculo.VeiculoProprio
        ,Veiculo.ItemVeiculoAtaId
        ,Veiculo.ItemVeiculoId
        ,Veiculo.ValorMensal
GO

--
-- Create or alter view [dbo].[ViewVeiculos_Original]
--
GO
PRINT (N'Create or alter view [dbo].[ViewVeiculos_Original]')
GO
CREATE OR ALTER VIEW dbo.ViewVeiculos_Original 
AS SELECT
  Veiculo.VeiculoId
 ,Veiculo.Placa
 ,LEFT(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'), LEN(SUBSTRING(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'), CHARINDEX(' ', REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'), CHARINDEX(' ', REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.'))), LEN(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR, CAST(Veiculo.Quilometragem AS MONEY), 1), ',', '_'), '.', ','), '_', '.')))) - 2) AS Quilometragem
 ,MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS MarcaModelo
 ,Unidade.Sigla
 ,Combustivel.Descricao
 ,CASE
    WHEN CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2)) IS NULL THEN 0
    ELSE CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2))
  END AS Consumo
 ,CASE
    WHEN ViewContratoFornecedor_Veiculos.ContratoVeiculo IS NOT NULL THEN ViewContratoFornecedor_Veiculos.ContratoVeiculo
    WHEN ViewAtaFornecedor.AtaVeiculo IS NOT NULL THEN ViewAtaFornecedor.AtaVeiculo + ' <b>(Ata)</b> '
    ELSE '<b>(Veículo Próprio)</b>'
  END AS OrigemVeiculo
 ,CONVERT(VARCHAR, Veiculo.DataAlteracao, 103) AS DataAlteracao
 ,AspNetUsers.NomeCompleto
 ,CASE
    WHEN Veiculo.Reserva = 0 THEN 'Efetivo'
    ELSE 'Reserva'
  END AS VeiculoReserva
 ,Veiculo.Status
 ,Veiculo.CombustivelId
 ,ROW_NUMBER() OVER (ORDER BY Veiculo.Placa) AS RowNum
 ,ViewContratoFornecedor_Veiculos.ContratoId
 ,ViewAtaFornecedor.AtaId
 ,ViewContratoFornecedor_Veiculos.ContratoVeiculo
 ,ViewAtaFornecedor.AtaVeiculo
 ,Veiculo.ValorMensal
FROM dbo.Abastecimento
RIGHT OUTER JOIN dbo.Veiculo
  ON Abastecimento.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
LEFT OUTER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
LEFT OUTER JOIN dbo.Unidade
  ON Unidade.UnidadeId = Veiculo.UnidadeId
LEFT OUTER JOIN dbo.Combustivel
  ON Combustivel.CombustivelId = Veiculo.CombustivelId
LEFT OUTER JOIN dbo.ViewContratoFornecedor_Veiculos
  ON ViewContratoFornecedor_Veiculos.ContratoId = Veiculo.ContratoId
LEFT OUTER JOIN dbo.ViewAtaFornecedor
  ON ViewAtaFornecedor.AtaId = Veiculo.AtaId
INNER JOIN dbo.AspNetUsers
  ON AspNetUsers.Id = Veiculo.UsuarioIdAlteracao
GROUP BY Veiculo.VeiculoId
        ,Veiculo.Placa
        ,Veiculo.Quilometragem
        ,MarcaVeiculo.DescricaoMarca
        ,ModeloVeiculo.DescricaoModelo
        ,Unidade.Sigla
        ,Combustivel.Descricao
        ,ViewContratoFornecedor_Veiculos.ContratoId
        ,Veiculo.DataAlteracao
        ,AspNetUsers.NomeCompleto
        ,Veiculo.Reserva
        ,Veiculo.Status
        ,Veiculo.CombustivelId
        ,ViewAtaFornecedor.AtaId
        ,ViewContratoFornecedor_Veiculos.ContratoVeiculo
        ,ViewAtaFornecedor.AtaVeiculo
        ,Veiculo.ValorMensal
        
GO

--
-- Create or alter view [dbo].[ViewVeiculos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewVeiculos]')
GO
CREATE OR ALTER VIEW dbo.ViewVeiculos 
AS SELECT
  Veiculo.VeiculoId
 ,Veiculo.Placa
 ,Economildo
 ,Quilometragem
 ,Veiculo.Categoria
 ,Veiculo.Placa +  ' (' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo + ')' AS VeiculoCompleto
 ,MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS MarcaModelo
 ,Unidade.Sigla
 ,Combustivel.Descricao
 ,CASE
    WHEN CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2)) IS NULL THEN 0
    ELSE CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2))
  END AS Consumo
 ,CASE
    WHEN ViewContratoFornecedor_Veiculos.ContratoVeiculo IS NOT NULL THEN ViewContratoFornecedor_Veiculos.ContratoVeiculo
    WHEN ViewAtaFornecedor.AtaVeiculo IS NOT NULL THEN ViewAtaFornecedor.AtaVeiculo + ' <b>(Ata)</b> '
    WHEN Veiculo.VeiculoProprio = 1 THEN '<b><i>(Veículo Próprio)</i></b>'
    ELSE '<b><i style="color: #dc3545;">(Sem Contrato/Ata)</i></b>'
  END AS OrigemVeiculo
 ,CONVERT(VARCHAR, Veiculo.DataAlteracao, 103) AS DataAlteracao
 ,AspNetUsers.NomeCompleto
 ,CASE
    WHEN Veiculo.Reserva = 0 THEN 'Efetivo'
    ELSE 'Reserva'
  END AS VeiculoReserva
 ,Veiculo.Status
 ,Veiculo.CombustivelId
 ,ROW_NUMBER() OVER (ORDER BY Veiculo.Placa) AS RowNum
 ,ViewContratoFornecedor_Veiculos.ContratoId
 ,ViewAtaFornecedor.AtaId
 ,ViewContratoFornecedor_Veiculos.ContratoVeiculo
 ,ViewAtaFornecedor.AtaVeiculo
 ,Veiculo.VeiculoProprio
 ,Veiculo.ItemVeiculoAtaId
 ,Veiculo.ItemVeiculoId
 ,Veiculo.ValorMensal
FROM dbo.Abastecimento
RIGHT OUTER JOIN dbo.Veiculo
  ON Abastecimento.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
LEFT OUTER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
LEFT OUTER JOIN dbo.Unidade
  ON Unidade.UnidadeId = Veiculo.UnidadeId
LEFT OUTER JOIN dbo.Combustivel
  ON Combustivel.CombustivelId = Veiculo.CombustivelId
LEFT OUTER JOIN dbo.ViewContratoFornecedor_Veiculos
  ON ViewContratoFornecedor_Veiculos.ContratoId = Veiculo.ContratoId
LEFT OUTER JOIN dbo.ViewAtaFornecedor
  ON ViewAtaFornecedor.AtaId = Veiculo.AtaId
INNER JOIN dbo.AspNetUsers
  ON AspNetUsers.Id = Veiculo.UsuarioIdAlteracao
GROUP BY Veiculo.VeiculoId
        ,Veiculo.Placa
        ,Veiculo.Quilometragem
        ,MarcaVeiculo.DescricaoMarca
        ,ModeloVeiculo.DescricaoModelo
        ,Unidade.Sigla
        ,Combustivel.Descricao
        ,ViewContratoFornecedor_Veiculos.ContratoId
        ,Veiculo.DataAlteracao
        ,AspNetUsers.NomeCompleto
        ,Veiculo.Reserva
        ,Veiculo.Status
        ,Veiculo.CombustivelId
        ,ViewAtaFornecedor.AtaId
        ,ViewContratoFornecedor_Veiculos.ContratoVeiculo
        ,ViewAtaFornecedor.AtaVeiculo
        ,Veiculo.VeiculoProprio
        ,Veiculo.ItemVeiculoAtaId
        ,Veiculo.ItemVeiculoId
        ,Veiculo.ValorMensal
        ,Economildo
        ,Veiculo.Categoria
GO

--
-- Create or alter view [dbo].[ViewManutencao.OLD]
--
GO
PRINT (N'Create or alter view [dbo].[ViewManutencao.OLD]')
GO
CREATE OR ALTER VIEW dbo.[ViewManutencao.OLD] 
AS SELECT
  Manutencao.ManutencaoId
 ,Manutencao.NumOS
 ,CONVERT(VARCHAR, Manutencao.DataSolicitacao, 103) AS DataSolicitacao
 ,Manutencao.ResumoOS
 ,CONVERT(VARCHAR, Manutencao.DataRecolhimento, 103) AS DataRecolhimento
 ,CONVERT(VARCHAR, Manutencao.DataRecebimentoReserva, 103) AS DataRecebimentoReserva
 ,CONVERT(VARCHAR, Manutencao.DataDevolucaoReserva, 103) AS DataDevolucaoReserva
 ,CONVERT(VARCHAR, Manutencao.DataEntrega, 103) AS DataEntrega
 ,Manutencao.StatusOS
 ,Manutencao.VeiculoId
 ,'(' + ViewVeiculos.Placa + ') ' + ViewVeiculos.MarcaModelo AS DescricaoVeiculo
 ,CASE
    WHEN Manutencao.ReservaEnviado IS NULL THEN ''
    WHEN Manutencao.ReservaEnviado = 1 THEN 'Enviado'
    ELSE 'Ausente'
  END AS Reserva
 ,CASE
    WHEN Manutencao.DataDevolucao IS NULL THEN '01/01/2001'
    ELSE CONVERT(VARCHAR, Manutencao.DataDevolucao, 103)
  END AS DataDevolucao
 ,CASE
    WHEN Manutencao.DataDevolucao IS NULL THEN '01'
    WHEN Manutencao.DataEntrega IS NOT NULL THEN DATEDIFF(DAY, Manutencao.DataEntrega, Manutencao.DataDevolucao)
    ELSE DATEDIFF(DAY, Manutencao.DataSolicitacao, Manutencao.DataDevolucao)
  END AS DiasGlosa
 ,ItemVeiculoContrato.NumItem
FROM dbo.ViewVeiculos
RIGHT OUTER JOIN dbo.Manutencao
  ON ViewVeiculos.VeiculoId = Manutencao.VeiculoId
LEFT OUTER JOIN dbo.ItemVeiculoContrato
  ON ItemVeiculoContrato.ItemVeiculoId = ViewVeiculos.ItemVeiculoId
GO

--
-- Create or alter view [dbo].[ViewTeste]
--
GO
PRINT (N'Create or alter view [dbo].[ViewTeste]')
GO
CREATE OR ALTER VIEW dbo.ViewTeste 
AS SELECT
  Abastecimento.AbastecimentoId
 ,Abastecimento.Litros
 ,Abastecimento.ValorUnitario
 ,Abastecimento.DataHora
 ,Abastecimento.KmRodado
 ,Abastecimento.Hodometro
 ,Veiculo.Placa
 ,ModeloVeiculo.DescricaoModelo
 ,MarcaVeiculo.DescricaoMarca
 ,Combustivel.Descricao
 ,Motorista.Nome
 ,Unidade.Sigla
FROM dbo.Abastecimento
INNER JOIN dbo.Veiculo
  ON Abastecimento.VeiculoId = Veiculo.VeiculoId
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
INNER JOIN dbo.Combustivel
  ON Abastecimento.CombustivelId = Combustivel.CombustivelId
INNER JOIN dbo.Motorista
  ON Abastecimento.MotoristaId = Motorista.MotoristaId
LEFT OUTER JOIN dbo.Unidade
  ON Unidade.UnidadeId = Motorista.UnidadeId
GO

--
-- Create or alter view [dbo].[ViewSabrina]
--
GO
PRINT (N'Create or alter view [dbo].[ViewSabrina]')
GO
CREATE OR ALTER VIEW dbo.ViewSabrina 
AS SELECT
  Combustivel.Descricao
 ,Veiculo.Placa
 ,Abastecimento.Litros
 ,Abastecimento.ValorUnitario
 ,Abastecimento.DataHora
FROM dbo.Abastecimento
INNER JOIN dbo.Combustivel
  ON Abastecimento.CombustivelId = Combustivel.CombustivelId
INNER JOIN dbo.Veiculo
  ON Abastecimento.VeiculoId = Veiculo.VeiculoId
GO

--
-- Create or alter view [dbo].[ViewMediaConsumo]
--
GO
PRINT (N'Create or alter view [dbo].[ViewMediaConsumo]')
GO
CREATE OR ALTER VIEW dbo.ViewMediaConsumo 
AS SELECT
  Abastecimento.VeiculoId
 ,CAST(ROUND(AVG(Abastecimento.KmRodado / Abastecimento.Litros), 2) AS DEC(10, 2)) AS ConsumoGeral
FROM dbo.Abastecimento
GROUP BY Abastecimento.VeiculoId
GO

--
-- Create or alter view [dbo].[ViewAbastecimentos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAbastecimentos]')
GO
CREATE OR ALTER VIEW dbo.ViewAbastecimentos 
AS SELECT TOP (100) PERCENT
  Abastecimento.AbastecimentoId
 ,Abastecimento.DataHora
 ,CONVERT(VARCHAR, Abastecimento.DataHora, 103) AS Data
 ,FORMAT(Abastecimento.DataHora, 'HH:mm') AS Hora
 ,Veiculo.Placa
 ,MarcaVeiculo.DescricaoMarca + ' / ' + ModeloVeiculo.DescricaoModelo AS TipoVeiculo
 ,Motorista.Nome
 ,Combustivel.Descricao AS TipoCombustivel
 ,Unidade.Sigla
 ,FORMAT(Abastecimento.Litros, 'N2') AS Litros
 ,FORMAT(Abastecimento.ValorUnitario, 'N2') AS ValorUnitario
 ,FORMAT(Abastecimento.Litros * Abastecimento.ValorUnitario, 'N2') AS ValorTotal
 ,FORMAT(Abastecimento.KmRodado / Abastecimento.Litros, 'N2') AS Consumo
 ,ViewMediaConsumo.ConsumoGeral
 ,Abastecimento.KmRodado
 ,Veiculo.VeiculoId
 ,Combustivel.CombustivelId
 ,Unidade.UnidadeId
 ,Motorista.MotoristaId
  ,ROW_NUMBER() OVER (ORDER BY Abastecimento.DataHora DESC) AS RowNum
 ,Motorista.Nome + ' (' + Motorista.TipoCondutor + ')' AS MotoristaCondutor
FROM dbo.Abastecimento
INNER JOIN dbo.Veiculo
  ON Abastecimento.VeiculoId = Veiculo.VeiculoId
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
INNER JOIN dbo.Motorista
  ON Abastecimento.MotoristaId = Motorista.MotoristaId
INNER JOIN dbo.Combustivel
  ON Abastecimento.CombustivelId = Combustivel.CombustivelId
INNER JOIN dbo.Unidade
  ON Motorista.UnidadeId = Unidade.UnidadeId
LEFT OUTER JOIN dbo.ViewMediaConsumo
  ON ViewMediaConsumo.VeiculoId = Abastecimento.VeiculoId
LEFT OUTER JOIN dbo.CondutorApoio
  ON CondutorApoio.CondutorId = Motorista.CondutorId
GO

--
-- Create or alter view [dbo].[ViewCustoAbastecimento]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustoAbastecimento]')
GO
CREATE OR ALTER VIEW dbo.ViewCustoAbastecimento 
AS SELECT
  Combustivel.Descricao
 ,DAY(Abastecimento.DataHora) AS Dia
 ,SUM(Abastecimento.Litros * Abastecimento.ValorUnitario) AS Valor
FROM dbo.Abastecimento
INNER JOIN dbo.Combustivel
  ON Abastecimento.CombustivelId = Combustivel.CombustivelId
WHERE MONTH(Abastecimento.DataHora) = 07
AND YEAR(Abastecimento.DataHora) = 2022
GROUP BY Combustivel.Descricao
        ,Abastecimento.DataHora
GO

--
-- Create or alter view [dbo].[ViewAbastecimentosPBI]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAbastecimentosPBI]')
GO
CREATE OR ALTER VIEW dbo.ViewAbastecimentosPBI 
AS SELECT
  Abastecimento.AbastecimentoId
 ,ViewAbastecimentosItensPBI.VeiculoID
 ,CASE
    WHEN ViewAbastecimentosItensPBI.Descricao IS NULL THEN 'Veículo Próprio'
    ELSE ViewAbastecimentosItensPBI.Descricao
  END AS Descricao
 ,ViewAbastecimentosItensPBI.Categoria
 ,Abastecimento.Litros
 ,Abastecimento.ValorUnitario
 ,Abastecimento.KmRodado
 ,CONVERT(VARCHAR, Abastecimento.DataHora, 103) AS DataAbastecimento
 ,FORMAT(Abastecimento.DataHora, 'HH:mm') AS HoraAbastecimento
 ,Combustivel.Descricao AS DescricaoCombustivel
FROM dbo.ViewAbastecimentosItensPBI
RIGHT OUTER JOIN dbo.Abastecimento
  ON ViewAbastecimentosItensPBI.VeiculoID = Abastecimento.VeiculoId
INNER JOIN dbo.Combustivel
  ON Abastecimento.CombustivelId = Combustivel.CombustivelId
GO

--
-- Create or alter function [dbo].[fn_CalculaMinutosUteis]
--
GO
PRINT (N'Create or alter function [dbo].[fn_CalculaMinutosUteis]')
GO
-- ================================================================
-- FUNÇÃO: Calcula minutos úteis com jornada de 8h/dia (Opção B)
-- ================================================================
CREATE OR ALTER FUNCTION dbo.fn_CalculaMinutosUteis
(
    @DataInicial DATETIME2,
    @DataFinal DATETIME2,
    @HoraInicio TIME,
    @HoraFim TIME
)
RETURNS INT
AS
BEGIN
    DECLARE @TotalMinutos INT = 0
    DECLARE @TotalDias INT
    DECLARE @MinutosPrimeiroDia INT
    DECLARE @MinutosUltimoDia INT
    DECLARE @DiasIntermediarios INT
    
    -- Constantes de jornada
    DECLARE @MINUTOS_JORNADA_DIA INT = 480  -- 8 horas
    DECLARE @INICIO_EXPEDIENTE TIME = '08:00:00'
    DECLARE @FIM_EXPEDIENTE TIME = '18:00:00'
    
    -- Validações
    IF @DataInicial IS NULL OR @HoraInicio IS NULL
        RETURN 0
    
    -- Se DataFinal é NULL, assume mesmo dia
    IF @DataFinal IS NULL
        SET @DataFinal = @DataInicial
    
    -- Se HoraFim é NULL, assume fim do expediente
    IF @HoraFim IS NULL
        SET @HoraFim = @FIM_EXPEDIENTE
    
    -- Calcula total de dias
    SET @TotalDias = DATEDIFF(DAY, @DataInicial, @DataFinal) + 1
    
    -- MESMO DIA
    IF @TotalDias = 1
    BEGIN
        SET @TotalMinutos = DATEDIFF(MINUTE, @HoraInicio, @HoraFim)
        
        -- Limita a 480 minutos (8h)
        IF @TotalMinutos > @MINUTOS_JORNADA_DIA
            SET @TotalMinutos = @MINUTOS_JORNADA_DIA
        
        -- Não permite negativo
        IF @TotalMinutos < 0
            SET @TotalMinutos = 0
        
        RETURN @TotalMinutos
    END
    
    -- MÚLTIPLOS DIAS
    
    -- Primeiro dia: HoraInicio até FIM_EXPEDIENTE (18:00), limitado a 480
    SET @MinutosPrimeiroDia = DATEDIFF(MINUTE, @HoraInicio, @FIM_EXPEDIENTE)
    IF @MinutosPrimeiroDia > @MINUTOS_JORNADA_DIA
        SET @MinutosPrimeiroDia = @MINUTOS_JORNADA_DIA
    IF @MinutosPrimeiroDia < 0
        SET @MinutosPrimeiroDia = 0
    
    SET @TotalMinutos = @MinutosPrimeiroDia
    
    -- Dias intermediários: 480 minutos cada
    SET @DiasIntermediarios = @TotalDias - 2
    IF @DiasIntermediarios > 0
        SET @TotalMinutos = @TotalMinutos + (@DiasIntermediarios * @MINUTOS_JORNADA_DIA)
    
    -- Último dia: INICIO_EXPEDIENTE (08:00) até HoraFim, limitado a 480
    SET @MinutosUltimoDia = DATEDIFF(MINUTE, @INICIO_EXPEDIENTE, @HoraFim)
    IF @MinutosUltimoDia > @MINUTOS_JORNADA_DIA
        SET @MinutosUltimoDia = @MINUTOS_JORNADA_DIA
    IF @MinutosUltimoDia < 0
        SET @MinutosUltimoDia = 0
    
    SET @TotalMinutos = @TotalMinutos + @MinutosUltimoDia
    
    RETURN @TotalMinutos
END
GO

--
-- Create table [dbo].[HeatmapViagensMensal]
--
PRINT (N'Create table [dbo].[HeatmapViagensMensal]')
GO
CREATE TABLE dbo.HeatmapViagensMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  MotoristaId uniqueidentifier NULL,
  DiaSemana int NOT NULL,
  Hora int NOT NULL,
  TotalViagens int NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapViagens_AnoMes] on table [dbo].[HeatmapViagensMensal]
--
PRINT (N'Create index [IX_HeatmapViagens_AnoMes] on table [dbo].[HeatmapViagensMensal]')
GO
CREATE INDEX IX_HeatmapViagens_AnoMes
  ON dbo.HeatmapViagensMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapViagens_Motorista] on table [dbo].[HeatmapViagensMensal]
--
PRINT (N'Create index [IX_HeatmapViagens_Motorista] on table [dbo].[HeatmapViagensMensal]')
GO
CREATE UNIQUE INDEX IX_HeatmapViagens_Motorista
  ON dbo.HeatmapViagensMensal (Ano, Mes, MotoristaId, DiaSemana, Hora)
  WHERE ([MotoristaId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_HeatmapViagens_Todos] on table [dbo].[HeatmapViagensMensal]
--
PRINT (N'Create index [IX_HeatmapViagens_Todos] on table [dbo].[HeatmapViagensMensal]')
GO
CREATE UNIQUE INDEX IX_HeatmapViagens_Todos
  ON dbo.HeatmapViagensMensal (Ano, Mes, DiaSemana, Hora)
  WHERE ([MotoristaId] IS NULL)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EvolucaoViagensDiaria]
--
PRINT (N'Create table [dbo].[EvolucaoViagensDiaria]')
GO
CREATE TABLE dbo.EvolucaoViagensDiaria (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Data date NOT NULL,
  MotoristaId uniqueidentifier NULL,
  TotalViagens int NULL DEFAULT (0),
  KmTotal decimal(18, 2) NULL DEFAULT (0),
  MinutosTotais int NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EvolucaoViagens_Data] on table [dbo].[EvolucaoViagensDiaria]
--
PRINT (N'Create index [IX_EvolucaoViagens_Data] on table [dbo].[EvolucaoViagensDiaria]')
GO
CREATE INDEX IX_EvolucaoViagens_Data
  ON dbo.EvolucaoViagensDiaria (Data)
  ON [PRIMARY]
GO

--
-- Create index [IX_EvolucaoViagens_Motorista] on table [dbo].[EvolucaoViagensDiaria]
--
PRINT (N'Create index [IX_EvolucaoViagens_Motorista] on table [dbo].[EvolucaoViagensDiaria]')
GO
CREATE UNIQUE INDEX IX_EvolucaoViagens_Motorista
  ON dbo.EvolucaoViagensDiaria (Data, MotoristaId)
  WHERE ([MotoristaId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_EvolucaoViagens_Todos] on table [dbo].[EvolucaoViagensDiaria]
--
PRINT (N'Create index [IX_EvolucaoViagens_Todos] on table [dbo].[EvolucaoViagensDiaria]')
GO
CREATE UNIQUE INDEX IX_EvolucaoViagens_Todos
  ON dbo.EvolucaoViagensDiaria (Data)
  WHERE ([MotoristaId] IS NULL)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[Viagem]
--
PRINT (N'Create table [dbo].[Viagem]')
GO
CREATE TABLE dbo.Viagem (
  ViagemId uniqueidentifier NOT NULL DEFAULT (newid()),
  DataInicial datetime NULL,
  DataFinal datetime NULL,
  HoraInicio datetime NULL,
  HoraFim datetime NULL,
  CombustivelInicial varchar(50) NULL CONSTRAINT DF_Viagem_CombustivelInicial DEFAULT (''),
  CombustivelFinal varchar(50) NULL CONSTRAINT DF_Viagem_CombustivelFinal DEFAULT (''),
  KmAtual int NOT NULL DEFAULT (0),
  KmInicial int NULL CONSTRAINT DF_Viagem_KmInicial DEFAULT (0),
  KmFinal int NULL CONSTRAINT DF_Viagem_KmFinal DEFAULT (0),
  Descricao varchar(max) NULL CONSTRAINT DF_Viagem_Descricao DEFAULT (''),
  RamalRequisitante varchar(50) NULL CONSTRAINT DF_Viagem_RamalRequisitante DEFAULT (''),
  Finalidade varchar(200) NULL CONSTRAINT DF_Viagem_Finalidade DEFAULT (''),
  NoFichaVistoria int NULL CONSTRAINT DF_Viagem_NoFichaVistoria DEFAULT (0),
  Status varchar(50) NULL CONSTRAINT DF_Viagem_Status DEFAULT (''),
  RequisitanteId uniqueidentifier NULL,
  SetorSolicitanteId uniqueidentifier NULL,
  VeiculoId uniqueidentifier NULL,
  MotoristaId uniqueidentifier NULL,
  UsuarioIdCriacao varchar(100) NULL,
  DataCriacao datetime NULL,
  UsuarioIdFinalizacao varchar(100) NULL,
  DataFinalizacao datetime NULL,
  ResumoOcorrencia varchar(100) NULL CONSTRAINT DF_Viagem_ResumoOcorrencia DEFAULT (''),
  DescricaoOcorrencia varchar(max) NULL CONSTRAINT DF_Viagem_DescricaoOcorrencia DEFAULT (''),
  StatusOcorrencia varchar(50) NULL CONSTRAINT DF_Viagem_StatusOcorrencia DEFAULT (''),
  StatusDocumento varchar(50) NULL CONSTRAINT DF_Viagem_StatusDocumento DEFAULT (''),
  StatusCartaoAbastecimento varchar(50) NULL CONSTRAINT DF_Viagem_StatusCartaoAbastecimento DEFAULT (''),
  StatusAgendamento bit NULL DEFAULT (0),
  Origem varchar(max) NULL CONSTRAINT DF_Viagem_Origem DEFAULT (''),
  Destino varchar(max) NULL CONSTRAINT DF_Viagem_Destino DEFAULT (''),
  DescricaoSemFormato varchar(max) NULL CONSTRAINT DF_Viagem_DescricaoSemFormato DEFAULT (''),
  FichaVistoria varbinary(max) NULL,
  CustoCombustivel float NULL CONSTRAINT DF_Viagem_CustoCombustivel DEFAULT (0),
  CustoMotorista float NULL CONSTRAINT DF_Viagem_CustoMotorista DEFAULT (0),
  CustoVeiculo float NULL CONSTRAINT DF_Viagem_CustoVeiculo DEFAULT (0),
  CustoOperador float NULL CONSTRAINT DF_Viagem_CustoOperador DEFAULT (0),
  CustoLavador float NULL CONSTRAINT DF_Viagem_CustoLavador DEFAULT (0),
  Minutos int NULL CONSTRAINT DF_Viagem_Minutos DEFAULT (0),
  NomeEvento varchar(max) NULL CONSTRAINT DF_Viagem_NomeEvento DEFAULT (''),
  DescricaoSolucaoOcorrencia varchar(max) NULL CONSTRAINT DF_Viagem_DescricaoSolucaoOcorrencia DEFAULT (''),
  ImagemOcorrencia varchar(500) NULL DEFAULT ('semimagem.jpg'),
  ItemManutencaoId uniqueidentifier NULL,
  EventoId uniqueidentifier NULL,
  FoiAgendamento bit NULL DEFAULT (0),
  Recorrente varchar(50) NULL CONSTRAINT DF_Viagem_Recorrente DEFAULT (''),
  RecorrenciaViagemId uniqueidentifier NULL,
  Intervalo varchar(50) NULL CONSTRAINT DF_Viagem_Intervalo DEFAULT (''),
  DataFinalRecorrencia date NULL,
  Monday bit NULL CONSTRAINT DF_Viagem_Monday DEFAULT (0),
  Tuesday bit NULL CONSTRAINT DF_Viagem_Tuesday DEFAULT (0),
  Wednesday bit NULL CONSTRAINT DF_Viagem_Wednesday DEFAULT (0),
  Thursday bit NULL CONSTRAINT DF_Viagem_Thursday DEFAULT (0),
  Friday bit NULL CONSTRAINT DF_Viagem_Friday DEFAULT (0),
  Saturday bit NULL CONSTRAINT DF_Viagem_Saturday DEFAULT (0),
  Sunday bit NULL CONSTRAINT DF_Viagem_Sunday DEFAULT (0),
  AgendamentoTMP varchar(max) NULL CONSTRAINT DF_Viagem_AgendamentoTMP DEFAULT (''),
  DatasSelecionadas varchar(50) NULL CONSTRAINT DF_Viagem_DatasSelecionadas DEFAULT (''),
  DiaMesRecorrencia int NULL CONSTRAINT DF_Viagem_DiaMesRecorrencia DEFAULT (0),
  UsuarioIdAgendamento varchar(100) NULL,
  DataAgendamento datetime NULL,
  DescricaoViagemWord varbinary(max) NULL,
  DescricaoViagemImagem varbinary(max) NULL,
  UsuarioIdCancelamento varchar(100) NULL,
  DataCancelamento datetime NULL,
  Rubrica nvarchar(max) NULL CONSTRAINT DF_Viagem_Rubrica DEFAULT (''),
  DanoAvaria varchar(max) NULL CONSTRAINT DF_Viagem_DanoAvaria DEFAULT (''),
  StatusDocumentoFinal varchar(50) NULL CONSTRAINT DF_Viagem_StatusDocumentoFinal DEFAULT (''),
  StatusCartaoAbastecimentoFinal varchar(50) NULL CONSTRAINT DF_Viagem_StatusCartaoAbastecimentoFinal DEFAULT (''),
  RubricaFinal nvarchar(max) NULL CONSTRAINT DF_Viagem_RubricaFinal DEFAULT (''),
  DanoAvariaFinal varchar(max) NULL CONSTRAINT DF_Viagem_DanoAvariaFinal DEFAULT (''),
  FotosBase64 varbinary(max) NULL,
  VideosBase64 varbinary(max) NULL,
  FotosFinaisBase64 varbinary(max) NULL,
  VideosFinaisBase64 varbinary(max) NULL,
  VistoriadorInicialId varchar(50) NULL,
  VistoriadorFinalId varchar(50) NULL,
  CintaEntregue bit NULL DEFAULT (0),
  CintaDevolvida bit NULL DEFAULT (0),
  DataInicialNormalizada datetime2 NULL,
  DataFinalNormalizada datetime2 NULL,
  HoraInicioNormalizada time NULL,
  HoraFimNormalizada time NULL,
  MinutosNormalizado int NULL,
  KmInicialNormalizado int NULL,
  KmFinalNormalizado int NULL,
  FoiNormalizada bit NULL DEFAULT (0),
  TipoNormalizacao nvarchar(500) NULL,
  DataNormalizacao datetime2 NULL,
  KmRodadoNormalizado int NULL,
  KmRodado int NULL,
  Id int IDENTITY,
  TabletEntregue bit NULL DEFAULT (0),
  TabletDevolvido bit NULL DEFAULT (0),
  CONSTRAINT PK_Viagem_ViagemId PRIMARY KEY CLUSTERED (ViagemId)
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IDX_DataHora] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_DataHora] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_DataHora
  ON dbo.Viagem (DataInicial, HoraInicio)
  ON [PRIMARY]
GO

--
-- Create index [IDX_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_DataInicial
  ON dbo.Viagem (DataInicial)
  ON [PRIMARY]
GO

--
-- Create index [IDX_Ficha] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_Ficha] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_Ficha
  ON dbo.Viagem (NoFichaVistoria)
  ON [PRIMARY]
GO

--
-- Create index [IDX_ItemManutencaoId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_ItemManutencaoId] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_ItemManutencaoId
  ON dbo.Viagem (ItemManutencaoId)
  ON [PRIMARY]
GO

--
-- Create index [IDX_MotoristaId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_MotoristaId] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_MotoristaId
  ON dbo.Viagem (MotoristaId)
  ON [PRIMARY]
GO

--
-- Create index [IDX_NoFichaVistoria] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_NoFichaVistoria] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_NoFichaVistoria
  ON dbo.Viagem (NoFichaVistoria)
  ON [PRIMARY]
GO

--
-- Create index [IDX_Requistante] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_Requistante] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_Requistante
  ON dbo.Viagem (RequisitanteId)
  ON [PRIMARY]
GO

--
-- Create index [IDX_SetorId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_SetorId] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_SetorId
  ON dbo.Viagem (SetorSolicitanteId)
  ON [PRIMARY]
GO

--
-- Create index [IDX_Status] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_Status] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_Status
  ON dbo.Viagem (Status)
  ON [PRIMARY]
GO

--
-- Create index [IDX_StatusOcorrencia] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_StatusOcorrencia] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_StatusOcorrencia
  ON dbo.Viagem (StatusOcorrencia)
  ON [PRIMARY]
GO

--
-- Create index [IDX_VeiculoId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IDX_VeiculoId] on table [dbo].[Viagem]')
GO
CREATE INDEX IDX_VeiculoId
  ON dbo.Viagem (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicial
  ON dbo.Viagem (DataInicial)
  INCLUDE (ViagemId, RecorrenciaViagemId, Status)
  WHERE ([Status] IN ('Agendada', 'Confirmada', 'EmAndamento'))
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicial_KM] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicial_KM] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicial_KM
  ON dbo.Viagem (DataInicial, KmInicial, KmFinal)
  INCLUDE (CustoCombustivel, CustoMotorista, CustoVeiculo, CustoOperador, CustoLavador)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicial_MotoristaId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicial_MotoristaId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicial_MotoristaId
  ON dbo.Viagem (DataInicial, MotoristaId)
  INCLUDE (KmInicial, KmFinal, Minutos)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicial_RecorrenciaViagemId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicial_RecorrenciaViagemId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicial_RecorrenciaViagemId
  ON dbo.Viagem (DataInicial, RecorrenciaViagemId)
  INCLUDE (HoraInicio, ViagemId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicial_Status] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicial_Status] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicial_Status
  ON dbo.Viagem (DataInicial, Status)
  INCLUDE (Minutos)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicial_Status_Realizada] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicial_Status_Realizada] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicial_Status_Realizada
  ON dbo.Viagem (DataInicial, Status)
  WHERE ([Status]='Realizada')
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataInicialNormalizada] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataInicialNormalizada] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataInicialNormalizada
  ON dbo.Viagem (DataInicialNormalizada)
  INCLUDE (ViagemId, KmRodadoNormalizado, MinutosNormalizado, FoiNormalizada, TipoNormalizacao)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_DataNormalizacao] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_DataNormalizacao] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_DataNormalizacao
  ON dbo.Viagem (DataNormalizacao)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_EventoId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_EventoId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_EventoId
  ON dbo.Viagem (EventoId)
  INCLUDE (CustoCombustivel, CustoMotorista, CustoVeiculo, CustoOperador, CustoLavador)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_EventoId_Custos] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_EventoId_Custos] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_EventoId_Custos
  ON dbo.Viagem (EventoId)
  INCLUDE (CustoCombustivel, CustoMotorista, CustoVeiculo, CustoOperador, CustoLavador)
  WHERE ([EventoId] IS NOT NULL)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_EventoId_Include_Custos] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_EventoId_Include_Custos] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_EventoId_Include_Custos
  ON dbo.Viagem (EventoId)
  INCLUDE (CustoCombustivel, CustoMotorista, CustoVeiculo, CustoOperador, CustoLavador)
  WHERE ([EventoId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_EventoId_Status] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_EventoId_Status] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_EventoId_Status
  ON dbo.Viagem (EventoId, Status)
  INCLUDE (DataInicial, DataFinal, VeiculoId, MotoristaId, NoFichaVistoria, CustoCombustivel)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_Finalidade_StatusAgendamento] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_Finalidade_StatusAgendamento] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_Finalidade_StatusAgendamento
  ON dbo.Viagem (Finalidade, StatusAgendamento)
  INCLUDE (DataInicial, DataFinal, Status, VeiculoId, MotoristaId, EventoId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_FoiNormalizada] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_FoiNormalizada] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_FoiNormalizada
  ON dbo.Viagem (FoiNormalizada, DataNormalizacao)
  INCLUDE (DataInicial, TipoNormalizacao)
  WHERE ([FoiNormalizada]=(1))
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_ItemManutencaoId_Completo] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_ItemManutencaoId_Completo] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_ItemManutencaoId_Completo
  ON dbo.Viagem (ItemManutencaoId)
  INCLUDE (ViagemId, VeiculoId, DataInicial, Status, StatusOcorrencia, ResumoOcorrencia)
  WHERE ([ItemManutencaoId] IS NOT NULL)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_MotoristaId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_MotoristaId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_MotoristaId
  ON dbo.Viagem (MotoristaId, DataInicial)
  INCLUDE (CustoCombustivel, CustoMotorista, CustoVeiculo, CustoOperador, CustoLavador, KmInicial, KmFinal)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_MotoristaId_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_MotoristaId_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_MotoristaId_DataInicial
  ON dbo.Viagem (MotoristaId, DataInicial)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_MotoristaId_StatusAgendamento] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_MotoristaId_StatusAgendamento] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_MotoristaId_StatusAgendamento
  ON dbo.Viagem (MotoristaId, StatusAgendamento)
  INCLUDE (DataInicial, DataFinal, Status, VeiculoId, CustoCombustivel, CustoMotorista)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_NoFichaVistoria_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_NoFichaVistoria_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_NoFichaVistoria_DataInicial
  ON dbo.Viagem (NoFichaVistoria, DataInicial DESC, HoraInicio DESC)
  INCLUDE (Status, VeiculoId, MotoristaId, EventoId)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_RecorrenciaViagemId_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_RecorrenciaViagemId_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_RecorrenciaViagemId_DataInicial
  ON dbo.Viagem (RecorrenciaViagemId, DataInicial)
  INCLUDE (ViagemId, Status)
  WHERE ([Status]<>'Cancelada')
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_RequisitanteId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_RequisitanteId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_RequisitanteId
  ON dbo.Viagem (RequisitanteId, DataInicial)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_RequisitanteId_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_RequisitanteId_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_RequisitanteId_DataInicial
  ON dbo.Viagem (RequisitanteId, DataInicial)
  INCLUDE (Status, StatusAgendamento, CustoCombustivel, CustoMotorista, VeiculoId, MotoristaId, SetorSolicitanteId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_SetorSolicitanteId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_SetorSolicitanteId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_SetorSolicitanteId
  ON dbo.Viagem (SetorSolicitanteId, DataInicial)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_SetorSolicitanteId_DataInicial] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_SetorSolicitanteId_DataInicial] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_SetorSolicitanteId_DataInicial
  ON dbo.Viagem (SetorSolicitanteId, DataInicial)
  INCLUDE (Status, StatusAgendamento, CustoCombustivel, CustoMotorista, VeiculoId, MotoristaId)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_Status] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_Status] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_Status
  ON dbo.Viagem (Status, DataInicial)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_Status_DadosCompletos] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_Status_DadosCompletos] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_Status_DadosCompletos
  ON dbo.Viagem (Status)
  INCLUDE (ViagemId, VeiculoId, MotoristaId, DataInicial, DataFinal, HoraInicio, HoraFim, KmInicial, KmFinal)
  WHERE ([Status]='Realizada' AND [DataInicial] IS NOT NULL AND [DataFinal] IS NOT NULL AND [HoraInicio] IS NOT NULL AND [HoraFim] IS NOT NULL AND [KmInicial] IS NOT NULL AND [KmFinal] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_StatusOcorrencia_DataFinal] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_StatusOcorrencia_DataFinal] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_StatusOcorrencia_DataFinal
  ON dbo.Viagem (StatusOcorrencia, DataFinal DESC)
  INCLUDE (VeiculoId, MotoristaId, ResumoOcorrencia, NoFichaVistoria, DataInicial)
  WHERE ([ResumoOcorrencia] IS NOT NULL AND [ResumoOcorrencia]<>'')
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_VeiculoId] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_VeiculoId] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_VeiculoId
  ON dbo.Viagem (VeiculoId, DataInicial)
  INCLUDE (CustoCombustivel, CustoMotorista, CustoVeiculo, CustoOperador, CustoLavador, KmInicial, KmFinal)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_VeiculoId_StatusAgendamento] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_VeiculoId_StatusAgendamento] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_VeiculoId_StatusAgendamento
  ON dbo.Viagem (VeiculoId, StatusAgendamento)
  INCLUDE (DataInicial, DataFinal, Status, MotoristaId, CustoCombustivel, CustoMotorista)
  WITH (FILLFACTOR = 90)
  ON [PRIMARY]
GO

--
-- Create index [IX_Viagem_ViagemId_Status] on table [dbo].[Viagem]
--
PRINT (N'Create index [IX_Viagem_ViagemId_Status] on table [dbo].[Viagem]')
GO
CREATE INDEX IX_Viagem_ViagemId_Status
  ON dbo.Viagem (ViagemId, Status)
  INCLUDE (DataInicial, RecorrenciaViagemId)
  ON [PRIMARY]
GO

--
-- Create or alter trigger [tr_Viagem_CalculaMinutos] on table [dbo].[Viagem]
--
GO
PRINT (N'Create or alter trigger [tr_Viagem_CalculaMinutos] on table [dbo].[Viagem]')
GO
CREATE OR ALTER TRIGGER dbo.tr_Viagem_CalculaMinutos
ON dbo.Viagem
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON
    
    -- ═══════════════════════════════════════════════════════════════════════
    -- PROTEÇÃO ANTI-RECURSÃO via CONTEXT_INFO
    -- ═══════════════════════════════════════════════════════════════════════
    IF CONTEXT_INFO() = 0x1
        RETURN
    
    SET CONTEXT_INFO 0x1
    
    BEGIN TRY
        -- ★ CONVERSÃO DATETIME → TIME (HoraInicio/HoraFim são DATETIME na tabela)
        UPDATE v
        SET v.Minutos = dbo.fn_CalculaMinutosUteis(
            i.DataInicial,
            i.DataFinal,
            CAST(i.HoraInicio AS TIME),
            CAST(i.HoraFim AS TIME)
        )
        FROM Viagem v
        INNER JOIN inserted i ON v.ViagemId = i.ViagemId
        WHERE i.DataInicial IS NOT NULL 
          AND i.DataFinal IS NOT NULL
          AND i.HoraInicio IS NOT NULL 
          AND i.HoraFim IS NOT NULL
    END TRY
    BEGIN CATCH
        -- Silencioso
    END CATCH
    
    SET CONTEXT_INFO 0x0
END
GO

--
-- Create or alter trigger [TR_Viagem_NormalizarMinutos] on table [dbo].[Viagem]
--
GO
PRINT (N'Create or alter trigger [TR_Viagem_NormalizarMinutos] on table [dbo].[Viagem]')
GO
CREATE OR ALTER TRIGGER dbo.TR_Viagem_NormalizarMinutos
ON Viagem
AFTER INSERT, UPDATE
AS
BEGIN
    SET NOCOUNT ON
    
    -- =========================================================================
    -- REGRA 1: Se Minutos é NULL, converter para 0
    -- REGRA 2: Se Status <> 'Realizada', Minutos = 0
    -- REGRA 3: Se Status = 'Realizada' e Minutos = 0/NULL e tem datas, calcular
    -- =========================================================================
    
    UPDATE v
    SET Minutos = 
        CASE 
            -- Se não é Realizada, sempre 0
            WHEN i.Status <> 'Realizada' THEN 0
            
            -- Se é Realizada e tem Minutos válido (> 0), manter
            WHEN i.Status = 'Realizada' AND ISNULL(i.Minutos, 0) > 0 THEN i.Minutos
            
            -- Se é Realizada, sem Minutos, mas tem todas as datas, calcular
            WHEN i.Status = 'Realizada' 
                 AND i.DataInicial IS NOT NULL 
                 AND i.DataFinal IS NOT NULL 
                 AND i.HoraInicio IS NOT NULL 
                 AND i.HoraFim IS NOT NULL
            THEN ABS(DATEDIFF(MINUTE, 
                    DATEADD(MINUTE, 
                        DATEPART(HOUR, i.HoraInicio) * 60 + DATEPART(MINUTE, i.HoraInicio),
                        CAST(CAST(i.DataInicial AS DATE) AS DATETIME)),
                    DATEADD(MINUTE, 
                        DATEPART(HOUR, i.HoraFim) * 60 + DATEPART(MINUTE, i.HoraFim),
                        CAST(CAST(i.DataFinal AS DATE) AS DATETIME))))
            
            -- Caso contrário, 0
            ELSE 0
        END
    FROM Viagem v
    INNER JOIN inserted i ON v.ViagemId = i.ViagemId
    WHERE v.Minutos IS NULL 
       OR v.Minutos < 0
       OR (i.Status <> 'Realizada' AND v.Minutos <> 0)
       OR (i.Status = 'Realizada' AND v.Minutos = 0 
           AND i.DataInicial IS NOT NULL 
           AND i.DataFinal IS NOT NULL 
           AND i.HoraInicio IS NOT NULL 
           AND i.HoraFim IS NOT NULL)
END
GO

--
-- Create foreign key [FK_Viagem_EventoId] on table [dbo].[Viagem]
--
PRINT (N'Create foreign key [FK_Viagem_EventoId] on table [dbo].[Viagem]')
GO
ALTER TABLE dbo.Viagem
  ADD CONSTRAINT FK_Viagem_EventoId FOREIGN KEY (EventoId) REFERENCES dbo.Evento (EventoId)
GO

--
-- Create foreign key [FK_Viagem_ItemManutencaoId] on table [dbo].[Viagem]
--
PRINT (N'Create foreign key [FK_Viagem_ItemManutencaoId] on table [dbo].[Viagem]')
GO
ALTER TABLE dbo.Viagem
  ADD CONSTRAINT FK_Viagem_ItemManutencaoId FOREIGN KEY (ItemManutencaoId) REFERENCES dbo.ItensManutencao (ItemManutencaoId)
GO

--
-- Create foreign key [FK_Viagem_Motorista] on table [dbo].[Viagem]
--
PRINT (N'Create foreign key [FK_Viagem_Motorista] on table [dbo].[Viagem]')
GO
ALTER TABLE dbo.Viagem
  ADD CONSTRAINT FK_Viagem_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId)
GO

--
-- Create foreign key [FK_Viagem_Requisitante] on table [dbo].[Viagem]
--
PRINT (N'Create foreign key [FK_Viagem_Requisitante] on table [dbo].[Viagem]')
GO
ALTER TABLE dbo.Viagem
  ADD CONSTRAINT FK_Viagem_Requisitante FOREIGN KEY (RequisitanteId) REFERENCES dbo.Requisitante (RequisitanteId)
GO

--
-- Create foreign key [FK_Viagem_Setor] on table [dbo].[Viagem]
--
PRINT (N'Create foreign key [FK_Viagem_Setor] on table [dbo].[Viagem]')
GO
ALTER TABLE dbo.Viagem
  ADD CONSTRAINT FK_Viagem_Setor FOREIGN KEY (SetorSolicitanteId) REFERENCES dbo.SetorSolicitante (SetorSolicitanteId)
GO

--
-- Create foreign key [FK_Viagem_Veiculo] on table [dbo].[Viagem]
--
PRINT (N'Create foreign key [FK_Viagem_Veiculo] on table [dbo].[Viagem]')
GO
ALTER TABLE dbo.Viagem
  ADD CONSTRAINT FK_Viagem_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create foreign key [FK_ItensManutencao_Viagem] on table [dbo].[ItensManutencao]
--
PRINT (N'Create foreign key [FK_ItensManutencao_Viagem] on table [dbo].[ItensManutencao]')
GO
ALTER TABLE dbo.ItensManutencao
  ADD CONSTRAINT FK_ItensManutencao_Viagem FOREIGN KEY (ViagemId) REFERENCES dbo.Viagem (ViagemId)
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasMotoristaUnico]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasMotoristaUnico]')
GO

  CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasMotoristaUnico
      @MotoristaId UNIQUEIDENTIFIER,
      @Ano INT,
      @Mes INT
  AS
  BEGIN
      SET NOCOUNT ON;

      DECLARE @DataInicio DATE = DATEFROMPARTS(@Ano, @Mes, 1);
      DECLARE @DataFim DATE = EOMONTH(@DataInicio);

      BEGIN TRY
          DELETE FROM EstatisticaMotoristasMensal
          WHERE MotoristaId = @MotoristaId AND Ano = @Ano AND Mes = @Mes;

          INSERT INTO EstatisticaMotoristasMensal (MotoristaId, Ano, Mes, TotalViagens, KmTotal, MinutosTotais, DataAtualizacao)
          SELECT
              @MotoristaId,
              @Ano,
              @Mes,
              COUNT(*),
              SUM(CASE
                  WHEN v.KmInicial IS NOT NULL AND v.KmFinal IS NOT NULL
                       AND v.KmFinal >= v.KmInicial
                       AND (v.KmFinal - v.KmInicial) <= 2000
                  THEN v.KmFinal - v.KmInicial
                  ELSE 0
              END),
              SUM(ISNULL(v.Minutos, 0)),
              GETDATE()
          FROM Viagem v
          WHERE v.MotoristaId = @MotoristaId
            AND v.DataInicial >= @DataInicio
            AND v.DataInicial < DATEADD(DAY, 1, @DataFim);

          IF @@ROWCOUNT = 0
          BEGIN
              INSERT INTO EstatisticaMotoristasMensal (MotoristaId, Ano, Mes, DataAtualizacao)
              VALUES (@MotoristaId, @Ano, @Mes, GETDATE());
          END

          UPDATE e
          SET e.TotalMultas = ISNULL(m.Total, 0),
              e.ValorTotalMultas = ISNULL(m.Valor, 0),
              e.DataAtualizacao = GETDATE()
          FROM EstatisticaMotoristasMensal e
          LEFT JOIN (
              SELECT COUNT(*) as Total, SUM(ISNULL(ValorAteVencimento, 0)) as Valor
              FROM Multa
              WHERE MotoristaId = @MotoristaId
                AND Data >= @DataInicio AND Data < DATEADD(DAY, 1, @DataFim)
          ) m ON 1=1
          WHERE e.MotoristaId = @MotoristaId AND e.Ano = @Ano AND e.Mes = @Mes;

          UPDATE e
          SET e.TotalAbastecimentos = ISNULL(a.Total, 0),
              e.LitrosTotais = ISNULL(a.Litros, 0),
              e.ValorTotalAbastecimentos = ISNULL(a.Valor, 0),
              e.DataAtualizacao = GETDATE()
          FROM EstatisticaMotoristasMensal e
          LEFT JOIN (
              SELECT COUNT(*) as Total,
                     SUM(ISNULL(Litros, 0)) as Litros,
                     SUM(ISNULL(Litros, 0) * ISNULL(ValorUnitario, 0)) as Valor
              FROM Abastecimento
              WHERE MotoristaId = @MotoristaId
                AND DataHora >= @DataInicio AND DataHora < DATEADD(DAY, 1, @DataFim)
          ) a ON 1=1
          WHERE e.MotoristaId = @MotoristaId AND e.Ano = @Ano AND e.Mes = @Mes;

          -- HEATMAP - CORRIGIDO: Usar HoraInicio
          DELETE FROM HeatmapViagensMensal
          WHERE Ano = @Ano AND Mes = @Mes AND MotoristaId = @MotoristaId;

          INSERT INTO HeatmapViagensMensal (Ano, Mes, MotoristaId, DiaSemana, Hora, TotalViagens, DataAtualizacao)
          SELECT
              @Ano, @Mes, @MotoristaId,
              DATEPART(WEEKDAY, v.HoraInicio) - 1,  -- CORRIGIDO: HoraInicio
              DATEPART(HOUR, v.HoraInicio),          -- CORRIGIDO: HoraInicio
              COUNT(*),
              GETDATE()
          FROM Viagem v
          WHERE v.MotoristaId = @MotoristaId
            AND v.DataInicial >= @DataInicio
            AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
            AND v.HoraInicio IS NOT NULL
          GROUP BY DATEPART(WEEKDAY, v.HoraInicio), DATEPART(HOUR, v.HoraInicio);

          DELETE FROM EvolucaoViagensDiaria
          WHERE Data >= @DataInicio AND Data <= @DataFim AND MotoristaId = @MotoristaId;

          INSERT INTO EvolucaoViagensDiaria (Data, MotoristaId, TotalViagens, KmTotal, MinutosTotais, DataAtualizacao)
          SELECT
              CAST(v.DataInicial AS DATE),
              @MotoristaId,
              COUNT(*),
              SUM(CASE
                  WHEN v.KmInicial IS NOT NULL AND v.KmFinal IS NOT NULL
                       AND v.KmFinal >= v.KmInicial
                       AND (v.KmFinal - v.KmInicial) <= 2000
                  THEN v.KmFinal - v.KmInicial
                  ELSE 0
              END),
              SUM(ISNULL(v.Minutos, 0)),
              GETDATE()
          FROM Viagem v
          WHERE v.MotoristaId = @MotoristaId
            AND v.DataInicial >= @DataInicio
            AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
          GROUP BY CAST(v.DataInicial AS DATE);

      END TRY
      BEGIN CATCH
          THROW;
      END CATCH
  END
  
GO

--
-- Create or alter trigger [trg_Viagem_AtualizarEstatisticasMotoristas] on table [dbo].[Viagem]
--
GO
PRINT (N'Create or alter trigger [trg_Viagem_AtualizarEstatisticasMotoristas] on table [dbo].[Viagem]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Viagem_AtualizarEstatisticasMotoristas
ON Viagem
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Coleta motoristas/meses afetados (inseridos/atualizados)
    DECLARE @Afetados TABLE (MotoristaId UNIQUEIDENTIFIER, Ano INT, Mes INT);

    INSERT INTO @Afetados (MotoristaId, Ano, Mes)
    SELECT DISTINCT MotoristaId, YEAR(DataInicial), MONTH(DataInicial)
    FROM inserted
    WHERE MotoristaId IS NOT NULL AND DataInicial IS NOT NULL;

    INSERT INTO @Afetados (MotoristaId, Ano, Mes)
    SELECT DISTINCT MotoristaId, YEAR(DataInicial), MONTH(DataInicial)
    FROM deleted
    WHERE MotoristaId IS NOT NULL AND DataInicial IS NOT NULL
      AND NOT EXISTS (
          SELECT 1 FROM @Afetados a
          WHERE a.MotoristaId = deleted.MotoristaId
            AND a.Ano = YEAR(deleted.DataInicial)
            AND a.Mes = MONTH(deleted.DataInicial)
      );

    -- Recalcula estatísticas para cada motorista/mês afetado
    DECLARE @MotoristaId UNIQUEIDENTIFIER, @Ano INT, @Mes INT;
    DECLARE cur CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT MotoristaId, Ano, Mes FROM @Afetados;

    OPEN cur;
    FETCH NEXT FROM cur INTO @MotoristaId, @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC sp_RecalcularEstatisticasMotoristaUnico @MotoristaId, @Ano, @Mes;
        FETCH NEXT FROM cur INTO @MotoristaId, @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;

    -- Recalcula estatísticas gerais dos meses afetados
    DECLARE cur2 CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT Ano, Mes FROM @Afetados;

    OPEN cur2;
    FETCH NEXT FROM cur2 INTO @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Atualiza apenas os totais gerais
        UPDATE EstatisticaGeralMensal
        SET TotalViagens = ISNULL((SELECT SUM(TotalViagens) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
            KmTotal = ISNULL((SELECT SUM(KmTotal) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
            HorasTotais = ISNULL((SELECT SUM(MinutosTotais) / 60.0 FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
            DataAtualizacao = GETDATE()
        WHERE Ano = @Ano AND Mes = @Mes;

        -- Atualiza heatmap geral do mês
        DELETE FROM HeatmapViagensMensal WHERE Ano = @Ano AND Mes = @Mes AND MotoristaId IS NULL;

        DECLARE @DataInicio DATE = DATEFROMPARTS(@Ano, @Mes, 1);
        DECLARE @DataFim DATE = EOMONTH(@DataInicio);

        INSERT INTO HeatmapViagensMensal (Ano, Mes, MotoristaId, DiaSemana, Hora, TotalViagens, DataAtualizacao)
        SELECT
            @Ano, @Mes, NULL,
            DATEPART(WEEKDAY, v.DataInicial) - 1,
            DATEPART(HOUR, v.DataInicial),
            COUNT(*),
            GETDATE()
        FROM Viagem v
        WHERE v.MotoristaId IS NOT NULL
          AND v.DataInicial >= @DataInicio
          AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
        GROUP BY DATEPART(WEEKDAY, v.DataInicial), DATEPART(HOUR, v.DataInicial);

        -- Atualiza evolução diária geral
        DELETE FROM EvolucaoViagensDiaria
        WHERE Data >= @DataInicio AND Data <= @DataFim AND MotoristaId IS NULL;

        INSERT INTO EvolucaoViagensDiaria (Data, MotoristaId, TotalViagens, KmTotal, MinutosTotais, DataAtualizacao)
        SELECT
            CAST(v.DataInicial AS DATE),
            NULL,
            COUNT(*),
            SUM(CASE
                WHEN v.KmInicial IS NOT NULL AND v.KmFinal IS NOT NULL
                     AND v.KmFinal >= v.KmInicial
                     AND (v.KmFinal - v.KmInicial) <= 2000
                THEN v.KmFinal - v.KmInicial
                ELSE 0
            END),
            SUM(ISNULL(v.Minutos, 0)),
            GETDATE()
        FROM Viagem v
        WHERE v.MotoristaId IS NOT NULL
          AND v.DataInicial >= @DataInicio
          AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
        GROUP BY CAST(v.DataInicial AS DATE);

        FETCH NEXT FROM cur2 INTO @Ano, @Mes;
    END

    CLOSE cur2;
    DEALLOCATE cur2;
END
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasMotoristas]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasMotoristas]')
GO

  CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasMotoristas
      @Ano INT,
      @Mes INT
  AS
  BEGIN
      SET NOCOUNT ON;

      DECLARE @DataInicio DATE = DATEFROMPARTS(@Ano, @Mes, 1);
      DECLARE @DataFim DATE = EOMONTH(@DataInicio);
      DECLARE @Hoje DATE = GETDATE();

      BEGIN TRY
          BEGIN TRANSACTION;

          -- Limpa dados existentes do mês
          DELETE FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes;

          -- Insere estatísticas de viagens por motorista
          INSERT INTO EstatisticaMotoristasMensal (MotoristaId, Ano, Mes, TotalViagens, KmTotal, MinutosTotais, DataAtualizacao)
          SELECT
              v.MotoristaId,
              @Ano,
              @Mes,
              COUNT(*),
              SUM(CASE
                  WHEN v.KmInicial IS NOT NULL AND v.KmFinal IS NOT NULL
                       AND v.KmFinal >= v.KmInicial
                       AND (v.KmFinal - v.KmInicial) <= 2000
                  THEN v.KmFinal - v.KmInicial
                  ELSE 0
              END),
              SUM(ISNULL(v.Minutos, 0)),
              GETDATE()
          FROM Viagem v
          WHERE v.MotoristaId IS NOT NULL
            AND v.DataInicial >= @DataInicio
            AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
          GROUP BY v.MotoristaId;

          -- Atualiza multas por motorista
          UPDATE e
          SET e.TotalMultas = ISNULL(m.Total, 0),
              e.ValorTotalMultas = ISNULL(m.Valor, 0),
              e.DataAtualizacao = GETDATE()
          FROM EstatisticaMotoristasMensal e
          LEFT JOIN (
              SELECT MotoristaId, COUNT(*) as Total, SUM(ISNULL(ValorAteVencimento, 0)) as Valor
              FROM Multa
              WHERE Data >= @DataInicio AND Data < DATEADD(DAY, 1, @DataFim)
                AND MotoristaId IS NOT NULL
              GROUP BY MotoristaId
          ) m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes;

          -- Insere motoristas que só têm multas (sem viagens)
          INSERT INTO EstatisticaMotoristasMensal (MotoristaId, Ano, Mes, TotalMultas, ValorTotalMultas, DataAtualizacao)
          SELECT
              m.MotoristaId,
              @Ano,
              @Mes,
              COUNT(*),
              SUM(ISNULL(m.ValorAteVencimento, 0)),
              GETDATE()
          FROM Multa m
          WHERE m.MotoristaId IS NOT NULL
            AND m.Data >= @DataInicio
            AND m.Data < DATEADD(DAY, 1, @DataFim)
            AND NOT EXISTS (
                SELECT 1 FROM EstatisticaMotoristasMensal e
                WHERE e.MotoristaId = m.MotoristaId AND e.Ano = @Ano AND e.Mes = @Mes
            )
          GROUP BY m.MotoristaId;

          -- Atualiza abastecimentos por motorista
          UPDATE e
          SET e.TotalAbastecimentos = ISNULL(a.Total, 0),
              e.LitrosTotais = ISNULL(a.Litros, 0),
              e.ValorTotalAbastecimentos = ISNULL(a.Valor, 0),
              e.DataAtualizacao = GETDATE()
          FROM EstatisticaMotoristasMensal e
          LEFT JOIN (
              SELECT MotoristaId, COUNT(*) as Total,
                     SUM(ISNULL(Litros, 0)) as Litros,
                     SUM(ISNULL(Litros, 0) * ISNULL(ValorUnitario, 0)) as Valor
              FROM Abastecimento
              WHERE DataHora >= @DataInicio AND DataHora < DATEADD(DAY, 1, @DataFim)
                AND MotoristaId IS NOT NULL AND MotoristaId <> '00000000-0000-0000-0000-000000000000'
              GROUP BY MotoristaId
          ) a ON e.MotoristaId = a.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes;

          -- Estatísticas Gerais do Mês
          DELETE FROM EstatisticaGeralMensal WHERE Ano = @Ano AND Mes = @Mes;

          INSERT INTO EstatisticaGeralMensal (
              Ano, Mes,
              TotalMotoristas, MotoristasAtivos, MotoristasInativos,
              Efetivos, Feristas, Cobertura,
              TotalViagens, KmTotal, HorasTotais,
              TotalMultas, ValorTotalMultas,
              TotalAbastecimentos,
              DataAtualizacao
          )
          SELECT
              @Ano,
              @Mes,
              (SELECT COUNT(*) FROM Motorista),
              (SELECT COUNT(*) FROM Motorista WHERE Status = 1),
              (SELECT COUNT(*) FROM Motorista WHERE Status = 0),
              (SELECT COUNT(*) FROM Motorista WHERE Status = 1 AND (EfetivoFerista = 'Efetivo' OR EfetivoFerista IS NULL OR EfetivoFerista = '')),    
              (SELECT COUNT(*) FROM Motorista WHERE Status = 1 AND EfetivoFerista = 'Ferista'),
              (SELECT COUNT(*) FROM Motorista WHERE Status = 1 AND EfetivoFerista = 'Cobertura'),
              ISNULL((SELECT SUM(TotalViagens) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
              ISNULL((SELECT SUM(KmTotal) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
              ISNULL((SELECT SUM(MinutosTotais) / 60.0 FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
              ISNULL((SELECT SUM(TotalMultas) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
              ISNULL((SELECT SUM(ValorTotalMultas) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
              ISNULL((SELECT SUM(TotalAbastecimentos) FROM EstatisticaMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes), 0),
              GETDATE();

          -- Rankings Top 10
          DELETE FROM RankingMotoristasMensal WHERE Ano = @Ano AND Mes = @Mes;

          -- Top 10 por Viagens
          INSERT INTO RankingMotoristasMensal (Ano, Mes, TipoRanking, Posicao, MotoristaId, NomeMotorista, TipoMotorista, ValorPrincipal, DataAtualizacao)
          SELECT TOP 10
              @Ano, @Mes, 'VIAGENS', ROW_NUMBER() OVER (ORDER BY e.TotalViagens DESC),
              e.MotoristaId, m.Nome, ISNULL(m.EfetivoFerista, 'Efetivo'), e.TotalViagens, GETDATE()
          FROM EstatisticaMotoristasMensal e
          INNER JOIN Motorista m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes AND e.TotalViagens > 0
          ORDER BY e.TotalViagens DESC;

          -- Top 10 por KM
          INSERT INTO RankingMotoristasMensal (Ano, Mes, TipoRanking, Posicao, MotoristaId, NomeMotorista, TipoMotorista, ValorPrincipal, DataAtualizacao)
          SELECT TOP 10
              @Ano, @Mes, 'KM', ROW_NUMBER() OVER (ORDER BY e.KmTotal DESC),
              e.MotoristaId, m.Nome, ISNULL(m.EfetivoFerista, 'Efetivo'), e.KmTotal, GETDATE()
          FROM EstatisticaMotoristasMensal e
          INNER JOIN Motorista m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes AND e.KmTotal > 0
          ORDER BY e.KmTotal DESC;

          -- Top 10 por Horas
          INSERT INTO RankingMotoristasMensal (Ano, Mes, TipoRanking, Posicao, MotoristaId, NomeMotorista, TipoMotorista, ValorPrincipal, DataAtualizacao)
          SELECT TOP 10
              @Ano, @Mes, 'HORAS', ROW_NUMBER() OVER (ORDER BY e.MinutosTotais DESC),
              e.MotoristaId, m.Nome, ISNULL(m.EfetivoFerista, 'Efetivo'), ROUND(e.MinutosTotais / 60.0, 1), GETDATE()
          FROM EstatisticaMotoristasMensal e
          INNER JOIN Motorista m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes AND e.MinutosTotais > 0
          ORDER BY e.MinutosTotais DESC;

          -- Top 10 por Abastecimentos
          INSERT INTO RankingMotoristasMensal (Ano, Mes, TipoRanking, Posicao, MotoristaId, NomeMotorista, TipoMotorista, ValorPrincipal, DataAtualizacao)
          SELECT TOP 10
              @Ano, @Mes, 'ABASTECIMENTOS', ROW_NUMBER() OVER (ORDER BY e.TotalAbastecimentos DESC),
              e.MotoristaId, m.Nome, ISNULL(m.EfetivoFerista, 'Efetivo'), e.TotalAbastecimentos, GETDATE()
          FROM EstatisticaMotoristasMensal e
          INNER JOIN Motorista m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes AND e.TotalAbastecimentos > 0
          ORDER BY e.TotalAbastecimentos DESC;

          -- Top 10 por Multas
          INSERT INTO RankingMotoristasMensal (Ano, Mes, TipoRanking, Posicao, MotoristaId, NomeMotorista, TipoMotorista, ValorPrincipal, ValorSecundario, DataAtualizacao)
          SELECT TOP 10
              @Ano, @Mes, 'MULTAS', ROW_NUMBER() OVER (ORDER BY e.TotalMultas DESC),
              e.MotoristaId, m.Nome, ISNULL(m.EfetivoFerista, 'Efetivo'), e.TotalMultas, e.ValorTotalMultas, GETDATE()
          FROM EstatisticaMotoristasMensal e
          INNER JOIN Motorista m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes AND e.TotalMultas > 0
          ORDER BY e.TotalMultas DESC;

          -- Top 10 Performance
          INSERT INTO RankingMotoristasMensal (Ano, Mes, TipoRanking, Posicao, MotoristaId, NomeMotorista, TipoMotorista, ValorPrincipal, ValorSecundario, ValorTerciario, ValorQuaternario, DataAtualizacao)
          SELECT TOP 10
              @Ano, @Mes, 'PERFORMANCE', ROW_NUMBER() OVER (ORDER BY e.TotalViagens DESC),
              e.MotoristaId, m.Nome, ISNULL(m.EfetivoFerista, 'Efetivo'),
              e.TotalViagens, e.KmTotal, ROUND(e.MinutosTotais / 60.0, 1), e.TotalMultas, GETDATE()
          FROM EstatisticaMotoristasMensal e
          INNER JOIN Motorista m ON e.MotoristaId = m.MotoristaId
          WHERE e.Ano = @Ano AND e.Mes = @Mes AND e.TotalViagens > 0
          ORDER BY e.TotalViagens DESC;

          -- =====================================================
          -- HEATMAP - CORRIGIDO: Usar HoraInicio para extrair a hora
          -- =====================================================
          DELETE FROM HeatmapViagensMensal WHERE Ano = @Ano AND Mes = @Mes AND MotoristaId IS NULL;

          INSERT INTO HeatmapViagensMensal (Ano, Mes, MotoristaId, DiaSemana, Hora, TotalViagens, DataAtualizacao)
          SELECT
              @Ano, @Mes, NULL,
              DATEPART(WEEKDAY, v.HoraInicio) - 1,  -- CORRIGIDO: HoraInicio
              DATEPART(HOUR, v.HoraInicio),          -- CORRIGIDO: HoraInicio
              COUNT(*),
              GETDATE()
          FROM Viagem v
          WHERE v.MotoristaId IS NOT NULL
            AND v.DataInicial >= @DataInicio
            AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
            AND v.HoraInicio IS NOT NULL
          GROUP BY DATEPART(WEEKDAY, v.HoraInicio), DATEPART(HOUR, v.HoraInicio);

          -- Evolução Diária de Viagens (Todos os motoristas)
          DELETE FROM EvolucaoViagensDiaria
          WHERE Data >= @DataInicio AND Data <= @DataFim AND MotoristaId IS NULL;

          INSERT INTO EvolucaoViagensDiaria (Data, MotoristaId, TotalViagens, KmTotal, MinutosTotais, DataAtualizacao)
          SELECT
              CAST(v.DataInicial AS DATE),
              NULL,
              COUNT(*),
              SUM(CASE
                  WHEN v.KmInicial IS NOT NULL AND v.KmFinal IS NOT NULL
                       AND v.KmFinal >= v.KmInicial
                       AND (v.KmFinal - v.KmInicial) <= 2000
                  THEN v.KmFinal - v.KmInicial
                  ELSE 0
              END),
              SUM(ISNULL(v.Minutos, 0)),
              GETDATE()
          FROM Viagem v
          WHERE v.MotoristaId IS NOT NULL
            AND v.DataInicial >= @DataInicio
            AND v.DataInicial < DATEADD(DAY, 1, @DataFim)
          GROUP BY CAST(v.DataInicial AS DATE);

          COMMIT TRANSACTION;
          PRINT 'Estatísticas do mês ' + CAST(@Mes AS VARCHAR) + '/' + CAST(@Ano AS VARCHAR) + ' recalculadas com sucesso.';

      END TRY
      BEGIN CATCH
          ROLLBACK TRANSACTION;
          THROW;
      END CATCH
  END
  
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularTodasEstatisticasMotoristas]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularTodasEstatisticasMotoristas]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularTodasEstatisticasMotoristas
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AnoMes TABLE (Ano INT, Mes INT);

    -- Busca todos os anos/meses com viagens
    INSERT INTO @AnoMes (Ano, Mes)
    SELECT DISTINCT YEAR(DataInicial), MONTH(DataInicial)
    FROM Viagem
    WHERE DataInicial IS NOT NULL AND MotoristaId IS NOT NULL
    ORDER BY YEAR(DataInicial), MONTH(DataInicial);

    -- Adiciona meses de multas que não estão em viagens
    INSERT INTO @AnoMes (Ano, Mes)
    SELECT DISTINCT YEAR(Data), MONTH(Data)
    FROM Multa
    WHERE Data IS NOT NULL
      AND MotoristaId IS NOT NULL
      AND NOT EXISTS (
          SELECT 1 FROM @AnoMes am
          WHERE am.Ano = YEAR(Data) AND am.Mes = MONTH(Data)
      );

    -- Adiciona meses de abastecimentos que não estão nas anteriores
    INSERT INTO @AnoMes (Ano, Mes)
    SELECT DISTINCT YEAR(DataHora), MONTH(DataHora)
    FROM Abastecimento
    WHERE DataHora IS NOT NULL
      AND MotoristaId IS NOT NULL
      AND MotoristaId <> '00000000-0000-0000-0000-000000000000'
      AND NOT EXISTS (
          SELECT 1 FROM @AnoMes am
          WHERE am.Ano = YEAR(DataHora) AND am.Mes = MONTH(DataHora)
      );

    DECLARE @Ano INT, @Mes INT;
    DECLARE cur CURSOR FOR SELECT Ano, Mes FROM @AnoMes ORDER BY Ano, Mes;

    OPEN cur;
    FETCH NEXT FROM cur INTO @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        PRINT 'Processando ' + CAST(@Mes AS VARCHAR) + '/' + CAST(@Ano AS VARCHAR) + '...';
        EXEC sp_RecalcularEstatisticasMotoristas @Ano, @Mes;
        FETCH NEXT FROM cur INTO @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;

    PRINT 'Todas as estatísticas foram recalculadas!';
END
GO

--
-- Create or alter procedure [dbo].[sp_AtualizarEstatisticasMesAtual]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_AtualizarEstatisticasMesAtual]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_AtualizarEstatisticasMesAtual
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Ano INT = YEAR(GETDATE());
    DECLARE @Mes INT = MONTH(GETDATE());

    -- Recalcula mês atual
    EXEC sp_RecalcularEstatisticasMotoristas @Ano, @Mes;

    -- Recalcula também mês anterior
    IF @Mes = 1
    BEGIN
        SET @Ano = @Ano - 1;
        SET @Mes = 12;
    END
    ELSE
        SET @Mes = @Mes - 1;

    EXEC sp_RecalcularEstatisticasMotoristas @Ano, @Mes;

    PRINT 'Estatísticas do mês atual e anterior atualizadas!';
END
GO

--
-- Create or alter procedure [dbo].[sp_NormalizarViagens]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_NormalizarViagens]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_NormalizarViagens
    @DiasParaProcessar INT = 365,
    @ForcarReprocessamento BIT = 0
AS
BEGIN
    SET NOCOUNT ON
    
    DECLARE @KM_MAXIMO_VIAGEM INT = 2000
    DECLARE @TotalNormalizadas INT = 0
    DECLARE @DataLimite DATE = DATEADD(DAY, -@DiasParaProcessar, GETDATE())
    
    PRINT '  Normalizando viagens dos últimos ' + CAST(@DiasParaProcessar AS VARCHAR) + ' dias...'
    
    -- PASSO 1: Copiar datas válidas
    PRINT '  [PASSO 1] Copiando datas válidas...'
    
    UPDATE Viagem
    SET 
        DataInicialNormalizada = DataInicial,
        DataFinalNormalizada = DataFinal,
        HoraInicioNormalizada = HoraInicio,
        HoraFimNormalizada = HoraFim,
        FoiNormalizada = 0,
        TipoNormalizacao = NULL,
        DataNormalizacao = GETDATE()
    WHERE DataInicial IS NOT NULL
      AND DataInicial >= @DataLimite
      AND (@ForcarReprocessamento = 1 OR DataInicialNormalizada IS NULL)
    
    PRINT '           ' + CAST(@@ROWCOUNT AS VARCHAR) + ' datas copiadas'
    
    -- PASSO 2: Corrigir datas invertidas
    PRINT '  [PASSO 2] Corrigindo datas invertidas...'
    
    UPDATE Viagem
    SET 
        DataInicialNormalizada = DataFinalNormalizada,
        DataFinalNormalizada = DataInicialNormalizada,
        FoiNormalizada = 1,
        TipoNormalizacao = 'DATAS_INVERTIDAS'
    WHERE DataInicialNormalizada > DataFinalNormalizada
      AND DataFinalNormalizada IS NOT NULL
      AND DataInicial >= @DataLimite
    
    SET @TotalNormalizadas = @TotalNormalizadas + @@ROWCOUNT
    PRINT '           ' + CAST(@@ROWCOUNT AS VARCHAR) + ' datas invertidas corrigidas'
    
    -- PASSO 3: Copiar KM válidos
    PRINT '  [PASSO 3] Copiando KM válidos...'
    
    UPDATE Viagem
    SET 
        KmInicialNormalizado = KmInicial,
        KmFinalNormalizado = KmFinal,
        KmRodadoNormalizado = KmFinal - KmInicial
    WHERE KmInicial IS NOT NULL
      AND KmFinal IS NOT NULL
      AND KmFinal >= KmInicial
      AND (KmFinal - KmInicial) <= @KM_MAXIMO_VIAGEM
      AND DataInicial >= @DataLimite
    
    PRINT '           ' + CAST(@@ROWCOUNT AS VARCHAR) + ' KM válidos copiados'
    
    -- PASSO 4: Tratar KM outliers usando padrão do veículo
    PRINT '  [PASSO 4] Corrigindo KM outliers...'
    
    UPDATE v
    SET 
        KmFinalNormalizado = v.KmInicial + CAST(COALESCE(p.MedianaKm, p.AvgKmPorViagem, 50) AS INT),
        KmRodadoNormalizado = CAST(COALESCE(p.MedianaKm, p.AvgKmPorViagem, 50) AS INT),
        FoiNormalizada = 1,
        TipoNormalizacao = COALESCE(v.TipoNormalizacao + ',', '') + 'KM_OUTLIER'
    FROM Viagem v
    INNER JOIN VeiculoPadraoViagem p ON v.VeiculoId = p.VeiculoId
    WHERE v.KmInicial IS NOT NULL
      AND v.KmFinal IS NOT NULL
      AND (v.KmFinal - v.KmInicial) > @KM_MAXIMO_VIAGEM
      AND v.DataInicial >= @DataLimite
    
    SET @TotalNormalizadas = @TotalNormalizadas + @@ROWCOUNT
    PRINT '           ' + CAST(@@ROWCOUNT AS VARCHAR) + ' KM outliers corrigidos'
    
    -- PASSO 5: Anular KM outliers sem padrão
    UPDATE v
    SET 
        KmFinalNormalizado = NULL,
        KmRodadoNormalizado = NULL,
        FoiNormalizada = 1,
        TipoNormalizacao = COALESCE(v.TipoNormalizacao + ',', '') + 'KM_ANULADO'
    FROM Viagem v
    LEFT JOIN VeiculoPadraoViagem p ON v.VeiculoId = p.VeiculoId
    WHERE v.KmInicial IS NOT NULL
      AND v.KmFinal IS NOT NULL
      AND (v.KmFinal - v.KmInicial) > @KM_MAXIMO_VIAGEM
      AND p.VeiculoId IS NULL
      AND v.DataInicial >= @DataLimite
    
    SET @TotalNormalizadas = @TotalNormalizadas + @@ROWCOUNT
    
    -- PASSO 6: Calcular MinutosNormalizado
    PRINT '  [PASSO 6] Calculando minutos normalizados...'
    
    UPDATE Viagem
    SET MinutosNormalizado = dbo.fn_CalculaMinutosUteis(
        DataInicialNormalizada,
        DataFinalNormalizada,
        HoraInicioNormalizada,
        HoraFimNormalizada
    )
    WHERE DataInicialNormalizada IS NOT NULL
      AND HoraInicioNormalizada IS NOT NULL
      AND DataInicial >= @DataLimite
    
    PRINT '           ' + CAST(@@ROWCOUNT AS VARCHAR) + ' minutos calculados'
    
    -- PASSO 7: Limitar minutos excessivos
    UPDATE Viagem
    SET MinutosNormalizado = 13200,
        FoiNormalizada = 1,
        TipoNormalizacao = COALESCE(TipoNormalizacao + ',', '') + 'MINUTOS_LIMITADOS'
    WHERE MinutosNormalizado > 13200
      AND DataInicial >= @DataLimite
    
    SET @TotalNormalizadas = @TotalNormalizadas + @@ROWCOUNT
    
    PRINT ''
    PRINT '  ✓ Normalização concluída! Total corrigidas: ' + CAST(@TotalNormalizadas AS VARCHAR)
    
    RETURN @TotalNormalizadas
END
GO

--
-- Create or alter procedure [dbo].[sp_CalculaCustosViagem]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_CalculaCustosViagem]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_CalculaCustosViagem
    @ViagemId UNIQUEIDENTIFIER
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @VeiculoId UNIQUEIDENTIFIER
    DECLARE @MotoristaId UNIQUEIDENTIFIER
    DECLARE @DataInicial DATETIME
    DECLARE @KmRodado INT
    DECLARE @Minutos INT
    DECLARE @Status VARCHAR(50)

    -- Custos calculados
    DECLARE @CustoCombustivel FLOAT = 0
    DECLARE @CustoVeiculo FLOAT = 0
    DECLARE @CustoMotorista FLOAT = 0
    DECLARE @CustoLavador FLOAT = 0
    DECLARE @CustoOperador FLOAT = 0

    -- Variáveis auxiliares
    DECLARE @ConsumoVeiculo FLOAT
    DECLARE @ValorCombustivel FLOAT
    DECLARE @ValorUnitarioVeiculo FLOAT
    DECLARE @CustoMensalMotorista FLOAT
    DECLARE @CustoMensalLavador FLOAT
    DECLARE @CustoMensalOperador FLOAT
    DECLARE @MediaMensalViagens FLOAT
    DECLARE @ItemVeiculoId UNIQUEIDENTIFIER
    DECLARE @ContratoMotoristaId UNIQUEIDENTIFIER
    DECLARE @ContratoAtivo UNIQUEIDENTIFIER
    DECLARE @QuantidadeLavador INT
    DECLARE @QuantidadeOperador INT

    -- ========================================================================
    -- BUSCA DADOS USANDO CAMPOS NORMALIZADOS
    -- ========================================================================
    SELECT 
        @VeiculoId = VeiculoId,
        @MotoristaId = MotoristaId,
        @DataInicial = COALESCE(DataInicialNormalizada, DataInicial),
        @KmRodado = COALESCE(KmRodadoNormalizado, 
                             CASE WHEN KmFinal >= KmInicial THEN KmFinal - KmInicial ELSE 0 END),
        @Minutos = COALESCE(MinutosNormalizado, Minutos, 0),
        @Status = Status
    FROM Viagem
    WHERE ViagemId = @ViagemId

    -- Só processa viagens realizadas com veículo
    IF @VeiculoId IS NULL OR @Status <> 'Realizada'
        RETURN

    -- Garantir valores não negativos
    IF @KmRodado < 0 SET @KmRodado = 0
    IF @Minutos < 0 SET @Minutos = 0

    -- ========================================================================
    -- 1. CUSTO COMBUSTÍVEL
    -- ========================================================================
    IF @KmRodado > 0
    BEGIN
        SET @ConsumoVeiculo = dbo.fn_CalculaConsumoVeiculo(@VeiculoId)
        SET @ValorCombustivel = dbo.fn_GetValorCombustivelProximo(@VeiculoId, @DataInicial)

        IF @ConsumoVeiculo IS NOT NULL AND @ConsumoVeiculo > 0 AND @ValorCombustivel IS NOT NULL
            SET @CustoCombustivel = @KmRodado * (@ValorCombustivel / @ConsumoVeiculo)
    END

    -- ========================================================================
    -- 2. CUSTO VEÍCULO (Jornada 8h × 22 dias = 10.560 min/mês)
    -- ========================================================================
    IF @Minutos > 0
    BEGIN
        SELECT @ItemVeiculoId = ItemVeiculoId FROM Veiculo WHERE VeiculoId = @VeiculoId

        IF @ItemVeiculoId IS NOT NULL
        BEGIN
            SELECT @ValorUnitarioVeiculo = ValorUnitario
            FROM ItemVeiculoContrato
            WHERE ItemVeiculoId = @ItemVeiculoId

            IF @ValorUnitarioVeiculo IS NOT NULL AND @ValorUnitarioVeiculo > 0
                -- FÓRMULA: Jornada 8h × 22 dias = 10.560 minutos/mês
                SET @CustoVeiculo = @ValorUnitarioVeiculo * (CAST(@Minutos AS FLOAT) / 10560.0)
        END
    END

    -- ========================================================================
    -- 3. CUSTO MOTORISTA (Jornada 220h = 13.200 min/mês + TETO)
    -- ========================================================================
    IF @Minutos > 0 AND @MotoristaId IS NOT NULL
    BEGIN
        SELECT @ContratoMotoristaId = ContratoId
        FROM Motorista
        WHERE MotoristaId = @MotoristaId

        IF @ContratoMotoristaId IS NOT NULL
        BEGIN
            -- Busca repactuação mais recente
            SELECT TOP 1 @CustoMensalMotorista = RT.ValorMotorista
            FROM RepactuacaoTerceirizacao RT
            INNER JOIN RepactuacaoContrato RC ON RT.RepactuacaoContratoId = RC.RepactuacaoContratoId
            WHERE RC.ContratoId = @ContratoMotoristaId
              AND RT.DataRepactuacao <= @DataInicial
            ORDER BY RT.DataRepactuacao DESC

            -- Fallback: se não tiver repactuação, usa Contrato
            IF @CustoMensalMotorista IS NULL
            BEGIN
                SELECT @CustoMensalMotorista = CustoMensalMotorista
                FROM Contrato
                WHERE ContratoId = @ContratoMotoristaId AND Status = 1
            END

            IF @CustoMensalMotorista IS NOT NULL AND @CustoMensalMotorista > 0
            BEGIN
                SET @CustoMotorista = @CustoMensalMotorista * (CAST(@Minutos AS FLOAT) / 13200.0)
                
                -- TETO: máximo = salário mensal
                IF @CustoMotorista > @CustoMensalMotorista
                    SET @CustoMotorista = @CustoMensalMotorista
            END
        END
    END

    -- ========================================================================
    -- 4. CUSTO LAVADOR (rateado por média de viagens/mês)
    -- ========================================================================
    IF @DataInicial IS NOT NULL
    BEGIN
        SELECT TOP 1 @ContratoAtivo = ContratoId
        FROM Contrato
        WHERE ContratoLavadores = 1 AND Status = 1
        ORDER BY DataInicio DESC

        IF @ContratoAtivo IS NOT NULL
        BEGIN
            SELECT TOP 1 
                @CustoMensalLavador = RT.ValorLavador,
                @QuantidadeLavador = RT.QtdLavadores
            FROM RepactuacaoTerceirizacao RT
            INNER JOIN RepactuacaoContrato RC ON RT.RepactuacaoContratoId = RC.RepactuacaoContratoId
            WHERE RC.ContratoId = @ContratoAtivo
              AND RT.DataRepactuacao <= @DataInicial
            ORDER BY RT.DataRepactuacao DESC

            IF @CustoMensalLavador IS NULL
            BEGIN
                SELECT @CustoMensalLavador = CustoMensalLavador,
                       @QuantidadeLavador = ISNULL(QuantidadeLavador, 1)
                FROM Contrato
                WHERE ContratoId = @ContratoAtivo
            END

            IF @CustoMensalLavador IS NOT NULL AND @CustoMensalLavador > 0
            BEGIN
                SET @MediaMensalViagens = dbo.fn_CalculaMediaMensalViagens(@DataInicial)
                IF @MediaMensalViagens > 0
                    SET @CustoLavador = (@CustoMensalLavador * ISNULL(@QuantidadeLavador, 1)) / @MediaMensalViagens
            END
        END
    END

    -- ========================================================================
    -- 5. CUSTO OPERADOR (rateado por média de viagens/mês)
    -- ========================================================================
    IF @DataInicial IS NOT NULL
    BEGIN
        SELECT TOP 1 @ContratoAtivo = ContratoId
        FROM Contrato
        WHERE ContratoOperadores = 1 AND Status = 1
        ORDER BY DataInicio DESC

        IF @ContratoAtivo IS NOT NULL
        BEGIN
            SELECT TOP 1 
                @CustoMensalOperador = RT.ValorOperador,
                @QuantidadeOperador = RT.QtdOperadores
            FROM RepactuacaoTerceirizacao RT
            INNER JOIN RepactuacaoContrato RC ON RT.RepactuacaoContratoId = RC.RepactuacaoContratoId
            WHERE RC.ContratoId = @ContratoAtivo
              AND RT.DataRepactuacao <= @DataInicial
            ORDER BY RT.DataRepactuacao DESC

            IF @CustoMensalOperador IS NULL
            BEGIN
                SELECT @CustoMensalOperador = CustoMensalOperador,
                       @QuantidadeOperador = ISNULL(QuantidadeOperador, 1)
                FROM Contrato
                WHERE ContratoId = @ContratoAtivo
            END

            IF @CustoMensalOperador IS NOT NULL AND @CustoMensalOperador > 0
            BEGIN
                IF @MediaMensalViagens IS NULL OR @MediaMensalViagens = 0
                    SET @MediaMensalViagens = dbo.fn_CalculaMediaMensalViagens(@DataInicial)
                
                IF @MediaMensalViagens > 0
                    SET @CustoOperador = (@CustoMensalOperador * ISNULL(@QuantidadeOperador, 1)) / @MediaMensalViagens
            END
        END
    END

    -- ========================================================================
    -- ATUALIZA VIAGEM
    -- ========================================================================
    UPDATE Viagem
    SET CustoCombustivel = ROUND(@CustoCombustivel, 2),
        CustoVeiculo = ROUND(@CustoVeiculo, 2),
        CustoMotorista = ROUND(@CustoMotorista, 2),
        CustoLavador = ROUND(@CustoLavador, 2),
        CustoOperador = ROUND(@CustoOperador, 2)
    WHERE ViagemId = @ViagemId
END
GO

--
-- Create or alter trigger [tr_Viagem_CalculaCustos] on table [dbo].[Viagem]
--
GO
PRINT (N'Create or alter trigger [tr_Viagem_CalculaCustos] on table [dbo].[Viagem]')
GO
CREATE OR ALTER TRIGGER dbo.tr_Viagem_CalculaCustos 
ON dbo.Viagem 
AFTER INSERT, UPDATE 
AS 
BEGIN 
    SET NOCOUNT ON
    
    -- ═══════════════════════════════════════════════════════════════════════
    -- PROTEÇÃO ANTI-RECURSÃO via CONTEXT_INFO
    -- ═══════════════════════════════════════════════════════════════════════
    IF CONTEXT_INFO() = 0x1
        RETURN
    
    SET CONTEXT_INFO 0x1
    
    BEGIN TRY
        DECLARE @ViagemId UNIQUEIDENTIFIER 
        
        DECLARE viagem_cursor CURSOR LOCAL FAST_FORWARD FOR 
            SELECT i.ViagemId 
            FROM inserted i 
            LEFT JOIN deleted d ON i.ViagemId = d.ViagemId 
            WHERE d.ViagemId IS NULL  -- INSERT
               -- Campos originais
               OR ISNULL(i.VeiculoId, NEWID()) <> ISNULL(d.VeiculoId, NEWID()) 
               OR ISNULL(i.MotoristaId, NEWID()) <> ISNULL(d.MotoristaId, NEWID()) 
               OR ISNULL(i.DataInicial, '1900-01-01') <> ISNULL(d.DataInicial, '1900-01-01') 
               OR ISNULL(i.DataFinal, '1900-01-01') <> ISNULL(d.DataFinal, '1900-01-01')
               OR ISNULL(i.KmInicial, -1) <> ISNULL(d.KmInicial, -1) 
               OR ISNULL(i.KmFinal, -1) <> ISNULL(d.KmFinal, -1) 
               OR ISNULL(i.Status, '') <> ISNULL(d.Status, '') 
               -- Campos normalizados
               OR ISNULL(i.DataInicialNormalizada, '1900-01-01') <> ISNULL(d.DataInicialNormalizada, '1900-01-01')
               OR ISNULL(i.DataFinalNormalizada, '1900-01-01') <> ISNULL(d.DataFinalNormalizada, '1900-01-01')
               OR ISNULL(i.HoraInicioNormalizada, '00:00:00') <> ISNULL(d.HoraInicioNormalizada, '00:00:00')
               OR ISNULL(i.HoraFimNormalizada, '00:00:00') <> ISNULL(d.HoraFimNormalizada, '00:00:00')
               OR ISNULL(i.MinutosNormalizado, -1) <> ISNULL(d.MinutosNormalizado, -1)
               OR ISNULL(i.KmInicialNormalizado, -1) <> ISNULL(d.KmInicialNormalizado, -1)
               OR ISNULL(i.KmFinalNormalizado, -1) <> ISNULL(d.KmFinalNormalizado, -1)
               OR ISNULL(i.KmRodadoNormalizado, -1) <> ISNULL(d.KmRodadoNormalizado, -1)
        
        OPEN viagem_cursor 
        FETCH NEXT FROM viagem_cursor INTO @ViagemId 
        
        WHILE @@FETCH_STATUS = 0 
        BEGIN 
            EXEC dbo.sp_CalculaCustosViagem @ViagemId 
            FETCH NEXT FROM viagem_cursor INTO @ViagemId 
        END 
        
        CLOSE viagem_cursor 
        DEALLOCATE viagem_cursor 
    END TRY
    BEGIN CATCH
        IF CURSOR_STATUS('local', 'viagem_cursor') >= 0
        BEGIN
            CLOSE viagem_cursor
            DEALLOCATE viagem_cursor
        END
    END CATCH
    
    SET CONTEXT_INFO 0x0
END
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularCustosTodasViagens]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularCustosTodasViagens]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularCustosTodasViagens
    @DataInicio DATE = NULL,
    @DataFim DATE = NULL
AS
BEGIN
    SET NOCOUNT ON
    
    -- Se não informou datas, pega TODA a base
    IF @DataInicio IS NULL
        SELECT @DataInicio = MIN(CAST(DataInicial AS DATE)) FROM Viagem WHERE Status = 'Realizada'
    
    IF @DataFim IS NULL
        SET @DataFim = CAST(GETDATE() AS DATE)
    
    DECLARE @ViagemId UNIQUEIDENTIFIER
    DECLARE @Total INT = 0
    DECLARE @Processadas INT = 0
    DECLARE @Inicio DATETIME = GETDATE()
    
    SELECT @Total = COUNT(*)
    FROM Viagem
    WHERE CAST(DataInicial AS DATE) >= @DataInicio
      AND CAST(DataInicial AS DATE) <= @DataFim
      AND Status = 'Realizada'
    
    PRINT '  Recalculando custos de ' + CAST(@Total AS VARCHAR) + ' viagens...'
    PRINT '  Período: ' + CONVERT(VARCHAR, @DataInicio, 103) + ' a ' + CONVERT(VARCHAR, @DataFim, 103)
    
    -- Desabilita o trigger via CONTEXT_INFO
    SET CONTEXT_INFO 0x1
    
    DECLARE viagem_cursor CURSOR LOCAL FAST_FORWARD FOR
        SELECT ViagemId
        FROM Viagem
        WHERE CAST(DataInicial AS DATE) >= @DataInicio
          AND CAST(DataInicial AS DATE) <= @DataFim
          AND Status = 'Realizada'
    
    OPEN viagem_cursor
    FETCH NEXT FROM viagem_cursor INTO @ViagemId
    
    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC dbo.sp_CalculaCustosViagem @ViagemId
        SET @Processadas = @Processadas + 1
        
        IF @Processadas % 500 = 0
            PRINT '    Processadas ' + CAST(@Processadas AS VARCHAR) + ' de ' + CAST(@Total AS VARCHAR)
        
        FETCH NEXT FROM viagem_cursor INTO @ViagemId
    END
    
    CLOSE viagem_cursor
    DEALLOCATE viagem_cursor
    
    SET CONTEXT_INFO 0x0
    
    DECLARE @Duracao INT = DATEDIFF(SECOND, @Inicio, GETDATE())
    PRINT '  ✓ Concluído! ' + CAST(@Processadas AS VARCHAR) + ' viagens em ' + CAST(@Duracao AS VARCHAR) + 's'
END
GO

--
-- Create or alter procedure [dbo].[sp_AtualizarPadroesVeiculos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_AtualizarPadroesVeiculos]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_AtualizarPadroesVeiculos
AS
BEGIN
    SET NOCOUNT ON
    
    DECLARE @KM_MAXIMO_VIAGEM INT = 2000
    DECLARE @VeiculosProcessados INT
    
    PRINT '  Calculando padrões estatísticos por veículo...'
    
    -- Limpar tabela
    DELETE FROM VeiculoPadraoViagem
    
    -- PASSO 1: Calcular agregações básicas
    ;WITH AgregacoesVeiculo AS (
        SELECT 
            VeiculoId,
            AVG(CAST(COALESCE(MinutosNormalizado, Minutos) AS DECIMAL(18,2))) AS AvgDuracaoMinutos,
            AVG(CAST(COALESCE(KmRodadoNormalizado, KmFinal - KmInicial) AS DECIMAL(18,2))) AS AvgKmPorViagem,
            CASE 
                WHEN COUNT(DISTINCT CAST(COALESCE(DataInicialNormalizada, DataInicial) AS DATE)) > 0 
                THEN SUM(CAST(COALESCE(KmRodadoNormalizado, KmFinal - KmInicial) AS DECIMAL(18,2))) / 
                     COUNT(DISTINCT CAST(COALESCE(DataInicialNormalizada, DataInicial) AS DATE))
                ELSE NULL 
            END AS AvgKmPorDia,
            ISNULL(STDEV(CAST(COALESCE(KmRodadoNormalizado, KmFinal - KmInicial) AS DECIMAL(18,2))), 0) AS StdDevKm,
            COUNT(*) AS TotalViagens,
            CASE 
                WHEN AVG(CAST(COALESCE(MinutosNormalizado, Minutos) AS FLOAT)) < 120 THEN 'DIARIO'
                WHEN AVG(CAST(COALESCE(MinutosNormalizado, Minutos) AS FLOAT)) > 480 THEN 'LONGA_DURACAO'
                ELSE 'MISTO'
            END AS TipoUsoCalculado
        FROM Viagem
        WHERE Status = 'Realizada'
          AND VeiculoId IS NOT NULL
          AND COALESCE(KmRodadoNormalizado, KmFinal - KmInicial) BETWEEN 1 AND @KM_MAXIMO_VIAGEM
        GROUP BY VeiculoId
        HAVING COUNT(*) >= 5
    ),
    -- PASSO 2: Calcular percentis
    PercentisPorVeiculo AS (
        SELECT DISTINCT
            VeiculoId,
            PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY COALESCE(KmRodadoNormalizado, KmFinal - KmInicial)) 
                OVER (PARTITION BY VeiculoId) AS MedianaKm,
            PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY COALESCE(KmRodadoNormalizado, KmFinal - KmInicial)) 
                OVER (PARTITION BY VeiculoId) AS Q1,
            PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY COALESCE(KmRodadoNormalizado, KmFinal - KmInicial)) 
                OVER (PARTITION BY VeiculoId) AS Q3
        FROM Viagem
        WHERE Status = 'Realizada'
          AND VeiculoId IS NOT NULL
          AND COALESCE(KmRodadoNormalizado, KmFinal - KmInicial) BETWEEN 1 AND @KM_MAXIMO_VIAGEM
    )
    -- PASSO 3: Inserir dados combinados
    INSERT INTO VeiculoPadraoViagem (
        VeiculoId, 
        AvgDuracaoMinutos, 
        AvgKmPorViagem, 
        AvgKmPorDia,
        MaxKmNormalPorViagem,
        MedianaKm,
        Q1Km,
        Q3Km,
        IQRKm,
        LimiteInferiorKm,
        LimiteSuperiorKm,
        TotalViagensAnalisadas,
        TipoUso,
        DataAtualizacao
    )
    SELECT 
        A.VeiculoId,
        A.AvgDuracaoMinutos,
        A.AvgKmPorViagem,
        A.AvgKmPorDia,
        -- Max normal = média + 2 desvios padrão (mínimo 500km)
        CASE 
            WHEN A.AvgKmPorViagem + 2 * A.StdDevKm > 500
            THEN A.AvgKmPorViagem + 2 * A.StdDevKm
            ELSE 500
        END AS MaxKmNormal,
        P.MedianaKm,
        P.Q1,
        P.Q3,
        P.Q3 - P.Q1 AS IQR,
        P.Q1 - 1.5 * (P.Q3 - P.Q1) AS LimiteInferior,
        P.Q3 + 1.5 * (P.Q3 - P.Q1) AS LimiteSuperior,
        A.TotalViagens,
        A.TipoUsoCalculado,
        GETDATE()
    FROM AgregacoesVeiculo A
    INNER JOIN PercentisPorVeiculo P ON A.VeiculoId = P.VeiculoId
    
    SELECT @VeiculosProcessados = @@ROWCOUNT
    
    PRINT '  ✓ Padrões calculados para ' + CAST(@VeiculosProcessados AS VARCHAR) + ' veículos'
    
    RETURN @VeiculosProcessados
END
GO

--
-- Create or alter procedure [dbo].[sp_AtualizarEstatisticasViagem]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_AtualizarEstatisticasViagem]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_AtualizarEstatisticasViagem
    @DataParam DATE
AS
BEGIN
    SET NOCOUNT ON
    
    DECLARE @DataRef DATE = CAST(@DataParam AS DATE)
    DECLARE @EstatisticaId INT
    
    -- ========================================================================
    -- CALCULAR ESTATÍSTICAS GERAIS
    -- ========================================================================
    
    DECLARE @TotalViagens INT = 0
    DECLARE @ViagensFinalizadas INT = 0
    DECLARE @ViagensEmAndamento INT = 0
    DECLARE @ViagensAgendadas INT = 0
    DECLARE @ViagensCanceladas INT = 0
    
    SELECT 
        @TotalViagens = ISNULL(COUNT(*), 0),
        @ViagensFinalizadas = ISNULL(SUM(CASE WHEN Status = 'Realizada' THEN 1 ELSE 0 END), 0),
        @ViagensEmAndamento = ISNULL(SUM(CASE WHEN Status = 'Aberta' THEN 1 ELSE 0 END), 0),
        @ViagensAgendadas = ISNULL(SUM(CASE WHEN Status = 'Agendada' THEN 1 ELSE 0 END), 0),
        @ViagensCanceladas = ISNULL(SUM(CASE WHEN Status = 'Cancelada' THEN 1 ELSE 0 END), 0)
    FROM Viagem
    WHERE CAST(DataInicial AS DATE) = @DataRef
    
    -- ========================================================================
    -- CALCULAR CUSTOS (apenas viagens Realizadas)
    -- IMPORTANTE: Soma TODOS os custos por viagem (Combustível + Motorista + Lavador)
    -- ========================================================================
    
    DECLARE @CustoTotal DECIMAL(18,2) = 0
    DECLARE @CustoVeiculo DECIMAL(18,2) = 0
    DECLARE @CustoMotorista DECIMAL(18,2) = 0
    DECLARE @CustoOperador DECIMAL(18,2) = 0
    DECLARE @CustoLavador DECIMAL(18,2) = 0
    DECLARE @CustoCombustivel DECIMAL(18,2) = 0
    
    SELECT 
        @CustoCombustivel = ISNULL(SUM(ISNULL(CustoCombustivel, 0)), 0),
        @CustoVeiculo = ISNULL(SUM(ISNULL(CustoVeiculo, 0)), 0),
        @CustoMotorista = ISNULL(SUM(ISNULL(CustoMotorista, 0)), 0),
        @CustoOperador = ISNULL(SUM(ISNULL(CustoOperador, 0)), 0),
        @CustoLavador = ISNULL(SUM(ISNULL(CustoLavador, 0)), 0)
    FROM Viagem
    WHERE CAST(DataInicial AS DATE) = @DataRef
      AND Status = 'Realizada'
    
    -- Custo total = soma de todos os custos
    SET @CustoTotal = @CustoCombustivel + @CustoVeiculo + @CustoMotorista + @CustoOperador + @CustoLavador
    
    -- ========================================================================
    -- CALCULAR QUILOMETRAGEM (com filtro de outliers: 1 a 2000 km)
    -- ========================================================================
    
    DECLARE @KmTotal INT = 0
    DECLARE @KmMedio DECIMAL(18,2) = 0
    DECLARE @MinutosTotal INT = 0
    DECLARE @MinutosMedio INT = 0
    DECLARE @QuilometragemTotal DECIMAL(18,2) = 0
    DECLARE @QuilometragemMedia DECIMAL(18,2) = 0
    
    SELECT 
        @KmTotal = ISNULL(SUM(ISNULL(KmRodado, 0)), 0),
        @KmMedio = ISNULL(AVG(CAST(ISNULL(KmRodado, 0) AS DECIMAL(18,2))), 0),
        @MinutosTotal = ISNULL(SUM(ISNULL(Minutos, 0)), 0),
        @MinutosMedio = ISNULL(AVG(ISNULL(Minutos, 0)), 0)
    FROM Viagem
    WHERE CAST(DataInicial AS DATE) = @DataRef
      AND Status = 'Realizada'
      AND KmRodado IS NOT NULL
      AND KmRodado BETWEEN 1 AND 2000  -- Filtro de outliers
    
    SET @QuilometragemTotal = CAST(@KmTotal AS DECIMAL(18,2))
    SET @QuilometragemMedia = @KmMedio
    
    -- ========================================================================
    -- CALCULAR JSONs AGREGADOS
    -- ========================================================================
    
    -- JSON: Viagens por Status
    DECLARE @ViagensPorStatusJson NVARCHAR(MAX)
    SELECT @ViagensPorStatusJson = (
        SELECT 
            Status AS status,
            COUNT(*) AS total
        FROM Viagem
        WHERE CAST(DataInicial AS DATE) = @DataRef
        GROUP BY Status
        FOR JSON PATH
    )
    
    -- JSON: Viagens por Motorista
    DECLARE @ViagensPorMotoristaJson NVARCHAR(MAX)
    SELECT @ViagensPorMotoristaJson = (
        SELECT 
            m.Nome AS motorista,
            COUNT(*) AS totalViagens
        FROM Viagem v
        INNER JOIN Motorista m ON v.MotoristaId = m.MotoristaId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
        GROUP BY m.Nome
        FOR JSON PATH
    )
    
    -- JSON: Viagens por Veículo
    DECLARE @ViagensPorVeiculoJson NVARCHAR(MAX)
    SELECT @ViagensPorVeiculoJson = (
        SELECT 
            ve.Placa AS veiculo,
            COUNT(*) AS totalViagens
        FROM Viagem v
        INNER JOIN Veiculo ve ON v.VeiculoId = ve.VeiculoId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
        GROUP BY ve.Placa
        FOR JSON PATH
    )
    
    -- JSON: Viagens por Finalidade
    DECLARE @ViagensPorFinalidadeJson NVARCHAR(MAX)
    SELECT @ViagensPorFinalidadeJson = (
        SELECT 
            v.Finalidade AS finalidade,
            COUNT(*) AS totalViagens
        FROM Viagem v
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
          AND v.Finalidade IS NOT NULL
        GROUP BY v.Finalidade
        FOR JSON PATH
    )
    
    -- JSON: Viagens por Setor
    DECLARE @ViagensPorSetorJson NVARCHAR(MAX)
    SELECT @ViagensPorSetorJson = (
        SELECT 
            s.Nome AS setor,
            COUNT(*) AS totalViagens
        FROM Viagem v
        INNER JOIN SetorSolicitante s ON v.SetorSolicitanteId = s.SetorSolicitanteId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
        GROUP BY s.Nome
        FOR JSON PATH
    )
    
    -- JSON: Viagens por Requisitante (CORRIGIDO - estava faltando!)
    DECLARE @ViagensPorRequisitanteJson NVARCHAR(MAX)
    SELECT @ViagensPorRequisitanteJson = (
        SELECT 
            r.Nome AS requisitante,
            COUNT(*) AS totalViagens
        FROM Viagem v
        INNER JOIN Requisitante r ON v.RequisitanteId = r.RequisitanteId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
        GROUP BY r.Nome
        FOR JSON PATH
    )
    
    -- JSON: Custos por Motorista (apenas CustoMotorista)
    DECLARE @CustosPorMotoristaJson NVARCHAR(MAX)
    SELECT @CustosPorMotoristaJson = (
        SELECT 
            m.Nome AS motorista,
            SUM(ISNULL(v.CustoMotorista, 0)) AS custoTotal
        FROM Viagem v
        INNER JOIN Motorista m ON v.MotoristaId = m.MotoristaId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
          AND v.Status = 'Realizada'
        GROUP BY m.Nome
        FOR JSON PATH
    )
    
    -- JSON: Custos por Veículo (apenas CustoVeiculo - partilha do aluguel)
    DECLARE @CustosPorVeiculoJson NVARCHAR(MAX)
    SELECT @CustosPorVeiculoJson = (
        SELECT 
            ve.Placa AS veiculo,
            SUM(ISNULL(v.CustoVeiculo, 0)) AS custoTotal
        FROM Viagem v
        INNER JOIN Veiculo ve ON v.VeiculoId = ve.VeiculoId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
          AND v.Status = 'Realizada'
        GROUP BY ve.Placa
        FOR JSON PATH
    )
    
    -- JSON: KM por Veículo (com filtro de outliers)
    DECLARE @KmPorVeiculoJson NVARCHAR(MAX)
    SELECT @KmPorVeiculoJson = (
        SELECT 
            ve.Placa AS veiculo,
            SUM(ISNULL(v.KmRodado, 0)) AS kmTotal
        FROM Viagem v
        INNER JOIN Veiculo ve ON v.VeiculoId = ve.VeiculoId
        WHERE CAST(v.DataInicial AS DATE) = @DataRef
          AND v.KmRodado IS NOT NULL
          AND v.KmRodado BETWEEN 1 AND 2000  -- Filtro de outliers
        GROUP BY ve.Placa
        FOR JSON PATH
    )
    
    -- JSON: Custos por Tipo (encapsulado para evitar erro FOR JSON com UNION)
    DECLARE @CustosPorTipoJson NVARCHAR(MAX)
    SELECT @CustosPorTipoJson = (
        SELECT tipo, custo
        FROM (
            SELECT 'Combustível' AS tipo, SUM(ISNULL(CustoCombustivel, 0)) AS custo
            FROM Viagem WHERE CAST(DataInicial AS DATE) = @DataRef AND Status = 'Realizada'
            UNION ALL
            SELECT 'Veículo' AS tipo, SUM(ISNULL(CustoVeiculo, 0)) AS custo
            FROM Viagem WHERE CAST(DataInicial AS DATE) = @DataRef AND Status = 'Realizada'
            UNION ALL
            SELECT 'Motorista' AS tipo, SUM(ISNULL(CustoMotorista, 0)) AS custo
            FROM Viagem WHERE CAST(DataInicial AS DATE) = @DataRef AND Status = 'Realizada'
            UNION ALL
            SELECT 'Operador' AS tipo, SUM(ISNULL(CustoOperador, 0)) AS custo
            FROM Viagem WHERE CAST(DataInicial AS DATE) = @DataRef AND Status = 'Realizada'
            UNION ALL
            SELECT 'Lavador' AS tipo, SUM(ISNULL(CustoLavador, 0)) AS custo
            FROM Viagem WHERE CAST(DataInicial AS DATE) = @DataRef AND Status = 'Realizada'
        ) AS CustosPorTipo
        FOR JSON PATH
    )
    
    -- ========================================================================
    -- INSERIR OU ATUALIZAR
    -- ========================================================================
    
    SELECT @EstatisticaId = Id
    FROM ViagemEstatistica
    WHERE CAST(DataReferencia AS DATE) = @DataRef
    
    IF @EstatisticaId IS NOT NULL
    BEGIN
        UPDATE ViagemEstatistica
        SET 
            TotalViagens = @TotalViagens,
            ViagensFinalizadas = @ViagensFinalizadas,
            ViagensEmAndamento = @ViagensEmAndamento,
            ViagensAgendadas = @ViagensAgendadas,
            ViagensCanceladas = @ViagensCanceladas,
            
            CustoTotal = @CustoTotal,
            CustoMedioPorViagem = CASE WHEN @ViagensFinalizadas > 0 THEN @CustoTotal / @ViagensFinalizadas ELSE 0 END,
            CustoVeiculo = @CustoVeiculo,
            CustoMotorista = @CustoMotorista,
            CustoOperador = @CustoOperador,
            CustoLavador = @CustoLavador,
            CustoCombustivel = @CustoCombustivel,
            
            QuilometragemTotal = @QuilometragemTotal,
            QuilometragemMedia = @QuilometragemMedia,
            KmTotal = @KmTotal,
            KmMedio = @KmMedio,
            MinutosTotal = @MinutosTotal,
            MinutosMedio = @MinutosMedio,
            
            ViagensPorStatusJson = @ViagensPorStatusJson,
            ViagensPorMotoristaJson = @ViagensPorMotoristaJson,
            ViagensPorVeiculoJson = @ViagensPorVeiculoJson,
            ViagensPorFinalidadeJson = @ViagensPorFinalidadeJson,
            ViagensPorRequisitanteJson = @ViagensPorRequisitanteJson,
            ViagensPorSetorJson = @ViagensPorSetorJson,
            CustosPorMotoristaJson = @CustosPorMotoristaJson,
            CustosPorVeiculoJson = @CustosPorVeiculoJson,
            KmPorVeiculoJson = @KmPorVeiculoJson,
            CustosPorTipoJson = @CustosPorTipoJson,
            
            DataAtualizacao = GETDATE()
        WHERE Id = @EstatisticaId
    END
    ELSE
    BEGIN
        INSERT INTO ViagemEstatistica (
            DataReferencia,
            TotalViagens, ViagensFinalizadas, ViagensEmAndamento, ViagensAgendadas, ViagensCanceladas,
            CustoTotal, CustoMedioPorViagem, CustoVeiculo, CustoMotorista, CustoOperador, CustoLavador, CustoCombustivel,
            QuilometragemTotal, QuilometragemMedia, KmTotal, KmMedio, MinutosTotal, MinutosMedio,
            ViagensPorStatusJson, ViagensPorMotoristaJson, ViagensPorVeiculoJson, ViagensPorFinalidadeJson,
            ViagensPorRequisitanteJson, ViagensPorSetorJson,
            CustosPorMotoristaJson, CustosPorVeiculoJson, KmPorVeiculoJson, CustosPorTipoJson,
            DataCriacao
        )
        VALUES (
            @DataRef,
            @TotalViagens, @ViagensFinalizadas, @ViagensEmAndamento, @ViagensAgendadas, @ViagensCanceladas,
            @CustoTotal, CASE WHEN @ViagensFinalizadas > 0 THEN @CustoTotal / @ViagensFinalizadas ELSE 0 END,
            @CustoVeiculo, @CustoMotorista, @CustoOperador, @CustoLavador, @CustoCombustivel,
            @QuilometragemTotal, @QuilometragemMedia, @KmTotal, @KmMedio, @MinutosTotal, @MinutosMedio,
            @ViagensPorStatusJson, @ViagensPorMotoristaJson, @ViagensPorVeiculoJson, @ViagensPorFinalidadeJson,
            @ViagensPorRequisitanteJson, @ViagensPorSetorJson,
            @CustosPorMotoristaJson, @CustosPorVeiculoJson, @KmPorVeiculoJson, @CustosPorTipoJson,
            GETDATE()
        )
    END
END
GO

--
-- Create or alter procedure [dbo].[sp_AtualizarTodasEstatisticasViagem]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_AtualizarTodasEstatisticasViagem]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_AtualizarTodasEstatisticasViagem
AS
BEGIN
    SET NOCOUNT ON
    
    IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ViagemEstatistica')
    BEGIN
        PRINT 'Tabela ViagemEstatistica nao existe - ignorando'
        RETURN
    END
    
    DECLARE @DataAtual DATE
    DECLARE @DataMin DATE
    DECLARE @DataMax DATE
    DECLARE @Hoje DATE = CAST(GETDATE() AS DATE)
    DECLARE @Total INT = 0
    
    SELECT @DataMin = MIN(CAST(DataInicial AS DATE)), @DataMax = MAX(CAST(DataInicial AS DATE))
    FROM Viagem
    WHERE DataInicial IS NOT NULL AND Status = 'Realizada'
    
    -- Limitar até a data atual (não calcular para datas futuras)
    IF @DataMax > @Hoje
        SET @DataMax = @Hoje
    
    SET @DataAtual = @DataMin
    
    PRINT 'Atualizando estatisticas de ' + CONVERT(VARCHAR, @DataMin, 103) + ' a ' + CONVERT(VARCHAR, @DataMax, 103) + '...'
    
    WHILE @DataAtual <= @DataMax
    BEGIN
        EXEC sp_AtualizarEstatisticasViagem @DataAtual
        SET @DataAtual = DATEADD(DAY, 1, @DataAtual)
        SET @Total = @Total + 1
        
        IF @Total % 100 = 0
            PRINT '  Processados ' + CAST(@Total AS VARCHAR) + ' dias...'
    END
    
    PRINT 'Total: ' + CAST(@Total AS VARCHAR) + ' dias processados com sucesso!'
    
    RETURN @Total
END
GO

--
-- Create or alter procedure [dbo].[sp_JobAtualizacaoViagens]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_JobAtualizacaoViagens]')
GO
-- ============================================================================
-- CRIAR sp_JobAtualizacaoViagens
-- ============================================================================

CREATE OR ALTER PROCEDURE dbo.sp_JobAtualizacaoViagens
AS
BEGIN
    SET NOCOUNT ON
    
    DECLARE @Inicio DATETIME = GETDATE()
    DECLARE @InicioEtapa DATETIME
    DECLARE @DataInicio DATE
    DECLARE @DataFim DATE = CAST(GETDATE() AS DATE)
    DECLARE @DiasTotal INT
    
    -- Pega a data do primeiro registro até hoje
    SELECT @DataInicio = MIN(CAST(DataInicial AS DATE)) FROM Viagem WHERE Status = 'Realizada'
    SET @DiasTotal = DATEDIFF(DAY, @DataInicio, @DataFim) + 1
    
    PRINT '========================================================================'
    PRINT '         JOB DE ATUALIZACAO DE VIAGENS - FROTIX'
    PRINT '========================================================================'
    PRINT 'Inicio: ' + CONVERT(VARCHAR, @Inicio, 120)
    PRINT 'Periodo: ' + CONVERT(VARCHAR, @DataInicio, 103) + ' a ' + CONVERT(VARCHAR, @DataFim, 103)
    PRINT 'Total de dias: ' + CAST(@DiasTotal AS VARCHAR)
    PRINT ''
    
    BEGIN TRY
        -- ETAPA 1: NORMALIZAR ABASTECIMENTOS
        SET @InicioEtapa = GETDATE()
        PRINT '[ETAPA 1/6] NORMALIZAR ABASTECIMENTOS'
        EXEC dbo.sp_NormalizarAbastecimentos
        PRINT '  Tempo: ' + CAST(DATEDIFF(SECOND, @InicioEtapa, GETDATE()) AS VARCHAR) + 's'
        PRINT ''
        
        -- ETAPA 2: CALCULAR CONSUMO DOS VEICULOS
        SET @InicioEtapa = GETDATE()
        PRINT '[ETAPA 2/6] CALCULAR CONSUMO DOS VEICULOS'
        EXEC dbo.sp_CalcularConsumoVeiculos
        PRINT '  Tempo: ' + CAST(DATEDIFF(SECOND, @InicioEtapa, GETDATE()) AS VARCHAR) + 's'
        PRINT ''
        
        -- ETAPA 3: ATUALIZAR PADROES ESTATISTICOS DOS VEICULOS
        SET @InicioEtapa = GETDATE()
        PRINT '[ETAPA 3/6] ATUALIZAR PADROES ESTATISTICOS DOS VEICULOS'
        EXEC dbo.sp_AtualizarPadroesVeiculos
        PRINT '  Tempo: ' + CAST(DATEDIFF(SECOND, @InicioEtapa, GETDATE()) AS VARCHAR) + 's'
        PRINT ''
        
        -- ETAPA 4: NORMALIZAR VIAGENS (KM, MINUTOS, DATAS) - TODA A BASE
        SET @InicioEtapa = GETDATE()
        PRINT '[ETAPA 4/6] NORMALIZAR VIAGENS (KM, MINUTOS, DATAS)'
        EXEC dbo.sp_NormalizarViagens @DiasParaProcessar = @DiasTotal, @ForcarReprocessamento = 1
        PRINT '  Tempo: ' + CAST(DATEDIFF(SECOND, @InicioEtapa, GETDATE()) AS VARCHAR) + 's'
        PRINT ''
        
        -- ETAPA 5: RECALCULAR CUSTOS DAS VIAGENS - TODA A BASE
        SET @InicioEtapa = GETDATE()
        PRINT '[ETAPA 5/6] RECALCULAR CUSTOS DAS VIAGENS'
        EXEC dbo.sp_RecalcularCustosTodasViagens @DataInicio = @DataInicio, @DataFim = @DataFim
        PRINT '  Tempo: ' + CAST(DATEDIFF(SECOND, @InicioEtapa, GETDATE()) AS VARCHAR) + 's'
        PRINT ''
        
        -- ETAPA 6: ATUALIZAR ESTATISTICAS (ViagemEstatistica)
        SET @InicioEtapa = GETDATE()
        PRINT '[ETAPA 6/6] ATUALIZAR ESTATISTICAS'
        EXEC dbo.sp_AtualizarTodasEstatisticasViagem
        PRINT '  Tempo: ' + CAST(DATEDIFF(SECOND, @InicioEtapa, GETDATE()) AS VARCHAR) + 's'
        PRINT ''
        
        -- RESUMO FINAL
        DECLARE @DuracaoTotal INT = DATEDIFF(SECOND, @Inicio, GETDATE())
        
        PRINT '========================================================================'
        PRINT '                    JOB CONCLUIDO COM SUCESSO!'
        PRINT '========================================================================'
        PRINT 'Tempo total: ' + CAST(@DuracaoTotal AS VARCHAR) + ' segundos'
        PRINT 'Termino: ' + CONVERT(VARCHAR, GETDATE(), 120)
        
    END TRY
    BEGIN CATCH
        DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE()
        DECLARE @ErrorSeverity INT = ERROR_SEVERITY()
        DECLARE @ErrorState INT = ERROR_STATE()
        
        PRINT ''
        PRINT '========================================================================'
        PRINT '                           ERRO NO JOB!'
        PRINT '========================================================================'
        PRINT 'Erro: ' + @ErrorMessage
        PRINT 'Linha: ' + CAST(ERROR_LINE() AS VARCHAR)
        
        RAISERROR(@ErrorMessage, @ErrorSeverity, @ErrorState)
    END CATCH
END
GO

--
-- Create or alter view [dbo].[vw_RankingMotoristasPorPeriodo]
--
GO
PRINT (N'Create or alter view [dbo].[vw_RankingMotoristasPorPeriodo]')
GO

CREATE OR ALTER VIEW dbo.vw_RankingMotoristasPorPeriodo
AS
WITH ViagensPorMotorista AS (
    SELECT
        YEAR(v.DataInicial) AS Ano,
        MONTH(v.DataInicial) AS Mes,
        v.MotoristaId,
        m.Nome AS NomeMotorista,
        COUNT(*) AS TotalViagens,
        SUM(
            CASE
                WHEN v.KmInicial IS NOT NULL
                     AND v.KmFinal IS NOT NULL
                     AND v.KmFinal >= v.KmInicial
                     AND (v.KmFinal - v.KmInicial) <= 2000
                THEN v.KmFinal - v.KmInicial
                ELSE 0
            END
        ) AS KmTotal
    FROM Viagem v
    INNER JOIN Motorista m ON v.MotoristaId = m.MotoristaId
    WHERE v.MotoristaId IS NOT NULL
      AND v.DataInicial IS NOT NULL
    GROUP BY YEAR(v.DataInicial), MONTH(v.DataInicial), v.MotoristaId, m.Nome
)
SELECT
    Ano,
    Mes,
    MotoristaId,
    NomeMotorista,
    TotalViagens,
    KmTotal,
    ROW_NUMBER() OVER (PARTITION BY Ano, Mes ORDER BY TotalViagens DESC, KmTotal DESC) AS PosicaoViagens,
    ROW_NUMBER() OVER (PARTITION BY Ano, Mes ORDER BY KmTotal DESC, TotalViagens DESC) AS PosicaoKm
FROM ViagensPorMotorista;
GO

--
-- Create or alter view [dbo].[ViewViagensAgendaTodosMeses]
--
GO
PRINT (N'Create or alter view [dbo].[ViewViagensAgendaTodosMeses]')
GO
CREATE OR ALTER VIEW dbo.ViewViagensAgendaTodosMeses 
AS SELECT
  Viagem.DataInicial
 ,Viagem.HoraInicio
 ,Viagem.MotoristaId
 ,Viagem.VeiculoId
 ,Viagem.Descricao
 ,Viagem.Status
 ,Viagem.ViagemId
 ,Viagem.Finalidade
 ,Viagem.StatusAgendamento
 ,Viagem.NomeEvento
FROM dbo.Viagem
GO

--
-- Create or alter view [dbo].[ViewViagensAgenda]
--
GO
PRINT (N'Create or alter view [dbo].[ViewViagensAgenda]')
GO
CREATE OR ALTER VIEW dbo.ViewViagensAgenda 
WITH SCHEMABINDING
AS -- ================================================================
-- VIEW: ViewViagensAgenda
-- Descrição: View para alimentar o calendário FullCalendar
-- Atualizado: Cores correspondentes aos Modais do sistema
-- ================================================================

SELECT
    -- ============================================================
    -- IDENTIFICADORES
    -- ============================================================
    v.ViagemId,
    v.MotoristaId,
    v.VeiculoId,
    v.EventoId,

    -- ============================================================
    -- DATAS E HORÁRIOS
    -- ============================================================
    v.DataInicial,
    v.HoraInicio,
    v.DataFinal,
    v.HoraFim,

    -- Campo Start para FullCalendar (DATETIME combinando data + hora)
    CONVERT(
        DATETIME,
        CONVERT(VARCHAR(10), v.DataInicial, 120) + ' ' + CONVERT(VARCHAR(8), v.HoraInicio, 108),
        120
    ) AS [Start],

    -- Campo End para FullCalendar
    v.HoraFim AS [End],

    -- ============================================================
    -- STATUS E FLAGS
    -- ============================================================
    v.Status,
    v.StatusAgendamento,
    v.FoiAgendamento,
    v.Finalidade,

    -- ============================================================
    -- INFORMAÇÕES DO EVENTO
    -- ============================================================
    v.NomeEvento,
    e.Nome AS NomeEventoFull,

    -- ============================================================
    -- INFORMAÇÕES DE MOTORISTA E VEÍCULO
    -- ============================================================
    m.Nome AS NomeMotorista,
    vec.Placa,

    -- ============================================================
    -- TÍTULO DO EVENTO NA AGENDA
    -- ============================================================
    Titulo = CASE
        WHEN v.Finalidade = 'Evento' AND e.Nome IS NOT NULL 
            THEN 'Evento: ' + e.Nome
        ELSE v.Finalidade
    END,

    -- ============================================================
    -- COR DO EVENTO - Correspondente aos Headers dos Modais
    -- ============================================================
    -- Prioridade: 1. Evento, 2. Cancelada, 3. Realizada, 4. Agendada, 5. Aberta
    CorEvento = CASE
        -- EVENTO (Finalidade = 'Evento') - Marrom #4C2B08
        WHEN v.Finalidade = 'Evento' 
            THEN '#4C2B08'
        
        -- CANCELADA - Vinho #722F37
        WHEN v.Status = 'Cancelada' 
            THEN '#722F37'
        
        -- REALIZADA - Azul Petróleo #154c62
        WHEN v.Status = 'Realizada' 
            THEN '#154c62'
        
        -- AGENDADA (Status = 'Agendada' OU Status = 'Aberta' com StatusAgendamento = 1) - Laranja #D55102
        WHEN v.Status = 'Agendada' 
            THEN '#D55102'
        WHEN v.Status = 'Aberta' AND ISNULL(CAST(v.StatusAgendamento AS INT), 0) = 1 
            THEN '#D55102'
        
        -- ABERTA (viagem já transformada) - Verde Militar #3d5c3d
        WHEN v.Status = 'Aberta' AND ISNULL(CAST(v.StatusAgendamento AS INT), 0) = 0 
            THEN '#3d5c3d'
        
        -- DEFAULT - Cinza
        ELSE '#6c757d'
    END,

    -- ============================================================
    -- COR DO TEXTO - Branco para todas (fundos escuros)
    -- ============================================================
    CorTexto = '#FFFFFF',

    -- ============================================================
    -- DESCRIÇÃO GENÉRICA (sem HTML)
    -- ============================================================
    DescricaoMontada = 
        ISNULL(m.Nome, '(Motorista Não Informado)')
        + ' - (' + ISNULL(vec.Placa, 'Sem Veículo') + ')'
        + CASE
            WHEN v.DescricaoSemFormato IS NOT NULL
            THEN ' - ' + 
                REPLACE(
                    REPLACE(
                        REPLACE(
                            CAST(v.DescricaoSemFormato AS VARCHAR(MAX)), 
                            CHAR(13), ''
                        ), 
                        CHAR(10), ' '
                    ), 
                    CHAR(9), ' '
                )
            ELSE ''
        END,

    -- ============================================================
    -- DESCRIÇÃO ESPECIAL PARA EVENTOS
    -- ============================================================
    DescricaoEvento = CASE
        -- Evento Cancelado
        WHEN v.Finalidade = 'Evento' AND e.Nome IS NOT NULL AND v.Status = 'Cancelada'
            THEN 'Evento CANCELADO: ' + e.Nome + ' / '
                + ISNULL(m.Nome, '(Motorista Não Identificado)')
                + ' - (' + ISNULL(vec.Placa, 'Sem Veículo') + ')'
                + CASE 
                    WHEN v.DescricaoSemFormato IS NOT NULL
                    THEN ' - ' + 
                        REPLACE(
                            REPLACE(
                                REPLACE(
                                    CAST(v.DescricaoSemFormato AS VARCHAR(MAX)), 
                                    CHAR(13), ''
                                ), 
                                CHAR(10), ' '
                            ), 
                            CHAR(9), ' '
                        )
                    ELSE '' 
                END

        -- Evento Normal
        WHEN v.Finalidade = 'Evento' AND e.Nome IS NOT NULL
            THEN 'Evento: ' + e.Nome + ' / '
                + ISNULL(m.Nome, '(Motorista Não Identificado)')
                + ' - (' + ISNULL(vec.Placa, 'Sem Veículo') + ')'
                + CASE 
                    WHEN v.DescricaoSemFormato IS NOT NULL
                    THEN ' - ' + 
                        REPLACE(
                            REPLACE(
                                REPLACE(
                                    CAST(v.DescricaoSemFormato AS VARCHAR(MAX)), 
                                    CHAR(13), ''
                                ), 
                                CHAR(10), ' '
                            ), 
                            CHAR(9), ' '
                        )
                    ELSE '' 
                END

        ELSE NULL
    END,

    -- ============================================================
    -- DESCRIÇÕES ORIGINAIS
    -- ============================================================
    v.DescricaoSemFormato,
    v.Descricao

-- ============================================================
-- JOINS
-- ============================================================
FROM dbo.Viagem v

LEFT JOIN dbo.Motorista m
    ON m.MotoristaId = v.MotoristaId

LEFT JOIN dbo.Veiculo vec
    ON vec.VeiculoId = v.VeiculoId

LEFT JOIN dbo.Evento e
    ON e.EventoId = v.EventoId;
GO

--
-- Create or alter view [dbo].[ViewViagens_Sergio]
--
GO
PRINT (N'Create or alter view [dbo].[ViewViagens_Sergio]')
GO
CREATE OR ALTER VIEW dbo.ViewViagens_Sergio 
AS SELECT
  Viagem.ViagemId
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS DataInicial
 ,FORMAT(Viagem.HoraInicio, 'HH:mm') AS HoraInicio
 ,Viagem.Descricao
 ,Viagem.KmInicial
 ,Viagem.KmFinal
 ,Viagem.CombustivelInicial
 ,Viagem.CombustivelFinal
 ,Viagem.NoFichaVistoria
 ,Viagem.Finalidade
,CASE
    WHEN Requisitante.Ramal IS NULL THEN Requisitante.Nome
    ELSE Requisitante.Nome + ' - (' + CONVERT(VARCHAR, Requisitante.Ramal) + ')'
  END AS NomeRequisitante
 ,CASE
    WHEN SetorSolicitante.Sigla IS NULL THEN SetorSolicitante.Nome
    ELSE SetorSolicitante.Nome + ' - (' + SetorSolicitante.Sigla + ')'
  END AS NomeSetor
 ,Motorista.Nome AS NomeMotorista
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,Veiculo.CombustivelId
 ,Viagem.FichaVistoria
 ,Viagem.Origem
 ,Viagem.Destino
 ,Viagem.Minutos
 ,Viagem.NomeEvento
FROM dbo.SetorSolicitante
RIGHT OUTER JOIN dbo.Viagem
  ON SetorSolicitante.SetorSolicitanteId = Viagem.SetorSolicitanteId
LEFT OUTER JOIN dbo.Requisitante
  ON Requisitante.RequisitanteId = Viagem.RequisitanteId
LEFT OUTER JOIN dbo.Motorista
  ON Motorista.MotoristaId = Viagem.MotoristaId
LEFT OUTER JOIN dbo.Veiculo
  ON Veiculo.VeiculoId = Viagem.VeiculoId
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
GO

--
-- Create or alter view [dbo].[ViewViagens]
--
GO
PRINT (N'Create or alter view [dbo].[ViewViagens]')
GO
CREATE OR ALTER VIEW dbo.ViewViagens 
AS SELECT
    Viagem.ViagemId,
    Viagem.DataInicial,
    Viagem.DataFinal,
    Viagem.HoraInicio,
    Viagem.HoraFim,
    Viagem.Descricao,
    Viagem.Status,
    Viagem.KmInicial,
    Viagem.KmFinal,
    Viagem.CombustivelInicial,
    Viagem.CombustivelFinal,
    Viagem.MotoristaId,
    Viagem.VeiculoId,
    Viagem.ResumoOcorrencia,
    Viagem.DescricaoOcorrencia,
    Viagem.StatusOcorrencia,
    Viagem.StatusDocumento,
    Viagem.StatusCartaoAbastecimento,
    Viagem.StatusAgendamento,
    Viagem.NoFichaVistoria,
    Viagem.Finalidade,
    Veiculo.Placa,
    Motorista.CNH,
    Motorista.Foto,
    Motorista.Ponto,
    convert(nvarchar(36), Viagem.ViagemId) AS ViagemIDStr,
    CASE
        WHEN Requisitante.Ramal IS NULL THEN Requisitante.Nome
        ELSE Requisitante.Nome + ' - (' + CONVERT(VARCHAR, Requisitante.Ramal) + ')'
    END AS NomeRequisitante,
    CASE
        WHEN SetorSolicitante.Sigla IS NULL THEN SetorSolicitante.Nome
        ELSE SetorSolicitante.Nome + ' - (' + SetorSolicitante.Sigla + ')'
    END AS NomeSetor,
    Requisitante.RequisitanteId,
    SetorSolicitante.SetorSolicitanteId,
    Motorista.Nome AS NomeMotorista,
    '(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo,
    Veiculo.UnidadeId,
    ROW_NUMBER() OVER (ORDER BY Viagem.DataInicial, Viagem.HoraInicio) AS RowNum,
    Veiculo.CombustivelId,
    Viagem.DescricaoSolucaoOcorrencia,
    Viagem.FichaVistoria,
    Viagem.Origem,
    Viagem.Destino,
    Viagem.Minutos,
    Viagem.NomeEvento,
    Viagem.RamalRequisitante,
    Viagem.ImagemOcorrencia,
    Viagem.ItemManutencaoId,
    ROUND((Viagem.CustoCombustivel + Viagem.CustoMotorista + Viagem.CustoVeiculo + Viagem.CustoOperador + Viagem.CustoLavador), 2) AS CustoViagem,
    Viagem.EventoId,

    -- NOVAS COLUNAS: Lógica de cor do evento
    CorEvento = CASE
        WHEN Viagem.StatusAgendamento = 1 AND Viagem.Status <> 'Cancelada' AND Viagem.Finalidade = 'Evento' THEN '#E99B63'
        WHEN Viagem.StatusAgendamento = 1 AND Viagem.Status <> 'Cancelada' THEN '#29B3FF'
        WHEN Viagem.Status = 'Cancelada' THEN '#E34234'
        WHEN Viagem.Status = 'Aberta' AND ISNULL(Viagem.StatusAgendamento, 0) = 0 THEN '#FFD774'
        WHEN Viagem.Status = 'Realizada' AND ISNULL(Viagem.FoiAgendamento, 0) = 1 THEN '#52688F'
        WHEN Viagem.Status = 'Realizada' THEN '#75B390'
        WHEN Viagem.Finalidade = 'Evento' THEN '#E99B63'
        ELSE '#29B3FF'
    END,

    CorTexto = CASE
        WHEN (Viagem.StatusAgendamento = 1 AND Viagem.Status <> 'Cancelada')
          OR (Viagem.Status = 'Realizada')
          OR (Viagem.Finalidade = 'Evento')
          OR (Viagem.Status = 'Cancelada')
          THEN 'white'
        WHEN (Viagem.Status = 'Aberta' AND ISNULL(Viagem.StatusAgendamento, 0) = 0)
          THEN '#2B6670'
        ELSE 'white'
    END,

    -- Descrição Montada
    DescricaoMontada = 
        (
            ISNULL(Motorista.Nome, '(Motorista Não Identificado)')
            + ' - (' + ISNULL(Veiculo.Placa, 'Sem Veículo') + ')'
            + CASE 
                WHEN Viagem.Descricao IS NOT NULL AND LEN(LTRIM(RTRIM(Viagem.Descricao))) > 0
                THEN ' - ' + Viagem.Descricao
                ELSE ''
              END
        ),

    -- Descrição especial para eventos (seguindo a mesma lógica do C#)
    DescricaoEvento =
        CASE
            WHEN Viagem.Finalidade = 'Evento' AND Viagem.NomeEvento IS NOT NULL AND Viagem.Status = 'Cancelada'
                THEN 'Evento CANCELADO: ' + Viagem.NomeEvento + ' / '
                    + ISNULL(Motorista.Nome, '(Motorista Não Identificado)')
                    + ' - (' + ISNULL(Veiculo.Placa, 'Sem Veículo') + ')'
                    + CASE WHEN Viagem.Descricao IS NOT NULL AND LEN(LTRIM(RTRIM(Viagem.Descricao))) > 0
                        THEN ' - ' + Viagem.Descricao
                        ELSE '' END
            WHEN Viagem.Finalidade = 'Evento' AND Viagem.NomeEvento IS NOT NULL
                THEN 'Evento: ' + Viagem.NomeEvento + ' / '
                    + ISNULL(Motorista.Nome, '(Motorista Não Identificado)')
                    + ' - (' + ISNULL(Veiculo.Placa, 'Sem Veículo') + ')'
                    + CASE WHEN Viagem.Descricao IS NOT NULL AND LEN(LTRIM(RTRIM(Viagem.Descricao))) > 0
                        THEN ' - ' + Viagem.Descricao
                        ELSE '' END
            ELSE NULL
        END,

    -- Título do Evento
    Titulo = 
        CASE
            WHEN Viagem.Finalidade = 'Evento' AND Viagem.NomeEvento IS NOT NULL THEN 'Evento : ' + Viagem.NomeEvento
            ELSE Viagem.Finalidade
        END

FROM dbo.SetorSolicitante
RIGHT OUTER JOIN dbo.Viagem
    ON SetorSolicitante.SetorSolicitanteId = Viagem.SetorSolicitanteId
LEFT OUTER JOIN dbo.Requisitante
    ON Requisitante.RequisitanteId = Viagem.RequisitanteId
LEFT OUTER JOIN dbo.Motorista
    ON Motorista.MotoristaId = Viagem.MotoristaId
LEFT OUTER JOIN dbo.Veiculo
    ON Veiculo.VeiculoId = Viagem.VeiculoId
INNER JOIN dbo.ModeloVeiculo
    ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
    ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
GO

--
-- Create or alter view [dbo].[ViewProcuraFicha]
--
GO
PRINT (N'Create or alter view [dbo].[ViewProcuraFicha]')
GO
CREATE OR ALTER VIEW dbo.ViewProcuraFicha 
AS SELECT 
MotoristaId, 
VeiculoId, 
DataInicial, 
DataFinal, 
(FORMAT(DATEPART(hour, HoraInicio), '00') + ':' + FORMAT(DATEPART(minute, HoraInicio), '00')) AS HoraInicio,
(FORMAT(DATEPART(hour, HoraFim), '00') + ':' + FORMAT(DATEPART(minute, HoraFim), '00')) AS HoraFim,
NoFichaVistoria
FROM
Viagem
WHERE Status NOT LIKE 'Cancelada' AND StatusAgendamento = 0
GO

--
-- Create or alter view [dbo].[ViewPendenciasManutencao]
--
GO
PRINT (N'Create or alter view [dbo].[ViewPendenciasManutencao]')
GO
CREATE OR ALTER VIEW dbo.ViewPendenciasManutencao 
AS SELECT
  ItensManutencao.ItemManutencaoId
 ,ItensManutencao.ManutencaoId
 ,ItensManutencao.TipoItem
 ,ItensManutencao.NumFicha
 ,CONVERT(VARCHAR, ItensManutencao.DataItem, 103) AS DataItem
 ,ItensManutencao.Resumo
 ,ItensManutencao.Descricao
 ,ItensManutencao.Status
 ,ItensManutencao.MotoristaId
 ,ItensManutencao.ViagemId
 ,ItensManutencao.ImagemOcorrencia
 ,Motorista.Nome
 ,Manutencao.VeiculoId
FROM dbo.ItensManutencao
LEFT OUTER JOIN dbo.Motorista
  ON ItensManutencao.MotoristaId = Motorista.MotoristaId
LEFT OUTER JOIN dbo.Viagem
  ON ItensManutencao.ViagemId = Viagem.ViagemId
INNER JOIN dbo.Manutencao
  ON ItensManutencao.ManutencaoId = Manutencao.ManutencaoId
GO

--
-- Create or alter view [dbo].[ViewOcorrencia]
--
GO
PRINT (N'Create or alter view [dbo].[ViewOcorrencia]')
GO
CREATE OR ALTER VIEW dbo.ViewOcorrencia 
WITH SCHEMABINDING
AS SELECT
  Viagem.VeiculoId
 ,Viagem.ViagemId
 ,Viagem.NoFichaVistoria
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS DataInicial
 ,Motorista.Nome AS NomeMotorista
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,Viagem.ResumoOcorrencia
 ,Viagem.StatusOcorrencia
 ,Viagem.MotoristaId
 ,Viagem.ImagemOcorrencia
 ,Viagem.ItemManutencaoId
 ,Viagem.DescricaoOcorrencia
 ,Viagem.DescricaoSolucaoOcorrencia
FROM dbo.Viagem
INNER JOIN dbo.Motorista
  ON Motorista.MotoristaId = Viagem.MotoristaId
INNER JOIN dbo.Veiculo
  ON Veiculo.VeiculoId = Viagem.VeiculoId
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
GO

--
-- Create index [UK_ViewOcorrencia_ViagemId] on view [dbo].[ViewOcorrencia]
--
PRINT (N'Create index [UK_ViewOcorrencia_ViagemId] on view [dbo].[ViewOcorrencia]')
GO
CREATE UNIQUE CLUSTERED INDEX UK_ViewOcorrencia_ViagemId
  ON dbo.ViewOcorrencia (ViagemId)
  ON [PRIMARY]
GO

--
-- Create or alter view [dbo].[ViewNoFichaVistoria]
--
GO
PRINT (N'Create or alter view [dbo].[ViewNoFichaVistoria]')
GO
CREATE OR ALTER VIEW dbo.ViewNoFichaVistoria 
AS SELECT NoFichaVistoria FROM Viagem
GO

--
-- Create or alter view [dbo].[ViewFichaViagem]
--
GO
PRINT (N'Create or alter view [dbo].[ViewFichaViagem]')
GO
CREATE OR ALTER VIEW dbo.ViewFichaViagem 
AS SELECT
  CONVERT(NVARCHAR(100), Viagem.ViagemId) AS ViagemId
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS DataInicial
 ,CONVERT(VARCHAR, Viagem.DataFinal, 103) AS DataFinal
 ,FORMAT(Viagem.HoraInicio, 'HH:mm') AS HoraInicio
 ,FORMAT(Viagem.HoraFim, 'HH:mm') AS HoraFim
 ,Viagem.DescricaoSemFormato
 ,Viagem.KmInicial
 ,Viagem.KmFinal
 ,Viagem.ResumoOcorrencia
 ,Viagem.DescricaoOcorrencia
 ,Viagem.StatusOcorrencia
 ,Viagem.NoFichaVistoria
 ,Viagem.Finalidade
 ,Viagem.Origem
 ,Viagem.Destino
 ,Viagem.Status
 ,Viagem.EventoId
 ,Viagem.StatusAgendamento
 ,CASE
    WHEN Requisitante.Ramal IS NULL THEN Requisitante.Nome
    ELSE Requisitante.Nome + ' - (' + CONVERT(VARCHAR, Requisitante.Ramal) + ')'
  END AS NomeRequisitante
 ,CASE
    WHEN SetorSolicitante.Sigla IS NULL THEN SetorSolicitante.Nome
    ELSE SetorSolicitante.Nome + ' - (' + SetorSolicitante.Sigla + ')'
  END AS NomeSetor
 ,Motorista.Nome AS NomeMotorista
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,Veiculo.UnidadeId
 ,Evento.Nome AS NomeEvento
 ,Viagem.FichaVistoria
 ,Viagem.Minutos
 ,Viagem.Descricao
 ,Viagem.CombustivelInicial
 ,Viagem.CombustivelFinal
 ,Viagem.RamalRequisitante
FROM dbo.SetorSolicitante
LEFT OUTER JOIN dbo.Viagem
  ON SetorSolicitante.SetorSolicitanteId = Viagem.SetorSolicitanteId
LEFT OUTER JOIN dbo.Requisitante
  ON Requisitante.RequisitanteId = Viagem.RequisitanteId
LEFT OUTER JOIN dbo.Motorista
  ON Motorista.MotoristaId = Viagem.MotoristaId
LEFT OUTER JOIN dbo.Veiculo
  ON Veiculo.VeiculoId = Viagem.VeiculoId
LEFT OUTER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
LEFT OUTER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
LEFT OUTER JOIN dbo.Evento
  ON Viagem.EventoId = Evento.EventoId
GO

--
-- Create or alter view [dbo].[ViewEventos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewEventos]')
GO

CREATE OR ALTER VIEW dbo.ViewEventos
AS
SELECT 
    e.EventoId,
    e.Nome,
    e.Descricao,
    e.QtdParticipantes,
    e.DataInicial,
    e.DataFinal,
    r.Nome AS NomeRequisitante,
    s.Nome AS NomeSetor,
    s.Sigla AS SiglaSetor,
    ISNULL(cv.CustoViagem, 0) AS CustoViagem,
    e.Status
FROM dbo.Evento e
LEFT JOIN dbo.Requisitante r 
    ON e.RequisitanteId = r.RequisitanteId
LEFT JOIN dbo.SetorSolicitante s 
    ON e.SetorSolicitanteId = s.SetorSolicitanteId
-- ✅ SUBQUERY AGREGADA: Executa 1x para TODOS os eventos
LEFT JOIN (
    SELECT 
        EventoId,
        ROUND(
            SUM(
                ISNULL(CustoCombustivel, 0) + 
                ISNULL(CustoMotorista, 0) + 
                ISNULL(CustoVeiculo, 0) + 
                ISNULL(CustoOperador, 0) + 
                ISNULL(CustoLavador, 0)
            ), 2
        ) AS CustoViagem
    FROM dbo.Viagem
    WHERE EventoId IS NOT NULL
    GROUP BY EventoId
) cv ON e.EventoId = cv.EventoId;
GO

--
-- Create or alter view [dbo].[ViewCustosViagem]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustosViagem]')
GO
CREATE OR ALTER VIEW dbo.ViewCustosViagem 
AS SELECT
  Viagem.NoFichaVistoria
 ,Viagem.ViagemId
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS DataInicial
 ,CONVERT(VARCHAR, Viagem.DataFinal, 103) AS DataFinal
 ,FORMAT(Viagem.HoraInicio, 'HH:mm') AS HoraInicio
 ,FORMAT(Viagem.HoraFim, 'HH:mm') AS HoraFim
 ,Viagem.Finalidade
 ,Viagem.Status
 ,Viagem.KmInicial
 ,Viagem.KmFinal
 ,Viagem.KmFinal - Viagem.KmInicial AS Quilometragem
 ,FORMAT(Viagem.CustoMotorista, 'N2', 'pt-BR') AS CustoMotorista
 ,FORMAT(Viagem.CustoCombustivel, 'N2', 'pt-BR') AS CustoCombustivel
 ,FORMAT(Viagem.CustoVeiculo, 'N2', 'pt-BR') AS CustoVeiculo
 ,CONVERT(varchar, CAST(Viagem.CustoMotorista AS money), 1) AS CustoMotoristaFormatado
 ,Motorista.Nome AS NomeMotorista
 ,Motorista.MotoristaId
 ,Viagem.VeiculoId
 ,Viagem.StatusAgendamento
 ,Viagem.SetorSolicitanteId 
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,ROW_NUMBER() OVER (ORDER BY Viagem.DataInicial, Viagem.HoraInicio) AS RowNum
FROM dbo.Viagem
LEFT OUTER JOIN dbo.Motorista
  ON Motorista.MotoristaId = Viagem.MotoristaId
LEFT OUTER JOIN dbo.Veiculo
  ON Veiculo.VeiculoId = Viagem.VeiculoId
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
WHERE Viagem.Status = 'Realizada'
AND Viagem.Finalidade NOT LIKE 'Manutenção'
AND Viagem.Finalidade NOT LIKE 'Devolução à Locadora'
GO

--
-- Create or alter view [dbo].[ViewCustosVeiculos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustosVeiculos]')
GO
CREATE OR ALTER VIEW dbo.ViewCustosVeiculos 
AS SELECT
  ItemVeiculoContrato.Descricao
 ,FORMAT(SUM(Viagem.CustoCombustivel), 'N2', 'pt-BR') AS Combustivel
 ,FORMAT(SUM(Viagem.CustoMotorista), 'N2', 'pt-BR') AS Motorista
 ,FORMAT(SUM(Viagem.CustoVeiculo), 'N2', 'pt-BR') AS Veiculo
 ,FORMAT(SUM(Viagem.KmFinal - Viagem.KmInicial), 'N2', 'pt-BR') AS Quilometragem
FROM dbo.Viagem
LEFT OUTER JOIN dbo.Veiculo
  ON Viagem.VeiculoId = Veiculo.VeiculoId
LEFT OUTER JOIN dbo.ItemVeiculoContrato
  ON Veiculo.ItemVeiculoId = ItemVeiculoContrato.ItemVeiculoId
WHERE Viagem.Status = 'Realizada'
AND Viagem.Finalidade NOT LIKE 'Manutenção'
AND Viagem.Finalidade NOT LIKE 'Devolução à Locadora'
AND MONTH(Viagem.DataInicial) = 12
GROUP BY ItemVeiculoContrato.Descricao
GO

--
-- Create or alter view [dbo].[ViewCustosTemporaria]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustosTemporaria]')
GO
CREATE OR ALTER VIEW dbo.ViewCustosTemporaria 
AS SELECT
 Viagem.NoFichaVistoria
 ,SetorSolicitante.Sigla
 ,SetorSolicitante.Nome
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS 'Data Inicial'
 ,CONVERT(VARCHAR, Viagem.DataFinal, 103) AS 'Data Final'
 ,FORMAT((Viagem.HoraFim - Viagem.HoraInicio), 'HH:mm') AS Duração
 ,(Viagem.KmFinal - Viagem.KmInicial) AS Quilometragem
 ,CONVERT(DECIMAL(10,2),Viagem.CustoCombustivel) AS Combustivel
 ,CONVERT(DECIMAL(10,2),Viagem.CustoMotorista) AS Motorista
 ,Viagem.Finalidade 
FROM dbo.Viagem
INNER JOIN dbo.SetorSolicitante
  ON Viagem.SetorSolicitanteId = SetorSolicitante.SetorSolicitanteId
WHERE SetorSolicitante.Sigla = 'CTRAN' AND Viagem.Finalidade NOT LIKE 'Manutenção' AND Viagem.Finalidade NOT LIKE 'Devolução à Locadora'
GO

--
-- Create or alter view [dbo].[ViewCustosMotoristas_Individual]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustosMotoristas_Individual]')
GO
CREATE OR ALTER VIEW dbo.ViewCustosMotoristas_Individual 
AS SELECT
  Viagem.NoFichaVistoria
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS DataInicial
 ,CONVERT(VARCHAR, Viagem.DataFinal, 103) AS DataFinal
 ,FORMAT(Viagem.KmFinal - Viagem.KmInicial, 'N2', 'pt-BR') AS Quilometragem
FROM dbo.Viagem
INNER JOIN dbo.Motorista
  ON Viagem.MotoristaId = Motorista.MotoristaId
WHERE Viagem.Status = 'Realizada'
AND Viagem.Finalidade NOT LIKE 'Manutenção'
AND Viagem.Finalidade NOT LIKE 'Devolução à Locadora'
AND Motorista.TipoCondutor = 'Terceirizado'
AND Motorista.MotoristaId = '00a5ece9-1735-47c0-5eb5-08d97c53518f'
AND MONTH(Viagem.DataInicial) = 06
GO

--
-- Create or alter view [dbo].[ViewCustosMotoristas]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustosMotoristas]')
GO
CREATE OR ALTER VIEW dbo.ViewCustosMotoristas 
AS SELECT
  Motorista.Nome
 ,FORMAT(SUM(Viagem.CustoCombustivel), 'N2', 'pt-BR') AS Combustivel
 ,FORMAT(SUM(Viagem.CustoMotorista), 'N2', 'pt-BR') AS Motorista
 ,FORMAT(SUM(Viagem.CustoVeiculo), 'N2', 'pt-BR') AS Veiculo
 ,FORMAT(SUM(Viagem.KmFinal - Viagem.KmInicial), 'N2', 'pt-BR') AS Quilometragem
FROM dbo.Viagem
INNER JOIN dbo.Motorista
  ON Viagem.MotoristaId = Motorista.MotoristaId
WHERE Viagem.Status = 'Realizada'
AND Viagem.Finalidade NOT LIKE 'Manutenção'
AND Viagem.Finalidade NOT LIKE 'Devolução à Locadora'
AND Motorista.TipoCondutor = 'Terceirizado'
AND MONTH(Viagem.DataInicial) = 05
GROUP BY Motorista.Nome
GO

--
-- Create or alter view [dbo].[ViewCustosFinalidade]
--
GO
PRINT (N'Create or alter view [dbo].[ViewCustosFinalidade]')
GO
CREATE OR ALTER VIEW dbo.ViewCustosFinalidade 
AS SELECT
  Viagem.Finalidade
 ,FORMAT(SUM(Viagem.CustoCombustivel), 'N2', 'pt-BR') AS Combustivel
 ,FORMAT(SUM(Viagem.CustoMotorista), 'N2', 'pt-BR') AS Motorista
 ,FORMAT(SUM(Viagem.CustoVeiculo), 'N2', 'pt-BR') AS Veiculo
 ,FORMAT(SUM(Viagem.KmFinal - Viagem.KmInicial), 'N2', 'pt-BR') AS Quilometragem
FROM dbo.Viagem
WHERE Viagem.Status = 'Realizada'
AND Viagem.Finalidade NOT LIKE 'Manutenção'
AND Viagem.Finalidade NOT LIKE 'Devolução à Locadora'
AND MONTH(Viagem.DataInicial) = 12
GROUP BY Viagem.Finalidade
GO

--
-- Create table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create table [dbo].[OcorrenciaViagem]')
GO
CREATE TABLE dbo.OcorrenciaViagem (
  OcorrenciaViagemId uniqueidentifier NOT NULL DEFAULT (newid()),
  ViagemId uniqueidentifier NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  MotoristaId uniqueidentifier NULL,
  Resumo nvarchar(200) NOT NULL DEFAULT (''),
  Descricao nvarchar(max) NOT NULL DEFAULT (''),
  ImagemOcorrencia nvarchar(max) NOT NULL DEFAULT (''),
  Status nvarchar(20) NOT NULL DEFAULT ('Aberta'),
  DataCriacao datetime NOT NULL DEFAULT (getdate()),
  DataBaixa datetime NULL,
  UsuarioCriacao nvarchar(100) NOT NULL DEFAULT (''),
  UsuarioBaixa nvarchar(100) NOT NULL DEFAULT (''),
  ItemManutencaoId uniqueidentifier NULL,
  Observacoes nvarchar(500) NOT NULL DEFAULT (''),
  StatusOcorrencia bit NULL DEFAULT (1),
  Solucao varchar(500) NULL DEFAULT (''),
  CONSTRAINT PK_OcorrenciaViagem PRIMARY KEY CLUSTERED (OcorrenciaViagemId),
  CONSTRAINT CK_OcorrenciaViagem_Status CHECK ([Status]='Pendente' OR [Status]='Baixada' OR [Status]='Aberta')
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_OcorrenciaViagem_ItemManutencaoId] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create index [IX_OcorrenciaViagem_ItemManutencaoId] on table [dbo].[OcorrenciaViagem]')
GO
CREATE INDEX IX_OcorrenciaViagem_ItemManutencaoId
  ON dbo.OcorrenciaViagem (ItemManutencaoId)
  WHERE ([ItemManutencaoId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_OcorrenciaViagem_MotoristaId] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create index [IX_OcorrenciaViagem_MotoristaId] on table [dbo].[OcorrenciaViagem]')
GO
CREATE INDEX IX_OcorrenciaViagem_MotoristaId
  ON dbo.OcorrenciaViagem (MotoristaId)
  WHERE ([MotoristaId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_OcorrenciaViagem_Status] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create index [IX_OcorrenciaViagem_Status] on table [dbo].[OcorrenciaViagem]')
GO
CREATE INDEX IX_OcorrenciaViagem_Status
  ON dbo.OcorrenciaViagem (Status)
  ON [PRIMARY]
GO

--
-- Create index [IX_OcorrenciaViagem_VeiculoId] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create index [IX_OcorrenciaViagem_VeiculoId] on table [dbo].[OcorrenciaViagem]')
GO
CREATE INDEX IX_OcorrenciaViagem_VeiculoId
  ON dbo.OcorrenciaViagem (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create index [IX_OcorrenciaViagem_VeiculoId_Status] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create index [IX_OcorrenciaViagem_VeiculoId_Status] on table [dbo].[OcorrenciaViagem]')
GO
CREATE INDEX IX_OcorrenciaViagem_VeiculoId_Status
  ON dbo.OcorrenciaViagem (VeiculoId, Status)
  INCLUDE (Resumo, Descricao, DataCriacao)
  ON [PRIMARY]
GO

--
-- Create index [IX_OcorrenciaViagem_ViagemId] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create index [IX_OcorrenciaViagem_ViagemId] on table [dbo].[OcorrenciaViagem]')
GO
CREATE INDEX IX_OcorrenciaViagem_ViagemId
  ON dbo.OcorrenciaViagem (ViagemId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_OcorrenciaViagem_ItensManutencao] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create foreign key [FK_OcorrenciaViagem_ItensManutencao] on table [dbo].[OcorrenciaViagem]')
GO
ALTER TABLE dbo.OcorrenciaViagem
  ADD CONSTRAINT FK_OcorrenciaViagem_ItensManutencao FOREIGN KEY (ItemManutencaoId) REFERENCES dbo.ItensManutencao (ItemManutencaoId) ON DELETE SET NULL
GO

--
-- Create foreign key [FK_OcorrenciaViagem_Motorista] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create foreign key [FK_OcorrenciaViagem_Motorista] on table [dbo].[OcorrenciaViagem]')
GO
ALTER TABLE dbo.OcorrenciaViagem
  ADD CONSTRAINT FK_OcorrenciaViagem_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId) ON DELETE SET NULL
GO

--
-- Create foreign key [FK_OcorrenciaViagem_Veiculo] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create foreign key [FK_OcorrenciaViagem_Veiculo] on table [dbo].[OcorrenciaViagem]')
GO
ALTER TABLE dbo.OcorrenciaViagem
  ADD CONSTRAINT FK_OcorrenciaViagem_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId)
GO

--
-- Create foreign key [FK_OcorrenciaViagem_Viagem] on table [dbo].[OcorrenciaViagem]
--
PRINT (N'Create foreign key [FK_OcorrenciaViagem_Viagem] on table [dbo].[OcorrenciaViagem]')
GO
ALTER TABLE dbo.OcorrenciaViagem
  ADD CONSTRAINT FK_OcorrenciaViagem_Viagem FOREIGN KEY (ViagemId) REFERENCES dbo.Viagem (ViagemId) ON DELETE CASCADE
GO

--
-- Create or alter view [dbo].[ViewOcorrenciasViagem]
--
GO
PRINT (N'Create or alter view [dbo].[ViewOcorrenciasViagem]')
GO
CREATE OR ALTER VIEW dbo.ViewOcorrenciasViagem 
AS SELECT 
    oc.OcorrenciaViagemId,
    oc.ViagemId,
    oc.VeiculoId,
    oc.MotoristaId,
    ISNULL(oc.Resumo, '') AS Resumo,
    ISNULL(oc.Descricao, '') AS Descricao,
    ISNULL(oc.ImagemOcorrencia, '') AS ImagemOcorrencia,
    ISNULL(oc.Status, 'Aberta') AS Status,
    oc.DataCriacao,
    oc.DataBaixa,
    ISNULL(oc.UsuarioCriacao, '') AS UsuarioCriacao,
    ISNULL(oc.UsuarioBaixa, '') AS UsuarioBaixa,
    oc.ItemManutencaoId,
    ISNULL(oc.Observacoes, '') AS Observacoes,
    vi.DataInicial,
    vi.DataFinal,
    vi.HoraInicio,
    vi.HoraFim,
    vi.NoFichaVistoria,
    ISNULL(vi.Origem, '') AS Origem,
    ISNULL(vi.Destino, '') AS Destino,
    ISNULL(vi.Finalidade, '') AS FinalidadeViagem,
    ISNULL(vi.Status, '') AS StatusViagem,
    ISNULL(ve.Placa, '') AS Placa,
    ISNULL(ma.DescricaoMarca, '') AS DescricaoMarca,
    ISNULL(mo.DescricaoModelo, '') AS DescricaoModelo,
    ISNULL(CONCAT(ve.Placa, ' - ', ma.DescricaoMarca, '/', mo.DescricaoModelo), '') AS VeiculoCompleto,
    ISNULL(CONCAT(ma.DescricaoMarca, '/', mo.DescricaoModelo), '') AS MarcaModelo,
    ISNULL(mt.Nome, '') AS NomeMotorista,
    CAST('' AS VARCHAR(1)) AS FotoMotorista,  -- Campo vazio como placeholder
    DATEDIFF(DAY, oc.DataCriacao, GETDATE()) AS DiasEmAberto,
    CASE 
        WHEN oc.Status = 'Baixada' THEN 'Resolvida'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 30 THEN 'Crítica'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 15 THEN 'Alta'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 7 THEN 'Média'
        ELSE 'Normal'
    END AS Urgencia,
    CASE 
        WHEN oc.Status = 'Baixada' THEN '#28a745'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 30 THEN '#dc3545'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 15 THEN '#ffc107'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 7 THEN '#17a2b8'
        ELSE '#6c757d'
    END AS CorUrgencia
FROM dbo.OcorrenciaViagem oc
    LEFT JOIN dbo.Viagem vi ON oc.ViagemId = vi.ViagemId
    LEFT JOIN dbo.Veiculo ve ON oc.VeiculoId = ve.VeiculoId
    LEFT JOIN dbo.MarcaVeiculo ma ON ve.MarcaId = ma.MarcaId
    LEFT JOIN dbo.ModeloVeiculo mo ON ve.ModeloId = mo.ModeloId
    LEFT JOIN dbo.Motorista mt ON oc.MotoristaId = mt.MotoristaId
GO

--
-- Create or alter view [dbo].[ViewOcorrenciasAbertasVeiculo]
--
GO
PRINT (N'Create or alter view [dbo].[ViewOcorrenciasAbertasVeiculo]')
GO

CREATE OR ALTER VIEW dbo.ViewOcorrenciasAbertasVeiculo
AS
SELECT 
    oc.OcorrenciaViagemId,
    oc.ViagemId,
    oc.VeiculoId,
    oc.MotoristaId,
    oc.Resumo,
    oc.Descricao,
    oc.ImagemOcorrencia,
    oc.DataCriacao,
    oc.UsuarioCriacao,
    
    -- Dados do Veículo
    ve.Placa,
    ma.DescricaoMarca,
    mo.DescricaoModelo,
    CONCAT(ve.Placa, ' - ', ma.DescricaoMarca, '/', mo.DescricaoModelo) AS VeiculoCompleto,
    
    -- Dados da Viagem de Origem
    vi.DataInicial AS DataViagem,
    vi.NoFichaVistoria,
    
    -- Dados do Motorista que registrou
    mt.Nome AS NomeMotorista,
    
    -- Campos de Urgência
    DATEDIFF(DAY, oc.DataCriacao, GETDATE()) AS DiasEmAberto,
    
    CASE 
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 30 THEN 'Crítica'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 15 THEN 'Alta'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 7 THEN 'Média'
        ELSE 'Normal'
    END AS Urgencia,
    
    CASE 
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 30 THEN '#dc3545'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 15 THEN '#ffc107'
        WHEN DATEDIFF(DAY, oc.DataCriacao, GETDATE()) > 7 THEN '#17a2b8'
        ELSE '#6c757d'
    END AS CorUrgencia

FROM dbo.OcorrenciaViagem oc
    INNER JOIN dbo.Viagem vi ON oc.ViagemId = vi.ViagemId
    INNER JOIN dbo.Veiculo ve ON oc.VeiculoId = ve.VeiculoId
    INNER JOIN dbo.MarcaVeiculo ma ON ve.MarcaId = ma.MarcaId
    INNER JOIN dbo.ModeloVeiculo mo ON ve.ModeloId = mo.ModeloId
    LEFT JOIN dbo.Motorista mt ON oc.MotoristaId = mt.MotoristaId

WHERE oc.Status = 'Aberta'

GO

--
-- Create table [dbo].[AlertasFrotiX]
--
PRINT (N'Create table [dbo].[AlertasFrotiX]')
GO
CREATE TABLE dbo.AlertasFrotiX (
  AlertasFrotiXId uniqueidentifier NOT NULL DEFAULT (newid()),
  Titulo nvarchar(200) NOT NULL,
  Descricao nvarchar(1000) NOT NULL,
  TipoAlerta int NOT NULL,
  Prioridade int NOT NULL,
  DataInsercao datetime2 NOT NULL DEFAULT (getdate()),
  DataExibicao datetime2 NULL,
  DataExpiracao datetime2 NULL,
  ViagemId uniqueidentifier NULL,
  ManutencaoId uniqueidentifier NULL,
  MotoristaId uniqueidentifier NULL,
  VeiculoId uniqueidentifier NULL,
  TipoExibicao int NOT NULL,
  HorarioExibicao time NULL,
  UsuarioCriadorId nvarchar(450) NOT NULL,
  Ativo bit NOT NULL DEFAULT (1),
  DataDesativacao datetime NULL,
  DesativadoPor varchar(100) NULL CONSTRAINT DF_AlertasFrotiX_DesativadoPor2 DEFAULT (''),
  MotivoDesativacao varchar(500) NULL CONSTRAINT DF_AlertasFrotiX_MotivoDesativacao2 DEFAULT (''),
  Recorrente char(1) NULL DEFAULT ('N'),
  Intervalo char(1) NULL,
  Monday bit NULL DEFAULT (0),
  Tuesday bit NULL DEFAULT (0),
  Wednesday bit NULL DEFAULT (0),
  Thursday bit NULL DEFAULT (0),
  Friday bit NULL DEFAULT (0),
  Saturday bit NULL DEFAULT (0),
  Sunday bit NULL DEFAULT (0),
  DiaMesRecorrencia int NULL CONSTRAINT DF_AlertasFrotiX_DiaMesRecorrencia2 DEFAULT (0),
  DataFinalRecorrencia datetime2 NULL,
  DatasSelecionadas nvarchar(max) NULL CONSTRAINT DF_AlertasFrotiX_DatasSelecionadas DEFAULT (''),
  RecorrenciaAlertaId uniqueidentifier NULL,
  DiasSemana varchar(500) NULL CONSTRAINT DF_AlertasFrotiX_DiasSemana DEFAULT (''),
  CONSTRAINT PK_AlertasFrotiX PRIMARY KEY CLUSTERED (AlertasFrotiXId),
  CONSTRAINT CK_AlertasFrotiX_DiaMes CHECK ([DiaMesRecorrencia]>=(1) AND [DiaMesRecorrencia]<=(31) OR [DiaMesRecorrencia] IS NULL),
  CONSTRAINT CK_AlertasFrotiX_Intervalo CHECK ([Intervalo]='V' OR [Intervalo]='M' OR [Intervalo]='Q' OR [Intervalo]='S' OR [Intervalo]='D' OR [Intervalo] IS NULL),
  CONSTRAINT CK_AlertasFrotiX_Recorrente CHECK ([Recorrente]='N' OR [Recorrente]='S')
)
ON [PRIMARY]
TEXTIMAGE_ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_Ativo] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_Ativo] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_Ativo
  ON dbo.AlertasFrotiX (Ativo)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_DataExpiracao] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_DataExpiracao] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_DataExpiracao
  ON dbo.AlertasFrotiX (DataExpiracao)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_DataInsercao] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_DataInsercao] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_DataInsercao
  ON dbo.AlertasFrotiX (DataInsercao DESC)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_Intervalo] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_Intervalo] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_Intervalo
  ON dbo.AlertasFrotiX (Intervalo)
  WHERE ([Intervalo] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_RecorrenciaAlertaId] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_RecorrenciaAlertaId] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_RecorrenciaAlertaId
  ON dbo.AlertasFrotiX (RecorrenciaAlertaId)
  WHERE ([RecorrenciaAlertaId] IS NOT NULL)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_Recorrente] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_Recorrente] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_Recorrente
  ON dbo.AlertasFrotiX (Recorrente)
  WHERE ([Recorrente]='S')
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_TipoExibicao] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_TipoExibicao] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_TipoExibicao
  ON dbo.AlertasFrotiX (TipoExibicao)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasFrotiX_TipoExibicao_Recorrente] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create index [IX_AlertasFrotiX_TipoExibicao_Recorrente] on table [dbo].[AlertasFrotiX]')
GO
CREATE INDEX IX_AlertasFrotiX_TipoExibicao_Recorrente
  ON dbo.AlertasFrotiX (TipoExibicao)
  WHERE ([TipoExibicao]>=(4))
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_AlertasFrotiX_Manutencao] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create foreign key [FK_AlertasFrotiX_Manutencao] on table [dbo].[AlertasFrotiX]')
GO
ALTER TABLE dbo.AlertasFrotiX
  ADD CONSTRAINT FK_AlertasFrotiX_Manutencao FOREIGN KEY (ManutencaoId) REFERENCES dbo.Manutencao (ManutencaoId) ON DELETE SET NULL
GO

--
-- Create foreign key [FK_AlertasFrotiX_Motorista] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create foreign key [FK_AlertasFrotiX_Motorista] on table [dbo].[AlertasFrotiX]')
GO
ALTER TABLE dbo.AlertasFrotiX
  ADD CONSTRAINT FK_AlertasFrotiX_Motorista FOREIGN KEY (MotoristaId) REFERENCES dbo.Motorista (MotoristaId) ON DELETE SET NULL
GO

--
-- Create foreign key [FK_AlertasFrotiX_RecorrenciaAlerta] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create foreign key [FK_AlertasFrotiX_RecorrenciaAlerta] on table [dbo].[AlertasFrotiX]')
GO
ALTER TABLE dbo.AlertasFrotiX
  ADD CONSTRAINT FK_AlertasFrotiX_RecorrenciaAlerta FOREIGN KEY (RecorrenciaAlertaId) REFERENCES dbo.AlertasFrotiX (AlertasFrotiXId)
GO

--
-- Create foreign key [FK_AlertasFrotiX_Veiculo] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create foreign key [FK_AlertasFrotiX_Veiculo] on table [dbo].[AlertasFrotiX]')
GO
ALTER TABLE dbo.AlertasFrotiX
  ADD CONSTRAINT FK_AlertasFrotiX_Veiculo FOREIGN KEY (VeiculoId) REFERENCES dbo.Veiculo (VeiculoId) ON DELETE SET NULL
GO

--
-- Create foreign key [FK_AlertasFrotiX_Viagem] on table [dbo].[AlertasFrotiX]
--
PRINT (N'Create foreign key [FK_AlertasFrotiX_Viagem] on table [dbo].[AlertasFrotiX]')
GO
ALTER TABLE dbo.AlertasFrotiX
  ADD CONSTRAINT FK_AlertasFrotiX_Viagem FOREIGN KEY (ViagemId) REFERENCES dbo.Viagem (ViagemId) ON DELETE SET NULL
GO

--
-- Create table [dbo].[AlertasUsuario]
--
PRINT (N'Create table [dbo].[AlertasUsuario]')
GO
CREATE TABLE dbo.AlertasUsuario (
  AlertasUsuarioId uniqueidentifier NOT NULL DEFAULT (newid()),
  AlertasFrotiXId uniqueidentifier NOT NULL,
  UsuarioId nvarchar(450) NOT NULL,
  Lido bit NOT NULL DEFAULT (0),
  DataLeitura datetime2 NULL,
  Notificado bit NOT NULL DEFAULT (0),
  Apagado bit NULL CONSTRAINT DF_AlertasUsuario_Apagado DEFAULT (0),
  DataApagado datetime NULL,
  DataNotificacao datetime NULL,
  CONSTRAINT PK_AlertasUsuario PRIMARY KEY CLUSTERED (AlertasUsuarioId),
  CONSTRAINT UK_AlertasUsuario_Alerta_Usuario UNIQUE (AlertasFrotiXId, UsuarioId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_AlertasUsuario_AlertasFrotiXId] on table [dbo].[AlertasUsuario]
--
PRINT (N'Create index [IX_AlertasUsuario_AlertasFrotiXId] on table [dbo].[AlertasUsuario]')
GO
CREATE INDEX IX_AlertasUsuario_AlertasFrotiXId
  ON dbo.AlertasUsuario (AlertasFrotiXId)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasUsuario_DataLeitura] on table [dbo].[AlertasUsuario]
--
PRINT (N'Create index [IX_AlertasUsuario_DataLeitura] on table [dbo].[AlertasUsuario]')
GO
CREATE INDEX IX_AlertasUsuario_DataLeitura
  ON dbo.AlertasUsuario (DataLeitura DESC)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasUsuario_Lido] on table [dbo].[AlertasUsuario]
--
PRINT (N'Create index [IX_AlertasUsuario_Lido] on table [dbo].[AlertasUsuario]')
GO
CREATE INDEX IX_AlertasUsuario_Lido
  ON dbo.AlertasUsuario (Lido)
  ON [PRIMARY]
GO

--
-- Create index [IX_AlertasUsuario_UsuarioId] on table [dbo].[AlertasUsuario]
--
PRINT (N'Create index [IX_AlertasUsuario_UsuarioId] on table [dbo].[AlertasUsuario]')
GO
CREATE INDEX IX_AlertasUsuario_UsuarioId
  ON dbo.AlertasUsuario (UsuarioId)
  ON [PRIMARY]
GO

--
-- Create foreign key [FK_AlertasUsuario_AlertasFrotiX] on table [dbo].[AlertasUsuario]
--
PRINT (N'Create foreign key [FK_AlertasUsuario_AlertasFrotiX] on table [dbo].[AlertasUsuario]')
GO
ALTER TABLE dbo.AlertasUsuario
  ADD CONSTRAINT FK_AlertasUsuario_AlertasFrotiX FOREIGN KEY (AlertasFrotiXId) REFERENCES dbo.AlertasFrotiX (AlertasFrotiXId) ON DELETE CASCADE
GO

--
-- Create foreign key [FK_AlertasUsuario_AspNetUsers] on table [dbo].[AlertasUsuario]
--
PRINT (N'Create foreign key [FK_AlertasUsuario_AspNetUsers] on table [dbo].[AlertasUsuario]')
GO
ALTER TABLE dbo.AlertasUsuario
  ADD CONSTRAINT FK_AlertasUsuario_AspNetUsers FOREIGN KEY (UsuarioId) REFERENCES dbo.AspNetUsers (Id) ON DELETE CASCADE
GO

--
-- Create or alter view [dbo].[ViewAlertasAtivos]
--
GO
PRINT (N'Create or alter view [dbo].[ViewAlertasAtivos]')
GO
CREATE OR ALTER VIEW dbo.ViewAlertasAtivos 
AS SELECT 
    a.AlertasFrotiXId,
    a.Titulo,
    a.Descricao,
    a.TipoAlerta,
    CASE a.TipoAlerta
        WHEN 1 THEN 'Agendamento'
        WHEN 2 THEN 'Manutenção'
        WHEN 3 THEN 'Motorista'
        WHEN 4 THEN 'Veículo'
        WHEN 5 THEN 'Anúncio'
        ELSE 'Diversos'
    END AS TipoAlertaTexto,
    a.Prioridade,
    CASE a.Prioridade
        WHEN 1 THEN 'Baixa'
        WHEN 2 THEN 'Média'
        WHEN 3 THEN 'Alta'
    END AS PrioridadeTexto,
    a.DataInsercao,
    a.DataExibicao,
    a.DataExpiracao,
    a.ViagemId,
    a.ManutencaoId,
    a.MotoristaId,
    a.VeiculoId,
    a.TipoExibicao,
    a.HorarioExibicao,
    a.UsuarioCriadorId,
    a.Ativo,
    au.UsuarioId,
    au.Lido,
    au.DataLeitura,
    au.Notificado,
    u.UserName,
    u.Email
FROM AlertasFrotiX a
INNER JOIN AlertasUsuario au ON a.AlertasFrotiXId = au.AlertasFrotiXId
INNER JOIN AspNetUsers u ON au.UsuarioId = u.Id
WHERE a.Ativo = 1
GO

--
-- Create user [frotix]
--
PRINT (N'Create user [frotix]')
GO
CREATE USER frotix
  WITHOUT LOGIN
GO

--
-- Create schema [frotix]
--
PRINT (N'Create schema [frotix]')
GO
CREATE SCHEMA frotix AUTHORIZATION frotix
GO

--
-- Create or alter procedure [frotix].[ViewViagens_SP]
--
GO
PRINT (N'Create or alter procedure [frotix].[ViewViagens_SP]')
GO
CREATE OR ALTER Procedure frotix.ViewViagens_SP
as
 

SELECT [ViagemId]
      ,[DataInicial]
      ,[DataFinal]
      ,[HoraInicio]
      ,[HoraFim]
      ,[CombustivelInicial]
      ,[CombustivelFinal]
      ,[KmAtual]
      ,[KmInicial]
      ,[KmFinal]
      ,[Descricao]
      ,[RamalRequisitante]
      ,[Finalidade]
      ,[Status]
      ,[RequisitanteId]
      ,[SetorSolicitanteId]
      ,[VeiculoId]
      ,[MotoristaId]
      ,[UsuarioIdCriacao]
      ,[DataCriacao]
      ,[UsuarioIdFinalizacao]
      ,[DataFinalizacao]
      ,[ResumoOcorrencia]
      ,[DescricaoOcorrencia]
      ,[StatusOcorrencia]
      ,[StatusDocumento]
      ,[StatusCartaoAbastecimento]
      ,[StatusAgendamento]
      ,[Origem]
      ,[Destino]
      ,[DescricaoSemFormato]
      ,[CustoCombustivel]
      ,[CustoMotorista]
      ,[CustoVeiculo]
      ,[CustoOperador]
      ,[CustoLavador]
      ,[Minutos]
      ,[NomeEvento]
      ,[DescricaoSolucaoOcorrencia]
      ,[ImagemOcorrencia]
      ,[ItemManutencaoId]
      ,[EventoId]
      ,[NoFichaVistoria]
 INTO #Viagem FROM  [Viagem] (Nolock)

 
CREATE NONCLUSTERED INDEX #IDX_Prueba ON #Viagem  (SetorSolicitanteId);
CREATE NONCLUSTERED INDEX #IDX_VeiculoId ON #Viagem(VeiculoId);
CREATE NONCLUSTERED INDEX #IDX_StatusOcorrencia on #Viagem (StatusOcorrencia)
CREATE NONCLUSTERED INDEX #IDX_Status ON #Viagem([Status])
CREATE NONCLUSTERED INDEX #IDX_MotoristaId ON #Viagem([MotoristaId])
CREATE NONCLUSTERED INDEX #IDX_RequisitanteID ON #Viagem(RequisitanteID)

SELECT [MotoristaId]
      ,[Nome]
      ,[Ponto]
      ,[DataNascimento]
      ,[CPF]
      ,[CNH]
      ,[CategoriaCNH]
      ,[DataVencimentoCNH]
      ,[Celular01]
      ,[Celular02]
      ,[DataIngresso]
      ,[OrigemIndicacao]
      ---,[Foto]
      ---,[CNHDigital]
      ,[Status]
      ,[UsuarioIdAlteracao]
      ,[DataAlteracao]
      ,[UnidadeId]
      ,[ContratoId]
      ,[CondutorId]
      ,[TipoCondutor]
      ,[EfetivoFerista]
  Into #Motorista FROM [Motorista]

  CREATE NONCLUSTERED INDEX #IDX_Motorista ON #Motorista  (MotoristaId);


  
SELECT [VeiculoId]
      ,[Placa]
      ,[Quilometragem]
      ,[Renavam]
      ,[PlacaVinculada]
      ,[AnoFabricacao]
      ,[AnoModelo]
      ,[Reserva]
      ,[VeiculoProprio]
      ,[Status]
      --,[CRLV]
      ,[DataAlteracao]
      ,[UsuarioIdAlteracao]
      ,[UnidadeId]
      ,[MarcaId]
      ,[ModeloId]
      ,[CombustivelId]
      ,[ContratoId]
      ,[AtaId]
      ,[PlacaBronzeId]
      ,[ItemVeiculoId]
      ,[Patrimonio]
      ,[ItemVeiculoAtaId]
      ,[Categoria]
      ,[DataIngresso]
  Into #Veiculo FROM  [Veiculo]


    CREATE NONCLUSTERED INDEX #IDX_Veiculo ON #Veiculo  (VeiculoId);






 
 
 
 
 
 
 SELECT
 Viagem.ViagemId
 ,CONVERT(VARCHAR, Viagem.DataInicial, 103) AS DataInicial
 ,CONVERT(VARCHAR, Viagem.DataFinal, 103) AS DataFinal
 ,FORMAT(Viagem.HoraInicio, 'HH:mm') AS HoraInicio
 ,FORMAT(Viagem.HoraFim, 'HH:mm') AS HoraFim
 ,Viagem.Descricao
 ,Viagem.Status
 ,Viagem.KmInicial
 ,Viagem.KmFinal
 ,Viagem.CombustivelInicial
 ,Viagem.CombustivelFinal
 ,Viagem.MotoristaId
 ,Viagem.VeiculoId
 ,Viagem.ResumoOcorrencia
 ,Viagem.DescricaoOcorrencia
 ,Viagem.StatusOcorrencia
 ,Viagem.StatusDocumento
 ,Viagem.StatusCartaoAbastecimento
 ,Viagem.StatusAgendamento
 ,Viagem.NoFichaVistoria
 ,Viagem.Finalidade
 ,Veiculo.Placa
 --,Motorista.CNH
 --,Motorista.Foto
 ,Motorista.Ponto
,convert(nvarchar(36), Viagem.ViagemId) AS ViagemIDStr
,CASE
    WHEN Requisitante.Ramal IS NULL THEN Requisitante.Nome
    ELSE Requisitante.Nome + ' - (' + CONVERT(VARCHAR, Requisitante.Ramal) + ')'
  END AS NomeRequisitante
 ,CASE
    WHEN SetorSolicitante.Sigla IS NULL THEN SetorSolicitante.Nome
    ELSE SetorSolicitante.Nome + ' - (' + SetorSolicitante.Sigla + ')'
  END AS NomeSetor
 ,Requisitante.RequisitanteId
 ,SetorSolicitante.SetorSolicitanteId
 ,Motorista.Nome AS NomeMotorista
 ,'(' + Veiculo.Placa + ') - ' + MarcaVeiculo.DescricaoMarca + '/' + ModeloVeiculo.DescricaoModelo AS DescricaoVeiculo
 ,Veiculo.UnidadeId
 ,ROW_NUMBER() OVER (ORDER BY Viagem.DataInicial, Viagem.HoraInicio) AS RowNum
 ,Veiculo.CombustivelId
 ,Viagem.DescricaoSolucaoOcorrencia
 ,Viagem.Origem
 ,Viagem.Destino
 ,Viagem.Minutos
 ,Viagem.NomeEvento
 ,Viagem.RamalRequisitante
 ,Viagem.ImagemOcorrencia
 ,Viagem.ItemManutencaoId
FROM dbo.SetorSolicitante
RIGHT OUTER JOIN #Viagem Viagem --with (index (#IDX_Prueba))
  ON SetorSolicitante.SetorSolicitanteId = Viagem.SetorSolicitanteId
LEFT OUTER JOIN dbo.Requisitante
  ON Requisitante.RequisitanteId = Viagem.RequisitanteId
LEFT OUTER JOIN #Motorista Motorista
  ON Motorista.MotoristaId = Viagem.MotoristaId
LEFT OUTER JOIN #Veiculo Veiculo
  ON Veiculo.VeiculoId = Viagem.VeiculoId
INNER JOIN dbo.ModeloVeiculo
  ON Veiculo.ModeloId = ModeloVeiculo.ModeloId
INNER JOIN dbo.MarcaVeiculo
  ON ModeloVeiculo.MarcaId = MarcaVeiculo.MarcaId
GO

--
-- Create table [dbo].[AnosDisponiveisVeiculo]
--
PRINT (N'Create table [dbo].[AnosDisponiveisVeiculo]')
GO
CREATE TABLE dbo.AnosDisponiveisVeiculo (
  Ano int NOT NULL,
  TotalViagens int NOT NULL DEFAULT (0),
  TotalAbastecimentos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Ano)
)
ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularRankingsVeiculoAnual]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularRankingsVeiculoAnual]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularRankingsVeiculoAnual
    @Ano INT
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- =====================================================
        -- Ranking por KM Rodado
        -- =====================================================
        DELETE FROM EstatisticaVeiculoRankingKm WHERE Ano = @Ano;

        INSERT INTO EstatisticaVeiculoRankingKm (
            Ano, VeiculoId, Placa, Modelo, KmRodado, TotalViagens, DataAtualizacao
        )
        SELECT
            @Ano,
            vi.VeiculoId,
            v.Placa,
            m.DescricaoModelo,
            SUM(ISNULL(vi.KmFinal, 0) - ISNULL(vi.KmInicial, 0)),
            COUNT(*),
            GETDATE()
        FROM Viagem vi
        INNER JOIN Veiculo v ON vi.VeiculoId = v.VeiculoId
        LEFT JOIN ModeloVeiculo m ON v.ModeloId = m.ModeloId
        WHERE YEAR(vi.DataInicial) = @Ano
          AND vi.VeiculoId IS NOT NULL AND vi.VeiculoId <> '00000000-0000-0000-0000-000000000000'
        GROUP BY vi.VeiculoId, v.Placa, m.DescricaoModelo;

        -- =====================================================
        -- Ranking por Litros Abastecidos
        -- =====================================================
        DELETE FROM EstatisticaVeiculoRankingLitros WHERE Ano = @Ano;

        INSERT INTO EstatisticaVeiculoRankingLitros (
            Ano, VeiculoId, Placa, Modelo, LitrosAbastecidos, ValorTotal, TotalAbastecimentos, DataAtualizacao
        )
        SELECT
            @Ano,
            a.VeiculoId,
            v.Placa,
            m.DescricaoModelo,
            SUM(ISNULL(a.Litros, 0)),
            SUM(ISNULL(a.Litros, 0) * ISNULL(a.ValorUnitario, 0)),
            COUNT(*),
            GETDATE()
        FROM Abastecimento a
        INNER JOIN Veiculo v ON a.VeiculoId = v.VeiculoId
        LEFT JOIN ModeloVeiculo m ON v.ModeloId = m.ModeloId
        WHERE YEAR(a.DataHora) = @Ano
          AND a.VeiculoId IS NOT NULL AND a.VeiculoId <> '00000000-0000-0000-0000-000000000000'
        GROUP BY a.VeiculoId, v.Placa, m.DescricaoModelo;

        -- =====================================================
        -- Ranking por Consumo (km/l)
        -- =====================================================
        DELETE FROM EstatisticaVeiculoRankingConsumo WHERE Ano = @Ano;

        -- Primeiro, obter KM por veículo
        WITH KmPorVeiculo AS (
            SELECT
                VeiculoId,
                SUM(ISNULL(KmFinal, 0) - ISNULL(KmInicial, 0)) AS KmRodado
            FROM Viagem
            WHERE YEAR(DataInicial) = @Ano
              AND VeiculoId IS NOT NULL AND VeiculoId <> '00000000-0000-0000-0000-000000000000'
            GROUP BY VeiculoId
        ),
        LitrosPorVeiculo AS (
            SELECT
                VeiculoId,
                SUM(ISNULL(Litros, 0)) AS LitrosAbastecidos,
                COUNT(*) AS TotalAbastecimentos
            FROM Abastecimento
            WHERE YEAR(DataHora) = @Ano
              AND VeiculoId IS NOT NULL AND VeiculoId <> '00000000-0000-0000-0000-000000000000'
            GROUP BY VeiculoId
        )
        INSERT INTO EstatisticaVeiculoRankingConsumo (
            Ano, VeiculoId, Placa, Modelo, KmRodado, LitrosAbastecidos,
            ConsumoKmPorLitro, TotalAbastecimentos, DataAtualizacao
        )
        SELECT
            @Ano,
            COALESCE(k.VeiculoId, l.VeiculoId),
            v.Placa,
            m.DescricaoModelo,
            ISNULL(k.KmRodado, 0),
            ISNULL(l.LitrosAbastecidos, 0),
            CASE WHEN ISNULL(l.LitrosAbastecidos, 0) > 0
                 THEN ROUND(ISNULL(k.KmRodado, 0) / l.LitrosAbastecidos, 2)
                 ELSE 0 END,
            ISNULL(l.TotalAbastecimentos, 0),
            GETDATE()
        FROM KmPorVeiculo k
        FULL OUTER JOIN LitrosPorVeiculo l ON k.VeiculoId = l.VeiculoId
        INNER JOIN Veiculo v ON COALESCE(k.VeiculoId, l.VeiculoId) = v.VeiculoId
        LEFT JOIN ModeloVeiculo m ON v.ModeloId = m.ModeloId
        WHERE ISNULL(k.KmRodado, 0) > 0 OR ISNULL(l.LitrosAbastecidos, 0) > 0;

        -- =====================================================
        -- Atualizar Anos Disponíveis
        -- =====================================================
        DELETE FROM AnosDisponiveisVeiculo WHERE Ano = @Ano;

        INSERT INTO AnosDisponiveisVeiculo (Ano, TotalViagens, TotalAbastecimentos, DataAtualizacao)
        SELECT
            @Ano,
            (SELECT COUNT(*) FROM Viagem WHERE YEAR(DataInicial) = @Ano),
            (SELECT COUNT(*) FROM Abastecimento WHERE YEAR(DataHora) = @Ano),
            GETDATE();

        COMMIT TRANSACTION;
        PRINT 'Rankings anuais de veículos do ano ' + CAST(@Ano AS VARCHAR) + ' recalculados com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaVeiculoUsoMensal]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoUsoMensal]')
GO
CREATE TABLE dbo.EstatisticaVeiculoUsoMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  TotalViagens int NOT NULL DEFAULT (0),
  KmTotalRodado decimal(18, 2) NOT NULL DEFAULT (0),
  TotalAbastecimentos int NOT NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NOT NULL DEFAULT (0),
  ValorAbastecimento decimal(18, 2) NOT NULL DEFAULT (0),
  ConsumoMedio decimal(10, 2) NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicUsoMensal UNIQUE (Ano, Mes)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicUsoMensal_AnoMes] on table [dbo].[EstatisticaVeiculoUsoMensal]
--
PRINT (N'Create index [IX_EstatVeicUsoMensal_AnoMes] on table [dbo].[EstatisticaVeiculoUsoMensal]')
GO
CREATE INDEX IX_EstatVeicUsoMensal_AnoMes
  ON dbo.EstatisticaVeiculoUsoMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoUsoMensal]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoUsoMensal]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoUsoMensal
    @Ano INT,
    @Mes INT
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DECLARE @DataInicio DATE = DATEFROMPARTS(@Ano, @Mes, 1);
        DECLARE @DataFim DATE = EOMONTH(@DataInicio);

        DELETE FROM EstatisticaVeiculoUsoMensal WHERE Ano = @Ano AND Mes = @Mes;

        -- Viagens do mês
        DECLARE @TotalViagens INT = 0;
        DECLARE @KmTotal DECIMAL(18,2) = 0;

        SELECT
            @TotalViagens = COUNT(*),
            @KmTotal = ISNULL(SUM(ISNULL(KmFinal, 0) - ISNULL(KmInicial, 0)), 0)
        FROM Viagem
        WHERE DataInicial >= @DataInicio AND DataInicial < DATEADD(DAY, 1, @DataFim);

        -- Abastecimentos do mês
        DECLARE @TotalAbastecimentos INT = 0;
        DECLARE @LitrosTotal DECIMAL(18,2) = 0;
        DECLARE @ValorAbastecimento DECIMAL(18,2) = 0;

        SELECT
            @TotalAbastecimentos = COUNT(*),
            @LitrosTotal = ISNULL(SUM(ISNULL(Litros, 0)), 0),
            @ValorAbastecimento = ISNULL(SUM(ISNULL(Litros, 0) * ISNULL(ValorUnitario, 0)), 0)
        FROM Abastecimento
        WHERE DataHora >= @DataInicio AND DataHora < DATEADD(DAY, 1, @DataFim);

        -- Consumo médio (km/l)
        DECLARE @ConsumoMedio DECIMAL(10,2) = 0;
        IF @LitrosTotal > 0
            SET @ConsumoMedio = @KmTotal / @LitrosTotal;

        INSERT INTO EstatisticaVeiculoUsoMensal (
            Ano, Mes, TotalViagens, KmTotalRodado,
            TotalAbastecimentos, LitrosTotal, ValorAbastecimento,
            ConsumoMedio, DataAtualizacao
        )
        VALUES (
            @Ano, @Mes, @TotalViagens, @KmTotal,
            @TotalAbastecimentos, @LitrosTotal, @ValorAbastecimento,
            @ConsumoMedio, GETDATE()
        );

        COMMIT TRANSACTION;
        PRINT 'Estatísticas de uso do mês ' + CAST(@Mes AS VARCHAR) + '/' + CAST(@Ano AS VARCHAR) + ' recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create or alter trigger [trg_Viagem_AtualizarEstatisticasVeiculo] on table [dbo].[Viagem]
--
GO
PRINT (N'Create or alter trigger [trg_Viagem_AtualizarEstatisticasVeiculo] on table [dbo].[Viagem]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Viagem_AtualizarEstatisticasVeiculo
ON Viagem
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Coleta anos/meses afetados
    DECLARE @Afetados TABLE (Ano INT, Mes INT);

    INSERT INTO @Afetados (Ano, Mes)
    SELECT DISTINCT YEAR(DataInicial), MONTH(DataInicial)
    FROM inserted
    WHERE DataInicial IS NOT NULL;

    INSERT INTO @Afetados (Ano, Mes)
    SELECT DISTINCT YEAR(DataInicial), MONTH(DataInicial)
    FROM deleted
    WHERE DataInicial IS NOT NULL
      AND NOT EXISTS (
          SELECT 1 FROM @Afetados a
          WHERE a.Ano = YEAR(deleted.DataInicial)
            AND a.Mes = MONTH(deleted.DataInicial)
      );

    -- Recalcula para cada mês afetado
    DECLARE @Ano INT, @Mes INT;
    DECLARE cur CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT Ano, Mes FROM @Afetados;

    OPEN cur;
    FETCH NEXT FROM cur INTO @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC sp_RecalcularEstatisticasVeiculoUsoMensal @Ano, @Mes;
        FETCH NEXT FROM cur INTO @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;

    -- Recalcula rankings anuais
    DECLARE cur2 CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT Ano FROM @Afetados;

    OPEN cur2;
    FETCH NEXT FROM cur2 INTO @Ano;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC sp_RecalcularRankingsVeiculoAnual @Ano;
        FETCH NEXT FROM cur2 INTO @Ano;
    END

    CLOSE cur2;
    DEALLOCATE cur2;
END
GO

--
-- Create table [dbo].[EstatisticaVeiculoAnoFabricacao]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoAnoFabricacao]')
GO
CREATE TABLE dbo.EstatisticaVeiculoAnoFabricacao (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  AnoFabricacao int NOT NULL,
  TotalVeiculos int NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatVeicAnoFab UNIQUE (AnoFabricacao)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatVeicAnoFab] on table [dbo].[EstatisticaVeiculoAnoFabricacao]
--
PRINT (N'Create index [IX_EstatVeicAnoFab] on table [dbo].[EstatisticaVeiculoAnoFabricacao]')
GO
CREATE INDEX IX_EstatVeicAnoFab
  ON dbo.EstatisticaVeiculoAnoFabricacao (AnoFabricacao)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoAnoFabricacao]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoAnoFabricacao]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoAnoFabricacao
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        DELETE FROM EstatisticaVeiculoAnoFabricacao;

        INSERT INTO EstatisticaVeiculoAnoFabricacao (AnoFabricacao, TotalVeiculos, DataAtualizacao)
        SELECT
            ISNULL(AnoFabricacao, 0),
            COUNT(*),
            GETDATE()
        FROM Veiculo
        WHERE AnoFabricacao IS NOT NULL AND AnoFabricacao > 0
        GROUP BY AnoFabricacao;

        COMMIT TRANSACTION;
        PRINT 'Estatísticas por ano de fabricação recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaVeiculoGeral]
--
PRINT (N'Create table [dbo].[EstatisticaVeiculoGeral]')
GO
CREATE TABLE dbo.EstatisticaVeiculoGeral (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  TotalVeiculos int NOT NULL DEFAULT (0),
  VeiculosAtivos int NOT NULL DEFAULT (0),
  VeiculosInativos int NOT NULL DEFAULT (0),
  VeiculosProprios int NOT NULL DEFAULT (0),
  VeiculosLocados int NOT NULL DEFAULT (0),
  IdadeMediaAnos decimal(10, 2) NOT NULL DEFAULT (0),
  KmMedioRodado decimal(18, 2) NOT NULL DEFAULT (0),
  ValorMensalLocacao decimal(18, 2) NOT NULL DEFAULT (0),
  DataAtualizacao datetime NOT NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id)
)
ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoGeral]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasVeiculoGeral]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasVeiculoGeral
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- Limpa tabela
        DELETE FROM EstatisticaVeiculoGeral;

        -- Insere estatísticas gerais
        INSERT INTO EstatisticaVeiculoGeral (
            TotalVeiculos, VeiculosAtivos, VeiculosInativos,
            VeiculosProprios, VeiculosLocados, IdadeMediaAnos,
            KmMedioRodado, ValorMensalLocacao, DataAtualizacao
        )
        SELECT
            COUNT(*),
            SUM(CASE WHEN Status = 1 THEN 1 ELSE 0 END),
            SUM(CASE WHEN Status = 0 THEN 1 ELSE 0 END),
            SUM(CASE WHEN VeiculoProprio = 1 THEN 1 ELSE 0 END),
            SUM(CASE WHEN VeiculoProprio = 0 THEN 1 ELSE 0 END),
            ISNULL(AVG(CAST(YEAR(GETDATE()) - AnoFabricacao AS DECIMAL(10,2))), 0),
            ISNULL(AVG(CAST(Quilometragem AS DECIMAL(18,2))), 0),
            ISNULL(SUM(CASE WHEN VeiculoProprio = 0 THEN ISNULL(ValorMensal, 0) ELSE 0 END), 0),
            GETDATE()
        FROM Veiculo;

        COMMIT TRANSACTION;
        PRINT 'Estatísticas gerais de veículos recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create or alter trigger [trg_Veiculo_AtualizarEstatisticas] on table [dbo].[Veiculo]
--
GO
PRINT (N'Create or alter trigger [trg_Veiculo_AtualizarEstatisticas] on table [dbo].[Veiculo]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Veiculo_AtualizarEstatisticas
ON Veiculo
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Atualiza estatísticas da frota (snapshot)
    EXEC sp_RecalcularEstatisticasVeiculoGeral;
    EXEC sp_RecalcularEstatisticasVeiculoCategoria;
    EXEC sp_RecalcularEstatisticasVeiculoStatus;
    EXEC sp_RecalcularEstatisticasVeiculoModelo;
    EXEC sp_RecalcularEstatisticasVeiculoCombustivel;
    EXEC sp_RecalcularEstatisticasVeiculoUnidade;
    EXEC sp_RecalcularEstatisticasVeiculoAnoFabricacao;
END
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularTodasEstatisticasVeiculos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularTodasEstatisticasVeiculos]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularTodasEstatisticasVeiculos
AS
BEGIN
    SET NOCOUNT ON;

    PRINT 'Iniciando recálculo de todas as estatísticas de veículos...';
    PRINT '';

    -- Estatísticas da frota (snapshot atual)
    PRINT '1. Recalculando estatísticas gerais da frota...';
    EXEC sp_RecalcularEstatisticasVeiculoGeral;

    PRINT '2. Recalculando estatísticas por categoria...';
    EXEC sp_RecalcularEstatisticasVeiculoCategoria;

    PRINT '3. Recalculando estatísticas por status...';
    EXEC sp_RecalcularEstatisticasVeiculoStatus;

    PRINT '4. Recalculando estatísticas por modelo...';
    EXEC sp_RecalcularEstatisticasVeiculoModelo;

    PRINT '5. Recalculando estatísticas por combustível...';
    EXEC sp_RecalcularEstatisticasVeiculoCombustivel;

    PRINT '6. Recalculando estatísticas por unidade...';
    EXEC sp_RecalcularEstatisticasVeiculoUnidade;

    PRINT '7. Recalculando estatísticas por ano de fabricação...';
    EXEC sp_RecalcularEstatisticasVeiculoAnoFabricacao;

    -- Estatísticas de uso (por ano/mês)
    PRINT '';
    PRINT '8. Recalculando estatísticas de uso mensal...';

    DECLARE @AnoMes TABLE (Ano INT, Mes INT);

    -- Anos/meses de viagens
    INSERT INTO @AnoMes (Ano, Mes)
    SELECT DISTINCT YEAR(DataInicial), MONTH(DataInicial)
    FROM Viagem
    WHERE DataInicial IS NOT NULL;

    -- Anos/meses de abastecimentos (sem duplicar)
    INSERT INTO @AnoMes (Ano, Mes)
    SELECT DISTINCT YEAR(DataHora), MONTH(DataHora)
    FROM Abastecimento
    WHERE DataHora IS NOT NULL
      AND NOT EXISTS (SELECT 1 FROM @AnoMes am WHERE am.Ano = YEAR(DataHora) AND am.Mes = MONTH(DataHora));

    DECLARE @Ano INT, @Mes INT;
    DECLARE cur CURSOR FOR SELECT DISTINCT Ano, Mes FROM @AnoMes ORDER BY Ano, Mes;

    OPEN cur;
    FETCH NEXT FROM cur INTO @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        PRINT '   Processando ' + CAST(@Mes AS VARCHAR) + '/' + CAST(@Ano AS VARCHAR) + '...';
        EXEC sp_RecalcularEstatisticasVeiculoUsoMensal @Ano, @Mes;
        FETCH NEXT FROM cur INTO @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;

    -- Rankings anuais
    PRINT '';
    PRINT '9. Recalculando rankings anuais...';

    DECLARE @Anos TABLE (Ano INT);
    INSERT INTO @Anos SELECT DISTINCT Ano FROM @AnoMes;

    DECLARE cur2 CURSOR FOR SELECT Ano FROM @Anos ORDER BY Ano;
    OPEN cur2;
    FETCH NEXT FROM cur2 INTO @Ano;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        PRINT '   Processando rankings de ' + CAST(@Ano AS VARCHAR) + '...';
        EXEC sp_RecalcularRankingsVeiculoAnual @Ano;
        FETCH NEXT FROM cur2 INTO @Ano;
    END

    CLOSE cur2;
    DEALLOCATE cur2;

    PRINT '';
    PRINT '=====================================================';
    PRINT 'Todas as estatísticas de veículos foram recalculadas!';
    PRINT '=====================================================';
END
GO

--
-- Create or alter procedure [dbo].[sp_AtualizarEstatisticasVeiculosMesAtual]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_AtualizarEstatisticasVeiculosMesAtual]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_AtualizarEstatisticasVeiculosMesAtual
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Ano INT = YEAR(GETDATE());
    DECLARE @Mes INT = MONTH(GETDATE());

    -- Atualiza snapshot da frota
    EXEC sp_RecalcularEstatisticasVeiculoGeral;
    EXEC sp_RecalcularEstatisticasVeiculoCategoria;
    EXEC sp_RecalcularEstatisticasVeiculoStatus;
    EXEC sp_RecalcularEstatisticasVeiculoModelo;
    EXEC sp_RecalcularEstatisticasVeiculoCombustivel;
    EXEC sp_RecalcularEstatisticasVeiculoUnidade;
    EXEC sp_RecalcularEstatisticasVeiculoAnoFabricacao;

    -- Atualiza mês atual
    EXEC sp_RecalcularEstatisticasVeiculoUsoMensal @Ano, @Mes;
    EXEC sp_RecalcularRankingsVeiculoAnual @Ano;

    -- Atualiza mês anterior
    IF @Mes = 1
    BEGIN
        SET @Ano = @Ano - 1;
        SET @Mes = 12;
    END
    ELSE
        SET @Mes = @Mes - 1;

    EXEC sp_RecalcularEstatisticasVeiculoUsoMensal @Ano, @Mes;

    PRINT 'Estatísticas de veículos do mês atual e anterior atualizadas!';
END
GO

--
-- Create table [dbo].[AnosDisponiveisAbastecimento]
--
PRINT (N'Create table [dbo].[AnosDisponiveisAbastecimento]')
GO
CREATE TABLE dbo.AnosDisponiveisAbastecimento (
  Ano int NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Ano)
)
ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasAbastecimentosAnuais]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasAbastecimentosAnuais]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasAbastecimentosAnuais
    @Ano INT
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- Recalcula estatísticas anuais por veículo (para ranking)
        DELETE FROM EstatisticaAbastecimentoVeiculo WHERE Ano = @Ano;

        INSERT INTO EstatisticaAbastecimentoVeiculo (Ano, VeiculoId, Placa, TipoVeiculo, Categoria, TotalAbastecimentos, ValorTotal, LitrosTotal, DataAtualizacao)
        SELECT
            @Ano,
            a.VeiculoId,
            v.Placa,
            m.DescricaoModelo,
            v.Categoria,
            COUNT(*),
            SUM(ISNULL(a.Litros, 0) * ISNULL(a.ValorUnitario, 0)),
            SUM(ISNULL(a.Litros, 0)),
            GETDATE()
        FROM Abastecimento a
        INNER JOIN Veiculo v ON a.VeiculoId = v.VeiculoId
        LEFT JOIN ModeloVeiculo m ON v.ModeloId = m.ModeloId
        WHERE YEAR(a.DataHora) = @Ano
          AND a.VeiculoId IS NOT NULL AND a.VeiculoId <> '00000000-0000-0000-0000-000000000000'
        GROUP BY a.VeiculoId, v.Placa, m.DescricaoModelo, v.Categoria;

        -- Atualiza lista de anos disponíveis
        DELETE FROM AnosDisponiveisAbastecimento WHERE Ano = @Ano;

        INSERT INTO AnosDisponiveisAbastecimento (Ano, TotalAbastecimentos, DataAtualizacao)
        SELECT @Ano, COUNT(*), GETDATE()
        FROM Abastecimento
        WHERE YEAR(DataHora) = @Ano;

        COMMIT TRANSACTION;

        PRINT 'Estatísticas anuais de abastecimentos do ano ' + CAST(@Ano AS VARCHAR) + ' recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create table [dbo].[EstatisticaAbastecimentoMensal]
--
PRINT (N'Create table [dbo].[EstatisticaAbastecimentoMensal]')
GO
CREATE TABLE dbo.EstatisticaAbastecimentoMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatAbastMensal UNIQUE (Ano, Mes)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastMensal_AnoMes] on table [dbo].[EstatisticaAbastecimentoMensal]
--
PRINT (N'Create index [IX_EstatAbastMensal_AnoMes] on table [dbo].[EstatisticaAbastecimentoMensal]')
GO
CREATE INDEX IX_EstatAbastMensal_AnoMes
  ON dbo.EstatisticaAbastecimentoMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create table [dbo].[EstatisticaAbastecimentoVeiculoMensal]
--
PRINT (N'Create table [dbo].[EstatisticaAbastecimentoVeiculoMensal]')
GO
CREATE TABLE dbo.EstatisticaAbastecimentoVeiculoMensal (
  Id uniqueidentifier NOT NULL DEFAULT (newid()),
  Ano int NOT NULL,
  Mes int NOT NULL,
  VeiculoId uniqueidentifier NOT NULL,
  TotalAbastecimentos int NULL DEFAULT (0),
  ValorTotal decimal(18, 2) NULL DEFAULT (0),
  LitrosTotal decimal(18, 2) NULL DEFAULT (0),
  DataAtualizacao datetime NULL DEFAULT (getdate()),
  PRIMARY KEY CLUSTERED (Id),
  CONSTRAINT UQ_EstatAbastVeiculoMes UNIQUE (Ano, Mes, VeiculoId)
)
ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastVeiculoMes_AnoMes] on table [dbo].[EstatisticaAbastecimentoVeiculoMensal]
--
PRINT (N'Create index [IX_EstatAbastVeiculoMes_AnoMes] on table [dbo].[EstatisticaAbastecimentoVeiculoMensal]')
GO
CREATE INDEX IX_EstatAbastVeiculoMes_AnoMes
  ON dbo.EstatisticaAbastecimentoVeiculoMensal (Ano, Mes)
  ON [PRIMARY]
GO

--
-- Create index [IX_EstatAbastVeiculoMes_Veiculo] on table [dbo].[EstatisticaAbastecimentoVeiculoMensal]
--
PRINT (N'Create index [IX_EstatAbastVeiculoMes_Veiculo] on table [dbo].[EstatisticaAbastecimentoVeiculoMensal]')
GO
CREATE INDEX IX_EstatAbastVeiculoMes_Veiculo
  ON dbo.EstatisticaAbastecimentoVeiculoMensal (VeiculoId)
  ON [PRIMARY]
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularEstatisticasAbastecimentos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularEstatisticasAbastecimentos]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularEstatisticasAbastecimentos
    @Ano INT,
    @Mes INT
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DataInicio DATE = DATEFROMPARTS(@Ano, @Mes, 1);
    DECLARE @DataFim DATE = EOMONTH(@DataInicio);

    BEGIN TRY
        BEGIN TRANSACTION;

        -- =====================================================
        -- 9.1 Estatísticas Gerais do Mês
        -- =====================================================

        DELETE FROM EstatisticaAbastecimentoMensal WHERE Ano = @Ano AND Mes = @Mes;

        INSERT INTO EstatisticaAbastecimentoMensal (Ano, Mes, TotalAbastecimentos, ValorTotal, LitrosTotal, DataAtualizacao)
        SELECT
            @Ano,
            @Mes,
            COUNT(*),
            SUM(ISNULL(Litros, 0) * ISNULL(ValorUnitario, 0)),
            SUM(ISNULL(Litros, 0)),
            GETDATE()
        FROM Abastecimento
        WHERE DataHora >= @DataInicio AND DataHora < DATEADD(DAY, 1, @DataFim);

        -- =====================================================
        -- 9.2 Estatísticas por Combustível
        -- =====================================================

        DELETE FROM EstatisticaAbastecimentoCombustivel WHERE Ano = @Ano AND Mes = @Mes;

        INSERT INTO EstatisticaAbastecimentoCombustivel (Ano, Mes, TipoCombustivel, TotalAbastecimentos, ValorTotal, LitrosTotal, MediaValorLitro, DataAtualizacao)
        SELECT
            @Ano,
            @Mes,
            ISNULL(c.Descricao, 'Não Informado'),
            COUNT(*),
            SUM(ISNULL(a.Litros, 0) * ISNULL(a.ValorUnitario, 0)),
            SUM(ISNULL(a.Litros, 0)),
            AVG(ISNULL(a.ValorUnitario, 0)),
            GETDATE()
        FROM Abastecimento a
        LEFT JOIN Combustivel c ON a.CombustivelId = c.CombustivelId
        WHERE a.DataHora >= @DataInicio AND a.DataHora < DATEADD(DAY, 1, @DataFim)
        GROUP BY c.Descricao;

        -- =====================================================
        -- 9.3 Estatísticas por Categoria de Veículo
        -- =====================================================

        DELETE FROM EstatisticaAbastecimentoCategoria WHERE Ano = @Ano AND Mes = @Mes;

        INSERT INTO EstatisticaAbastecimentoCategoria (Ano, Mes, Categoria, TotalAbastecimentos, ValorTotal, LitrosTotal, DataAtualizacao)
        SELECT
            @Ano,
            @Mes,
            ISNULL(v.Categoria, 'Sem Categoria'),
            COUNT(*),
            SUM(ISNULL(a.Litros, 0) * ISNULL(a.ValorUnitario, 0)),
            SUM(ISNULL(a.Litros, 0)),
            GETDATE()
        FROM Abastecimento a
        LEFT JOIN Veiculo v ON a.VeiculoId = v.VeiculoId
        WHERE a.DataHora >= @DataInicio AND a.DataHora < DATEADD(DAY, 1, @DataFim)
        GROUP BY v.Categoria;

        -- =====================================================
        -- 9.4 Estatísticas por Tipo/Modelo de Veículo
        -- =====================================================

        DELETE FROM EstatisticaAbastecimentoTipoVeiculo WHERE Ano = @Ano AND Mes = @Mes;

        INSERT INTO EstatisticaAbastecimentoTipoVeiculo (Ano, Mes, TipoVeiculo, TotalAbastecimentos, ValorTotal, LitrosTotal, DataAtualizacao)
        SELECT
            @Ano,
            @Mes,
            ISNULL(m.DescricaoModelo, 'Não Informado'),
            COUNT(*),
            SUM(ISNULL(a.Litros, 0) * ISNULL(a.ValorUnitario, 0)),
            SUM(ISNULL(a.Litros, 0)),
            GETDATE()
        FROM Abastecimento a
        LEFT JOIN Veiculo v ON a.VeiculoId = v.VeiculoId
        LEFT JOIN ModeloVeiculo m ON v.ModeloId = m.ModeloId
        WHERE a.DataHora >= @DataInicio AND a.DataHora < DATEADD(DAY, 1, @DataFim)
        GROUP BY m.DescricaoModelo;

        -- =====================================================
        -- 9.5 Estatísticas por Veículo Mensal
        -- =====================================================

        DELETE FROM EstatisticaAbastecimentoVeiculoMensal WHERE Ano = @Ano AND Mes = @Mes;

        INSERT INTO EstatisticaAbastecimentoVeiculoMensal (Ano, Mes, VeiculoId, TotalAbastecimentos, ValorTotal, LitrosTotal, DataAtualizacao)
        SELECT
            @Ano,
            @Mes,
            a.VeiculoId,
            COUNT(*),
            SUM(ISNULL(a.Litros, 0) * ISNULL(a.ValorUnitario, 0)),
            SUM(ISNULL(a.Litros, 0)),
            GETDATE()
        FROM Abastecimento a
        WHERE a.DataHora >= @DataInicio AND a.DataHora < DATEADD(DAY, 1, @DataFim)
          AND a.VeiculoId IS NOT NULL AND a.VeiculoId <> '00000000-0000-0000-0000-000000000000'
        GROUP BY a.VeiculoId;

        -- =====================================================
        -- 9.6 Heatmap Geral (todos os veículos)
        -- =====================================================

        DELETE FROM HeatmapAbastecimentoMensal
        WHERE Ano = @Ano AND Mes = @Mes AND VeiculoId IS NULL AND TipoVeiculo IS NULL;

        INSERT INTO HeatmapAbastecimentoMensal (Ano, Mes, VeiculoId, TipoVeiculo, DiaSemana, Hora, TotalAbastecimentos, ValorTotal, DataAtualizacao)
        SELECT
            @Ano, @Mes, NULL, NULL,
            DATEPART(WEEKDAY, DataHora) - 1, -- 0=Domingo
            DATEPART(HOUR, DataHora),
            COUNT(*),
            SUM(ISNULL(Litros, 0) * ISNULL(ValorUnitario, 0)),
            GETDATE()
        FROM Abastecimento
        WHERE DataHora >= @DataInicio AND DataHora < DATEADD(DAY, 1, @DataFim)
        GROUP BY DATEPART(WEEKDAY, DataHora), DATEPART(HOUR, DataHora);

        COMMIT TRANSACTION;

        PRINT 'Estatísticas de abastecimentos do mês ' + CAST(@Mes AS VARCHAR) + '/' + CAST(@Ano AS VARCHAR) + ' recalculadas com sucesso.';

    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END
GO

--
-- Create or alter trigger [trg_Abastecimento_AtualizarEstatisticas] on table [dbo].[Abastecimento]
--
GO
PRINT (N'Create or alter trigger [trg_Abastecimento_AtualizarEstatisticas] on table [dbo].[Abastecimento]')
GO
CREATE OR ALTER TRIGGER dbo.trg_Abastecimento_AtualizarEstatisticas
ON Abastecimento
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;

    -- Coleta anos/meses afetados
    DECLARE @Afetados TABLE (Ano INT, Mes INT);

    INSERT INTO @Afetados (Ano, Mes)
    SELECT DISTINCT YEAR(DataHora), MONTH(DataHora)
    FROM inserted
    WHERE DataHora IS NOT NULL;

    INSERT INTO @Afetados (Ano, Mes)
    SELECT DISTINCT YEAR(DataHora), MONTH(DataHora)
    FROM deleted
    WHERE DataHora IS NOT NULL
      AND NOT EXISTS (
          SELECT 1 FROM @Afetados a
          WHERE a.Ano = YEAR(deleted.DataHora)
            AND a.Mes = MONTH(deleted.DataHora)
      );

    -- Recalcula estatísticas para cada mês afetado
    DECLARE @Ano INT, @Mes INT;
    DECLARE cur CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT Ano, Mes FROM @Afetados;

    OPEN cur;
    FETCH NEXT FROM cur INTO @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC sp_RecalcularEstatisticasAbastecimentos @Ano, @Mes;
        FETCH NEXT FROM cur INTO @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;

    -- Recalcula estatísticas anuais
    DECLARE cur2 CURSOR LOCAL FAST_FORWARD FOR
        SELECT DISTINCT Ano FROM @Afetados;

    OPEN cur2;
    FETCH NEXT FROM cur2 INTO @Ano;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC sp_RecalcularEstatisticasAbastecimentosAnuais @Ano;
        FETCH NEXT FROM cur2 INTO @Ano;
    END

    CLOSE cur2;
    DEALLOCATE cur2;
END
GO

--
-- Create or alter procedure [dbo].[sp_RecalcularTodasEstatisticasAbastecimentos]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_RecalcularTodasEstatisticasAbastecimentos]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_RecalcularTodasEstatisticasAbastecimentos
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @AnoMes TABLE (Ano INT, Mes INT);

    -- Busca todos os anos/meses com abastecimentos
    INSERT INTO @AnoMes (Ano, Mes)
    SELECT DISTINCT YEAR(DataHora), MONTH(DataHora)
    FROM Abastecimento
    WHERE DataHora IS NOT NULL
    ORDER BY YEAR(DataHora), MONTH(DataHora);

    DECLARE @Ano INT, @Mes INT;
    DECLARE cur CURSOR FOR SELECT Ano, Mes FROM @AnoMes ORDER BY Ano, Mes;

    OPEN cur;
    FETCH NEXT FROM cur INTO @Ano, @Mes;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        PRINT 'Processando ' + CAST(@Mes AS VARCHAR) + '/' + CAST(@Ano AS VARCHAR) + '...';
        EXEC sp_RecalcularEstatisticasAbastecimentos @Ano, @Mes;
        FETCH NEXT FROM cur INTO @Ano, @Mes;
    END

    CLOSE cur;
    DEALLOCATE cur;

    -- Recalcula estatísticas anuais
    DECLARE @Anos TABLE (Ano INT);
    INSERT INTO @Anos SELECT DISTINCT Ano FROM @AnoMes;

    DECLARE cur2 CURSOR FOR SELECT Ano FROM @Anos ORDER BY Ano;
    OPEN cur2;
    FETCH NEXT FROM cur2 INTO @Ano;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        PRINT 'Processando estatísticas anuais de ' + CAST(@Ano AS VARCHAR) + '...';
        EXEC sp_RecalcularEstatisticasAbastecimentosAnuais @Ano;
        FETCH NEXT FROM cur2 INTO @Ano;
    END

    CLOSE cur2;
    DEALLOCATE cur2;

    PRINT 'Todas as estatísticas de abastecimentos foram recalculadas!';
END
GO

--
-- Create or alter procedure [dbo].[sp_AtualizarEstatisticasAbastecimentosMesAtual]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_AtualizarEstatisticasAbastecimentosMesAtual]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_AtualizarEstatisticasAbastecimentosMesAtual
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @Ano INT = YEAR(GETDATE());
    DECLARE @Mes INT = MONTH(GETDATE());

    -- Recalcula mês atual
    EXEC sp_RecalcularEstatisticasAbastecimentos @Ano, @Mes;
    EXEC sp_RecalcularEstatisticasAbastecimentosAnuais @Ano;

    -- Recalcula também mês anterior
    IF @Mes = 1
    BEGIN
        SET @Ano = @Ano - 1;
        SET @Mes = 12;
    END
    ELSE
        SET @Mes = @Mes - 1;

    EXEC sp_RecalcularEstatisticasAbastecimentos @Ano, @Mes;

    PRINT 'Estatísticas de abastecimentos do mês atual e anterior atualizadas!';
END
GO

--
-- Create or alter procedure [dbo].[sp_TratarNulosTabela]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_TratarNulosTabela]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_TratarNulosTabela
    @NomeTabela NVARCHAR(128)
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @SQL NVARCHAR(MAX) = 'UPDATE ' + QUOTENAME(@NomeTabela) + ' SET ';
    DECLARE @Colunas NVARCHAR(MAX) = '';
    DECLARE @Where NVARCHAR(MAX) = ' WHERE ';
    
    SELECT @Colunas = @Colunas + QUOTENAME(c.COLUMN_NAME) + ' = ISNULL(' + QUOTENAME(c.COLUMN_NAME) + ', ' +
        CASE 
            WHEN c.DATA_TYPE IN ('varchar','nvarchar','char','nchar','text','ntext') THEN ''''''
            WHEN c.DATA_TYPE IN ('int','bigint','smallint','tinyint','decimal','numeric','float','real','money') THEN '0'
            WHEN c.DATA_TYPE = 'bit' THEN '1'
            ELSE 'NULL'
        END + '), '
    FROM INFORMATION_SCHEMA.COLUMNS c
    WHERE c.TABLE_NAME = @NomeTabela
      AND c.TABLE_SCHEMA = 'dbo'
      AND c.IS_NULLABLE = 'YES'
      AND c.DATA_TYPE IN ('varchar','nvarchar','char','nchar','text','ntext',
                          'int','bigint','smallint','tinyint','decimal','numeric','float','real','money',
                          'bit')
      -- Exclui colunas que são FK
      AND NOT EXISTS (
          SELECT 1 FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu
          INNER JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc 
              ON kcu.CONSTRAINT_NAME = tc.CONSTRAINT_NAME
          WHERE tc.CONSTRAINT_TYPE = 'FOREIGN KEY'
            AND kcu.TABLE_NAME = c.TABLE_NAME
            AND kcu.COLUMN_NAME = c.COLUMN_NAME
      )
      -- Exclui colunas com CHECK constraints
      AND NOT EXISTS (
          SELECT 1 FROM INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE ccu
          INNER JOIN INFORMATION_SCHEMA.CHECK_CONSTRAINTS cc 
              ON ccu.CONSTRAINT_NAME = cc.CONSTRAINT_NAME
          WHERE ccu.TABLE_NAME = c.TABLE_NAME
            AND ccu.COLUMN_NAME = c.COLUMN_NAME
      );
    
    SELECT @Where = @Where + QUOTENAME(c.COLUMN_NAME) + ' IS NULL OR '
    FROM INFORMATION_SCHEMA.COLUMNS c
    WHERE c.TABLE_NAME = @NomeTabela
      AND c.TABLE_SCHEMA = 'dbo'
      AND c.IS_NULLABLE = 'YES'
      AND c.DATA_TYPE IN ('varchar','nvarchar','char','nchar','text','ntext',
                          'int','bigint','smallint','tinyint','decimal','numeric','float','real','money',
                          'bit')
      AND NOT EXISTS (
          SELECT 1 FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu
          INNER JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc 
              ON kcu.CONSTRAINT_NAME = tc.CONSTRAINT_NAME
          WHERE tc.CONSTRAINT_TYPE = 'FOREIGN KEY'
            AND kcu.TABLE_NAME = c.TABLE_NAME
            AND kcu.COLUMN_NAME = c.COLUMN_NAME
      )
      AND NOT EXISTS (
          SELECT 1 FROM INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE ccu
          INNER JOIN INFORMATION_SCHEMA.CHECK_CONSTRAINTS cc 
              ON ccu.CONSTRAINT_NAME = cc.CONSTRAINT_NAME
          WHERE ccu.TABLE_NAME = c.TABLE_NAME
            AND ccu.COLUMN_NAME = c.COLUMN_NAME
      );
    
    IF LEN(@Colunas) > 1
    BEGIN
        SET @Colunas = LEFT(@Colunas, LEN(@Colunas) - 1);
        SET @Where = LEFT(@Where, LEN(@Where) - 3);
        SET @SQL = @SQL + @Colunas + @Where;
        EXEC sp_executesql @SQL;
    END
END
GO

--
-- Create or alter procedure [dbo].[sp_TratarNulosTodasTabelas]
--
GO
PRINT (N'Create or alter procedure [dbo].[sp_TratarNulosTodasTabelas]')
GO

CREATE OR ALTER PROCEDURE dbo.sp_TratarNulosTodasTabelas
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @Tabela NVARCHAR(128);
    DECLARE curTabelas CURSOR FOR
        SELECT TABLE_NAME 
        FROM INFORMATION_SCHEMA.TABLES 
        WHERE TABLE_SCHEMA = 'dbo' 
          AND TABLE_TYPE = 'BASE TABLE'
          AND TABLE_NAME NOT LIKE 'AspNet%'
          AND TABLE_NAME NOT LIKE '__EF%';
    
    OPEN curTabelas;
    FETCH NEXT FROM curTabelas INTO @Tabela;
    
    WHILE @@FETCH_STATUS = 0
    BEGIN
        EXEC dbo.sp_TratarNulosTabela @Tabela;
        FETCH NEXT FROM curTabelas INTO @Tabela;
    END
    
    CLOSE curTabelas;
    DEALLOCATE curTabelas;
END
GO

--
-- Create table [dbo].[RepactuacaoServicos]
--
PRINT (N'Create table [dbo].[RepactuacaoServicos]')
GO
CREATE TABLE dbo.RepactuacaoServicos (
  RepactuacaoServicoId uniqueidentifier NOT NULL,
  DataRepactuacao date NULL,
  Valor float NULL,
  RepactuacaoContratoId uniqueidentifier NOT NULL,
  CONSTRAINT PK_RepactuacaoServicos_RepactuacaoTerceirizacaoId PRIMARY KEY CLUSTERED (RepactuacaoServicoId)
)
ON [PRIMARY]
GO

--
-- Create or alter function [dbo].[InitCapWithExceptions]
--
GO
PRINT (N'Create or alter function [dbo].[InitCapWithExceptions]')
GO
CREATE OR ALTER FUNCTION dbo.InitCapWithExceptions (@input VARCHAR(MAX))
RETURNS VARCHAR(MAX)
AS
BEGIN
    DECLARE @output VARCHAR(MAX) = ''
    DECLARE @word VARCHAR(100)
    DECLARE @pos INT = 1
    DECLARE @len INT
    DECLARE @exceptions TABLE (ex VARCHAR(10))
    
    -- Inserindo exceções
    INSERT INTO @exceptions (ex) VALUES ('I'), ('II'), ('III'), ('V')

    SET @input = LTRIM(RTRIM(@input)) -- trim inicial/final

    WHILE @pos <= LEN(@input)
    BEGIN
        SET @len = CHARINDEX(' ', @input + ' ', @pos) - @pos
        SET @word = SUBSTRING(@input, @pos, @len)
        
        IF EXISTS (SELECT 1 FROM @exceptions WHERE ex = UPPER(@word))
            SET @output = @output + UPPER(@word)
        ELSE
            SET @output = @output + UPPER(LEFT(@word, 1)) + LOWER(SUBSTRING(@word, 2, LEN(@word)))
        
        SET @pos = @pos + @len + 1
        
        IF @pos <= LEN(@input)
            SET @output = @output + ' '
    END

    RETURN @output
END
GO

--
-- Create or alter function [dbo].[GetToday]
--
GO
PRINT (N'Create or alter function [dbo].[GetToday]')
GO
CREATE OR ALTER FUNCTION dbo.GetToday()
RETURNS DATE
WITH SCHEMABINDING
AS
BEGIN
    DECLARE @CurrentDate DATE =  SYSDATETIME();
    RETURN @CurrentDate;
END;
GO

--
-- Create or alter function [dbo].[fn_NormalizaPonto]
--
GO
PRINT (N'Create or alter function [dbo].[fn_NormalizaPonto]')
GO

CREATE OR ALTER FUNCTION dbo.fn_NormalizaPonto(@ponto NVARCHAR(50))
RETURNS NVARCHAR(50)
AS
BEGIN
    DECLARE @resultado NVARCHAR(50);
    
    -- Remove espaços
    SET @ponto = LTRIM(RTRIM(@ponto));
    
    -- Se vazio, retorna vazio
    IF @ponto IS NULL OR @ponto = ''
        RETURN '';
    
    -- Remove prefixo existente (p_, P_, p, P) se houver
    IF LEFT(UPPER(@ponto), 2) = 'P_'
        SET @ponto = SUBSTRING(@ponto, 3, LEN(@ponto));
    ELSE IF LEFT(UPPER(@ponto), 1) = 'P' AND ISNUMERIC(SUBSTRING(@ponto, 2, 1)) = 1
        SET @ponto = SUBSTRING(@ponto, 2, LEN(@ponto));
    
    -- Adiciona prefixo "p_" minúsculo
    SET @resultado = 'p_' + @ponto;
    
    RETURN @resultado;
END
GO

--
-- Create or alter function [dbo].[fn_diagramobjects]
--
GO
PRINT (N'Create or alter function [dbo].[fn_diagramobjects]')
GO

	CREATE OR ALTER FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END
	
GO

--
-- Create or alter function [dbo].[fn_CamelCase]
--
GO
PRINT (N'Create or alter function [dbo].[fn_CamelCase]')
GO

CREATE OR ALTER FUNCTION dbo.fn_CamelCase(@texto NVARCHAR(MAX))
RETURNS NVARCHAR(MAX)
AS
BEGIN
    DECLARE @resultado NVARCHAR(MAX) = '';
    DECLARE @palavra NVARCHAR(100);
    DECLARE @posicao INT = 1;
    DECLARE @espaco INT;
    DECLARE @contador INT = 0;
    
    -- Lista de preposições/artigos que ficam em minúsculo
    -- (exceto se for a primeira palavra)
    DECLARE @excecoes NVARCHAR(200) = ',de,da,do,das,dos,e,em,na,no,nas,nos,a,o,as,os,';
    
    -- Remove espaços extras e converte para minúsculo
    SET @texto = LOWER(LTRIM(RTRIM(@texto)));
    
    -- Remove espaços duplos
    WHILE CHARINDEX('  ', @texto) > 0
        SET @texto = REPLACE(@texto, '  ', ' ');
    
    -- Adiciona espaço no final para facilitar o loop
    SET @texto = @texto + ' ';
    
    -- Processa cada palavra
    WHILE @posicao <= LEN(@texto)
    BEGIN
        SET @espaco = CHARINDEX(' ', @texto, @posicao);
        
        IF @espaco = 0
            BREAK;
        
        SET @palavra = SUBSTRING(@texto, @posicao, @espaco - @posicao);
        SET @contador = @contador + 1;
        
        -- Se não for a primeira palavra e estiver na lista de exceções, mantém minúsculo
        IF @contador > 1 AND CHARINDEX(',' + @palavra + ',', @excecoes) > 0
        BEGIN
            SET @resultado = @resultado + @palavra + ' ';
        END
        ELSE
        BEGIN
            -- Capitaliza a primeira letra
            IF LEN(@palavra) > 0
                SET @resultado = @resultado + UPPER(LEFT(@palavra, 1)) + SUBSTRING(@palavra, 2, LEN(@palavra)) + ' ';
        END
        
        SET @posicao = @espaco + 1;
    END
    
    -- Remove espaço final
    SET @resultado = RTRIM(@resultado);
    
    RETURN @resultado;
END
GO

--
-- Create or alter function [dbo].[fn_CalculaMediaMensalViagens]
--
GO
PRINT (N'Create or alter function [dbo].[fn_CalculaMediaMensalViagens]')
GO

CREATE OR ALTER FUNCTION dbo.fn_CalculaMediaMensalViagens(@DataReferencia DATETIME)
RETURNS FLOAT
AS
BEGIN
    DECLARE @Media FLOAT
    DECLARE @Ano INT = YEAR(@DataReferencia)
    DECLARE @Mes INT = MONTH(@DataReferencia)
    
    -- Conta viagens do mês de referência
    SELECT @Media = COUNT(*)
    FROM Viagem
    WHERE Status = 'Realizada'
      AND YEAR(COALESCE(DataInicialNormalizada, DataInicial)) = @Ano
      AND MONTH(COALESCE(DataInicialNormalizada, DataInicial)) = @Mes
    
    -- Se não houver viagens no mês, usa média dos últimos 12 meses
    IF @Media IS NULL OR @Media = 0
    BEGIN
        SELECT @Media = AVG(QtdMensal)
        FROM (
            SELECT COUNT(*) AS QtdMensal
            FROM Viagem
            WHERE Status = 'Realizada'
              AND COALESCE(DataInicialNormalizada, DataInicial) >= DATEADD(MONTH, -12, @DataReferencia)
            GROUP BY YEAR(COALESCE(DataInicialNormalizada, DataInicial)), 
                     MONTH(COALESCE(DataInicialNormalizada, DataInicial))
        ) AS Meses
    END
    
    -- Evita divisão por zero
    IF @Media IS NULL OR @Media = 0
        SET @Media = 1
    
    RETURN @Media
END
GO

SET NOEXEC OFF
GO